!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=0)}([function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(1);var _paths_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(10),_config_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(11),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_5__=(__webpack_require__(12),__webpack_require__(109),__webpack_require__(116)),_device_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(165),_lib_runtime_devtools_support_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(174);
/*
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
window.onclick=(()=>{window.ShellApi&&window.ShellApi.receiveEntity()});console.log("version: mar-26 -- pouchdb://local/arcs/"),(async()=>{await Object(_lib_runtime_devtools_support_js__WEBPACK_IMPORTED_MODULE_7__.DevtoolsSupport)(),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_5__.Utils.init(_paths_js__WEBPACK_IMPORTED_MODULE_1__.paths.root,_paths_js__WEBPACK_IMPORTED_MODULE_1__.paths.map),window.ShellApi=await Object(_device_js__WEBPACK_IMPORTED_MODULE_6__.ShellApiFactory)("pouchdb://local/arcs/",_config_js__WEBPACK_IMPORTED_MODULE_2__.manifest,window.DeviceClient)})()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _components_xen_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2);let logLevel=0;const params=new URL(document.location).searchParams;if(params.has("log")){const log=params.get("log");logLevel=""===log?2:Number(log)||0,console.log(`setting logLevel = ${logLevel}`)}window.logLevel=logLevel,_components_xen_js__WEBPACK_IMPORTED_MODULE_0__.Xen.Debug.level=logLevel},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _modalities_dom_components_xen_xen_async_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);__webpack_require__.d(__webpack_exports__,"Xen",function(){return _modalities_dom_components_xen_xen_async_js__WEBPACK_IMPORTED_MODULE_0__.Xen}),__webpack_require__.d(__webpack_exports__,"XenAsyncMixin",function(){return _modalities_dom_components_xen_xen_async_js__WEBPACK_IMPORTED_MODULE_0__.XenAsyncMixin})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"XenAsyncMixin",function(){return XenAsyncMixin});var _xen_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4);__webpack_require__.d(__webpack_exports__,"Xen",function(){return _xen_js__WEBPACK_IMPORTED_MODULE_0__.default});const XenAsyncMixin=Base=>(class extends Base{set state(state){this._setState(state)}get state(){return this._state}get props(){return this._props}async awaitState(name,operation){const state=this._state,semaphore=`_await_${name}`;if(!state[semaphore]){state[semaphore]=!0;const value=await operation();this.state={[name]:value,[semaphore]:!1}}}fire(name,detail){this._fire(name,detail)}_getInitialState(){return this.getInitialState&&this.getInitialState()}_update(props,state,oldProps,oldState){return this.update&&this.update(props,state,oldProps,oldState)}_render(props,state,oldProps,oldState){return this.render&&this.render(props,state,oldProps,oldState)}onState(e,data){this._setState({[e.type]:data})}});_xen_js__WEBPACK_IMPORTED_MODULE_0__.default.AsyncMixin=XenAsyncMixin,_xen_js__WEBPACK_IMPORTED_MODULE_0__.default.Async=XenAsyncMixin(_xen_js__WEBPACK_IMPORTED_MODULE_0__.default.Base)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _xen_template_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5),_xen_state_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(6),_xen_element_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(7),_xen_base_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(8),_xen_debug_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(9);const html=(strings,...values)=>(strings[0]+values.map((v,i)=>v+strings[i+1]).join("")).trim();_xen_template_js__WEBPACK_IMPORTED_MODULE_0__.Template.html=((...args)=>_xen_template_js__WEBPACK_IMPORTED_MODULE_0__.Template.createTemplate(html(...args)));const Xen={State:_xen_state_js__WEBPACK_IMPORTED_MODULE_1__.XenStateMixin,Template:_xen_template_js__WEBPACK_IMPORTED_MODULE_0__.Template,Element:_xen_element_js__WEBPACK_IMPORTED_MODULE_2__.XenElementMixin,BaseMixin:_xen_base_js__WEBPACK_IMPORTED_MODULE_3__.XenBaseMixin,Base:_xen_base_js__WEBPACK_IMPORTED_MODULE_3__.XenBase,Debug:_xen_debug_js__WEBPACK_IMPORTED_MODULE_4__.Debug,setBoolAttribute:_xen_template_js__WEBPACK_IMPORTED_MODULE_0__.Template.setBoolAttribute,html:html,walker:_xen_debug_js__WEBPACK_IMPORTED_MODULE_4__.walker,logFactory:_xen_debug_js__WEBPACK_IMPORTED_MODULE_4__.logFactory,clone:obj=>"object"==typeof obj?Object.assign(Object.create(null),obj):{},nob:_xen_state_js__WEBPACK_IMPORTED_MODULE_1__.nob,debounce:_xen_state_js__WEBPACK_IMPORTED_MODULE_1__.debounce};window.Xen=Xen,__webpack_exports__.default=Xen},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Template",function(){return Template});const locateNodes=function(root,locator,map){map=map||[];for(const n in locator){const loc=locator[n];if(loc){const node=root.childNodes[n];map[loc.key]=node.nodeType===Node.TEXT_NODE?node.parentElement:node,loc.sub&&locateNodes(node,loc.sub,map)}}return map},annotateTextNode=function(node,key,notes){if(annotateMustache(node,key,notes,"textContent",node.textContent))return node.textContent="",!0},annotateElementNode=function(node,key,notes){if(node.hasAttributes()){let noted=!1;for(let a,a$=node.attributes,i=a$.length-1;i>=0&&(a=a$[i]);i--)(annotateEvent(node,key,notes,a.name,a.value)||annotateMustache(node,key,notes,a.name,a.value)||annotateDirective(node,key,notes,a.name,a.value))&&(node.removeAttribute(a.name),noted=!0);return noted}},annotateMustache=function(node,key,notes,property,mustache){if("{{"===mustache.slice(0,2)){"class"===property&&(property="className");let value=mustache.slice(2,-2);const override=value.split(":");return 2===override.length&&(property=override[0],value=override[1]),takeNote(notes,key,"mustaches",property,value),"$"===value[0]&&takeNote(notes,"xlate",value,!0),!0}},annotateEvent=function(node,key,notes,name,value){if("on-"===name.slice(0,3))return"{{"===value.slice(0,2)&&(value=value.slice(2,-2),console.warn(`Xen: event handler for '${name}' expressed as a mustache, which is not supported. Using literal value '${value}' instead.`)),takeNote(notes,key,"events",name.slice(3),value),!0},annotateDirective=function(node,key,notes,name,value){if("xen:forward"===name)return takeNote(notes,key,"events","xen:forward",value),!0},takeNote=function(notes,key,group,name,note){const n$=notes[key]||(notes[key]=Object.create(null));(n$[group]||(n$[group]={}))[name]=note},annotator=new
/*
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
*/
class{constructor(cb){this.cb=cb}annotate(node,notes,opts){return this.notes=notes,this.opts=opts||0,this.key=this.opts.key||0,notes.locator=this._annotateSubtree(node),notes}_annotateSubtree(node){let childLocators;for(let neo,i=0,child=node.firstChild,previous=null;child;i++){const childLocator=this._annotateNode(child);childLocator&&((childLocators=childLocators||{})[i]=childLocator),(neo=previous?previous.nextSibling:node.firstChild)===child?(previous=child,child=child.nextSibling):(child=neo,i--)}return childLocators}_annotateNode(node){const key=this.key++,shouldLocate=this.cb(node,key,this.notes,this.opts),locators=this._annotateSubtree(node);if(shouldLocate||locators){const cl=Object.create(null);return cl.key=key,locators&&(cl.sub=locators),cl}}}(function(node,key,notes,opts){if(opts.annotator&&opts.annotator(node,key,notes,opts))return!0;switch(node.nodeType){case Node.DOCUMENT_FRAGMENT_NODE:return;case Node.ELEMENT_NODE:return annotateElementNode(node,key,notes);case Node.TEXT_NODE:return annotateTextNode(node,key,notes)}}),mapEvents=function(notes,map,mapper){for(const key in notes){const node=map[key],events=notes[key]&&notes[key].events;if(node&&events)for(const name in events)mapper(node,name,events[name])}},_set=function(node,property,value,controller){const modifier=property.slice(-1);if("style%"===property||"style"===property||"xen:style"===property)"string"==typeof value?node.style.cssText=value:Object.assign(node.style,value);else if("$"==modifier){const n=property.slice(0,-1);"boolean"==typeof value||void 0===value?setBoolAttribute(node,n,Boolean(value)):node.setAttribute(n,value)}else"textContent"===property?value&&(value.$template||value.template)?_setSubTemplate(node,value,controller):node.textContent=value||"":"unsafe-html"===property?node.innerHTML=value||"":"value"===property?node.value!==value&&(node.value=value):node[property]=value},setBoolAttribute=function(node,attr,state){node[(void 0===state?!node.hasAttribute(attr):state)?"setAttribute":"removeAttribute"](attr,"")},_setSubTemplate=function(node,value,controller){let{template:template,models:models}=value;if(template)template=maybeStringToTemplate(template);else{template=node.getRootNode().querySelector(`template[${value.$template}]`)}_renderSubtemplates(node,controller,template,models)},_renderSubtemplates=function(container,controller,template,models){let next,child=container.firstElementChild;for(template&&models&&models&&models.forEach((model,i)=>{if(next=child&&child.nextElementSibling,!child){const dom=stamp(template).events(controller);(child=dom.root.firstElementChild)&&(child._subtreeDom=dom,container.appendChild(child),!template._shapeWarning&&dom.root.firstElementChild&&(template._shapeWarning=!0,console.warn("xen-template: subtemplate has multiple root nodes: only the first is used.",template)))}child&&(child._subtreeDom.set(model),child=next)});child;)next=child.nextElementSibling,child.remove(),child=next},stamp=function(template,opts){const notes=function(root,key,opts){return root._notes||(root._notes=annotator.annotate(root.content,{},key,opts))}(template=maybeStringToTemplate(template),opts),root=document.importNode(template.content,!0),firstElement=root.firstElementChild,map=locateNodes(root,notes.locator);return{root:root,notes:notes,map:map,firstElement:firstElement,$(slctr){return this.root.querySelector(slctr)},set:function(scope){return scope&&function(notes,map,scope,controller){if(scope)for(const key in notes){const node=map[key];if(node){node.scope=scope;const mustaches=notes[key].mustaches;for(const name in mustaches){const property=mustaches[name];property in scope&&_set(node,name,scope[property],controller)}}}}(notes,map,scope,this.controller),this},events:function(controller){return controller&&"function"!=typeof controller&&(controller=function(controller,node,eventName,handlerName){node.addEventListener(eventName,function(e){if(controller[handlerName])return controller[handlerName](e,e.detail)})}.bind(this,controller)),this.controller=controller,controller&&mapEvents(notes,map,controller),this},forward:function(){return mapEvents(notes,map,(node,eventName,handlerName)=>{node.addEventListener(eventName,e=>{const wrapper={eventName:eventName,handlerName:handlerName,detail:e.detail,target:e.target};fire(node,"xen:forward",wrapper,{bubbles:!0})})}),this},appendTo:function(node){return this.root?node.appendChild(this.root):console.warn("Xen: cannot appendTo, template stamped no DOM"),this.root=node,this}}},fire=(node,eventName,detail,init)=>{const eventInit=init||{};eventInit.detail=detail;const event=new CustomEvent(eventName,eventInit);return node.dispatchEvent(event),event.detail},maybeStringToTemplate=template=>"string"==typeof template?createTemplate(template):template,createTemplate=innerHTML=>Object.assign(document.createElement("template"),{innerHTML:innerHTML}),Template={createTemplate:createTemplate,setBoolAttribute:setBoolAttribute,stamp:stamp}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"XenStateMixin",function(){return XenStateMixin}),__webpack_require__.d(__webpack_exports__,"nob",function(){return nob}),__webpack_require__.d(__webpack_exports__,"debounce",function(){return debounce});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const nob=()=>Object.create(null),debounce=(key,action,delay)=>{if(key&&clearTimeout(key),action&&delay)return setTimeout(action,delay)},XenStateMixin=Base=>(class extends Base{constructor(){super(),this._pendingProps=nob(),this._props=this._getInitialProps()||nob(),this._lastProps=nob(),this._state=this._getInitialState()||nob(),this._lastState=nob()}_getInitialProps(){}_getInitialState(){}_getProperty(name){return this._pendingProps[name]||this._props[name]}_setProperty(name,value){(this._validator||this._wouldChangeProp(name,value))&&(this._pendingProps[name]=value,this._invalidateProps())}_wouldChangeValue(map,name,value){return map[name]!==value}_wouldChangeProp(name,value){return this._wouldChangeValue(this._props,name,value)}_wouldChangeState(name,value){return this._wouldChangeValue(this._state,name,value)}_setProps(props){Object.assign(this._pendingProps,props),this._invalidateProps()}_invalidateProps(){this._propsInvalid=!0,this._invalidate()}_setImmutableState(name,value){"object"==typeof name&&(console.warn("Xen:: _setImmutableState takes name and value args for a single property, dictionaries not supported."),value=Object.values(name)[0],name=Object.names(name)[0]),"object"==typeof value&&(value=Object.assign(Object.create(null),value)),this._state[name]=value,this._invalidate()}_setState(object){let dirty=!1;const state=this._state;for(const property in object){const value=object[property];this._wouldChangeState(property,value)&&(dirty=!0,state[property]=value)}if(dirty)return this._invalidate(),!0}_async(fn){return Promise.resolve().then(fn.bind(this))}_invalidate(){this._validator||(this._validator=this._async(this._validate))}_getStateArgs(){return[this._props,this._state,this._lastProps,this._lastState]}_validate(){const stateArgs=this._getStateArgs();try{Object.assign(this._props,this._pendingProps),this._propsInvalid&&(this._willReceiveProps(...stateArgs),this._propsInvalid=!1),this._shouldUpdate(...stateArgs)&&(this._ensureMount(),this._doUpdate(...stateArgs))}catch(x){console.error(x)}this._validator=null,this._lastProps=Object.assign(nob(),this._props),this._lastState=Object.assign(nob(),this._state)}_doUpdate(...stateArgs){this._update(...stateArgs),this._didUpdate(...stateArgs)}_ensureMount(){}_willReceiveProps(){}_shouldUpdate(){return!0}_update(){}_didUpdate(){}_debounce(key,func,delay){key=`_debounce_${key}`,this._state[key]=debounce(this._state[key],func,null!=delay?delay:16)}})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"XenElementMixin",function(){return XenElementMixin});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const XenElementMixin=Base=>(class extends Base{constructor(){super(),this._mounted=!1,this._root=this,this.__configureAccessors(),this.__lazyAcquireProps()}get _class(){return this.constructor._class||this.constructor}__configureAccessors(){const p=Object.getPrototypeOf(this);if(!p.hasOwnProperty("__$xenPropsConfigured")){p.__$xenPropsConfigured=!0;const a=this._class.observedAttributes;a&&a.forEach(n=>{Object.defineProperty(p,n,{get(){return this._getProperty(n)},set(value){this._setProperty(n,value)}})})}}__lazyAcquireProps(){const a=this._class.observedAttributes;a&&a.forEach(n=>{if(n.toLowerCase()!==n&&console.error(`Xen: Mixed-case attributes are not yet supported, "${this.localName}.observedAttributes" contains "${n}".`),this.hasOwnProperty(n)){const value=this[n];delete this[n],this[n]=value}else this.hasAttribute(n)&&this._setValueFromAttribute(n,this.getAttribute(n))})}_setValueFromAttribute(name,value){this[name]=value}connectedCallback(){this._mount()}_mount(){this._mounted||(this._mounted=!0,this._doMount(),this._didMount())}_doMount(){}_didMount(){}_fire(eventName,detail,node,init){const eventInit=init||{};eventInit.detail=detail;const event=new CustomEvent(eventName,eventInit);return(node||this).dispatchEvent(event),event.detail}})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"XenBaseMixin",function(){return XenBaseMixin}),__webpack_require__.d(__webpack_exports__,"XenBase",function(){return XenBase});var _xen_state_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),_xen_element_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(7),_xen_template_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(5);const XenBaseMixin=Base=>(class extends Base{get template(){const module=this.constructor.module;return module?module.querySelector("template"):""}get host(){return this.shadowRoot||this.attachShadow({mode:"open"})}_doMount(){this._stamp(),this._invalidate()}_stamp(){this.template&&(this._dom=_xen_template_js__WEBPACK_IMPORTED_MODULE_2__.Template.stamp(this.template).events(this._listener.bind(this)).appendTo(this.host))}_listener(node,name,handler){node.addEventListener(name,e=>{if(this[handler])return this[handler](e,e.detail,this._props,this._state)})}_doUpdate(...stateArgs){this._update(...stateArgs);let model=this._render(...stateArgs);this._dom&&(Array.isArray(model)&&(model=model.reduce((sum,value)=>Object.assign(sum,value),Object.create(null))),this._dom.set(model)),this._didUpdate(...stateArgs),this._didRender(...stateArgs)}_render(){}_didRender(){}}),XenBase=XenBaseMixin(Object(_xen_element_js__WEBPACK_IMPORTED_MODULE_1__.XenElementMixin)(Object(_xen_state_js__WEBPACK_IMPORTED_MODULE_0__.XenStateMixin)(HTMLElement)))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Debug",function(){return Debug}),__webpack_require__.d(__webpack_exports__,"logFactory",function(){return logFactory}),__webpack_require__.d(__webpack_exports__,"walker",function(){return walker});const Debug=(Base,log)=>(class extends Base{_setProperty(name,value){return Debug.level>1&&(name in this._pendingProps&&this._pendingProps[name]!==value||this._props[name]!==value)&&log("props",deepishClone({[name]:value})),super._setProperty(name,value)}_setState(state){return"object"!=typeof state?(console.warn("Xen::_setState argument must be an object"),!1):super._setState(state)?(Debug.level>1&&(Debug.lastFire?log("(fired --\x3e) state",deepishClone(state)):log("state",deepishClone(state))),!0):void 0}_setImmutableState(name,value){log("state [immutable]",{[name]:value}),super._setImmutableState(name,value)}_fire(name,detail,node,init){Debug.lastFire={name:name,detail:deepishClone(detail),log:log},log("fire",{[Debug.lastFire.name]:Debug.lastFire.detail}),super._fire(name,detail,node,init),Debug.lastFire=null}_doUpdate(...args){return Debug.level>2&&log("updating..."),super._doUpdate(...args)}_invalidate(){Debug.level>2&&(this._validator||log("invalidating...")),super._invalidate()}}),deepishClone=(obj,depth)=>{if(!obj||"object"!=typeof obj)return obj;const clone=Object.create(null);for(const n in obj){let value=obj[n];depth<1&&(value=deepishClone(obj,(depth||0)+1)),clone[n]=value}return clone};Debug.level=0;const logFactory=(preamble,color,log)=>Debug.level>0?((preamble,color,log="log")=>console[log].bind(console,`%c${preamble}`,`background: ${color}; color: white; padding: 1px 6px 2px 7px; border-radius: 6px;`))(preamble,color,log):()=>{},walker=(node,tree)=>{let subtree=tree;subtree||(subtree={});let index=1,child=(node||document.body).firstElementChild;for(;child;){const name=child.localName;if(customElements.get(name)){const shadow=child.shadowRoot,record={node:child,props:child._props,state:child._state},children=shadow?walker(shadow):{};children&&(record.children=children);let moniker=`${name}${child.id?`#${child.id}`:""} (${index++})`;for(;subtree[moniker];)moniker+="_";subtree[moniker]=record}walker(child,subtree),child=child.nextElementSibling}return subtree}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"paths",function(){return paths});const paths={root:".",map:{"https://$build/":"./"}}},function(module,__webpack_exports__,__webpack_require__){"use strict";let manifest;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"manifest",function(){return manifest});const params=new URL(document.location).searchParams;params.has("solo")&&(manifest=`import '${params.get("solo")}'`)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(13),__webpack_require__(14)},function(module,exports,__webpack_require__){!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=57)}([,,function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){"object"==typeof window&&(g=window)}module.exports=g},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},,,,function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var pouchdb__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(58),pouchdb_adapter_memory__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(70),pouchdb_debug__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(153);window.PouchDB={PouchDB:pouchdb__WEBPACK_IMPORTED_MODULE_0__.default,PouchDbMemory:pouchdb_adapter_memory__WEBPACK_IMPORTED_MODULE_1__.default,PouchDbDebug:pouchdb_debug__WEBPACK_IMPORTED_MODULE_2__.default}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(global,process){var argsarray__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(59),argsarray__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(argsarray__WEBPACK_IMPORTED_MODULE_0__),immediate__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(60),immediate__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(immediate__WEBPACK_IMPORTED_MODULE_1__),events__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(61),inherits__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(62),inherits__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(inherits__WEBPACK_IMPORTED_MODULE_3__),spark_md5__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(63),spark_md5__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(spark_md5__WEBPACK_IMPORTED_MODULE_4__),uuid__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(64),uuid__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(uuid__WEBPACK_IMPORTED_MODULE_5__),vuvuzela__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(69),vuvuzela__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(vuvuzela__WEBPACK_IMPORTED_MODULE_6__);function cloneBinaryObject(object){if(object instanceof ArrayBuffer)return function(buff){if("function"==typeof buff.slice)return buff.slice(0);var target=new ArrayBuffer(buff.byteLength),targetArray=new Uint8Array(target),sourceArray=new Uint8Array(buff);return targetArray.set(sourceArray),target}(object);var size=object.size,type=object.type;return"function"==typeof object.slice?object.slice(0,size,type):object.webkitSlice(0,size,type)}var ExportedSet,ExportedMap,funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object);function clone(object){var newObject,i,len;if(!object||"object"!=typeof object)return object;if(Array.isArray(object)){for(newObject=[],i=0,len=object.length;i<len;i++)newObject[i]=clone(object[i]);return newObject}if(object instanceof Date)return object.toISOString();if(function(object){return"undefined"!=typeof ArrayBuffer&&object instanceof ArrayBuffer||"undefined"!=typeof Blob&&object instanceof Blob}(object))return cloneBinaryObject(object);if(!function(value){var proto=Object.getPrototypeOf(value);if(null===proto)return!0;var Ctor=proto.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}(object))return object;for(i in newObject={},object)if(Object.prototype.hasOwnProperty.call(object,i)){var value=clone(object[i]);void 0!==value&&(newObject[i]=value)}return newObject}function once(fun){var called=!1;return argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){if(called)throw new Error("once called more than once");called=!0,fun.apply(this,args)})}function toPromise(func){return argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){args=clone(args);var self=this,usedCB="function"==typeof args[args.length-1]&&args.pop(),promise=new Promise(function(fulfill,reject){var resp;try{var callback=once(function(err,mesg){err?reject(err):fulfill(mesg)});args.push(callback),(resp=func.apply(self,args))&&"function"==typeof resp.then&&fulfill(resp)}catch(e){reject(e)}});return usedCB&&promise.then(function(result){usedCB(null,result)},usedCB),promise})}function adapterFun(name,callback){return toPromise(argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){if(this._closed)return Promise.reject(new Error("database is closed"));if(this._destroyed)return Promise.reject(new Error("database is destroyed"));var self=this;return function(self,name,args){if(self.constructor.listeners("debug").length){for(var logArgs=["api",self.name,name],i=0;i<args.length-1;i++)logArgs.push(args[i]);self.constructor.emit("debug",logArgs);var origCallback=args[args.length-1];args[args.length-1]=function(err,res){var responseArgs=["api",self.name,name];responseArgs=responseArgs.concat(err?["error",err]:["success",res]),self.constructor.emit("debug",responseArgs),origCallback(err,res)}}}(self,name,args),this.taskqueue.isReady?callback.apply(this,args):new Promise(function(fulfill,reject){self.taskqueue.addTask(function(failed){failed?reject(failed):fulfill(self[name].apply(self,args))})})}))}function mangle(key){return"$"+key}function unmangle(key){return key.substring(1)}function Map$1(){this._store={}}function Set$1(array){if(this._store=new Map$1,array&&Array.isArray(array))for(var i=0,len=array.length;i<len;i++)this.add(array[i])}function pick(obj,arr){for(var res={},i=0,len=arr.length;i<len;i++){var prop=arr[i];prop in obj&&(res[prop]=obj[prop])}return res}Map$1.prototype.get=function(key){var mangled=mangle(key);return this._store[mangled]},Map$1.prototype.set=function(key,value){var mangled=mangle(key);return this._store[mangled]=value,!0},Map$1.prototype.has=function(key){return mangle(key)in this._store},Map$1.prototype.delete=function(key){var mangled=mangle(key),res=mangled in this._store;return delete this._store[mangled],res},Map$1.prototype.forEach=function(cb){for(var keys=Object.keys(this._store),i=0,len=keys.length;i<len;i++){var key=keys[i];cb(this._store[key],key=unmangle(key))}},Object.defineProperty(Map$1.prototype,"size",{get:function(){return Object.keys(this._store).length}}),Set$1.prototype.add=function(key){return this._store.set(key,!0)},Set$1.prototype.has=function(key){return this._store.has(key)},Set$1.prototype.forEach=function(cb){this._store.forEach(function(value,key){cb(key)})},Object.defineProperty(Set$1.prototype,"size",{get:function(){return this._store.size}}),!function(){if("undefined"==typeof Symbol||"undefined"==typeof Map||"undefined"==typeof Set)return!1;var prop=Object.getOwnPropertyDescriptor(Map,Symbol.species);return prop&&"get"in prop&&Map[Symbol.species]===Map}()?(ExportedSet=Set$1,ExportedMap=Map$1):(ExportedSet=Set,ExportedMap=Map);var hasLocal,MAX_NUM_CONCURRENT_REQUESTS=6;function identityFunction(x){return x}function formatResultForOpenRevsGet(result){return[{ok:result}]}function bulkGet(db,opts,callback){var requests=opts.docs,requestsById=new ExportedMap;requests.forEach(function(request){requestsById.has(request.id)?requestsById.get(request.id).push(request):requestsById.set(request.id,[request])});var numDocs=requestsById.size,numDone=0,perDocResults=new Array(numDocs);function checkDone(){var results;++numDone===numDocs&&(results=[],perDocResults.forEach(function(res){res.docs.forEach(function(info){results.push({id:res.id,docs:[info]})})}),callback(null,{results:results}))}var allRequests=[];requestsById.forEach(function(value,key){allRequests.push(key)});var i=0;function nextBatch(){if(!(i>=allRequests.length)){var upTo=Math.min(i+MAX_NUM_CONCURRENT_REQUESTS,allRequests.length),batch=allRequests.slice(i,upTo);!function(batch,offset){batch.forEach(function(docId,j){var docIdx=offset+j,docRequests=requestsById.get(docId),docOpts=pick(docRequests[0],["atts_since","attachments"]);docOpts.open_revs=docRequests.map(function(request){return request.rev}),docOpts.open_revs=docOpts.open_revs.filter(identityFunction);var formatResult=identityFunction;0===docOpts.open_revs.length&&(delete docOpts.open_revs,formatResult=formatResultForOpenRevsGet),["revs","attachments","binary","ajax","latest"].forEach(function(param){param in opts&&(docOpts[param]=opts[param])}),db.get(docId,docOpts,function(err,res){var result,id,docs;result=err?[{error:err}]:formatResult(res),id=docId,docs=result,perDocResults[docIdx]={id:id,docs:docs},checkDone(),nextBatch()})})}(batch,i),i+=batch.length}}nextBatch()}try{localStorage.setItem("_pouch_check_localstorage",1),hasLocal=!!localStorage.getItem("_pouch_check_localstorage")}catch(e){hasLocal=!1}function hasLocalStorage(){return hasLocal}function Changes(){var self;events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.call(this),this._listeners={},self=this,hasLocalStorage()&&addEventListener("storage",function(e){self.emit(e.key)})}function guardedConsole(method){if("undefined"!=typeof console&&"function"==typeof console[method]){var args=Array.prototype.slice.call(arguments,1);console[method].apply(console,args)}}function defaultBackOff(min){var max=0;return min||(max=2e3),function(min,max){return min=parseInt(min,10)||0,(max=parseInt(max,10))!=max||max<=min?max=(min||1)<<1:max+=1,max>6e5&&(min=3e5,max=6e5),~~((max-min)*Math.random()+min)}(min,max)}function explainError(status,str){guardedConsole("info","The above "+status+" is totally normal. "+str)}inherits__WEBPACK_IMPORTED_MODULE_3___default()(Changes,events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter),Changes.prototype.addListener=function(dbName,id,db,opts){if(!this._listeners[id]){var self=this,inprogress=!1;this._listeners[id]=eventFunction,this.on(dbName,eventFunction)}function eventFunction(){if(self._listeners[id])if(inprogress)inprogress="waiting";else{inprogress=!0;var changesOpts=pick(opts,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);db.changes(changesOpts).on("change",function(c){c.seq>opts.since&&!opts.cancelled&&(opts.since=c.seq,opts.onChange(c))}).on("complete",function(){"waiting"===inprogress&&immediate__WEBPACK_IMPORTED_MODULE_1___default()(eventFunction),inprogress=!1}).on("error",function(){inprogress=!1})}}},Changes.prototype.removeListener=function(dbName,id){id in this._listeners&&(events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.prototype.removeListener.call(this,dbName,this._listeners[id]),delete this._listeners[id])},Changes.prototype.notifyLocalWindows=function(dbName){hasLocalStorage()&&(localStorage[dbName]="a"===localStorage[dbName]?"b":"a")},Changes.prototype.notify=function(dbName){this.emit(dbName),this.notifyLocalWindows(dbName)};var $inject_Object_assign="function"==typeof Object.assign?Object.assign:function(target){for(var to=Object(target),index=1;index<arguments.length;index++){var nextSource=arguments[index];if(null!=nextSource)for(var nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey])}return to};function PouchError(status,error,reason){Error.call(this,reason),this.status=status,this.name=error,this.message=reason,this.error=!0}inherits__WEBPACK_IMPORTED_MODULE_3___default()(PouchError,Error),PouchError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};new PouchError(401,"unauthorized","Name or password is incorrect.");var MISSING_BULK_DOCS=new PouchError(400,"bad_request","Missing JSON list of 'docs'"),MISSING_DOC=new PouchError(404,"not_found","missing"),REV_CONFLICT=new PouchError(409,"conflict","Document update conflict"),INVALID_ID=new PouchError(400,"bad_request","_id field must contain a string"),MISSING_ID=new PouchError(412,"missing_id","_id is required for puts"),RESERVED_ID=new PouchError(400,"bad_request","Only reserved document ids may start with underscore."),UNKNOWN_ERROR=(new PouchError(412,"precondition_failed","Database not open"),new PouchError(500,"unknown_error","Database encountered an unknown error")),BAD_ARG=new PouchError(500,"badarg","Some query argument is invalid"),QUERY_PARSE_ERROR=(new PouchError(400,"invalid_request","Request was invalid"),new PouchError(400,"query_parse_error","Some query parameter is invalid")),DOC_VALIDATION=new PouchError(500,"doc_validation","Bad special document member"),BAD_REQUEST=new PouchError(400,"bad_request","Something wrong with the request"),NOT_AN_OBJECT=new PouchError(400,"bad_request","Document must be a JSON object"),IDB_ERROR=(new PouchError(404,"not_found","Database not found"),new PouchError(500,"indexed_db_went_bad","unknown")),INVALID_REV=(new PouchError(500,"web_sql_went_bad","unknown"),new PouchError(500,"levelDB_went_went_bad","unknown"),new PouchError(403,"forbidden","Forbidden by design doc validate_doc_update function"),new PouchError(400,"bad_request","Invalid rev format")),MISSING_STUB=(new PouchError(412,"file_exists","The database could not be created, the file already exists."),new PouchError(412,"missing_stub","A pre-existing attachment stub wasn't found"));new PouchError(413,"invalid_url","Provided URL is invalid");function createError(error,reason){function CustomPouchError(reason){for(var p in error)"function"!=typeof error[p]&&(this[p]=error[p]);void 0!==reason&&(this.reason=reason)}return CustomPouchError.prototype=PouchError.prototype,new CustomPouchError(reason)}function generateErrorFromResponse(err){if("object"!=typeof err){var data=err;(err=UNKNOWN_ERROR).data=data}return"error"in err&&"conflict"===err.error&&(err.name="conflict",err.status=409),"name"in err||(err.name=err.error||"unknown"),"status"in err||(err.status=500),"message"in err||(err.message=err.message||err.reason),err}function filterChange(opts){var req={},hasFilter=opts.filter&&"function"==typeof opts.filter;return req.query=opts.query_params,function(change){change.doc||(change.doc={});var filterReturn=hasFilter&&function(filter,doc,req){try{return!filter(doc,req)}catch(err){var msg="Filter function threw: "+err.toString();return createError(BAD_REQUEST,msg)}}(opts.filter,change.doc,req);if("object"==typeof filterReturn)return filterReturn;if(filterReturn)return!1;if(opts.include_docs){if(!opts.attachments)for(var att in change.doc._attachments)change.doc._attachments.hasOwnProperty(att)&&(change.doc._attachments[att].stub=!0)}else delete change.doc;return!0}}function flatten(arrs){for(var res=[],i=0,len=arrs.length;i<len;i++)res=res.concat(arrs[i]);return res}function invalidIdError(id){var err;if(id?"string"!=typeof id?err=createError(INVALID_ID):/^_/.test(id)&&!/^_(design|local)/.test(id)&&(err=createError(RESERVED_ID)):err=createError(MISSING_ID),err)throw err}function isRemote(db){return"boolean"==typeof db._remote?db._remote:"function"==typeof db.type&&(guardedConsole("warn","db.type() is deprecated and will be removed in a future version of PouchDB"),"http"===db.type())}function parseDesignDocFunctionName(s){if(!s)return null;var parts=s.split("/");return 2===parts.length?parts:1===parts.length?[s,s]:null}function normalizeDesignDocFunctionName(s){var normalized=parseDesignDocFunctionName(s);return normalized?normalized.join("/"):null}var keys=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],qName="queryKey",qParser=/(?:^|&)([^&=]*)=?([^&]*)/g,parser=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;function parseUri(str){for(var m=parser.exec(str),uri={},i=14;i--;){var key=keys[i],value=m[i]||"",encoded=-1!==["user","password"].indexOf(key);uri[key]=encoded?decodeURIComponent(value):value}return uri[qName]={},uri[keys[12]].replace(qParser,function($0,$1,$2){$1&&(uri[qName][$1]=$2)}),uri}function scopeEval(source,scope){var keys=[],values=[];for(var key in scope)scope.hasOwnProperty(key)&&(keys.push(key),values.push(scope[key]));return keys.push(source),Function.apply(null,keys).apply(null,values)}function upsert(db,docId,diffFun){return new Promise(function(fulfill,reject){db.get(docId,function(err,doc){if(err){if(404!==err.status)return reject(err);doc={}}var docRev=doc._rev,newDoc=diffFun(doc);if(!newDoc)return fulfill({updated:!1,rev:docRev});newDoc._id=docId,newDoc._rev=docRev,fulfill(function(db,doc,diffFun){return db.put(doc).then(function(res){return{updated:!0,rev:res.rev}},function(err){if(409!==err.status)throw err;return upsert(db,doc._id,diffFun)})}(db,newDoc,diffFun))})})}var thisAtob=function(str){return atob(str)},thisBtoa=function(str){return btoa(str)};function createBlob(parts,properties){parts=parts||[],properties=properties||{};try{return new Blob(parts,properties)}catch(e){if("TypeError"!==e.name)throw e;for(var builder=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<parts.length;i+=1)builder.append(parts[i]);return builder.getBlob(properties.type)}}function binaryStringToArrayBuffer(bin){for(var length=bin.length,buf=new ArrayBuffer(length),arr=new Uint8Array(buf),i=0;i<length;i++)arr[i]=bin.charCodeAt(i);return buf}function binStringToBluffer(binString,type){return createBlob([binaryStringToArrayBuffer(binString)],{type:type})}function b64ToBluffer(b64,type){return binStringToBluffer(thisAtob(b64),type)}function readAsBinaryString(blob,callback){var reader=new FileReader,hasBinaryString="function"==typeof reader.readAsBinaryString;reader.onloadend=function(e){var result=e.target.result||"";if(hasBinaryString)return callback(result);callback(function(buffer){for(var binary="",bytes=new Uint8Array(buffer),length=bytes.byteLength,i=0;i<length;i++)binary+=String.fromCharCode(bytes[i]);return binary}(result))},hasBinaryString?reader.readAsBinaryString(blob):reader.readAsArrayBuffer(blob)}function blobToBinaryString(blobOrBuffer,callback){readAsBinaryString(blobOrBuffer,function(bin){callback(bin)})}function blobToBase64(blobOrBuffer,callback){blobToBinaryString(blobOrBuffer,function(base64){callback(thisBtoa(base64))})}var setImmediateShim=global.setImmediate||global.setTimeout,MD5_CHUNK_SIZE=32768;function appendBlob(buffer,blob,start,end,callback){(start>0||end<blob.size)&&(blob=function(blob,start,end){return blob.webkitSlice?blob.webkitSlice(start,end):blob.slice(start,end)}(blob,start,end)),function(blob,callback){var reader=new FileReader;reader.onloadend=function(e){var result=e.target.result||new ArrayBuffer(0);callback(result)},reader.readAsArrayBuffer(blob)}(blob,function(arrayBuffer){buffer.append(arrayBuffer),callback()})}function appendString(buffer,string,start,end,callback){(start>0||end<string.length)&&(string=string.substring(start,end)),buffer.appendBinary(string),callback()}function binaryMd5(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new spark_md5__WEBPACK_IMPORTED_MODULE_4___default.a:new spark_md5__WEBPACK_IMPORTED_MODULE_4___default.a.ArrayBuffer,append=inputIsString?appendString:appendBlob;function next(){setImmediateShim(loadNextChunk)}function done(){var base64=function(raw){return thisBtoa(raw)}(buffer.end(!0));callback(base64),buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;append(buffer,data,start,end,++currentChunk<chunks?next:done)}loadNextChunk()}function stringMd5(string){return spark_md5__WEBPACK_IMPORTED_MODULE_4___default.a.hash(string)}function rev$$1(doc,deterministic_revs){var clonedDoc=clone(doc);return deterministic_revs?(delete clonedDoc._rev_tree,stringMd5(JSON.stringify(clonedDoc))):uuid__WEBPACK_IMPORTED_MODULE_5___default.a.v4().replace(/-/g,"").toLowerCase()}var uuid=uuid__WEBPACK_IMPORTED_MODULE_5___default.a.v4;function winningRev(metadata){for(var winningId,winningPos,winningDeleted,node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var tree=node.ids,branches=tree[2],pos=node.pos;if(branches.length)for(var i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i]});else{var deleted=!!tree[1].deleted,id=tree[0];winningId&&!(winningDeleted!==deleted?winningDeleted:winningPos!==pos?winningPos<pos:winningId<id)||(winningId=id,winningPos=pos,winningDeleted=deleted)}}return winningPos+"-"+winningId}function traverseRevTree(revs,callback){for(var node,toVisit=revs.slice();node=toVisit.pop();)for(var pos=node.pos,tree=node.ids,branches=tree[2],newCtx=callback(0===branches.length,pos,tree[0],node.ctx,tree[1]),i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i],ctx:newCtx})}function sortByPos(a,b){return a.pos-b.pos}function collectLeaves(revs){var leaves=[];traverseRevTree(revs,function(isLeaf,pos,id,acc,opts){isLeaf&&leaves.push({rev:pos+"-"+id,pos:pos,opts:opts})}),leaves.sort(sortByPos).reverse();for(var i=0,len=leaves.length;i<len;i++)delete leaves[i].pos;return leaves}function collectConflicts(metadata){for(var win=winningRev(metadata),leaves=collectLeaves(metadata.rev_tree),conflicts=[],i=0,len=leaves.length;i<len;i++){var leaf=leaves[i];leaf.rev===win||leaf.opts.deleted||conflicts.push(leaf.rev)}return conflicts}function rootToLeaf(revs){for(var node,paths=[],toVisit=revs.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];history.push({id:id,opts:opts}),isLeaf&&paths.push({pos:pos+1-history.length,ids:history});for(var i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i],history:history})}return paths.reverse()}function sortByPos$1(a,b){return a.pos-b.pos}function insertSorted(arr,item,comparator){var idx=function(arr,item,comparator){for(var mid,low=0,high=arr.length;low<high;)comparator(arr[mid=low+high>>>1],item)<0?low=mid+1:high=mid;return low}(arr,item,comparator);arr.splice(idx,0,item)}function pathToTree(path,numStemmed){for(var root,leaf,i=numStemmed,len=path.length;i<len;i++){var node=path[i],currentLeaf=[node.id,node.opts,[]];leaf?(leaf[2].push(currentLeaf),leaf=currentLeaf):root=leaf=currentLeaf}return root}function compareTree(a,b){return a[0]<b[0]?-1:1}function mergeTree(in_tree1,in_tree2){for(var queue=[{tree1:in_tree1,tree2:in_tree2}],conflicts=!1;queue.length>0;){var item=queue.pop(),tree1=item.tree1,tree2=item.tree2;(tree1[1].status||tree2[1].status)&&(tree1[1].status="available"===tree1[1].status||"available"===tree2[1].status?"available":"missing");for(var i=0;i<tree2[2].length;i++)if(tree1[2][0]){for(var merged=!1,j=0;j<tree1[2].length;j++)tree1[2][j][0]===tree2[2][i][0]&&(queue.push({tree1:tree1[2][j],tree2:tree2[2][i]}),merged=!0);merged||(conflicts="new_branch",insertSorted(tree1[2],tree2[2][i],compareTree))}else conflicts="new_leaf",tree1[2][0]=tree2[2][i]}return{conflicts:conflicts,tree:in_tree1}}function doMerge(tree,path,dontExpand){var res,restree=[],conflicts=!1,merged=!1;if(!tree.length)return{tree:[path],conflicts:"new_leaf"};for(var i=0,len=tree.length;i<len;i++){var branch=tree[i];if(branch.pos===path.pos&&branch.ids[0]===path.ids[0])res=mergeTree(branch.ids,path.ids),restree.push({pos:branch.pos,ids:res.tree}),conflicts=conflicts||res.conflicts,merged=!0;else if(!0!==dontExpand){var t1=branch.pos<path.pos?branch:path,t2=branch.pos<path.pos?path:branch,diff=t2.pos-t1.pos,candidateParents=[],trees=[];for(trees.push({ids:t1.ids,diff:diff,parent:null,parentIdx:null});trees.length>0;){var item=trees.pop();if(0!==item.diff)for(var elements=item.ids[2],j=0,elementsLen=elements.length;j<elementsLen;j++)trees.push({ids:elements[j],diff:item.diff-1,parent:item.ids,parentIdx:j});else item.ids[0]===t2.ids[0]&&candidateParents.push(item)}var el=candidateParents[0];el?(res=mergeTree(el.ids,t2.ids),el.parent[2][el.parentIdx]=res.tree,restree.push({pos:t1.pos,ids:t1.ids}),conflicts=conflicts||res.conflicts,merged=!0):restree.push(branch)}else restree.push(branch)}return merged||restree.push(path),restree.sort(sortByPos$1),{tree:restree,conflicts:conflicts||"internal_node"}}function merge(tree,path,depth){var newTree=doMerge(tree,path),stemmed=function(tree,depth){for(var stemmedRevs,result,paths=rootToLeaf(tree),i=0,len=paths.length;i<len;i++){var node,path=paths[i],stemmed=path.ids;if(stemmed.length>depth){stemmedRevs||(stemmedRevs={});var numStemmed=stemmed.length-depth;node={pos:path.pos+numStemmed,ids:pathToTree(stemmed,numStemmed)};for(var s=0;s<numStemmed;s++){var rev=path.pos+s+"-"+stemmed[s].id;stemmedRevs[rev]=!0}}else node={pos:path.pos,ids:pathToTree(stemmed,0)};result=result?doMerge(result,node,!0).tree:[node]}return stemmedRevs&&traverseRevTree(result,function(isLeaf,pos,revHash){delete stemmedRevs[pos+"-"+revHash]}),{tree:result,revs:stemmedRevs?Object.keys(stemmedRevs):[]}}(newTree.tree,depth);return{tree:stemmed.tree,stemmedRevs:stemmed.revs,conflicts:newTree.conflicts}}function getTrees(node){return node.ids}function isDeleted(metadata,rev){rev||(rev=winningRev(metadata));for(var tree,id=rev.substring(rev.indexOf("-")+1),toVisit=metadata.rev_tree.map(getTrees);tree=toVisit.pop();){if(tree[0]===id)return!!tree[1].deleted;toVisit=toVisit.concat(tree[2])}}function isLocalId(id){return/^_local/.test(id)}function Changes$1(db,opts,callback){events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.call(this);var self=this;this.db=db;var complete=(opts=opts?clone(opts):{}).complete=once(function(err,resp){var ee,type;err?(type="error",("listenerCount"in(ee=self)?ee.listenerCount(type):events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.listenerCount(ee,type))>0&&self.emit("error",err)):self.emit("complete",resp),self.removeAllListeners(),db.removeListener("destroyed",onDestroy)});function onDestroy(){self.cancel()}callback&&(self.on("complete",function(resp){callback(null,resp)}),self.on("error",callback)),db.once("destroyed",onDestroy),opts.onChange=function(change,pending,lastSeq){self.isCancelled||function(self,change,pending,lastSeq){try{self.emit("change",change,pending,lastSeq)}catch(e){guardedConsole("error",'Error in .on("change", function):',e)}}(self,change,pending,lastSeq)};var promise=new Promise(function(fulfill,reject){opts.complete=function(err,res){err?reject(err):fulfill(res)}});self.once("cancel",function(){db.removeListener("destroyed",onDestroy),opts.complete(null,{status:"cancelled"})}),this.then=promise.then.bind(promise),this.catch=promise.catch.bind(promise),this.then(function(result){complete(null,result)},complete),db.taskqueue.isReady?self.validateChanges(opts):db.taskqueue.addTask(function(failed){failed?opts.complete(failed):self.isCancelled?self.emit("cancel"):self.validateChanges(opts)})}function processChange(doc,metadata,opts){var changeList=[{rev:doc._rev}];"all_docs"===opts.style&&(changeList=collectLeaves(metadata.rev_tree).map(function(x){return{rev:x.rev}}));var change={id:metadata.id,changes:changeList,doc:doc};return isDeleted(metadata,doc._rev)&&(change.deleted=!0),opts.conflicts&&(change.doc._conflicts=collectConflicts(metadata),change.doc._conflicts.length||delete change.doc._conflicts),change}function compare(left,right){return left<right?-1:left>right?1:0}function yankError(callback,docId){return function(err,results){err||results[0]&&results[0].error?((err=err||results[0]).docId=docId,callback(err)):callback(null,results.length?results[0]:results)}}function compareByIdThenRev(a,b){var idCompare=compare(a._id,b._id);return 0!==idCompare?idCompare:compare(a._revisions?a._revisions.start:0,b._revisions?b._revisions.start:0)}function AbstractPouchDB(){for(var p in events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.call(this),AbstractPouchDB.prototype)"function"==typeof this[p]&&(this[p]=this[p].bind(this))}function TaskQueue(){this.isReady=!1,this.failed=!1,this.queue=[]}function PouchDB(name,opts){if(!(this instanceof PouchDB))return new PouchDB(name,opts);var self=this;if(opts=opts||{},name&&"object"==typeof name&&(name=(opts=name).name,delete opts.name),void 0===opts.deterministic_revs&&(opts.deterministic_revs=!0),this.__opts=opts=clone(opts),self.auto_compaction=opts.auto_compaction,self.prefix=PouchDB.prefix,"string"!=typeof name)throw new Error("Missing/invalid DB name");var backend=function(name,opts){var match=name.match(/([a-z-]*):\/\/(.*)/);if(match)return{name:/https?/.test(match[1])?match[1]+"://"+match[2]:match[2],adapter:match[1]};var adapters=PouchDB.adapters,preferredAdapters=PouchDB.preferredAdapters,prefix=PouchDB.prefix,adapterName=opts.adapter;if(!adapterName)for(var i=0;i<preferredAdapters.length&&"idb"===(adapterName=preferredAdapters[i])&&"websql"in adapters&&hasLocalStorage()&&localStorage["_pouch__websqldb_"+prefix+name];++i)guardedConsole("log",'PouchDB is downgrading "'+name+'" to WebSQL to avoid data loss, because it was already opened with WebSQL.');var adapter=adapters[adapterName];return{name:adapter&&"use_prefix"in adapter&&!adapter.use_prefix?name:prefix+name,adapter:adapterName}}((opts.prefix||"")+name,opts);if(opts.name=backend.name,opts.adapter=opts.adapter||backend.adapter,self.name=name,self._adapter=opts.adapter,PouchDB.emit("debug",["adapter","Picked adapter: ",opts.adapter]),!PouchDB.adapters[opts.adapter]||!PouchDB.adapters[opts.adapter].valid())throw new Error("Invalid Adapter: "+opts.adapter);AbstractPouchDB.call(self),self.taskqueue=new TaskQueue,self.adapter=opts.adapter,PouchDB.adapters[opts.adapter].call(self,opts,function(err){if(err)return self.taskqueue.fail(err);!function(self){function onDestroyed(from_constructor){self.removeListener("closed",onClosed),from_constructor||self.constructor.emit("destroyed",self.name)}function onClosed(){self.removeListener("destroyed",onDestroyed),self.constructor.emit("unref",self)}self.once("destroyed",onDestroyed),self.once("closed",onClosed),self.constructor.emit("ref",self)}(self),self.emit("created",self),PouchDB.emit("created",self.name),self.taskqueue.ready(self)})}inherits__WEBPACK_IMPORTED_MODULE_3___default()(Changes$1,events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter),Changes$1.prototype.cancel=function(){this.isCancelled=!0,this.db.taskqueue.isReady&&this.emit("cancel")},Changes$1.prototype.validateChanges=function(opts){var callback=opts.complete,self=this;PouchDB._changesFilterPlugin?PouchDB._changesFilterPlugin.validate(opts,function(err){if(err)return callback(err);self.doChanges(opts)}):self.doChanges(opts)},Changes$1.prototype.doChanges=function(opts){var self=this,callback=opts.complete;if("live"in(opts=clone(opts))&&!("continuous"in opts)&&(opts.continuous=opts.live),opts.processChange=processChange,"latest"===opts.since&&(opts.since="now"),opts.since||(opts.since=0),"now"!==opts.since){if(PouchDB._changesFilterPlugin){if(PouchDB._changesFilterPlugin.normalize(opts),PouchDB._changesFilterPlugin.shouldFilter(this,opts))return PouchDB._changesFilterPlugin.filter(this,opts)}else["doc_ids","filter","selector","view"].forEach(function(key){key in opts&&guardedConsole("warn",'The "'+key+'" option was passed in to changes/replicate, but pouchdb-changes-filter plugin is not installed, so it was ignored. Please install the plugin to enable filtering.')});"descending"in opts||(opts.descending=!1),opts.limit=0===opts.limit?1:opts.limit,opts.complete=callback;var newPromise=this.db._changes(opts);if(newPromise&&"function"==typeof newPromise.cancel){var cancel=self.cancel;self.cancel=argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){newPromise.cancel(),cancel.apply(this,args)})}}else this.db.info().then(function(info){self.isCancelled?callback(null,{status:"cancelled"}):(opts.since=info.update_seq,self.doChanges(opts))},callback)},inherits__WEBPACK_IMPORTED_MODULE_3___default()(AbstractPouchDB,events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter),AbstractPouchDB.prototype.post=adapterFun("post",function(doc,opts,callback){if("function"==typeof opts&&(callback=opts,opts={}),"object"!=typeof doc||Array.isArray(doc))return callback(createError(NOT_AN_OBJECT));this.bulkDocs({docs:[doc]},opts,yankError(callback,doc._id))}),AbstractPouchDB.prototype.put=adapterFun("put",function(doc,opts,cb){if("function"==typeof opts&&(cb=opts,opts={}),"object"!=typeof doc||Array.isArray(doc))return cb(createError(NOT_AN_OBJECT));if(invalidIdError(doc._id),isLocalId(doc._id)&&"function"==typeof this._putLocal)return doc._deleted?this._removeLocal(doc,cb):this._putLocal(doc,cb);var parts,oldRevId,newRevNum,newRevId,self=this;function putDoc(next){"function"==typeof self._put&&!1!==opts.new_edits?self._put(doc,opts,next):self.bulkDocs({docs:[doc]},opts,yankError(next,doc._id))}opts.force&&doc._rev?(parts=doc._rev.split("-"),oldRevId=parts[1],newRevNum=parseInt(parts[0],10)+1,newRevId=rev$$1(),doc._revisions={start:newRevNum,ids:[newRevId,oldRevId]},doc._rev=newRevNum+"-"+newRevId,opts.new_edits=!1,putDoc(function(err){var result=err?null:{ok:!0,id:doc._id,rev:doc._rev};cb(err,result)})):putDoc(cb)}),AbstractPouchDB.prototype.putAttachment=adapterFun("putAttachment",function(docId,attachmentId,rev,blob,type){var api=this;function createAttachment(doc){var prevrevpos="_rev"in doc?parseInt(doc._rev,10):0;return doc._attachments=doc._attachments||{},doc._attachments[attachmentId]={content_type:type,data:blob,revpos:++prevrevpos},api.put(doc)}return"function"==typeof type&&(type=blob,blob=rev,rev=null),void 0===type&&(type=blob,blob=rev,rev=null),type||guardedConsole("warn","Attachment",attachmentId,"on document",docId,"is missing content_type"),api.get(docId).then(function(doc){if(doc._rev!==rev)throw createError(REV_CONFLICT);return createAttachment(doc)},function(err){if(err.reason===MISSING_DOC.message)return createAttachment({_id:docId});throw err})}),AbstractPouchDB.prototype.removeAttachment=adapterFun("removeAttachment",function(docId,attachmentId,rev,callback){var self=this;self.get(docId,function(err,obj){if(err)callback(err);else if(obj._rev===rev){if(!obj._attachments)return callback();delete obj._attachments[attachmentId],0===Object.keys(obj._attachments).length&&delete obj._attachments,self.put(obj,callback)}else callback(createError(REV_CONFLICT))})}),AbstractPouchDB.prototype.remove=adapterFun("remove",function(docOrId,optsOrRev,opts,callback){var doc;"string"==typeof optsOrRev?(doc={_id:docOrId,_rev:optsOrRev},"function"==typeof opts&&(callback=opts,opts={})):(doc=docOrId,"function"==typeof optsOrRev?(callback=optsOrRev,opts={}):(callback=opts,opts=optsOrRev)),(opts=opts||{}).was_delete=!0;var newDoc={_id:doc._id,_rev:doc._rev||opts.rev,_deleted:!0};if(isLocalId(newDoc._id)&&"function"==typeof this._removeLocal)return this._removeLocal(doc,callback);this.bulkDocs({docs:[newDoc]},opts,yankError(callback,newDoc._id))}),AbstractPouchDB.prototype.revsDiff=adapterFun("revsDiff",function(req,opts,callback){"function"==typeof opts&&(callback=opts,opts={});var ids=Object.keys(req);if(!ids.length)return callback(null,{});var count=0,missing=new ExportedMap;function addToMissing(id,revId){missing.has(id)||missing.set(id,{missing:[]}),missing.get(id).missing.push(revId)}ids.map(function(id){this._getRevisionTree(id,function(err,rev_tree){if(err&&404===err.status&&"missing"===err.message)missing.set(id,{missing:req[id]});else{if(err)return callback(err);!function(id,rev_tree){var missingForId=req[id].slice(0);traverseRevTree(rev_tree,function(isLeaf,pos,revHash,ctx,opts){var rev=pos+"-"+revHash,idx=missingForId.indexOf(rev);-1!==idx&&(missingForId.splice(idx,1),"available"!==opts.status&&addToMissing(id,rev))}),missingForId.forEach(function(rev){addToMissing(id,rev)})}(id,rev_tree)}if(++count===ids.length){var missingObj={};return missing.forEach(function(value,key){missingObj[key]=value}),callback(null,missingObj)}})},this)}),AbstractPouchDB.prototype.bulkGet=adapterFun("bulkGet",function(opts,callback){bulkGet(this,opts,callback)}),AbstractPouchDB.prototype.compactDocument=adapterFun("compactDocument",function(docId,maxHeight,callback){var self=this;this._getRevisionTree(docId,function(err,revTree){if(err)return callback(err);var height=function(revs){var height={},edges=[];return traverseRevTree(revs,function(isLeaf,pos,id,prnt){var rev=pos+"-"+id;return isLeaf&&(height[rev]=0),void 0!==prnt&&edges.push({from:prnt,to:rev}),rev}),edges.reverse(),edges.forEach(function(edge){void 0===height[edge.from]?height[edge.from]=1+height[edge.to]:height[edge.from]=Math.min(height[edge.from],1+height[edge.to])}),height}(revTree),candidates=[],revs=[];Object.keys(height).forEach(function(rev){height[rev]>maxHeight&&candidates.push(rev)}),traverseRevTree(revTree,function(isLeaf,pos,revHash,ctx,opts){var rev=pos+"-"+revHash;"available"===opts.status&&-1!==candidates.indexOf(rev)&&revs.push(rev)}),self._doCompaction(docId,revs,callback)})}),AbstractPouchDB.prototype.compact=adapterFun("compact",function(opts,callback){"function"==typeof opts&&(callback=opts,opts={});opts=opts||{},this._compactionQueue=this._compactionQueue||[],this._compactionQueue.push({opts:opts,callback:callback}),1===this._compactionQueue.length&&function doNextCompaction(self){var task=self._compactionQueue[0],opts=task.opts,callback=task.callback;self.get("_local/compaction").catch(function(){return!1}).then(function(doc){doc&&doc.last_seq&&(opts.last_seq=doc.last_seq),self._compact(opts,function(err,res){err?callback(err):callback(null,res),immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){self._compactionQueue.shift(),self._compactionQueue.length&&doNextCompaction(self)})})})}(this)}),AbstractPouchDB.prototype._compact=function(opts,callback){var self=this,changesOpts={return_docs:!1,last_seq:opts.last_seq||0},promises=[];self.changes(changesOpts).on("change",function(row){promises.push(self.compactDocument(row.id,0))}).on("complete",function(resp){var lastSeq=resp.last_seq;Promise.all(promises).then(function(){return upsert(self,"_local/compaction",function(doc){return(!doc.last_seq||doc.last_seq<lastSeq)&&(doc.last_seq=lastSeq,doc)})}).then(function(){callback(null,{ok:!0})}).catch(callback)}).on("error",callback)},AbstractPouchDB.prototype.get=adapterFun("get",function(id,opts,cb){if("function"==typeof opts&&(cb=opts,opts={}),"string"!=typeof id)return cb(createError(INVALID_ID));if(isLocalId(id)&&"function"==typeof this._getLocal)return this._getLocal(id,cb);var leaves=[],self=this;function finishOpenRevs(){var result=[],count=leaves.length;if(!count)return cb(null,result);leaves.forEach(function(leaf){self.get(id,{rev:leaf,revs:opts.revs,latest:opts.latest,attachments:opts.attachments,binary:opts.binary},function(err,doc){if(err)result.push({missing:leaf});else{for(var existing,i=0,l=result.length;i<l;i++)if(result[i].ok&&result[i].ok._rev===doc._rev){existing=!0;break}existing||result.push({ok:doc})}--count||cb(null,result)})})}if(!opts.open_revs)return this._get(id,opts,function(err,result){if(err)return err.docId=id,cb(err);var doc=result.doc,metadata=result.metadata,ctx=result.ctx;if(opts.conflicts){var conflicts=collectConflicts(metadata);conflicts.length&&(doc._conflicts=conflicts)}if(isDeleted(metadata,doc._rev)&&(doc._deleted=!0),opts.revs||opts.revs_info){for(var splittedRev=doc._rev.split("-"),revNo=parseInt(splittedRev[0],10),revHash=splittedRev[1],paths=rootToLeaf(metadata.rev_tree),path=null,i=0;i<paths.length;i++){var currentPath=paths[i],hashIndex=currentPath.ids.map(function(x){return x.id}).indexOf(revHash);(hashIndex===revNo-1||!path&&-1!==hashIndex)&&(path=currentPath)}var indexOfRev=path.ids.map(function(x){return x.id}).indexOf(doc._rev.split("-")[1])+1,howMany=path.ids.length-indexOfRev;if(path.ids.splice(indexOfRev,howMany),path.ids.reverse(),opts.revs&&(doc._revisions={start:path.pos+path.ids.length-1,ids:path.ids.map(function(rev){return rev.id})}),opts.revs_info){var pos=path.pos+path.ids.length;doc._revs_info=path.ids.map(function(rev){return{rev:--pos+"-"+rev.id,status:rev.opts.status}})}}if(opts.attachments&&doc._attachments){var attachments=doc._attachments,count=Object.keys(attachments).length;if(0===count)return cb(null,doc);Object.keys(attachments).forEach(function(key){this._getAttachment(doc._id,key,attachments[key],{rev:doc._rev,binary:opts.binary,ctx:ctx},function(err,data){var att=doc._attachments[key];att.data=data,delete att.stub,delete att.length,--count||cb(null,doc)})},self)}else{if(doc._attachments)for(var key in doc._attachments)doc._attachments.hasOwnProperty(key)&&(doc._attachments[key].stub=!0);cb(null,doc)}});if("all"===opts.open_revs)this._getRevisionTree(id,function(err,rev_tree){if(err)return cb(err);leaves=collectLeaves(rev_tree).map(function(leaf){return leaf.rev}),finishOpenRevs()});else{if(!Array.isArray(opts.open_revs))return cb(createError(UNKNOWN_ERROR,"function_clause"));leaves=opts.open_revs;for(var i=0;i<leaves.length;i++){var l=leaves[i];if("string"!=typeof l||!/^\d+-/.test(l))return cb(createError(INVALID_REV))}finishOpenRevs()}}),AbstractPouchDB.prototype.getAttachment=adapterFun("getAttachment",function(docId,attachmentId,opts,callback){var self=this;opts instanceof Function&&(callback=opts,opts={}),this._get(docId,opts,function(err,res){return err?callback(err):res.doc._attachments&&res.doc._attachments[attachmentId]?(opts.ctx=res.ctx,opts.binary=!0,void self._getAttachment(docId,attachmentId,res.doc._attachments[attachmentId],opts,callback)):callback(createError(MISSING_DOC))})}),AbstractPouchDB.prototype.allDocs=adapterFun("allDocs",function(opts,callback){if("function"==typeof opts&&(callback=opts,opts={}),opts.skip=void 0!==opts.skip?opts.skip:0,opts.start_key&&(opts.startkey=opts.start_key),opts.end_key&&(opts.endkey=opts.end_key),"keys"in opts){if(!Array.isArray(opts.keys))return callback(new TypeError("options.keys must be an array"));var incompatibleOpt=["startkey","endkey","key"].filter(function(incompatibleOpt){return incompatibleOpt in opts})[0];if(incompatibleOpt)return void callback(createError(QUERY_PARSE_ERROR,"Query parameter `"+incompatibleOpt+"` is not compatible with multi-get"));if(!isRemote(this)&&(function(opts){var keys="limit"in opts?opts.keys.slice(opts.skip,opts.limit+opts.skip):opts.skip>0?opts.keys.slice(opts.skip):opts.keys;opts.keys=keys,opts.skip=0,delete opts.limit,opts.descending&&(keys.reverse(),opts.descending=!1)}(opts),0===opts.keys.length))return this._allDocs({limit:0},callback)}return this._allDocs(opts,callback)}),AbstractPouchDB.prototype.changes=function(opts,callback){return"function"==typeof opts&&(callback=opts,opts={}),(opts=opts||{}).return_docs="return_docs"in opts?opts.return_docs:!opts.live,new Changes$1(this,opts,callback)},AbstractPouchDB.prototype.close=adapterFun("close",function(callback){return this._closed=!0,this.emit("closed"),this._close(callback)}),AbstractPouchDB.prototype.info=adapterFun("info",function(callback){var self=this;this._info(function(err,info){if(err)return callback(err);info.db_name=info.db_name||self.name,info.auto_compaction=!(!self.auto_compaction||isRemote(self)),info.adapter=self.adapter,callback(null,info)})}),AbstractPouchDB.prototype.id=adapterFun("id",function(callback){return this._id(callback)}),AbstractPouchDB.prototype.type=function(){return"function"==typeof this._type?this._type():this.adapter},AbstractPouchDB.prototype.bulkDocs=adapterFun("bulkDocs",function(req,opts,callback){if("function"==typeof opts&&(callback=opts,opts={}),opts=opts||{},Array.isArray(req)&&(req={docs:req}),!req||!req.docs||!Array.isArray(req.docs))return callback(createError(MISSING_BULK_DOCS));for(var i=0;i<req.docs.length;++i)if("object"!=typeof req.docs[i]||Array.isArray(req.docs[i]))return callback(createError(NOT_AN_OBJECT));var attachmentError;if(req.docs.forEach(function(doc){doc._attachments&&Object.keys(doc._attachments).forEach(function(name){attachmentError=attachmentError||function(name){return"_"===name.charAt(0)&&name+" is not a valid attachment name, attachment names cannot start with '_'"}(name),doc._attachments[name].content_type||guardedConsole("warn","Attachment",name,"on document",doc._id,"is missing content_type")})}),attachmentError)return callback(createError(BAD_REQUEST,attachmentError));"new_edits"in opts||(opts.new_edits=!("new_edits"in req)||req.new_edits);var adapter=this;opts.new_edits||isRemote(adapter)||req.docs.sort(compareByIdThenRev),function(docs){for(var i=0;i<docs.length;i++){var doc=docs[i];if(doc._deleted)delete doc._attachments;else if(doc._attachments)for(var atts=Object.keys(doc._attachments),j=0;j<atts.length;j++){var att=atts[j];doc._attachments[att]=pick(doc._attachments[att],["data","digest","content_type","length","revpos","stub"])}}}(req.docs);var ids=req.docs.map(function(doc){return doc._id});return this._bulkDocs(req,opts,function(err,res){if(err)return callback(err);if(opts.new_edits||(res=res.filter(function(x){return x.error})),!isRemote(adapter))for(var i=0,l=res.length;i<l;i++)res[i].id=res[i].id||ids[i];callback(null,res)})}),AbstractPouchDB.prototype.registerDependentDatabase=adapterFun("registerDependentDatabase",function(dependentDb,callback){var depDB=new this.constructor(dependentDb,this.__opts);upsert(this,"_local/_pouch_dependentDbs",function(doc){return doc.dependentDbs=doc.dependentDbs||{},!doc.dependentDbs[dependentDb]&&(doc.dependentDbs[dependentDb]=!0,doc)}).then(function(){callback(null,{db:depDB})}).catch(callback)}),AbstractPouchDB.prototype.destroy=adapterFun("destroy",function(opts,callback){"function"==typeof opts&&(callback=opts,opts={});var self=this,usePrefix=!("use_prefix"in self)||self.use_prefix;function destroyDb(){self._destroy(opts,function(err,resp){if(err)return callback(err);self._destroyed=!0,self.emit("destroyed"),callback(null,resp||{ok:!0})})}if(isRemote(self))return destroyDb();self.get("_local/_pouch_dependentDbs",function(err,localDoc){if(err)return 404!==err.status?callback(err):destroyDb();var dependentDbs=localDoc.dependentDbs,PouchDB=self.constructor,deletedMap=Object.keys(dependentDbs).map(function(name){var trueName=usePrefix?name.replace(new RegExp("^"+PouchDB.prefix),""):name;return new PouchDB(trueName,self.__opts).destroy()});Promise.all(deletedMap).then(destroyDb,callback)})}),TaskQueue.prototype.execute=function(){var fun;if(this.failed)for(;fun=this.queue.shift();)fun(this.failed);else for(;fun=this.queue.shift();)fun()},TaskQueue.prototype.fail=function(err){this.failed=err,this.execute()},TaskQueue.prototype.ready=function(db){this.isReady=!0,this.db=db,this.execute()},TaskQueue.prototype.addTask=function(fun){this.queue.push(fun),this.failed&&this.execute()},inherits__WEBPACK_IMPORTED_MODULE_3___default()(PouchDB,AbstractPouchDB);var a="undefined"!=typeof AbortController?AbortController:function(){return{abort:function(){}}},f$1=fetch,h=Headers;PouchDB.adapters={},PouchDB.preferredAdapters=[],PouchDB.prefix="_pouch_";var eventEmitter=new events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter;!function(Pouch){Object.keys(events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.prototype).forEach(function(key){"function"==typeof events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.prototype[key]&&(Pouch[key]=eventEmitter[key].bind(eventEmitter))});var destructListeners=Pouch._destructionListeners=new ExportedMap;Pouch.on("ref",function(db){destructListeners.has(db.name)||destructListeners.set(db.name,[]),destructListeners.get(db.name).push(db)}),Pouch.on("unref",function(db){if(destructListeners.has(db.name)){var dbList=destructListeners.get(db.name),pos=dbList.indexOf(db);pos<0||(dbList.splice(pos,1),dbList.length>1?destructListeners.set(db.name,dbList):destructListeners.delete(db.name))}}),Pouch.on("destroyed",function(name){if(destructListeners.has(name)){var dbList=destructListeners.get(name);destructListeners.delete(name),dbList.forEach(function(db){db.emit("destroyed",!0)})}})}(PouchDB),PouchDB.adapter=function(id,obj,addToPreferredAdapters){obj.valid()&&(PouchDB.adapters[id]=obj,addToPreferredAdapters&&PouchDB.preferredAdapters.push(id))},PouchDB.plugin=function(obj){if("function"==typeof obj)obj(PouchDB);else{if("object"!=typeof obj||0===Object.keys(obj).length)throw new Error('Invalid plugin: got "'+obj+'", expected an object or a function');Object.keys(obj).forEach(function(id){PouchDB.prototype[id]=obj[id]})}return this.__defaults&&(PouchDB.__defaults=$inject_Object_assign({},this.__defaults)),PouchDB},PouchDB.defaults=function(defaultOpts){function PouchAlt(name,opts){if(!(this instanceof PouchAlt))return new PouchAlt(name,opts);opts=opts||{},name&&"object"==typeof name&&(name=(opts=name).name,delete opts.name),opts=$inject_Object_assign({},PouchAlt.__defaults,opts),PouchDB.call(this,name,opts)}return inherits__WEBPACK_IMPORTED_MODULE_3___default()(PouchAlt,PouchDB),PouchAlt.preferredAdapters=PouchDB.preferredAdapters.slice(),Object.keys(PouchDB).forEach(function(key){key in PouchAlt||(PouchAlt[key]=PouchDB[key])}),PouchAlt.__defaults=$inject_Object_assign({},this.__defaults,defaultOpts),PouchAlt},PouchDB.fetch=function(url,opts){return f$1(url,opts)};function getFieldFromDoc(doc,parsedField){for(var value=doc,i=0,len=parsedField.length;i<len;i++){if(!(value=value[parsedField[i]]))break}return value}function parseField(fieldName){for(var fields=[],current="",i=0,len=fieldName.length;i<len;i++){var ch=fieldName[i];"."===ch?i>0&&"\\"===fieldName[i-1]?current=current.substring(0,current.length-1)+".":(fields.push(current),current=""):current+=ch}return fields.push(current),fields}var combinationFields=["$or","$nor","$not"];function isCombinationalField(field){return combinationFields.indexOf(field)>-1}function getKey(obj){return Object.keys(obj)[0]}function mergeAndedSelectors(selectors){var res={};return selectors.forEach(function(selector){Object.keys(selector).forEach(function(field){var matcher=selector[field];if("object"!=typeof matcher&&(matcher={$eq:matcher}),isCombinationalField(field))matcher instanceof Array?res[field]=matcher.map(function(m){return mergeAndedSelectors([m])}):res[field]=mergeAndedSelectors([matcher]);else{var fieldMatchers=res[field]=res[field]||{};Object.keys(matcher).forEach(function(operator){var value=matcher[operator];return"$gt"===operator||"$gte"===operator?function(operator,value,fieldMatchers){if(void 0!==fieldMatchers.$eq)return;void 0!==fieldMatchers.$gte?"$gte"===operator?value>fieldMatchers.$gte&&(fieldMatchers.$gte=value):value>=fieldMatchers.$gte&&(delete fieldMatchers.$gte,fieldMatchers.$gt=value):void 0!==fieldMatchers.$gt?"$gte"===operator?value>fieldMatchers.$gt&&(delete fieldMatchers.$gt,fieldMatchers.$gte=value):value>fieldMatchers.$gt&&(fieldMatchers.$gt=value):fieldMatchers[operator]=value}(operator,value,fieldMatchers):"$lt"===operator||"$lte"===operator?function(operator,value,fieldMatchers){if(void 0!==fieldMatchers.$eq)return;void 0!==fieldMatchers.$lte?"$lte"===operator?value<fieldMatchers.$lte&&(fieldMatchers.$lte=value):value<=fieldMatchers.$lte&&(delete fieldMatchers.$lte,fieldMatchers.$lt=value):void 0!==fieldMatchers.$lt?"$lte"===operator?value<fieldMatchers.$lt&&(delete fieldMatchers.$lt,fieldMatchers.$lte=value):value<fieldMatchers.$lt&&(fieldMatchers.$lt=value):fieldMatchers[operator]=value}(operator,value,fieldMatchers):"$ne"===operator?function(value,fieldMatchers){"$ne"in fieldMatchers?fieldMatchers.$ne.push(value):fieldMatchers.$ne=[value]}(value,fieldMatchers):"$eq"===operator?function(value,fieldMatchers){delete fieldMatchers.$gt,delete fieldMatchers.$gte,delete fieldMatchers.$lt,delete fieldMatchers.$lte,delete fieldMatchers.$ne,fieldMatchers.$eq=value}(value,fieldMatchers):void(fieldMatchers[operator]=value)})}})}),res}var MIN_MAGNITUDE=-324,MAGNITUDE_DIGITS=3,SEP="";function collate(a,b){if(a===b)return 0;a=normalizeKey(a),b=normalizeKey(b);var ai=collationIndex(a),bi=collationIndex(b);if(ai-bi!=0)return ai-bi;switch(typeof a){case"number":return a-b;case"boolean":return a<b?-1:1;case"string":return function(a,b){return a===b?0:a>b?1:-1}(a,b)}return Array.isArray(a)?function(a,b){for(var len=Math.min(a.length,b.length),i=0;i<len;i++){var sort=collate(a[i],b[i]);if(0!==sort)return sort}return a.length===b.length?0:a.length>b.length?1:-1}(a,b):function(a,b){for(var ak=Object.keys(a),bk=Object.keys(b),len=Math.min(ak.length,bk.length),i=0;i<len;i++){var sort=collate(ak[i],bk[i]);if(0!==sort)return sort;if(0!==(sort=collate(a[ak[i]],b[bk[i]])))return sort}return ak.length===bk.length?0:ak.length>bk.length?1:-1}(a,b)}function normalizeKey(key){switch(typeof key){case"undefined":return null;case"number":return key===1/0||key===-1/0||isNaN(key)?null:key;case"object":var origKey=key;if(Array.isArray(key)){var len=key.length;key=new Array(len);for(var i=0;i<len;i++)key[i]=normalizeKey(origKey[i])}else{if(key instanceof Date)return key.toJSON();if(null!==key)for(var k in key={},origKey)if(origKey.hasOwnProperty(k)){var val=origKey[k];void 0!==val&&(key[k]=normalizeKey(val))}}}return key}function indexify(key){if(null!==key)switch(typeof key){case"boolean":return key?1:0;case"number":return function(num){if(0===num)return"1";var expFormat=num.toExponential().split(/e\+?/),magnitude=parseInt(expFormat[1],10),neg=num<0,result=neg?"0":"2",magString=(str=((neg?-magnitude:magnitude)-MIN_MAGNITUDE).toString(),padWith="0",upToLength=MAGNITUDE_DIGITS,function(str,padWith,upToLength){for(var padding="",targetLength=upToLength-str.length;padding.length<targetLength;)padding+=padWith;return padding}(str,padWith,upToLength)+str);var str,padWith,upToLength;result+=SEP+magString;var factor=Math.abs(parseFloat(expFormat[0]));neg&&(factor=10-factor);var factorStr=factor.toFixed(20);return factorStr=factorStr.replace(/\.?0+$/,""),result+=SEP+factorStr}(key);case"string":return key.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var isArray=Array.isArray(key),arr=isArray?key:Object.keys(key),i=-1,len=arr.length,result="";if(isArray)for(;++i<len;)result+=toIndexableString(arr[i]);else for(;++i<len;){var objKey=arr[i];result+=toIndexableString(objKey)+toIndexableString(key[objKey])}return result}return""}function toIndexableString(key){return collationIndex(key=normalizeKey(key))+SEP+indexify(key)+"\0"}function parseNumber(str,i){var num,originalIdx=i;if("1"===str[i])num=0,i++;else{var neg="0"===str[i];i++;var numAsString="",magAsString=str.substring(i,i+MAGNITUDE_DIGITS),magnitude=parseInt(magAsString,10)+MIN_MAGNITUDE;for(neg&&(magnitude=-magnitude),i+=MAGNITUDE_DIGITS;;){var ch=str[i];if("\0"===ch)break;numAsString+=ch,i++}num=1===(numAsString=numAsString.split(".")).length?parseInt(numAsString,10):parseFloat(numAsString[0]+"."+numAsString[1]),neg&&(num-=10),0!==magnitude&&(num=parseFloat(num+"e"+magnitude))}return{num:num,length:i-originalIdx}}function pop(stack,metaStack){var obj=stack.pop();if(metaStack.length){var lastMetaElement=metaStack[metaStack.length-1];obj===lastMetaElement.element&&(metaStack.pop(),lastMetaElement=metaStack[metaStack.length-1]);var element=lastMetaElement.element,lastElementIndex=lastMetaElement.index;if(Array.isArray(element))element.push(obj);else if(lastElementIndex===stack.length-2){element[stack.pop()]=obj}else stack.push(obj)}}function collationIndex(x){var idx=["boolean","number","string","object"].indexOf(typeof x);return~idx?null===x?1:Array.isArray(x)?5:idx<3?idx+2:idx+3:Array.isArray(x)?5:void 0}function filterInMemoryFields(rows,requestDef,inMemoryFields){if(rows=rows.filter(function(row){return rowFilter(row.doc,requestDef.selector,inMemoryFields)}),requestDef.sort){var fieldSorter=function(sort){function getFieldValuesAsArray(doc){return sort.map(function(sorting){var parsedField=parseField(getKey(sorting));return getFieldFromDoc(doc,parsedField)})}return function(aRow,bRow){var left,right,collation=collate(getFieldValuesAsArray(aRow.doc),getFieldValuesAsArray(bRow.doc));return 0!==collation?collation:(left=aRow.doc._id,right=bRow.doc._id,left<right?-1:left>right?1:0)}}(requestDef.sort);rows=rows.sort(fieldSorter),"string"!=typeof requestDef.sort[0]&&"desc"===(obj=requestDef.sort[0])[getKey(obj)]&&(rows=rows.reverse())}var obj;if("limit"in requestDef||"skip"in requestDef){var skip=requestDef.skip||0,limit=("limit"in requestDef?requestDef.limit:rows.length)+skip;rows=rows.slice(skip,limit)}return rows}function rowFilter(doc,selector,inMemoryFields){return inMemoryFields.every(function(field){var matcher=selector[field],parsedField=parseField(field),docFieldValue=getFieldFromDoc(doc,parsedField);return isCombinationalField(field)?function(field,matcher,doc){if("$or"===field)return matcher.some(function(orMatchers){return rowFilter(doc,orMatchers,Object.keys(orMatchers))});if("$not"===field)return!rowFilter(doc,matcher,Object.keys(matcher));return!matcher.find(function(orMatchers){return rowFilter(doc,orMatchers,Object.keys(orMatchers))})}(field,matcher,doc):matchSelector(matcher,doc,parsedField,docFieldValue)})}function matchSelector(matcher,doc,parsedField,docFieldValue){return!matcher||Object.keys(matcher).every(function(userOperator){var userValue=matcher[userOperator];return function(userOperator,doc,userValue,parsedField,docFieldValue){if(!matchers[userOperator])throw new Error('unknown operator "'+userOperator+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');return matchers[userOperator](doc,userValue,parsedField,docFieldValue)}(userOperator,doc,userValue,parsedField,docFieldValue)})}function fieldExists(docFieldValue){return null!=docFieldValue}function fieldIsNotUndefined(docFieldValue){return void 0!==docFieldValue}function arrayContainsValue(docFieldValue,userValue){return userValue.some(function(val){return docFieldValue instanceof Array?docFieldValue.indexOf(val)>-1:docFieldValue===val})}var matchers={$elemMatch:function(doc,userValue,parsedField,docFieldValue){return!!Array.isArray(docFieldValue)&&(0!==docFieldValue.length&&("object"==typeof docFieldValue[0]?docFieldValue.some(function(val){return rowFilter(val,userValue,Object.keys(userValue))}):docFieldValue.some(function(val){return matchSelector(userValue,doc,parsedField,val)})))},$allMatch:function(doc,userValue,parsedField,docFieldValue){return!!Array.isArray(docFieldValue)&&(0!==docFieldValue.length&&("object"==typeof docFieldValue[0]?docFieldValue.every(function(val){return rowFilter(val,userValue,Object.keys(userValue))}):docFieldValue.every(function(val){return matchSelector(userValue,doc,parsedField,val)})))},$eq:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&0===collate(docFieldValue,userValue)},$gte:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)>=0},$gt:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)>0},$lte:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)<=0},$lt:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)<0},$exists:function(doc,userValue,parsedField,docFieldValue){return userValue?fieldIsNotUndefined(docFieldValue):!fieldIsNotUndefined(docFieldValue)},$mod:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&function(docFieldValue,userValue){var divisor=userValue[0],mod=userValue[1];if(0===divisor)throw new Error("Bad divisor, cannot divide by zero");if(parseInt(divisor,10)!==divisor)throw new Error("Divisor is not an integer");if(parseInt(mod,10)!==mod)throw new Error("Modulus is not an integer");return parseInt(docFieldValue,10)===docFieldValue&&docFieldValue%divisor===mod}(docFieldValue,userValue)},$ne:function(doc,userValue,parsedField,docFieldValue){return userValue.every(function(neValue){return 0!==collate(docFieldValue,neValue)})},$in:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&arrayContainsValue(docFieldValue,userValue)},$nin:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&!arrayContainsValue(docFieldValue,userValue)},$size:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&function(docFieldValue,userValue){return docFieldValue.length===userValue}(docFieldValue,userValue)},$all:function(doc,userValue,parsedField,docFieldValue){return Array.isArray(docFieldValue)&&function(docFieldValue,userValue){return userValue.every(function(val){return docFieldValue.indexOf(val)>-1})}(docFieldValue,userValue)},$regex:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&function(docFieldValue,userValue){return new RegExp(userValue).test(docFieldValue)}(docFieldValue,userValue)},$type:function(doc,userValue,parsedField,docFieldValue){return function(docFieldValue,userValue){switch(userValue){case"null":return null===docFieldValue;case"boolean":return"boolean"==typeof docFieldValue;case"number":return"number"==typeof docFieldValue;case"string":return"string"==typeof docFieldValue;case"array":return docFieldValue instanceof Array;case"object":return"[object Object]"==={}.toString.call(docFieldValue)}throw new Error(userValue+" not supported as a type.Please use one of object, string, array, number, boolean or null.")}(docFieldValue,userValue)}};function matchesSelector(doc,selector){if("object"!=typeof selector)throw new Error("Selector error: expected a JSON object");var rowsMatched=filterInMemoryFields([{doc:doc}],{selector:selector=function(input){var result=clone(input),wasAnded=!1;"$and"in result&&(result=mergeAndedSelectors(result.$and),wasAnded=!0),["$or","$nor"].forEach(function(orOrNor){orOrNor in result&&result[orOrNor].forEach(function(subSelector){for(var fields=Object.keys(subSelector),i=0;i<fields.length;i++){var field=fields[i],matcher=subSelector[field];"object"==typeof matcher&&null!==matcher||(subSelector[field]={$eq:matcher})}})}),"$not"in result&&(result.$not=mergeAndedSelectors([result.$not]));for(var fields=Object.keys(result),i=0;i<fields.length;i++){var field=fields[i],matcher=result[field];"object"!=typeof matcher||null===matcher?matcher={$eq:matcher}:"$ne"in matcher&&!wasAnded&&(matcher.$ne=[matcher.$ne]),result[field]=matcher}return result}(selector)},Object.keys(selector));return rowsMatched&&1===rowsMatched.length}function validate(opts,callback){if(opts.selector&&opts.filter&&"_selector"!==opts.filter){var filterName="string"==typeof opts.filter?opts.filter:"function";return callback(new Error('selector invalid for filter "'+filterName+'"'))}callback()}function normalize(opts){opts.view&&!opts.filter&&(opts.filter="_view"),opts.selector&&!opts.filter&&(opts.filter="_selector"),opts.filter&&"string"==typeof opts.filter&&("_view"===opts.filter?opts.view=normalizeDesignDocFunctionName(opts.view):opts.filter=normalizeDesignDocFunctionName(opts.filter))}function shouldFilter(changesHandler,opts){return opts.filter&&"string"==typeof opts.filter&&!opts.doc_ids&&!isRemote(changesHandler.db)}function filter(changesHandler,opts){var callback=opts.complete;if("_view"===opts.filter){if(!opts.view||"string"!=typeof opts.view){var err=createError(BAD_REQUEST,"`view` filter parameter not found or invalid.");return callback(err)}var viewName=parseDesignDocFunctionName(opts.view);changesHandler.db.get("_design/"+viewName[0],function(err,ddoc){if(changesHandler.isCancelled)return callback(null,{status:"cancelled"});if(err)return callback(generateErrorFromResponse(err));var mapFun=ddoc&&ddoc.views&&ddoc.views[viewName[1]]&&ddoc.views[viewName[1]].map;if(!mapFun)return callback(createError(MISSING_DOC,ddoc.views?"missing json key: "+viewName[1]:"missing json key: views"));opts.filter=scopeEval(["return function(doc) {",'  "use strict";',"  var emitted = false;","  var emit = function (a, b) {","    emitted = true;","  };","  var view = "+mapFun+";","  view(doc);","  if (emitted) {","    return true;","  }","};"].join("\n"),{}),changesHandler.doChanges(opts)})}else if(opts.selector)opts.filter=function(doc){return matchesSelector(doc,opts.selector)},changesHandler.doChanges(opts);else{var filterName=parseDesignDocFunctionName(opts.filter);changesHandler.db.get("_design/"+filterName[0],function(err,ddoc){if(changesHandler.isCancelled)return callback(null,{status:"cancelled"});if(err)return callback(generateErrorFromResponse(err));var filterFun=ddoc&&ddoc.filters&&ddoc.filters[filterName[1]];if(!filterFun)return callback(createError(MISSING_DOC,ddoc&&ddoc.filters?"missing json key: "+filterName[1]:"missing json key: filters"));opts.filter=scopeEval('"use strict";\nreturn '+filterFun+";",{}),changesHandler.doChanges(opts)})}}function toObject(array){return array.reduce(function(obj,item){return obj[item]=!0,obj},{})}PouchDB.plugin(function(PouchDB){PouchDB._changesFilterPlugin={validate:validate,normalize:normalize,shouldFilter:shouldFilter,filter:filter}}),PouchDB.version="7.0.0";var reservedWords=toObject(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),dataWords=toObject(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);function parseRevisionInfo(rev){if(!/^\d+-./.test(rev))return createError(INVALID_REV);var idx=rev.indexOf("-"),left=rev.substring(0,idx),right=rev.substring(idx+1);return{prefix:parseInt(left,10),id:right}}function parseDoc(doc,newEdits,dbOpts){var nRevNum,newRevId,revInfo;dbOpts||(dbOpts={deterministic_revs:!0});var opts={status:"available"};if(doc._deleted&&(opts.deleted=!0),newEdits)if(doc._id||(doc._id=uuid()),newRevId=rev$$1(doc,dbOpts.deterministic_revs),doc._rev){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;doc._rev_tree=[{pos:revInfo.prefix,ids:[revInfo.id,{status:"missing"},[[newRevId,opts,[]]]]}],nRevNum=revInfo.prefix+1}else doc._rev_tree=[{pos:1,ids:[newRevId,opts,[]]}],nRevNum=1;else if(doc._revisions&&(doc._rev_tree=function(revisions,opts){for(var pos=revisions.start-revisions.ids.length+1,revisionIds=revisions.ids,ids=[revisionIds[0],opts,[]],i=1,len=revisionIds.length;i<len;i++)ids=[revisionIds[i],{status:"missing"},[ids]];return[{pos:pos,ids:ids}]}(doc._revisions,opts),nRevNum=doc._revisions.start,newRevId=doc._revisions.ids[0]),!doc._rev_tree){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;nRevNum=revInfo.prefix,newRevId=revInfo.id,doc._rev_tree=[{pos:nRevNum,ids:[newRevId,opts,[]]}]}invalidIdError(doc._id),doc._rev=nRevNum+"-"+newRevId;var result={metadata:{},data:{}};for(var key in doc)if(Object.prototype.hasOwnProperty.call(doc,key)){var specialKey="_"===key[0];if(specialKey&&!reservedWords[key]){var error=createError(DOC_VALIDATION,key);throw error.message=DOC_VALIDATION.message+": "+key,error}specialKey&&!dataWords[key]?result.metadata[key.slice(1)]=doc[key]:result.data[key]=doc[key]}return result}function preprocessString(att,blobType,callback){var asBinary=function(data){try{return thisAtob(data)}catch(e){return{error:createError(BAD_ARG,"Attachment is not a valid base64 string")}}}(att.data);if(asBinary.error)return callback(asBinary.error);att.length=asBinary.length,att.data="blob"===blobType?binStringToBluffer(asBinary,att.content_type):"base64"===blobType?thisBtoa(asBinary):asBinary,binaryMd5(asBinary,function(result){att.digest="md5-"+result,callback()})}function preprocessAttachment(att,blobType,callback){if(att.stub)return callback();"string"==typeof att.data?preprocessString(att,blobType,callback):function(att,blobType,callback){binaryMd5(att.data,function(md5){att.digest="md5-"+md5,att.length=att.data.size||att.data.length||0,"binary"===blobType?blobToBinaryString(att.data,function(binString){att.data=binString,callback()}):"base64"===blobType?blobToBase64(att.data,function(b64){att.data=b64,callback()}):callback()})}(att,blobType,callback)}function updateDoc(revLimit,prev,docInfo,results,i,cb,writeDoc,newEdits){if(function(revs,rev){for(var node,toVisit=revs.slice(),splitRev=rev.split("-"),targetPos=parseInt(splitRev[0],10),targetId=splitRev[1];node=toVisit.pop();){if(node.pos===targetPos&&node.ids[0]===targetId)return!0;for(var branches=node.ids[2],i=0,len=branches.length;i<len;i++)toVisit.push({pos:node.pos+1,ids:branches[i]})}return!1}(prev.rev_tree,docInfo.metadata.rev)&&!newEdits)return results[i]=docInfo,cb();var previousWinningRev=prev.winningRev||winningRev(prev),previouslyDeleted="deleted"in prev?prev.deleted:isDeleted(prev,previousWinningRev),deleted="deleted"in docInfo.metadata?docInfo.metadata.deleted:isDeleted(docInfo.metadata),isRoot=/^1-/.test(docInfo.metadata.rev);if(previouslyDeleted&&!deleted&&newEdits&&isRoot){var newDoc=docInfo.data;newDoc._rev=previousWinningRev,newDoc._id=docInfo.metadata.id,docInfo=parseDoc(newDoc,newEdits)}var merged=merge(prev.rev_tree,docInfo.metadata.rev_tree[0],revLimit);if(newEdits&&(previouslyDeleted&&deleted&&"new_leaf"!==merged.conflicts||!previouslyDeleted&&"new_leaf"!==merged.conflicts||previouslyDeleted&&!deleted&&"new_branch"===merged.conflicts)){var err=createError(REV_CONFLICT);return results[i]=err,cb()}var newRev=docInfo.metadata.rev;docInfo.metadata.rev_tree=merged.tree,docInfo.stemmedRevs=merged.stemmedRevs||[],prev.rev_map&&(docInfo.metadata.rev_map=prev.rev_map);var winningRev$$1=winningRev(docInfo.metadata),winningRevIsDeleted=isDeleted(docInfo.metadata,winningRev$$1),delta=previouslyDeleted===winningRevIsDeleted?0:previouslyDeleted<winningRevIsDeleted?-1:1;writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRev===winningRev$$1?winningRevIsDeleted:isDeleted(docInfo.metadata,newRev),!0,delta,i,cb)}function processDocs(revLimit,docInfos,api,fetchedDocs,tx,results,writeDoc,opts,overallCallback){revLimit=revLimit||1e3;var newEdits=opts.new_edits,idsToDocs=new ExportedMap,docsDone=0,docsToDo=docInfos.length;function checkAllDocsDone(){++docsDone===docsToDo&&overallCallback&&overallCallback()}docInfos.forEach(function(currentDoc,resultsIdx){if(currentDoc._id&&isLocalId(currentDoc._id)){var fun=currentDoc._deleted?"_removeLocal":"_putLocal";api[fun](currentDoc,{ctx:tx},function(err,res){results[resultsIdx]=err||res,checkAllDocsDone()})}else{var id=currentDoc.metadata.id;idsToDocs.has(id)?(docsToDo--,idsToDocs.get(id).push([currentDoc,resultsIdx])):idsToDocs.set(id,[[currentDoc,resultsIdx]])}}),idsToDocs.forEach(function(docs,id){var numDone=0;function docWritten(){++numDone<docs.length?nextDoc():checkAllDocsDone()}function nextDoc(){var value=docs[numDone],currentDoc=value[0],resultsIdx=value[1];if(fetchedDocs.has(id))updateDoc(revLimit,fetchedDocs.get(id),currentDoc,results,resultsIdx,docWritten,writeDoc,newEdits);else{var merged=merge([],currentDoc.metadata.rev_tree[0],revLimit);currentDoc.metadata.rev_tree=merged.tree,currentDoc.stemmedRevs=merged.stemmedRevs||[],function(docInfo,resultsIdx,callback){var winningRev$$1=winningRev(docInfo.metadata),deleted=isDeleted(docInfo.metadata,winningRev$$1);if("was_delete"in opts&&deleted)return results[resultsIdx]=createError(MISSING_DOC,"deleted"),callback();if(newEdits&&function(docInfo){return"missing"===docInfo.metadata.rev_tree[0].ids[1].status}(docInfo)){var err=createError(REV_CONFLICT);return results[resultsIdx]=err,callback()}writeDoc(docInfo,winningRev$$1,deleted,deleted,!1,deleted?0:1,resultsIdx,callback)}(currentDoc,resultsIdx,docWritten)}}nextDoc()})}var ADAPTER_VERSION=5,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",ATTACH_AND_SEQ_STORE="attach-seq-store",META_STORE="meta-store",LOCAL_STORE="local-store",DETECT_BLOB_SUPPORT_STORE="detect-blob-support";function safeJsonStringify(json){try{return JSON.stringify(json)}catch(e){return vuvuzela__WEBPACK_IMPORTED_MODULE_6___default.a.stringify(json)}}function idbError(callback){return function(evt){var message="unknown_error";evt.target&&evt.target.error&&(message=evt.target.error.name||evt.target.error.message),callback(createError(IDB_ERROR,message,evt.type))}}function encodeMetadata(metadata,winningRev,deleted){return{data:safeJsonStringify(metadata),winningRev:winningRev,deletedOrLocal:deleted?"1":"0",seq:metadata.seq,id:metadata.id}}function decodeMetadata(storedObject){if(!storedObject)return null;var metadata=function(str){try{return JSON.parse(str)}catch(e){return vuvuzela__WEBPACK_IMPORTED_MODULE_6___default.a.parse(str)}}(storedObject.data);return metadata.winningRev=storedObject.winningRev,metadata.deleted="1"===storedObject.deletedOrLocal,metadata.seq=storedObject.seq,metadata}function decodeDoc(doc){if(!doc)return doc;var idx=doc._doc_id_rev.lastIndexOf(":");return doc._id=doc._doc_id_rev.substring(0,idx-1),doc._rev=doc._doc_id_rev.substring(idx+1),delete doc._doc_id_rev,doc}function readBlobData(body,type,asBlob,callback){asBlob?callback(body?"string"!=typeof body?body:b64ToBluffer(body,type):createBlob([""],{type:type})):body?"string"!=typeof body?readAsBinaryString(body,function(binary){callback(thisBtoa(binary))}):callback(body):callback("")}function fetchAttachmentsIfNecessary(doc,opts,txn,cb){var attachments=Object.keys(doc._attachments||{});if(!attachments.length)return cb&&cb();var numDone=0;function checkDone(){++numDone===attachments.length&&cb&&cb()}attachments.forEach(function(att){opts.attachments&&opts.include_docs?function(doc,att){var attObj=doc._attachments[att],digest=attObj.digest;txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e){attObj.body=e.target.result.body,checkDone()}}(doc,att):(doc._attachments[att].stub=!0,checkDone())})}function postProcessAttachments(results,asBlob){return Promise.all(results.map(function(row){if(row.doc&&row.doc._attachments){var attNames=Object.keys(row.doc._attachments);return Promise.all(attNames.map(function(att){var attObj=row.doc._attachments[att];if("body"in attObj){var body=attObj.body,type=attObj.content_type;return new Promise(function(resolve){readBlobData(body,type,asBlob,function(data){row.doc._attachments[att]=$inject_Object_assign(pick(attObj,["digest","content_type"]),{data:data}),resolve()})})}}))}}))}function compactRevs(revs,docId,txn){var possiblyOrphanedDigests=[],seqStore=txn.objectStore(BY_SEQ_STORE),attStore=txn.objectStore(ATTACH_STORE),attAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE),count=revs.length;function checkDone(){--count||function(){if(!possiblyOrphanedDigests.length)return;possiblyOrphanedDigests.forEach(function(digest){var countReq=attAndSeqStore.index("digestSeq").count(IDBKeyRange.bound(digest+"::",digest+"::￿",!1,!1));countReq.onsuccess=function(e){var count=e.target.result;count||attStore.delete(digest)}})}()}revs.forEach(function(rev){var index=seqStore.index("_doc_id_rev"),key=docId+"::"+rev;index.getKey(key).onsuccess=function(e){var seq=e.target.result;if("number"!=typeof seq)return checkDone();seqStore.delete(seq),attAndSeqStore.index("seq").openCursor(IDBKeyRange.only(seq)).onsuccess=function(event){var cursor=event.target.result;if(cursor){var digest=cursor.value.digestSeq.split("::")[0];possiblyOrphanedDigests.push(digest),attAndSeqStore.delete(cursor.primaryKey),cursor.continue()}else checkDone()}}})}function openTransactionSafely(idb,stores,mode){try{return{txn:idb.transaction(stores,mode)}}catch(err){return{error:err}}}var changesHandler=new Changes;function idbBulkDocs(dbOpts,req,opts,api,idb,callback){for(var txn,docStore,bySeqStore,attachStore,attachAndSeqStore,metaStore,docInfoError,metaDoc,docInfos=req.docs,i=0,len=docInfos.length;i<len;i++){var doc=docInfos[i];doc._id&&isLocalId(doc._id)||(doc=docInfos[i]=parseDoc(doc,opts.new_edits,dbOpts)).error&&!docInfoError&&(docInfoError=doc)}if(docInfoError)return callback(docInfoError);var allDocsProcessed=!1,docCountDelta=0,results=new Array(docInfos.length),fetchedDocs=new ExportedMap,preconditionErrored=!1,blobType=api._meta.blobSupport?"blob":"base64";function onAllDocsProcessed(){allDocsProcessed=!0,updateDocCountIfReady()}function updateDocCountIfReady(){metaDoc&&allDocsProcessed&&(metaDoc.docCount+=docCountDelta,metaStore.put(metaDoc))}function complete(){preconditionErrored||(changesHandler.notify(api._meta.name),callback(null,results))}function writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRevIsDeleted,isUpdate,delta,resultsIdx,callback){docInfo.metadata.winningRev=winningRev$$1,docInfo.metadata.deleted=winningRevIsDeleted;var doc=docInfo.data;if(doc._id=docInfo.metadata.id,doc._rev=docInfo.metadata.rev,newRevIsDeleted&&(doc._deleted=!0),doc._attachments&&Object.keys(doc._attachments).length)return function(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback){var doc=docInfo.data,numDone=0,attachments=Object.keys(doc._attachments);function collectResults(){numDone===attachments.length&&finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback)}function attachmentSaved(){numDone++,collectResults()}attachments.forEach(function(key){var att=docInfo.data._attachments[key];if(att.stub)numDone++,collectResults();else{var data=att.data;delete att.data,att.revpos=parseInt(winningRev$$1,10);var digest=att.digest;!function(digest,data,callback){attachStore.count(digest).onsuccess=function(e){var count=e.target.result;if(count)return callback();var newAtt={digest:digest,body:data},putReq=attachStore.put(newAtt);putReq.onsuccess=callback}}(digest,data,attachmentSaved)}})}(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback);docCountDelta+=delta,updateDocCountIfReady(),finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback)}function finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback){var doc=docInfo.data,metadata=docInfo.metadata;function afterPutDoc(e){var revsToDelete=docInfo.stemmedRevs||[];isUpdate&&api.auto_compaction&&(revsToDelete=revsToDelete.concat(function(metadata){var revs=[];return traverseRevTree(metadata.rev_tree,function(isLeaf,pos,revHash,ctx,opts){"available"!==opts.status||isLeaf||(revs.push(pos+"-"+revHash),opts.status="missing")}),revs}(docInfo.metadata))),revsToDelete&&revsToDelete.length&&compactRevs(revsToDelete,docInfo.metadata.id,txn),metadata.seq=e.target.result;var metadataToStore=encodeMetadata(metadata,winningRev$$1,winningRevIsDeleted);docStore.put(metadataToStore).onsuccess=afterPutMetadata}function afterPutMetadata(){results[resultsIdx]={ok:!0,id:metadata.id,rev:metadata.rev},fetchedDocs.set(docInfo.metadata.id,docInfo.metadata),function(docInfo,seq,callback){var attsAdded=0,attsToAdd=Object.keys(docInfo.data._attachments||{});if(!attsToAdd.length)return callback();function checkDone(){++attsAdded===attsToAdd.length&&callback()}function add(att){var digest=docInfo.data._attachments[att].digest,req=attachAndSeqStore.put({seq:seq,digestSeq:digest+"::"+seq});req.onsuccess=checkDone,req.onerror=function(e){e.preventDefault(),e.stopPropagation(),checkDone()}}for(var i=0;i<attsToAdd.length;i++)add(attsToAdd[i])}(docInfo,metadata.seq,callback)}doc._doc_id_rev=metadata.id+"::"+metadata.rev,delete doc._id,delete doc._rev;var putReq=bySeqStore.put(doc);putReq.onsuccess=afterPutDoc,putReq.onerror=function(e){e.preventDefault(),e.stopPropagation(),bySeqStore.index("_doc_id_rev").getKey(doc._doc_id_rev).onsuccess=function(e){bySeqStore.put(doc,e.target.result).onsuccess=afterPutDoc}}}!function(docInfos,blobType,callback){if(!docInfos.length)return callback();var overallErr,docv=0;function done(){docv++,docInfos.length===docv&&(overallErr?callback(overallErr):callback())}docInfos.forEach(function(docInfo){var attachments=docInfo.data&&docInfo.data._attachments?Object.keys(docInfo.data._attachments):[],recv=0;if(!attachments.length)return done();function processedAttachment(err){overallErr=err,++recv===attachments.length&&done()}for(var key in docInfo.data._attachments)docInfo.data._attachments.hasOwnProperty(key)&&preprocessAttachment(docInfo.data._attachments[key],blobType,processedAttachment)})}(docInfos,blobType,function(err){if(err)return callback(err);!function(){var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,LOCAL_STORE,ATTACH_AND_SEQ_STORE,META_STORE],"readwrite");if(txnResult.error)return callback(txnResult.error);(txn=txnResult.txn).onabort=idbError(callback),txn.ontimeout=idbError(callback),txn.oncomplete=complete,docStore=txn.objectStore(DOC_STORE),bySeqStore=txn.objectStore(BY_SEQ_STORE),attachStore=txn.objectStore(ATTACH_STORE),attachAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE),(metaStore=txn.objectStore(META_STORE)).get(META_STORE).onsuccess=function(e){metaDoc=e.target.result,updateDocCountIfReady()},function(finish){var digests=[];if(docInfos.forEach(function(docInfo){docInfo.data&&docInfo.data._attachments&&Object.keys(docInfo.data._attachments).forEach(function(filename){var att=docInfo.data._attachments[filename];att.stub&&digests.push(att.digest)})}),!digests.length)return finish();var err,numDone=0;digests.forEach(function(digest){!function(digest,callback){attachStore.get(digest).onsuccess=function(e){if(e.target.result)callback();else{var err=createError(MISSING_STUB,"unknown stub attachment with digest "+digest);err.status=412,callback(err)}}}(digest,function(attErr){attErr&&!err&&(err=attErr),++numDone===digests.length&&finish(err)})})}(function(err){if(err)return preconditionErrored=!0,callback(err);!function(){if(!docInfos.length)return;var numFetched=0;function checkDone(){++numFetched===docInfos.length&&processDocs(dbOpts.revs_limit,docInfos,api,fetchedDocs,txn,results,writeDoc,opts,onAllDocsProcessed)}function readMetadata(event){var metadata=decodeMetadata(event.target.result);metadata&&fetchedDocs.set(metadata.id,metadata),checkDone()}for(var i=0,len=docInfos.length;i<len;i++){var docInfo=docInfos[i];if(docInfo._id&&isLocalId(docInfo._id))checkDone();else{var req=docStore.get(docInfo.metadata.id);req.onsuccess=readMetadata}}}()})}()})}function runBatchedCursor(objectStore,keyRange,descending,batchSize,onBatch){var keysBatch,valuesBatch,pseudoCursor;function onGetAll(e){valuesBatch=e.target.result,keysBatch&&onBatch(keysBatch,valuesBatch,pseudoCursor)}function onGetAllKeys(e){keysBatch=e.target.result,valuesBatch&&onBatch(keysBatch,valuesBatch,pseudoCursor)}function onCursor(e){var cursor=e.target.result;if(!cursor)return onBatch();onBatch([cursor.key],[cursor.value],cursor)}-1===batchSize&&(batchSize=1e3),"function"==typeof objectStore.getAll&&"function"==typeof objectStore.getAllKeys&&batchSize>1&&!descending?(pseudoCursor={continue:function(){if(!keysBatch.length)return onBatch();var newKeyRange,lastKey=keysBatch[keysBatch.length-1];if(keyRange&&keyRange.upper)try{newKeyRange=IDBKeyRange.bound(lastKey,keyRange.upper,!0,keyRange.upperOpen)}catch(e){if("DataError"===e.name&&0===e.code)return onBatch()}else newKeyRange=IDBKeyRange.lowerBound(lastKey,!0);keyRange=newKeyRange,keysBatch=null,valuesBatch=null,objectStore.getAll(keyRange,batchSize).onsuccess=onGetAll,objectStore.getAllKeys(keyRange,batchSize).onsuccess=onGetAllKeys}},objectStore.getAll(keyRange,batchSize).onsuccess=onGetAll,objectStore.getAllKeys(keyRange,batchSize).onsuccess=onGetAllKeys):descending?objectStore.openCursor(keyRange,"prev").onsuccess=onCursor:objectStore.openCursor(keyRange).onsuccess=onCursor}function idbAllDocs(opts,idb,callback){var keyRange,keyRangeError,start="startkey"in opts&&opts.startkey,end="endkey"in opts&&opts.endkey,key="key"in opts&&opts.key,keys="keys"in opts&&opts.keys,skip=opts.skip||0,limit="number"==typeof opts.limit?opts.limit:-1,inclusiveEnd=!1!==opts.inclusive_end;if(!keys&&(keyRangeError=(keyRange=function(start,end,inclusiveEnd,key,descending){try{if(start&&end)return descending?IDBKeyRange.bound(end,start,!inclusiveEnd,!1):IDBKeyRange.bound(start,end,!1,!inclusiveEnd);if(start)return descending?IDBKeyRange.upperBound(start):IDBKeyRange.lowerBound(start);if(end)return descending?IDBKeyRange.lowerBound(end,!inclusiveEnd):IDBKeyRange.upperBound(end,!inclusiveEnd);if(key)return IDBKeyRange.only(key)}catch(e){return{error:e}}return null}(start,end,inclusiveEnd,key,opts.descending))&&keyRange.error)&&("DataError"!==keyRangeError.name||0!==keyRangeError.code))return callback(createError(IDB_ERROR,keyRangeError.name,keyRangeError.message));var stores=[DOC_STORE,BY_SEQ_STORE,META_STORE];opts.attachments&&stores.push(ATTACH_STORE);var txnResult=openTransactionSafely(idb,stores,"readonly");if(txnResult.error)return callback(txnResult.error);var txn=txnResult.txn;txn.oncomplete=function(){opts.attachments?postProcessAttachments(results,opts.binary).then(onResultsReady):onResultsReady()},txn.onabort=idbError(callback);var docCount,updateSeq,docStore=txn.objectStore(DOC_STORE),seqStore=txn.objectStore(BY_SEQ_STORE),metaStore=txn.objectStore(META_STORE),docIdRevIndex=seqStore.index("_doc_id_rev"),results=[];function allDocsInner(winningRev$$1,metadata){var row={id:metadata.id,key:metadata.id,value:{rev:winningRev$$1}};metadata.deleted?keys&&(results.push(row),row.value.deleted=!0,row.doc=null):skip--<=0&&(results.push(row),opts.include_docs&&function(metadata,row,winningRev$$1){var key=metadata.id+"::"+winningRev$$1;docIdRevIndex.get(key).onsuccess=function(e){if(row.doc=decodeDoc(e.target.result)||{},opts.conflicts){var conflicts=collectConflicts(metadata);conflicts.length&&(row.doc._conflicts=conflicts)}fetchAttachmentsIfNecessary(row.doc,opts,txn)}}(metadata,row,winningRev$$1))}function processBatch(batchValues){for(var i=0,len=batchValues.length;i<len&&results.length!==limit;i++){var batchValue=batchValues[i];if(batchValue.error&&keys)results.push(batchValue);else{var metadata=decodeMetadata(batchValue);allDocsInner(metadata.winningRev,metadata)}}}function onBatch(batchKeys,batchValues,cursor){cursor&&(processBatch(batchValues),results.length<limit&&cursor.continue())}function onResultsReady(){var returnVal={total_rows:docCount,offset:opts.skip,rows:results};opts.update_seq&&void 0!==updateSeq&&(returnVal.update_seq=updateSeq),callback(null,returnVal)}return metaStore.get(META_STORE).onsuccess=function(e){docCount=e.target.result.docCount},opts.update_seq&&function(objectStore,onSuccess){objectStore.openCursor(null,"prev").onsuccess=function(e){var cursor=e.target.result,maxKey=void 0;cursor&&cursor.key&&(maxKey=cursor.key);return onSuccess({target:{result:[maxKey]}})}}(seqStore,function(e){e.target.result&&e.target.result.length>0&&(updateSeq=e.target.result[0])}),keyRangeError||0===limit?void 0:keys?function(keys,docStore,onBatch){var valuesBatch=new Array(keys.length),count=0;keys.forEach(function(key,index){docStore.get(key).onsuccess=function(event){event.target.result?valuesBatch[index]=event.target.result:valuesBatch[index]={key:key,error:"not_found"},++count===keys.length&&onBatch(keys,valuesBatch,{})}})}(opts.keys,docStore,onBatch):-1===limit?function(objectStore,keyRange,onSuccess){if("function"!=typeof objectStore.getAll){var values=[];objectStore.openCursor(keyRange).onsuccess=function(e){var cursor=e.target.result;cursor?(values.push(cursor.value),cursor.continue()):onSuccess({target:{result:values}})}}else objectStore.getAll(keyRange).onsuccess=onSuccess}(docStore,keyRange,function(e){var values=e.target.result;opts.descending&&(values=values.reverse()),processBatch(values)}):void runBatchedCursor(docStore,keyRange,opts.descending,limit+skip,onBatch)}var running=!1,queue=[];function applyNext(){!running&&queue.length&&(running=!0,queue.shift()())}function changes(opts,api,dbName,idb){if((opts=clone(opts)).continuous){var id=dbName+":"+uuid();return changesHandler.addListener(dbName,id,api,opts),changesHandler.notify(dbName),{cancel:function(){changesHandler.removeListener(dbName,id)}}}var docIds=opts.doc_ids&&new ExportedSet(opts.doc_ids);opts.since=opts.since||0;var lastSeq=opts.since,limit="limit"in opts?opts.limit:-1;0===limit&&(limit=1);var txn,bySeqStore,docStore,docIdRevIndex,results=[],numResults=0,filter=filterChange(opts),docIdsToMetadata=new ExportedMap;function onGetMetadata(doc,seq,metadata,cb){if(metadata.seq!==seq)return cb();if(metadata.winningRev===doc._rev)return cb(metadata,doc);var docIdRev=doc._id+"::"+metadata.winningRev;docIdRevIndex.get(docIdRev).onsuccess=function(e){cb(metadata,decodeDoc(e.target.result))}}function finish(){opts.complete(null,{results:results,last_seq:lastSeq})}var objectStores=[DOC_STORE,BY_SEQ_STORE];opts.attachments&&objectStores.push(ATTACH_STORE);var txnResult=openTransactionSafely(idb,objectStores,"readonly");if(txnResult.error)return opts.complete(txnResult.error);(txn=txnResult.txn).onabort=idbError(opts.complete),txn.oncomplete=function(){!opts.continuous&&opts.attachments?postProcessAttachments(results).then(finish):finish()},bySeqStore=txn.objectStore(BY_SEQ_STORE),docStore=txn.objectStore(DOC_STORE),docIdRevIndex=bySeqStore.index("_doc_id_rev"),runBatchedCursor(bySeqStore,opts.since&&!opts.descending?IDBKeyRange.lowerBound(opts.since,!0):null,opts.descending,limit,function(batchKeys,batchValues,cursor){if(cursor&&batchKeys.length){var winningDocs=new Array(batchKeys.length),metadatas=new Array(batchKeys.length),numDone=0;batchValues.forEach(function(value,i){!function(doc,seq,cb){if(docIds&&!docIds.has(doc._id))return cb();var metadata=docIdsToMetadata.get(doc._id);if(metadata)return onGetMetadata(doc,seq,metadata,cb);docStore.get(doc._id).onsuccess=function(e){metadata=decodeMetadata(e.target.result),docIdsToMetadata.set(doc._id,metadata),onGetMetadata(doc,seq,metadata,cb)}}(decodeDoc(value),batchKeys[i],function(metadata,winningDoc){metadatas[i]=metadata,winningDocs[i]=winningDoc,++numDone===batchKeys.length&&function(){for(var promises=[],i=0,len=winningDocs.length;i<len&&numResults!==limit;i++){var winningDoc=winningDocs[i];if(winningDoc){var metadata=metadatas[i];promises.push(processMetadataAndWinningDoc(metadata,winningDoc))}}Promise.all(promises).then(function(changes){for(var i=0,len=changes.length;i<len;i++)changes[i]&&opts.onChange(changes[i])}).catch(opts.complete),numResults!==limit&&cursor.continue()}()})})}function processMetadataAndWinningDoc(metadata,winningDoc){var change=opts.processChange(winningDoc,metadata,opts);lastSeq=change.seq=metadata.seq;var filtered=filter(change);return"object"==typeof filtered?Promise.reject(filtered):filtered?(numResults++,opts.return_docs&&results.push(change),opts.attachments&&opts.include_docs?new Promise(function(resolve){fetchAttachmentsIfNecessary(winningDoc,opts,txn,function(){postProcessAttachments([change],opts.binary).then(function(){resolve(change)})})}):Promise.resolve(change)):Promise.resolve()}})}var blobSupportPromise,cachedDBs=new ExportedMap,openReqList=new ExportedMap;function IdbPouch(opts,callback){var api=this;!function(action,callback,PouchDB){queue.push(function(){action(function(err,res){!function(fun,err,res,PouchDB){try{fun(err,res)}catch(err){PouchDB.emit("error",err)}}(callback,err,res,PouchDB),running=!1,immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){applyNext()})})}),applyNext()}(function(thisCallback){!function(api,opts,callback){var dbName=opts.name,idb=null;function addDeletedOrLocalIndex(txn,callback){var docStore=txn.objectStore(DOC_STORE);docStore.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),docStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){var metadata=cursor.value,deleted=isDeleted(metadata);metadata.deletedOrLocal=deleted?"1":"0",docStore.put(metadata),cursor.continue()}else callback()}}function migrateLocalStore(txn,cb){var localStore=txn.objectStore(LOCAL_STORE),docStore=txn.objectStore(DOC_STORE),seqStore=txn.objectStore(BY_SEQ_STORE),cursor=docStore.openCursor();cursor.onsuccess=function(event){var cursor=event.target.result;if(cursor){var metadata=cursor.value,docId=metadata.id,local=isLocalId(docId),rev=winningRev(metadata);if(local){var docIdRev=docId+"::"+rev,start=docId+"::",end=docId+"::~",index=seqStore.index("_doc_id_rev"),range=IDBKeyRange.bound(start,end,!1,!1),seqCursor=index.openCursor(range);seqCursor.onsuccess=function(e){if(seqCursor=e.target.result){var data=seqCursor.value;data._doc_id_rev===docIdRev&&localStore.put(data),seqStore.delete(seqCursor.primaryKey),seqCursor.continue()}else docStore.delete(cursor.primaryKey),cursor.continue()}}else cursor.continue()}else cb&&cb()}}function migrateAttsAndSeqs(txn,callback){var seqStore=txn.objectStore(BY_SEQ_STORE),attStore=txn.objectStore(ATTACH_STORE),attAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE),req=attStore.count();req.onsuccess=function(e){var count=e.target.result;if(!count)return callback();seqStore.openCursor().onsuccess=function(e){var cursor=e.target.result;if(!cursor)return callback();for(var doc=cursor.value,seq=cursor.primaryKey,atts=Object.keys(doc._attachments||{}),digestMap={},j=0;j<atts.length;j++){var att=doc._attachments[atts[j]];digestMap[att.digest]=!0}var digests=Object.keys(digestMap);for(j=0;j<digests.length;j++){var digest=digests[j];attAndSeqStore.put({seq:seq,digestSeq:digest+"::"+seq})}cursor.continue()}}}function migrateMetadata(txn){var bySeqStore=txn.objectStore(BY_SEQ_STORE),docStore=txn.objectStore(DOC_STORE),cursor=docStore.openCursor();cursor.onsuccess=function(e){var cursor=e.target.result;if(cursor){var start,end,req,metadataSeq,metadata=function(storedObject){if(!storedObject.data)return storedObject.deleted="1"===storedObject.deletedOrLocal,storedObject;return decodeMetadata(storedObject)}(cursor.value);if(metadata.winningRev=metadata.winningRev||winningRev(metadata),metadata.seq)return onGetMetadataSeq();start=metadata.id+"::",end=metadata.id+"::￿",req=bySeqStore.index("_doc_id_rev").openCursor(IDBKeyRange.bound(start,end)),metadataSeq=0,req.onsuccess=function(e){var cursor=e.target.result;if(!cursor)return metadata.seq=metadataSeq,onGetMetadataSeq();var seq=cursor.primaryKey;seq>metadataSeq&&(metadataSeq=seq),cursor.continue()}}function onGetMetadataSeq(){var metadataToStore=encodeMetadata(metadata,metadata.winningRev,metadata.deleted),req=docStore.put(metadataToStore);req.onsuccess=function(){cursor.continue()}}}}api._meta=null,api._remote=!1,api.type=function(){return"idb"},api._id=toPromise(function(callback){callback(null,api._meta.instanceId)}),api._bulkDocs=function(req,reqOpts,callback){idbBulkDocs(opts,req,reqOpts,api,idb,callback)},api._get=function(id,opts,callback){var doc,metadata,err,txn=opts.ctx;if(!txn){var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(txnResult.error)return callback(txnResult.error);txn=txnResult.txn}function finish(){callback(err,{doc:doc,metadata:metadata,ctx:txn})}txn.objectStore(DOC_STORE).get(id).onsuccess=function(e){if(!(metadata=decodeMetadata(e.target.result)))return err=createError(MISSING_DOC,"missing"),finish();var rev;if(opts.rev)rev=opts.latest?function(rev,metadata){for(var node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];if(history.push({id:id,pos:pos,opts:opts}),isLeaf)for(var i=0,len=history.length;i<len;i++){var historyNode=history[i];if(historyNode.pos+"-"+historyNode.id===rev)return pos+"-"+id}for(var j=0,l=branches.length;j<l;j++)toVisit.push({pos:pos+1,ids:branches[j],history:history})}throw new Error("Unable to resolve latest revision for id "+metadata.id+", rev "+rev)}(opts.rev,metadata):opts.rev;else{rev=metadata.winningRev;var deleted=isDeleted(metadata);if(deleted)return err=createError(MISSING_DOC,"deleted"),finish()}var objectStore=txn.objectStore(BY_SEQ_STORE),key=metadata.id+"::"+rev;objectStore.index("_doc_id_rev").get(key).onsuccess=function(e){if((doc=e.target.result)&&(doc=decodeDoc(doc)),!doc)return err=createError(MISSING_DOC,"missing"),finish();finish()}}},api._getAttachment=function(docId,attachId,attachment,opts,callback){var txn;if(opts.ctx)txn=opts.ctx;else{var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(txnResult.error)return callback(txnResult.error);txn=txnResult.txn}var digest=attachment.digest,type=attachment.content_type;txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e){var body=e.target.result.body;readBlobData(body,type,opts.binary,function(blobData){callback(null,blobData)})}},api._info=function(callback){var updateSeq,docCount,txnResult=openTransactionSafely(idb,[META_STORE,BY_SEQ_STORE],"readonly");if(txnResult.error)return callback(txnResult.error);var txn=txnResult.txn;txn.objectStore(META_STORE).get(META_STORE).onsuccess=function(e){docCount=e.target.result.docCount},txn.objectStore(BY_SEQ_STORE).openCursor(null,"prev").onsuccess=function(e){var cursor=e.target.result;updateSeq=cursor?cursor.key:0},txn.oncomplete=function(){callback(null,{doc_count:docCount,update_seq:updateSeq,idb_attachment_format:api._meta.blobSupport?"binary":"base64"})}},api._allDocs=function(opts,callback){idbAllDocs(opts,idb,callback)},api._changes=function(opts){return changes(opts,api,dbName,idb)},api._close=function(callback){idb.close(),cachedDBs.delete(dbName),callback()},api._getRevisionTree=function(docId,callback){var txnResult=openTransactionSafely(idb,[DOC_STORE],"readonly");if(txnResult.error)return callback(txnResult.error);var txn=txnResult.txn,req=txn.objectStore(DOC_STORE).get(docId);req.onsuccess=function(event){var doc=decodeMetadata(event.target.result);doc?callback(null,doc.rev_tree):callback(createError(MISSING_DOC))}},api._doCompaction=function(docId,revs,callback){var stores=[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,ATTACH_AND_SEQ_STORE],txnResult=openTransactionSafely(idb,stores,"readwrite");if(txnResult.error)return callback(txnResult.error);var txn=txnResult.txn,docStore=txn.objectStore(DOC_STORE);docStore.get(docId).onsuccess=function(event){var metadata=decodeMetadata(event.target.result);traverseRevTree(metadata.rev_tree,function(isLeaf,pos,revHash,ctx,opts){var rev=pos+"-"+revHash;-1!==revs.indexOf(rev)&&(opts.status="missing")}),compactRevs(revs,docId,txn);var winningRev$$1=metadata.winningRev,deleted=metadata.deleted;txn.objectStore(DOC_STORE).put(encodeMetadata(metadata,winningRev$$1,deleted))},txn.onabort=idbError(callback),txn.oncomplete=function(){callback()}},api._getLocal=function(id,callback){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readonly");if(txnResult.error)return callback(txnResult.error);var tx=txnResult.txn,req=tx.objectStore(LOCAL_STORE).get(id);req.onerror=idbError(callback),req.onsuccess=function(e){var doc=e.target.result;doc?(delete doc._doc_id_rev,callback(null,doc)):callback(createError(MISSING_DOC))}},api._putLocal=function(doc,opts,callback){"function"==typeof opts&&(callback=opts,opts={}),delete doc._revisions;var oldRev=doc._rev,id=doc._id;doc._rev=oldRev?"0-"+(parseInt(oldRev.split("-")[1],10)+1):"0-1";var ret,tx=opts.ctx;if(!tx){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readwrite");if(txnResult.error)return callback(txnResult.error);(tx=txnResult.txn).onerror=idbError(callback),tx.oncomplete=function(){ret&&callback(null,ret)}}var req,oStore=tx.objectStore(LOCAL_STORE);oldRev?(req=oStore.get(id)).onsuccess=function(e){var oldDoc=e.target.result;if(oldDoc&&oldDoc._rev===oldRev){var req=oStore.put(doc);req.onsuccess=function(){ret={ok:!0,id:doc._id,rev:doc._rev},opts.ctx&&callback(null,ret)}}else callback(createError(REV_CONFLICT))}:((req=oStore.add(doc)).onerror=function(e){callback(createError(REV_CONFLICT)),e.preventDefault(),e.stopPropagation()},req.onsuccess=function(){ret={ok:!0,id:doc._id,rev:doc._rev},opts.ctx&&callback(null,ret)})},api._removeLocal=function(doc,opts,callback){"function"==typeof opts&&(callback=opts,opts={});var ret,tx=opts.ctx;if(!tx){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readwrite");if(txnResult.error)return callback(txnResult.error);(tx=txnResult.txn).oncomplete=function(){ret&&callback(null,ret)}}var id=doc._id,oStore=tx.objectStore(LOCAL_STORE),req=oStore.get(id);req.onerror=idbError(callback),req.onsuccess=function(e){var oldDoc=e.target.result;oldDoc&&oldDoc._rev===doc._rev?(oStore.delete(id),ret={ok:!0,id:id,rev:"0-0"},opts.ctx&&callback(null,ret)):callback(createError(MISSING_DOC))}},api._destroy=function(opts,callback){changesHandler.removeAllListeners(dbName);var openReq=openReqList.get(dbName);openReq&&openReq.result&&(openReq.result.close(),cachedDBs.delete(dbName));var req=indexedDB.deleteDatabase(dbName);req.onsuccess=function(){openReqList.delete(dbName),hasLocalStorage()&&dbName in localStorage&&delete localStorage[dbName],callback(null,{ok:!0})},req.onerror=idbError(callback)};var cached=cachedDBs.get(dbName);if(cached)return idb=cached.idb,api._meta=cached.global,immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){callback(null,api)});var req=indexedDB.open(dbName,ADAPTER_VERSION);openReqList.set(dbName,req),req.onupgradeneeded=function(e){var db=e.target.result;if(e.oldVersion<1)return function(db){var docStore=db.createObjectStore(DOC_STORE,{keyPath:"id"});db.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),db.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),db.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1}),db.createObjectStore(DETECT_BLOB_SUPPORT_STORE),docStore.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),db.createObjectStore(LOCAL_STORE,{keyPath:"_id"});var attAndSeqStore=db.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:!0});attAndSeqStore.createIndex("seq","seq"),attAndSeqStore.createIndex("digestSeq","digestSeq",{unique:!0})}(db);var txn=e.currentTarget.transaction;e.oldVersion<3&&function(db){db.createObjectStore(LOCAL_STORE,{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0})}(db),e.oldVersion<4&&function(db){var attAndSeqStore=db.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:!0});attAndSeqStore.createIndex("seq","seq"),attAndSeqStore.createIndex("digestSeq","digestSeq",{unique:!0})}(db);var migrations=[addDeletedOrLocalIndex,migrateLocalStore,migrateAttsAndSeqs,migrateMetadata],i=e.oldVersion;!function next(){var migration=migrations[i-1];i++;migration&&migration(txn,next)}()},req.onsuccess=function(e){(idb=e.target.result).onversionchange=function(){idb.close(),cachedDBs.delete(dbName)},idb.onabort=function(e){guardedConsole("error","Database has a global failure",e.target.error),idb.close(),cachedDBs.delete(dbName)};var metaDoc,docCount,blobSupport,instanceId,txn=idb.transaction([META_STORE,DETECT_BLOB_SUPPORT_STORE,DOC_STORE],"readwrite"),storedMetaDoc=!1;function completeSetup(){void 0!==blobSupport&&storedMetaDoc&&(api._meta={name:dbName,instanceId:instanceId,blobSupport:blobSupport},cachedDBs.set(dbName,{idb:idb,global:api._meta}),callback(null,api))}function storeMetaDocIfReady(){if(void 0!==docCount&&void 0!==metaDoc){var instanceKey=dbName+"_id";instanceKey in metaDoc?instanceId=metaDoc[instanceKey]:metaDoc[instanceKey]=instanceId=uuid(),metaDoc.docCount=docCount,txn.objectStore(META_STORE).put(metaDoc)}}txn.objectStore(META_STORE).get(META_STORE).onsuccess=function(e){metaDoc=e.target.result||{id:META_STORE},storeMetaDocIfReady()},function(txn,cb){txn.objectStore(DOC_STORE).index("deletedOrLocal").count(IDBKeyRange.only("0")).onsuccess=function(e){cb(e.target.result)}}(txn,function(count){docCount=count,storeMetaDocIfReady()}),blobSupportPromise||(blobSupportPromise=function(txn){return new Promise(function(resolve){var blob$$1=createBlob([""]),req=txn.objectStore(DETECT_BLOB_SUPPORT_STORE).put(blob$$1,"key");req.onsuccess=function(){var matchedChrome=navigator.userAgent.match(/Chrome\/(\d+)/),matchedEdge=navigator.userAgent.match(/Edge\//);resolve(matchedEdge||!matchedChrome||parseInt(matchedChrome[1],10)>=43)},req.onerror=txn.onabort=function(e){e.preventDefault(),e.stopPropagation(),resolve(!1)}}).catch(function(){return!1})}(txn)),blobSupportPromise.then(function(val){blobSupport=val,completeSetup()}),txn.oncomplete=function(){storedMetaDoc=!0,completeSetup()},txn.onabort=idbError(callback)},req.onerror=function(){var msg="Failed to open indexedDB, are you in private browsing mode?";guardedConsole("error",msg),callback(createError(IDB_ERROR,msg))}}(api,opts,thisCallback)},callback,api.constructor)}IdbPouch.valid=function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}};var CHANGES_BATCH_SIZE=25,MAX_SIMULTANEOUS_REVS=50,CHANGES_TIMEOUT_BUFFER=5e3,DEFAULT_HEARTBEAT=1e4,supportsBulkGetMap={};function readAttachmentsAsBlobOrBuffer(row){var atts=(row.doc||row.ok)._attachments;atts&&Object.keys(atts).forEach(function(filename){var att=atts[filename];att.data=b64ToBluffer(att.data,att.content_type)})}function encodeDocId(id){return/^_design/.test(id)?"_design/"+encodeURIComponent(id.slice(8)):/^_local/.test(id)?"_local/"+encodeURIComponent(id.slice(7)):encodeURIComponent(id)}function preprocessAttachments$1(doc){return doc._attachments&&Object.keys(doc._attachments)?Promise.all(Object.keys(doc._attachments).map(function(key){var attachment=doc._attachments[key];if(attachment.data&&"string"!=typeof attachment.data)return new Promise(function(resolve){blobToBase64(attachment.data,resolve)}).then(function(b64){attachment.data=b64})})):Promise.resolve()}function getHost(name,opts){if(function(opts){if(!opts.prefix)return!1;var protocol=parseUri(opts.prefix).protocol;return"http"===protocol||"https"===protocol}(opts)){var dbName=opts.name.substr(opts.prefix.length);name=opts.prefix.replace(/\/?$/,"/")+encodeURIComponent(dbName)}var uri=parseUri(name);(uri.user||uri.password)&&(uri.auth={username:uri.user,password:uri.password});var parts=uri.path.replace(/(^\/|\/$)/g,"").split("/");return uri.db=parts.pop(),-1===uri.db.indexOf("%")&&(uri.db=encodeURIComponent(uri.db)),uri.path=parts.join("/"),uri}function genDBUrl(opts,path){return genUrl(opts,opts.db+"/"+path)}function genUrl(opts,path){var pathDel=opts.path?"/":"";return opts.protocol+"://"+opts.host+(opts.port?":"+opts.port:"")+"/"+opts.path+pathDel+path}function paramsToStr(params){return"?"+Object.keys(params).map(function(k){return k+"="+encodeURIComponent(params[k])}).join("&")}function HttpPouch(opts,callback){var api=this,host=getHost(opts.name,opts),dbUrl=genDBUrl(host,"");opts=clone(opts);var setupPromise,ourFetch=function(url,options){if((options=options||{}).headers=options.headers||new h,opts.auth||host.auth){var nAuth=opts.auth||host.auth,str=nAuth.username+":"+nAuth.password,token=thisBtoa(unescape(encodeURIComponent(str)));options.headers.set("Authorization","Basic "+token)}var headers=opts.headers||{};return Object.keys(headers).forEach(function(key){options.headers.append(key,headers[key])}),function(opts){var ua="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",isIE=-1!==ua.indexOf("msie"),isTrident=-1!==ua.indexOf("trident"),isEdge=-1!==ua.indexOf("edge"),isGET=!("method"in opts)||"GET"===opts.method;return(isIE||isTrident||isEdge)&&isGET}(options)&&(url+=(-1===url.indexOf("?")?"?":"&")+"_nonce="+Date.now()),(opts.fetch||f$1)(url,options)};function adapterFun$$1(name,fun){return adapterFun(name,argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){setup().then(function(){return fun.apply(this,args)}).catch(function(e){args.pop()(e)})})).bind(api)}function fetchJSON(url,options,callback){var result={};return(options=options||{}).headers=options.headers||new h,options.headers.get("Content-Type")||options.headers.set("Content-Type","application/json"),options.headers.get("Accept")||options.headers.set("Accept","application/json"),ourFetch(url,options).then(function(response){return result.ok=response.ok,result.status=response.status,response.json()}).then(function(json){if(result.data=json,!result.ok){result.data.status=result.status;var err=generateErrorFromResponse(result.data);if(callback)return callback(err);throw err}if(Array.isArray(result.data)&&(result.data=result.data.map(function(v){return v.error||v.missing?generateErrorFromResponse(v):v})),!callback)return result;callback(null,result.data)})}function setup(){return opts.skip_setup?Promise.resolve():setupPromise||((setupPromise=fetchJSON(dbUrl).catch(function(err){return err&&err.status&&404===err.status?(explainError(404,"PouchDB is just detecting if the remote exists."),fetchJSON(dbUrl,{method:"PUT"})):Promise.reject(err)}).catch(function(err){return!(!err||!err.status||412!==err.status)||Promise.reject(err)})).catch(function(){setupPromise=null}),setupPromise)}function encodeAttachmentId(attachmentId){return attachmentId.split("/").map(encodeURIComponent).join("/")}immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){callback(null,api)}),api._remote=!0,api.type=function(){return"http"},api.id=adapterFun$$1("id",function(callback){ourFetch(genUrl(host,"")).then(function(response){return response.json()}).then(function(result){var uuid$$1=result&&result.uuid?result.uuid+host.db:genDBUrl(host,"");callback(null,uuid$$1)}).catch(function(err){callback(err)})}),api.compact=adapterFun$$1("compact",function(opts,callback){"function"==typeof opts&&(callback=opts,opts={}),opts=clone(opts),fetchJSON(genDBUrl(host,"_compact"),{method:"POST"}).then(function(){!function ping(){api.info(function(err,res){res&&!res.compact_running?callback(null,{ok:!0}):setTimeout(ping,opts.interval||200)})}()})}),api.bulkGet=adapterFun("bulkGet",function(opts,callback){var self=this;function doBulkGet(cb){var params={};opts.revs&&(params.revs=!0),opts.attachments&&(params.attachments=!0),opts.latest&&(params.latest=!0),fetchJSON(genDBUrl(host,"_bulk_get"+paramsToStr(params)),{method:"POST",body:JSON.stringify({docs:opts.docs})}).then(function(result){opts.attachments&&opts.binary&&result.data.results.forEach(function(res){res.docs.forEach(readAttachmentsAsBlobOrBuffer)}),cb(null,result.data)}).catch(cb)}function doBulkGetShim(){var batchSize=MAX_SIMULTANEOUS_REVS,numBatches=Math.ceil(opts.docs.length/batchSize),numDone=0,results=new Array(numBatches);function onResult(batchNum){return function(err,res){results[batchNum]=res.results,++numDone===numBatches&&callback(null,{results:flatten(results)})}}for(var i=0;i<numBatches;i++){var subOpts=pick(opts,["revs","attachments","binary","latest"]);subOpts.docs=opts.docs.slice(i*batchSize,Math.min(opts.docs.length,(i+1)*batchSize)),bulkGet(self,subOpts,onResult(i))}}var dbUrl=genUrl(host,""),supportsBulkGet=supportsBulkGetMap[dbUrl];"boolean"!=typeof supportsBulkGet?doBulkGet(function(err,res){err?(supportsBulkGetMap[dbUrl]=!1,explainError(err.status,"PouchDB is just detecting if the remote supports the _bulk_get API."),doBulkGetShim()):(supportsBulkGetMap[dbUrl]=!0,callback(null,res))}):supportsBulkGet?doBulkGet(callback):doBulkGetShim()}),api._info=function(callback){setup().then(function(){return ourFetch(genDBUrl(host,""))}).then(function(response){return response.json()}).then(function(info){info.host=genDBUrl(host,""),callback(null,info)}).catch(callback)},api.fetch=function(path,options){return setup().then(function(){return ourFetch(genDBUrl(host,path),options)})},api.get=adapterFun$$1("get",function(id,opts,callback){"function"==typeof opts&&(callback=opts,opts={});var params={};function fetchAttachments(doc){var atts=doc._attachments,filenames=atts&&Object.keys(atts);if(atts&&filenames.length)return function(promiseFactories,limit){return new Promise(function(resolve,reject){var err,running=0,current=0,done=0,len=promiseFactories.length;function doNext(){++done===len?err?reject(err):resolve():runNextBatch()}function onSuccess(){running--,doNext()}function onError(thisErr){running--,err=err||thisErr,doNext()}function runNextBatch(){for(;running<limit&&current<len;)running++,promiseFactories[current++]().then(onSuccess,onError)}runNextBatch()})}(filenames.map(function(filename){return function(){return function(filename){var att=atts[filename],path=encodeDocId(doc._id)+"/"+encodeAttachmentId(filename)+"?rev="+doc._rev;return ourFetch(genDBUrl(host,path)).then(function(response){return void 0===process||process.browser?response.blob():response.buffer()}).then(function(blob){return opts.binary?(void 0===process||process.browser||(blob.type=att.content_type),blob):new Promise(function(resolve){blobToBase64(blob,resolve)})}).then(function(data){delete att.stub,delete att.length,att.data=data})}(filename)}}),5)}(opts=clone(opts)).revs&&(params.revs=!0),opts.revs_info&&(params.revs_info=!0),opts.latest&&(params.latest=!0),opts.open_revs&&("all"!==opts.open_revs&&(opts.open_revs=JSON.stringify(opts.open_revs)),params.open_revs=opts.open_revs),opts.rev&&(params.rev=opts.rev),opts.conflicts&&(params.conflicts=opts.conflicts),opts.update_seq&&(params.update_seq=opts.update_seq),id=encodeDocId(id),fetchJSON(genDBUrl(host,id+paramsToStr(params))).then(function(res){return Promise.resolve().then(function(){if(opts.attachments)return docOrDocs=res.data,Array.isArray(docOrDocs)?Promise.all(docOrDocs.map(function(doc){if(doc.ok)return fetchAttachments(doc.ok)})):fetchAttachments(docOrDocs);var docOrDocs}).then(function(){callback(null,res.data)})}).catch(function(e){e.docId=id,callback(e)})}),api.remove=adapterFun$$1("remove",function(docOrId,optsOrRev,opts,cb){var doc;"string"==typeof optsOrRev?(doc={_id:docOrId,_rev:optsOrRev},"function"==typeof opts&&(cb=opts,opts={})):(doc=docOrId,"function"==typeof optsOrRev?(cb=optsOrRev,opts={}):(cb=opts,opts=optsOrRev));var rev=doc._rev||opts.rev;fetchJSON(genDBUrl(host,encodeDocId(doc._id))+"?rev="+rev,{method:"DELETE"},cb).catch(cb)}),api.getAttachment=adapterFun$$1("getAttachment",function(docId,attachmentId,opts,callback){"function"==typeof opts&&(callback=opts,opts={});var contentType,params=opts.rev?"?rev="+opts.rev:"",url=genDBUrl(host,encodeDocId(docId))+"/"+encodeAttachmentId(attachmentId)+params;ourFetch(url,{method:"GET"}).then(function(response){if(contentType=response.headers.get("content-type"),response.ok)return void 0===process||process.browser?response.blob():response.buffer();throw response}).then(function(blob){void 0===process||process.browser||(blob.type=contentType),callback(null,blob)}).catch(function(err){callback(err)})}),api.removeAttachment=adapterFun$$1("removeAttachment",function(docId,attachmentId,rev,callback){fetchJSON(genDBUrl(host,encodeDocId(docId)+"/"+encodeAttachmentId(attachmentId))+"?rev="+rev,{method:"DELETE"},callback).catch(callback)}),api.putAttachment=adapterFun$$1("putAttachment",function(docId,attachmentId,rev,blob,type,callback){"function"==typeof type&&(callback=type,type=blob,blob=rev,rev=null);var id=encodeDocId(docId)+"/"+encodeAttachmentId(attachmentId),url=genDBUrl(host,id);if(rev&&(url+="?rev="+rev),"string"==typeof blob){var binary;try{binary=thisAtob(blob)}catch(err){return callback(createError(BAD_ARG,"Attachment is not a valid base64 string"))}blob=binary?binStringToBluffer(binary,type):""}fetchJSON(url,{headers:new h({"Content-Type":type}),method:"PUT",body:blob},callback).catch(callback)}),api._bulkDocs=function(req,opts,callback){req.new_edits=opts.new_edits,setup().then(function(){return Promise.all(req.docs.map(preprocessAttachments$1))}).then(function(){return fetchJSON(genDBUrl(host,"_bulk_docs"),{method:"POST",body:JSON.stringify(req)},callback)}).catch(callback)},api._put=function(doc,opts,callback){setup().then(function(){return preprocessAttachments$1(doc)}).then(function(){return fetchJSON(genDBUrl(host,encodeDocId(doc._id)),{method:"PUT",body:JSON.stringify(doc)})}).then(function(result){callback(null,result.data)}).catch(function(err){err.docId=doc&&doc._id,callback(err)})},api.allDocs=adapterFun$$1("allDocs",function(opts,callback){"function"==typeof opts&&(callback=opts,opts={});var body,params={},method="GET";(opts=clone(opts)).conflicts&&(params.conflicts=!0),opts.update_seq&&(params.update_seq=!0),opts.descending&&(params.descending=!0),opts.include_docs&&(params.include_docs=!0),opts.attachments&&(params.attachments=!0),opts.key&&(params.key=JSON.stringify(opts.key)),opts.start_key&&(opts.startkey=opts.start_key),opts.startkey&&(params.startkey=JSON.stringify(opts.startkey)),opts.end_key&&(opts.endkey=opts.end_key),opts.endkey&&(params.endkey=JSON.stringify(opts.endkey)),void 0!==opts.inclusive_end&&(params.inclusive_end=!!opts.inclusive_end),void 0!==opts.limit&&(params.limit=opts.limit),void 0!==opts.skip&&(params.skip=opts.skip);var paramStr=paramsToStr(params);void 0!==opts.keys&&(method="POST",body={keys:opts.keys}),fetchJSON(genDBUrl(host,"_all_docs"+paramStr),{method:method,body:JSON.stringify(body)}).then(function(result){opts.include_docs&&opts.attachments&&opts.binary&&result.data.rows.forEach(readAttachmentsAsBlobOrBuffer),callback(null,result.data)}).catch(callback)}),api._changes=function(opts){var batchSize="batch_size"in opts?opts.batch_size:CHANGES_BATCH_SIZE;!(opts=clone(opts)).continuous||"heartbeat"in opts||(opts.heartbeat=DEFAULT_HEARTBEAT);var requestTimeout="timeout"in opts?opts.timeout:3e4;"timeout"in opts&&opts.timeout&&requestTimeout-opts.timeout<CHANGES_TIMEOUT_BUFFER&&(requestTimeout=opts.timeout+CHANGES_TIMEOUT_BUFFER),"heartbeat"in opts&&opts.heartbeat&&requestTimeout-opts.heartbeat<CHANGES_TIMEOUT_BUFFER&&(requestTimeout=opts.heartbeat+CHANGES_TIMEOUT_BUFFER);var params={};"timeout"in opts&&opts.timeout&&(params.timeout=opts.timeout);var limit=void 0!==opts.limit&&opts.limit,leftToFetch=limit;if(opts.style&&(params.style=opts.style),(opts.include_docs||opts.filter&&"function"==typeof opts.filter)&&(params.include_docs=!0),opts.attachments&&(params.attachments=!0),opts.continuous&&(params.feed="longpoll"),opts.seq_interval&&(params.seq_interval=opts.seq_interval),opts.conflicts&&(params.conflicts=!0),opts.descending&&(params.descending=!0),opts.update_seq&&(params.update_seq=!0),"heartbeat"in opts&&opts.heartbeat&&(params.heartbeat=opts.heartbeat),opts.filter&&"string"==typeof opts.filter&&(params.filter=opts.filter),opts.view&&"string"==typeof opts.view&&(params.filter="_view",params.view=opts.view),opts.query_params&&"object"==typeof opts.query_params)for(var param_name in opts.query_params)opts.query_params.hasOwnProperty(param_name)&&(params[param_name]=opts.query_params[param_name]);var body,method="GET";opts.doc_ids?(params.filter="_doc_ids",method="POST",body={doc_ids:opts.doc_ids}):opts.selector&&(params.filter="_selector",method="POST",body={selector:opts.selector});var lastFetchedSeq,controller=new a,fetchData=function(since,callback){if(!opts.aborted){params.since=since,"object"==typeof params.since&&(params.since=JSON.stringify(params.since)),opts.descending?limit&&(params.limit=leftToFetch):params.limit=!limit||leftToFetch>batchSize?batchSize:leftToFetch;var url=genDBUrl(host,"_changes"+paramsToStr(params)),fetchOpts={signal:controller.signal,method:method,body:JSON.stringify(body)};lastFetchedSeq=since,opts.aborted||setup().then(function(){return fetchJSON(url,fetchOpts,callback)}).catch(callback)}},results={results:[]},fetched=function(err,res){if(!opts.aborted){var raw_results_length=0;if(res&&res.results){raw_results_length=res.results.length,results.last_seq=res.last_seq;var pending=null,lastSeq=null;"number"==typeof res.pending&&(pending=res.pending),"string"!=typeof results.last_seq&&"number"!=typeof results.last_seq||(lastSeq=results.last_seq);opts.query_params,res.results=res.results.filter(function(c){leftToFetch--;var ret=filterChange(opts)(c);return ret&&(opts.include_docs&&opts.attachments&&opts.binary&&readAttachmentsAsBlobOrBuffer(c),opts.return_docs&&results.results.push(c),opts.onChange(c,pending,lastSeq)),ret})}else if(err)return opts.aborted=!0,void opts.complete(err);res&&res.last_seq&&(lastFetchedSeq=res.last_seq);var finished=limit&&leftToFetch<=0||res&&raw_results_length<batchSize||opts.descending;(!opts.continuous||limit&&leftToFetch<=0)&&finished?opts.complete(null,results):immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){fetchData(lastFetchedSeq,fetched)})}};return fetchData(opts.since||0,fetched),{cancel:function(){opts.aborted=!0,controller.abort()}}},api.revsDiff=adapterFun$$1("revsDiff",function(req,opts,callback){"function"==typeof opts&&(callback=opts,opts={}),fetchJSON(genDBUrl(host,"_revs_diff"),{method:"POST",body:JSON.stringify(req)},callback).catch(callback)}),api._close=function(callback){callback()},api._destroy=function(options,callback){fetchJSON(genDBUrl(host,""),{method:"DELETE"}).then(function(json){callback(null,json)}).catch(function(err){404===err.status?callback(null,{ok:!0}):callback(err)})}}function QueryParseError(message){this.status=400,this.name="query_parse_error",this.message=message,this.error=!0;try{Error.captureStackTrace(this,QueryParseError)}catch(e){}}function NotFoundError(message){this.status=404,this.name="not_found",this.message=message,this.error=!0;try{Error.captureStackTrace(this,NotFoundError)}catch(e){}}function BuiltInError(message){this.status=500,this.name="invalid_value",this.message=message,this.error=!0;try{Error.captureStackTrace(this,BuiltInError)}catch(e){}}function promisedCallback(promise,callback){return callback&&promise.then(function(res){immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){callback(null,res)})},function(reason){immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){callback(reason)})}),promise}function sequentialize(queue,promiseFactory){return function(){var args=arguments,that=this;return queue.add(function(){return promiseFactory.apply(that,args)})}}function uniq(arr){var theSet=new ExportedSet(arr),result=new Array(theSet.size),index=-1;return theSet.forEach(function(value){result[++index]=value}),result}function mapToKeysArray(map){var result=new Array(map.size),index=-1;return map.forEach(function(value,key){result[++index]=key}),result}function createBuiltInError(name){return new BuiltInError("builtin "+name+" function requires map values to be numbers or number arrays")}function sum(values){for(var result=0,i=0,len=values.length;i<len;i++){var num=values[i];if("number"!=typeof num){if(!Array.isArray(num))throw createBuiltInError("_sum");result="number"==typeof result?[result]:result;for(var j=0,jLen=num.length;j<jLen;j++){var jNum=num[j];if("number"!=typeof jNum)throw createBuiltInError("_sum");void 0===result[j]?result.push(jNum):result[j]+=jNum}}else"number"==typeof result?result+=num:result[0]+=num}return result}HttpPouch.valid=function(){return!0},inherits__WEBPACK_IMPORTED_MODULE_3___default()(QueryParseError,Error),inherits__WEBPACK_IMPORTED_MODULE_3___default()(NotFoundError,Error),inherits__WEBPACK_IMPORTED_MODULE_3___default()(BuiltInError,Error);var log=guardedConsole.bind(null,"log"),isArray=Array.isArray,toJSON=JSON.parse;function evalFunctionWithEval(func,emit){return scopeEval("return ("+func.replace(/;\s*$/,"")+");",{emit:emit,sum:sum,log:log,isArray:isArray,toJSON:toJSON})}function TaskQueue$1(){this.promise=new Promise(function(fulfill){fulfill()})}function stringify(input){if(!input)return"undefined";switch(typeof input){case"function":case"string":return input.toString();default:return JSON.stringify(input)}}function createView(sourceDB,viewName,mapFun,reduceFun,temporary,localDocName){var cachedViews,viewSignature=function(mapFun,reduceFun){return stringify(mapFun)+stringify(reduceFun)+"undefined"}(mapFun,reduceFun);if(!temporary&&(cachedViews=sourceDB._cachedViews=sourceDB._cachedViews||{})[viewSignature])return cachedViews[viewSignature];var promiseForView=sourceDB.info().then(function(info){var depDbName=info.db_name+"-mrview-"+(temporary?"temp":stringMd5(viewSignature));return upsert(sourceDB,"_local/"+localDocName,function(doc){doc.views=doc.views||{};var fullViewName=viewName;-1===fullViewName.indexOf("/")&&(fullViewName=viewName+"/"+viewName);var depDbs=doc.views[fullViewName]=doc.views[fullViewName]||{};if(!depDbs[depDbName])return depDbs[depDbName]=!0,doc}).then(function(){return sourceDB.registerDependentDatabase(depDbName).then(function(res){var db=res.db;db.auto_compaction=!0;var view={name:depDbName,db:db,sourceDB:sourceDB,adapter:sourceDB.adapter,mapFun:mapFun,reduceFun:reduceFun};return view.db.get("_local/lastSeq").catch(function(err){if(404!==err.status)throw err}).then(function(lastSeqDoc){return view.seq=lastSeqDoc?lastSeqDoc.seq:0,cachedViews&&view.db.once("destroyed",function(){delete cachedViews[viewSignature]}),view})})})});return cachedViews&&(cachedViews[viewSignature]=promiseForView),promiseForView}TaskQueue$1.prototype.add=function(promiseFactory){return this.promise=this.promise.catch(function(){}).then(function(){return promiseFactory()}),this.promise},TaskQueue$1.prototype.finish=function(){return this.promise};var persistentQueues={},tempViewQueue=new TaskQueue$1,CHANGES_BATCH_SIZE$1=50;function parseViewName(name){return-1===name.indexOf("/")?[name,name]:name.split("/")}function emitError(db,e){try{db.emit("error",e)}catch(err){guardedConsole("error","The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),guardedConsole("error",e)}}var builtInReduce={_sum:function(keys,values){return sum(values)},_count:function(keys,values){return values.length},_stats:function(keys,values){return{sum:sum(values),min:Math.min.apply(null,values),max:Math.max.apply(null,values),count:values.length,sumsqr:function(values){for(var _sumsqr=0,i=0,len=values.length;i<len;i++){var num=values[i];_sumsqr+=num*num}return _sumsqr}(values)}}};var abstract=function(localDocName,mapper,reducer,ddocValidator){function tryMap(db,fun,doc){try{fun(doc)}catch(e){emitError(db,e)}}function tryReduce(db,fun,keys,values,rereduce){try{return{output:fun(keys,values,rereduce)}}catch(e){return emitError(db,e),{error:e}}}function sortByKeyThenValue(x,y){var keyCompare=collate(x.key,y.key);return 0!==keyCompare?keyCompare:collate(x.value,y.value)}function sliceResults(results,limit,skip){return skip=skip||0,"number"==typeof limit?results.slice(skip,limit+skip):skip>0?results.slice(skip):results}function rowToDocId(row){var val=row.value;return val&&"object"==typeof val&&val._id||row.id}function postprocessAttachments(opts){return function(res){return opts.include_docs&&opts.attachments&&opts.binary&&function(res){res.rows.forEach(function(row){var atts=row.doc&&row.doc._attachments;atts&&Object.keys(atts).forEach(function(filename){var att=atts[filename];atts[filename].data=b64ToBluffer(att.data,att.content_type)})})}(res),res}}function addHttpParam(paramName,opts,params,asJson){var val=opts[paramName];void 0!==val&&(asJson&&(val=encodeURIComponent(JSON.stringify(val))),params.push(paramName+"="+val))}function coerceInteger(integerCandidate){if(void 0!==integerCandidate){var asNumber=Number(integerCandidate);return isNaN(asNumber)||asNumber!==parseInt(integerCandidate,10)?integerCandidate:asNumber}}function checkQueryParseError(options,fun){var startkeyName=options.descending?"endkey":"startkey",endkeyName=options.descending?"startkey":"endkey";if(void 0!==options[startkeyName]&&void 0!==options[endkeyName]&&collate(options[startkeyName],options[endkeyName])>0)throw new QueryParseError("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(fun.reduce&&!1!==options.reduce){if(options.include_docs)throw new QueryParseError("{include_docs:true} is invalid for reduce");if(options.keys&&options.keys.length>1&&!options.group&&!options.group_level)throw new QueryParseError("Multi-key fetches for reduce views must use {group: true}")}["group_level","limit","skip"].forEach(function(optionName){var error=function(number){if(number){if("number"!=typeof number)return new QueryParseError('Invalid value for integer: "'+number+'"');if(number<0)return new QueryParseError('Invalid value for positive integer: "'+number+'"')}}(options[optionName]);if(error)throw error})}function defaultsTo(value){return function(reason){if(404===reason.status)return value;throw reason}}function getDocsToPersist(docId,view,docIdsToChangesAndEmits){var metaDocId="_local/doc_"+docId,defaultMetaDoc={_id:metaDocId,keys:[]},docData=docIdsToChangesAndEmits.get(docId),indexableKeysToKeyValues=docData[0];return(function(changes){return 1===changes.length&&/^1-/.test(changes[0].rev)}(docData[1])?Promise.resolve(defaultMetaDoc):view.db.get(metaDocId).catch(defaultsTo(defaultMetaDoc))).then(function(metaDoc){return function(metaDoc){return metaDoc.keys.length?view.db.allDocs({keys:metaDoc.keys,include_docs:!0}):Promise.resolve({rows:[]})}(metaDoc).then(function(kvDocsRes){return function(metaDoc,kvDocsRes){for(var kvDocs=[],oldKeys=new ExportedSet,i=0,len=kvDocsRes.rows.length;i<len;i++){var doc=kvDocsRes.rows[i].doc;if(doc&&(kvDocs.push(doc),oldKeys.add(doc._id),doc._deleted=!indexableKeysToKeyValues.has(doc._id),!doc._deleted)){var keyValue=indexableKeysToKeyValues.get(doc._id);"value"in keyValue&&(doc.value=keyValue.value)}}var newKeys=mapToKeysArray(indexableKeysToKeyValues);return newKeys.forEach(function(key){if(!oldKeys.has(key)){var kvDoc={_id:key},keyValue=indexableKeysToKeyValues.get(key);"value"in keyValue&&(kvDoc.value=keyValue.value),kvDocs.push(kvDoc)}}),metaDoc.keys=uniq(newKeys.concat(metaDoc.keys)),kvDocs.push(metaDoc),kvDocs}(metaDoc,kvDocsRes)})})}function getQueue(view){var viewName="string"==typeof view?view:view.name,queue=persistentQueues[viewName];return queue||(queue=persistentQueues[viewName]=new TaskQueue$1),queue}function updateView(view){return sequentialize(getQueue(view),function(){return function(view){var mapResults,doc,mapFun=mapper(view.mapFun,function(key,value){var output={id:doc._id,key:normalizeKey(key)};null!=value&&(output.value=normalizeKey(value)),mapResults.push(output)}),currentSeq=view.seq||0;function processChange(docIdsToChangesAndEmits,seq){return function(){return function(view,docIdsToChangesAndEmits,seq){return view.db.get("_local/lastSeq").catch(defaultsTo({_id:"_local/lastSeq",seq:0})).then(function(lastSeqDoc){var docIds=mapToKeysArray(docIdsToChangesAndEmits);return Promise.all(docIds.map(function(docId){return getDocsToPersist(docId,view,docIdsToChangesAndEmits)})).then(function(listOfDocsToPersist){var docsToPersist=flatten(listOfDocsToPersist);return lastSeqDoc.seq=seq,docsToPersist.push(lastSeqDoc),view.db.bulkDocs({docs:docsToPersist})})})}(view,docIdsToChangesAndEmits,seq)}}var queue=new TaskQueue$1;function processNextBatch(){return view.sourceDB.changes({return_docs:!0,conflicts:!0,include_docs:!0,style:"all_docs",since:currentSeq,limit:CHANGES_BATCH_SIZE$1}).then(processBatch)}function processBatch(response){var results=response.results;if(results.length){var docIdsToChangesAndEmits=function(results){for(var docIdsToChangesAndEmits=new ExportedMap,i=0,len=results.length;i<len;i++){var change=results[i];if("_"!==change.doc._id[0]){mapResults=[],(doc=change.doc)._deleted||tryMap(view.sourceDB,mapFun,doc),mapResults.sort(sortByKeyThenValue);var indexableKeysToKeyValues=createIndexableKeysToKeyValues(mapResults);docIdsToChangesAndEmits.set(change.doc._id,[indexableKeysToKeyValues,change.changes])}currentSeq=change.seq}return docIdsToChangesAndEmits}(results);if(queue.add(processChange(docIdsToChangesAndEmits,currentSeq)),!(results.length<CHANGES_BATCH_SIZE$1))return processNextBatch()}}function createIndexableKeysToKeyValues(mapResults){for(var lastKey,indexableKeysToKeyValues=new ExportedMap,i=0,len=mapResults.length;i<len;i++){var emittedKeyValue=mapResults[i],complexKey=[emittedKeyValue.key,emittedKeyValue.id];i>0&&0===collate(emittedKeyValue.key,lastKey)&&complexKey.push(i),indexableKeysToKeyValues.set(toIndexableString(complexKey),emittedKeyValue),lastKey=emittedKeyValue.key}return indexableKeysToKeyValues}return processNextBatch().then(function(){return queue.finish()}).then(function(){view.seq=currentSeq})}(view)})()}function queryView(view,opts){return sequentialize(getQueue(view),function(){return function(view,opts){var totalRows,shouldReduce=view.reduceFun&&!1!==opts.reduce,skip=opts.skip||0;function fetchFromView(viewOpts){return viewOpts.include_docs=!0,view.db.allDocs(viewOpts).then(function(res){return totalRows=res.total_rows,res.rows.map(function(result){if("value"in result.doc&&"object"==typeof result.doc.value&&null!==result.doc.value){var keys=Object.keys(result.doc.value).sort(),expectedKeys=["id","key","value"];if(!(keys<expectedKeys||keys>expectedKeys))return result.doc.value}var parsedKeyAndDocId=function(str){for(var stack=[],metaStack=[],i=0;;){var collationIndex=str[i++];if("\0"!==collationIndex)switch(collationIndex){case"1":stack.push(null);break;case"2":stack.push("1"===str[i]),i++;break;case"3":var parsedNum=parseNumber(str,i);stack.push(parsedNum.num),i+=parsedNum.length;break;case"4":for(var parsedStr="";;){var ch=str[i];if("\0"===ch)break;parsedStr+=ch,i++}parsedStr=parsedStr.replace(/\u0001\u0001/g,"\0").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,""),stack.push(parsedStr);break;case"5":var arrayElement={element:[],index:stack.length};stack.push(arrayElement.element),metaStack.push(arrayElement);break;case"6":var objElement={element:{},index:stack.length};stack.push(objElement.element),metaStack.push(objElement);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+collationIndex)}else{if(1===stack.length)return stack.pop();pop(stack,metaStack)}}}(result.doc._id);return{key:parsedKeyAndDocId[0],id:parsedKeyAndDocId[1],value:"value"in result.doc?result.doc.value:null}})})}function onMapResultsReady(rows){var finalResults;if(finalResults=shouldReduce?function(view,results,options){0===options.group_level&&delete options.group_level;var shouldGroup=options.group||options.group_level,reduceFun=reducer(view.reduceFun),groups=[],lvl=isNaN(options.group_level)?Number.POSITIVE_INFINITY:options.group_level;results.forEach(function(e){var last=groups[groups.length-1],groupKey=shouldGroup?e.key:null;if(shouldGroup&&Array.isArray(groupKey)&&(groupKey=groupKey.slice(0,lvl)),last&&0===collate(last.groupKey,groupKey))return last.keys.push([e.key,e.id]),void last.values.push(e.value);groups.push({keys:[[e.key,e.id]],values:[e.value],groupKey:groupKey})}),results=[];for(var i=0,len=groups.length;i<len;i++){var e=groups[i],reduceTry=tryReduce(view.sourceDB,reduceFun,e.keys,e.values,!1);if(reduceTry.error&&reduceTry.error instanceof BuiltInError)throw reduceTry.error;results.push({value:reduceTry.error?null:reduceTry.output,key:e.groupKey})}return{rows:sliceResults(results,options.limit,options.skip)}}(view,rows,opts):{total_rows:totalRows,offset:skip,rows:rows},opts.update_seq&&(finalResults.update_seq=view.seq),opts.include_docs){var docIds=uniq(rows.map(rowToDocId));return view.sourceDB.allDocs({keys:docIds,include_docs:!0,conflicts:opts.conflicts,attachments:opts.attachments,binary:opts.binary}).then(function(allDocsRes){var docIdsToDocs=new ExportedMap;return allDocsRes.rows.forEach(function(row){docIdsToDocs.set(row.id,row.doc)}),rows.forEach(function(row){var docId=rowToDocId(row),doc=docIdsToDocs.get(docId);doc&&(row.doc=doc)}),finalResults})}return finalResults}if(void 0===opts.keys||opts.keys.length||(opts.limit=0,delete opts.keys),void 0!==opts.keys){var keys=opts.keys,fetchPromises=keys.map(function(key){var viewOpts={startkey:toIndexableString([key]),endkey:toIndexableString([key,{}])};return opts.update_seq&&(viewOpts.update_seq=!0),fetchFromView(viewOpts)});return Promise.all(fetchPromises).then(flatten).then(onMapResultsReady)}var startkey,endkey,viewOpts={descending:opts.descending};if(opts.update_seq&&(viewOpts.update_seq=!0),"start_key"in opts&&(startkey=opts.start_key),"startkey"in opts&&(startkey=opts.startkey),"end_key"in opts&&(endkey=opts.end_key),"endkey"in opts&&(endkey=opts.endkey),void 0!==startkey&&(viewOpts.startkey=opts.descending?toIndexableString([startkey,{}]):toIndexableString([startkey])),void 0!==endkey){var inclusiveEnd=!1!==opts.inclusive_end;opts.descending&&(inclusiveEnd=!inclusiveEnd),viewOpts.endkey=toIndexableString(inclusiveEnd?[endkey,{}]:[endkey])}if(void 0!==opts.key){var keyStart=toIndexableString([opts.key]),keyEnd=toIndexableString([opts.key,{}]);viewOpts.descending?(viewOpts.endkey=keyStart,viewOpts.startkey=keyEnd):(viewOpts.startkey=keyStart,viewOpts.endkey=keyEnd)}return shouldReduce||("number"==typeof opts.limit&&(viewOpts.limit=opts.limit),viewOpts.skip=skip),fetchFromView(viewOpts).then(onMapResultsReady)}(view,opts)})()}function queryPromised(db,fun,opts){if("function"==typeof db._query)return function(db,fun,opts){return new Promise(function(resolve,reject){db._query(fun,opts,function(err,res){if(err)return reject(err);resolve(res)})})}(db,fun,opts);if(isRemote(db))return function(db,fun,opts){var body,ok,status,params=[],method="GET";if(addHttpParam("reduce",opts,params),addHttpParam("include_docs",opts,params),addHttpParam("attachments",opts,params),addHttpParam("limit",opts,params),addHttpParam("descending",opts,params),addHttpParam("group",opts,params),addHttpParam("group_level",opts,params),addHttpParam("skip",opts,params),addHttpParam("stale",opts,params),addHttpParam("conflicts",opts,params),addHttpParam("startkey",opts,params,!0),addHttpParam("start_key",opts,params,!0),addHttpParam("endkey",opts,params,!0),addHttpParam("end_key",opts,params,!0),addHttpParam("inclusive_end",opts,params),addHttpParam("key",opts,params,!0),addHttpParam("update_seq",opts,params),params=""===(params=params.join("&"))?"":"?"+params,void 0!==opts.keys){var keysAsString="keys="+encodeURIComponent(JSON.stringify(opts.keys));keysAsString.length+params.length+1<=2e3?params+=("?"===params[0]?"&":"?")+keysAsString:(method="POST","string"==typeof fun?body={keys:opts.keys}:fun.keys=opts.keys)}if("string"==typeof fun){var parts=parseViewName(fun);return db.fetch("_design/"+parts[0]+"/_view/"+parts[1]+params,{headers:new h({"Content-Type":"application/json"}),method:method,body:JSON.stringify(body)}).then(function(response){return ok=response.ok,status=response.status,response.json()}).then(function(result){if(!ok)throw result.status=status,generateErrorFromResponse(result);return result.rows.forEach(function(row){if(row.value&&row.value.error&&"builtin_reduce_error"===row.value.error)throw new Error(row.reason)}),result}).then(postprocessAttachments(opts))}return body=body||{},Object.keys(fun).forEach(function(key){Array.isArray(fun[key])?body[key]=fun[key]:body[key]=fun[key].toString()}),db.fetch("_temp_view"+params,{headers:new h({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify(body)}).then(function(response){return ok=response.ok,status=response.status,response.json()}).then(function(result){if(!ok)throw result.status=status,generateErrorFromResponse(result);return result}).then(postprocessAttachments(opts))}(db,fun,opts);if("string"!=typeof fun)return checkQueryParseError(opts,fun),tempViewQueue.add(function(){return createView(db,"temp_view/temp_view",fun.map,fun.reduce,!0,localDocName).then(function(view){return promise=updateView(view).then(function(){return queryView(view,opts)}),finalPromiseFactory=function(){return view.db.destroy()},promise.then(function(res){return finalPromiseFactory().then(function(){return res})},function(reason){return finalPromiseFactory().then(function(){throw reason})});var promise,finalPromiseFactory})}),tempViewQueue.finish();var fullViewName=fun,parts=parseViewName(fullViewName),designDocName=parts[0],viewName=parts[1];return db.get("_design/"+designDocName).then(function(doc){var fun=doc.views&&doc.views[viewName];if(!fun)throw new NotFoundError("ddoc "+doc._id+" has no view named "+viewName);return ddocValidator(doc,viewName),checkQueryParseError(opts,fun),createView(db,fullViewName,fun.map,fun.reduce,!1,localDocName).then(function(view){return"ok"===opts.stale||"update_after"===opts.stale?("update_after"===opts.stale&&immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){updateView(view)}),queryView(view,opts)):updateView(view).then(function(){return queryView(view,opts)})})})}var fun;return{query:function(fun,opts,callback){var db=this;"function"==typeof opts&&(callback=opts,opts={}),opts=opts?function(opts){return opts.group_level=coerceInteger(opts.group_level),opts.limit=coerceInteger(opts.limit),opts.skip=coerceInteger(opts.skip),opts}(opts):{},"function"==typeof fun&&(fun={map:fun});var promise=Promise.resolve().then(function(){return queryPromised(db,fun,opts)});return promisedCallback(promise,callback),promise},viewCleanup:(fun=function(){var db=this;return"function"==typeof db._viewCleanup?function(db){return new Promise(function(resolve,reject){db._viewCleanup(function(err,res){if(err)return reject(err);resolve(res)})})}(db):isRemote(db)?function(db){return db.fetch("_view_cleanup",{headers:new h({"Content-Type":"application/json"}),method:"POST"}).then(function(response){return response.json()})}(db):function(db){return db.get("_local/"+localDocName).then(function(metaDoc){var docsToViews=new ExportedMap;Object.keys(metaDoc.views).forEach(function(fullViewName){var parts=parseViewName(fullViewName),designDocName="_design/"+parts[0],viewName=parts[1],views=docsToViews.get(designDocName);views||(views=new ExportedSet,docsToViews.set(designDocName,views)),views.add(viewName)});var opts={keys:mapToKeysArray(docsToViews),include_docs:!0};return db.allDocs(opts).then(function(res){var viewsToStatus={};res.rows.forEach(function(row){var ddocName=row.key.substring(8);docsToViews.get(row.key).forEach(function(viewName){var fullViewName=ddocName+"/"+viewName;metaDoc.views[fullViewName]||(fullViewName=viewName);var viewDBNames=Object.keys(metaDoc.views[fullViewName]),statusIsGood=row.doc&&row.doc.views&&row.doc.views[viewName];viewDBNames.forEach(function(viewDBName){viewsToStatus[viewDBName]=viewsToStatus[viewDBName]||statusIsGood})})});var destroyPromises=Object.keys(viewsToStatus).filter(function(viewDBName){return!viewsToStatus[viewDBName]}).map(function(viewDBName){return sequentialize(getQueue(viewDBName),function(){return new db.constructor(viewDBName,db.__opts).destroy()})()});return Promise.all(destroyPromises).then(function(){return{ok:!0}})})},defaultsTo({ok:!0}))}(db)},argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){var cb=args.pop(),promise=fun.apply(this,args);return"function"==typeof cb&&promisedCallback(promise,cb),promise}))}}("mrviews",function(mapFun,emit){if("function"==typeof mapFun&&2===mapFun.length){var origMap=mapFun;return function(doc){return origMap(doc,emit)}}return evalFunctionWithEval(mapFun.toString(),emit)},function(reduceFun){var reduceFunString=reduceFun.toString(),builtIn=function(reduceFunString){if(/^_sum/.test(reduceFunString))return builtInReduce._sum;if(/^_count/.test(reduceFunString))return builtInReduce._count;if(/^_stats/.test(reduceFunString))return builtInReduce._stats;if(/^_/.test(reduceFunString))throw new Error(reduceFunString+" is not a supported reduce function.")}(reduceFunString);return builtIn||evalFunctionWithEval(reduceFunString)},function(ddoc,viewName){var fun=ddoc.views&&ddoc.views[viewName];if("string"!=typeof fun.map)throw new NotFoundError("ddoc "+ddoc._id+" has no string view named "+viewName+", instead found object of type: "+typeof fun.map)});var mapreduce={query:function(fun,opts,callback){return abstract.query.call(this,fun,opts,callback)},viewCleanup:function(callback){return abstract.viewCleanup.call(this,callback)}};function isGenOne$1(rev){return/^1-/.test(rev)}function getDocAttachments(db,doc){var filenames=Object.keys(doc._attachments);return Promise.all(filenames.map(function(filename){return db.getAttachment(doc._id,filename,{rev:doc._rev})}))}function getDocs(src,target,diffs,state){diffs=clone(diffs);var resultDocs=[],ok=!0;function fetchRevisionOneDocs(ids){return src.allDocs({keys:ids,include_docs:!0,conflicts:!0}).then(function(res){if(state.cancelled)throw new Error("cancelled");res.rows.forEach(function(row){var doc;row.deleted||!row.doc||!isGenOne$1(row.value.rev)||(doc=row.doc,doc._attachments&&Object.keys(doc._attachments).length>0)||function(doc){return doc._conflicts&&doc._conflicts.length>0}(row.doc)||(row.doc._conflicts&&delete row.doc._conflicts,resultDocs.push(row.doc),delete diffs[row.id])})})}return Promise.resolve().then(function(){var ids=Object.keys(diffs).filter(function(id){var missing=diffs[id].missing;return 1===missing.length&&isGenOne$1(missing[0])});if(ids.length>0)return fetchRevisionOneDocs(ids)}).then(function(){var bulkGetOpts=function(diffs){var requests=[];return Object.keys(diffs).forEach(function(id){diffs[id].missing.forEach(function(missingRev){requests.push({id:id,rev:missingRev})})}),{docs:requests,revs:!0,latest:!0}}(diffs);if(bulkGetOpts.docs.length)return src.bulkGet(bulkGetOpts).then(function(bulkGetResponse){if(state.cancelled)throw new Error("cancelled");return Promise.all(bulkGetResponse.results.map(function(bulkGetInfo){return Promise.all(bulkGetInfo.docs.map(function(doc){var remoteDoc=doc.ok;return doc.error&&(ok=!1),remoteDoc&&remoteDoc._attachments?function(target,src,doc){var doCheckForLocalAttachments=isRemote(src)&&!isRemote(target),filenames=Object.keys(doc._attachments);return doCheckForLocalAttachments?target.get(doc._id).then(function(localDoc){return Promise.all(filenames.map(function(filename){return function(localDoc,remoteDoc,filename){return!localDoc._attachments||!localDoc._attachments[filename]||localDoc._attachments[filename].digest!==remoteDoc._attachments[filename].digest}(localDoc,doc,filename)?src.getAttachment(doc._id,filename):target.getAttachment(localDoc._id,filename)}))}).catch(function(error){if(404!==error.status)throw error;return getDocAttachments(src,doc)}):getDocAttachments(src,doc)}(target,src,remoteDoc).then(function(attachments){var filenames=Object.keys(remoteDoc._attachments);return attachments.forEach(function(attachment,i){var att=remoteDoc._attachments[filenames[i]];delete att.stub,delete att.length,att.data=attachment}),remoteDoc}):remoteDoc}))})).then(function(results){resultDocs=resultDocs.concat(flatten(results).filter(Boolean))})})}).then(function(){return{ok:ok,docs:resultDocs}})}var CHECKPOINT_VERSION=1,REPLICATOR="pouchdb",CHECKPOINT_HISTORY_SIZE=5,LOWEST_SEQ=0;function updateCheckpoint(db,id,checkpoint,session,returnValue){return db.get(id).catch(function(err){if(404===err.status)return"http"!==db.adapter&&"https"!==db.adapter||explainError(404,"PouchDB is just checking if a remote checkpoint exists."),{session_id:session,_id:id,history:[],replicator:REPLICATOR,version:CHECKPOINT_VERSION};throw err}).then(function(doc){if(!returnValue.cancelled&&doc.last_seq!==checkpoint)return doc.history=(doc.history||[]).filter(function(item){return item.session_id!==session}),doc.history.unshift({last_seq:checkpoint,session_id:session}),doc.history=doc.history.slice(0,CHECKPOINT_HISTORY_SIZE),doc.version=CHECKPOINT_VERSION,doc.replicator=REPLICATOR,doc.session_id=session,doc.last_seq=checkpoint,db.put(doc).catch(function(err){if(409===err.status)return updateCheckpoint(db,id,checkpoint,session,returnValue);throw err})})}function Checkpointer(src,target,id,returnValue,opts){this.src=src,this.target=target,this.id=id,this.returnValue=returnValue,this.opts=opts||{}}Checkpointer.prototype.writeCheckpoint=function(checkpoint,session){var self=this;return this.updateTarget(checkpoint,session).then(function(){return self.updateSource(checkpoint,session)})},Checkpointer.prototype.updateTarget=function(checkpoint,session){return this.opts.writeTargetCheckpoint?updateCheckpoint(this.target,this.id,checkpoint,session,this.returnValue):Promise.resolve(!0)},Checkpointer.prototype.updateSource=function(checkpoint,session){if(this.opts.writeSourceCheckpoint){var self=this;return updateCheckpoint(this.src,this.id,checkpoint,session,this.returnValue).catch(function(err){if(isForbiddenError(err))return self.opts.writeSourceCheckpoint=!1,!0;throw err})}return Promise.resolve(!0)};var comparisons={undefined:function(targetDoc,sourceDoc){return 0===collate(targetDoc.last_seq,sourceDoc.last_seq)?sourceDoc.last_seq:0},1:function(targetDoc,sourceDoc){return function(srcDoc,tgtDoc){if(srcDoc.session_id===tgtDoc.session_id)return{last_seq:srcDoc.last_seq,history:srcDoc.history};return function compareReplicationHistory(sourceHistory,targetHistory){var S=sourceHistory[0];var sourceRest=sourceHistory.slice(1);var T=targetHistory[0];var targetRest=targetHistory.slice(1);if(!S||0===targetHistory.length)return{last_seq:LOWEST_SEQ,history:[]};var sourceId=S.session_id;if(hasSessionId(sourceId,targetHistory))return{last_seq:S.last_seq,history:sourceHistory};var targetId=T.session_id;if(hasSessionId(targetId,sourceRest))return{last_seq:T.last_seq,history:targetRest};return compareReplicationHistory(sourceRest,targetRest)}(srcDoc.history,tgtDoc.history)}(sourceDoc,targetDoc).last_seq}};function hasSessionId(sessionId,history){var props=history[0],rest=history.slice(1);return!(!sessionId||0===history.length)&&(sessionId===props.session_id||hasSessionId(sessionId,rest))}function isForbiddenError(err){return"number"==typeof err.status&&4===Math.floor(err.status/100)}Checkpointer.prototype.getCheckpoint=function(){var self=this;return self.opts&&self.opts.writeSourceCheckpoint&&!self.opts.writeTargetCheckpoint?self.src.get(self.id).then(function(sourceDoc){return sourceDoc.last_seq||LOWEST_SEQ}).catch(function(err){if(404!==err.status)throw err;return LOWEST_SEQ}):self.target.get(self.id).then(function(targetDoc){return self.opts&&self.opts.writeTargetCheckpoint&&!self.opts.writeSourceCheckpoint?targetDoc.last_seq||LOWEST_SEQ:self.src.get(self.id).then(function(sourceDoc){return targetDoc.version!==sourceDoc.version?LOWEST_SEQ:(version=targetDoc.version?targetDoc.version.toString():"undefined")in comparisons?comparisons[version](targetDoc,sourceDoc):LOWEST_SEQ;var version},function(err){if(404===err.status&&targetDoc.last_seq)return self.src.put({_id:self.id,last_seq:LOWEST_SEQ}).then(function(){return LOWEST_SEQ},function(err){return isForbiddenError(err)?(self.opts.writeSourceCheckpoint=!1,targetDoc.last_seq):LOWEST_SEQ});throw err})}).catch(function(err){if(404!==err.status)throw err;return LOWEST_SEQ})};var STARTING_BACK_OFF=0;function generateReplicationId(src,target,opts){var docIds=opts.doc_ids?opts.doc_ids.sort(collate):"",filterFun=opts.filter?opts.filter.toString():"",queryParams="",filterViewName="",selector="";return opts.selector&&(selector=JSON.stringify(opts.selector)),opts.filter&&opts.query_params&&(queryParams=JSON.stringify(function(queryParams){return Object.keys(queryParams).sort(collate).reduce(function(result,key){return result[key]=queryParams[key],result},{})}(opts.query_params))),opts.filter&&"_view"===opts.filter&&(filterViewName=opts.view.toString()),Promise.all([src.id(),target.id()]).then(function(res){var queryData=res[0]+res[1]+filterFun+filterViewName+queryParams+docIds+selector;return new Promise(function(resolve){binaryMd5(queryData,resolve)})}).then(function(md5sum){return"_local/"+(md5sum=md5sum.replace(/\//g,".").replace(/\+/g,"_"))})}function replicate(src,target,opts,returnValue,result){var currentBatch,repId,checkpointer,batches=[],pendingBatch={seq:0,changes:[],docs:[]},writingCheckpoint=!1,changesCompleted=!1,replicationCompleted=!1,last_seq=0,continuous=opts.continuous||opts.live||!1,batch_size=opts.batch_size||100,batches_limit=opts.batches_limit||10,changesPending=!1,doc_ids=opts.doc_ids,selector=opts.selector,changedDocs=[],session=uuid();result=result||{ok:!0,start_time:(new Date).toISOString(),docs_read:0,docs_written:0,doc_write_failures:0,errors:[]};var changesOpts={};function initCheckpointer(){return checkpointer?Promise.resolve():generateReplicationId(src,target,opts).then(function(res){repId=res;var checkpointOpts={};checkpointOpts=!1===opts.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!1}:"source"===opts.checkpoint?{writeSourceCheckpoint:!0,writeTargetCheckpoint:!1}:"target"===opts.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!0}:{writeSourceCheckpoint:!0,writeTargetCheckpoint:!0},checkpointer=new Checkpointer(src,target,repId,returnValue,checkpointOpts)})}function writeDocs(){if(changedDocs=[],0!==currentBatch.docs.length){var docs=currentBatch.docs,bulkOpts={timeout:opts.timeout};return target.bulkDocs({docs:docs,new_edits:!1},bulkOpts).then(function(res){if(returnValue.cancelled)throw completeReplication(),new Error("cancelled");var errorsById=Object.create(null);res.forEach(function(res){res.error&&(errorsById[res.id]=res)});var errorsNo=Object.keys(errorsById).length;result.doc_write_failures+=errorsNo,result.docs_written+=docs.length-errorsNo,docs.forEach(function(doc){var error=errorsById[doc._id];if(error){result.errors.push(error);var errorName=(error.name||"").toLowerCase();if("unauthorized"!==errorName&&"forbidden"!==errorName)throw error;returnValue.emit("denied",clone(error))}else changedDocs.push(doc)})},function(err){throw result.doc_write_failures+=docs.length,err})}}function finishBatch(){if(currentBatch.error)throw new Error("There was a problem getting docs.");result.last_seq=last_seq=currentBatch.seq;var outResult=clone(result);return changedDocs.length&&(outResult.docs=changedDocs,"number"==typeof currentBatch.pending&&(outResult.pending=currentBatch.pending,delete currentBatch.pending),returnValue.emit("change",outResult)),writingCheckpoint=!0,checkpointer.writeCheckpoint(currentBatch.seq,session).then(function(){if(writingCheckpoint=!1,returnValue.cancelled)throw completeReplication(),new Error("cancelled");currentBatch=void 0,getChanges()}).catch(function(err){throw onCheckpointError(err),err})}function getBatchDocs(){return getDocs(src,target,currentBatch.diffs,returnValue).then(function(got){currentBatch.error=!got.ok,got.docs.forEach(function(doc){delete currentBatch.diffs[doc._id],result.docs_read++,currentBatch.docs.push(doc)})})}function startNextBatch(){var diff;returnValue.cancelled||currentBatch||(0!==batches.length?(currentBatch=batches.shift(),(diff={},currentBatch.changes.forEach(function(change){"_user/"!==change.id&&(diff[change.id]=change.changes.map(function(x){return x.rev}))}),target.revsDiff(diff).then(function(diffs){if(returnValue.cancelled)throw completeReplication(),new Error("cancelled");currentBatch.diffs=diffs})).then(getBatchDocs).then(writeDocs).then(finishBatch).then(startNextBatch).catch(function(err){abortReplication("batch processing terminated with error",err)})):processPendingBatch(!0))}function processPendingBatch(immediate){0!==pendingBatch.changes.length?(immediate||changesCompleted||pendingBatch.changes.length>=batch_size)&&(batches.push(pendingBatch),pendingBatch={seq:0,changes:[],docs:[]},"pending"!==returnValue.state&&"stopped"!==returnValue.state||(returnValue.state="active",returnValue.emit("active")),startNextBatch()):0!==batches.length||currentBatch||((continuous&&changesOpts.live||changesCompleted)&&(returnValue.state="pending",returnValue.emit("paused")),changesCompleted&&completeReplication())}function abortReplication(reason,err){replicationCompleted||(err.message||(err.message=reason),result.ok=!1,result.status="aborting",batches=[],pendingBatch={seq:0,changes:[],docs:[]},completeReplication(err))}function completeReplication(fatalError){if(!(replicationCompleted||returnValue.cancelled&&(result.status="cancelled",writingCheckpoint)))if(result.status=result.status||"complete",result.end_time=(new Date).toISOString(),result.last_seq=last_seq,replicationCompleted=!0,fatalError){(fatalError=createError(fatalError)).result=result;var errorName=(fatalError.name||"").toLowerCase();"unauthorized"===errorName||"forbidden"===errorName?(returnValue.emit("error",fatalError),returnValue.removeAllListeners()):function(opts,returnValue,error,callback){if(!1===opts.retry)return returnValue.emit("error",error),void returnValue.removeAllListeners();if("function"!=typeof opts.back_off_function&&(opts.back_off_function=defaultBackOff),returnValue.emit("requestError",error),"active"===returnValue.state||"pending"===returnValue.state){returnValue.emit("paused",error),returnValue.state="stopped";var backOffSet=function(){opts.current_back_off=STARTING_BACK_OFF};returnValue.once("paused",function(){returnValue.removeListener("active",backOffSet)}),returnValue.once("active",backOffSet)}opts.current_back_off=opts.current_back_off||STARTING_BACK_OFF,opts.current_back_off=opts.back_off_function(opts.current_back_off),setTimeout(callback,opts.current_back_off)}(opts,returnValue,fatalError,function(){replicate(src,target,opts,returnValue)})}else returnValue.emit("complete",result),returnValue.removeAllListeners()}function onChange(change,pending,lastSeq){if(returnValue.cancelled)return completeReplication();"number"==typeof pending&&(pendingBatch.pending=pending),filterChange(opts)(change)&&(pendingBatch.seq=change.seq||lastSeq,pendingBatch.changes.push(change),immediate__WEBPACK_IMPORTED_MODULE_1___default()(function(){processPendingBatch(0===batches.length&&changesOpts.live)}))}function onChangesComplete(changes){if(changesPending=!1,returnValue.cancelled)return completeReplication();if(changes.results.length>0)changesOpts.since=changes.results[changes.results.length-1].seq,getChanges(),processPendingBatch(!0);else{var complete=function(){continuous?(changesOpts.live=!0,getChanges()):changesCompleted=!0,processPendingBatch(!0)};currentBatch||0!==changes.results.length?complete():(writingCheckpoint=!0,checkpointer.writeCheckpoint(changes.last_seq,session).then(function(){writingCheckpoint=!1,result.last_seq=last_seq=changes.last_seq,complete()}).catch(onCheckpointError))}}function onChangesError(err){if(changesPending=!1,returnValue.cancelled)return completeReplication();abortReplication("changes rejected",err)}function getChanges(){if(!changesPending&&!changesCompleted&&batches.length<batches_limit){changesPending=!0,returnValue._changes&&(returnValue.removeListener("cancel",returnValue._abortChanges),returnValue._changes.cancel()),returnValue.once("cancel",abortChanges);var changes=src.changes(changesOpts).on("change",onChange);changes.then(removeListener,removeListener),changes.then(onChangesComplete).catch(onChangesError),opts.retry&&(returnValue._changes=changes,returnValue._abortChanges=abortChanges)}function abortChanges(){changes.cancel()}function removeListener(){returnValue.removeListener("cancel",abortChanges)}}function startChanges(){initCheckpointer().then(function(){if(!returnValue.cancelled)return checkpointer.getCheckpoint().then(function(checkpoint){changesOpts={since:last_seq=checkpoint,limit:batch_size,batch_size:batch_size,style:"all_docs",doc_ids:doc_ids,selector:selector,return_docs:!0},opts.filter&&("string"!=typeof opts.filter?changesOpts.include_docs=!0:changesOpts.filter=opts.filter),"heartbeat"in opts&&(changesOpts.heartbeat=opts.heartbeat),"timeout"in opts&&(changesOpts.timeout=opts.timeout),opts.query_params&&(changesOpts.query_params=opts.query_params),opts.view&&(changesOpts.view=opts.view),getChanges()});completeReplication()}).catch(function(err){abortReplication("getCheckpoint rejected with ",err)})}function onCheckpointError(err){writingCheckpoint=!1,abortReplication("writeCheckpoint completed with error",err)}returnValue.ready(src,target),returnValue.cancelled?completeReplication():(returnValue._addedListeners||(returnValue.once("cancel",completeReplication),"function"==typeof opts.complete&&(returnValue.once("error",opts.complete),returnValue.once("complete",function(result){opts.complete(null,result)})),returnValue._addedListeners=!0),void 0===opts.since?startChanges():initCheckpointer().then(function(){return writingCheckpoint=!0,checkpointer.writeCheckpoint(opts.since,session)}).then(function(){writingCheckpoint=!1,returnValue.cancelled?completeReplication():(last_seq=opts.since,startChanges())}).catch(onCheckpointError))}function Replication(){events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter.call(this),this.cancelled=!1,this.state="pending";var self=this,promise=new Promise(function(fulfill,reject){self.once("complete",fulfill),self.once("error",reject)});self.then=function(resolve,reject){return promise.then(resolve,reject)},self.catch=function(reject){return promise.catch(reject)},self.catch(function(){})}function toPouch(db,opts){var PouchConstructor=opts.PouchConstructor;return"string"==typeof db?new PouchConstructor(db,opts):db}function replicateWrapper(src,target,opts,callback){if("function"==typeof opts&&(callback=opts,opts={}),void 0===opts&&(opts={}),opts.doc_ids&&!Array.isArray(opts.doc_ids))throw createError(BAD_REQUEST,"`doc_ids` filter parameter is not a list.");opts.complete=callback,(opts=clone(opts)).continuous=opts.continuous||opts.live,opts.retry="retry"in opts&&opts.retry,opts.PouchConstructor=opts.PouchConstructor||this;var replicateRet=new Replication(opts);return replicate(toPouch(src,opts),toPouch(target,opts),opts,replicateRet),replicateRet}function sync(src,target,opts,callback){return"function"==typeof opts&&(callback=opts,opts={}),void 0===opts&&(opts={}),(opts=clone(opts)).PouchConstructor=opts.PouchConstructor||this,new Sync(src=toPouch(src,opts),target=toPouch(target,opts),opts,callback)}function Sync(src,target,opts,callback){var self=this;this.canceled=!1;var optsPush=opts.push?$inject_Object_assign({},opts,opts.push):opts,optsPull=opts.pull?$inject_Object_assign({},opts,opts.pull):opts;function pullChange(change){self.emit("change",{direction:"pull",change:change})}function pushChange(change){self.emit("change",{direction:"push",change:change})}function pushDenied(doc){self.emit("denied",{direction:"push",doc:doc})}function pullDenied(doc){self.emit("denied",{direction:"pull",doc:doc})}function pushPaused(){self.pushPaused=!0,self.pullPaused&&self.emit("paused")}function pullPaused(){self.pullPaused=!0,self.pushPaused&&self.emit("paused")}function pushActive(){self.pushPaused=!1,self.pullPaused&&self.emit("active",{direction:"push"})}function pullActive(){self.pullPaused=!1,self.pushPaused&&self.emit("active",{direction:"pull"})}this.push=replicateWrapper(src,target,optsPush),this.pull=replicateWrapper(target,src,optsPull),this.pushPaused=!0,this.pullPaused=!0;var removed={};function removeAll(type){return function(event,func){("change"===event&&(func===pullChange||func===pushChange)||"denied"===event&&(func===pullDenied||func===pushDenied)||"paused"===event&&(func===pullPaused||func===pushPaused)||"active"===event&&(func===pullActive||func===pushActive))&&(event in removed||(removed[event]={}),removed[event][type]=!0,2===Object.keys(removed[event]).length&&self.removeAllListeners(event))}}function addOneListener(ee,event,listener){-1==ee.listeners(event).indexOf(listener)&&ee.on(event,listener)}opts.live&&(this.push.on("complete",self.pull.cancel.bind(self.pull)),this.pull.on("complete",self.push.cancel.bind(self.push))),this.on("newListener",function(event){"change"===event?(addOneListener(self.pull,"change",pullChange),addOneListener(self.push,"change",pushChange)):"denied"===event?(addOneListener(self.pull,"denied",pullDenied),addOneListener(self.push,"denied",pushDenied)):"active"===event?(addOneListener(self.pull,"active",pullActive),addOneListener(self.push,"active",pushActive)):"paused"===event&&(addOneListener(self.pull,"paused",pullPaused),addOneListener(self.push,"paused",pushPaused))}),this.on("removeListener",function(event){"change"===event?(self.pull.removeListener("change",pullChange),self.push.removeListener("change",pushChange)):"denied"===event?(self.pull.removeListener("denied",pullDenied),self.push.removeListener("denied",pushDenied)):"active"===event?(self.pull.removeListener("active",pullActive),self.push.removeListener("active",pushActive)):"paused"===event&&(self.pull.removeListener("paused",pullPaused),self.push.removeListener("paused",pushPaused))}),this.pull.on("removeListener",removeAll("pull")),this.push.on("removeListener",removeAll("push"));var promise=Promise.all([this.push,this.pull]).then(function(resp){var out={push:resp[0],pull:resp[1]};return self.emit("complete",out),callback&&callback(null,out),self.removeAllListeners(),out},function(err){if(self.cancel(),callback?callback(err):self.emit("error",err),self.removeAllListeners(),callback)throw err});this.then=function(success,err){return promise.then(success,err)},this.catch=function(err){return promise.catch(err)}}inherits__WEBPACK_IMPORTED_MODULE_3___default()(Replication,events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter),Replication.prototype.cancel=function(){this.cancelled=!0,this.state="cancelled",this.emit("cancel")},Replication.prototype.ready=function(src,target){var self=this;function onDestroy(){self.cancel()}self._readyCalled||(self._readyCalled=!0,src.once("destroyed",onDestroy),target.once("destroyed",onDestroy),self.once("complete",function(){src.removeListener("destroyed",onDestroy),target.removeListener("destroyed",onDestroy)}))},inherits__WEBPACK_IMPORTED_MODULE_3___default()(Sync,events__WEBPACK_IMPORTED_MODULE_2__.EventEmitter),Sync.prototype.cancel=function(){this.canceled||(this.canceled=!0,this.push.cancel(),this.pull.cancel())},PouchDB.plugin(function(PouchDB){PouchDB.adapter("idb",IdbPouch,!0)}).plugin(function(PouchDB){PouchDB.adapter("http",HttpPouch,!1),PouchDB.adapter("https",HttpPouch,!1)}).plugin(mapreduce).plugin(function(PouchDB){PouchDB.replicate=replicateWrapper,PouchDB.sync=sync,Object.defineProperty(PouchDB.prototype,"replicate",{get:function(){var self=this;return void 0===this.replicateMethods&&(this.replicateMethods={from:function(other,opts,callback){return self.constructor.replicate(other,self,opts,callback)},to:function(other,opts,callback){return self.constructor.replicate(self,other,opts,callback)}}),this.replicateMethods}}),PouchDB.prototype.sync=function(dbName,opts,callback){return this.constructor.sync(this,dbName,opts,callback)}}),__webpack_exports__.default=PouchDB}.call(this,__webpack_require__(2),__webpack_require__(53))},function(module,exports,__webpack_require__){"use strict";module.exports=function(fun){return function(){var len=arguments.length;if(len){for(var args=[],i=-1;++i<len;)args[i]=arguments[i];return fun.call(this,args)}return fun.call(this,[])}}},function(module,exports,__webpack_require__){"use strict";(function(global){var scheduleDrain,draining,Mutation=global.MutationObserver||global.WebKitMutationObserver;if(Mutation){var called=0,observer=new Mutation(nextTick),element=global.document.createTextNode("");observer.observe(element,{characterData:!0}),scheduleDrain=function(){element.data=called=++called%2}}else if(global.setImmediate||void 0===global.MessageChannel)scheduleDrain="document"in global&&"onreadystatechange"in global.document.createElement("script")?function(){var scriptEl=global.document.createElement("script");scriptEl.onreadystatechange=function(){nextTick(),scriptEl.onreadystatechange=null,scriptEl.parentNode.removeChild(scriptEl),scriptEl=null},global.document.documentElement.appendChild(scriptEl)}:function(){setTimeout(nextTick,0)};else{var channel=new global.MessageChannel;channel.port1.onmessage=nextTick,scheduleDrain=function(){channel.port2.postMessage(0)}}var queue=[];function nextTick(){var i,oldQueue;draining=!0;for(var len=queue.length;len;){for(oldQueue=queue,queue=[],i=-1;++i<len;)oldQueue[i]();len=queue.length}draining=!1}module.exports=function(task){1!==queue.push(task)||draining||scheduleDrain()}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(target,receiver,args){return Function.prototype.apply.call(target,receiver,args)};ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(target){return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))}:function(target){return Object.getOwnPropertyNames(target)};var NumberIsNaN=Number.isNaN||function(value){return value!=value};function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function $getMaxListeners(that){return void 0===that._maxListeners?EventEmitter.defaultMaxListeners:that._maxListeners}function _addListener(target,type,listener,prepend){var m,events,existing,warning;if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);if(void 0===(events=target._events)?(events=target._events=Object.create(null),target._eventsCount=0):(void 0!==events.newListener&&(target.emit("newListener",type,listener.listener?listener.listener:listener),events=target._events),existing=events[type]),void 0===existing)existing=events[type]=listener,++target._eventsCount;else if("function"==typeof existing?existing=events[type]=prepend?[listener,existing]:[existing,listener]:prepend?existing.unshift(listener):existing.push(listener),(m=$getMaxListeners(target))>0&&existing.length>m&&!existing.warned){existing.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+String(type)+" listeners added. Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning",w.emitter=target,w.type=type,w.count=existing.length,warning=w,console&&console.warn&&console.warn(warning)}return target}function _onceWrap(target,type,listener){var state={fired:!1,wrapFn:void 0,target:target,type:type,listener:listener},wrapped=function(){for(var args=[],i=0;i<arguments.length;i++)args.push(arguments[i]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,ReflectApply(this.listener,this.target,args))}.bind(state);return wrapped.listener=listener,state.wrapFn=wrapped,wrapped}function _listeners(target,type,unwrap){var events=target._events;if(void 0===events)return[];var evlistener=events[type];return void 0===evlistener?[]:"function"==typeof evlistener?unwrap?[evlistener.listener||evlistener]:[evlistener]:unwrap?function(arr){for(var ret=new Array(arr.length),i=0;i<ret.length;++i)ret[i]=arr[i].listener||arr[i];return ret}(evlistener):arrayClone(evlistener,evlistener.length)}function listenerCount(type){var events=this._events;if(void 0!==events){var evlistener=events[type];if("function"==typeof evlistener)return 1;if(void 0!==evlistener)return evlistener.length}return 0}function arrayClone(arr,n){for(var copy=new Array(n),i=0;i<n;++i)copy[i]=arr[i];return copy}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(arg){if("number"!=typeof arg||arg<0||NumberIsNaN(arg))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+arg+".");defaultMaxListeners=arg}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if("number"!=typeof n||n<0||NumberIsNaN(n))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n+".");return this._maxListeners=n,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(type){for(var args=[],i=1;i<arguments.length;i++)args.push(arguments[i]);var doError="error"===type,events=this._events;if(void 0!==events)doError=doError&&void 0===events.error;else if(!doError)return!1;if(doError){var er;if(args.length>0&&(er=args[0]),er instanceof Error)throw er;var err=new Error("Unhandled error."+(er?" ("+er.message+")":""));throw err.context=er,err}var handler=events[type];if(void 0===handler)return!1;if("function"==typeof handler)ReflectApply(handler,this,args);else{var len=handler.length,listeners=arrayClone(handler,len);for(i=0;i<len;++i)ReflectApply(listeners[i],this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){return _addListener(this,type,listener,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(type,listener){return _addListener(this,type,listener,!0)},EventEmitter.prototype.once=function(type,listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);return this.on(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.prependOnceListener=function(type,listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);return this.prependListener(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.removeListener=function(type,listener){var list,events,position,i,originalListener;if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);if(void 0===(events=this._events))return this;if(void 0===(list=events[type]))return this;if(list===listener||list.listener===listener)0==--this._eventsCount?this._events=Object.create(null):(delete events[type],events.removeListener&&this.emit("removeListener",type,list.listener||listener));else if("function"!=typeof list){for(position=-1,i=list.length-1;i>=0;i--)if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener,position=i;break}if(position<0)return this;0===position?list.shift():function(list,index){for(;index+1<list.length;index++)list[index]=list[index+1];list.pop()}(list,position),1===list.length&&(events[type]=list[0]),void 0!==events.removeListener&&this.emit("removeListener",type,originalListener||listener)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(type){var listeners,events,i;if(void 0===(events=this._events))return this;if(void 0===events.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==events[type]&&(0==--this._eventsCount?this._events=Object.create(null):delete events[type]),this;if(0===arguments.length){var key,keys=Object.keys(events);for(i=0;i<keys.length;++i)"removeListener"!==(key=keys[i])&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(listeners=events[type]))this.removeListener(type,listeners);else if(void 0!==listeners)for(i=listeners.length-1;i>=0;i--)this.removeListener(type,listeners[i]);return this},EventEmitter.prototype.listeners=function(type){return _listeners(this,type,!0)},EventEmitter.prototype.rawListeners=function(type){return _listeners(this,type,!1)},EventEmitter.listenerCount=function(emitter,type){return"function"==typeof emitter.listenerCount?emitter.listenerCount(type):listenerCount.call(emitter,type)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]}},function(module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},function(module,exports,__webpack_require__){module.exports=function(undefined){"use strict";var hex_chr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a+=(b&c|~b&d)+k[0]-680876936|0,d+=((a=(a<<7|a>>>25)+b|0)&b|~a&c)+k[1]-389564586|0,c+=((d=(d<<12|d>>>20)+a|0)&a|~d&b)+k[2]+606105819|0,b+=((c=(c<<17|c>>>15)+d|0)&d|~c&a)+k[3]-1044525330|0,a+=((b=(b<<22|b>>>10)+c|0)&c|~b&d)+k[4]-176418897|0,d+=((a=(a<<7|a>>>25)+b|0)&b|~a&c)+k[5]+1200080426|0,c+=((d=(d<<12|d>>>20)+a|0)&a|~d&b)+k[6]-1473231341|0,b+=((c=(c<<17|c>>>15)+d|0)&d|~c&a)+k[7]-45705983|0,a+=((b=(b<<22|b>>>10)+c|0)&c|~b&d)+k[8]+1770035416|0,d+=((a=(a<<7|a>>>25)+b|0)&b|~a&c)+k[9]-1958414417|0,c+=((d=(d<<12|d>>>20)+a|0)&a|~d&b)+k[10]-42063|0,b+=((c=(c<<17|c>>>15)+d|0)&d|~c&a)+k[11]-1990404162|0,a+=((b=(b<<22|b>>>10)+c|0)&c|~b&d)+k[12]+1804603682|0,d+=((a=(a<<7|a>>>25)+b|0)&b|~a&c)+k[13]-40341101|0,c+=((d=(d<<12|d>>>20)+a|0)&a|~d&b)+k[14]-1502002290|0,b+=((c=(c<<17|c>>>15)+d|0)&d|~c&a)+k[15]+1236535329|0,a+=((b=(b<<22|b>>>10)+c|0)&d|c&~d)+k[1]-165796510|0,d+=((a=(a<<5|a>>>27)+b|0)&c|b&~c)+k[6]-1069501632|0,c+=((d=(d<<9|d>>>23)+a|0)&b|a&~b)+k[11]+643717713|0,b+=((c=(c<<14|c>>>18)+d|0)&a|d&~a)+k[0]-373897302|0,a+=((b=(b<<20|b>>>12)+c|0)&d|c&~d)+k[5]-701558691|0,d+=((a=(a<<5|a>>>27)+b|0)&c|b&~c)+k[10]+38016083|0,c+=((d=(d<<9|d>>>23)+a|0)&b|a&~b)+k[15]-660478335|0,b+=((c=(c<<14|c>>>18)+d|0)&a|d&~a)+k[4]-405537848|0,a+=((b=(b<<20|b>>>12)+c|0)&d|c&~d)+k[9]+568446438|0,d+=((a=(a<<5|a>>>27)+b|0)&c|b&~c)+k[14]-1019803690|0,c+=((d=(d<<9|d>>>23)+a|0)&b|a&~b)+k[3]-187363961|0,b+=((c=(c<<14|c>>>18)+d|0)&a|d&~a)+k[8]+1163531501|0,a+=((b=(b<<20|b>>>12)+c|0)&d|c&~d)+k[13]-1444681467|0,d+=((a=(a<<5|a>>>27)+b|0)&c|b&~c)+k[2]-51403784|0,c+=((d=(d<<9|d>>>23)+a|0)&b|a&~b)+k[7]+1735328473|0,b+=((c=(c<<14|c>>>18)+d|0)&a|d&~a)+k[12]-1926607734|0,a+=((b=(b<<20|b>>>12)+c|0)^c^d)+k[5]-378558|0,d+=((a=(a<<4|a>>>28)+b|0)^b^c)+k[8]-2022574463|0,c+=((d=(d<<11|d>>>21)+a|0)^a^b)+k[11]+1839030562|0,b+=((c=(c<<16|c>>>16)+d|0)^d^a)+k[14]-35309556|0,a+=((b=(b<<23|b>>>9)+c|0)^c^d)+k[1]-1530992060|0,d+=((a=(a<<4|a>>>28)+b|0)^b^c)+k[4]+1272893353|0,c+=((d=(d<<11|d>>>21)+a|0)^a^b)+k[7]-155497632|0,b+=((c=(c<<16|c>>>16)+d|0)^d^a)+k[10]-1094730640|0,a+=((b=(b<<23|b>>>9)+c|0)^c^d)+k[13]+681279174|0,d+=((a=(a<<4|a>>>28)+b|0)^b^c)+k[0]-358537222|0,c+=((d=(d<<11|d>>>21)+a|0)^a^b)+k[3]-722521979|0,b+=((c=(c<<16|c>>>16)+d|0)^d^a)+k[6]+76029189|0,a+=((b=(b<<23|b>>>9)+c|0)^c^d)+k[9]-640364487|0,d+=((a=(a<<4|a>>>28)+b|0)^b^c)+k[12]-421815835|0,c+=((d=(d<<11|d>>>21)+a|0)^a^b)+k[15]+530742520|0,b+=((c=(c<<16|c>>>16)+d|0)^d^a)+k[2]-995338651|0,a+=(c^((b=(b<<23|b>>>9)+c|0)|~d))+k[0]-198630844|0,d+=(b^((a=(a<<6|a>>>26)+b|0)|~c))+k[7]+1126891415|0,c+=(a^((d=(d<<10|d>>>22)+a|0)|~b))+k[14]-1416354905|0,b+=(d^((c=(c<<15|c>>>17)+d|0)|~a))+k[5]-57434055|0,a+=(c^((b=(b<<21|b>>>11)+c|0)|~d))+k[12]+1700485571|0,d+=(b^((a=(a<<6|a>>>26)+b|0)|~c))+k[3]-1894986606|0,c+=(a^((d=(d<<10|d>>>22)+a|0)|~b))+k[10]-1051523|0,b+=(d^((c=(c<<15|c>>>17)+d|0)|~a))+k[1]-2054922799|0,a+=(c^((b=(b<<21|b>>>11)+c|0)|~d))+k[8]+1873313359|0,d+=(b^((a=(a<<6|a>>>26)+b|0)|~c))+k[15]-30611744|0,c+=(a^((d=(d<<10|d>>>22)+a|0)|~b))+k[6]-1560198380|0,b+=(d^((c=(c<<15|c>>>17)+d|0)|~a))+k[13]+1309151649|0,a+=(c^((b=(b<<21|b>>>11)+c|0)|~d))+k[4]-145523070|0,d+=(b^((a=(a<<6|a>>>26)+b|0)|~c))+k[11]-1120210379|0,c+=(a^((d=(d<<10|d>>>22)+a|0)|~b))+k[2]+718787259|0,b=((b+=(d^((c=(c<<15|c>>>17)+d|0)|~a))+k[9]-343485551|0)<<21|b>>>11)+c|0,x[0]=a+x[0]|0,x[1]=b+x[1]|0,x[2]=c+x[2]|0,x[3]=d+x[3]|0}function md5blk(s){var i,md5blks=[];for(i=0;i<64;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}function md5blk_array(a){var i,md5blks=[];for(i=0;i<64;i+=4)md5blks[i>>2]=a[i]+(a[i+1]<<8)+(a[i+2]<<16)+(a[i+3]<<24);return md5blks}function md51(s){var i,length,tail,tmp,lo,hi,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=n;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));for(s=s.substring(i-64),length=s.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;i<length;i+=1)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;i<16;i+=1)tail[i]=0;return tmp=(tmp=8*n).toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(state,tail),state}function rhex(n){var j,s="";for(j=0;j<4;j+=1)s+=hex_chr[n>>8*j+4&15]+hex_chr[n>>8*j&15];return s}function hex(x){var i;for(i=0;i<x.length;i+=1)x[i]=rhex(x[i]);return x.join("")}function toUtf8(str){return/[\u0080-\uFFFF]/.test(str)&&(str=unescape(encodeURIComponent(str))),str}function hexToBinaryString(hex){var x,bytes=[],length=hex.length;for(x=0;x<length-1;x+=2)bytes.push(parseInt(hex.substr(x,2),16));return String.fromCharCode.apply(String,bytes)}function SparkMD5(){this.reset()}return hex(md51("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function clamp(val,length){return(val=0|val||0)<0?Math.max(val+length,0):Math.min(val,length)}ArrayBuffer.prototype.slice=function(from,to){var num,target,targetArray,sourceArray,length=this.byteLength,begin=clamp(from,length),end=length;return to!==undefined&&(end=clamp(to,length)),begin>end?new ArrayBuffer(0):(num=end-begin,target=new ArrayBuffer(num),targetArray=new Uint8Array(target),sourceArray=new Uint8Array(this,begin,num),targetArray.set(sourceArray),target)}}(),SparkMD5.prototype.append=function(str){return this.appendBinary(toUtf8(str)),this},SparkMD5.prototype.appendBinary=function(contents){this._buff+=contents,this._length+=contents.length;var i,length=this._buff.length;for(i=64;i<=length;i+=64)md5cycle(this._hash,md5blk(this._buff.substring(i-64,i)));return this._buff=this._buff.substring(i-64),this},SparkMD5.prototype.end=function(raw){var i,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<length;i+=1)tail[i>>2]|=buff.charCodeAt(i)<<(i%4<<3);return this._finish(tail,length),ret=hex(this._hash),raw&&(ret=hexToBinaryString(ret)),this.reset(),ret},SparkMD5.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},SparkMD5.prototype.setState=function(state){return this._buff=state.buff,this._length=state.length,this._hash=state.hash,this},SparkMD5.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},SparkMD5.prototype._finish=function(tail,length){var tmp,lo,hi,i=length;if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(this._hash,tail),i=0;i<16;i+=1)tail[i]=0;tmp=(tmp=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(this._hash,tail)},SparkMD5.hash=function(str,raw){return SparkMD5.hashBinary(toUtf8(str),raw)},SparkMD5.hashBinary=function(content,raw){var ret=hex(md51(content));return raw?hexToBinaryString(ret):ret},SparkMD5.ArrayBuffer=function(){this.reset()},SparkMD5.ArrayBuffer.prototype.append=function(arr){var i,first,second,returnUInt8Array,result,buff=(first=this._buff.buffer,second=arr,returnUInt8Array=!0,(result=new Uint8Array(first.byteLength+second.byteLength)).set(new Uint8Array(first)),result.set(new Uint8Array(second),first.byteLength),returnUInt8Array?result:result.buffer),length=buff.length;for(this._length+=arr.byteLength,i=64;i<=length;i+=64)md5cycle(this._hash,md5blk_array(buff.subarray(i-64,i)));return this._buff=i-64<length?new Uint8Array(buff.buffer.slice(i-64)):new Uint8Array(0),this},SparkMD5.ArrayBuffer.prototype.end=function(raw){var i,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<length;i+=1)tail[i>>2]|=buff[i]<<(i%4<<3);return this._finish(tail,length),ret=hex(this._hash),raw&&(ret=hexToBinaryString(ret)),this.reset(),ret},SparkMD5.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.ArrayBuffer.prototype.getState=function(){var buff,state=SparkMD5.prototype.getState.call(this);return state.buff=(buff=state.buff,String.fromCharCode.apply(null,new Uint8Array(buff))),state},SparkMD5.ArrayBuffer.prototype.setState=function(state){return state.buff=function(str,returnUInt8Array){var i,length=str.length,buff=new ArrayBuffer(length),arr=new Uint8Array(buff);for(i=0;i<length;i+=1)arr[i]=str.charCodeAt(i);return returnUInt8Array?arr:buff}(state.buff,!0),SparkMD5.prototype.setState.call(this,state)},SparkMD5.ArrayBuffer.prototype.destroy=SparkMD5.prototype.destroy,SparkMD5.ArrayBuffer.prototype._finish=SparkMD5.prototype._finish,SparkMD5.ArrayBuffer.hash=function(arr,raw){var ret=hex(function(a){var i,length,tail,tmp,lo,hi,n=a.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=n;i+=64)md5cycle(state,md5blk_array(a.subarray(i-64,i)));for(a=i-64<n?a.subarray(i-64):new Uint8Array(0),length=a.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;i<length;i+=1)tail[i>>2]|=a[i]<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;i<16;i+=1)tail[i]=0;return tmp=(tmp=8*n).toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(state,tail),state}(new Uint8Array(arr)));return raw?hexToBinaryString(ret):ret},SparkMD5}()},function(module,exports,__webpack_require__){var v1=__webpack_require__(65),v4=__webpack_require__(68),uuid=v4;uuid.v1=v1,uuid.v4=v4,module.exports=uuid},function(module,exports,__webpack_require__){var _nodeId,_clockseq,rng=__webpack_require__(66),bytesToUuid=__webpack_require__(67),_lastMSecs=0,_lastNSecs=0;module.exports=function(options,buf,offset){var i=buf&&offset||0,b=buf||[],node=(options=options||{}).node||_nodeId,clockseq=void 0!==options.clockseq?options.clockseq:_clockseq;if(null==node||null==clockseq){var seedBytes=rng();null==node&&(node=_nodeId=[1|seedBytes[0],seedBytes[1],seedBytes[2],seedBytes[3],seedBytes[4],seedBytes[5]]),null==clockseq&&(clockseq=_clockseq=16383&(seedBytes[6]<<8|seedBytes[7]))}var msecs=void 0!==options.msecs?options.msecs:(new Date).getTime(),nsecs=void 0!==options.nsecs?options.nsecs:_lastNSecs+1,dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&void 0===options.clockseq&&(clockseq=clockseq+1&16383),(dt<0||msecs>_lastMSecs)&&void 0===options.nsecs&&(nsecs=0),nsecs>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=msecs,_lastNSecs=nsecs,_clockseq=clockseq;var tl=(1e4*(268435455&(msecs+=122192928e5))+nsecs)%4294967296;b[i++]=tl>>>24&255,b[i++]=tl>>>16&255,b[i++]=tl>>>8&255,b[i++]=255&tl;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255,b[i++]=255&tmh,b[i++]=tmh>>>24&15|16,b[i++]=tmh>>>16&255,b[i++]=clockseq>>>8|128,b[i++]=255&clockseq;for(var n=0;n<6;++n)b[i+n]=node[n];return buf||bytesToUuid(b)}},function(module,exports){var getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&msCrypto.getRandomValues.bind(msCrypto);if(getRandomValues){var rnds8=new Uint8Array(16);module.exports=function(){return getRandomValues(rnds8),rnds8}}else{var rnds=new Array(16);module.exports=function(){for(var r,i=0;i<16;i++)0==(3&i)&&(r=4294967296*Math.random()),rnds[i]=r>>>((3&i)<<3)&255;return rnds}}},function(module,exports){for(var byteToHex=[],i=0;i<256;++i)byteToHex[i]=(i+256).toString(16).substr(1);module.exports=function(buf,offset){var i=offset||0,bth=byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}},function(module,exports,__webpack_require__){var rng=__webpack_require__(66),bytesToUuid=__webpack_require__(67);module.exports=function(options,buf,offset){var i=buf&&offset||0;"string"==typeof options&&(buf="binary"===options?new Array(16):null,options=null);var rnds=(options=options||{}).random||(options.rng||rng)();if(rnds[6]=15&rnds[6]|64,rnds[8]=63&rnds[8]|128,buf)for(var ii=0;ii<16;++ii)buf[i+ii]=rnds[ii];return buf||bytesToUuid(rnds)}},function(module,exports,__webpack_require__){"use strict";function pop(obj,stack,metaStack){var lastMetaElement=metaStack[metaStack.length-1];obj===lastMetaElement.element&&(metaStack.pop(),lastMetaElement=metaStack[metaStack.length-1]);var element=lastMetaElement.element,lastElementIndex=lastMetaElement.index;if(Array.isArray(element))element.push(obj);else if(lastElementIndex===stack.length-2){element[stack.pop()]=obj}else stack.push(obj)}exports.stringify=function(input){var queue=[];queue.push({obj:input});for(var next,obj,val,i,arrayPrefix,keys,k,key,value,objPrefix,res="";next=queue.pop();)if(obj=next.obj,res+=next.prefix||"",val=next.val||"")res+=val;else if("object"!=typeof obj)res+=void 0===obj?null:JSON.stringify(obj);else if(null===obj)res+="null";else if(Array.isArray(obj)){for(queue.push({val:"]"}),i=obj.length-1;i>=0;i--)arrayPrefix=0===i?"":",",queue.push({obj:obj[i],prefix:arrayPrefix});queue.push({val:"["})}else{for(k in keys=[],obj)obj.hasOwnProperty(k)&&keys.push(k);for(queue.push({val:"}"}),i=keys.length-1;i>=0;i--)value=obj[key=keys[i]],objPrefix=i>0?",":"",objPrefix+=JSON.stringify(key)+":",queue.push({obj:value,prefix:objPrefix});queue.push({val:"{"})}return res},exports.parse=function(str){for(var collationIndex,parsedNum,numChar,parsedString,lastCh,numConsecutiveSlashes,ch,arrayElement,objElement,stack=[],metaStack=[],i=0;;)if("}"!==(collationIndex=str[i++])&&"]"!==collationIndex&&void 0!==collationIndex)switch(collationIndex){case" ":case"\t":case"\n":case":":case",":break;case"n":i+=3,pop(null,stack,metaStack);break;case"t":i+=3,pop(!0,stack,metaStack);break;case"f":i+=4,pop(!1,stack,metaStack);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(parsedNum="",i--;;){if(numChar=str[i++],!/[\d\.\-e\+]/.test(numChar)){i--;break}parsedNum+=numChar}pop(parseFloat(parsedNum),stack,metaStack);break;case'"':for(parsedString="",lastCh=void 0,numConsecutiveSlashes=0;'"'!==(ch=str[i++])||"\\"===lastCh&&numConsecutiveSlashes%2==1;)parsedString+=ch,"\\"===(lastCh=ch)?numConsecutiveSlashes++:numConsecutiveSlashes=0;pop(JSON.parse('"'+parsedString+'"'),stack,metaStack);break;case"[":arrayElement={element:[],index:stack.length},stack.push(arrayElement.element),metaStack.push(arrayElement);break;case"{":objElement={element:{},index:stack.length},stack.push(objElement.element),metaStack.push(objElement);break;default:throw new Error("unexpectedly reached end of input: "+collationIndex)}else{if(1===stack.length)return stack.pop();pop(stack.pop(),stack,metaStack)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(71),pouchdb_adapter_leveldb_core__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(76),memdown__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(138),memdown__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(memdown__WEBPACK_IMPORTED_MODULE_2__);function MemDownPouch(opts,callback){var _opts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.assign)({db:memdown__WEBPACK_IMPORTED_MODULE_2___default.a},opts);pouchdb_adapter_leveldb_core__WEBPACK_IMPORTED_MODULE_1__.default.call(this,_opts,callback)}MemDownPouch.valid=function(){return!0},MemDownPouch.use_prefix=!1,__webpack_exports__.default=function(PouchDB){PouchDB.adapter("memory",MemDownPouch,!0)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"adapterFun",function(){return adapterFun}),__webpack_require__.d(__webpack_exports__,"assign",function(){return assign$1}),__webpack_require__.d(__webpack_exports__,"bulkGetShim",function(){return bulkGet}),__webpack_require__.d(__webpack_exports__,"changesHandler",function(){return Changes}),__webpack_require__.d(__webpack_exports__,"clone",function(){return clone$1}),__webpack_require__.d(__webpack_exports__,"defaultBackOff",function(){return defaultBackOff}),__webpack_require__.d(__webpack_exports__,"explainError",function(){return explainError}),__webpack_require__.d(__webpack_exports__,"filterChange",function(){return filterChange}),__webpack_require__.d(__webpack_exports__,"flatten",function(){return flatten}),__webpack_require__.d(__webpack_exports__,"functionName",function(){return res$1}),__webpack_require__.d(__webpack_exports__,"guardedConsole",function(){return guardedConsole}),__webpack_require__.d(__webpack_exports__,"hasLocalStorage",function(){return hasLocalStorage}),__webpack_require__.d(__webpack_exports__,"invalidIdError",function(){return invalidIdError}),__webpack_require__.d(__webpack_exports__,"isRemote",function(){return isRemote}),__webpack_require__.d(__webpack_exports__,"listenerCount",function(){return listenerCount}),__webpack_require__.d(__webpack_exports__,"normalizeDdocFunctionName",function(){return normalizeDesignDocFunctionName}),__webpack_require__.d(__webpack_exports__,"once",function(){return once}),__webpack_require__.d(__webpack_exports__,"parseDdocFunctionName",function(){return parseDesignDocFunctionName}),__webpack_require__.d(__webpack_exports__,"parseUri",function(){return parseUri}),__webpack_require__.d(__webpack_exports__,"pick",function(){return pick}),__webpack_require__.d(__webpack_exports__,"rev",function(){return rev}),__webpack_require__.d(__webpack_exports__,"scopeEval",function(){return scopeEval}),__webpack_require__.d(__webpack_exports__,"toPromise",function(){return toPromise}),__webpack_require__.d(__webpack_exports__,"upsert",function(){return upsert}),__webpack_require__.d(__webpack_exports__,"uuid",function(){return uuid});var argsarray__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(59),argsarray__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(argsarray__WEBPACK_IMPORTED_MODULE_0__),pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(72),immediate__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(60),immediate__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(immediate__WEBPACK_IMPORTED_MODULE_2__);__webpack_require__.d(__webpack_exports__,"nextTick",function(){return immediate__WEBPACK_IMPORTED_MODULE_2___default.a});var events__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(61),inherits__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(62),inherits__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(inherits__WEBPACK_IMPORTED_MODULE_4__),pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(73),uuid__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(64),uuid__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(uuid__WEBPACK_IMPORTED_MODULE_6__),pouchdb_md5__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(74),pouchdb_utils__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(71);function cloneBinaryObject(object){if(object instanceof ArrayBuffer)return function(buff){if("function"==typeof buff.slice)return buff.slice(0);var target=new ArrayBuffer(buff.byteLength),targetArray=new Uint8Array(target),sourceArray=new Uint8Array(buff);return targetArray.set(sourceArray),target}(object);var size=object.size,type=object.type;return"function"==typeof object.slice?object.slice(0,size,type):object.webkitSlice(0,size,type)}var funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object);function clone$1(object){var newObject,i,len;if(!object||"object"!=typeof object)return object;if(Array.isArray(object)){for(newObject=[],i=0,len=object.length;i<len;i++)newObject[i]=clone$1(object[i]);return newObject}if(object instanceof Date)return object.toISOString();if(function(object){return"undefined"!=typeof ArrayBuffer&&object instanceof ArrayBuffer||"undefined"!=typeof Blob&&object instanceof Blob}(object))return cloneBinaryObject(object);if(!function(value){var proto=Object.getPrototypeOf(value);if(null===proto)return!0;var Ctor=proto.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}(object))return object;for(i in newObject={},object)if(Object.prototype.hasOwnProperty.call(object,i)){var value=clone$1(object[i]);void 0!==value&&(newObject[i]=value)}return newObject}function once(fun){var called=!1;return argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){if(called)throw new Error("once called more than once");called=!0,fun.apply(this,args)})}function toPromise(func){return argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){args=clone$1(args);var self=this,usedCB="function"==typeof args[args.length-1]&&args.pop(),promise=new Promise(function(fulfill,reject){var resp;try{var callback=once(function(err,mesg){err?reject(err):fulfill(mesg)});args.push(callback),(resp=func.apply(self,args))&&"function"==typeof resp.then&&fulfill(resp)}catch(e){reject(e)}});return usedCB&&promise.then(function(result){usedCB(null,result)},usedCB),promise})}function adapterFun(name,callback){return toPromise(argsarray__WEBPACK_IMPORTED_MODULE_0___default()(function(args){if(this._closed)return Promise.reject(new Error("database is closed"));if(this._destroyed)return Promise.reject(new Error("database is destroyed"));var self=this;return function(self,name,args){if(self.constructor.listeners("debug").length){for(var logArgs=["api",self.name,name],i=0;i<args.length-1;i++)logArgs.push(args[i]);self.constructor.emit("debug",logArgs);var origCallback=args[args.length-1];args[args.length-1]=function(err,res){var responseArgs=["api",self.name,name];responseArgs=responseArgs.concat(err?["error",err]:["success",res]),self.constructor.emit("debug",responseArgs),origCallback(err,res)}}}(self,name,args),this.taskqueue.isReady?callback.apply(this,args):new Promise(function(fulfill,reject){self.taskqueue.addTask(function(failed){failed?reject(failed):fulfill(self[name].apply(self,args))})})}))}function pick(obj,arr){for(var res={},i=0,len=arr.length;i<len;i++){var prop=arr[i];prop in obj&&(res[prop]=obj[prop])}return res}var hasLocal,MAX_NUM_CONCURRENT_REQUESTS=6;function identityFunction(x){return x}function formatResultForOpenRevsGet(result){return[{ok:result}]}function bulkGet(db,opts,callback){var requests=opts.docs,requestsById=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map;requests.forEach(function(request){requestsById.has(request.id)?requestsById.get(request.id).push(request):requestsById.set(request.id,[request])});var numDocs=requestsById.size,numDone=0,perDocResults=new Array(numDocs);function checkDone(){var results;++numDone===numDocs&&(results=[],perDocResults.forEach(function(res){res.docs.forEach(function(info){results.push({id:res.id,docs:[info]})})}),callback(null,{results:results}))}var allRequests=[];requestsById.forEach(function(value,key){allRequests.push(key)});var i=0;function nextBatch(){if(!(i>=allRequests.length)){var upTo=Math.min(i+MAX_NUM_CONCURRENT_REQUESTS,allRequests.length),batch=allRequests.slice(i,upTo);!function(batch,offset){batch.forEach(function(docId,j){var docIdx=offset+j,docRequests=requestsById.get(docId),docOpts=pick(docRequests[0],["atts_since","attachments"]);docOpts.open_revs=docRequests.map(function(request){return request.rev}),docOpts.open_revs=docOpts.open_revs.filter(identityFunction);var formatResult=identityFunction;0===docOpts.open_revs.length&&(delete docOpts.open_revs,formatResult=formatResultForOpenRevsGet),["revs","attachments","binary","ajax","latest"].forEach(function(param){param in opts&&(docOpts[param]=opts[param])}),db.get(docId,docOpts,function(err,res){var result,id,docs;result=err?[{error:err}]:formatResult(res),id=docId,docs=result,perDocResults[docIdx]={id:id,docs:docs},checkDone(),nextBatch()})})}(batch,i),i+=batch.length}}nextBatch()}try{localStorage.setItem("_pouch_check_localstorage",1),hasLocal=!!localStorage.getItem("_pouch_check_localstorage")}catch(e){hasLocal=!1}function hasLocalStorage(){return hasLocal}function Changes(){var self;events__WEBPACK_IMPORTED_MODULE_3__.EventEmitter.call(this),this._listeners={},self=this,hasLocalStorage()&&addEventListener("storage",function(e){self.emit(e.key)})}function guardedConsole(method){if("undefined"!=typeof console&&"function"==typeof console[method]){var args=Array.prototype.slice.call(arguments,1);console[method].apply(console,args)}}function defaultBackOff(min){var max=0;return min||(max=2e3),function(min,max){return min=parseInt(min,10)||0,(max=parseInt(max,10))!=max||max<=min?max=(min||1)<<1:max+=1,max>6e5&&(min=3e5,max=6e5),~~((max-min)*Math.random()+min)}(min,max)}function explainError(status,str){guardedConsole("info","The above "+status+" is totally normal. "+str)}inherits__WEBPACK_IMPORTED_MODULE_4___default()(Changes,events__WEBPACK_IMPORTED_MODULE_3__.EventEmitter),Changes.prototype.addListener=function(dbName,id,db,opts){if(!this._listeners[id]){var self=this,inprogress=!1;this._listeners[id]=eventFunction,this.on(dbName,eventFunction)}function eventFunction(){if(self._listeners[id])if(inprogress)inprogress="waiting";else{inprogress=!0;var changesOpts=pick(opts,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);db.changes(changesOpts).on("change",function(c){c.seq>opts.since&&!opts.cancelled&&(opts.since=c.seq,opts.onChange(c))}).on("complete",function(){"waiting"===inprogress&&immediate__WEBPACK_IMPORTED_MODULE_2___default()(eventFunction),inprogress=!1}).on("error",function(){inprogress=!1})}}},Changes.prototype.removeListener=function(dbName,id){id in this._listeners&&(events__WEBPACK_IMPORTED_MODULE_3__.EventEmitter.prototype.removeListener.call(this,dbName,this._listeners[id]),delete this._listeners[id])},Changes.prototype.notifyLocalWindows=function(dbName){hasLocalStorage()&&(localStorage[dbName]="a"===localStorage[dbName]?"b":"a")},Changes.prototype.notify=function(dbName){this.emit(dbName),this.notifyLocalWindows(dbName)};var assign$1="function"==typeof Object.assign?Object.assign:function(target){for(var to=Object(target),index=1;index<arguments.length;index++){var nextSource=arguments[index];if(null!=nextSource)for(var nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey])}return to};function filterChange(opts){var req={},hasFilter=opts.filter&&"function"==typeof opts.filter;return req.query=opts.query_params,function(change){change.doc||(change.doc={});var filterReturn=hasFilter&&function(filter,doc,req){try{return!filter(doc,req)}catch(err){var msg="Filter function threw: "+err.toString();return Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.BAD_REQUEST,msg)}}(opts.filter,change.doc,req);if("object"==typeof filterReturn)return filterReturn;if(filterReturn)return!1;if(opts.include_docs){if(!opts.attachments)for(var att in change.doc._attachments)change.doc._attachments.hasOwnProperty(att)&&(change.doc._attachments[att].stub=!0)}else delete change.doc;return!0}}function flatten(arrs){for(var res=[],i=0,len=arrs.length;i<len;i++)res=res.concat(arrs[i]);return res}var res$1=function(){}.name?function(fun){return fun.name}:function(fun){var match=fun.toString().match(/^\s*function\s*(?:(\S+)\s*)?\(/);return match&&match[1]?match[1]:""};function invalidIdError(id){var err;if(id?"string"!=typeof id?err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.INVALID_ID):/^_/.test(id)&&!/^_(design|local)/.test(id)&&(err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.RESERVED_ID)):err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_5__.MISSING_ID),err)throw err}function isRemote(db){return"boolean"==typeof db._remote?db._remote:"function"==typeof db.type&&(guardedConsole("warn","db.type() is deprecated and will be removed in a future version of PouchDB"),"http"===db.type())}function listenerCount(ee,type){return"listenerCount"in ee?ee.listenerCount(type):events__WEBPACK_IMPORTED_MODULE_3__.EventEmitter.listenerCount(ee,type)}function parseDesignDocFunctionName(s){if(!s)return null;var parts=s.split("/");return 2===parts.length?parts:1===parts.length?[s,s]:null}function normalizeDesignDocFunctionName(s){var normalized=parseDesignDocFunctionName(s);return normalized?normalized.join("/"):null}var keys=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],qName="queryKey",qParser=/(?:^|&)([^&=]*)=?([^&]*)/g,parser=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;function parseUri(str){for(var m=parser.exec(str),uri={},i=14;i--;){var key=keys[i],value=m[i]||"",encoded=-1!==["user","password"].indexOf(key);uri[key]=encoded?decodeURIComponent(value):value}return uri[qName]={},uri[keys[12]].replace(qParser,function($0,$1,$2){$1&&(uri[qName][$1]=$2)}),uri}function scopeEval(source,scope){var keys=[],values=[];for(var key in scope)scope.hasOwnProperty(key)&&(keys.push(key),values.push(scope[key]));return keys.push(source),Function.apply(null,keys).apply(null,values)}function upsert(db,docId,diffFun){return new Promise(function(fulfill,reject){db.get(docId,function(err,doc){if(err){if(404!==err.status)return reject(err);doc={}}var docRev=doc._rev,newDoc=diffFun(doc);if(!newDoc)return fulfill({updated:!1,rev:docRev});newDoc._id=docId,newDoc._rev=docRev,fulfill(function(db,doc,diffFun){return db.put(doc).then(function(res){return{updated:!0,rev:res.rev}},function(err){if(409!==err.status)throw err;return upsert(db,doc._id,diffFun)})}(db,newDoc,diffFun))})})}function rev(doc,deterministic_revs){var clonedDoc=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_8__.clone)(doc);return deterministic_revs?(delete clonedDoc._rev_tree,Object(pouchdb_md5__WEBPACK_IMPORTED_MODULE_7__.stringMd5)(JSON.stringify(clonedDoc))):uuid__WEBPACK_IMPORTED_MODULE_6___default.a.v4().replace(/-/g,"").toLowerCase()}var uuid=uuid__WEBPACK_IMPORTED_MODULE_6___default.a.v4},function(module,__webpack_exports__,__webpack_require__){"use strict";function mangle(key){return"$"+key}function unmangle(key){return key.substring(1)}function Map$1(){this._store={}}function Set$1(array){if(this._store=new Map$1,array&&Array.isArray(array))for(var i=0,len=array.length;i<len;i++)this.add(array[i])}var ExportedSet,ExportedMap;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Set",function(){return ExportedSet}),__webpack_require__.d(__webpack_exports__,"Map",function(){return ExportedMap}),Map$1.prototype.get=function(key){var mangled=mangle(key);return this._store[mangled]},Map$1.prototype.set=function(key,value){var mangled=mangle(key);return this._store[mangled]=value,!0},Map$1.prototype.has=function(key){return mangle(key)in this._store},Map$1.prototype.delete=function(key){var mangled=mangle(key),res=mangled in this._store;return delete this._store[mangled],res},Map$1.prototype.forEach=function(cb){for(var keys=Object.keys(this._store),i=0,len=keys.length;i<len;i++){var key=keys[i];cb(this._store[key],key=unmangle(key))}},Object.defineProperty(Map$1.prototype,"size",{get:function(){return Object.keys(this._store).length}}),Set$1.prototype.add=function(key){return this._store.set(key,!0)},Set$1.prototype.has=function(key){return this._store.has(key)},Set$1.prototype.forEach=function(cb){this._store.forEach(function(value,key){cb(key)})},Object.defineProperty(Set$1.prototype,"size",{get:function(){return this._store.size}}),!function(){if("undefined"==typeof Symbol||"undefined"==typeof Map||"undefined"==typeof Set)return!1;var prop=Object.getOwnPropertyDescriptor(Map,Symbol.species);return prop&&"get"in prop&&Map[Symbol.species]===Map}()?(ExportedSet=Set$1,ExportedMap=Map$1):(ExportedSet=Set,ExportedMap=Map)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"UNAUTHORIZED",function(){return UNAUTHORIZED}),__webpack_require__.d(__webpack_exports__,"MISSING_BULK_DOCS",function(){return MISSING_BULK_DOCS}),__webpack_require__.d(__webpack_exports__,"MISSING_DOC",function(){return MISSING_DOC}),__webpack_require__.d(__webpack_exports__,"REV_CONFLICT",function(){return REV_CONFLICT}),__webpack_require__.d(__webpack_exports__,"INVALID_ID",function(){return INVALID_ID}),__webpack_require__.d(__webpack_exports__,"MISSING_ID",function(){return MISSING_ID}),__webpack_require__.d(__webpack_exports__,"RESERVED_ID",function(){return RESERVED_ID}),__webpack_require__.d(__webpack_exports__,"NOT_OPEN",function(){return NOT_OPEN}),__webpack_require__.d(__webpack_exports__,"UNKNOWN_ERROR",function(){return UNKNOWN_ERROR}),__webpack_require__.d(__webpack_exports__,"BAD_ARG",function(){return BAD_ARG}),__webpack_require__.d(__webpack_exports__,"INVALID_REQUEST",function(){return INVALID_REQUEST}),__webpack_require__.d(__webpack_exports__,"QUERY_PARSE_ERROR",function(){return QUERY_PARSE_ERROR}),__webpack_require__.d(__webpack_exports__,"DOC_VALIDATION",function(){return DOC_VALIDATION}),__webpack_require__.d(__webpack_exports__,"BAD_REQUEST",function(){return BAD_REQUEST}),__webpack_require__.d(__webpack_exports__,"NOT_AN_OBJECT",function(){return NOT_AN_OBJECT}),__webpack_require__.d(__webpack_exports__,"DB_MISSING",function(){return DB_MISSING}),__webpack_require__.d(__webpack_exports__,"WSQ_ERROR",function(){return WSQ_ERROR}),__webpack_require__.d(__webpack_exports__,"LDB_ERROR",function(){return LDB_ERROR}),__webpack_require__.d(__webpack_exports__,"FORBIDDEN",function(){return FORBIDDEN}),__webpack_require__.d(__webpack_exports__,"INVALID_REV",function(){return INVALID_REV}),__webpack_require__.d(__webpack_exports__,"FILE_EXISTS",function(){return FILE_EXISTS}),__webpack_require__.d(__webpack_exports__,"MISSING_STUB",function(){return MISSING_STUB}),__webpack_require__.d(__webpack_exports__,"IDB_ERROR",function(){return IDB_ERROR}),__webpack_require__.d(__webpack_exports__,"INVALID_URL",function(){return INVALID_URL}),__webpack_require__.d(__webpack_exports__,"createError",function(){return createError}),__webpack_require__.d(__webpack_exports__,"generateErrorFromResponse",function(){return generateErrorFromResponse});var inherits__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(62);function PouchError(status,error,reason){Error.call(this,reason),this.status=status,this.name=error,this.message=reason,this.error=!0}__webpack_require__.n(inherits__WEBPACK_IMPORTED_MODULE_0__)()(PouchError,Error),PouchError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};var UNAUTHORIZED=new PouchError(401,"unauthorized","Name or password is incorrect."),MISSING_BULK_DOCS=new PouchError(400,"bad_request","Missing JSON list of 'docs'"),MISSING_DOC=new PouchError(404,"not_found","missing"),REV_CONFLICT=new PouchError(409,"conflict","Document update conflict"),INVALID_ID=new PouchError(400,"bad_request","_id field must contain a string"),MISSING_ID=new PouchError(412,"missing_id","_id is required for puts"),RESERVED_ID=new PouchError(400,"bad_request","Only reserved document ids may start with underscore."),NOT_OPEN=new PouchError(412,"precondition_failed","Database not open"),UNKNOWN_ERROR=new PouchError(500,"unknown_error","Database encountered an unknown error"),BAD_ARG=new PouchError(500,"badarg","Some query argument is invalid"),INVALID_REQUEST=new PouchError(400,"invalid_request","Request was invalid"),QUERY_PARSE_ERROR=new PouchError(400,"query_parse_error","Some query parameter is invalid"),DOC_VALIDATION=new PouchError(500,"doc_validation","Bad special document member"),BAD_REQUEST=new PouchError(400,"bad_request","Something wrong with the request"),NOT_AN_OBJECT=new PouchError(400,"bad_request","Document must be a JSON object"),DB_MISSING=new PouchError(404,"not_found","Database not found"),IDB_ERROR=new PouchError(500,"indexed_db_went_bad","unknown"),WSQ_ERROR=new PouchError(500,"web_sql_went_bad","unknown"),LDB_ERROR=new PouchError(500,"levelDB_went_went_bad","unknown"),FORBIDDEN=new PouchError(403,"forbidden","Forbidden by design doc validate_doc_update function"),INVALID_REV=new PouchError(400,"bad_request","Invalid rev format"),FILE_EXISTS=new PouchError(412,"file_exists","The database could not be created, the file already exists."),MISSING_STUB=new PouchError(412,"missing_stub","A pre-existing attachment stub wasn't found"),INVALID_URL=new PouchError(413,"invalid_url","Provided URL is invalid");function createError(error,reason){function CustomPouchError(reason){for(var p in error)"function"!=typeof error[p]&&(this[p]=error[p]);void 0!==reason&&(this.reason=reason)}return CustomPouchError.prototype=PouchError.prototype,new CustomPouchError(reason)}function generateErrorFromResponse(err){if("object"!=typeof err){var data=err;(err=UNKNOWN_ERROR).data=data}return"error"in err&&"conflict"===err.error&&(err.name="conflict",err.status=409),"name"in err||(err.name=err.error||"unknown"),"status"in err||(err.status=500),"message"in err||(err.message=err.message||err.reason),err}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(global){__webpack_require__.d(__webpack_exports__,"binaryMd5",function(){return binaryMd5}),__webpack_require__.d(__webpack_exports__,"stringMd5",function(){return stringMd5});var pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(75),spark_md5__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(63),spark_md5__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(spark_md5__WEBPACK_IMPORTED_MODULE_1__),setImmediateShim=global.setImmediate||global.setTimeout,MD5_CHUNK_SIZE=32768;function appendBlob(buffer,blob,start,end,callback){(start>0||end<blob.size)&&(blob=function(blob,start,end){return blob.webkitSlice?blob.webkitSlice(start,end):blob.slice(start,end)}(blob,start,end)),Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.readAsArrayBuffer)(blob,function(arrayBuffer){buffer.append(arrayBuffer),callback()})}function appendString(buffer,string,start,end,callback){(start>0||end<string.length)&&(string=string.substring(start,end)),buffer.appendBinary(string),callback()}function binaryMd5(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new spark_md5__WEBPACK_IMPORTED_MODULE_1___default.a:new spark_md5__WEBPACK_IMPORTED_MODULE_1___default.a.ArrayBuffer,append=inputIsString?appendString:appendBlob;function next(){setImmediateShim(loadNextChunk)}function done(){var base64=function(raw){return Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.btoa)(raw)}(buffer.end(!0));callback(base64),buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;append(buffer,data,start,end,++currentChunk<chunks?next:done)}loadNextChunk()}function stringMd5(string){return spark_md5__WEBPACK_IMPORTED_MODULE_1___default.a.hash(string)}}.call(this,__webpack_require__(2))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"atob",function(){return thisAtob}),__webpack_require__.d(__webpack_exports__,"btoa",function(){return thisBtoa}),__webpack_require__.d(__webpack_exports__,"base64StringToBlobOrBuffer",function(){return b64ToBluffer}),__webpack_require__.d(__webpack_exports__,"binaryStringToArrayBuffer",function(){return binaryStringToArrayBuffer}),__webpack_require__.d(__webpack_exports__,"binaryStringToBlobOrBuffer",function(){return binStringToBluffer}),__webpack_require__.d(__webpack_exports__,"blob",function(){return createBlob}),__webpack_require__.d(__webpack_exports__,"blobOrBufferToBase64",function(){return blobToBase64}),__webpack_require__.d(__webpack_exports__,"blobOrBufferToBinaryString",function(){return blobToBinaryString}),__webpack_require__.d(__webpack_exports__,"readAsArrayBuffer",function(){return readAsArrayBuffer}),__webpack_require__.d(__webpack_exports__,"readAsBinaryString",function(){return readAsBinaryString}),__webpack_require__.d(__webpack_exports__,"typedBuffer",function(){return typedBuffer});var thisAtob=function(str){return atob(str)},thisBtoa=function(str){return btoa(str)};function createBlob(parts,properties){parts=parts||[],properties=properties||{};try{return new Blob(parts,properties)}catch(e){if("TypeError"!==e.name)throw e;for(var builder=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<parts.length;i+=1)builder.append(parts[i]);return builder.getBlob(properties.type)}}function binaryStringToArrayBuffer(bin){for(var length=bin.length,buf=new ArrayBuffer(length),arr=new Uint8Array(buf),i=0;i<length;i++)arr[i]=bin.charCodeAt(i);return buf}function binStringToBluffer(binString,type){return createBlob([binaryStringToArrayBuffer(binString)],{type:type})}function b64ToBluffer(b64,type){return binStringToBluffer(thisAtob(b64),type)}function readAsBinaryString(blob,callback){var reader=new FileReader,hasBinaryString="function"==typeof reader.readAsBinaryString;reader.onloadend=function(e){var result=e.target.result||"";if(hasBinaryString)return callback(result);callback(function(buffer){for(var binary="",bytes=new Uint8Array(buffer),length=bytes.byteLength,i=0;i<length;i++)binary+=String.fromCharCode(bytes[i]);return binary}(result))},hasBinaryString?reader.readAsBinaryString(blob):reader.readAsArrayBuffer(blob)}function blobToBinaryString(blobOrBuffer,callback){readAsBinaryString(blobOrBuffer,function(bin){callback(bin)})}function blobToBase64(blobOrBuffer,callback){blobToBinaryString(blobOrBuffer,function(base64){callback(thisBtoa(base64))})}function readAsArrayBuffer(blob,callback){var reader=new FileReader;reader.onloadend=function(e){var result=e.target.result||new ArrayBuffer(0);callback(result)},reader.readAsArrayBuffer(blob)}function typedBuffer(){}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(75),pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(72),pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(71),levelup__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(77),levelup__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(levelup__WEBPACK_IMPORTED_MODULE_3__),sublevel_pouchdb__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(116),through2__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(132),argsarray__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(59),argsarray__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(argsarray__WEBPACK_IMPORTED_MODULE_6__),double_ended_queue__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(133),double_ended_queue__WEBPACK_IMPORTED_MODULE_7___default=__webpack_require__.n(double_ended_queue__WEBPACK_IMPORTED_MODULE_7__),buffer_from__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(134),buffer_from__WEBPACK_IMPORTED_MODULE_8___default=__webpack_require__.n(buffer_from__WEBPACK_IMPORTED_MODULE_8__),pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(135),pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(136),pouchdb_json__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(137),pouchdb_md5__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(74),pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(73);function readAsBlobOrBuffer(storedObject,type){var byteArray=new Uint8Array(storedObject);return Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.blob)([byteArray],{type:type})}function getCacheFor(transaction,store){var prefix=store.prefix()[0],cache=transaction._cache,subCache=cache.get(prefix);return subCache||(subCache=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,cache.set(prefix,subCache)),subCache}function LevelTransaction(){this._batch=[],this._cache=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map}LevelTransaction.prototype.get=function(store,key,callback){var cache=getCacheFor(this,store),exists=cache.get(key);return exists?Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback(null,exists)}):null===exists?Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback({name:"NotFoundError"})}):void store.get(key,function(err,res){if(err)return"NotFoundError"===err.name&&cache.set(key,null),callback(err);cache.set(key,res),callback(null,res)})},LevelTransaction.prototype.batch=function(batch){for(var i=0,len=batch.length;i<len;i++){var operation=batch[i],cache=getCacheFor(this,operation.prefix);"put"===operation.type?cache.set(operation.key,operation.value):cache.set(operation.key,null)}this._batch=this._batch.concat(batch)},LevelTransaction.prototype.execute=function(db,callback){for(var keys=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Set,uniqBatches=[],i=this._batch.length-1;i>=0;i--){var operation=this._batch[i],lookupKey=operation.prefix.prefix()[0]+"ÿ"+operation.key;keys.has(lookupKey)||(keys.add(lookupKey),uniqBatches.push(operation))}db.batch(uniqBatches,callback)};var DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACHMENT_STORE="attach-store",BINARY_STORE="attach-binary-store",LOCAL_STORE="local-store",META_STORE="meta-store",dbStores=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,UPDATE_SEQ_KEY="_local_last_update_seq",DOC_COUNT_KEY="_local_doc_count",UUID_KEY="_local_uuid",MD5_PREFIX="md5-",safeJsonEncoding={encode:pouchdb_json__WEBPACK_IMPORTED_MODULE_11__.safeJsonStringify,decode:pouchdb_json__WEBPACK_IMPORTED_MODULE_11__.safeJsonParse,buffer:!1,type:"cheap-json"},levelChanges=new pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.changesHandler;function getWinningRev(metadata){return"winningRev"in metadata?metadata.winningRev:Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__.winningRev)(metadata)}function getIsDeleted(metadata,winningRev$$1){return"deleted"in metadata?metadata.deleted:Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.isDeleted)(metadata,winningRev$$1)}function fetchAttachments(results,stores,opts){var atts=[];return results.forEach(function(row){row.doc&&row.doc._attachments&&Object.keys(row.doc._attachments).forEach(function(attName){var att=row.doc._attachments[attName];"data"in att||atts.push(att)})}),Promise.all(atts.map(function(att){return function(att,stores,opts){var type=att.content_type;return new Promise(function(resolve,reject){stores.binaryStore.get(att.digest,function(err,buffer){var data;if(err){if("NotFoundError"!==err.name)return reject(err);data=opts.binary?Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.binaryStringToBlobOrBuffer)("",type):""}else data=opts.binary?readAsBlobOrBuffer(buffer,type):buffer.toString("base64");delete att.stub,delete att.length,att.data=data,resolve()})})}(att,stores,opts)}))}__webpack_exports__.default=function(opts,callback){opts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.clone)(opts);var instanceId,db,api=this,stores={},revLimit=opts.revs_limit,name=opts.name;void 0===opts.createIfMissing&&(opts.createIfMissing=!0);var dbStore,leveldown=opts.db,leveldownName=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.functionName)(leveldown);function afterDBCreated(){stores.docStore=db.sublevel(DOC_STORE,{valueEncoding:safeJsonEncoding}),stores.bySeqStore=db.sublevel(BY_SEQ_STORE,{valueEncoding:"json"}),stores.attachmentStore=db.sublevel(ATTACHMENT_STORE,{valueEncoding:"json"}),stores.binaryStore=db.sublevel(BINARY_STORE,{valueEncoding:"binary"}),stores.localStore=db.sublevel(LOCAL_STORE,{valueEncoding:"json"}),stores.metaStore=db.sublevel(META_STORE,{valueEncoding:"json"}),"object"==typeof opts.migrate?opts.migrate.doMigrationTwo(db,stores,afterLastMigration):afterLastMigration()}function afterLastMigration(){stores.metaStore.get(UPDATE_SEQ_KEY,function(err,value){void 0===db._updateSeq&&(db._updateSeq=value||0),stores.metaStore.get(DOC_COUNT_KEY,function(err,value){db._docCount=err?0:value,stores.metaStore.get(UUID_KEY,function(err,value){instanceId=err?Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.uuid)():value,stores.metaStore.put(UUID_KEY,instanceId,function(){Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback(null,api)})})})})})}function tryCode(fun,args){try{fun.apply(null,args)}catch(err){args[args.length-1](err)}}function executeNext(){var firstTask=db._queue.peekFront();"read"===firstTask.type?function(firstTask){for(var readTasks=[firstTask],i=1,nextTask=db._queue.get(i);void 0!==nextTask&&"read"===nextTask.type;)readTasks.push(nextTask),i++,nextTask=db._queue.get(i);var numDone=0;readTasks.forEach(function(readTask){var args=readTask.args,callback=args[args.length-1];args[args.length-1]=argsarray__WEBPACK_IMPORTED_MODULE_6___default()(function(cbArgs){callback.apply(null,cbArgs),++numDone===readTasks.length&&Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){readTasks.forEach(function(){db._queue.shift()}),db._queue.length&&executeNext()})}),tryCode(readTask.fun,args)})}(firstTask):function(firstTask){var args=firstTask.args,callback=args[args.length-1];args[args.length-1]=argsarray__WEBPACK_IMPORTED_MODULE_6___default()(function(cbArgs){callback.apply(null,cbArgs),Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){db._queue.shift(),db._queue.length&&executeNext()})}),tryCode(firstTask.fun,args)}(firstTask)}function writeLock(fun){return argsarray__WEBPACK_IMPORTED_MODULE_6___default()(function(args){db._queue.push({fun:fun,args:args,type:"write"}),1===db._queue.length&&Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(executeNext)})}function readLock(fun){return argsarray__WEBPACK_IMPORTED_MODULE_6___default()(function(args){db._queue.push({fun:fun,args:args,type:"read"}),1===db._queue.length&&Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(executeNext)})}function formatSeq(n){return("0000000000000000"+n).slice(-16)}function callDestroy(name,cb){"destroy"in leveldown&&leveldown.destroy(name,cb)}dbStores.has(leveldownName)?dbStore=dbStores.get(leveldownName):(dbStore=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,dbStores.set(leveldownName,dbStore)),dbStore.has(name)?(db=dbStore.get(name),afterDBCreated()):dbStore.set(name,Object(sublevel_pouchdb__WEBPACK_IMPORTED_MODULE_4__.default)(levelup__WEBPACK_IMPORTED_MODULE_3___default()(leveldown(name),opts,function(err){if(err)return dbStore.delete(name),callback(err);(db=dbStore.get(name))._docCount=-1,db._queue=new double_ended_queue__WEBPACK_IMPORTED_MODULE_7___default.a,"object"==typeof opts.migrate?opts.migrate.doMigrationOne(name,db,afterDBCreated):afterDBCreated()}))),api._remote=!1,api.type=function(){return"leveldb"},api._id=function(callback){callback(null,instanceId)},api._info=function(callback){var res={doc_count:db._docCount,update_seq:db._updateSeq,backend_adapter:Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.functionName)(leveldown)};return Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback(null,res)})},api._get=readLock(function(id,opts,callback){opts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.clone)(opts),stores.docStore.get(id,function(err,metadata){if(err||!metadata)return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC,"missing"));var rev;if(opts.rev)rev=opts.latest?Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__.latest)(opts.rev,metadata):opts.rev;else if(rev=getWinningRev(metadata),getIsDeleted(metadata,rev))return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC,"deleted"));var seq=metadata.rev_map[rev];stores.bySeqStore.get(formatSeq(seq),function(err,doc){if(!doc)return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC));if("_id"in doc&&doc._id!==metadata.id)return callback(new Error("wrong doc returned"));if(doc._id=metadata.id,"_rev"in doc){if(doc._rev!==rev)return callback(new Error("wrong doc returned"))}else doc._rev=rev;return callback(null,{doc:doc,metadata:metadata})})})}),api._getAttachment=function(docId,attachId,attachment,opts,callback){var digest=attachment.digest,type=attachment.content_type;stores.binaryStore.get(digest,function(err,attach){if(err)return"NotFoundError"!==err.name?callback(err):callback(null,opts.binary?function(type){return Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.blob)([""],{type:type})}(type):"");opts.binary?callback(null,readAsBlobOrBuffer(attach,type)):callback(null,attach.toString("base64"))})},api._bulkDocs=writeLock(function(req,opts,callback){var newEdits=opts.new_edits,results=new Array(req.docs.length),fetchedDocs=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,stemmedRevs=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,txn=new LevelTransaction,docCountDelta=0,newUpdateSeq=db._updateSeq,userDocs=req.docs,docInfos=userDocs.map(function(doc){if(doc._id&&Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.isLocalId)(doc._id))return doc;var newDoc=Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.parseDoc)(doc,newEdits,api.__opts);return newDoc.metadata&&!newDoc.metadata.rev_map&&(newDoc.metadata.rev_map={}),newDoc}),infoErrors=docInfos.filter(function(doc){return doc.error});if(infoErrors.length)return callback(infoErrors[0]);function compact(revsMap,callback){var promise=Promise.resolve();revsMap.forEach(function(revs,docId){promise=promise.then(function(){return new Promise(function(resolve,reject){api._doCompactionNoLock(docId,revs,{ctx:txn},function(err){if(err)return reject(err);resolve()})})})}),promise.then(function(){callback()},callback)}function finish(){compact(stemmedRevs,function(error){if(error&&complete(error),api.auto_compaction)return callback=complete,revsMap=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map,fetchedDocs.forEach(function(metadata,docId){revsMap.set(docId,Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__.compactTree)(metadata))}),void compact(revsMap,callback);var callback,revsMap;complete()})}function writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRevIsDeleted,isUpdate,delta,resultsIdx,callback2){docCountDelta+=delta;var err=null,recv=0;docInfo.metadata.winningRev=winningRev$$1,docInfo.metadata.deleted=winningRevIsDeleted,docInfo.data._id=docInfo.metadata.id,docInfo.data._rev=docInfo.metadata.rev,newRevIsDeleted&&(docInfo.data._deleted=!0),docInfo.stemmedRevs.length&&stemmedRevs.set(docInfo.metadata.id,docInfo.stemmedRevs);var attData,cb,attachments=docInfo.data._attachments?Object.keys(docInfo.data._attachments):[];function attachmentSaved(attachmentErr){recv++,err||(attachmentErr?callback2(err=attachmentErr):recv===attachments.length&&finish())}function onMD5Load(doc,key,data,attachmentSaved){return function(result){!function(docInfo,digest,key,data,callback){var att=docInfo.data._attachments[key];delete att.data,att.digest=digest,att.length=data.length;var id=docInfo.metadata.id,rev=docInfo.metadata.rev;att.revpos=parseInt(rev,10),saveAttachmentRefs(id,rev,digest,function(err,isNewAttachment){return err?callback(err):0===data.length?callback(err):isNewAttachment?(txn.batch([{type:"put",prefix:stores.binaryStore,key:digest,value:buffer_from__WEBPACK_IMPORTED_MODULE_8___default()(data,"binary")}]),void callback()):callback(err)})}(doc,MD5_PREFIX+result,key,data,attachmentSaved)}}function doMD5(doc,key,attachmentSaved){return function(data){Object(pouchdb_md5__WEBPACK_IMPORTED_MODULE_12__.binaryMd5)(data,onMD5Load(doc,key,data,attachmentSaved))}}for(var i=0;i<attachments.length;i++){var data,key=attachments[i],att=docInfo.data._attachments[key];if(att.stub)saveAttachmentRefs(docInfo.data._id,docInfo.data._rev,att.digest,attachmentSaved);else if("string"==typeof att.data){try{data=Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.atob)(att.data)}catch(e){return void callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.BAD_ARG,"Attachment is not a valid base64 string"))}doMD5(docInfo,key,attachmentSaved)(data)}else attData=att.data,cb=doMD5(docInfo,key,attachmentSaved),Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_0__.readAsBinaryString)(attData,cb)}function finish(){var seq=docInfo.metadata.rev_map[docInfo.metadata.rev];if(seq)return callback2();seq=++newUpdateSeq,docInfo.metadata.rev_map[docInfo.metadata.rev]=docInfo.metadata.seq=seq;var batch=[{key:formatSeq(seq),value:docInfo.data,prefix:stores.bySeqStore,type:"put"},{key:docInfo.metadata.id,value:docInfo.metadata,prefix:stores.docStore,type:"put"}];txn.batch(batch),results[resultsIdx]={ok:!0,id:docInfo.metadata.id,rev:docInfo.metadata.rev},fetchedDocs.set(docInfo.metadata.id,docInfo.metadata),callback2()}attachments.length||finish()}var attachmentQueues={};function saveAttachmentRefs(id,rev,digest,callback){function saveAtt(oldAtt){var ref=[id,rev].join("@"),newAtt={};return oldAtt?oldAtt.refs&&(newAtt.refs=oldAtt.refs,newAtt.refs[ref]=!0):(newAtt.refs={},newAtt.refs[ref]=!0),new Promise(function(resolve){txn.batch([{type:"put",prefix:stores.attachmentStore,key:digest,value:newAtt}]),resolve(!oldAtt)})}var queue=attachmentQueues[digest]||Promise.resolve();attachmentQueues[digest]=queue.then(function(){return new Promise(function(resolve,reject){txn.get(stores.attachmentStore,digest,function(err,oldAtt){if(err&&"NotFoundError"!==err.name)return reject(err);resolve(oldAtt)})}).then(saveAtt).then(function(isNewAttachment){callback(null,isNewAttachment)},callback)})}function complete(err){if(err)return Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback(err)});txn.batch([{prefix:stores.metaStore,type:"put",key:UPDATE_SEQ_KEY,value:newUpdateSeq},{prefix:stores.metaStore,type:"put",key:DOC_COUNT_KEY,value:db._docCount+docCountDelta}]),txn.execute(db,function(err){if(err)return callback(err);db._docCount+=docCountDelta,db._updateSeq=newUpdateSeq,levelChanges.notify(name),Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.nextTick)(function(){callback(null,results)})})}if(!docInfos.length)return callback(null,[]);!function(finish){var digests=[];if(userDocs.forEach(function(doc){doc&&doc._attachments&&Object.keys(doc._attachments).forEach(function(filename){var att=doc._attachments[filename];att.stub&&digests.push(att.digest)})}),!digests.length)return finish();var err,numDone=0;digests.forEach(function(digest){!function(digest,callback){txn.get(stores.attachmentStore,digest,function(levelErr){if(levelErr){var err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_STUB,"unknown stub attachment with digest "+digest);callback(err)}else callback()})}(digest,function(attErr){attErr&&!err&&(err=attErr),++numDone===digests.length&&finish(err)})})}(function(err){if(err)return callback(err);!function(finish){var overallErr,numDone=0;function checkDone(){if(++numDone===userDocs.length)return finish(overallErr)}userDocs.forEach(function(doc){if(doc._id&&Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.isLocalId)(doc._id))return checkDone();txn.get(stores.docStore,doc._id,function(err,info){err?"NotFoundError"!==err.name&&(overallErr=err):fetchedDocs.set(doc._id,info),checkDone()})})}(function(err){if(err)return callback(err);Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.processDocs)(revLimit,docInfos,api,fetchedDocs,txn,results,writeDoc,opts,finish)})})}),api._allDocs=function(opts,callback){return"keys"in opts?Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.allDocsKeysQuery)(this,opts):readLock(function(opts,callback){opts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.clone)(opts),function(callback){db.isClosed()?callback(new Error("database is closed")):callback(null,db._docCount)}(function(err,docCount){if(err)return callback(err);var limit,readstreamOpts={},skip=opts.skip||0;if(opts.startkey&&(readstreamOpts.gte=opts.startkey),opts.endkey&&(readstreamOpts.lte=opts.endkey),opts.key&&(readstreamOpts.gte=readstreamOpts.lte=opts.key),opts.descending){readstreamOpts.reverse=!0;var tmp=readstreamOpts.lte;readstreamOpts.lte=readstreamOpts.gte,readstreamOpts.gte=tmp}if("number"==typeof opts.limit&&(limit=opts.limit),0===limit||"gte"in readstreamOpts&&"lte"in readstreamOpts&&readstreamOpts.gte>readstreamOpts.lte){var returnVal={total_rows:docCount,offset:opts.skip,rows:[]};return opts.update_seq&&(returnVal.update_seq=db._updateSeq),callback(null,returnVal)}var results=[],docstream=stores.docStore.readStream(readstreamOpts),throughStream=Object(through2__WEBPACK_IMPORTED_MODULE_5__.obj)(function(entry,_,next){var metadata=entry.value,winningRev$$1=getWinningRev(metadata),deleted=getIsDeleted(metadata,winningRev$$1);if(deleted){if("ok"!==opts.deleted)return void next()}else{if(skip-- >0)return void next();if("number"==typeof limit&&limit--<=0)return docstream.unpipe(),docstream.destroy(),void next()}function allDocsInner(data){var doc={id:metadata.id,key:metadata.id,value:{rev:winningRev$$1}};if(opts.include_docs){if(doc.doc=data,doc.doc._rev=doc.value.rev,opts.conflicts){var conflicts=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__.collectConflicts)(metadata);conflicts.length&&(doc.doc._conflicts=conflicts)}for(var att in doc.doc._attachments)doc.doc._attachments.hasOwnProperty(att)&&(doc.doc._attachments[att].stub=!0)}if(!1===opts.inclusive_end&&metadata.id===opts.endkey)return next();if(deleted){if("ok"!==opts.deleted)return next();doc.value.deleted=!0,doc.doc=null}results.push(doc),next()}if(opts.include_docs){var seq=metadata.rev_map[winningRev$$1];stores.bySeqStore.get(formatSeq(seq),function(err,data){allDocsInner(data)})}else allDocsInner()},function(next){Promise.resolve().then(function(){if(opts.include_docs&&opts.attachments)return fetchAttachments(results,stores,opts)}).then(function(){var returnVal={total_rows:docCount,offset:opts.skip,rows:results};opts.update_seq&&(returnVal.update_seq=db._updateSeq),callback(null,returnVal)},callback),next()}).on("unpipe",function(){throughStream.end()});docstream.on("error",callback),docstream.pipe(throughStream)})})(opts,callback)},api._changes=function(opts){if((opts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.clone)(opts)).continuous){var id=name+":"+Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.uuid)();return levelChanges.addListener(name,id,api,opts),levelChanges.notify(name),{cancel:function(){levelChanges.removeListener(name,id)}}}var limit,descending=opts.descending,results=[],lastSeq=opts.since||0,called=0,streamOpts={reverse:descending};"limit"in opts&&opts.limit>0&&(limit=opts.limit),streamOpts.reverse||(streamOpts.start=formatSeq(opts.since||0));var docIds=opts.doc_ids&&new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Set(opts.doc_ids),filter=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.filterChange)(opts),docIdsToMetadata=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map;function complete(){opts.done=!0,opts.return_docs&&opts.limit&&opts.limit<results.length&&(results.length=opts.limit),changeStream.unpipe(throughStream),changeStream.destroy(),opts.continuous||opts.cancelled||(opts.include_docs&&opts.attachments&&opts.return_docs?fetchAttachments(results,stores,opts).then(function(){opts.complete(null,{results:results,last_seq:lastSeq})}):opts.complete(null,{results:results,last_seq:lastSeq}))}var changeStream=stores.bySeqStore.readStream(streamOpts),throughStream=Object(through2__WEBPACK_IMPORTED_MODULE_5__.obj)(function(data,_,next){if(limit&&called>=limit)return complete(),next();if(opts.cancelled||opts.done)return next();var s,metadata,seq=(s=data.key,parseInt(s,10)),doc=data.value;if(seq===opts.since&&!descending)return next();if(docIds&&!docIds.has(doc._id))return next();function onGetMetadata(metadata){var winningRev$$1=getWinningRev(metadata);function onGetWinningDoc(winningDoc){var change=opts.processChange(winningDoc,metadata,opts);change.seq=metadata.seq;var filtered=filter(change);if("object"==typeof filtered)return opts.complete(filtered);filtered&&(called++,opts.attachments&&opts.include_docs?fetchAttachments([change],stores,opts).then(function(){opts.onChange(change)}):opts.onChange(change),opts.return_docs&&results.push(change)),next()}if(metadata.seq!==seq)return next();if(lastSeq=seq,winningRev$$1===doc._rev)return onGetWinningDoc(doc);var winningSeq=metadata.rev_map[winningRev$$1];stores.bySeqStore.get(formatSeq(winningSeq),function(err,doc){onGetWinningDoc(doc)})}if(metadata=docIdsToMetadata.get(doc._id))return onGetMetadata(metadata);stores.docStore.get(doc._id,function(err,metadata){if(opts.cancelled||opts.done||db.isClosed()||Object(pouchdb_adapter_utils__WEBPACK_IMPORTED_MODULE_9__.isLocalId)(metadata.id))return next();docIdsToMetadata.set(doc._id,metadata),onGetMetadata(metadata)})},function(next){if(opts.cancelled)return next();opts.return_docs&&opts.limit&&opts.limit<results.length&&(results.length=opts.limit),next()}).on("unpipe",function(){throughStream.end(),complete()});return changeStream.pipe(throughStream),{cancel:function(){opts.cancelled=!0,complete()}}},api._close=function(callback){if(db.isClosed())return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.NOT_OPEN));db.close(function(err){err?callback(err):(dbStore.delete(name),callback())})},api._getRevisionTree=function(docId,callback){stores.docStore.get(docId,function(err,metadata){err?callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC)):callback(null,metadata.rev_tree)})},api._doCompaction=writeLock(function(docId,revs,opts,callback){api._doCompactionNoLock(docId,revs,opts,callback)}),api._doCompactionNoLock=function(docId,revs,opts,callback){if("function"==typeof opts&&(callback=opts,opts={}),!revs.length)return callback();var txn=opts.ctx||new LevelTransaction;txn.get(stores.docStore,docId,function(err,metadata){if(err)return callback(err);var seqs=revs.map(function(rev){var seq=metadata.rev_map[rev];return delete metadata.rev_map[rev],seq});Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_10__.traverseRevTree)(metadata.rev_tree,function(isLeaf,pos,revHash,ctx,opts){var rev=pos+"-"+revHash;-1!==revs.indexOf(rev)&&(opts.status="missing")});var batch=[];batch.push({key:metadata.id,value:metadata,type:"put",prefix:stores.docStore});var overallErr,digestMap={},numDone=0;function checkDone(err){if(err&&(overallErr=err),++numDone===revs.length){if(overallErr)return callback(overallErr);!function(){var possiblyOrphanedAttachments=Object.keys(digestMap);if(!possiblyOrphanedAttachments.length)return finish();var overallErr,numDone=0;function checkDone(err){err&&(overallErr=err),++numDone===possiblyOrphanedAttachments.length&&finish(overallErr)}var refsToDelete=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_1__.Map;revs.forEach(function(rev){refsToDelete.set(docId+"@"+rev,!0)}),possiblyOrphanedAttachments.forEach(function(digest){txn.get(stores.attachmentStore,digest,function(err,attData){if(err)return"NotFoundError"===err.name?checkDone():checkDone(err);var refs=Object.keys(attData.refs||{}).filter(function(ref){return!refsToDelete.has(ref)}),newRefs={};refs.forEach(function(ref){newRefs[ref]=!0}),refs.length?batch.push({key:digest,type:"put",value:{refs:newRefs},prefix:stores.attachmentStore}):batch=batch.concat([{key:digest,type:"del",prefix:stores.attachmentStore},{key:digest,type:"del",prefix:stores.binaryStore}]),checkDone()})})}()}}function finish(err){return err?callback(err):(txn.batch(batch),opts.ctx?callback():void txn.execute(db,callback))}seqs.forEach(function(seq){batch.push({key:formatSeq(seq),type:"del",prefix:stores.bySeqStore}),txn.get(stores.bySeqStore,formatSeq(seq),function(err,doc){if(err)return"NotFoundError"===err.name?checkDone():checkDone(err);Object.keys(doc._attachments||{}).forEach(function(attName){var digest=doc._attachments[attName].digest;digestMap[digest]=!0}),checkDone()})})})},api._getLocal=function(id,callback){stores.localStore.get(id,function(err,doc){err?callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC)):callback(null,doc)})},api._putLocal=function(doc,opts,callback){"function"==typeof opts&&(callback=opts,opts={}),opts.ctx?api._putLocalNoLock(doc,opts,callback):api._putLocalWithLock(doc,opts,callback)},api._putLocalWithLock=writeLock(function(doc,opts,callback){api._putLocalNoLock(doc,opts,callback)}),api._putLocalNoLock=function(doc,opts,callback){delete doc._revisions;var oldRev=doc._rev,id=doc._id,txn=opts.ctx||new LevelTransaction;txn.get(stores.localStore,id,function(err,resp){if(err&&oldRev)return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.REV_CONFLICT));if(resp&&resp._rev!==oldRev)return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.REV_CONFLICT));doc._rev=oldRev?"0-"+(parseInt(oldRev.split("-")[1],10)+1):"0-1";var batch=[{type:"put",prefix:stores.localStore,key:id,value:doc}];txn.batch(batch);var ret={ok:!0,id:doc._id,rev:doc._rev};if(opts.ctx)return callback(null,ret);txn.execute(db,function(err){if(err)return callback(err);callback(null,ret)})})},api._removeLocal=function(doc,opts,callback){"function"==typeof opts&&(callback=opts,opts={}),opts.ctx?api._removeLocalNoLock(doc,opts,callback):api._removeLocalWithLock(doc,opts,callback)},api._removeLocalWithLock=writeLock(function(doc,opts,callback){api._removeLocalNoLock(doc,opts,callback)}),api._removeLocalNoLock=function(doc,opts,callback){var txn=opts.ctx||new LevelTransaction;txn.get(stores.localStore,doc._id,function(err,resp){if(err)return"NotFoundError"!==err.name?callback(err):callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.MISSING_DOC));if(resp._rev!==doc._rev)return callback(Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_13__.REV_CONFLICT));txn.batch([{prefix:stores.localStore,type:"del",key:doc._id}]);var ret={ok:!0,id:doc._id,rev:"0-0"};if(opts.ctx)return callback(null,ret);txn.execute(db,function(err){if(err)return callback(err);callback(null,ret)})})},api._destroy=function(opts,callback){var dbStore,leveldownName=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_2__.functionName)(leveldown);if(!dbStores.has(leveldownName))return callDestroy(name,callback);(dbStore=dbStores.get(leveldownName)).has(name)?(levelChanges.removeAllListeners(name),dbStore.get(name).close(function(){dbStore.delete(name),callDestroy(name,callback)})):callDestroy(name,callback)}}},function(module,exports,__webpack_require__){(function(process){var EventEmitter=__webpack_require__(61).EventEmitter,inherits=__webpack_require__(78).inherits,extend=__webpack_require__(80),DeferredLevelDOWN=__webpack_require__(81),IteratorStream=__webpack_require__(91),Batch=__webpack_require__(109),errors=__webpack_require__(110),assert=__webpack_require__(115),promisify=__webpack_require__(114),WriteError=errors.WriteError,ReadError=errors.ReadError,NotFoundError=errors.NotFoundError,OpenError=errors.OpenError,InitializationError=errors.InitializationError;function LevelUP(db,options,callback){if(!(this instanceof LevelUP))return new LevelUP(db,options,callback);var error;if(EventEmitter.call(this),this.setMaxListeners(1/0),"function"==typeof options&&(callback=options,options={}),options=options||{},!db||"object"!=typeof db){if(error=new InitializationError("First argument must be an abstract-leveldown compliant store"),"function"==typeof callback)return process.nextTick(callback,error);throw error}assert.equal(typeof db.status,"string",".status required, old abstract-leveldown"),this.options=getOptions(options),this._db=db,this.db=new DeferredLevelDOWN(db),this.open(callback)}function getCallback(options,callback){return"function"==typeof options?options:callback}function getOptions(options){return"object"==typeof options&&null!==options?options:{}}function maybeError(db,callback){if(!db._isOpening()&&!db.isOpen())return process.nextTick(callback,new ReadError("Database is not open")),!0}LevelUP.prototype.emit=EventEmitter.prototype.emit,LevelUP.prototype.once=EventEmitter.prototype.once,inherits(LevelUP,EventEmitter),LevelUP.prototype.open=function(callback){var promise,self=this;return callback||(promise=(callback=promisify()).promise),this.isOpen()?(process.nextTick(callback,null,self),promise):this._isOpening()?(this.once("open",function(){callback(null,self)}),promise):(this.emit("opening"),this.db.open(this.options,function(err){if(err)return callback(new OpenError(err));self.db=self._db,callback(null,self),self.emit("open"),self.emit("ready")}),promise)},LevelUP.prototype.close=function(callback){var promise,self=this;return callback||(promise=(callback=promisify()).promise),this.isOpen()?(this.db.close(function(){self.emit("closed"),callback.apply(null,arguments)}),this.emit("closing"),this.db=new DeferredLevelDOWN(this._db)):this.isClosed()?process.nextTick(callback):"closing"===this.db.status?this.once("closed",callback):this._isOpening()&&this.once("open",function(){self.close(callback)}),promise},LevelUP.prototype.isOpen=function(){return"open"===this.db.status},LevelUP.prototype._isOpening=function(){return"opening"===this.db.status},LevelUP.prototype.isClosed=function(){return/^clos|new/.test(this.db.status)},LevelUP.prototype.get=function(key,options,callback){if(null==key)throw new ReadError("get() requires a key argument");var promise;return(callback=getCallback(options,callback))||(promise=(callback=promisify()).promise),maybeError(this,callback)?promise:(options=getOptions(options),this.db.get(key,options,function(err,value){if(err)return err=/notfound/i.test(err)||err.notFound?new NotFoundError("Key not found in database ["+key+"]",err):new ReadError(err),callback(err);callback(null,value)}),promise)},LevelUP.prototype.put=function(key,value,options,callback){if(null==key)throw new WriteError("put() requires a key argument");var promise,self=this;return(callback=getCallback(options,callback))||(promise=(callback=promisify()).promise),maybeError(this,callback)?promise:(options=getOptions(options),this.db.put(key,value,options,function(err){if(err)return callback(new WriteError(err));self.emit("put",key,value),callback()}),promise)},LevelUP.prototype.del=function(key,options,callback){if(null==key)throw new WriteError("del() requires a key argument");var promise,self=this;return(callback=getCallback(options,callback))||(promise=(callback=promisify()).promise),maybeError(this,callback)?promise:(options=getOptions(options),this.db.del(key,options,function(err){if(err)return callback(new WriteError(err));self.emit("del",key),callback()}),promise)},LevelUP.prototype.batch=function(arr,options,callback){if(!arguments.length)return new Batch(this);if(!Array.isArray(arr))throw new WriteError("batch() requires an array argument");var promise,self=this;return(callback=getCallback(options,callback))||(promise=(callback=promisify()).promise),maybeError(this,callback)?promise:(options=getOptions(options),this.db.batch(arr,options,function(err){if(err)return callback(new WriteError(err));self.emit("batch",arr),callback()}),promise)},LevelUP.prototype.readStream=LevelUP.prototype.createReadStream=function(options){return"number"!=typeof(options=extend({keys:!0,values:!0},options)).limit&&(options.limit=-1),new IteratorStream(this.db.iterator(options),options)},LevelUP.prototype.keyStream=LevelUP.prototype.createKeyStream=function(options){return this.createReadStream(extend(options,{keys:!0,values:!1}))},LevelUP.prototype.valueStream=LevelUP.prototype.createValueStream=function(options){return this.createReadStream(extend(options,{keys:!1,values:!0}))},LevelUP.prototype.toString=function(){return"LevelUP"},LevelUP.errors=errors,module.exports=LevelUP.default=LevelUP}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){(function(process){var getOwnPropertyDescriptors=Object.getOwnPropertyDescriptors||function(obj){for(var keys=Object.keys(obj),descriptors={},i=0;i<keys.length;i++)descriptors[keys[i]]=Object.getOwnPropertyDescriptor(obj,keys[i]);return descriptors},formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}i=1;for(var args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];i<len;x=args[++i])isNull(x)||!isObject(x)?str+=" "+x:str+=" "+inspect(x);return str},exports.deprecate=function(fn,msg){if(void 0!==process&&!0===process.noDeprecation)return fn;if(void 0===process)return function(){return exports.deprecate(fn,msg).apply(this,arguments)};var warned=!1;return function(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}};var debugEnviron,debugs={};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=function(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=function(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var output,base="",array=!1,braces=["{","}"];(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value))&&(base=" [Function"+(value.name?": "+value.name:"")+"]");return isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0!==keys.length||array&&0!=value.length?recurseTimes<0?isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special"):(ctx.seen.push(value),output=array?function(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;i<l;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),function(output,base,braces){if(output.reduce(function(prev,cur){return 0,cur.indexOf("\n")>=0&&0,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1];return braces[0]+base+" "+output.join(", ")+" "+braces[1]}(output,base,braces)):braces[0]+base+braces[1]}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if((desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]}).get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1)).indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;(name=JSON.stringify(""+key)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=function(arg){return null==arg},exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=function(arg){return"symbol"==typeof arg},exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=function(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||void 0===arg},exports.isBuffer=__webpack_require__(79);var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}exports.log=function(){var d,time;console.log("%s - %s",(d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":"),[d.getDate(),months[d.getMonth()],time].join(" ")),exports.format.apply(exports,arguments))},exports.inherits=__webpack_require__(62),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin};var kCustomPromisifiedSymbol="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function callbackifyOnRejected(reason,cb){if(!reason){var newReason=new Error("Promise was rejected with a falsy value");newReason.reason=reason,reason=newReason}return cb(reason)}exports.promisify=function(original){if("function"!=typeof original)throw new TypeError('The "original" argument must be of type Function');if(kCustomPromisifiedSymbol&&original[kCustomPromisifiedSymbol]){var fn;if("function"!=typeof(fn=original[kCustomPromisifiedSymbol]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(fn,kCustomPromisifiedSymbol,{value:fn,enumerable:!1,writable:!1,configurable:!0}),fn}function fn(){for(var promiseResolve,promiseReject,promise=new Promise(function(resolve,reject){promiseResolve=resolve,promiseReject=reject}),args=[],i=0;i<arguments.length;i++)args.push(arguments[i]);args.push(function(err,value){err?promiseReject(err):promiseResolve(value)});try{original.apply(this,args)}catch(err){promiseReject(err)}return promise}return Object.setPrototypeOf(fn,Object.getPrototypeOf(original)),kCustomPromisifiedSymbol&&Object.defineProperty(fn,kCustomPromisifiedSymbol,{value:fn,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(fn,getOwnPropertyDescriptors(original))},exports.promisify.custom=kCustomPromisifiedSymbol,exports.callbackify=function(original){if("function"!=typeof original)throw new TypeError('The "original" argument must be of type Function');function callbackified(){for(var args=[],i=0;i<arguments.length;i++)args.push(arguments[i]);var maybeCb=args.pop();if("function"!=typeof maybeCb)throw new TypeError("The last argument must be of type Function");var self=this,cb=function(){return maybeCb.apply(self,arguments)};original.apply(this,args).then(function(ret){process.nextTick(cb,null,ret)},function(rej){process.nextTick(callbackifyOnRejected,rej,cb)})}return Object.setPrototypeOf(callbackified,Object.getPrototypeOf(original)),Object.defineProperties(callbackified,getOwnPropertyDescriptors(original)),callbackified}}).call(this,__webpack_require__(53))},function(module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},function(module,exports){module.exports=function(){for(var target={},i=0;i<arguments.length;i++){var source=arguments[i];for(var key in source)hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};var hasOwnProperty=Object.prototype.hasOwnProperty},function(module,exports,__webpack_require__){var AbstractLevelDOWN=__webpack_require__(82).AbstractLevelDOWN,inherits=__webpack_require__(62),DeferredIterator=__webpack_require__(90),deferrables="put get del batch".split(" ");function DeferredLevelDOWN(db){AbstractLevelDOWN.call(this,""),this._db=db,this._operations=[],this._iterators=[],closed(this)}function closed(self){deferrables.forEach(function(m){self["_"+m]=function(){this._operations.push({method:m,args:arguments})}}),"function"==typeof self._db.approximateSize&&(self.approximateSize=function(){this._operations.push({method:"approximateSize",args:arguments})}),self._iterator=function(options){var it=new DeferredIterator(options);return this._iterators.push(it),it}}inherits(DeferredLevelDOWN,AbstractLevelDOWN),DeferredLevelDOWN.prototype._open=function(options,callback){var self=this;this._db.open(options,function(err){if(err)return callback(err);self._operations.forEach(function(op){self._db[op.method].apply(self._db,op.args)}),self._operations=[],self._iterators.forEach(function(it){it.setDb(self._db)}),self._iterators=[],function(self){deferrables.concat("iterator").forEach(function(m){self["_"+m]=function(){return this._db[m].apply(this._db,arguments)}}),self._db.approximateSize&&(self.approximateSize=function(){return this._db.approximateSize.apply(this._db,arguments)})}(self),callback()})},DeferredLevelDOWN.prototype._close=function(callback){var self=this;this._db.close(function(err){if(err)return callback(err);closed(self),callback()})},DeferredLevelDOWN.prototype._serializeKey=function(key){return key},DeferredLevelDOWN.prototype._serializeValue=function(value){return value},module.exports=DeferredLevelDOWN,module.exports.DeferredIterator=DeferredIterator},function(module,exports,__webpack_require__){exports.AbstractLevelDOWN=__webpack_require__(83),exports.AbstractIterator=__webpack_require__(88),exports.AbstractChainedBatch=__webpack_require__(89)},function(module,exports,__webpack_require__){(function(process,Buffer){var xtend=__webpack_require__(80),AbstractIterator=__webpack_require__(88),AbstractChainedBatch=__webpack_require__(89),hasOwnProperty=Object.prototype.hasOwnProperty,rangeOptions="start end gt gte lt lte".split(" ");function AbstractLevelDOWN(location){if(!arguments.length||void 0===location)throw new Error("constructor requires at least a location argument");if("string"!=typeof location)throw new Error("constructor requires a location string argument");this.location=location,this.status="new"}function isRangeOption(k){return-1!==rangeOptions.indexOf(k)}AbstractLevelDOWN.prototype.open=function(options,callback){var self=this,oldStatus=this.status;if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("open() requires a callback argument");"object"!=typeof options&&(options={}),options.createIfMissing=!1!==options.createIfMissing,options.errorIfExists=!!options.errorIfExists,this.status="opening",this._open(options,function(err){if(err)return self.status=oldStatus,callback(err);self.status="open",callback()})},AbstractLevelDOWN.prototype._open=function(options,callback){process.nextTick(callback)},AbstractLevelDOWN.prototype.close=function(callback){var self=this,oldStatus=this.status;if("function"!=typeof callback)throw new Error("close() requires a callback argument");this.status="closing",this._close(function(err){if(err)return self.status=oldStatus,callback(err);self.status="closed",callback()})},AbstractLevelDOWN.prototype._close=function(callback){process.nextTick(callback)},AbstractLevelDOWN.prototype.get=function(key,options,callback){if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("get() requires a callback argument");var err=this._checkKey(key,"key");if(err)return process.nextTick(callback,err);key=this._serializeKey(key),"object"!=typeof options&&(options={}),options.asBuffer=!1!==options.asBuffer,this._get(key,options,callback)},AbstractLevelDOWN.prototype._get=function(key,options,callback){process.nextTick(function(){callback(new Error("NotFound"))})},AbstractLevelDOWN.prototype.put=function(key,value,options,callback){if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("put() requires a callback argument");var err=this._checkKey(key,"key");if(err)return process.nextTick(callback,err);key=this._serializeKey(key),value=this._serializeValue(value),"object"!=typeof options&&(options={}),this._put(key,value,options,callback)},AbstractLevelDOWN.prototype._put=function(key,value,options,callback){process.nextTick(callback)},AbstractLevelDOWN.prototype.del=function(key,options,callback){if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("del() requires a callback argument");var err=this._checkKey(key,"key");if(err)return process.nextTick(callback,err);key=this._serializeKey(key),"object"!=typeof options&&(options={}),this._del(key,options,callback)},AbstractLevelDOWN.prototype._del=function(key,options,callback){process.nextTick(callback)},AbstractLevelDOWN.prototype.batch=function(array,options,callback){if(!arguments.length)return this._chainedBatch();if("function"==typeof options&&(callback=options),"function"==typeof array&&(callback=array),"function"!=typeof callback)throw new Error("batch(array) requires a callback argument");if(!Array.isArray(array))return process.nextTick(callback,new Error("batch(array) requires an array argument"));options&&"object"==typeof options||(options={});for(var serialized=new Array(array.length),i=0;i<array.length;i++){if("object"!=typeof array[i]||null===array[i])return process.nextTick(callback,new Error("batch(array) element must be an object and not `null`"));var e=xtend(array[i]);if("put"!==e.type&&"del"!==e.type)return process.nextTick(callback,new Error("`type` must be 'put' or 'del'"));var err=this._checkKey(e.key,"key");if(err)return process.nextTick(callback,err);e.key=this._serializeKey(e.key),"put"===e.type&&(e.value=this._serializeValue(e.value)),serialized[i]=e}this._batch(serialized,options,callback)},AbstractLevelDOWN.prototype._batch=function(array,options,callback){process.nextTick(callback)},AbstractLevelDOWN.prototype._setupIteratorOptions=function(options){return(options=function(options){var result={};for(var k in options)hasOwnProperty.call(options,k)&&(isRangeOption(k)&&(""===(v=options[k])||null==v||function(v){return Buffer.isBuffer(v)&&0===v.length}(v))||(result[k]=options[k]));var v;return result}(options)).reverse=!!options.reverse,options.keys=!1!==options.keys,options.values=!1!==options.values,options.limit="limit"in options?options.limit:-1,options.keyAsBuffer=!1!==options.keyAsBuffer,options.valueAsBuffer=!1!==options.valueAsBuffer,options},AbstractLevelDOWN.prototype.iterator=function(options){return"object"!=typeof options&&(options={}),options=this._setupIteratorOptions(options),this._iterator(options)},AbstractLevelDOWN.prototype._iterator=function(options){return new AbstractIterator(this)},AbstractLevelDOWN.prototype._chainedBatch=function(){return new AbstractChainedBatch(this)},AbstractLevelDOWN.prototype._serializeKey=function(key){return Buffer.isBuffer(key)?key:String(key)},AbstractLevelDOWN.prototype._serializeValue=function(value){return null==value?"":Buffer.isBuffer(value)||process.browser?value:String(value)},AbstractLevelDOWN.prototype._checkKey=function(obj,type){return null==obj?new Error(type+" cannot be `null` or `undefined`"):Buffer.isBuffer(obj)&&0===obj.length?new Error(type+" cannot be an empty Buffer"):""===String(obj)?new Error(type+" cannot be an empty String"):void 0},module.exports=AbstractLevelDOWN}).call(this,__webpack_require__(53),__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){"use strict";(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var base64=__webpack_require__(85),ieee754=__webpack_require__(86),isArray=__webpack_require__(87);function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length)throw new RangeError("Invalid typed array length");return Buffer.TYPED_ARRAY_SUPPORT?(that=new Uint8Array(length)).__proto__=Buffer.prototype:(null===that&&(that=new Buffer(length)),that.length=length),that}function Buffer(arg,encodingOrOffset,length){if(!(Buffer.TYPED_ARRAY_SUPPORT||this instanceof Buffer))return new Buffer(arg,encodingOrOffset,length);if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}function from(that,value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&value instanceof ArrayBuffer?function(that,array,byteOffset,length){if(array.byteLength,byteOffset<0||array.byteLength<byteOffset)throw new RangeError("'offset' is out of bounds");if(array.byteLength<byteOffset+(length||0))throw new RangeError("'length' is out of bounds");array=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);Buffer.TYPED_ARRAY_SUPPORT?(that=array).__proto__=Buffer.prototype:that=fromArrayLike(that,array);return that}(that,value,encodingOrOffset,length):"string"==typeof value?function(that,string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');var length=0|byteLength(string,encoding),actual=(that=createBuffer(that,length)).write(string,encoding);actual!==length&&(that=that.slice(0,actual));return that}(that,value,encodingOrOffset):function(that,obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length);return 0===(that=createBuffer(that,len)).length?that:(obj.copy(that,0,0,len),that)}if(obj){if("undefined"!=typeof ArrayBuffer&&obj.buffer instanceof ArrayBuffer||"length"in obj)return"number"!=typeof obj.length||(val=obj.length)!=val?createBuffer(that,0):fromArrayLike(that,obj);if("Buffer"===obj.type&&isArray(obj.data))return fromArrayLike(that,obj.data)}var val;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(that,value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be a number');if(size<0)throw new RangeError('"size" argument must not be negative')}function allocUnsafe(that,size){if(assertSize(size),that=createBuffer(that,size<0?0:0|checked(size)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;i<size;++i)that[i]=0;return that}function fromArrayLike(that,array){var length=array.length<0?0:0|checked(array.length);that=createBuffer(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset=+byteOffset,isNaN(byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,Buffer.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length))>remaining&&(length=remaining):length=remaining;var strLen=string.length;if(strLen%2!=0)throw new TypeError("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&(tempCodePoint=(31&firstByte)<<6|63&secondByte)>127&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}(res)}exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50,Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}(),exports.kMaxLength=kMaxLength(),Buffer.poolSize=8192,Buffer._augment=function(arr){return arr.__proto__=Buffer.prototype,arr},Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)},Buffer.TYPED_ARRAY_SUPPORT&&(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0})),Buffer.alloc=function(size,fill,encoding){return function(that,size,fill,encoding){return assertSize(size),size<=0?createBuffer(that,size):void 0!==fill?"string"==typeof encoding?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill):createBuffer(that,size)}(null,size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)},Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=0|this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):function(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset|=0,isFinite(length)?(length|=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){value<0&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){value<0&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var newBuf,len=this.length;if((start=~~start)<0?(start+=len)<0&&(start=0):start>len&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):end>len&&(end=len),end<start&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)(newBuf=this.subarray(start,end)).__proto__=Buffer.prototype;else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;i<sliceLen;++i)newBuf[i]=this[i+start]}return newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&start<targetStart&&targetStart<end)for(i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;i<len;++i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),1===val.length){var code=val.charCodeAt(0);code<256&&(val=code)}if(void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding)}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0),"number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString()),len=bytes.length;for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if((codePoint=string.charCodeAt(i))>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=function(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}(str).replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){for(var tmp,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=placeHoldersLen>0?validLen-4:validLen,i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,i+16383>len2?len2:i+16383));1===extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},function(module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},function(module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},function(module,exports,__webpack_require__){(function(process){function AbstractIterator(db){this.db=db,this._ended=!1,this._nexting=!1}AbstractIterator.prototype.next=function(callback){var self=this;if("function"!=typeof callback)throw new Error("next() requires a callback argument");return self._ended?(process.nextTick(callback,new Error("cannot call next() after end()")),self):self._nexting?(process.nextTick(callback,new Error("cannot call next() before previous next() has completed")),self):(self._nexting=!0,self._next(function(){self._nexting=!1,callback.apply(null,arguments)}),self)},AbstractIterator.prototype._next=function(callback){process.nextTick(callback)},AbstractIterator.prototype.end=function(callback){if("function"!=typeof callback)throw new Error("end() requires a callback argument");if(this._ended)return process.nextTick(callback,new Error("end() already called on iterator"));this._ended=!0,this._end(callback)},AbstractIterator.prototype._end=function(callback){process.nextTick(callback)},module.exports=AbstractIterator}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){(function(process){function AbstractChainedBatch(db){this._db=db,this._operations=[],this._written=!1}AbstractChainedBatch.prototype._serializeKey=function(key){return this._db._serializeKey(key)},AbstractChainedBatch.prototype._serializeValue=function(value){return this._db._serializeValue(value)},AbstractChainedBatch.prototype._checkWritten=function(){if(this._written)throw new Error("write() already called on this batch")},AbstractChainedBatch.prototype.put=function(key,value){this._checkWritten();var err=this._db._checkKey(key,"key");if(err)throw err;return key=this._serializeKey(key),value=this._serializeValue(value),this._put(key,value),this},AbstractChainedBatch.prototype._put=function(key,value){this._operations.push({type:"put",key:key,value:value})},AbstractChainedBatch.prototype.del=function(key){this._checkWritten();var err=this._db._checkKey(key,"key");if(err)throw err;return key=this._serializeKey(key),this._del(key),this},AbstractChainedBatch.prototype._del=function(key){this._operations.push({type:"del",key:key})},AbstractChainedBatch.prototype.clear=function(){return this._checkWritten(),this._operations=[],this._clear(),this},AbstractChainedBatch.prototype._clear=function(){},AbstractChainedBatch.prototype.write=function(options,callback){if(this._checkWritten(),"function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("write() requires a callback argument");return"object"!=typeof options&&(options={}),this._written=!0,"function"==typeof this._write?this._write(callback):"function"==typeof this._db._batch?this._db._batch(this._operations,options,callback):void process.nextTick(callback)},module.exports=AbstractChainedBatch}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){var AbstractIterator=__webpack_require__(82).AbstractIterator;function DeferredIterator(options){AbstractIterator.call(this,options),this._options=options,this._iterator=null,this._operations=[]}__webpack_require__(62)(DeferredIterator,AbstractIterator),DeferredIterator.prototype.setDb=function(db){var it=this._iterator=db.iterator(this._options);this._operations.forEach(function(op){it[op.method].apply(it,op.args)})},DeferredIterator.prototype._operation=function(method,args){if(this._iterator)return this._iterator[method].apply(this._iterator,args);this._operations.push({method:method,args:args})},"next end".split(" ").forEach(function(m){DeferredIterator.prototype["_"+m]=function(){this._operation(m,arguments)}}),module.exports=DeferredIterator},function(module,exports,__webpack_require__){var inherits=__webpack_require__(62),Readable=__webpack_require__(92).Readable,extend=__webpack_require__(80);function ReadStream(iterator,options){if(!(this instanceof ReadStream))return new ReadStream(iterator,options);options=options||{},Readable.call(this,extend(options,{objectMode:!0})),this._iterator=iterator,this._destroyed=!1,this._options=options,this.on("end",this._cleanup.bind(this))}module.exports=ReadStream,inherits(ReadStream,Readable),ReadStream.prototype._read=function(){var self=this,options=this._options;this._destroyed||this._iterator.next(function(err,key,value){if(!self._destroyed)return err?self.emit("error",err):void(void 0===key&&void 0===value?self.push(null):!1!==options.keys&&!1===options.values?self.push(key):!1===options.keys&&!1!==options.values?self.push(value):self.push({key:key,value:value}))})},ReadStream.prototype.destroy=ReadStream.prototype._cleanup=function(){var self=this;this._destroyed||(this._destroyed=!0,this._iterator.end(function(err){if(err)return self.emit("error",err);self.emit("close")}))}},function(module,exports,__webpack_require__){(exports=module.exports=__webpack_require__(93)).Stream=exports,exports.Readable=exports,exports.Writable=__webpack_require__(102),exports.Duplex=__webpack_require__(101),exports.Transform=__webpack_require__(107),exports.PassThrough=__webpack_require__(108)},function(module,exports,__webpack_require__){"use strict";(function(global,process){var processNextTick=__webpack_require__(94);module.exports=Readable;var Duplex,isArray=__webpack_require__(87);Readable.ReadableState=ReadableState;__webpack_require__(61).EventEmitter;var EElistenerCount=function(emitter,type){return emitter.listeners(type).length},Stream=__webpack_require__(95),Buffer=__webpack_require__(96).Buffer,OurUint8Array=global.Uint8Array||function(){};var util=__webpack_require__(97);util.inherits=__webpack_require__(62);var debugUtil=__webpack_require__(98),debug=void 0;debug=debugUtil&&debugUtil.debuglog?debugUtil.debuglog("stream"):function(){};var StringDecoder,BufferList=__webpack_require__(99),destroyImpl=__webpack_require__(100);util.inherits(Readable,Stream);var kProxyEvents=["error","close","destroy","pause","resume"];function ReadableState(options,stream){Duplex=Duplex||__webpack_require__(101),options=options||{},this.objectMode=!!options.objectMode,stream instanceof Duplex&&(this.objectMode=this.objectMode||!!options.readableObjectMode);var hwm=options.highWaterMark,defaultHwm=this.objectMode?16:16384;this.highWaterMark=hwm||0===hwm?hwm:defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new BufferList,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=options.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,options.encoding&&(StringDecoder||(StringDecoder=__webpack_require__(106).StringDecoder),this.decoder=new StringDecoder(options.encoding),this.encoding=options.encoding)}function Readable(options){if(Duplex=Duplex||__webpack_require__(101),!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this),this.readable=!0,options&&("function"==typeof options.read&&(this._read=options.read),"function"==typeof options.destroy&&(this._destroy=options.destroy)),Stream.call(this)}function readableAddChunk(stream,chunk,encoding,addToFront,skipChunkCheck){var er,state=stream._readableState;null===chunk?(state.reading=!1,function(stream,state){if(state.ended)return;if(state.decoder){var chunk=state.decoder.end();chunk&&chunk.length&&(state.buffer.push(chunk),state.length+=state.objectMode?1:chunk.length)}state.ended=!0,emitReadable(stream)}(stream,state)):(skipChunkCheck||(er=function(state,chunk){var er;obj=chunk,Buffer.isBuffer(obj)||obj instanceof OurUint8Array||"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk"));var obj;return er}(state,chunk)),er?stream.emit("error",er):state.objectMode||chunk&&chunk.length>0?("string"==typeof chunk||state.objectMode||Object.getPrototypeOf(chunk)===Buffer.prototype||(chunk=function(chunk){return Buffer.from(chunk)}(chunk)),addToFront?state.endEmitted?stream.emit("error",new Error("stream.unshift() after end event")):addChunk(stream,state,chunk,!0):state.ended?stream.emit("error",new Error("stream.push() after EOF")):(state.reading=!1,state.decoder&&!encoding?(chunk=state.decoder.write(chunk),state.objectMode||0!==chunk.length?addChunk(stream,state,chunk,!1):maybeReadMore(stream,state)):addChunk(stream,state,chunk,!1))):addToFront||(state.reading=!1));return function(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||0===state.length)}(state)}function addChunk(stream,state,chunk,addToFront){state.flowing&&0===state.length&&!state.sync?(stream.emit("data",chunk),stream.read(0)):(state.length+=state.objectMode?1:chunk.length,addToFront?state.buffer.unshift(chunk):state.buffer.push(chunk),state.needReadable&&emitReadable(stream)),maybeReadMore(stream,state)}Object.defineProperty(Readable.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(value){this._readableState&&(this._readableState.destroyed=value)}}),Readable.prototype.destroy=destroyImpl.destroy,Readable.prototype._undestroy=destroyImpl.undestroy,Readable.prototype._destroy=function(err,cb){this.push(null),cb(err)},Readable.prototype.push=function(chunk,encoding){var skipChunkCheck,state=this._readableState;return state.objectMode?skipChunkCheck=!0:"string"==typeof chunk&&((encoding=encoding||state.defaultEncoding)!==state.encoding&&(chunk=Buffer.from(chunk,encoding),encoding=""),skipChunkCheck=!0),readableAddChunk(this,chunk,encoding,!1,skipChunkCheck)},Readable.prototype.unshift=function(chunk){return readableAddChunk(this,chunk,null,!0,!1)},Readable.prototype.isPaused=function(){return!1===this._readableState.flowing},Readable.prototype.setEncoding=function(enc){return StringDecoder||(StringDecoder=__webpack_require__(106).StringDecoder),this._readableState.decoder=new StringDecoder(enc),this._readableState.encoding=enc,this};var MAX_HWM=8388608;function howMuchToRead(n,state){return n<=0||0===state.length&&state.ended?0:state.objectMode?1:n!=n?state.flowing&&state.length?state.buffer.head.data.length:state.length:(n>state.highWaterMark&&(state.highWaterMark=function(n){return n>=MAX_HWM?n=MAX_HWM:(n--,n|=n>>>1,n|=n>>>2,n|=n>>>4,n|=n>>>8,n|=n>>>16,n++),n}(n)),n<=state.length?n:state.ended?state.length:(state.needReadable=!0,0))}function emitReadable(stream){var state=stream._readableState;state.needReadable=!1,state.emittedReadable||(debug("emitReadable",state.flowing),state.emittedReadable=!0,state.sync?processNextTick(emitReadable_,stream):emitReadable_(stream))}function emitReadable_(stream){debug("emit readable"),stream.emit("readable"),flow(stream)}function maybeReadMore(stream,state){state.readingMore||(state.readingMore=!0,processNextTick(maybeReadMore_,stream,state))}function maybeReadMore_(stream,state){for(var len=state.length;!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark&&(debug("maybeReadMore read 0"),stream.read(0),len!==state.length);)len=state.length;state.readingMore=!1}function nReadingNextTick(self){debug("readable nexttick read 0"),self.read(0)}function resume_(stream,state){state.reading||(debug("resume read 0"),stream.read(0)),state.resumeScheduled=!1,state.awaitDrain=0,stream.emit("resume"),flow(stream),state.flowing&&!state.reading&&stream.read(0)}function flow(stream){var state=stream._readableState;for(debug("flow",state.flowing);state.flowing&&null!==stream.read(););}function fromList(n,state){return 0===state.length?null:(state.objectMode?ret=state.buffer.shift():!n||n>=state.length?(ret=state.decoder?state.buffer.join(""):1===state.buffer.length?state.buffer.head.data:state.buffer.concat(state.length),state.buffer.clear()):ret=function(n,list,hasStrings){var ret;n<list.head.data.length?(ret=list.head.data.slice(0,n),list.head.data=list.head.data.slice(n)):ret=n===list.head.data.length?list.shift():hasStrings?function(n,list){var p=list.head,c=1,ret=p.data;n-=ret.length;for(;p=p.next;){var str=p.data,nb=n>str.length?str.length:n;if(nb===str.length?ret+=str:ret+=str.slice(0,n),0===(n-=nb)){nb===str.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=str.slice(nb));break}++c}return list.length-=c,ret}(n,list):function(n,list){var ret=Buffer.allocUnsafe(n),p=list.head,c=1;p.data.copy(ret),n-=p.data.length;for(;p=p.next;){var buf=p.data,nb=n>buf.length?buf.length:n;if(buf.copy(ret,ret.length-n,0,nb),0===(n-=nb)){nb===buf.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=buf.slice(nb));break}++c}return list.length-=c,ret}(n,list);return ret}(n,state.buffer,state.decoder),ret);var ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');state.endEmitted||(state.ended=!0,processNextTick(endReadableNT,state,stream))}function endReadableNT(state,stream){state.endEmitted||0!==state.length||(state.endEmitted=!0,stream.readable=!1,stream.emit("end"))}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++)if(xs[i]===x)return i;return-1}Readable.prototype.read=function(n){debug("read",n),n=parseInt(n,10);var state=this._readableState,nOrig=n;if(0!==n&&(state.emittedReadable=!1),0===n&&state.needReadable&&(state.length>=state.highWaterMark||state.ended))return debug("read: emitReadable",state.length,state.ended),0===state.length&&state.ended?endReadable(this):emitReadable(this),null;if(0===(n=howMuchToRead(n,state))&&state.ended)return 0===state.length&&endReadable(this),null;var ret,doRead=state.needReadable;return debug("need readable",doRead),(0===state.length||state.length-n<state.highWaterMark)&&debug("length less than watermark",doRead=!0),state.ended||state.reading?debug("reading or ended",doRead=!1):doRead&&(debug("do read"),state.reading=!0,state.sync=!0,0===state.length&&(state.needReadable=!0),this._read(state.highWaterMark),state.sync=!1,state.reading||(n=howMuchToRead(nOrig,state))),null===(ret=n>0?fromList(n,state):null)?(state.needReadable=!0,n=0):state.length-=n,0===state.length&&(state.ended||(state.needReadable=!0),nOrig!==n&&state.ended&&endReadable(this)),null!==ret&&this.emit("data",ret),ret},Readable.prototype._read=function(n){this.emit("error",new Error("_read() is not implemented"))},Readable.prototype.pipe=function(dest,pipeOpts){var src=this,state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest)}state.pipesCount+=1,debug("pipe count=%d opts=%j",state.pipesCount,pipeOpts);var endFn=(!pipeOpts||!1!==pipeOpts.end)&&dest!==process.stdout&&dest!==process.stderr?onend:unpipe;function onunpipe(readable,unpipeInfo){debug("onunpipe"),readable===src&&unpipeInfo&&!1===unpipeInfo.hasUnpiped&&(unpipeInfo.hasUnpiped=!0,debug("cleanup"),dest.removeListener("close",onclose),dest.removeListener("finish",onfinish),dest.removeListener("drain",ondrain),dest.removeListener("error",onerror),dest.removeListener("unpipe",onunpipe),src.removeListener("end",onend),src.removeListener("end",unpipe),src.removeListener("data",ondata),cleanedUp=!0,!state.awaitDrain||dest._writableState&&!dest._writableState.needDrain||ondrain())}function onend(){debug("onend"),dest.end()}state.endEmitted?processNextTick(endFn):src.once("end",endFn),dest.on("unpipe",onunpipe);var ondrain=function(src){return function(){var state=src._readableState;debug("pipeOnDrain",state.awaitDrain),state.awaitDrain&&state.awaitDrain--,0===state.awaitDrain&&EElistenerCount(src,"data")&&(state.flowing=!0,flow(src))}}(src);dest.on("drain",ondrain);var cleanedUp=!1;var increasedAwaitDrain=!1;function ondata(chunk){debug("ondata"),increasedAwaitDrain=!1,!1!==dest.write(chunk)||increasedAwaitDrain||((1===state.pipesCount&&state.pipes===dest||state.pipesCount>1&&-1!==indexOf(state.pipes,dest))&&!cleanedUp&&(debug("false write response, pause",src._readableState.awaitDrain),src._readableState.awaitDrain++,increasedAwaitDrain=!0),src.pause())}function onerror(er){debug("onerror",er),unpipe(),dest.removeListener("error",onerror),0===EElistenerCount(dest,"error")&&dest.emit("error",er)}function onclose(){dest.removeListener("finish",onfinish),unpipe()}function onfinish(){debug("onfinish"),dest.removeListener("close",onclose),unpipe()}function unpipe(){debug("unpipe"),src.unpipe(dest)}return src.on("data",ondata),function(emitter,event,fn){if("function"==typeof emitter.prependListener)return emitter.prependListener(event,fn);emitter._events&&emitter._events[event]?isArray(emitter._events[event])?emitter._events[event].unshift(fn):emitter._events[event]=[fn,emitter._events[event]]:emitter.on(event,fn)}(dest,"error",onerror),dest.once("close",onclose),dest.once("finish",onfinish),dest.emit("pipe",src),state.flowing||(debug("pipe resume"),src.resume()),dest},Readable.prototype.unpipe=function(dest){var state=this._readableState,unpipeInfo={hasUnpiped:!1};if(0===state.pipesCount)return this;if(1===state.pipesCount)return dest&&dest!==state.pipes?this:(dest||(dest=state.pipes),state.pipes=null,state.pipesCount=0,state.flowing=!1,dest&&dest.emit("unpipe",this,unpipeInfo),this);if(!dest){var dests=state.pipes,len=state.pipesCount;state.pipes=null,state.pipesCount=0,state.flowing=!1;for(var i=0;i<len;i++)dests[i].emit("unpipe",this,unpipeInfo);return this}var index=indexOf(state.pipes,dest);return-1===index?this:(state.pipes.splice(index,1),state.pipesCount-=1,1===state.pipesCount&&(state.pipes=state.pipes[0]),dest.emit("unpipe",this,unpipeInfo),this)},Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if("data"===ev)!1!==this._readableState.flowing&&this.resume();else if("readable"===ev){var state=this._readableState;state.endEmitted||state.readableListening||(state.readableListening=state.needReadable=!0,state.emittedReadable=!1,state.reading?state.length&&emitReadable(this):processNextTick(nReadingNextTick,this))}return res},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var state=this._readableState;return state.flowing||(debug("resume"),state.flowing=!0,function(stream,state){state.resumeScheduled||(state.resumeScheduled=!0,processNextTick(resume_,stream,state))}(this,state)),this},Readable.prototype.pause=function(){return debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause")),this},Readable.prototype.wrap=function(stream){var state=this._readableState,paused=!1,self=this;for(var i in stream.on("end",function(){if(debug("wrapped end"),state.decoder&&!state.ended){var chunk=state.decoder.end();chunk&&chunk.length&&self.push(chunk)}self.push(null)}),stream.on("data",function(chunk){(debug("wrapped data"),state.decoder&&(chunk=state.decoder.write(chunk)),state.objectMode&&null==chunk)||(state.objectMode||chunk&&chunk.length)&&(self.push(chunk)||(paused=!0,stream.pause()))}),stream)void 0===this[i]&&"function"==typeof stream[i]&&(this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i));for(var n=0;n<kProxyEvents.length;n++)stream.on(kProxyEvents[n],self.emit.bind(self,kProxyEvents[n]));return self._read=function(n){debug("wrapped _read",n),paused&&(paused=!1,stream.resume())},self},Readable._fromList=fromList}).call(this,__webpack_require__(2),__webpack_require__(53))},function(module,exports,__webpack_require__){"use strict";(function(process){!process.version||0===process.version.indexOf("v0.")||0===process.version.indexOf("v1.")&&0!==process.version.indexOf("v1.8.")?module.exports=function(fn,arg1,arg2,arg3){if("function"!=typeof fn)throw new TypeError('"callback" argument must be a function');var args,i,len=arguments.length;switch(len){case 0:case 1:return process.nextTick(fn);case 2:return process.nextTick(function(){fn.call(null,arg1)});case 3:return process.nextTick(function(){fn.call(null,arg1,arg2)});case 4:return process.nextTick(function(){fn.call(null,arg1,arg2,arg3)});default:for(args=new Array(len-1),i=0;i<args.length;)args[i++]=arguments[i];return process.nextTick(function(){fn.apply(null,args)})}}:module.exports=process.nextTick}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){module.exports=__webpack_require__(61).EventEmitter},function(module,exports,__webpack_require__){var buffer=__webpack_require__(84),Buffer=buffer.Buffer;function copyProps(src,dst){for(var key in src)dst[key]=src[key]}function SafeBuffer(arg,encodingOrOffset,length){return Buffer(arg,encodingOrOffset,length)}Buffer.from&&Buffer.alloc&&Buffer.allocUnsafe&&Buffer.allocUnsafeSlow?module.exports=buffer:(copyProps(buffer,exports),exports.Buffer=SafeBuffer),copyProps(Buffer,SafeBuffer),SafeBuffer.from=function(arg,encodingOrOffset,length){if("number"==typeof arg)throw new TypeError("Argument must not be a number");return Buffer(arg,encodingOrOffset,length)},SafeBuffer.alloc=function(size,fill,encoding){if("number"!=typeof size)throw new TypeError("Argument must be a number");var buf=Buffer(size);return void 0!==fill?"string"==typeof encoding?buf.fill(fill,encoding):buf.fill(fill):buf.fill(0),buf},SafeBuffer.allocUnsafe=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return Buffer(size)},SafeBuffer.allocUnsafeSlow=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return buffer.SlowBuffer(size)}},function(module,exports,__webpack_require__){(function(Buffer){function objectToString(o){return Object.prototype.toString.call(o)}exports.isArray=function(arg){return Array.isArray?Array.isArray(arg):"[object Array]"===objectToString(arg)},exports.isBoolean=function(arg){return"boolean"==typeof arg},exports.isNull=function(arg){return null===arg},exports.isNullOrUndefined=function(arg){return null==arg},exports.isNumber=function(arg){return"number"==typeof arg},exports.isString=function(arg){return"string"==typeof arg},exports.isSymbol=function(arg){return"symbol"==typeof arg},exports.isUndefined=function(arg){return void 0===arg},exports.isRegExp=function(re){return"[object RegExp]"===objectToString(re)},exports.isObject=function(arg){return"object"==typeof arg&&null!==arg},exports.isDate=function(d){return"[object Date]"===objectToString(d)},exports.isError=function(e){return"[object Error]"===objectToString(e)||e instanceof Error},exports.isFunction=function(arg){return"function"==typeof arg},exports.isPrimitive=function(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||void 0===arg},exports.isBuffer=Buffer.isBuffer}).call(this,__webpack_require__(84).Buffer)},function(module,exports){},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(96).Buffer;module.exports=function(){function BufferList(){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,BufferList),this.head=null,this.tail=null,this.length=0}return BufferList.prototype.push=function(v){var entry={data:v,next:null};this.length>0?this.tail.next=entry:this.head=entry,this.tail=entry,++this.length},BufferList.prototype.unshift=function(v){var entry={data:v,next:this.head};0===this.length&&(this.tail=entry),this.head=entry,++this.length},BufferList.prototype.shift=function(){if(0!==this.length){var ret=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,ret}},BufferList.prototype.clear=function(){this.head=this.tail=null,this.length=0},BufferList.prototype.join=function(s){if(0===this.length)return"";for(var p=this.head,ret=""+p.data;p=p.next;)ret+=s+p.data;return ret},BufferList.prototype.concat=function(n){if(0===this.length)return Buffer.alloc(0);if(1===this.length)return this.head.data;for(var src,target,offset,ret=Buffer.allocUnsafe(n>>>0),p=this.head,i=0;p;)src=p.data,target=ret,offset=i,src.copy(target,offset),i+=p.data.length,p=p.next;return ret},BufferList}()},function(module,exports,__webpack_require__){"use strict";var processNextTick=__webpack_require__(94);function emitErrorNT(self,err){self.emit("error",err)}module.exports={destroy:function(err,cb){var _this=this,readableDestroyed=this._readableState&&this._readableState.destroyed,writableDestroyed=this._writableState&&this._writableState.destroyed;readableDestroyed||writableDestroyed?cb?cb(err):!err||this._writableState&&this._writableState.errorEmitted||processNextTick(emitErrorNT,this,err):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(err||null,function(err){!cb&&err?(processNextTick(emitErrorNT,_this,err),_this._writableState&&(_this._writableState.errorEmitted=!0)):cb&&cb(err)}))},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}}},function(module,exports,__webpack_require__){"use strict";var processNextTick=__webpack_require__(94),objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)keys.push(key);return keys};module.exports=Duplex;var util=__webpack_require__(97);util.inherits=__webpack_require__(62);var Readable=__webpack_require__(93),Writable=__webpack_require__(102);util.inherits(Duplex,Readable);for(var keys=objectKeys(Writable.prototype),v=0;v<keys.length;v++){var method=keys[v];Duplex.prototype[method]||(Duplex.prototype[method]=Writable.prototype[method])}function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options),Writable.call(this,options),options&&!1===options.readable&&(this.readable=!1),options&&!1===options.writable&&(this.writable=!1),this.allowHalfOpen=!0,options&&!1===options.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",onend)}function onend(){this.allowHalfOpen||this._writableState.ended||processNextTick(onEndNT,this)}function onEndNT(self){self.end()}Object.defineProperty(Duplex.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(value){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=value,this._writableState.destroyed=value)}}),Duplex.prototype._destroy=function(err,cb){this.push(null),this.end(),processNextTick(cb,err)}},function(module,exports,__webpack_require__){"use strict";(function(process,setImmediate,global){var processNextTick=__webpack_require__(94);function CorkedRequest(state){var _this=this;this.next=null,this.entry=null,this.finish=function(){!function(corkReq,state,err){var entry=corkReq.entry;corkReq.entry=null;for(;entry;){var cb=entry.callback;state.pendingcb--,cb(err),entry=entry.next}state.corkedRequestsFree?state.corkedRequestsFree.next=corkReq:state.corkedRequestsFree=corkReq}(_this,state)}}module.exports=Writable;var Duplex,asyncWrite=!process.browser&&["v0.10","v0.9."].indexOf(process.version.slice(0,5))>-1?setImmediate:processNextTick;Writable.WritableState=WritableState;var util=__webpack_require__(97);util.inherits=__webpack_require__(62);var internalUtil={deprecate:__webpack_require__(105)},Stream=__webpack_require__(95),Buffer=__webpack_require__(96).Buffer,OurUint8Array=global.Uint8Array||function(){};var realHasInstance,destroyImpl=__webpack_require__(100);function nop(){}function WritableState(options,stream){Duplex=Duplex||__webpack_require__(101),options=options||{},this.objectMode=!!options.objectMode,stream instanceof Duplex&&(this.objectMode=this.objectMode||!!options.writableObjectMode);var hwm=options.highWaterMark,defaultHwm=this.objectMode?16:16384;this.highWaterMark=hwm||0===hwm?hwm:defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var noDecode=!1===options.decodeStrings;this.decodeStrings=!noDecode,this.defaultEncoding=options.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(er){!function(stream,er){var state=stream._writableState,sync=state.sync,cb=state.writecb;if(function(state){state.writing=!1,state.writecb=null,state.length-=state.writelen,state.writelen=0}(state),er)!function(stream,state,sync,er,cb){--state.pendingcb,sync?(processNextTick(cb,er),processNextTick(finishMaybe,stream,state),stream._writableState.errorEmitted=!0,stream.emit("error",er)):(cb(er),stream._writableState.errorEmitted=!0,stream.emit("error",er),finishMaybe(stream,state))}(stream,state,sync,er,cb);else{var finished=needFinish(state);finished||state.corked||state.bufferProcessing||!state.bufferedRequest||clearBuffer(stream,state),sync?asyncWrite(afterWrite,stream,state,finished,cb):afterWrite(stream,state,finished,cb)}}(stream,er)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new CorkedRequest(this)}function Writable(options){if(Duplex=Duplex||__webpack_require__(101),!(realHasInstance.call(Writable,this)||this instanceof Duplex))return new Writable(options);this._writableState=new WritableState(options,this),this.writable=!0,options&&("function"==typeof options.write&&(this._write=options.write),"function"==typeof options.writev&&(this._writev=options.writev),"function"==typeof options.destroy&&(this._destroy=options.destroy),"function"==typeof options.final&&(this._final=options.final)),Stream.call(this)}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len,state.writecb=cb,state.writing=!0,state.sync=!0,writev?stream._writev(chunk,state.onwrite):stream._write(chunk,encoding,state.onwrite),state.sync=!1}function afterWrite(stream,state,finished,cb){finished||function(stream,state){0===state.length&&state.needDrain&&(state.needDrain=!1,stream.emit("drain"))}(stream,state),state.pendingcb--,cb(),finishMaybe(stream,state)}function clearBuffer(stream,state){state.bufferProcessing=!0;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount,buffer=new Array(l),holder=state.corkedRequestsFree;holder.entry=entry;for(var count=0,allBuffers=!0;entry;)buffer[count]=entry,entry.isBuf||(allBuffers=!1),entry=entry.next,count+=1;buffer.allBuffers=allBuffers,doWrite(stream,state,!0,state.length,buffer,"",holder.finish),state.pendingcb++,state.lastBufferedRequest=null,holder.next?(state.corkedRequestsFree=holder.next,holder.next=null):state.corkedRequestsFree=new CorkedRequest(state)}else{for(;entry;){var chunk=entry.chunk,encoding=entry.encoding,cb=entry.callback;if(doWrite(stream,state,!1,state.objectMode?1:chunk.length,chunk,encoding,cb),entry=entry.next,state.writing)break}null===entry&&(state.lastBufferedRequest=null)}state.bufferedRequestCount=0,state.bufferedRequest=entry,state.bufferProcessing=!1}function needFinish(state){return state.ending&&0===state.length&&null===state.bufferedRequest&&!state.finished&&!state.writing}function callFinal(stream,state){stream._final(function(err){state.pendingcb--,err&&stream.emit("error",err),state.prefinished=!0,stream.emit("prefinish"),finishMaybe(stream,state)})}function finishMaybe(stream,state){var need=needFinish(state);return need&&(!function(stream,state){state.prefinished||state.finalCalled||("function"==typeof stream._final?(state.pendingcb++,state.finalCalled=!0,processNextTick(callFinal,stream,state)):(state.prefinished=!0,stream.emit("prefinish")))}(stream,state),0===state.pendingcb&&(state.finished=!0,stream.emit("finish"))),need}util.inherits(Writable,Stream),WritableState.prototype.getBuffer=function(){for(var current=this.bufferedRequest,out=[];current;)out.push(current),current=current.next;return out},function(){try{Object.defineProperty(WritableState.prototype,"buffer",{get:internalUtil.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(_){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(realHasInstance=Function.prototype[Symbol.hasInstance],Object.defineProperty(Writable,Symbol.hasInstance,{value:function(object){return!!realHasInstance.call(this,object)||object&&object._writableState instanceof WritableState}})):realHasInstance=function(object){return object instanceof this},Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Writable.prototype.write=function(chunk,encoding,cb){var obj,state=this._writableState,ret=!1,isBuf=(obj=chunk,(Buffer.isBuffer(obj)||obj instanceof OurUint8Array)&&!state.objectMode);return isBuf&&!Buffer.isBuffer(chunk)&&(chunk=function(chunk){return Buffer.from(chunk)}(chunk)),"function"==typeof encoding&&(cb=encoding,encoding=null),isBuf?encoding="buffer":encoding||(encoding=state.defaultEncoding),"function"!=typeof cb&&(cb=nop),state.ended?function(stream,cb){var er=new Error("write after end");stream.emit("error",er),processNextTick(cb,er)}(this,cb):(isBuf||function(stream,state,chunk,cb){var valid=!0,er=!1;return null===chunk?er=new TypeError("May not write null values to stream"):"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk")),er&&(stream.emit("error",er),processNextTick(cb,er),valid=!1),valid}(this,state,chunk,cb))&&(state.pendingcb++,ret=function(stream,state,isBuf,chunk,encoding,cb){if(!isBuf){var newChunk=function(state,chunk,encoding){state.objectMode||!1===state.decodeStrings||"string"!=typeof chunk||(chunk=Buffer.from(chunk,encoding));return chunk}(state,chunk,encoding);chunk!==newChunk&&(isBuf=!0,encoding="buffer",chunk=newChunk)}var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;ret||(state.needDrain=!0);if(state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest={chunk:chunk,encoding:encoding,isBuf:isBuf,callback:cb,next:null},last?last.next=state.lastBufferedRequest:state.bufferedRequest=state.lastBufferedRequest,state.bufferedRequestCount+=1}else doWrite(stream,state,!1,len,chunk,encoding,cb);return ret}(this,state,isBuf,chunk,encoding,cb)),ret},Writable.prototype.cork=function(){this._writableState.corked++},Writable.prototype.uncork=function(){var state=this._writableState;state.corked&&(state.corked--,state.writing||state.corked||state.finished||state.bufferProcessing||!state.bufferedRequest||clearBuffer(this,state))},Writable.prototype.setDefaultEncoding=function(encoding){if("string"==typeof encoding&&(encoding=encoding.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((encoding+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+encoding);return this._writableState.defaultEncoding=encoding,this},Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("_write() is not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;"function"==typeof chunk?(cb=chunk,chunk=null,encoding=null):"function"==typeof encoding&&(cb=encoding,encoding=null),null!=chunk&&this.write(chunk,encoding),state.corked&&(state.corked=1,this.uncork()),state.ending||state.finished||function(stream,state,cb){state.ending=!0,finishMaybe(stream,state),cb&&(state.finished?processNextTick(cb):stream.once("finish",cb));state.ended=!0,stream.writable=!1}(this,state,cb)},Object.defineProperty(Writable.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(value){this._writableState&&(this._writableState.destroyed=value)}}),Writable.prototype.destroy=destroyImpl.destroy,Writable.prototype._undestroy=destroyImpl.undestroy,Writable.prototype._destroy=function(err,cb){this.end(),cb(err)}}).call(this,__webpack_require__(53),__webpack_require__(103).setImmediate,__webpack_require__(2))},function(module,exports,__webpack_require__){(function(global){var scope=void 0!==global&&global||"undefined"!=typeof self&&self||window,apply=Function.prototype.apply;function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,scope,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,scope,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout&&timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(scope,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;msecs>=0&&(item._idleTimeoutId=setTimeout(function(){item._onTimeout&&item._onTimeout()},msecs))},__webpack_require__(104),exports.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==global&&global.setImmediate||this&&this.setImmediate,exports.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==global&&global.clearImmediate||this&&this.clearImmediate}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){(function(global,process){!function(global,undefined){"use strict";if(!global.setImmediate){var registerImmediate,html,channel,messagePrefix,onGlobalMessage,nextHandle=1,tasksByHandle={},currentlyRunningATask=!1,doc=global.document,attachTo=Object.getPrototypeOf&&Object.getPrototypeOf(global);attachTo=attachTo&&attachTo.setTimeout?attachTo:global,"[object process]"==={}.toString.call(global.process)?registerImmediate=function(handle){process.nextTick(function(){runIfPresent(handle)})}:!function(){if(global.postMessage&&!global.importScripts){var postMessageIsAsynchronous=!0,oldOnMessage=global.onmessage;return global.onmessage=function(){postMessageIsAsynchronous=!1},global.postMessage("","*"),global.onmessage=oldOnMessage,postMessageIsAsynchronous}}()?global.MessageChannel?((channel=new MessageChannel).port1.onmessage=function(event){runIfPresent(event.data)},registerImmediate=function(handle){channel.port2.postMessage(handle)}):doc&&"onreadystatechange"in doc.createElement("script")?(html=doc.documentElement,registerImmediate=function(handle){var script=doc.createElement("script");script.onreadystatechange=function(){runIfPresent(handle),script.onreadystatechange=null,html.removeChild(script),script=null},html.appendChild(script)}):registerImmediate=function(handle){setTimeout(runIfPresent,0,handle)}:(messagePrefix="setImmediate$"+Math.random()+"$",onGlobalMessage=function(event){event.source===global&&"string"==typeof event.data&&0===event.data.indexOf(messagePrefix)&&runIfPresent(+event.data.slice(messagePrefix.length))},global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),registerImmediate=function(handle){global.postMessage(messagePrefix+handle,"*")}),attachTo.setImmediate=function(callback){"function"!=typeof callback&&(callback=new Function(""+callback));for(var args=new Array(arguments.length-1),i=0;i<args.length;i++)args[i]=arguments[i+1];var task={callback:callback,args:args};return tasksByHandle[nextHandle]=task,registerImmediate(nextHandle),nextHandle++},attachTo.clearImmediate=clearImmediate}function clearImmediate(handle){delete tasksByHandle[handle]}function runIfPresent(handle){if(currentlyRunningATask)setTimeout(runIfPresent,0,handle);else{var task=tasksByHandle[handle];if(task){currentlyRunningATask=!0;try{!function(task){var callback=task.callback,args=task.args;switch(args.length){case 0:callback();break;case 1:callback(args[0]);break;case 2:callback(args[0],args[1]);break;case 3:callback(args[0],args[1],args[2]);break;default:callback.apply(undefined,args)}}(task)}finally{clearImmediate(handle),currentlyRunningATask=!1}}}}}("undefined"==typeof self?void 0===global?this:global:self)}).call(this,__webpack_require__(2),__webpack_require__(53))},function(module,exports,__webpack_require__){(function(global){function config(name){try{if(!global.localStorage)return!1}catch(_){return!1}var val=global.localStorage[name];return null!=val&&"true"===String(val).toLowerCase()}module.exports=function(fn,msg){if(config("noDeprecation"))return fn;var warned=!1;return function(){if(!warned){if(config("throwDeprecation"))throw new Error(msg);config("traceDeprecation")?console.trace(msg):console.warn(msg),warned=!0}return fn.apply(this,arguments)}}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(96).Buffer,isEncoding=Buffer.isEncoding||function(encoding){switch((encoding=""+encoding)&&encoding.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function StringDecoder(encoding){var nb;switch(this.encoding=function(enc){var nenc=function(enc){if(!enc)return"utf8";for(var retried;;)switch(enc){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return enc;default:if(retried)return;enc=(""+enc).toLowerCase(),retried=!0}}(enc);if("string"!=typeof nenc&&(Buffer.isEncoding===isEncoding||!isEncoding(enc)))throw new Error("Unknown encoding: "+enc);return nenc||enc}(encoding),this.encoding){case"utf16le":this.text=utf16Text,this.end=utf16End,nb=4;break;case"utf8":this.fillLast=utf8FillLast,nb=4;break;case"base64":this.text=base64Text,this.end=base64End,nb=3;break;default:return this.write=simpleWrite,void(this.end=simpleEnd)}this.lastNeed=0,this.lastTotal=0,this.lastChar=Buffer.allocUnsafe(nb)}function utf8CheckByte(byte){return byte<=127?0:byte>>5==6?2:byte>>4==14?3:byte>>3==30?4:-1}function utf8FillLast(buf){var p=this.lastTotal-this.lastNeed,r=function(self,buf,p){if(128!=(192&buf[0]))return self.lastNeed=0,"�".repeat(p);if(self.lastNeed>1&&buf.length>1){if(128!=(192&buf[1]))return self.lastNeed=1,"�".repeat(p+1);if(self.lastNeed>2&&buf.length>2&&128!=(192&buf[2]))return self.lastNeed=2,"�".repeat(p+2)}}(this,buf,p);return void 0!==r?r:this.lastNeed<=buf.length?(buf.copy(this.lastChar,p,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(buf.copy(this.lastChar,p,0,buf.length),void(this.lastNeed-=buf.length))}function utf16Text(buf,i){if((buf.length-i)%2==0){var r=buf.toString("utf16le",i);if(r){var c=r.charCodeAt(r.length-1);if(c>=55296&&c<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=buf[buf.length-1],buf.toString("utf16le",i,buf.length-1)}function utf16End(buf){var r=buf&&buf.length?this.write(buf):"";if(this.lastNeed){var end=this.lastTotal-this.lastNeed;return r+this.lastChar.toString("utf16le",0,end)}return r}function base64Text(buf,i){var n=(buf.length-i)%3;return 0===n?buf.toString("base64",i):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=buf[buf.length-1]:(this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1]),buf.toString("base64",i,buf.length-n))}function base64End(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+this.lastChar.toString("base64",0,3-this.lastNeed):r}function simpleWrite(buf){return buf.toString(this.encoding)}function simpleEnd(buf){return buf&&buf.length?this.write(buf):""}exports.StringDecoder=StringDecoder,StringDecoder.prototype.write=function(buf){if(0===buf.length)return"";var r,i;if(this.lastNeed){if(void 0===(r=this.fillLast(buf)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<buf.length?r?r+this.text(buf,i):this.text(buf,i):r||""},StringDecoder.prototype.end=function(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+"�".repeat(this.lastTotal-this.lastNeed):r},StringDecoder.prototype.text=function(buf,i){var total=function(self,buf,i){var j=buf.length-1;if(j<i)return 0;var nb=utf8CheckByte(buf[j]);if(nb>=0)return nb>0&&(self.lastNeed=nb-1),nb;if(--j<i)return 0;if((nb=utf8CheckByte(buf[j]))>=0)return nb>0&&(self.lastNeed=nb-2),nb;if(--j<i)return 0;if((nb=utf8CheckByte(buf[j]))>=0)return nb>0&&(2===nb?nb=0:self.lastNeed=nb-3),nb;return 0}(this,buf,i);if(!this.lastNeed)return buf.toString("utf8",i);this.lastTotal=total;var end=buf.length-(total-this.lastNeed);return buf.copy(this.lastChar,0,end),buf.toString("utf8",i,end)},StringDecoder.prototype.fillLast=function(buf){if(this.lastNeed<=buf.length)return buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,buf.length),this.lastNeed-=buf.length}},function(module,exports,__webpack_require__){"use strict";module.exports=Transform;var Duplex=__webpack_require__(101),util=__webpack_require__(97);function TransformState(stream){this.afterTransform=function(er,data){return function(stream,er,data){var ts=stream._transformState;ts.transforming=!1;var cb=ts.writecb;if(!cb)return stream.emit("error",new Error("write callback called multiple times"));ts.writechunk=null,ts.writecb=null,null!=data&&stream.push(data);cb(er);var rs=stream._readableState;rs.reading=!1,(rs.needReadable||rs.length<rs.highWaterMark)&&stream._read(rs.highWaterMark)}(stream,er,data)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null,this.writeencoding=null}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options),this._transformState=new TransformState(this);var stream=this;this._readableState.needReadable=!0,this._readableState.sync=!1,options&&("function"==typeof options.transform&&(this._transform=options.transform),"function"==typeof options.flush&&(this._flush=options.flush)),this.once("prefinish",function(){"function"==typeof this._flush?this._flush(function(er,data){done(stream,er,data)}):done(stream)})}function done(stream,er,data){if(er)return stream.emit("error",er);null!=data&&stream.push(data);var ws=stream._writableState,ts=stream._transformState;if(ws.length)throw new Error("Calling transform done when ws.length != 0");if(ts.transforming)throw new Error("Calling transform done when still transforming");return stream.push(null)}util.inherits=__webpack_require__(62),util.inherits(Transform,Duplex),Transform.prototype.push=function(chunk,encoding){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,chunk,encoding)},Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("_transform() is not implemented")},Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;if(ts.writecb=cb,ts.writechunk=chunk,ts.writeencoding=encoding,!ts.transforming){var rs=this._readableState;(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}},Transform.prototype._read=function(n){var ts=this._transformState;null!==ts.writechunk&&ts.writecb&&!ts.transforming?(ts.transforming=!0,this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)):ts.needTransform=!0},Transform.prototype._destroy=function(err,cb){var _this=this;Duplex.prototype._destroy.call(this,err,function(err2){cb(err2),_this.emit("close")})}},function(module,exports,__webpack_require__){"use strict";module.exports=PassThrough;var Transform=__webpack_require__(107),util=__webpack_require__(97);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}util.inherits=__webpack_require__(62),util.inherits(PassThrough,Transform),PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)}},function(module,exports,__webpack_require__){var WriteError=__webpack_require__(110).WriteError,promisify=__webpack_require__(114);function Batch(levelup){this._levelup=levelup,this.batch=levelup.db.batch(),this.ops=[],this.length=0}Batch.prototype.put=function(key,value){try{this.batch.put(key,value)}catch(e){throw new WriteError(e)}return this.ops.push({type:"put",key:key,value:value}),this.length++,this},Batch.prototype.del=function(key){try{this.batch.del(key)}catch(err){throw new WriteError(err)}return this.ops.push({type:"del",key:key}),this.length++,this},Batch.prototype.clear=function(){try{this.batch.clear()}catch(err){throw new WriteError(err)}return this.ops=[],this.length=0,this},Batch.prototype.write=function(callback){var promise,levelup=this._levelup,ops=this.ops;callback||(promise=(callback=promisify()).promise);try{this.batch.write(function(err){if(err)return callback(new WriteError(err));levelup.emit("batch",ops),callback()})}catch(err){throw new WriteError(err)}return promise},module.exports=Batch},function(module,exports,__webpack_require__){var createError=__webpack_require__(111).create,LevelUPError=createError("LevelUPError"),NotFoundError=createError("NotFoundError",LevelUPError);NotFoundError.prototype.notFound=!0,NotFoundError.prototype.status=404,module.exports={LevelUPError:LevelUPError,InitializationError:createError("InitializationError",LevelUPError),OpenError:createError("OpenError",LevelUPError),ReadError:createError("ReadError",LevelUPError),WriteError:createError("WriteError",LevelUPError),NotFoundError:NotFoundError,EncodingError:createError("EncodingError",LevelUPError)}},function(module,exports,__webpack_require__){var all=module.exports.all=[{errno:-2,code:"ENOENT",description:"no such file or directory"},{errno:-1,code:"UNKNOWN",description:"unknown error"},{errno:0,code:"OK",description:"success"},{errno:1,code:"EOF",description:"end of file"},{errno:2,code:"EADDRINFO",description:"getaddrinfo error"},{errno:3,code:"EACCES",description:"permission denied"},{errno:4,code:"EAGAIN",description:"resource temporarily unavailable"},{errno:5,code:"EADDRINUSE",description:"address already in use"},{errno:6,code:"EADDRNOTAVAIL",description:"address not available"},{errno:7,code:"EAFNOSUPPORT",description:"address family not supported"},{errno:8,code:"EALREADY",description:"connection already in progress"},{errno:9,code:"EBADF",description:"bad file descriptor"},{errno:10,code:"EBUSY",description:"resource busy or locked"},{errno:11,code:"ECONNABORTED",description:"software caused connection abort"},{errno:12,code:"ECONNREFUSED",description:"connection refused"},{errno:13,code:"ECONNRESET",description:"connection reset by peer"},{errno:14,code:"EDESTADDRREQ",description:"destination address required"},{errno:15,code:"EFAULT",description:"bad address in system call argument"},{errno:16,code:"EHOSTUNREACH",description:"host is unreachable"},{errno:17,code:"EINTR",description:"interrupted system call"},{errno:18,code:"EINVAL",description:"invalid argument"},{errno:19,code:"EISCONN",description:"socket is already connected"},{errno:20,code:"EMFILE",description:"too many open files"},{errno:21,code:"EMSGSIZE",description:"message too long"},{errno:22,code:"ENETDOWN",description:"network is down"},{errno:23,code:"ENETUNREACH",description:"network is unreachable"},{errno:24,code:"ENFILE",description:"file table overflow"},{errno:25,code:"ENOBUFS",description:"no buffer space available"},{errno:26,code:"ENOMEM",description:"not enough memory"},{errno:27,code:"ENOTDIR",description:"not a directory"},{errno:28,code:"EISDIR",description:"illegal operation on a directory"},{errno:29,code:"ENONET",description:"machine is not on the network"},{errno:31,code:"ENOTCONN",description:"socket is not connected"},{errno:32,code:"ENOTSOCK",description:"socket operation on non-socket"},{errno:33,code:"ENOTSUP",description:"operation not supported on socket"},{errno:34,code:"ENOENT",description:"no such file or directory"},{errno:35,code:"ENOSYS",description:"function not implemented"},{errno:36,code:"EPIPE",description:"broken pipe"},{errno:37,code:"EPROTO",description:"protocol error"},{errno:38,code:"EPROTONOSUPPORT",description:"protocol not supported"},{errno:39,code:"EPROTOTYPE",description:"protocol wrong type for socket"},{errno:40,code:"ETIMEDOUT",description:"connection timed out"},{errno:41,code:"ECHARSET",description:"invalid Unicode character"},{errno:42,code:"EAIFAMNOSUPPORT",description:"address family for hostname not supported"},{errno:44,code:"EAISERVICE",description:"servname not supported for ai_socktype"},{errno:45,code:"EAISOCKTYPE",description:"ai_socktype not supported"},{errno:46,code:"ESHUTDOWN",description:"cannot send after transport endpoint shutdown"},{errno:47,code:"EEXIST",description:"file already exists"},{errno:48,code:"ESRCH",description:"no such process"},{errno:49,code:"ENAMETOOLONG",description:"name too long"},{errno:50,code:"EPERM",description:"operation not permitted"},{errno:51,code:"ELOOP",description:"too many symbolic links encountered"},{errno:52,code:"EXDEV",description:"cross-device link not permitted"},{errno:53,code:"ENOTEMPTY",description:"directory not empty"},{errno:54,code:"ENOSPC",description:"no space left on device"},{errno:55,code:"EIO",description:"i/o error"},{errno:56,code:"EROFS",description:"read-only file system"},{errno:57,code:"ENODEV",description:"no such device"},{errno:58,code:"ESPIPE",description:"invalid seek"},{errno:59,code:"ECANCELED",description:"operation canceled"}];module.exports.errno={},module.exports.code={},all.forEach(function(error){module.exports.errno[error.errno]=error,module.exports.code[error.code]=error}),module.exports.custom=__webpack_require__(112)(module.exports),module.exports.create=module.exports.custom.createError},function(module,exports,__webpack_require__){var prr=__webpack_require__(113);function init(type,message,cause){prr(this,{type:type,name:type,cause:"string"!=typeof message?message:cause,message:message&&"string"!=typeof message?message.message:message},"ewr")}function CustomError(message,cause){Error.call(this),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),init.call(this,"CustomError",message,cause)}CustomError.prototype=new Error,module.exports=function(errno){var ce=function(type,proto){return function(errno,type,proto){var err=function(message,cause){init.call(this,type,message,cause),"FilesystemError"==type&&(this.code=this.cause.code,this.path=this.cause.path,this.errno=this.cause.errno,this.message=(errno.errno[this.cause.errno]?errno.errno[this.cause.errno].description:this.cause.message)+(this.cause.path?" ["+this.cause.path+"]":"")),Error.call(this),Error.captureStackTrace&&Error.captureStackTrace(this,err)};return err.prototype=proto?new proto:new CustomError,err}(errno,type,proto)};return{CustomError:CustomError,FilesystemError:ce("FilesystemError"),createError:ce}}},function(module,exports,__webpack_require__){
/*!
  * prr
  * (c) 2013 Rod Vagg <rod@vagg.org>
  * https://github.com/rvagg/prr
  * License: MIT
  */
var context,definition;context=this,definition=function(){var setProperty="function"==typeof Object.defineProperty?function(obj,key,options){return Object.defineProperty(obj,key,options),obj}:function(obj,key,options){return obj[key]=options.value,obj};return function(obj,key,value,options){var k;if(options=function(value,options){var oo="object"==typeof options,os=!oo&&"string"==typeof options,op=function(p){return oo?!!options[p]:!!os&&options.indexOf(p[0])>-1};return{enumerable:op("enumerable"),configurable:op("configurable"),writable:op("writable"),value:value}}(value,options),"object"==typeof key){for(k in key)Object.hasOwnProperty.call(key,k)&&(options.value=key[k],setProperty(obj,k,options));return obj}return setProperty(obj,key,options)}},module.exports?module.exports=definition():context.prr=definition()},function(module,exports){module.exports=function(){var callback,promise=new Promise(function(resolve,reject){callback=function(err,value){err?reject(err):resolve(value)}});return callback.promise=promise,callback}},function(module,exports,__webpack_require__){"use strict";(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
function compare(a,b){if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0}function isBuffer(b){return global.Buffer&&"function"==typeof global.Buffer.isBuffer?global.Buffer.isBuffer(b):!(null==b||!b._isBuffer)}var util=__webpack_require__(78),hasOwn=Object.prototype.hasOwnProperty,pSlice=Array.prototype.slice,functionsHaveNames="foo"===function(){}.name;function pToString(obj){return Object.prototype.toString.call(obj)}function isView(arrbuf){return!isBuffer(arrbuf)&&("function"==typeof global.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(arrbuf):!!arrbuf&&(arrbuf instanceof DataView||!!(arrbuf.buffer&&arrbuf.buffer instanceof ArrayBuffer))))}var assert=module.exports=ok,regex=/\s*function\s+([^\(\s]*)\s*/;function getName(func){if(util.isFunction(func)){if(functionsHaveNames)return func.name;var match=func.toString().match(regex);return match&&match[1]}}function truncate(s,n){return"string"==typeof s?s.length<n?s:s.slice(0,n):s}function inspect(something){if(functionsHaveNames||!util.isFunction(something))return util.inspect(something);var rawname=getName(something);return"[Function"+(rawname?": "+rawname:"")+"]"}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}function ok(value,message){value||fail(value,!0,message,"==",assert.ok)}function _deepEqual(actual,expected,strict,memos){if(actual===expected)return!0;if(isBuffer(actual)&&isBuffer(expected))return 0===compare(actual,expected);if(util.isDate(actual)&&util.isDate(expected))return actual.getTime()===expected.getTime();if(util.isRegExp(actual)&&util.isRegExp(expected))return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase;if(null!==actual&&"object"==typeof actual||null!==expected&&"object"==typeof expected){if(isView(actual)&&isView(expected)&&pToString(actual)===pToString(expected)&&!(actual instanceof Float32Array||actual instanceof Float64Array))return 0===compare(new Uint8Array(actual.buffer),new Uint8Array(expected.buffer));if(isBuffer(actual)!==isBuffer(expected))return!1;var actualIndex=(memos=memos||{actual:[],expected:[]}).actual.indexOf(actual);return-1!==actualIndex&&actualIndex===memos.expected.indexOf(expected)||(memos.actual.push(actual),memos.expected.push(expected),function(a,b,strict,actualVisitedObjects){if(null==a||null==b)return!1;if(util.isPrimitive(a)||util.isPrimitive(b))return a===b;if(strict&&Object.getPrototypeOf(a)!==Object.getPrototypeOf(b))return!1;var aIsArgs=isArguments(a),bIsArgs=isArguments(b);if(aIsArgs&&!bIsArgs||!aIsArgs&&bIsArgs)return!1;if(aIsArgs)return a=pSlice.call(a),b=pSlice.call(b),_deepEqual(a,b,strict);var key,i,ka=objectKeys(a),kb=objectKeys(b);if(ka.length!==kb.length)return!1;for(ka.sort(),kb.sort(),i=ka.length-1;i>=0;i--)if(ka[i]!==kb[i])return!1;for(i=ka.length-1;i>=0;i--)if(key=ka[i],!_deepEqual(a[key],b[key],strict,actualVisitedObjects))return!1;return!0}(actual,expected,strict,memos))}return strict?actual===expected:actual==expected}function isArguments(object){return"[object Arguments]"==Object.prototype.toString.call(object)}function expectedException(actual,expected){if(!actual||!expected)return!1;if("[object RegExp]"==Object.prototype.toString.call(expected))return expected.test(actual);try{if(actual instanceof expected)return!0}catch(e){}return!Error.isPrototypeOf(expected)&&!0===expected.call({},actual)}function _throws(shouldThrow,block,expected,message){var actual;if("function"!=typeof block)throw new TypeError('"block" argument must be a function');"string"==typeof expected&&(message=expected,expected=null),actual=function(block){var error;try{block()}catch(e){error=e}return error}(block),message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:"."),shouldThrow&&!actual&&fail(actual,expected,"Missing expected exception"+message);var userProvidedMessage="string"==typeof message,isUnexpectedException=!shouldThrow&&actual&&!expected;if((!shouldThrow&&util.isError(actual)&&userProvidedMessage&&expectedException(actual,expected)||isUnexpectedException)&&fail(actual,expected,"Got unwanted exception"+message),shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual)throw actual}assert.AssertionError=function(options){var self;this.name="AssertionError",this.actual=options.actual,this.expected=options.expected,this.operator=options.operator,options.message?(this.message=options.message,this.generatedMessage=!1):(this.message=truncate(inspect((self=this).actual),128)+" "+self.operator+" "+truncate(inspect(self.expected),128),this.generatedMessage=!0);var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace)Error.captureStackTrace(this,stackStartFunction);else{var err=new Error;if(err.stack){var out=err.stack,fn_name=getName(stackStartFunction),idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}},util.inherits(assert.AssertionError,Error),assert.fail=fail,assert.ok=ok,assert.equal=function(actual,expected,message){actual!=expected&&fail(actual,expected,message,"==",assert.equal)},assert.notEqual=function(actual,expected,message){actual==expected&&fail(actual,expected,message,"!=",assert.notEqual)},assert.deepEqual=function(actual,expected,message){_deepEqual(actual,expected,!1)||fail(actual,expected,message,"deepEqual",assert.deepEqual)},assert.deepStrictEqual=function(actual,expected,message){_deepEqual(actual,expected,!0)||fail(actual,expected,message,"deepStrictEqual",assert.deepStrictEqual)},assert.notDeepEqual=function(actual,expected,message){_deepEqual(actual,expected,!1)&&fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)},assert.notDeepStrictEqual=function notDeepStrictEqual(actual,expected,message){_deepEqual(actual,expected,!0)&&fail(actual,expected,message,"notDeepStrictEqual",notDeepStrictEqual)},assert.strictEqual=function(actual,expected,message){actual!==expected&&fail(actual,expected,message,"===",assert.strictEqual)},assert.notStrictEqual=function(actual,expected,message){actual===expected&&fail(actual,expected,message,"!==",assert.notStrictEqual)},assert.throws=function(block,error,message){_throws(!0,block,error,message)},assert.doesNotThrow=function(block,error,message){_throws(!1,block,error,message)},assert.ifError=function(err){if(err)throw err};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)hasOwn.call(obj,key)&&keys.push(key);return keys}}).call(this,__webpack_require__(2))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var ltgt__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(117),ltgt__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(ltgt__WEBPACK_IMPORTED_MODULE_0__),inherits__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(62),inherits__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(inherits__WEBPACK_IMPORTED_MODULE_1__),events__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(61),events__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(events__WEBPACK_IMPORTED_MODULE_2__),readable_stream__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(118),readable_stream__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(readable_stream__WEBPACK_IMPORTED_MODULE_3__),level_codec__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(130),level_codec__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(level_codec__WEBPACK_IMPORTED_MODULE_4__);function getPrefix(db){return"function"==typeof db.prefix?db.prefix():db}function NotFoundError(){Error.call(this)}inherits__WEBPACK_IMPORTED_MODULE_1___default()(NotFoundError,Error),NotFoundError.prototype.name="NotFoundError";var EventEmitter=events__WEBPACK_IMPORTED_MODULE_2___default.a.EventEmitter,NOT_FOUND_ERROR=new NotFoundError,sublevel=function(nut,prefix,createStream,options){var emitter=new EventEmitter;function mergeOpts(opts){var k,o={};if(options)for(k in options)void 0!==options[k]&&(o[k]=options[k]);if(opts)for(k in opts)void 0!==opts[k]&&(o[k]=opts[k]);return o}return emitter.sublevels={},emitter.options=options,emitter.version="6.5.4",emitter.methods={},prefix=prefix||[],emitter.put=function(key,value,opts,cb){"function"==typeof opts&&(cb=opts,opts={}),nut.apply([{key:key,value:value,prefix:prefix.slice(),type:"put"}],mergeOpts(opts),function(err){if(err)return cb(err);emitter.emit("put",key,value),cb(null)})},emitter.prefix=function(){return prefix.slice()},emitter.batch=function(ops,opts,cb){"function"==typeof opts&&(cb=opts,opts={}),ops=ops.map(function(op){return{key:op.key,value:op.value,prefix:op.prefix||prefix,keyEncoding:op.keyEncoding,valueEncoding:op.valueEncoding,type:op.type}}),nut.apply(ops,mergeOpts(opts),function(err){if(err)return cb(err);emitter.emit("batch",ops),cb(null)})},emitter.get=function(key,opts,cb){"function"==typeof opts&&(cb=opts,opts={}),nut.get(key,prefix,mergeOpts(opts),function(err,value){err?cb(NOT_FOUND_ERROR):cb(null,value)})},emitter.sublevel=function(name,opts){return emitter.sublevels[name]=emitter.sublevels[name]||sublevel(nut,prefix.concat(name),createStream,mergeOpts(opts))},emitter.readStream=emitter.createReadStream=function(opts){var stream;(opts=mergeOpts(opts)).prefix=prefix;var it=nut.iterator(opts);return(stream=createStream(opts,nut.createDecoder(opts))).setIterator(it),stream},emitter.close=function(cb){nut.close(cb)},emitter.isOpen=nut.isOpen,emitter.isClosed=nut.isClosed,emitter},Readable=readable_stream__WEBPACK_IMPORTED_MODULE_3___default.a.Readable;function ReadStream(options,makeData){if(!(this instanceof ReadStream))return new ReadStream(options,makeData);Readable.call(this,{objectMode:!0,highWaterMark:options.highWaterMark}),this._waiting=!1,this._options=options,this._makeData=makeData}inherits__WEBPACK_IMPORTED_MODULE_1___default()(ReadStream,Readable),ReadStream.prototype.setIterator=function(it){return this._iterator=it,this._destroyed?it.end(function(){}):this._waiting?(this._waiting=!1,this._read()):this},ReadStream.prototype._read=function(){var self=this;if(!self._destroyed)return self._iterator?void self._iterator.next(function(err,key,value){if(err||void 0===key&&void 0===value)return err||self._destroyed||self.push(null),self._cleanup(err);value=self._makeData(key,value),self._destroyed||self.push(value)}):this._waiting=!0},ReadStream.prototype._cleanup=function(err){if(!this._destroyed){this._destroyed=!0;var self=this;err&&"iterator has ended"!==err.message&&self.emit("error",err),self._iterator?self._iterator.end(function(){self._iterator=null,self.emit("close")}):self.emit("close")}},ReadStream.prototype.destroy=function(){this._cleanup()};var precodec={encode:function(decodedKey){return"ÿ"+decodedKey[0]+"ÿ"+decodedKey[1]},decode:function(encodedKeyAsBuffer){var str=encodedKeyAsBuffer.toString(),idx=str.indexOf("ÿ",1);return[str.substring(1,idx),str.substring(idx+1)]},lowerBound:"\0",upperBound:"ÿ"},codec=new level_codec__WEBPACK_IMPORTED_MODULE_4___default.a;__webpack_exports__.default=function(db){return sublevel(function(db,precodec,codec){function encodePrefix(prefix,key,opts1,opts2){return precodec.encode([prefix,codec.encodeKey(key,opts1,opts2)])}function addEncodings(op,prefix){return prefix&&prefix.options&&(op.keyEncoding=op.keyEncoding||prefix.options.keyEncoding,op.valueEncoding=op.valueEncoding||prefix.options.valueEncoding),op}return db.open(function(){}),{apply:function(ops,opts,cb){opts=opts||{};for(var batch=[],i=-1,len=ops.length;++i<len;){var op=ops[i];addEncodings(op,op.prefix),op.prefix=getPrefix(op.prefix),batch.push({key:encodePrefix(op.prefix,op.key,opts,op),value:"del"!==op.type&&codec.encodeValue(op.value,opts,op),type:op.type})}db.db.batch(batch,opts,cb)},get:function(key,prefix,opts,cb){return opts.asBuffer=codec.valueAsBuffer(opts),db.db.get(encodePrefix(prefix,key,opts),opts,function(err,value){err?cb(err):cb(null,codec.decodeValue(value,opts))})},createDecoder:function(opts){return function(key,value){return{key:codec.decodeKey(precodec.decode(key)[1],opts),value:codec.decodeValue(value,opts)}}},isClosed:function(){return db.isClosed()},close:function(cb){return db.close(cb)},iterator:function(_opts){var iterator,opts=function(_obj){var obj={};for(var k in _obj)obj[k]=_obj[k];return obj}(_opts||{}),prefix=_opts.prefix||[];return ltgt__WEBPACK_IMPORTED_MODULE_0___default.a.toLtgt(_opts,opts,function(key){return encodePrefix(prefix,key,opts,{})},precodec.lowerBound,precodec.upperBound),opts.prefix=null,opts.keyAsBuffer=opts.valueAsBuffer=!1,"number"!=typeof opts.limit&&(opts.limit=-1),opts.keyAsBuffer=precodec.buffer,opts.valueAsBuffer=codec.valueAsBuffer(opts),iterator=db.db.iterator(opts),{next:function(cb){return iterator.next(cb)},end:function(cb){iterator.end(cb)}}}}}(db,precodec,codec),[],ReadStream,db.options)}},function(module,exports,__webpack_require__){(function(Buffer){function isDef(val){return void 0!==val&&""!==val}function has(range,name){return Object.hasOwnProperty.call(range,name)}function hasKey(range,name){return Object.hasOwnProperty.call(range,name)&&name}exports.compare=function(a,b){if(Buffer.isBuffer(a)){for(var l=Math.min(a.length,b.length),i=0;i<l;i++){var cmp=a[i]-b[i];if(cmp)return cmp}return a.length-b.length}return a<b?-1:a>b?1:0};var lowerBoundKey=exports.lowerBoundKey=function(range){return hasKey(range,"gt")||hasKey(range,"gte")||hasKey(range,"min")||(range.reverse?hasKey(range,"end"):hasKey(range,"start"))||void 0},lowerBound=exports.lowerBound=function(range,def){var k=lowerBoundKey(range);return k?range[k]:def},lowerBoundInclusive=exports.lowerBoundInclusive=function(range){return!has(range,"gt")},upperBoundInclusive=exports.upperBoundInclusive=function(range){return!has(range,"lt")},lowerBoundExclusive=exports.lowerBoundExclusive=function(range){return!lowerBoundInclusive(range)},upperBoundExclusive=exports.upperBoundExclusive=function(range){return!upperBoundInclusive(range)},upperBoundKey=exports.upperBoundKey=function(range){return hasKey(range,"lt")||hasKey(range,"lte")||hasKey(range,"max")||(range.reverse?hasKey(range,"start"):hasKey(range,"end"))||void 0},upperBound=exports.upperBound=function(range,def){var k=upperBoundKey(range);return k?range[k]:def};function id(e){return e}exports.start=function(range,def){return range.reverse?upperBound(range,def):lowerBound(range,def)},exports.end=function(range,def){return range.reverse?lowerBound(range,def):upperBound(range,def)},exports.startInclusive=function(range){return range.reverse?upperBoundInclusive(range):lowerBoundInclusive(range)},exports.endInclusive=function(range){return range.reverse?lowerBoundInclusive(range):upperBoundInclusive(range)},exports.toLtgt=function(range,_range,map,lower,upper){_range=_range||{},map=map||id;var defaults=arguments.length>3,lb=exports.lowerBoundKey(range),ub=exports.upperBoundKey(range);return lb?"gt"===lb?_range.gt=map(range.gt,!1):_range.gte=map(range[lb],!1):defaults&&(_range.gte=map(lower,!1)),ub?"lt"===ub?_range.lt=map(range.lt,!0):_range.lte=map(range[ub],!0):defaults&&(_range.lte=map(upper,!0)),null!=range.reverse&&(_range.reverse=!!range.reverse),has(_range,"max")&&delete _range.max,has(_range,"min")&&delete _range.min,has(_range,"start")&&delete _range.start,has(_range,"end")&&delete _range.end,_range},exports.contains=function(range,key,compare){compare=compare||exports.compare;var lb=lowerBound(range);if(isDef(lb)&&((cmp=compare(key,lb))<0||0===cmp&&lowerBoundExclusive(range)))return!1;var cmp,ub=upperBound(range);if(isDef(ub)&&((cmp=compare(key,ub))>0||0===cmp&&upperBoundExclusive(range)))return!1;return!0},exports.filter=function(range,compare){return function(key){return exports.contains(range,key,compare)}}}).call(this,__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){var Stream=__webpack_require__(119);(exports=module.exports=__webpack_require__(124)).Stream=Stream,exports.Readable=exports,exports.Writable=__webpack_require__(126),exports.Duplex=__webpack_require__(127),exports.Transform=__webpack_require__(128),exports.PassThrough=__webpack_require__(129)},function(module,exports,__webpack_require__){module.exports=Stream;var EE=__webpack_require__(61).EventEmitter;function Stream(){EE.call(this)}__webpack_require__(62)(Stream,EE),Stream.Readable=__webpack_require__(92),Stream.Writable=__webpack_require__(120),Stream.Duplex=__webpack_require__(121),Stream.Transform=__webpack_require__(122),Stream.PassThrough=__webpack_require__(123),Stream.Stream=Stream,Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){dest.writable&&!1===dest.write(chunk)&&source.pause&&source.pause()}function ondrain(){source.readable&&source.resume&&source.resume()}source.on("data",ondata),dest.on("drain",ondrain),dest._isStdio||options&&!1===options.end||(source.on("end",onend),source.on("close",onclose));var didOnEnd=!1;function onend(){didOnEnd||(didOnEnd=!0,dest.end())}function onclose(){didOnEnd||(didOnEnd=!0,"function"==typeof dest.destroy&&dest.destroy())}function onerror(er){if(cleanup(),0===EE.listenerCount(this,"error"))throw er}function cleanup(){source.removeListener("data",ondata),dest.removeListener("drain",ondrain),source.removeListener("end",onend),source.removeListener("close",onclose),source.removeListener("error",onerror),dest.removeListener("error",onerror),source.removeListener("end",cleanup),source.removeListener("close",cleanup),dest.removeListener("close",cleanup)}return source.on("error",onerror),dest.on("error",onerror),source.on("end",cleanup),source.on("close",cleanup),dest.on("close",cleanup),dest.emit("pipe",source),dest}},function(module,exports,__webpack_require__){module.exports=__webpack_require__(102)},function(module,exports,__webpack_require__){module.exports=__webpack_require__(101)},function(module,exports,__webpack_require__){module.exports=__webpack_require__(92).Transform},function(module,exports,__webpack_require__){module.exports=__webpack_require__(92).PassThrough},function(module,exports,__webpack_require__){(function(process){module.exports=Readable;var isArray=__webpack_require__(125),Buffer=__webpack_require__(84).Buffer;Readable.ReadableState=ReadableState;var EE=__webpack_require__(61).EventEmitter;EE.listenerCount||(EE.listenerCount=function(emitter,type){return emitter.listeners(type).length});var StringDecoder,Stream=__webpack_require__(119),util=__webpack_require__(97);function ReadableState(options,stream){var hwm=(options=options||{}).highWaterMark;this.highWaterMark=hwm||0===hwm?hwm:16384,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=!1,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.calledRead=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.objectMode=!!options.objectMode,this.defaultEncoding=options.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,options.encoding&&(StringDecoder||(StringDecoder=__webpack_require__(106).StringDecoder),this.decoder=new StringDecoder(options.encoding),this.encoding=options.encoding)}function Readable(options){if(!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this),this.readable=!0,Stream.call(this)}function readableAddChunk(stream,state,chunk,encoding,addToFront){var er=function(state,chunk){var er=null;Buffer.isBuffer(chunk)||"string"==typeof chunk||null==chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk"));return er}(state,chunk);if(er)stream.emit("error",er);else if(null==chunk)state.reading=!1,state.ended||function(stream,state){if(state.decoder&&!state.ended){var chunk=state.decoder.end();chunk&&chunk.length&&(state.buffer.push(chunk),state.length+=state.objectMode?1:chunk.length)}state.ended=!0,state.length>0?emitReadable(stream):endReadable(stream)}(stream,state);else if(state.objectMode||chunk&&chunk.length>0)if(state.ended&&!addToFront){var e=new Error("stream.push() after EOF");stream.emit("error",e)}else if(state.endEmitted&&addToFront){e=new Error("stream.unshift() after end event");stream.emit("error",e)}else!state.decoder||addToFront||encoding||(chunk=state.decoder.write(chunk)),state.length+=state.objectMode?1:chunk.length,addToFront?state.buffer.unshift(chunk):(state.reading=!1,state.buffer.push(chunk)),state.needReadable&&emitReadable(stream),function(stream,state){state.readingMore||(state.readingMore=!0,process.nextTick(function(){!function(stream,state){var len=state.length;for(;!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark&&(stream.read(0),len!==state.length);)len=state.length;state.readingMore=!1}(stream,state)}))}(stream,state);else addToFront||(state.reading=!1);return function(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||0===state.length)}(state)}util.inherits=__webpack_require__(62),util.inherits(Readable,Stream),Readable.prototype.push=function(chunk,encoding){var state=this._readableState;return"string"!=typeof chunk||state.objectMode||(encoding=encoding||state.defaultEncoding)!==state.encoding&&(chunk=new Buffer(chunk,encoding),encoding=""),readableAddChunk(this,state,chunk,encoding,!1)},Readable.prototype.unshift=function(chunk){return readableAddChunk(this,this._readableState,chunk,"",!0)},Readable.prototype.setEncoding=function(enc){StringDecoder||(StringDecoder=__webpack_require__(106).StringDecoder),this._readableState.decoder=new StringDecoder(enc),this._readableState.encoding=enc};var MAX_HWM=8388608;function howMuchToRead(n,state){return 0===state.length&&state.ended?0:state.objectMode?0===n?0:1:null===n||isNaN(n)?state.flowing&&state.buffer.length?state.buffer[0].length:state.length:n<=0?0:(n>state.highWaterMark&&(state.highWaterMark=function(n){if(n>=MAX_HWM)n=MAX_HWM;else{n--;for(var p=1;p<32;p<<=1)n|=n>>p;n++}return n}(n)),n>state.length?state.ended?state.length:(state.needReadable=!0,0):n)}function emitReadable(stream){var state=stream._readableState;state.needReadable=!1,state.emittedReadable||(state.emittedReadable=!0,state.sync?process.nextTick(function(){emitReadable_(stream)}):emitReadable_(stream))}function emitReadable_(stream){stream.emit("readable")}function flow(src){var chunk,state=src._readableState;function write(dest,i,list){!1===dest.write(chunk)&&state.awaitDrain++}for(state.awaitDrain=0;state.pipesCount&&null!==(chunk=src.read());)if(1===state.pipesCount?write(state.pipes):forEach(state.pipes,write),src.emit("data",chunk),state.awaitDrain>0)return;if(0===state.pipesCount)return state.flowing=!1,void(EE.listenerCount(src,"data")>0&&emitDataEvents(src));state.ranOut=!0}function pipeOnReadable(){this._readableState.ranOut&&(this._readableState.ranOut=!1,flow(this))}function emitDataEvents(stream,startPaused){if(stream._readableState.flowing)throw new Error("Cannot switch to old mode now.");var paused=startPaused||!1,readable=!1;stream.readable=!0,stream.pipe=Stream.prototype.pipe,stream.on=stream.addListener=Stream.prototype.on,stream.on("readable",function(){var c;for(readable=!0;!paused&&null!==(c=stream.read());)stream.emit("data",c);null===c&&(readable=!1,stream._readableState.needReadable=!0)}),stream.pause=function(){paused=!0,this.emit("pause")},stream.resume=function(){paused=!1,readable?process.nextTick(function(){stream.emit("readable")}):this.read(0),this.emit("resume")},stream.emit("readable")}function fromList(n,state){var ret,list=state.buffer,length=state.length,stringMode=!!state.decoder,objectMode=!!state.objectMode;if(0===list.length)return null;if(0===length)ret=null;else if(objectMode)ret=list.shift();else if(!n||n>=length)ret=stringMode?list.join(""):Buffer.concat(list,length),list.length=0;else{if(n<list[0].length)ret=(buf=list[0]).slice(0,n),list[0]=buf.slice(n);else if(n===list[0].length)ret=list.shift();else{ret=stringMode?"":new Buffer(n);for(var c=0,i=0,l=list.length;i<l&&c<n;i++){var buf=list[0],cpy=Math.min(n-c,buf.length);stringMode?ret+=buf.slice(0,cpy):buf.copy(ret,c,0,cpy),cpy<buf.length?list[0]=buf.slice(cpy):list.shift(),c+=cpy}}}return ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error("endReadable called on non-empty stream");!state.endEmitted&&state.calledRead&&(state.ended=!0,process.nextTick(function(){state.endEmitted||0!==state.length||(state.endEmitted=!0,stream.readable=!1,stream.emit("end"))}))}function forEach(xs,f){for(var i=0,l=xs.length;i<l;i++)f(xs[i],i)}Readable.prototype.read=function(n){var state=this._readableState;state.calledRead=!0;var ret,nOrig=n;if(("number"!=typeof n||n>0)&&(state.emittedReadable=!1),0===n&&state.needReadable&&(state.length>=state.highWaterMark||state.ended))return emitReadable(this),null;if(0===(n=howMuchToRead(n,state))&&state.ended)return ret=null,state.length>0&&state.decoder&&(ret=fromList(n,state),state.length-=ret.length),0===state.length&&endReadable(this),ret;var doRead=state.needReadable;return state.length-n<=state.highWaterMark&&(doRead=!0),(state.ended||state.reading)&&(doRead=!1),doRead&&(state.reading=!0,state.sync=!0,0===state.length&&(state.needReadable=!0),this._read(state.highWaterMark),state.sync=!1),doRead&&!state.reading&&(n=howMuchToRead(nOrig,state)),null===(ret=n>0?fromList(n,state):null)&&(state.needReadable=!0,n=0),state.length-=n,0!==state.length||state.ended||(state.needReadable=!0),state.ended&&!state.endEmitted&&0===state.length&&endReadable(this),ret},Readable.prototype._read=function(n){this.emit("error",new Error("not implemented"))},Readable.prototype.pipe=function(dest,pipeOpts){var src=this,state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest)}state.pipesCount+=1;var endFn=(!pipeOpts||!1!==pipeOpts.end)&&dest!==process.stdout&&dest!==process.stderr?onend:cleanup;function onunpipe(readable){readable===src&&cleanup()}function onend(){dest.end()}state.endEmitted?process.nextTick(endFn):src.once("end",endFn),dest.on("unpipe",onunpipe);var ondrain=function(src){return function(){var state=src._readableState;state.awaitDrain--,0===state.awaitDrain&&flow(src)}}(src);function cleanup(){dest.removeListener("close",onclose),dest.removeListener("finish",onfinish),dest.removeListener("drain",ondrain),dest.removeListener("error",onerror),dest.removeListener("unpipe",onunpipe),src.removeListener("end",onend),src.removeListener("end",cleanup),dest._writableState&&!dest._writableState.needDrain||ondrain()}function onerror(er){unpipe(),dest.removeListener("error",onerror),0===EE.listenerCount(dest,"error")&&dest.emit("error",er)}function onclose(){dest.removeListener("finish",onfinish),unpipe()}function onfinish(){dest.removeListener("close",onclose),unpipe()}function unpipe(){src.unpipe(dest)}return dest.on("drain",ondrain),dest._events&&dest._events.error?isArray(dest._events.error)?dest._events.error.unshift(onerror):dest._events.error=[onerror,dest._events.error]:dest.on("error",onerror),dest.once("close",onclose),dest.once("finish",onfinish),dest.emit("pipe",src),state.flowing||(this.on("readable",pipeOnReadable),state.flowing=!0,process.nextTick(function(){flow(src)})),dest},Readable.prototype.unpipe=function(dest){var state=this._readableState;if(0===state.pipesCount)return this;if(1===state.pipesCount)return dest&&dest!==state.pipes?this:(dest||(dest=state.pipes),state.pipes=null,state.pipesCount=0,this.removeListener("readable",pipeOnReadable),state.flowing=!1,dest&&dest.emit("unpipe",this),this);if(!dest){var dests=state.pipes,len=state.pipesCount;state.pipes=null,state.pipesCount=0,this.removeListener("readable",pipeOnReadable),state.flowing=!1;for(var i=0;i<len;i++)dests[i].emit("unpipe",this);return this}return-1===(i=function(xs,x){for(var i=0,l=xs.length;i<l;i++)if(xs[i]===x)return i;return-1}(state.pipes,dest))?this:(state.pipes.splice(i,1),state.pipesCount-=1,1===state.pipesCount&&(state.pipes=state.pipes[0]),dest.emit("unpipe",this),this)},Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if("data"!==ev||this._readableState.flowing||emitDataEvents(this),"readable"===ev&&this.readable){var state=this._readableState;state.readableListening||(state.readableListening=!0,state.emittedReadable=!1,state.needReadable=!0,state.reading?state.length&&emitReadable(this):this.read(0))}return res},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){emitDataEvents(this),this.read(0),this.emit("resume")},Readable.prototype.pause=function(){emitDataEvents(this,!0),this.emit("pause")},Readable.prototype.wrap=function(stream){var state=this._readableState,paused=!1,self=this;for(var i in stream.on("end",function(){if(state.decoder&&!state.ended){var chunk=state.decoder.end();chunk&&chunk.length&&self.push(chunk)}self.push(null)}),stream.on("data",function(chunk){(state.decoder&&(chunk=state.decoder.write(chunk)),state.objectMode&&null==chunk)||(state.objectMode||chunk&&chunk.length)&&(self.push(chunk)||(paused=!0,stream.pause()))}),stream)"function"==typeof stream[i]&&void 0===this[i]&&(this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i));return forEach(["error","close","destroy","pause","resume"],function(ev){stream.on(ev,self.emit.bind(self,ev))}),self._read=function(n){paused&&(paused=!1,stream.resume())},self},Readable._fromList=fromList}).call(this,__webpack_require__(53))},function(module,exports){module.exports=Array.isArray||function(arr){return"[object Array]"==Object.prototype.toString.call(arr)}},function(module,exports,__webpack_require__){(function(process){module.exports=Writable;var Buffer=__webpack_require__(84).Buffer;Writable.WritableState=WritableState;var util=__webpack_require__(97);util.inherits=__webpack_require__(62);var Stream=__webpack_require__(119);function WriteReq(chunk,encoding,cb){this.chunk=chunk,this.encoding=encoding,this.callback=cb}function WritableState(options,stream){var hwm=(options=options||{}).highWaterMark;this.highWaterMark=hwm||0===hwm?hwm:16384,this.objectMode=!!options.objectMode,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var noDecode=!1===options.decodeStrings;this.decodeStrings=!noDecode,this.defaultEncoding=options.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(er){!function(stream,er){var state=stream._writableState,sync=state.sync,cb=state.writecb;if(function(state){state.writing=!1,state.writecb=null,state.length-=state.writelen,state.writelen=0}(state),er)!function(stream,state,sync,er,cb){sync?process.nextTick(function(){cb(er)}):cb(er);stream._writableState.errorEmitted=!0,stream.emit("error",er)}(stream,0,sync,er,cb);else{var finished=needFinish(stream,state);finished||state.bufferProcessing||!state.buffer.length||function(stream,state){state.bufferProcessing=!0;for(var c=0;c<state.buffer.length;c++){var entry=state.buffer[c],chunk=entry.chunk,encoding=entry.encoding,cb=entry.callback,len=state.objectMode?1:chunk.length;if(doWrite(stream,state,len,chunk,encoding,cb),state.writing){c++;break}}state.bufferProcessing=!1,c<state.buffer.length?state.buffer=state.buffer.slice(c):state.buffer.length=0}(stream,state),sync?process.nextTick(function(){afterWrite(stream,state,finished,cb)}):afterWrite(stream,state,finished,cb)}}(stream,er)},this.writecb=null,this.writelen=0,this.buffer=[],this.errorEmitted=!1}function Writable(options){var Duplex=__webpack_require__(127);if(!(this instanceof Writable||this instanceof Duplex))return new Writable(options);this._writableState=new WritableState(options,this),this.writable=!0,Stream.call(this)}function doWrite(stream,state,len,chunk,encoding,cb){state.writelen=len,state.writecb=cb,state.writing=!0,state.sync=!0,stream._write(chunk,encoding,state.onwrite),state.sync=!1}function afterWrite(stream,state,finished,cb){finished||function(stream,state){0===state.length&&state.needDrain&&(state.needDrain=!1,stream.emit("drain"))}(stream,state),cb(),finished&&finishMaybe(stream,state)}function needFinish(stream,state){return state.ending&&0===state.length&&!state.finished&&!state.writing}function finishMaybe(stream,state){var need=needFinish(0,state);return need&&(state.finished=!0,stream.emit("finish")),need}util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState,ret=!1;return"function"==typeof encoding&&(cb=encoding,encoding=null),Buffer.isBuffer(chunk)?encoding="buffer":encoding||(encoding=state.defaultEncoding),"function"!=typeof cb&&(cb=function(){}),state.ended?function(stream,state,cb){var er=new Error("write after end");stream.emit("error",er),process.nextTick(function(){cb(er)})}(this,0,cb):function(stream,state,chunk,cb){var valid=!0;if(!Buffer.isBuffer(chunk)&&"string"!=typeof chunk&&null!=chunk&&!state.objectMode){var er=new TypeError("Invalid non-string/buffer chunk");stream.emit("error",er),process.nextTick(function(){cb(er)}),valid=!1}return valid}(this,state,chunk,cb)&&(ret=function(stream,state,chunk,encoding,cb){chunk=function(state,chunk,encoding){return state.objectMode||!1===state.decodeStrings||"string"!=typeof chunk||(chunk=new Buffer(chunk,encoding)),chunk}(state,chunk,encoding),Buffer.isBuffer(chunk)&&(encoding="buffer");var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;ret||(state.needDrain=!0);state.writing?state.buffer.push(new WriteReq(chunk,encoding,cb)):doWrite(stream,state,len,chunk,encoding,cb);return ret}(this,state,chunk,encoding,cb)),ret},Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("not implemented"))},Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;"function"==typeof chunk?(cb=chunk,chunk=null,encoding=null):"function"==typeof encoding&&(cb=encoding,encoding=null),null!=chunk&&this.write(chunk,encoding),state.ending||state.finished||function(stream,state,cb){state.ending=!0,finishMaybe(stream,state),cb&&(state.finished?process.nextTick(cb):stream.once("finish",cb));state.ended=!0}(this,state,cb)}}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){(function(process){module.exports=Duplex;var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)keys.push(key);return keys},util=__webpack_require__(97);util.inherits=__webpack_require__(62);var Readable=__webpack_require__(124),Writable=__webpack_require__(126);function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options),Writable.call(this,options),options&&!1===options.readable&&(this.readable=!1),options&&!1===options.writable&&(this.writable=!1),this.allowHalfOpen=!0,options&&!1===options.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",onend)}function onend(){this.allowHalfOpen||this._writableState.ended||process.nextTick(this.end.bind(this))}util.inherits(Duplex,Readable),function(xs,f){for(var i=0,l=xs.length;i<l;i++)f(xs[i],i)}(objectKeys(Writable.prototype),function(method){Duplex.prototype[method]||(Duplex.prototype[method]=Writable.prototype[method])})}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){module.exports=Transform;var Duplex=__webpack_require__(127),util=__webpack_require__(97);function TransformState(options,stream){this.afterTransform=function(er,data){return function(stream,er,data){var ts=stream._transformState;ts.transforming=!1;var cb=ts.writecb;if(!cb)return stream.emit("error",new Error("no writecb in Transform class"));ts.writechunk=null,ts.writecb=null,null!=data&&stream.push(data);cb&&cb(er);var rs=stream._readableState;rs.reading=!1,(rs.needReadable||rs.length<rs.highWaterMark)&&stream._read(rs.highWaterMark)}(stream,er,data)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options);this._transformState=new TransformState(options,this);var stream=this;this._readableState.needReadable=!0,this._readableState.sync=!1,this.once("finish",function(){"function"==typeof this._flush?this._flush(function(er){done(stream,er)}):done(stream)})}function done(stream,er){if(er)return stream.emit("error",er);var ws=stream._writableState,ts=(stream._readableState,stream._transformState);if(ws.length)throw new Error("calling transform done when ws.length != 0");if(ts.transforming)throw new Error("calling transform done when still transforming");return stream.push(null)}util.inherits=__webpack_require__(62),util.inherits(Transform,Duplex),Transform.prototype.push=function(chunk,encoding){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,chunk,encoding)},Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("not implemented")},Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;if(ts.writecb=cb,ts.writechunk=chunk,ts.writeencoding=encoding,!ts.transforming){var rs=this._readableState;(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}},Transform.prototype._read=function(n){var ts=this._transformState;null!==ts.writechunk&&ts.writecb&&!ts.transforming?(ts.transforming=!0,this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)):ts.needTransform=!0}},function(module,exports,__webpack_require__){module.exports=PassThrough;var Transform=__webpack_require__(128),util=__webpack_require__(97);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}util.inherits=__webpack_require__(62),util.inherits(PassThrough,Transform),PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)}},function(module,exports,__webpack_require__){var encodings=__webpack_require__(131);function Codec(opts){this.opts=opts||{},this.encodings=encodings}module.exports=Codec,Codec.prototype._encoding=function(encoding){return"string"==typeof encoding&&(encoding=encodings[encoding]),encoding||(encoding=encodings.id),encoding},Codec.prototype._keyEncoding=function(opts,batchOpts){return this._encoding(batchOpts&&batchOpts.keyEncoding||opts&&opts.keyEncoding||this.opts.keyEncoding)},Codec.prototype._valueEncoding=function(opts,batchOpts){return this._encoding(batchOpts&&(batchOpts.valueEncoding||batchOpts.encoding)||opts&&(opts.valueEncoding||opts.encoding)||this.opts.valueEncoding||this.opts.encoding)},Codec.prototype.encodeKey=function(key,opts,batchOpts){return this._keyEncoding(opts,batchOpts).encode(key)},Codec.prototype.encodeValue=function(value,opts,batchOpts){return this._valueEncoding(opts,batchOpts).encode(value)},Codec.prototype.decodeKey=function(key,opts){return this._keyEncoding(opts).decode(key)},Codec.prototype.decodeValue=function(value,opts){return this._valueEncoding(opts).decode(value)},Codec.prototype.encodeBatch=function(ops,opts){var self=this;return ops.map(function(_op){var op={type:_op.type,key:self.encodeKey(_op.key,opts,_op)};return self.keyAsBuffer(opts,_op)&&(op.keyEncoding="binary"),_op.prefix&&(op.prefix=_op.prefix),"value"in _op&&(op.value=self.encodeValue(_op.value,opts,_op),self.valueAsBuffer(opts,_op)&&(op.valueEncoding="binary")),op})};var ltgtKeys=["lt","gt","lte","gte","start","end"];Codec.prototype.encodeLtgt=function(ltgt){var self=this,ret={};return Object.keys(ltgt).forEach(function(key){ret[key]=ltgtKeys.indexOf(key)>-1?self.encodeKey(ltgt[key],ltgt):ltgt[key]}),ret},Codec.prototype.createStreamDecoder=function(opts){var self=this;return opts.keys&&opts.values?function(key,value){return{key:self.decodeKey(key,opts),value:self.decodeValue(value,opts)}}:opts.keys?function(key){return self.decodeKey(key,opts)}:opts.values?function(_,value){return self.decodeValue(value,opts)}:function(){}},Codec.prototype.keyAsBuffer=function(opts){return this._keyEncoding(opts).buffer},Codec.prototype.valueAsBuffer=function(opts){return this._valueEncoding(opts).buffer}},function(module,exports,__webpack_require__){(function(Buffer){exports.utf8=exports["utf-8"]={encode:function(data){return isBinary(data)?data:String(data)},decode:function(data){return"string"==typeof data?data:String(data)},buffer:!1,type:"utf8"},exports.json={encode:JSON.stringify,decode:JSON.parse,buffer:!1,type:"json"},exports.binary={encode:function(data){return isBinary(data)?data:new Buffer(data)},decode:identity,buffer:!0,type:"binary"},exports.none={encode:identity,decode:identity,buffer:!1,type:"id"},exports.id=exports.none;function identity(value){return value}function isBinary(data){return null==data||Buffer.isBuffer(data)}["hex","ascii","base64","ucs2","ucs-2","utf16le","utf-16le"].forEach(function(type){exports[type]={encode:function(data){return isBinary(data)?data:new Buffer(data,type)},decode:function(buffer){return buffer.toString(type)},buffer:!0,type:type}})}).call(this,__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){(function(process){var Transform=__webpack_require__(122),inherits=__webpack_require__(78).inherits,xtend=__webpack_require__(80);function DestroyableTransform(opts){Transform.call(this,opts),this._destroyed=!1}function noop(chunk,enc,callback){callback(null,chunk)}function through2(construct){return function(options,transform,flush){return"function"==typeof options&&(flush=transform,transform=options,options={}),"function"!=typeof transform&&(transform=noop),"function"!=typeof flush&&(flush=null),construct(options,transform,flush)}}inherits(DestroyableTransform,Transform),DestroyableTransform.prototype.destroy=function(err){if(!this._destroyed){this._destroyed=!0;var self=this;process.nextTick(function(){err&&self.emit("error",err),self.emit("close")})}},module.exports=through2(function(options,transform,flush){var t2=new DestroyableTransform(options);return t2._transform=transform,flush&&(t2._flush=flush),t2}),module.exports.ctor=through2(function(options,transform,flush){function Through2(override){if(!(this instanceof Through2))return new Through2(override);this.options=xtend(options,override),DestroyableTransform.call(this,this.options)}return inherits(Through2,DestroyableTransform),Through2.prototype._transform=transform,flush&&(Through2.prototype._flush=flush),Through2}),module.exports.obj=through2(function(options,transform,flush){var t2=new DestroyableTransform(xtend({objectMode:!0,highWaterMark:16},options));return t2._transform=transform,flush&&(t2._flush=flush),t2})}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){"use strict";function Deque(capacity){if(this._capacity=getCapacity(capacity),this._length=0,this._front=0,isArray(capacity)){for(var len=capacity.length,i=0;i<len;++i)this[i]=capacity[i];this._length=len}}Deque.prototype.toArray=function(){for(var len=this._length,ret=new Array(len),front=this._front,capacity=this._capacity,j=0;j<len;++j)ret[j]=this[front+j&capacity-1];return ret},Deque.prototype.push=function(item){var argsLength=arguments.length,length=this._length;if(argsLength>1){var capacity=this._capacity;if(length+argsLength>capacity){for(var i=0;i<argsLength;++i){this._checkCapacity(length+1),this[j=this._front+length&this._capacity-1]=arguments[i],length++,this._length=length}return length}for(var j=this._front,i=0;i<argsLength;++i)this[j+length&capacity-1]=arguments[i],j++;return this._length=length+argsLength,length+argsLength}return 0===argsLength?length:(this._checkCapacity(length+1),this[i=this._front+length&this._capacity-1]=item,this._length=length+1,length+1)},Deque.prototype.pop=function(){var length=this._length;if(0!==length){var i=this._front+length-1&this._capacity-1,ret=this[i];return this[i]=void 0,this._length=length-1,ret}},Deque.prototype.shift=function(){var length=this._length;if(0!==length){var front=this._front,ret=this[front];return this[front]=void 0,this._front=front+1&this._capacity-1,this._length=length-1,ret}},Deque.prototype.unshift=function(item){var length=this._length,argsLength=arguments.length;if(argsLength>1){if(length+argsLength>(capacity=this._capacity)){for(var i=argsLength-1;i>=0;i--){this._checkCapacity(length+1);var capacity=this._capacity;this[j=(this._front-1&capacity-1^capacity)-capacity]=arguments[i],length++,this._length=length,this._front=j}return length}var front=this._front;for(i=argsLength-1;i>=0;i--){var j;this[j=(front-1&capacity-1^capacity)-capacity]=arguments[i],front=j}return this._front=front,this._length=length+argsLength,length+argsLength}if(0===argsLength)return length;this._checkCapacity(length+1);capacity=this._capacity;return this[i=(this._front-1&capacity-1^capacity)-capacity]=item,this._length=length+1,this._front=i,length+1},Deque.prototype.peekBack=function(){var length=this._length;if(0!==length)return this[this._front+length-1&this._capacity-1]},Deque.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},Deque.prototype.get=function(index){var i=index;if(i===(0|i)){var len=this._length;if(i<0&&(i+=len),!(i<0||i>=len))return this[this._front+i&this._capacity-1]}},Deque.prototype.isEmpty=function(){return 0===this._length},Deque.prototype.clear=function(){for(var len=this._length,front=this._front,capacity=this._capacity,j=0;j<len;++j)this[front+j&capacity-1]=void 0;this._length=0,this._front=0},Deque.prototype.toString=function(){return this.toArray().toString()},Deque.prototype.valueOf=Deque.prototype.toString,Deque.prototype.removeFront=Deque.prototype.shift,Deque.prototype.removeBack=Deque.prototype.pop,Deque.prototype.insertFront=Deque.prototype.unshift,Deque.prototype.insertBack=Deque.prototype.push,Deque.prototype.enqueue=Deque.prototype.push,Deque.prototype.dequeue=Deque.prototype.shift,Deque.prototype.toJSON=Deque.prototype.toArray,Object.defineProperty(Deque.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),Deque.prototype._checkCapacity=function(size){this._capacity<size&&this._resizeTo(getCapacity(1.5*this._capacity+16))},Deque.prototype._resizeTo=function(capacity){var oldCapacity=this._capacity;this._capacity=capacity;var front=this._front,length=this._length;front+length>oldCapacity&&function(src,srcIndex,dst,dstIndex,len){for(var j=0;j<len;++j)dst[j+dstIndex]=src[j+srcIndex],src[j+srcIndex]=void 0}(this,0,this,oldCapacity,front+length&oldCapacity-1)};var isArray=Array.isArray;function getCapacity(capacity){if("number"!=typeof capacity){if(!isArray(capacity))return 16;capacity=capacity.length}return n=Math.min(Math.max(16,capacity),1073741824),n>>>=0,n-=1,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,1+(n|=n>>16);var n}module.exports=Deque},function(module,exports,__webpack_require__){(function(Buffer){var toString=Object.prototype.toString,isModern="function"==typeof Buffer.alloc&&"function"==typeof Buffer.allocUnsafe&&"function"==typeof Buffer.from;module.exports=function(value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return input=value,"ArrayBuffer"===toString.call(input).slice(8,-1)?function(obj,byteOffset,length){byteOffset>>>=0;var maxLength=obj.byteLength-byteOffset;if(maxLength<0)throw new RangeError("'offset' is out of bounds");if(void 0===length)length=maxLength;else if((length>>>=0)>maxLength)throw new RangeError("'length' is out of bounds");return isModern?Buffer.from(obj.slice(byteOffset,byteOffset+length)):new Buffer(new Uint8Array(obj.slice(byteOffset,byteOffset+length)))}(value,encodingOrOffset,length):"string"==typeof value?function(string,encoding){if("string"==typeof encoding&&""!==encoding||(encoding="utf8"),!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');return isModern?Buffer.from(string,encoding):new Buffer(string,encoding)}(value,encodingOrOffset):isModern?Buffer.from(value):new Buffer(value);var input}}).call(this,__webpack_require__(84).Buffer)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"allDocsKeysQuery",function(){return allDocsKeysQuery}),__webpack_require__.d(__webpack_exports__,"parseDoc",function(){return parseDoc}),__webpack_require__.d(__webpack_exports__,"preprocessAttachments",function(){return preprocessAttachments}),__webpack_require__.d(__webpack_exports__,"processDocs",function(){return processDocs}),__webpack_require__.d(__webpack_exports__,"updateDoc",function(){return updateDoc});var pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(71);__webpack_require__.d(__webpack_exports__,"invalidIdError",function(){return pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.invalidIdError}),__webpack_require__.d(__webpack_exports__,"normalizeDdocFunctionName",function(){return pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.normalizeDdocFunctionName}),__webpack_require__.d(__webpack_exports__,"parseDdocFunctionName",function(){return pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.parseDdocFunctionName});var pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(73),pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(75),pouchdb_md5__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(74),pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(136);__webpack_require__.d(__webpack_exports__,"isDeleted",function(){return pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted}),__webpack_require__.d(__webpack_exports__,"isLocalId",function(){return pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isLocalId});var pouchdb_collections__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(72);function allDocsKeysQuery(api,opts){var keys=opts.keys,finalResults={offset:opts.skip};return Promise.all(keys.map(function(key){var subOpts=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.assign)({key:key,deleted:"ok"},opts);return["limit","skip","keys"].forEach(function(optKey){delete subOpts[optKey]}),new Promise(function(resolve,reject){api._allDocs(subOpts,function(err,res){if(err)return reject(err);opts.update_seq&&void 0!==res.update_seq&&(finalResults.update_seq=res.update_seq),finalResults.total_rows=res.total_rows,resolve(res.rows[0]||{key:key,error:"not_found"})})})})).then(function(results){return finalResults.rows=results,finalResults})}function toObject(array){return array.reduce(function(obj,item){return obj[item]=!0,obj},{})}var reservedWords=toObject(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),dataWords=toObject(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);function parseRevisionInfo(rev$$1){if(!/^\d+-./.test(rev$$1))return Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.INVALID_REV);var idx=rev$$1.indexOf("-"),left=rev$$1.substring(0,idx),right=rev$$1.substring(idx+1);return{prefix:parseInt(left,10),id:right}}function parseDoc(doc,newEdits,dbOpts){var nRevNum,newRevId,revInfo;dbOpts||(dbOpts={deterministic_revs:!0});var opts={status:"available"};if(doc._deleted&&(opts.deleted=!0),newEdits)if(doc._id||(doc._id=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.uuid)()),newRevId=Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.rev)(doc,dbOpts.deterministic_revs),doc._rev){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;doc._rev_tree=[{pos:revInfo.prefix,ids:[revInfo.id,{status:"missing"},[[newRevId,opts,[]]]]}],nRevNum=revInfo.prefix+1}else doc._rev_tree=[{pos:1,ids:[newRevId,opts,[]]}],nRevNum=1;else if(doc._revisions&&(doc._rev_tree=function(revisions,opts){for(var pos=revisions.start-revisions.ids.length+1,revisionIds=revisions.ids,ids=[revisionIds[0],opts,[]],i=1,len=revisionIds.length;i<len;i++)ids=[revisionIds[i],{status:"missing"},[ids]];return[{pos:pos,ids:ids}]}(doc._revisions,opts),nRevNum=doc._revisions.start,newRevId=doc._revisions.ids[0]),!doc._rev_tree){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;nRevNum=revInfo.prefix,newRevId=revInfo.id,doc._rev_tree=[{pos:nRevNum,ids:[newRevId,opts,[]]}]}Object(pouchdb_utils__WEBPACK_IMPORTED_MODULE_0__.invalidIdError)(doc._id),doc._rev=nRevNum+"-"+newRevId;var result={metadata:{},data:{}};for(var key in doc)if(Object.prototype.hasOwnProperty.call(doc,key)){var specialKey="_"===key[0];if(specialKey&&!reservedWords[key]){var error=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.DOC_VALIDATION,key);throw error.message=pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.DOC_VALIDATION.message+": "+key,error}specialKey&&!dataWords[key]?result.metadata[key.slice(1)]=doc[key]:result.data[key]=doc[key]}return result}function preprocessString(att,blobType,callback){var asBinary=function(data){try{return Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__.atob)(data)}catch(e){return{error:Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.BAD_ARG,"Attachment is not a valid base64 string")}}}(att.data);if(asBinary.error)return callback(asBinary.error);att.length=asBinary.length,att.data="blob"===blobType?Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__.binaryStringToBlobOrBuffer)(asBinary,att.content_type):"base64"===blobType?Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__.btoa)(asBinary):asBinary,Object(pouchdb_md5__WEBPACK_IMPORTED_MODULE_3__.binaryMd5)(asBinary,function(result){att.digest="md5-"+result,callback()})}function preprocessAttachment(att,blobType,callback){if(att.stub)return callback();"string"==typeof att.data?preprocessString(att,blobType,callback):function(att,blobType,callback){Object(pouchdb_md5__WEBPACK_IMPORTED_MODULE_3__.binaryMd5)(att.data,function(md5){att.digest="md5-"+md5,att.length=att.data.size||att.data.length||0,"binary"===blobType?Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__.blobOrBufferToBinaryString)(att.data,function(binString){att.data=binString,callback()}):"base64"===blobType?Object(pouchdb_binary_utils__WEBPACK_IMPORTED_MODULE_2__.blobOrBufferToBase64)(att.data,function(b64){att.data=b64,callback()}):callback()})}(att,blobType,callback)}function preprocessAttachments(docInfos,blobType,callback){if(!docInfos.length)return callback();var overallErr,docv=0;function done(){docv++,docInfos.length===docv&&(overallErr?callback(overallErr):callback())}docInfos.forEach(function(docInfo){var attachments=docInfo.data&&docInfo.data._attachments?Object.keys(docInfo.data._attachments):[],recv=0;if(!attachments.length)return done();function processedAttachment(err){overallErr=err,++recv===attachments.length&&done()}for(var key in docInfo.data._attachments)docInfo.data._attachments.hasOwnProperty(key)&&preprocessAttachment(docInfo.data._attachments[key],blobType,processedAttachment)})}function updateDoc(revLimit,prev,docInfo,results,i,cb,writeDoc,newEdits){if(Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.revExists)(prev.rev_tree,docInfo.metadata.rev)&&!newEdits)return results[i]=docInfo,cb();var previousWinningRev=prev.winningRev||Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.winningRev)(prev),previouslyDeleted="deleted"in prev?prev.deleted:Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted)(prev,previousWinningRev),deleted="deleted"in docInfo.metadata?docInfo.metadata.deleted:Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted)(docInfo.metadata),isRoot=/^1-/.test(docInfo.metadata.rev);if(previouslyDeleted&&!deleted&&newEdits&&isRoot){var newDoc=docInfo.data;newDoc._rev=previousWinningRev,newDoc._id=docInfo.metadata.id,docInfo=parseDoc(newDoc,newEdits)}var merged=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.merge)(prev.rev_tree,docInfo.metadata.rev_tree[0],revLimit);if(newEdits&&(previouslyDeleted&&deleted&&"new_leaf"!==merged.conflicts||!previouslyDeleted&&"new_leaf"!==merged.conflicts||previouslyDeleted&&!deleted&&"new_branch"===merged.conflicts)){var err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.REV_CONFLICT);return results[i]=err,cb()}var newRev=docInfo.metadata.rev;docInfo.metadata.rev_tree=merged.tree,docInfo.stemmedRevs=merged.stemmedRevs||[],prev.rev_map&&(docInfo.metadata.rev_map=prev.rev_map);var winningRev$$1=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.winningRev)(docInfo.metadata),winningRevIsDeleted=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted)(docInfo.metadata,winningRev$$1),delta=previouslyDeleted===winningRevIsDeleted?0:previouslyDeleted<winningRevIsDeleted?-1:1;writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRev===winningRev$$1?winningRevIsDeleted:Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted)(docInfo.metadata,newRev),!0,delta,i,cb)}function processDocs(revLimit,docInfos,api,fetchedDocs,tx,results,writeDoc,opts,overallCallback){revLimit=revLimit||1e3;var newEdits=opts.new_edits,idsToDocs=new pouchdb_collections__WEBPACK_IMPORTED_MODULE_5__.Map,docsDone=0,docsToDo=docInfos.length;function checkAllDocsDone(){++docsDone===docsToDo&&overallCallback&&overallCallback()}docInfos.forEach(function(currentDoc,resultsIdx){if(currentDoc._id&&Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isLocalId)(currentDoc._id)){var fun=currentDoc._deleted?"_removeLocal":"_putLocal";api[fun](currentDoc,{ctx:tx},function(err,res){results[resultsIdx]=err||res,checkAllDocsDone()})}else{var id=currentDoc.metadata.id;idsToDocs.has(id)?(docsToDo--,idsToDocs.get(id).push([currentDoc,resultsIdx])):idsToDocs.set(id,[[currentDoc,resultsIdx]])}}),idsToDocs.forEach(function(docs,id){var numDone=0;function docWritten(){++numDone<docs.length?nextDoc():checkAllDocsDone()}function nextDoc(){var value=docs[numDone],currentDoc=value[0],resultsIdx=value[1];if(fetchedDocs.has(id))updateDoc(revLimit,fetchedDocs.get(id),currentDoc,results,resultsIdx,docWritten,writeDoc,newEdits);else{var merged=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.merge)([],currentDoc.metadata.rev_tree[0],revLimit);currentDoc.metadata.rev_tree=merged.tree,currentDoc.stemmedRevs=merged.stemmedRevs||[],function(docInfo,resultsIdx,callback){var winningRev$$1=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.winningRev)(docInfo.metadata),deleted=Object(pouchdb_merge__WEBPACK_IMPORTED_MODULE_4__.isDeleted)(docInfo.metadata,winningRev$$1);if("was_delete"in opts&&deleted)return results[resultsIdx]=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.MISSING_DOC,"deleted"),callback();if(newEdits&&function(docInfo){return"missing"===docInfo.metadata.rev_tree[0].ids[1].status}(docInfo)){var err=Object(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.createError)(pouchdb_errors__WEBPACK_IMPORTED_MODULE_1__.REV_CONFLICT);return results[resultsIdx]=err,callback()}writeDoc(docInfo,winningRev$$1,deleted,deleted,!1,deleted?0:1,resultsIdx,callback)}(currentDoc,resultsIdx,docWritten)}}nextDoc()})}},function(module,__webpack_exports__,__webpack_require__){"use strict";function winningRev(metadata){for(var winningId,winningPos,winningDeleted,node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var tree=node.ids,branches=tree[2],pos=node.pos;if(branches.length)for(var i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i]});else{var deleted=!!tree[1].deleted,id=tree[0];winningId&&!(winningDeleted!==deleted?winningDeleted:winningPos!==pos?winningPos<pos:winningId<id)||(winningId=id,winningPos=pos,winningDeleted=deleted)}}return winningPos+"-"+winningId}function traverseRevTree(revs,callback){for(var node,toVisit=revs.slice();node=toVisit.pop();)for(var pos=node.pos,tree=node.ids,branches=tree[2],newCtx=callback(0===branches.length,pos,tree[0],node.ctx,tree[1]),i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i],ctx:newCtx})}function sortByPos(a,b){return a.pos-b.pos}function collectLeaves(revs){var leaves=[];traverseRevTree(revs,function(isLeaf,pos,id,acc,opts){isLeaf&&leaves.push({rev:pos+"-"+id,pos:pos,opts:opts})}),leaves.sort(sortByPos).reverse();for(var i=0,len=leaves.length;i<len;i++)delete leaves[i].pos;return leaves}function collectConflicts(metadata){for(var win=winningRev(metadata),leaves=collectLeaves(metadata.rev_tree),conflicts=[],i=0,len=leaves.length;i<len;i++){var leaf=leaves[i];leaf.rev===win||leaf.opts.deleted||conflicts.push(leaf.rev)}return conflicts}function compactTree(metadata){var revs=[];return traverseRevTree(metadata.rev_tree,function(isLeaf,pos,revHash,ctx,opts){"available"!==opts.status||isLeaf||(revs.push(pos+"-"+revHash),opts.status="missing")}),revs}function rootToLeaf(revs){for(var node,paths=[],toVisit=revs.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];history.push({id:id,opts:opts}),isLeaf&&paths.push({pos:pos+1-history.length,ids:history});for(var i=0,len=branches.length;i<len;i++)toVisit.push({pos:pos+1,ids:branches[i],history:history})}return paths.reverse()}function sortByPos$1(a,b){return a.pos-b.pos}function insertSorted(arr,item,comparator){var idx=function(arr,item,comparator){for(var mid,low=0,high=arr.length;low<high;)comparator(arr[mid=low+high>>>1],item)<0?low=mid+1:high=mid;return low}(arr,item,comparator);arr.splice(idx,0,item)}function pathToTree(path,numStemmed){for(var root,leaf,i=numStemmed,len=path.length;i<len;i++){var node=path[i],currentLeaf=[node.id,node.opts,[]];leaf?(leaf[2].push(currentLeaf),leaf=currentLeaf):root=leaf=currentLeaf}return root}function compareTree(a,b){return a[0]<b[0]?-1:1}function mergeTree(in_tree1,in_tree2){for(var queue=[{tree1:in_tree1,tree2:in_tree2}],conflicts=!1;queue.length>0;){var item=queue.pop(),tree1=item.tree1,tree2=item.tree2;(tree1[1].status||tree2[1].status)&&(tree1[1].status="available"===tree1[1].status||"available"===tree2[1].status?"available":"missing");for(var i=0;i<tree2[2].length;i++)if(tree1[2][0]){for(var merged=!1,j=0;j<tree1[2].length;j++)tree1[2][j][0]===tree2[2][i][0]&&(queue.push({tree1:tree1[2][j],tree2:tree2[2][i]}),merged=!0);merged||(conflicts="new_branch",insertSorted(tree1[2],tree2[2][i],compareTree))}else conflicts="new_leaf",tree1[2][0]=tree2[2][i]}return{conflicts:conflicts,tree:in_tree1}}function doMerge(tree,path,dontExpand){var res,restree=[],conflicts=!1,merged=!1;if(!tree.length)return{tree:[path],conflicts:"new_leaf"};for(var i=0,len=tree.length;i<len;i++){var branch=tree[i];if(branch.pos===path.pos&&branch.ids[0]===path.ids[0])res=mergeTree(branch.ids,path.ids),restree.push({pos:branch.pos,ids:res.tree}),conflicts=conflicts||res.conflicts,merged=!0;else if(!0!==dontExpand){var t1=branch.pos<path.pos?branch:path,t2=branch.pos<path.pos?path:branch,diff=t2.pos-t1.pos,candidateParents=[],trees=[];for(trees.push({ids:t1.ids,diff:diff,parent:null,parentIdx:null});trees.length>0;){var item=trees.pop();if(0!==item.diff)for(var elements=item.ids[2],j=0,elementsLen=elements.length;j<elementsLen;j++)trees.push({ids:elements[j],diff:item.diff-1,parent:item.ids,parentIdx:j});else item.ids[0]===t2.ids[0]&&candidateParents.push(item)}var el=candidateParents[0];el?(res=mergeTree(el.ids,t2.ids),el.parent[2][el.parentIdx]=res.tree,restree.push({pos:t1.pos,ids:t1.ids}),conflicts=conflicts||res.conflicts,merged=!0):restree.push(branch)}else restree.push(branch)}return merged||restree.push(path),restree.sort(sortByPos$1),{tree:restree,conflicts:conflicts||"internal_node"}}function merge(tree,path,depth){var newTree=doMerge(tree,path),stemmed=function(tree,depth){for(var stemmedRevs,result,paths=rootToLeaf(tree),i=0,len=paths.length;i<len;i++){var node,path=paths[i],stemmed=path.ids;if(stemmed.length>depth){stemmedRevs||(stemmedRevs={});var numStemmed=stemmed.length-depth;node={pos:path.pos+numStemmed,ids:pathToTree(stemmed,numStemmed)};for(var s=0;s<numStemmed;s++){var rev=path.pos+s+"-"+stemmed[s].id;stemmedRevs[rev]=!0}}else node={pos:path.pos,ids:pathToTree(stemmed,0)};result=result?doMerge(result,node,!0).tree:[node]}return stemmedRevs&&traverseRevTree(result,function(isLeaf,pos,revHash){delete stemmedRevs[pos+"-"+revHash]}),{tree:result,revs:stemmedRevs?Object.keys(stemmedRevs):[]}}(newTree.tree,depth);return{tree:stemmed.tree,stemmedRevs:stemmed.revs,conflicts:newTree.conflicts}}function revExists(revs,rev){for(var node,toVisit=revs.slice(),splitRev=rev.split("-"),targetPos=parseInt(splitRev[0],10),targetId=splitRev[1];node=toVisit.pop();){if(node.pos===targetPos&&node.ids[0]===targetId)return!0;for(var branches=node.ids[2],i=0,len=branches.length;i<len;i++)toVisit.push({pos:node.pos+1,ids:branches[i]})}return!1}function getTrees(node){return node.ids}function isDeleted(metadata,rev){rev||(rev=winningRev(metadata));for(var tree,id=rev.substring(rev.indexOf("-")+1),toVisit=metadata.rev_tree.map(getTrees);tree=toVisit.pop();){if(tree[0]===id)return!!tree[1].deleted;toVisit=toVisit.concat(tree[2])}}function isLocalId(id){return/^_local/.test(id)}function latest(rev,metadata){for(var node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];if(history.push({id:id,pos:pos,opts:opts}),isLeaf)for(var i=0,len=history.length;i<len;i++){var historyNode=history[i];if(historyNode.pos+"-"+historyNode.id===rev)return pos+"-"+id}for(var j=0,l=branches.length;j<l;j++)toVisit.push({pos:pos+1,ids:branches[j],history:history})}throw new Error("Unable to resolve latest revision for id "+metadata.id+", rev "+rev)}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"collectConflicts",function(){return collectConflicts}),__webpack_require__.d(__webpack_exports__,"collectLeaves",function(){return collectLeaves}),__webpack_require__.d(__webpack_exports__,"compactTree",function(){return compactTree}),__webpack_require__.d(__webpack_exports__,"isDeleted",function(){return isDeleted}),__webpack_require__.d(__webpack_exports__,"isLocalId",function(){return isLocalId}),__webpack_require__.d(__webpack_exports__,"merge",function(){return merge}),__webpack_require__.d(__webpack_exports__,"revExists",function(){return revExists}),__webpack_require__.d(__webpack_exports__,"rootToLeaf",function(){return rootToLeaf}),__webpack_require__.d(__webpack_exports__,"traverseRevTree",function(){return traverseRevTree}),__webpack_require__.d(__webpack_exports__,"winningRev",function(){return winningRev}),__webpack_require__.d(__webpack_exports__,"latest",function(){return latest})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"safeJsonParse",function(){return safeJsonParse}),__webpack_require__.d(__webpack_exports__,"safeJsonStringify",function(){return safeJsonStringify});var vuvuzela__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(69),vuvuzela__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(vuvuzela__WEBPACK_IMPORTED_MODULE_0__);function safeJsonParse(str){try{return JSON.parse(str)}catch(e){return vuvuzela__WEBPACK_IMPORTED_MODULE_0___default.a.parse(str)}}function safeJsonStringify(json){try{return JSON.stringify(json)}catch(e){return vuvuzela__WEBPACK_IMPORTED_MODULE_0___default.a.stringify(json)}}},function(module,exports,__webpack_require__){(function(Buffer){var inherits=__webpack_require__(62),AbstractLevelDOWN=__webpack_require__(139).AbstractLevelDOWN,AbstractIterator=__webpack_require__(139).AbstractIterator,ltgt=__webpack_require__(144),createRBT=__webpack_require__(145),globalStore={},setImmediate=__webpack_require__(146);function gt(value){return ltgt.compare(value,this._end)>0}function gte(value){return ltgt.compare(value,this._end)>=0}function lt(value){return ltgt.compare(value,this._end)<0}function lte(value){return ltgt.compare(value,this._end)<=0}function MemIterator(db,options){AbstractIterator.call(this,db),this._limit=options.limit,-1===this._limit&&(this._limit=1/0);var tree=db._store[db._location];this.keyAsBuffer=!1!==options.keyAsBuffer,this.valueAsBuffer=!1!==options.valueAsBuffer,this._reverse=options.reverse,this._options=options,this._done=0,this._reverse?(this._incr="prev",this._start=ltgt.upperBound(options),this._end=ltgt.lowerBound(options),void 0===this._start?this._tree=tree.end:ltgt.upperBoundInclusive(options)?this._tree=tree.le(this._start):this._tree=tree.lt(this._start),this._end&&(ltgt.lowerBoundInclusive(options)?this._test=gte:this._test=gt)):(this._incr="next",this._start=ltgt.lowerBound(options),this._end=ltgt.upperBound(options),void 0===this._start?this._tree=tree.begin:ltgt.lowerBoundInclusive(options)?this._tree=tree.ge(this._start):this._tree=tree.gt(this._start),this._end&&(ltgt.upperBoundInclusive(options)?this._test=lte:this._test=lt))}function MemDOWN(location){if(!(this instanceof MemDOWN))return new MemDOWN(location);AbstractLevelDOWN.call(this,"string"==typeof location?location:""),this._location=this.location?"$"+this.location:"_tree",this._store=this.location?globalStore:this,this._store[this._location]=this._store[this._location]||createRBT(ltgt.compare)}inherits(MemIterator,AbstractIterator),MemIterator.prototype._next=function(callback){var key,value;return this._done++>=this._limit?setImmediate(callback):this._tree.valid?(key=this._tree.key,value=this._tree.value,this._test(key)?(this.keyAsBuffer&&(key=new Buffer(key)),this.valueAsBuffer&&(value=new Buffer(value)),this._tree[this._incr](),void setImmediate(function(){callback(null,key,value)})):setImmediate(callback)):setImmediate(callback)},MemIterator.prototype._test=function(){return!0},MemDOWN.clearGlobalStore=function(strict){strict?Object.keys(globalStore).forEach(function(key){delete globalStore[key]}):globalStore={}},inherits(MemDOWN,AbstractLevelDOWN),MemDOWN.prototype._open=function(options,callback){var self=this;setImmediate(function(){callback(null,self)})},MemDOWN.prototype._put=function(key,value,options,callback){null==value&&(value="");var iter=this._store[this._location].find(key);iter.valid?this._store[this._location]=iter.update(value):this._store[this._location]=this._store[this._location].insert(key,value),setImmediate(callback)},MemDOWN.prototype._get=function(key,options,callback){var value=this._store[this._location].get(key);if(void 0===value)return setImmediate(function(){callback(new Error("NotFound"))});!1===options.asBuffer||this._isBuffer(value)||(value=new Buffer(String(value))),setImmediate(function(){callback(null,value)})},MemDOWN.prototype._del=function(key,options,callback){this._store[this._location]=this._store[this._location].remove(key),setImmediate(callback)},MemDOWN.prototype._batch=function(array,options,callback){for(var key,value,iter,i=-1,len=array.length,tree=this._store[this._location];++i<len;)array[i]&&(key=this._isBuffer(array[i].key)?array[i].key:String(array[i].key),iter=tree.find(key),"put"===array[i].type?(value=this._isBuffer(array[i].value)?array[i].value:String(array[i].value),tree=iter.valid?iter.update(value):tree.insert(key,value)):tree=iter.remove());this._store[this._location]=tree,setImmediate(callback)},MemDOWN.prototype._iterator=function(options){return new MemIterator(this,options)},MemDOWN.prototype._isBuffer=function(obj){return Buffer.isBuffer(obj)},MemDOWN.destroy=function(name,callback){var key="$"+name;key in globalStore&&delete globalStore[key],setImmediate(callback)},module.exports=MemDOWN}).call(this,__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){exports.AbstractLevelDOWN=__webpack_require__(140),exports.AbstractIterator=__webpack_require__(141),exports.AbstractChainedBatch=__webpack_require__(142),exports.isLevelDOWN=__webpack_require__(143)},function(module,exports,__webpack_require__){(function(process,Buffer){var xtend=__webpack_require__(80),AbstractIterator=__webpack_require__(141),AbstractChainedBatch=__webpack_require__(142);function AbstractLevelDOWN(location){if(!arguments.length||void 0===location)throw new Error("constructor requires at least a location argument");if("string"!=typeof location)throw new Error("constructor requires a location string argument");this.location=location,this.status="new"}AbstractLevelDOWN.prototype.open=function(options,callback){var self=this,oldStatus=this.status;if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("open() requires a callback argument");"object"!=typeof options&&(options={}),options.createIfMissing=0!=options.createIfMissing,options.errorIfExists=!!options.errorIfExists,"function"==typeof this._open?(this.status="opening",this._open(options,function(err){if(err)return self.status=oldStatus,callback(err);self.status="open",callback()})):(this.status="open",process.nextTick(callback))},AbstractLevelDOWN.prototype.close=function(callback){var self=this,oldStatus=this.status;if("function"!=typeof callback)throw new Error("close() requires a callback argument");"function"==typeof this._close?(this.status="closing",this._close(function(err){if(err)return self.status=oldStatus,callback(err);self.status="closed",callback()})):(this.status="closed",process.nextTick(callback))},AbstractLevelDOWN.prototype.get=function(key,options,callback){var err;if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("get() requires a callback argument");return(err=this._checkKey(key,"key",this._isBuffer))?callback(err):(this._isBuffer(key)||(key=String(key)),"object"!=typeof options&&(options={}),options.asBuffer=0!=options.asBuffer,"function"==typeof this._get?this._get(key,options,callback):void process.nextTick(function(){callback(new Error("NotFound"))}))},AbstractLevelDOWN.prototype.put=function(key,value,options,callback){var err;if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("put() requires a callback argument");return(err=this._checkKey(key,"key",this._isBuffer))?callback(err):(this._isBuffer(key)||(key=String(key)),null==value||this._isBuffer(value)||process.browser||(value=String(value)),"object"!=typeof options&&(options={}),"function"==typeof this._put?this._put(key,value,options,callback):void process.nextTick(callback))},AbstractLevelDOWN.prototype.del=function(key,options,callback){var err;if("function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("del() requires a callback argument");return(err=this._checkKey(key,"key",this._isBuffer))?callback(err):(this._isBuffer(key)||(key=String(key)),"object"!=typeof options&&(options={}),"function"==typeof this._del?this._del(key,options,callback):void process.nextTick(callback))},AbstractLevelDOWN.prototype.batch=function(array,options,callback){if(!arguments.length)return this._chainedBatch();if("function"==typeof options&&(callback=options),"function"==typeof array&&(callback=array),"function"!=typeof callback)throw new Error("batch(array) requires a callback argument");if(!Array.isArray(array))return callback(new Error("batch(array) requires an array argument"));options&&"object"==typeof options||(options={});for(var e,err,i=0,l=array.length;i<l;i++)if("object"==typeof(e=array[i])){if(err=this._checkKey(e.type,"type",this._isBuffer))return callback(err);if(err=this._checkKey(e.key,"key",this._isBuffer))return callback(err)}if("function"==typeof this._batch)return this._batch(array,options,callback);process.nextTick(callback)},AbstractLevelDOWN.prototype.approximateSize=function(start,end,callback){if(null==start||null==end||"function"==typeof start||"function"==typeof end)throw new Error("approximateSize() requires valid `start`, `end` and `callback` arguments");if("function"!=typeof callback)throw new Error("approximateSize() requires a callback argument");if(this._isBuffer(start)||(start=String(start)),this._isBuffer(end)||(end=String(end)),"function"==typeof this._approximateSize)return this._approximateSize(start,end,callback);process.nextTick(function(){callback(null,0)})},AbstractLevelDOWN.prototype._setupIteratorOptions=function(options){var self=this;return options=xtend(options),["start","end","gt","gte","lt","lte"].forEach(function(o){options[o]&&self._isBuffer(options[o])&&0===options[o].length&&delete options[o]}),options.reverse=!!options.reverse,options.keys=0!=options.keys,options.values=0!=options.values,options.limit="limit"in options?options.limit:-1,options.keyAsBuffer=0!=options.keyAsBuffer,options.valueAsBuffer=0!=options.valueAsBuffer,options},AbstractLevelDOWN.prototype.iterator=function(options){return"object"!=typeof options&&(options={}),options=this._setupIteratorOptions(options),"function"==typeof this._iterator?this._iterator(options):new AbstractIterator(this)},AbstractLevelDOWN.prototype._chainedBatch=function(){return new AbstractChainedBatch(this)},AbstractLevelDOWN.prototype._isBuffer=function(obj){return Buffer.isBuffer(obj)},AbstractLevelDOWN.prototype._checkKey=function(obj,type){if(null==obj)return new Error(type+" cannot be `null` or `undefined`");if(this._isBuffer(obj)){if(0===obj.length)return new Error(type+" cannot be an empty Buffer")}else if(""===String(obj))return new Error(type+" cannot be an empty String")},module.exports=AbstractLevelDOWN}).call(this,__webpack_require__(53),__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){(function(process){function AbstractIterator(db){this.db=db,this._ended=!1,this._nexting=!1}AbstractIterator.prototype.next=function(callback){var self=this;if("function"!=typeof callback)throw new Error("next() requires a callback argument");return self._ended?callback(new Error("cannot call next() after end()")):self._nexting?callback(new Error("cannot call next() before previous next() has completed")):(self._nexting=!0,"function"==typeof self._next?self._next(function(){self._nexting=!1,callback.apply(null,arguments)}):void process.nextTick(function(){self._nexting=!1,callback()}))},AbstractIterator.prototype.end=function(callback){if("function"!=typeof callback)throw new Error("end() requires a callback argument");return this._ended?callback(new Error("end() already called on iterator")):(this._ended=!0,"function"==typeof this._end?this._end(callback):void process.nextTick(callback))},module.exports=AbstractIterator}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){(function(process){function AbstractChainedBatch(db){this._db=db,this._operations=[],this._written=!1}AbstractChainedBatch.prototype._checkWritten=function(){if(this._written)throw new Error("write() already called on this batch")},AbstractChainedBatch.prototype.put=function(key,value){this._checkWritten();var err=this._db._checkKey(key,"key",this._db._isBuffer);if(err)throw err;return this._db._isBuffer(key)||(key=String(key)),this._db._isBuffer(value)||(value=String(value)),"function"==typeof this._put?this._put(key,value):this._operations.push({type:"put",key:key,value:value}),this},AbstractChainedBatch.prototype.del=function(key){this._checkWritten();var err=this._db._checkKey(key,"key",this._db._isBuffer);if(err)throw err;return this._db._isBuffer(key)||(key=String(key)),"function"==typeof this._del?this._del(key):this._operations.push({type:"del",key:key}),this},AbstractChainedBatch.prototype.clear=function(){return this._checkWritten(),this._operations=[],"function"==typeof this._clear&&this._clear(),this},AbstractChainedBatch.prototype.write=function(options,callback){if(this._checkWritten(),"function"==typeof options&&(callback=options),"function"!=typeof callback)throw new Error("write() requires a callback argument");return"object"!=typeof options&&(options={}),this._written=!0,"function"==typeof this._write?this._write(callback):"function"==typeof this._db._batch?this._db._batch(this._operations,options,callback):void process.nextTick(callback)},module.exports=AbstractChainedBatch}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){var AbstractLevelDOWN=__webpack_require__(140);module.exports=function(db){return!(!db||"object"!=typeof db)&&Object.keys(AbstractLevelDOWN.prototype).filter(function(name){return"_"!=name[0]&&"approximateSize"!=name}).every(function(name){return"function"==typeof db[name]})}},function(module,exports,__webpack_require__){(function(Buffer){function has(obj,key){return Object.hasOwnProperty.call(obj,key)}function isDef(val){return void 0!==val&&""!==val}function has(range,name){return Object.hasOwnProperty.call(range,name)}function hasKey(range,name){return Object.hasOwnProperty.call(range,name)&&name}exports.compare=function(a,b){if(Buffer.isBuffer(a)){for(var l=Math.min(a.length,b.length),i=0;i<l;i++){var cmp=a[i]-b[i];if(cmp)return cmp}return a.length-b.length}return a<b?-1:a>b?1:0};var lowerBoundKey=exports.lowerBoundKey=function(range){return hasKey(range,"gt")||hasKey(range,"gte")||hasKey(range,"min")||(range.reverse?hasKey(range,"end"):hasKey(range,"start"))||void 0},lowerBound=exports.lowerBound=function(range){var k=lowerBoundKey(range);return k&&range[k]},lowerBoundInclusive=exports.lowerBoundInclusive=function(range){return!has(range,"gt")},upperBoundInclusive=exports.upperBoundInclusive=function(range){return!has(range,"lt")},lowerBoundExclusive=exports.lowerBoundExclusive=function(range){return!lowerBoundInclusive(range)},upperBoundExclusive=exports.upperBoundExclusive=function(range){return!upperBoundInclusive(range)},upperBoundKey=exports.upperBoundKey=function(range){return hasKey(range,"lt")||hasKey(range,"lte")||hasKey(range,"max")||(range.reverse?hasKey(range,"start"):hasKey(range,"end"))||void 0},upperBound=exports.upperBound=function(range){var k=upperBoundKey(range);return k&&range[k]};function id(e){return e}exports.toLtgt=function(range,_range,map,lower,upper){_range=_range||{},map=map||id;var defaults=arguments.length>3,lb=exports.lowerBoundKey(range),ub=exports.upperBoundKey(range);return lb?"gt"===lb?_range.gt=map(range.gt,!1):_range.gte=map(range[lb],!1):defaults&&(_range.gte=map(lower,!1)),ub?"lt"===ub?_range.lt=map(range.lt,!0):_range.lte=map(range[ub],!0):defaults&&(_range.lte=map(upper,!0)),null!=range.reverse&&(_range.reverse=!!range.reverse),has(_range,"max")&&delete _range.max,has(_range,"min")&&delete _range.min,has(_range,"start")&&delete _range.start,has(_range,"end")&&delete _range.end,_range},exports.contains=function(range,key,compare){compare=compare||exports.compare;var lb=lowerBound(range);if(isDef(lb)&&((cmp=compare(key,lb))<0||0===cmp&&lowerBoundExclusive(range)))return!1;var cmp,ub=upperBound(range);if(isDef(ub)&&((cmp=compare(key,ub))>0||0===cmp&&upperBoundExclusive(range)))return!1;return!0},exports.filter=function(range,compare){return function(key){return exports.contains(range,key,compare)}}}).call(this,__webpack_require__(84).Buffer)},function(module,exports,__webpack_require__){"use strict";module.exports=function(compare){return new RedBlackTree(compare||defaultCompare,null)};var RED=0,BLACK=1;function RBNode(color,key,value,left,right,count){this._color=color,this.key=key,this.value=value,this.left=left,this.right=right,this._count=count}function cloneNode(node){return new RBNode(node._color,node.key,node.value,node.left,node.right,node._count)}function repaint(color,node){return new RBNode(color,node.key,node.value,node.left,node.right,node._count)}function recount(node){node._count=1+(node.left?node.left._count:0)+(node.right?node.right._count:0)}function RedBlackTree(compare,root){this._compare=compare,this.root=root}var proto=RedBlackTree.prototype;function RedBlackTreeIterator(tree,stack){this.tree=tree,this._stack=stack}Object.defineProperty(proto,"keys",{get:function(){var result=[];return this.forEach(function(k,v){result.push(k)}),result}}),Object.defineProperty(proto,"values",{get:function(){var result=[];return this.forEach(function(k,v){result.push(v)}),result}}),Object.defineProperty(proto,"length",{get:function(){return this.root?this.root._count:0}}),proto.insert=function(key,value){for(var cmp=this._compare,n=this.root,n_stack=[],d_stack=[];n;){var d=cmp(key,n.key);n_stack.push(n),d_stack.push(d),n=d<=0?n.left:n.right}n_stack.push(new RBNode(RED,key,value,null,null,1));for(var s=n_stack.length-2;s>=0;--s){n=n_stack[s];d_stack[s]<=0?n_stack[s]=new RBNode(n._color,n.key,n.value,n_stack[s+1],n.right,n._count+1):n_stack[s]=new RBNode(n._color,n.key,n.value,n.left,n_stack[s+1],n._count+1)}for(s=n_stack.length-1;s>1;--s){var p=n_stack[s-1];n=n_stack[s];if(p._color===BLACK||n._color===BLACK)break;var pp=n_stack[s-2];if(pp.left===p)if(p.left===n){if(!(y=pp.right)||y._color!==RED){if(pp._color=RED,pp.left=p.right,p._color=BLACK,p.right=pp,n_stack[s-2]=p,n_stack[s-1]=n,recount(pp),recount(p),s>=3)(ppp=n_stack[s-3]).left===pp?ppp.left=p:ppp.right=p;break}p._color=BLACK,pp.right=repaint(BLACK,y),pp._color=RED,s-=1}else{if(!(y=pp.right)||y._color!==RED){if(p.right=n.left,pp._color=RED,pp.left=n.right,n._color=BLACK,n.left=p,n.right=pp,n_stack[s-2]=n,n_stack[s-1]=p,recount(pp),recount(p),recount(n),s>=3)(ppp=n_stack[s-3]).left===pp?ppp.left=n:ppp.right=n;break}p._color=BLACK,pp.right=repaint(BLACK,y),pp._color=RED,s-=1}else if(p.right===n){if(!(y=pp.left)||y._color!==RED){if(pp._color=RED,pp.right=p.left,p._color=BLACK,p.left=pp,n_stack[s-2]=p,n_stack[s-1]=n,recount(pp),recount(p),s>=3)(ppp=n_stack[s-3]).right===pp?ppp.right=p:ppp.left=p;break}p._color=BLACK,pp.left=repaint(BLACK,y),pp._color=RED,s-=1}else{var y;if(!(y=pp.left)||y._color!==RED){var ppp;if(p.left=n.right,pp._color=RED,pp.right=n.left,n._color=BLACK,n.right=p,n.left=pp,n_stack[s-2]=n,n_stack[s-1]=p,recount(pp),recount(p),recount(n),s>=3)(ppp=n_stack[s-3]).right===pp?ppp.right=n:ppp.left=n;break}p._color=BLACK,pp.left=repaint(BLACK,y),pp._color=RED,s-=1}}return n_stack[0]._color=BLACK,new RedBlackTree(cmp,n_stack[0])},proto.forEach=function(visit,lo,hi){if(this.root)switch(arguments.length){case 1:return function doVisitFull(visit,node){var v;if(node.left&&(v=doVisitFull(visit,node.left)))return v;return(v=visit(node.key,node.value))||(node.right?doVisitFull(visit,node.right):void 0)}(visit,this.root);case 2:return function doVisitHalf(lo,compare,visit,node){if(compare(lo,node.key)<=0){var v;if(node.left&&(v=doVisitHalf(lo,compare,visit,node.left)))return v;if(v=visit(node.key,node.value))return v}if(node.right)return doVisitHalf(lo,compare,visit,node.right)}(lo,this._compare,visit,this.root);case 3:if(this._compare(lo,hi)>=0)return;return function doVisit(lo,hi,compare,visit,node){var v,l=compare(lo,node.key),h=compare(hi,node.key);if(l<=0){if(node.left&&(v=doVisit(lo,hi,compare,visit,node.left)))return v;if(h>0&&(v=visit(node.key,node.value)))return v}if(h>0&&node.right)return doVisit(lo,hi,compare,visit,node.right)}(lo,hi,this._compare,visit,this.root)}},Object.defineProperty(proto,"begin",{get:function(){for(var stack=[],n=this.root;n;)stack.push(n),n=n.left;return new RedBlackTreeIterator(this,stack)}}),Object.defineProperty(proto,"end",{get:function(){for(var stack=[],n=this.root;n;)stack.push(n),n=n.right;return new RedBlackTreeIterator(this,stack)}}),proto.at=function(idx){if(idx<0)return new RedBlackTreeIterator(this,[]);for(var n=this.root,stack=[];;){if(stack.push(n),n.left){if(idx<n.left._count){n=n.left;continue}idx-=n.left._count}if(!idx)return new RedBlackTreeIterator(this,stack);if(idx-=1,!n.right)break;if(idx>=n.right._count)break;n=n.right}return new RedBlackTreeIterator(this,[])},proto.ge=function(key){for(var cmp=this._compare,n=this.root,stack=[],last_ptr=0;n;){var d=cmp(key,n.key);stack.push(n),d<=0&&(last_ptr=stack.length),n=d<=0?n.left:n.right}return stack.length=last_ptr,new RedBlackTreeIterator(this,stack)},proto.gt=function(key){for(var cmp=this._compare,n=this.root,stack=[],last_ptr=0;n;){var d=cmp(key,n.key);stack.push(n),d<0&&(last_ptr=stack.length),n=d<0?n.left:n.right}return stack.length=last_ptr,new RedBlackTreeIterator(this,stack)},proto.lt=function(key){for(var cmp=this._compare,n=this.root,stack=[],last_ptr=0;n;){var d=cmp(key,n.key);stack.push(n),d>0&&(last_ptr=stack.length),n=d<=0?n.left:n.right}return stack.length=last_ptr,new RedBlackTreeIterator(this,stack)},proto.le=function(key){for(var cmp=this._compare,n=this.root,stack=[],last_ptr=0;n;){var d=cmp(key,n.key);stack.push(n),d>=0&&(last_ptr=stack.length),n=d<0?n.left:n.right}return stack.length=last_ptr,new RedBlackTreeIterator(this,stack)},proto.find=function(key){for(var cmp=this._compare,n=this.root,stack=[];n;){var d=cmp(key,n.key);if(stack.push(n),0===d)return new RedBlackTreeIterator(this,stack);n=d<=0?n.left:n.right}return new RedBlackTreeIterator(this,[])},proto.remove=function(key){var iter=this.find(key);return iter?iter.remove():this},proto.get=function(key){for(var cmp=this._compare,n=this.root;n;){var d=cmp(key,n.key);if(0===d)return n.value;n=d<=0?n.left:n.right}};var iproto=RedBlackTreeIterator.prototype;function swapNode(n,v){n.key=v.key,n.value=v.value,n.left=v.left,n.right=v.right,n._color=v._color,n._count=v._count}function defaultCompare(a,b){return a<b?-1:a>b?1:0}Object.defineProperty(iproto,"valid",{get:function(){return this._stack.length>0}}),Object.defineProperty(iproto,"node",{get:function(){return this._stack.length>0?this._stack[this._stack.length-1]:null},enumerable:!0}),iproto.clone=function(){return new RedBlackTreeIterator(this.tree,this._stack.slice())},iproto.remove=function(){var stack=this._stack;if(0===stack.length)return this.tree;var cstack=new Array(stack.length),n=stack[stack.length-1];cstack[cstack.length-1]=new RBNode(n._color,n.key,n.value,n.left,n.right,n._count);for(var i=stack.length-2;i>=0;--i){(n=stack[i]).left===stack[i+1]?cstack[i]=new RBNode(n._color,n.key,n.value,cstack[i+1],n.right,n._count):cstack[i]=new RBNode(n._color,n.key,n.value,n.left,cstack[i+1],n._count)}if((n=cstack[cstack.length-1]).left&&n.right){var split=cstack.length;for(n=n.left;n.right;)cstack.push(n),n=n.right;var v=cstack[split-1];cstack.push(new RBNode(n._color,v.key,v.value,n.left,n.right,n._count)),cstack[split-1].key=n.key,cstack[split-1].value=n.value;for(i=cstack.length-2;i>=split;--i)n=cstack[i],cstack[i]=new RBNode(n._color,n.key,n.value,n.left,cstack[i+1],n._count);cstack[split-1].left=cstack[split]}if((n=cstack[cstack.length-1])._color===RED){var p=cstack[cstack.length-2];p.left===n?p.left=null:p.right===n&&(p.right=null),cstack.pop();for(i=0;i<cstack.length;++i)cstack[i]._count--;return new RedBlackTree(this.tree._compare,cstack[0])}if(n.left||n.right){n.left?swapNode(n,n.left):n.right&&swapNode(n,n.right),n._color=BLACK;for(i=0;i<cstack.length-1;++i)cstack[i]._count--;return new RedBlackTree(this.tree._compare,cstack[0])}if(1===cstack.length)return new RedBlackTree(this.tree._compare,null);for(i=0;i<cstack.length;++i)cstack[i]._count--;var parent=cstack[cstack.length-2];return function(stack){for(var n,p,s,z,i=stack.length-1;i>=0;--i){if(n=stack[i],0===i)return void(n._color=BLACK);if((p=stack[i-1]).left===n){if((s=p.right).right&&s.right._color===RED)return z=(s=p.right=cloneNode(s)).right=cloneNode(s.right),p.right=s.left,s.left=p,s.right=z,s._color=p._color,n._color=BLACK,p._color=BLACK,z._color=BLACK,recount(p),recount(s),i>1&&((pp=stack[i-2]).left===p?pp.left=s:pp.right=s),void(stack[i-1]=s);if(s.left&&s.left._color===RED)return z=(s=p.right=cloneNode(s)).left=cloneNode(s.left),p.right=z.left,s.left=z.right,z.left=p,z.right=s,z._color=p._color,p._color=BLACK,s._color=BLACK,n._color=BLACK,recount(p),recount(s),recount(z),i>1&&((pp=stack[i-2]).left===p?pp.left=z:pp.right=z),void(stack[i-1]=z);if(s._color===BLACK){if(p._color===RED)return p._color=BLACK,void(p.right=repaint(RED,s));p.right=repaint(RED,s);continue}s=cloneNode(s),p.right=s.left,s.left=p,s._color=p._color,p._color=RED,recount(p),recount(s),i>1&&((pp=stack[i-2]).left===p?pp.left=s:pp.right=s),stack[i-1]=s,stack[i]=p,i+1<stack.length?stack[i+1]=n:stack.push(n),i+=2}else{if((s=p.left).left&&s.left._color===RED)return z=(s=p.left=cloneNode(s)).left=cloneNode(s.left),p.left=s.right,s.right=p,s.left=z,s._color=p._color,n._color=BLACK,p._color=BLACK,z._color=BLACK,recount(p),recount(s),i>1&&((pp=stack[i-2]).right===p?pp.right=s:pp.left=s),void(stack[i-1]=s);if(s.right&&s.right._color===RED)return z=(s=p.left=cloneNode(s)).right=cloneNode(s.right),p.left=z.right,s.right=z.left,z.right=p,z.left=s,z._color=p._color,p._color=BLACK,s._color=BLACK,n._color=BLACK,recount(p),recount(s),recount(z),i>1&&((pp=stack[i-2]).right===p?pp.right=z:pp.left=z),void(stack[i-1]=z);if(s._color===BLACK){if(p._color===RED)return p._color=BLACK,void(p.left=repaint(RED,s));p.left=repaint(RED,s);continue}var pp;s=cloneNode(s),p.left=s.right,s.right=p,s._color=p._color,p._color=RED,recount(p),recount(s),i>1&&((pp=stack[i-2]).right===p?pp.right=s:pp.left=s),stack[i-1]=s,stack[i]=p,i+1<stack.length?stack[i+1]=n:stack.push(n),i+=2}}}(cstack),parent.left===n?parent.left=null:parent.right=null,new RedBlackTree(this.tree._compare,cstack[0])},Object.defineProperty(iproto,"key",{get:function(){if(this._stack.length>0)return this._stack[this._stack.length-1].key},enumerable:!0}),Object.defineProperty(iproto,"value",{get:function(){if(this._stack.length>0)return this._stack[this._stack.length-1].value},enumerable:!0}),Object.defineProperty(iproto,"index",{get:function(){var idx=0,stack=this._stack;if(0===stack.length){var r=this.tree.root;return r?r._count:0}stack[stack.length-1].left&&(idx=stack[stack.length-1].left._count);for(var s=stack.length-2;s>=0;--s)stack[s+1]===stack[s].right&&(++idx,stack[s].left&&(idx+=stack[s].left._count));return idx},enumerable:!0}),iproto.next=function(){var stack=this._stack;if(0!==stack.length){var n=stack[stack.length-1];if(n.right)for(n=n.right;n;)stack.push(n),n=n.left;else for(stack.pop();stack.length>0&&stack[stack.length-1].right===n;)n=stack[stack.length-1],stack.pop()}},Object.defineProperty(iproto,"hasNext",{get:function(){var stack=this._stack;if(0===stack.length)return!1;if(stack[stack.length-1].right)return!0;for(var s=stack.length-1;s>0;--s)if(stack[s-1].left===stack[s])return!0;return!1}}),iproto.update=function(value){var stack=this._stack;if(0===stack.length)throw new Error("Can't update empty node!");var cstack=new Array(stack.length),n=stack[stack.length-1];cstack[cstack.length-1]=new RBNode(n._color,n.key,value,n.left,n.right,n._count);for(var i=stack.length-2;i>=0;--i)(n=stack[i]).left===stack[i+1]?cstack[i]=new RBNode(n._color,n.key,n.value,cstack[i+1],n.right,n._count):cstack[i]=new RBNode(n._color,n.key,n.value,n.left,cstack[i+1],n._count);return new RedBlackTree(this.tree._compare,cstack[0])},iproto.prev=function(){var stack=this._stack;if(0!==stack.length){var n=stack[stack.length-1];if(n.left)for(n=n.left;n;)stack.push(n),n=n.right;else for(stack.pop();stack.length>0&&stack[stack.length-1].left===n;)n=stack[stack.length-1],stack.pop()}},Object.defineProperty(iproto,"hasPrev",{get:function(){var stack=this._stack;if(0===stack.length)return!1;if(stack[stack.length-1].left)return!0;for(var s=stack.length-1;s>0;--s)if(stack[s-1].right===stack[s])return!0;return!1}})},function(module,exports,__webpack_require__){module.exports=__webpack_require__(147)},function(module,exports,__webpack_require__){"use strict";var draining,currentQueue,scheduleDrain,types=[__webpack_require__(148),__webpack_require__(149),__webpack_require__(150),__webpack_require__(151),__webpack_require__(152)],queueIndex=-1,queue=[],scheduled=!1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&nextTick())}function nextTick(){if(!draining){scheduled=!1,draining=!0;for(var len=queue.length,timeout=setTimeout(cleanUpNextTick);len;){for(currentQueue=queue,queue=[];currentQueue&&++queueIndex<len;)currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,queueIndex=-1,draining=!1,clearTimeout(timeout)}}for(var i=-1,len=types.length;++i<len;)if(types[i]&&types[i].test&&types[i].test()){scheduleDrain=types[i].install(nextTick);break}function Item(fun,array){this.fun=fun,this.array=array}Item.prototype.run=function(){var fun=this.fun,array=this.array;switch(array.length){case 0:return fun();case 1:return fun(array[0]);case 2:return fun(array[0],array[1]);case 3:return fun(array[0],array[1],array[2]);default:return fun.apply(null,array)}},module.exports=function(task){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(task,args)),scheduled||draining||(scheduled=!0,scheduleDrain())}},function(module,exports,__webpack_require__){"use strict";(function(process){exports.test=function(){return void 0!==process&&!process.browser},exports.install=function(func){return function(){process.nextTick(func)}}}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){"use strict";(function(global){var Mutation=global.MutationObserver||global.WebKitMutationObserver;exports.test=function(){return Mutation},exports.install=function(handle){var called=0,observer=new Mutation(handle),element=global.document.createTextNode("");return observer.observe(element,{characterData:!0}),function(){element.data=called=++called%2}}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";(function(global){exports.test=function(){return!global.setImmediate&&void 0!==global.MessageChannel},exports.install=function(func){var channel=new global.MessageChannel;return channel.port1.onmessage=func,function(){channel.port2.postMessage(0)}}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";(function(global){exports.test=function(){return"document"in global&&"onreadystatechange"in global.document.createElement("script")},exports.install=function(handle){return function(){var scriptEl=global.document.createElement("script");return scriptEl.onreadystatechange=function(){handle(),scriptEl.onreadystatechange=null,scriptEl.parentNode.removeChild(scriptEl),scriptEl=null},global.document.documentElement.appendChild(scriptEl),handle}}}).call(this,__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";exports.test=function(){return!0},exports.install=function(t){return function(){setTimeout(t,0)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var debug__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(154),debug__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(debug__WEBPACK_IMPORTED_MODULE_0__);__webpack_exports__.default=function(PouchDB){PouchDB.debug=debug__WEBPACK_IMPORTED_MODULE_0___default.a;var logs={};PouchDB.on("debug",function(args){var logId=args[0],logArgs=args.slice(1);logs[logId]||(logs[logId]=debug__WEBPACK_IMPORTED_MODULE_0___default()("pouchdb:"+logId)),logs[logId].apply(null,logArgs)})}},function(module,exports,__webpack_require__){(function(process){function load(){var r;try{r=exports.storage.debug}catch(e){}return!r&&void 0!==process&&"env"in process&&(r=process.env.DEBUG),r}(exports=module.exports=__webpack_require__(155)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},exports.formatArgs=function(args){var useColors=this.useColors;if(args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff),!useColors)return;var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0,lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){"%%"!==match&&(index++,"%c"===match&&(lastC=index))}),args.splice(lastC,0,c)},exports.save=function(namespaces){try{null==namespaces?exports.storage.removeItem("debug"):exports.storage.debug=namespaces}catch(e){}},exports.load=load,exports.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},exports.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),exports.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}},exports.enable(load())}).call(this,__webpack_require__(53))},function(module,exports,__webpack_require__){function createDebug(namespace){var prevTime;function debug(){if(debug.enabled){var self=debug,curr=+new Date,ms=curr-(prevTime||curr);self.diff=ms,self.prev=prevTime,self.curr=curr,prevTime=curr;for(var args=new Array(arguments.length),i=0;i<args.length;i++)args[i]=arguments[i];args[0]=exports.coerce(args[0]),"string"!=typeof args[0]&&args.unshift("%O");var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if("%%"===match)return match;index++;var formatter=exports.formatters[format];if("function"==typeof formatter){var val=args[index];match=formatter.call(self,val),args.splice(index,1),index--}return match}),exports.formatArgs.call(self,args),(debug.log||exports.log||console.log.bind(console)).apply(self,args)}}return debug.namespace=namespace,debug.enabled=exports.enabled(namespace),debug.useColors=exports.useColors(),debug.color=function(namespace){var i,hash=0;for(i in namespace)hash=(hash<<5)-hash+namespace.charCodeAt(i),hash|=0;return exports.colors[Math.abs(hash)%exports.colors.length]}(namespace),debug.destroy=destroy,"function"==typeof exports.init&&exports.init(debug),exports.instances.push(debug),debug}function destroy(){var index=exports.instances.indexOf(this);return-1!==index&&(exports.instances.splice(index,1),!0)}(exports=module.exports=createDebug.debug=createDebug.default=createDebug).coerce=function(val){return val instanceof Error?val.stack||val.message:val},exports.disable=function(){exports.enable("")},exports.enable=function(namespaces){var i;exports.save(namespaces),exports.names=[],exports.skips=[];var split=("string"==typeof namespaces?namespaces:"").split(/[\s,]+/),len=split.length;for(i=0;i<len;i++)split[i]&&("-"===(namespaces=split[i].replace(/\*/g,".*?"))[0]?exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$")):exports.names.push(new RegExp("^"+namespaces+"$")));for(i=0;i<exports.instances.length;i++){var instance=exports.instances[i];instance.enabled=exports.enabled(instance.namespace)}},exports.enabled=function(name){if("*"===name[name.length-1])return!0;var i,len;for(i=0,len=exports.skips.length;i<len;i++)if(exports.skips[i].test(name))return!1;for(i=0,len=exports.names.length;i<len;i++)if(exports.names[i].test(name))return!0;return!1},exports.humanize=__webpack_require__(156),exports.instances=[],exports.names=[],exports.skips=[],exports.formatters={}},function(module,exports){var s=1e3,m=60*s,h=60*m,d=24*h,y=365.25*d;function plural(ms,n,name){if(!(ms<n))return ms<1.5*n?Math.floor(ms/n)+" "+name:Math.ceil(ms/n)+" "+name+"s"}module.exports=function(val,options){options=options||{};var ms,type=typeof val;if("string"===type&&val.length>0)return function(str){if((str=String(str)).length>100)return;var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match)return;var n=parseFloat(match[1]);switch((match[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(val);if("number"===type&&!1===isNaN(val))return options.long?plural(ms=val,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms":function(ms){if(ms>=d)return Math.round(ms/d)+"d";if(ms>=h)return Math.round(ms/h)+"h";if(ms>=m)return Math.round(ms/m)+"m";if(ms>=s)return Math.round(ms/s)+"s";return ms+"ms"}(val);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(15),_pouch_db_storage_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(101);_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__.StorageProviderFactory.register("pouchdb",{storage:_pouch_db_storage_js__WEBPACK_IMPORTED_MODULE_1__.PouchDbStorage,isPersistent:!0})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StorageProviderFactory",function(){return StorageProviderFactory});var _volatile_storage_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(16),_synthetic_storage_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(99);const providers={volatile:{storage:_volatile_storage_js__WEBPACK_IMPORTED_MODULE_0__.VolatileStorage,isPersistent:!1},synthetic:{storage:_synthetic_storage_js__WEBPACK_IMPORTED_MODULE_1__.SyntheticStorage,isPersistent:!1}};class StorageProviderFactory{constructor(arcId){this.arcId=arcId,this._storageInstances={},Object.keys(providers).forEach(name=>{const{storage:storage,isPersistent:isPersistent}=providers[name];this._storageInstances[name]={storage:new storage(arcId,this),isPersistent:isPersistent}})}static register(name,instance){providers[name]=instance}getInstance(key){const instance=this._storageInstances[key.split(":")[0]];if(!instance)throw new Error(`unknown storage protocol: ${key}`);return instance}_storageForKey(key){if(!key)throw new Error("key is required");return this.getInstance(key).storage}isPersistent(key){return key&&this.getInstance(key).isPersistent}async construct(id,type,keyFragment){return await this._storageForKey(keyFragment).construct(id,type,keyFragment)}async connect(id,type,key){return await this._storageForKey(key).connect(id,type,key)}async connectOrConstruct(id,type,key){const storage=this._storageForKey(key);let result=await storage.connect(id,type,key);return null==result&&(result=await storage.construct(id,type,key)),result}async baseStorageFor(type,keyString){return await this._storageForKey(keyString).baseStorageFor(type,keyString)}baseStorageKey(type,keyString){return this._storageForKey(keyString).baseStorageKey(type,keyString)}parseStringAsKey(s){return this._storageForKey(s).parseStringAsKey(s)}newKey(id,associatedKeyFragment){}async shutdown(){for(const s of Object.values(this._storageInstances))await s.storage.shutdown()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"resetVolatileStorageForTesting",function(){return resetVolatileStorageForTesting}),__webpack_require__.d(__webpack_exports__,"VolatileStorage",function(){return VolatileStorage});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_type_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(18),_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(34),_key_base_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(35),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(36),_runtime_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(38);function resetVolatileStorageForTesting(){const cache=storageCache();for(const value of cache.values())value._memoryMap={}}class VolatileKey extends _key_base_js__WEBPACK_IMPORTED_MODULE_3__.KeyBase{constructor(key){super();let parts=key.split("://");this.protocol=parts[0],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("volatile"===this.protocol,`can't construct volatile key for protocol ${this.protocol} (input key ${key})`),parts=parts[1]?parts.slice(1).join("://").split("^^"):[],this.arcId=parts[0],this.location=parts[1],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.toString()===key,`Expected ${key}, but got ${this.toString()} volatile key base.`)}base(){return"volatile"}get arcId(){return this._arcId}set arcId(arcId){this._arcId=arcId}childKeyForHandle(id){return new VolatileKey("volatile")}childKeyForArcInfo(){return new VolatileKey(`${this.protocol}://${this.arcId}^^arc-info`)}childKeyForSuggestions(userId,arcId){return new VolatileKey(`${this.protocol}://${this.arcId}^^${userId}/suggestions/${arcId}`)}childKeyForSearch(userId){return new VolatileKey(`${this.protocol}://${this.arcId}^^${userId}/search`)}toString(){return void 0!==this.location&&void 0!==this.arcId?`${this.protocol}://${this.arcId}^^${this.location}`:void 0!==this.arcId?`${this.protocol}://${this.arcId}`:`${this.protocol}`}}const storageCache=()=>_runtime_js__WEBPACK_IMPORTED_MODULE_5__.Runtime.getRuntime().getCacheService().getOrCreateCache("volatileStorageCache");class VolatileStorage extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.StorageBase{constructor(arcId){super(arcId),this._memoryMap={},this._typeMap={},this.localIDBase=0,this.typePromiseMap={},storageCache().set(this.arcId.toString(),this)}async construct(id,type,keyFragment){const provider=await this._construct(id,type,keyFragment);return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.ReferenceType||type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.BigCollectionType?provider:type.isTypeContainer()&&type.getContainedType()instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.ReferenceType?provider:(provider.enableReferenceMode(),provider)}async _construct(id,type,keyFragment){const key=new VolatileKey(keyFragment);void 0===key.arcId&&(key.arcId=this.arcId.toString()),void 0===key.location&&(key.location="volatile-"+this.localIDBase++);const provider=VolatileStorageProvider.newProvider(type,this,void 0,id,key.toString());return void 0!==this._memoryMap[key.toString()]?null:(this._memoryMap[key.toString()]=provider,provider)}async connect(id,type,key){const imKey=new VolatileKey(key);return imKey.arcId!==this.arcId.toString()?null==storageCache().get(imKey.arcId)?null:storageCache().get(imKey.arcId).connect(id,type,key):void 0===this._memoryMap[key]?null:this._memoryMap[key]}baseStorageKey(type){const key=new VolatileKey("volatile");return key.arcId=this.arcId.toString(),key.location="volatile-"+type.toString(),key.toString()}async baseStorageFor(type,key){if(this._typeMap[key])return this._typeMap[key];if(this.typePromiseMap[key])return this.typePromiseMap[key];const storagePromise=this._construct(type.toString(),type.collectionOf(),key);this.typePromiseMap[key]=storagePromise;const storage=await storagePromise;return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(storage,`could not construct baseStorage for key ${key}`),this._typeMap[key]=storage,storage}parseStringAsKey(s){const key=new VolatileKey(s);return void 0===key.arcId&&(key.arcId=this.arcId.toString()),key}}class VolatileStorageProvider extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.StorageProviderBase{constructor(){super(...arguments),this.backingStore=null,this.pendingBackingStore=null}static newProvider(type,storageEngine,name,id,key){return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.CollectionType?new VolatileCollection(type,storageEngine,name,id,key):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.BigCollectionType?new VolatileBigCollection(type,storageEngine,name,id,key):new VolatileVariable(type,storageEngine,name,id,key)}async ensureBackingStore(){if(this.backingStore)return this.backingStore;if(!this.pendingBackingStore){const key=this.storageEngine.baseStorageKey(this.backingType());this.pendingBackingStore=this.storageEngine.baseStorageFor(this.backingType(),key),this.pendingBackingStore.then(backingStore=>this.backingStore=backingStore)}return this.pendingBackingStore}}class VolatileCollection extends VolatileStorageProvider{constructor(type,storageEngine,name,id,key){super(type,name,id,key),this._model=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel,this.storageEngine=storageEngine,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==this.version)}backingType(){return this.type.getContainedType()}clone(){const handle=new VolatileCollection(this.type,this.storageEngine,this.name,this.id,null);return handle.cloneFrom(this),handle}async cloneFrom(handle){this.referenceMode=handle.referenceMode;const literal=await handle.toLiteral();if(this.referenceMode&&literal.model.length>0){await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]),literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:value.id,storageKey:this.backingStore.storageKey}}));const underlying=await handle.backingStore.getMultiple(literal.model.map(({id:id})=>id));await this.backingStore.storeMultiple(underlying,[this.storageKey])}this.fromLiteral(literal)}async modelForSynchronization(){const model=await this._toList();return{version:this.version,model:model}}async toLiteral(){return{version:this.version,model:this._model.toLiteral()}}fromLiteral({version:version,model:model}){this.version=version,this._model=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(model)}async _toList(){if(this.referenceMode){const items=(await this.toLiteral()).model;if(0===items.length)return[];const refSet=new Set;items.forEach(item=>refSet.add(item.value.storageKey)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(1===refSet.size,"multiple storageKeys in reference set of collection not yet supported.");refSet.values().next().value;await this.ensureBackingStore();const ids=items.map(item=>item.value.id),results=await this.backingStore.getMultiple(ids),output=[];for(let i=0;i<results.length;i++)output.push({id:ids[i],value:results[i],keys:items[i].keys});return output}return(await this.toLiteral()).model}async toList(){return(await this._toList()).map(item=>item.value)}async getMultiple(ids){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"getMultiple not implemented for referenceMode stores"),ids.map(id=>this._model.getValue(id))}async storeMultiple(values,keys,originatorId=null){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"storeMultiple not implemented for referenceMode stores"),values.map(value=>this._model.add(value.id,value,keys)),this.version++}async get(id){if(this.referenceMode){const ref=this._model.getValue(id);return null==ref?null:(await this.ensureBackingStore(),await this.backingStore.get(ref.id))}return this._model.getValue(id)}traceInfo(){return{items:this._model.size}}async store(value,keys,originatorId=null){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required");const item={value:value,keys:keys,effective:void 0};if(this.referenceMode){const referredType=this.type.getContainedType(),storageKey=this.backingStore?this.backingStore.storageKey:this.storageEngine.baseStorageKey(referredType);item.effective=this._model.add(value.id,{id:value.id,storageKey:storageKey},keys),await this.ensureBackingStore(),await this.backingStore.store(value,keys)}else item.effective=this._model.add(value.id,value,keys);this.version++,await this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.ChangeEvent({add:[item],version:this.version,originatorId:originatorId}))}async removeMultiple(items,originatorId=null){0===items.length&&(items=this._model.toList().map(item=>({id:item.id,keys:[]}))),items.forEach(item=>{0===item.keys.length&&(item.keys=this._model.getKeys(item.id)),item.value=this._model.getValue(item.id),null!==item.value&&(item.effective=this._model.remove(item.id,item.keys))}),this.version++,this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.ChangeEvent({remove:items,version:this.version,originatorId:originatorId}))}async remove(id,keys=[],originatorId=null){0===keys.length&&(keys=this._model.getKeys(id));const value=this._model.getValue(id);if(null!==value){const effective=this._model.remove(id,keys);this.version++,await this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.ChangeEvent({remove:[{value:value,keys:keys,effective:effective}],version:this.version,originatorId:originatorId}))}}clearItemsForTesting(){this._model=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel}}class VolatileVariable extends VolatileStorageProvider{constructor(type,storageEngine,name,id,key){super(type,name,id,key),this.localKeyId=0,this.storageEngine=storageEngine,this._stored=null,this.backingStore=null}backingType(){return this.type}clone(){const variable=new VolatileVariable(this.type,this.storageEngine,this.name,this.id,null);return variable.cloneFrom(this),variable}async cloneFrom(handle){this.referenceMode=handle.referenceMode,handle.referenceMode&&handle.localModified&&await handle._persistChanges();const literal=await handle.toLiteral();if(this.referenceMode&&literal.model.length>0){await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]),literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:value.id,storageKey:this.backingStore.storageKey}}));const underlying=await handle.backingStore.getMultiple(literal.model.map(({id:id})=>id));await this.backingStore.storeMultiple(underlying,[this.storageKey])}await this.fromLiteral(literal)}async modelForSynchronization(){if(this.referenceMode&&null!==this._stored){const value=this._stored;await this.ensureBackingStore();const result=await this.backingStore.get(value.id);return{version:this.version,model:[{id:value.id,value:result}]}}return super.modelForSynchronization()}async toLiteral(){const value=this._stored,model=null!=value?[{id:value.id,value:value,keys:[]}]:[];return{version:this.version,model:model}}fromLiteral({version:version,model:model}){const value=0===model.length?null:model[0].value;this.referenceMode&&value&&value.rawData&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,`shouldn't have rawData ${JSON.stringify(value.rawData)} here`),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value),this._stored=value,this.version=version}traceInfo(){return{stored:null!==this._stored}}async get(){if(this.referenceMode&&this._stored){const value=this._stored;return await this.ensureBackingStore(),await this.backingStore.get(value.id)}return this._stored}async set(value,originatorId=null,barrier=null){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value),this.referenceMode&&value){const referredType=this.type,storageKey=this.backingStore?this.backingStore.storageKey:this.storageEngine.baseStorageKey(referredType);this._stored={id:value.id,storageKey:storageKey},await this.ensureBackingStore(),await this.backingStore.store(value,[this.storageKey+this.localKeyId++])}else{if(JSON.stringify(this._stored)===JSON.stringify(value)&&null==barrier)return;this._stored=value}this.version++;const data=this.referenceMode?value:this._stored;await this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_4__.ChangeEvent({data:data,version:this.version,originatorId:originatorId,barrier:barrier}))}async clear(originatorId=null,barrier=null){await this.set(null,originatorId,barrier)}}class VolatileCursor{constructor(version,data,pageSize,forward){this.version=version,this.pageSize=pageSize;const copy=[...data];copy.sort((a,b)=>a.index-b.index),this.data=copy.map(v=>v.value),forward||this.data.reverse()}async next(){return 0===this.data.length?{done:!0}:{value:this.data.splice(0,this.pageSize),done:!1}}close(){this.data=[]}}class VolatileBigCollection extends VolatileStorageProvider{constructor(type,storageEngine,name,id,key){super(type,name,id,key),this.items=new Map,this.cursors=new Map,this.cursorIndex=0}enableReferenceMode(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"referenceMode is not supported for BigCollection")}backingType(){return this.type.getContainedType()}async get(id){const data=this.items.get(id);return void 0!==data?data.value:null}async store(value,keys,originatorId){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required"),this.version++,this.items.has(value.id)||this.items.set(value.id,{index:null,value:null,keys:{}});const data=this.items.get(value.id);data.index=this.version,data.value=value,keys.forEach(k=>data.keys[k]=this.version)}async remove(id,keys,originatorId){this.version++,this.items.delete(id)}async stream(pageSize,forward=!0){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!isNaN(pageSize)&&pageSize>0),this.cursorIndex++;const cursor=new VolatileCursor(this.version,this.items.values(),pageSize,forward);return this.cursors.set(this.cursorIndex,cursor),this.cursorIndex}async cursorNext(cursorId){const cursor=this.cursors.get(cursorId);if(!cursor)return{done:!0};const data=await cursor.next();return data.done&&this.cursors.delete(cursorId),data}async cursorClose(cursorId){const cursor=this.cursors.get(cursorId);cursor&&(this.cursors.delete(cursorId),cursor.close())}cursorVersion(cursorId){const cursor=this.cursors.get(cursorId);return cursor?cursor.version:null}async cloneFrom(handle){handle.items&&this.fromLiteral(handle.toLiteral())}async toLiteral(){const model=[];for(const[id,{index:index,value:value,keys:keys}]of this.items.entries())model.push({id:id,index:index,value:value,keys:Object.keys(keys)});return{version:this.version,model:model}}fromLiteral({version:version,model:model}){this.version=version,this.items.clear();for(const{id:id,index:index,value:value,keys:keys}of model){const adjustedKeys={};for(const k of keys)adjustedKeys[k]=index;this.items.set(id,{index:index,value:value,keys:adjustedKeys})}}clearItemsForTesting(){this.items.clear()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";function assert(test,message){if(!test)throw new Error(message)}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"assert",function(){return assert})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Type",function(){return Type}),__webpack_require__.d(__webpack_exports__,"EntityType",function(){return EntityType}),__webpack_require__.d(__webpack_exports__,"TypeVariable",function(){return TypeVariable}),__webpack_require__.d(__webpack_exports__,"CollectionType",function(){return CollectionType}),__webpack_require__.d(__webpack_exports__,"BigCollectionType",function(){return BigCollectionType}),__webpack_require__.d(__webpack_exports__,"RelationType",function(){return RelationType}),__webpack_require__.d(__webpack_exports__,"InterfaceType",function(){return InterfaceType}),__webpack_require__.d(__webpack_exports__,"SlotType",function(){return SlotType}),__webpack_require__.d(__webpack_exports__,"ReferenceType",function(){return ReferenceType}),__webpack_require__.d(__webpack_exports__,"ArcType",function(){return ArcType}),__webpack_require__.d(__webpack_exports__,"HandleType",function(){return HandleType});var _interface_info_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(19),_schema_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(21),_slot_info_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(31),_synthetic_types_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(32),_type_variable_info_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(33);
// @license
class Type{constructor(tag){this.tag=tag}static fromLiteral(literal){switch(literal.tag){case"Entity":return new EntityType(_schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema.fromLiteral(literal.data));case"TypeVariable":return new TypeVariable(_type_variable_info_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariableInfo.fromLiteral(literal.data));case"Collection":return new CollectionType(Type.fromLiteral(literal.data));case"BigCollection":return new BigCollectionType(Type.fromLiteral(literal.data));case"Relation":return new RelationType(literal.data.map(t=>Type.fromLiteral(t)));case"Interface":return new InterfaceType(_interface_info_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceInfo.fromLiteral(literal.data));case"Slot":return new SlotType(_slot_info_js__WEBPACK_IMPORTED_MODULE_2__.SlotInfo.fromLiteral(literal.data));case"Reference":return new ReferenceType(Type.fromLiteral(literal.data));case"Arc":return new ArcType;case"Handle":return new HandleType;default:throw new Error(`fromLiteral: unknown type ${literal}`)}}static unwrapPair(type1,type2){if(type1.tag===type2.tag){const contained1=type1.getContainedType();if(null!==contained1)return Type.unwrapPair(contained1,type2.getContainedType())}return[type1,type2]}static canMergeConstraints(type1,type2){return Type._canMergeCanReadSubset(type1,type2)&&Type._canMergeCanWriteSuperset(type1,type2)}static _canMergeCanReadSubset(type1,type2){if(type1.canReadSubset&&type2.canReadSubset){if(type1.canReadSubset.tag!==type2.canReadSubset.tag)return!1;if(type1.canReadSubset instanceof EntityType)return null!==_schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema.intersect(type1.canReadSubset.entitySchema,type2.canReadSubset.entitySchema);throw new Error(`_canMergeCanReadSubset not implemented for types tagged with ${type1.canReadSubset.tag}`)}return!0}static _canMergeCanWriteSuperset(type1,type2){if(type1.canWriteSuperset&&type2.canWriteSuperset){if(type1.canWriteSuperset.tag!==type2.canWriteSuperset.tag)return!1;if(type1.canWriteSuperset instanceof EntityType)return null!==_schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema.union(type1.canWriteSuperset.entitySchema,type2.canWriteSuperset.entitySchema)}return!0}isCollectionType(){return this instanceof CollectionType}isBigCollectionType(){return this instanceof BigCollectionType}isResolved(){return!this.hasUnresolvedVariable}mergeTypeVariablesByName(variableMap){return this}_applyExistenceTypeTest(test){return test(this)}get hasVariable(){return this._applyExistenceTypeTest(type=>type instanceof TypeVariable)}get hasUnresolvedVariable(){return this._applyExistenceTypeTest(type=>type instanceof TypeVariable&&!type.variable.isResolved())}getContainedType(){return null}isTypeContainer(){return!1}collectionOf(){return new CollectionType(this)}bigCollectionOf(){return new BigCollectionType(this)}resolvedType(){return this}canEnsureResolved(){return this.isResolved()||this._canEnsureResolved()}_canEnsureResolved(){return!0}maybeEnsureResolved(){return!0}get canWriteSuperset(){throw new Error(`canWriteSuperset not implemented for ${this}`)}get canReadSubset(){throw new Error(`canReadSubset not implemented for ${this}`)}isMoreSpecificThan(type){return this.tag===type.tag&&this._isMoreSpecificThan(type)}_isMoreSpecificThan(type){throw new Error(`isMoreSpecificThan not implemented for ${this}`)}clone(variableMap){return this.resolvedType()._clone(variableMap)}_clone(variableMap){return Type.fromLiteral(this.toLiteral())}_cloneWithResolutions(variableMap){return Type.fromLiteral(this.toLiteral())}hasProperty(property){return property(this)||this._hasProperty(property)}_hasProperty(property){return!1}toString(options){return this.tag}getEntitySchema(){return null}toPrettyString(){return null}}class EntityType extends Type{constructor(schema){super("Entity"),this.entitySchema=schema}static make(names,fields,description){return new EntityType(new _schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema(names,fields,description))}get isEntity(){return!0}get canWriteSuperset(){return this}get canReadSubset(){return this}_isMoreSpecificThan(type){return this.entitySchema.isMoreSpecificThan(type.entitySchema)}toLiteral(){return{tag:this.tag,data:this.entitySchema.toLiteral()}}toString(options){return this.entitySchema.toInlineSchemaString(options)}getEntitySchema(){return this.entitySchema}_cloneWithResolutions(variableMap){if(variableMap.has(this.entitySchema))return variableMap.get(this.entitySchema);const clonedEntityType=new EntityType(this.entitySchema);return variableMap.set(this.entitySchema,clonedEntityType),clonedEntityType}toPrettyString(){return this.entitySchema.description.pattern?this.entitySchema.description.pattern:this.entitySchema.name?this.entitySchema.name.replace(/([^A-Z])([A-Z])/g,"$1 $2").replace(/([A-Z][^A-Z])/g," $1").replace(/[\s]+/g," ").trim():JSON.stringify(this.entitySchema.toLiteral())}}class TypeVariable extends Type{constructor(variable){super("TypeVariable"),this.variable=variable}static make(name,canWriteSuperset,canReadSubset){return new TypeVariable(new _type_variable_info_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariableInfo(name,canWriteSuperset,canReadSubset))}get isVariable(){return!0}mergeTypeVariablesByName(variableMap){const name=this.variable.name;let variable=variableMap.get(name);if(variable){if(variable instanceof TypeVariable&&(variable.variable.hasConstraint||this.variable.hasConstraint)){if(!variable.variable.maybeMergeConstraints(this.variable))throw new Error("could not merge type variables")}}else variable=this,variableMap.set(name,this);return variable}resolvedType(){return this.variable.resolution||this}_canEnsureResolved(){return this.variable.canEnsureResolved()}maybeEnsureResolved(){return this.variable.maybeEnsureResolved()}get canWriteSuperset(){return this.variable.canWriteSuperset}get canReadSubset(){return this.variable.canReadSubset}_clone(variableMap){const name=this.variable.name;if(variableMap.has(name))return new TypeVariable(variableMap.get(name));{const newTypeVariable=_type_variable_info_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariableInfo.fromLiteral(this.variable.toLiteral());return variableMap.set(name,newTypeVariable),new TypeVariable(newTypeVariable)}}_cloneWithResolutions(variableMap){if(variableMap.has(this.variable))return new TypeVariable(variableMap.get(this.variable));{const newTypeVariable=_type_variable_info_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariableInfo.fromLiteral(this.variable.toLiteralIgnoringResolutions());return this.variable.resolution&&(newTypeVariable._resolution=this.variable._resolution._cloneWithResolutions(variableMap)),this.variable._canReadSubset&&(newTypeVariable.canReadSubset=this.variable.canReadSubset._cloneWithResolutions(variableMap)),this.variable._canWriteSuperset&&(newTypeVariable.canWriteSuperset=this.variable.canWriteSuperset._cloneWithResolutions(variableMap)),variableMap.set(this.variable,newTypeVariable),new TypeVariable(newTypeVariable)}}toLiteral(){return this.variable.resolution?this.variable.resolution.toLiteral():{tag:this.tag,data:this.variable.toLiteral()}}toString(options){return`~${this.variable.name}`}getEntitySchema(){return this.variable.isResolved()?this.resolvedType().getEntitySchema():null}toPrettyString(){return this.variable.isResolved()?this.resolvedType().toPrettyString():`[~${this.variable.name}]`}}class CollectionType extends Type{constructor(collectionType){super("Collection"),this.collectionType=collectionType}get isCollection(){return!0}mergeTypeVariablesByName(variableMap){const collectionType=this.collectionType,result=collectionType.mergeTypeVariablesByName(variableMap);return result===collectionType?this:result.collectionOf()}_applyExistenceTypeTest(test){return this.collectionType._applyExistenceTypeTest(test)}getContainedType(){return this.collectionType}isTypeContainer(){return!0}resolvedType(){const collectionType=this.collectionType,resolvedCollectionType=collectionType.resolvedType();return collectionType!==resolvedCollectionType?resolvedCollectionType.collectionOf():this}_canEnsureResolved(){return this.collectionType.canEnsureResolved()}maybeEnsureResolved(){return this.collectionType.maybeEnsureResolved()}_clone(variableMap){const data=this.collectionType.clone(variableMap).toLiteral();return Type.fromLiteral({tag:this.tag,data:data})}_cloneWithResolutions(variableMap){return new CollectionType(this.collectionType._cloneWithResolutions(variableMap))}toLiteral(){return{tag:this.tag,data:this.collectionType.toLiteral()}}_hasProperty(property){return this.collectionType.hasProperty(property)}toString(options){return`[${this.collectionType.toString(options)}]`}getEntitySchema(){return this.collectionType.getEntitySchema()}toPrettyString(){const entitySchema=this.getEntitySchema();return entitySchema&&entitySchema.description.plural?entitySchema.description.plural:`${this.collectionType.toPrettyString()} List`}}class BigCollectionType extends Type{constructor(bigCollectionType){super("BigCollection"),this.bigCollectionType=bigCollectionType}get isBigCollection(){return!0}mergeTypeVariablesByName(variableMap){const collectionType=this.bigCollectionType,result=collectionType.mergeTypeVariablesByName(variableMap);return result===collectionType?this:result.bigCollectionOf()}_applyExistenceTypeTest(test){return this.bigCollectionType._applyExistenceTypeTest(test)}getContainedType(){return this.bigCollectionType}isTypeContainer(){return!0}resolvedType(){const collectionType=this.bigCollectionType,resolvedCollectionType=collectionType.resolvedType();return collectionType!==resolvedCollectionType?resolvedCollectionType.bigCollectionOf():this}_canEnsureResolved(){return this.bigCollectionType.canEnsureResolved()}maybeEnsureResolved(){return this.bigCollectionType.maybeEnsureResolved()}_clone(variableMap){const data=this.bigCollectionType.clone(variableMap).toLiteral();return Type.fromLiteral({tag:this.tag,data:data})}_cloneWithResolutions(variableMap){return new BigCollectionType(this.bigCollectionType._cloneWithResolutions(variableMap))}toLiteral(){return{tag:this.tag,data:this.bigCollectionType.toLiteral()}}_hasProperty(property){return this.bigCollectionType.hasProperty(property)}toString(options){return`BigCollection<${this.bigCollectionType.toString(options)}>`}getEntitySchema(){return this.bigCollectionType.getEntitySchema()}toPrettyString(){const entitySchema=this.getEntitySchema();return entitySchema&&entitySchema.description.plural?entitySchema.description.plural:`Collection of ${this.bigCollectionType.toPrettyString()}`}}class RelationType extends Type{constructor(relation){super("Relation"),this.relationEntities=relation}get isRelation(){return!0}toLiteral(){return{tag:this.tag,data:this.relationEntities.map(t=>t.toLiteral())}}toPrettyString(){return JSON.stringify(this.relationEntities)}}class InterfaceType extends Type{constructor(iface){super("Interface"),this.interfaceInfo=iface}static make(name,handles,slots){return new InterfaceType(new _interface_info_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceInfo(name,handles,slots))}get isInterface(){return!0}mergeTypeVariablesByName(variableMap){const interfaceInfo=this.interfaceInfo.clone(new Map);return interfaceInfo.mergeTypeVariablesByName(variableMap),new InterfaceType(interfaceInfo)}_applyExistenceTypeTest(test){return this.interfaceInfo._applyExistenceTypeTest(test)}resolvedType(){return new InterfaceType(this.interfaceInfo.resolvedType())}_canEnsureResolved(){return this.interfaceInfo.canEnsureResolved()}maybeEnsureResolved(){return this.interfaceInfo.maybeEnsureResolved()}get canWriteSuperset(){return new InterfaceType(this.interfaceInfo.canWriteSuperset)}get canReadSubset(){return new InterfaceType(this.interfaceInfo.canReadSubset)}_isMoreSpecificThan(type){return this.interfaceInfo.isMoreSpecificThan(type.interfaceInfo)}_clone(variableMap){const data=this.interfaceInfo.clone(variableMap).toLiteral();return Type.fromLiteral({tag:this.tag,data:data})}_cloneWithResolutions(variableMap){return new InterfaceType(this.interfaceInfo._cloneWithResolutions(variableMap))}toLiteral(){return{tag:this.tag,data:this.interfaceInfo.toLiteral()}}toString(options){return this.interfaceInfo.name}toPrettyString(){return this.interfaceInfo.toPrettyString()}}class SlotType extends Type{constructor(slot){super("Slot"),this.slot=slot}static make(formFactor,handle){return new SlotType(new _slot_info_js__WEBPACK_IMPORTED_MODULE_2__.SlotInfo(formFactor,handle))}get isSlot(){return!0}get canWriteSuperset(){return this}get canReadSubset(){return this}_isMoreSpecificThan(type){return!0}toLiteral(){return{tag:this.tag,data:this.slot.toLiteral()}}toString(options){const fields=[];for(const key of Object.keys(this.slot))void 0!==this.slot[key]&&fields.push(`${key}:${this.slot[key]}`);let fieldsString="";return 0!==fields.length&&(fieldsString=` {${fields.join(", ")}}`),`Slot${fieldsString}`}toPrettyString(){const fields=[];for(const key of Object.keys(this.slot))void 0!==this.slot[key]&&fields.push(`${key}:${this.slot[key]}`);let fieldsString="";return 0!==fields.length&&(fieldsString=` {${fields.join(", ")}}`),`Slot${fieldsString}`}}class ReferenceType extends Type{constructor(reference){super("Reference"),this.referredType=reference}get isReference(){return!0}getContainedType(){return this.referredType}isTypeContainer(){return!0}resolvedType(){const referredType=this.referredType,resolvedReferredType=referredType.resolvedType();return referredType!==resolvedReferredType?new ReferenceType(resolvedReferredType):this}_canEnsureResolved(){return this.referredType.canEnsureResolved()}maybeEnsureResolved(){return this.referredType.maybeEnsureResolved()}get canReadSubset(){return this.referredType.canReadSubset}_clone(variableMap){const data=this.referredType.clone(variableMap).toLiteral();return Type.fromLiteral({tag:this.tag,data:data})}_cloneWithResolutions(variableMap){return new ReferenceType(this.referredType._cloneWithResolutions(variableMap))}toLiteral(){return{tag:this.tag,data:this.referredType.toLiteral()}}toString(options){return"Reference<"+this.referredType.toString()+">"}}class ArcType extends Type{constructor(){super("Arc")}get isArc(){return!0}newInstance(arcId,serialization){return new _synthetic_types_js__WEBPACK_IMPORTED_MODULE_3__.ArcInfo(arcId,serialization)}toLiteral(){return{tag:this.tag}}}class HandleType extends Type{constructor(){super("Handle")}get isHandle(){return!0}toLiteral(){return{tag:this.tag}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"InterfaceInfo",function(){return InterfaceInfo});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(20),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
function _typeFromLiteral(member){return _type_js__WEBPACK_IMPORTED_MODULE_2__.Type.fromLiteral(member)}function _typeVarOrStringFromLiteral(member){return"object"==typeof member?_typeFromLiteral(member):member}function _HandleFromLiteral({type:type,name:name,direction:direction}){return{type:type?_typeFromLiteral(type):void 0,name:name?_typeVarOrStringFromLiteral(name):void 0,direction:direction}}function _SlotFromLiteral({name:name,direction:direction,isRequired:isRequired,isSet:isSet}){return{name:name?_typeVarOrStringFromLiteral(name):void 0,direction:direction,isRequired:isRequired,isSet:isSet}}function _typeVarOrStringToLiteral(member){return member instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable?member.toLiteral():member}function _HandleToLiteral({type:type,name:name,direction:direction}){return{type:type?type.toLiteral():void 0,name:name?_typeVarOrStringToLiteral(name):void 0,direction:direction}}function _SlotToLiteral({name:name,direction:direction,isRequired:isRequired,isSet:isSet}){return{name:name?_typeVarOrStringToLiteral(name):void 0,direction:direction,isRequired:isRequired,isSet:isSet}}const handleFields=["type","name","direction"],slotFields=["name","direction","isRequired","isSet"];class InterfaceInfo{constructor(name,handles,slots){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(name),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==handles),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==slots),this.name=name,this.handles=handles,this.slots=slots,this.typeVars=[];for(const handle of handles)for(const field of handleFields)InterfaceInfo.isTypeVar(handle[field])&&this.typeVars.push({object:handle,field:field});for(const slot of slots)for(const field of slotFields)InterfaceInfo.isTypeVar(slot[field])&&this.typeVars.push({object:slot,field:field})}toPrettyString(){return"InterfaceInfo"}mergeTypeVariablesByName(variableMap){this.typeVars.map(({object:object,field:field})=>object[field]=object[field].mergeTypeVariablesByName(variableMap))}get canReadSubset(){return this._cloneAndUpdate(typeVar=>typeVar.canReadSubset)}get canWriteSuperset(){return this._cloneAndUpdate(typeVar=>typeVar.canWriteSuperset)}isMoreSpecificThan(other){if(this.handles.length!==other.handles.length||this.slots.length!==other.slots.length)return!1;for(let i=0;i<this.typeVars.length;i++){const thisTypeVar=this.typeVars[i],otherTypeVar=other.typeVars[i];if(!thisTypeVar.object[thisTypeVar.field].isMoreSpecificThan(otherTypeVar.object[otherTypeVar.field]))return!1}return!0}_applyExistenceTypeTest(test){for(const typeRef of this.typeVars)if(test(typeRef.object[typeRef.field]))return!0;return!1}_handlesToManifestString(){return this.handles.map(h=>`  ${h.direction?h.direction+" ":""}${h.type.toString()} ${h.name?h.name:"*"}`).join("\n")}_slotsToManifestString(){return this.slots.map(slot=>`  ${slot.direction} ${slot.isSet?"set of ":""}${slot.name?slot.name+" ":""}`).join("\n")}toString(){return`interface ${this.name}\n${this._handlesToManifestString()}\n${this._slotsToManifestString()}`}static fromLiteral(data){const handles=data.handles.map(_HandleFromLiteral),slots=data.slots.map(_SlotFromLiteral);return new InterfaceInfo(data.name,handles,slots)}toLiteral(){const handles=this.handles.map(_HandleToLiteral),slots=this.slots.map(_SlotToLiteral);return{name:this.name,handles:handles,slots:slots}}clone(variableMap){const handles=this.handles.map(({name:name,direction:direction,type:type})=>({name:name,direction:direction,type:type?type.clone(variableMap):void 0})),slots=this.slots.map(({name:name,direction:direction,isRequired:isRequired,isSet:isSet})=>({name:name,direction:direction,isRequired:isRequired,isSet:isSet}));return new InterfaceInfo(this.name,handles,slots)}cloneWithResolutions(variableMap){return this._cloneWithResolutions(variableMap)}_cloneWithResolutions(variableMap){const handles=this.handles.map(({name:name,direction:direction,type:type})=>({name:name,direction:direction,type:type?type._cloneWithResolutions(variableMap):void 0})),slots=this.slots.map(({name:name,direction:direction,isRequired:isRequired,isSet:isSet})=>({name:name,direction:direction,isRequired:isRequired,isSet:isSet}));return new InterfaceInfo(this.name,handles,slots)}canEnsureResolved(){for(const typeVar of this.typeVars)if(!typeVar.object[typeVar.field].canEnsureResolved())return!1;return!0}maybeEnsureResolved(){for(const typeVar of this.typeVars){let variable=typeVar.object[typeVar.field];if(!(variable=variable.clone(new Map)).maybeEnsureResolved())return!1}for(const typeVar of this.typeVars)typeVar.object[typeVar.field].maybeEnsureResolved();return!0}tryMergeTypeVariablesWith(other){if(!this._equalItems(other.slots,this.slots,this._equalSlot))return null;if(other.handles.length!==this.handles.length)return null;const handles=new Set(this.handles),otherHandles=new Set(other.handles),handleMap=new Map;let sizeCheck=handles.size;for(;handles.size>0;){const handleMatches=[...handles.values()].map(handle=>({handle:handle,match:[...otherHandles.values()].filter(otherHandle=>this._equalHandle(handle,otherHandle))}));for(const handleMatch of handleMatches){if(0===handleMatch.match.length)return null;1===handleMatch.match.length&&(handleMap.set(handleMatch.handle,handleMatch.match[0]),otherHandles.delete(handleMatch.match[0]),handles.delete(handleMatch.handle))}if(handles.size===sizeCheck)return null;sizeCheck=handles.size}const handleList=[];for(const handle of this.handles){const otherHandle=handleMap.get(handle);let resultType;if(handle.type.hasVariable||otherHandle.type.hasVariable){if(!(resultType=_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker._tryMergeTypeVariable(handle.type,otherHandle.type)))return null}else resultType=handle.type||otherHandle.type;handleList.push({name:handle.name||otherHandle.name,direction:handle.direction||otherHandle.direction,type:resultType})}const slots=this.slots.map(({name:name,direction:direction,isRequired:isRequired,isSet:isSet})=>({name:name,direction:direction,isRequired:isRequired,isSet:isSet}));return new InterfaceInfo(this.name,handleList,slots)}resolvedType(){return this._cloneAndUpdate(typeVar=>typeVar.resolvedType())}equals(other){return this.handles.length===other.handles.length&&(!!this._equalItems(other.handles,this.handles,this._equalHandle)&&!!this._equalItems(other.slots,this.slots,this._equalSlot))}_equalHandle(handle,otherHandle){return handle.name===otherHandle.name&&handle.direction===otherHandle.direction&&_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:handle.type},{type:otherHandle.type})}_equalSlot(slot,otherSlot){return slot.name===otherSlot.name&&slot.direction===otherSlot.direction&&slot.isRequired===otherSlot.isRequired&&slot.isSet===otherSlot.isSet}_equalItems(otherItems,items,compareItem){for(const otherItem of otherItems){let exists=!1;for(const item of items)if(compareItem(item,otherItem)){exists=!0;break}if(!exists)return!1}return!0}_cloneAndUpdate(update){const copy=this.clone(new Map);return copy.typeVars.forEach(typeVar=>InterfaceInfo._updateTypeVar(typeVar,update)),copy}static _updateTypeVar(typeVar,update){typeVar.object[typeVar.field]=update(typeVar.object[typeVar.field])}static isTypeVar(reference){return reference instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable||reference instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.Type&&reference.hasVariable}static mustMatch(reference){return!(null==reference||InterfaceInfo.isTypeVar(reference))}static handlesMatch(interfaceHandle,particleHandle){if(InterfaceInfo.mustMatch(interfaceHandle.name)&&interfaceHandle.name!==particleHandle.name)return!1;if(InterfaceInfo.mustMatch(interfaceHandle.direction)&&interfaceHandle.direction!==particleHandle.direction)return!1;if(null==interfaceHandle.type)return!0;const[left,right]=_type_js__WEBPACK_IMPORTED_MODULE_2__.Type.unwrapPair(interfaceHandle.type,particleHandle.type);return left instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable?[{var:left,value:right,direction:interfaceHandle.direction}]:_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:left},{type:right})}static slotsMatch(interfaceSlot,particleSlot){return(!InterfaceInfo.mustMatch(interfaceSlot.name)||interfaceSlot.name===particleSlot.name)&&((!InterfaceInfo.mustMatch(interfaceSlot.direction)||interfaceSlot.direction===particleSlot.direction)&&((!InterfaceInfo.mustMatch(interfaceSlot.isRequired)||interfaceSlot.isRequired===particleSlot.isRequired)&&(!InterfaceInfo.mustMatch(interfaceSlot.isSet)||interfaceSlot.isSet===particleSlot.isSet)))}particleMatches(particleSpec){return!1!==this.cloneWithResolutions(new Map).restrictType(particleSpec)}restrictType(particleSpec){return this._restrictThis(particleSpec)}_restrictThis(particleSpec){const handleMatches=this.handles.map(h=>particleSpec.handleConnections.map(c=>({match:c,result:InterfaceInfo.handlesMatch(h,c)})).filter(a=>!1!==a.result)),particleSlots=[];particleSpec.slotConnections.forEach(consumedSlot=>{particleSlots.push({name:consumedSlot.name,direction:"consume",isRequired:consumedSlot.isRequired,isSet:consumedSlot.isSet}),consumedSlot.provideSlotConnections.forEach(providedSlot=>{particleSlots.push({name:providedSlot.name,direction:"provide",isRequired:!1,isSet:providedSlot.isSet})})});const slotMatches=this.slots.map(slot=>particleSlots.filter(particleSlot=>InterfaceInfo.slotsMatch(slot,particleSlot))).map(matchList=>matchList.map(slot=>({match:slot,result:!0})));function choose(list,exclusions){if(0===list.length)return[];const thisLevel=list.pop();for(const connection of thisLevel){if(exclusions.includes(connection.match))continue;const newExclusions=exclusions.slice();newExclusions.push(connection.match);const constraints=choose(list,newExclusions);if(!1!==constraints)return"boolean"==typeof connection.result?constraints:constraints.concat(connection.result)}return!1}const handleOptions=choose(handleMatches,[]),slotOptions=choose(slotMatches,[]);if(!1===handleOptions||!1===slotOptions)return!1;for(const constraint of handleOptions)if(constraint.var.variable.resolution){if(constraint.var.variable.resolution instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable){if(!_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.processTypeList(constraint.var,[{type:constraint.value,direction:constraint.direction}]))return!1}else if(!_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:constraint.var.variable.resolution},{type:constraint.value}))return!1}else constraint.var.variable.resolution=constraint.value;return!0}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"TypeChecker",function(){return TypeChecker});var _type_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18);class TypeChecker{static processTypeList(baseType,list){const newBaseType=_type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable.make("",null,null);baseType&&(newBaseType.variable.resolution=baseType),baseType=newBaseType;const concreteTypes=[];for(const item of list)if(item.type.resolvedType().hasVariable){if(null==(baseType=TypeChecker._tryMergeTypeVariable(baseType,item.type)))return null}else concreteTypes.push(item);for(const item of concreteTypes)if(!TypeChecker._tryMergeConstraints(baseType,item))return null;const getResolution=candidate=>candidate instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable?null==candidate.canReadSubset||null==candidate.canWriteSuperset?candidate:candidate.canReadSubset.isMoreSpecificThan(candidate.canWriteSuperset)?(candidate.canWriteSuperset.isMoreSpecificThan(candidate.canReadSubset)&&(candidate.variable.resolution=candidate.canReadSubset),candidate):null:candidate,candidate=baseType.resolvedType();if(candidate.isCollectionType()){const resolution=getResolution(candidate.collectionType);return null!==resolution?resolution.collectionOf():null}if(candidate.isBigCollectionType()){const resolution=getResolution(candidate.bigCollectionType);return null!==resolution?resolution.bigCollectionOf():null}return getResolution(candidate)}static _tryMergeTypeVariable(base,onto){const[primitiveBase,primitiveOnto]=_type_js__WEBPACK_IMPORTED_MODULE_0__.Type.unwrapPair(base.resolvedType(),onto.resolvedType());if(primitiveBase instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable){if(primitiveOnto instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable){if(!1===primitiveBase.variable.maybeMergeConstraints(primitiveOnto.variable))return null;primitiveOnto.variable.resolution=primitiveBase}else{if(!primitiveBase.variable.isValidResolutionCandidate(primitiveOnto).result)return null;primitiveBase.variable.resolution=primitiveOnto}return base}if(primitiveOnto instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable)return primitiveOnto.variable.isValidResolutionCandidate(primitiveBase).result?(primitiveOnto.variable.resolution=primitiveBase,onto):null;if(primitiveBase instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceType&&primitiveOnto instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceType){const result=primitiveBase.interfaceInfo.tryMergeTypeVariablesWith(primitiveOnto.interfaceInfo);return null==result?null:new _type_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceType(result)}if(primitiveBase.isTypeContainer()&&primitiveBase.hasVariable||primitiveOnto.isTypeContainer()&&primitiveOnto.hasVariable)return null;throw new Error("tryMergeTypeVariable shouldn't be called on two types without any type variables")}static _tryMergeConstraints(handleType,{type:type,direction:direction}){let[primitiveHandleType,primitiveConnectionType]=_type_js__WEBPACK_IMPORTED_MODULE_0__.Type.unwrapPair(handleType.resolvedType(),type.resolvedType());if(primitiveHandleType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable){for(;primitiveConnectionType.isTypeContainer();){if(null!=primitiveHandleType.variable.resolution||null!=primitiveHandleType.variable.canReadSubset||null!=primitiveHandleType.variable.canWriteSuperset)return!1;const newVar=_type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable.make("a",null,null);primitiveConnectionType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.CollectionType?primitiveHandleType.variable.resolution=new _type_js__WEBPACK_IMPORTED_MODULE_0__.CollectionType(newVar):primitiveConnectionType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.BigCollectionType?primitiveHandleType.variable.resolution=new _type_js__WEBPACK_IMPORTED_MODULE_0__.BigCollectionType(newVar):primitiveHandleType.variable.resolution=new _type_js__WEBPACK_IMPORTED_MODULE_0__.ReferenceType(newVar);const unwrap=_type_js__WEBPACK_IMPORTED_MODULE_0__.Type.unwrapPair(primitiveHandleType.resolvedType(),primitiveConnectionType);if([primitiveHandleType,primitiveConnectionType]=unwrap,!(primitiveHandleType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable))throw new TypeError("unwrapping a wrapped TypeVariable somehow didn't become a TypeVariable")}if(("out"===direction||"inout"===direction||"`provide"===direction)&&!primitiveHandleType.variable.maybeMergeCanReadSubset(primitiveConnectionType.canWriteSuperset))return!1;if(("in"===direction||"inout"===direction||"`consume"===direction)&&!primitiveHandleType.variable.maybeMergeCanWriteSuperset(primitiveConnectionType.canReadSubset))return!1}else{if(primitiveConnectionType.tag!==primitiveHandleType.tag)return!1;if(("out"===direction||"inout"===direction)&&!TypeChecker._writeConstraintsApply(primitiveHandleType,primitiveConnectionType))return!1;if(("in"===direction||"inout"===direction)&&!TypeChecker._readConstraintsApply(primitiveHandleType,primitiveConnectionType))return!1}return!0}static _writeConstraintsApply(handleType,connectionType){const writtenType=connectionType.canWriteSuperset;return null==writtenType||null==handleType.canReadSubset||!!writtenType.isMoreSpecificThan(handleType.canReadSubset)}static _readConstraintsApply(handleType,connectionType){const readType=connectionType.canReadSubset;return null==readType||null==handleType.canWriteSuperset||!!handleType.canWriteSuperset.isMoreSpecificThan(readType)}static compareTypes(left,right){const resolvedLeft=left.type.resolvedType(),resolvedRight=right.type.resolvedType(),[leftType,rightType]=_type_js__WEBPACK_IMPORTED_MODULE_0__.Type.unwrapPair(resolvedLeft,resolvedRight);if(leftType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable&&rightType.isTypeContainer())return!(leftType.variable.canReadSubset||leftType.variable.canWriteSuperset);if(rightType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable&&leftType.isTypeContainer())return!(rightType.variable.canReadSubset||rightType.variable.canWriteSuperset);if(leftType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable||rightType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.TypeVariable)return _type_js__WEBPACK_IMPORTED_MODULE_0__.Type.canMergeConstraints(leftType,rightType);if(void 0===leftType!=(void 0===rightType))return!1;if(leftType===rightType)return!0;if(leftType.tag!==rightType.tag)return!1;if(leftType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.SlotType)return!0;if(leftType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceType&&rightType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.InterfaceType&&leftType.interfaceInfo.equals(rightType.interfaceInfo))return!0;if(!(leftType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.EntityType&&rightType instanceof _type_js__WEBPACK_IMPORTED_MODULE_0__.EntityType))return!1;const leftIsSub=leftType.entitySchema.isMoreSpecificThan(rightType.entitySchema),leftIsSuper=rightType.entitySchema.isMoreSpecificThan(leftType.entitySchema);if(leftIsSuper&&leftIsSub)return!0;if(!leftIsSuper&&!leftIsSub)return!1;const[superclass,subclass]=leftIsSuper?[left,right]:[right,left],superDirection=superclass.direction||(superclass.connection?superclass.connection.direction:"inout"),subDirection=subclass.direction||(subclass.connection?subclass.connection.direction:"inout");return"in"===superDirection||"out"===subDirection}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Schema",function(){return Schema});var _entity_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22),_type_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(18);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class Schema{constructor(names,fields,description){this.description={},this.names=names,this.fields={};for(const[name,field]of Object.entries(fields))this.fields[name]="string"==typeof field?{kind:"schema-primitive",type:field}:field;description&&description.description.forEach(desc=>this.description[desc.name]=desc.pattern||desc.patterns[0])}toLiteral(){const fields={},updateField=field=>{if("schema-reference"===field.kind){const schema=field.schema;return{kind:"schema-reference",schema:{kind:schema.kind,model:schema.model.toLiteral()}}}return"schema-collection"===field.kind?{kind:"schema-collection",schema:updateField(field.schema)}:field};for(const key of Object.keys(this.fields))fields[key]=updateField(this.fields[key]);return{names:this.names,fields:fields,description:this.description}}static fromLiteral(data={fields:{},names:[],description:{}}){const fields={},updateField=field=>{if("schema-reference"===field.kind){const schema=field.schema;return{kind:"schema-reference",schema:{kind:schema.kind,model:_type_js__WEBPACK_IMPORTED_MODULE_1__.Type.fromLiteral(schema.model)}}}return"schema-collection"===field.kind?{kind:"schema-collection",schema:updateField(field.schema)}:field};for(const key of Object.keys(data.fields))fields[key]=updateField(data.fields[key]);const result=new Schema(data.names,fields);return result.description=data.description||{},result}get name(){return this.names[0]}static typesEqual(fieldType1,fieldType2){return Schema._typeString(fieldType1)===Schema._typeString(fieldType2)}static _typeString(type){switch(type.kind){case"schema-primitive":return type.type;case"schema-union":return`(${type.types.map(t=>t.type).join(" or ")})`;case"schema-tuple":return`(${type.types.map(t=>t.type).join(", ")})`;case"schema-reference":return`Reference<${Schema._typeString(type.schema)}>`;case"type-name":case"schema-inline":return type.model.entitySchema.toInlineSchemaString();case"schema-collection":return`[${Schema._typeString(type.schema)}]`;default:throw new Error(`Unknown type kind ${type.kind} in schema ${this.name}`)}}static union(schema1,schema2){const names=[...new Set([...schema1.names,...schema2.names])],fields={};for(const[field,type]of[...Object.entries(schema1.fields),...Object.entries(schema2.fields)])if(fields[field]){if(!Schema.typesEqual(fields[field],type))return null}else fields[field]=type;return new Schema(names,fields)}static intersect(schema1,schema2){const names=[...schema1.names].filter(name=>schema2.names.includes(name)),fields={};for(const[field,type]of Object.entries(schema1.fields)){const otherType=schema2.fields[field];otherType&&Schema.typesEqual(type,otherType)&&(fields[field]=type)}return new Schema(names,fields)}equals(otherSchema){return this===otherSchema||this.name===otherSchema.name&&this.isMoreSpecificThan(otherSchema)&&otherSchema.isMoreSpecificThan(this)}isMoreSpecificThan(otherSchema){const names=new Set(this.names);for(const name of otherSchema.names)if(!names.has(name))return!1;const fields={};for(const[name,type]of Object.entries(this.fields))fields[name]=type;for(const[name,type]of Object.entries(otherSchema.fields)){if(null==fields[name])return!1;if(!Schema.typesEqual(fields[name],type))return!1}return!0}get type(){return new _type_js__WEBPACK_IMPORTED_MODULE_1__.EntityType(this)}entityClass(context=null){return _entity_js__WEBPACK_IMPORTED_MODULE_0__.Entity.createEntityClass(this,context)}toInlineSchemaString(options){const names=this.names.join(" ")||"*",fields=Object.entries(this.fields).map(([name,type])=>`${Schema._typeString(type)} ${name}`).join(", ");return`${names} {${fields.length>0&&options&&options.hideFields?"...":fields}}`}toManifestString(){const results=[];if(results.push(`schema ${this.names.join(" ")}`),results.push(...Object.entries(this.fields).map(([name,type])=>`  ${Schema._typeString(type)} ${name}`)),Object.keys(this.description).length>0){results.push(`  description \`${this.description.pattern}\``);for(const name of Object.keys(this.description))"pattern"!==name&&results.push(`    ${name} \`${this.description[name]}\``)}return results.join("\n")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Entity",function(){return Entity});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_symbols_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(23),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18),_reference_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(24),_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(20);
// @license
class Entity{constructor(data,schema,context,userIDComponent){this._mutable=!0,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!userIDComponent||-1===userIDComponent.indexOf(":"),"user IDs must not contain the ':' character"),setEntityId(this,void 0),this.userIDComponent=userIDComponent,this.schema=schema,this.context=context,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(data,"can't construct entity with null data"),this.rawData=createRawDataProxy(data,schema,context)}get mutable(){return this._mutable}set mutable(mutable){if(!this.mutable&&mutable)throw new Error("You cannot make an immutable entity mutable again.");this._mutable=mutable}mutate(mutation){if(!this.mutable)throw new Error("Entity is immutable.");let newData;"function"==typeof mutation?mutation(newData=this.dataClone()):newData=mutation,this.rawData=createRawDataProxy(newData,this.schema,this.context)}getUserID(){return this.userIDComponent}isIdentified(){return void 0!==getEntityId(this)}get id(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!!this.isIdentified()),getEntityId(this)}identify(identifier){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.isIdentified()),setEntityId(this,identifier);const components=identifier.split(":"),uid=components.lastIndexOf("uid");this.userIDComponent=uid>0?components.slice(uid+1).join(":"):""}createIdentity(parentId,idGenerator){let id;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.isIdentified()),setEntityId(this,id=this.userIDComponent?`${parentId.toString()}:uid:${this.userIDComponent}`:idGenerator.newChildId(parentId).toString())}toLiteral(){return this.rawData}toJSON(){return this.rawData}dataClone(){const clone={},fieldTypes=this.schema.fields;for(const name of Object.keys(fieldTypes))void 0!==this.rawData[name]&&(fieldTypes[name]&&"schema-reference"===fieldTypes[name].kind?this.rawData[name]&&(clone[name]=this.rawData[name].dataClone()):fieldTypes[name]&&"schema-collection"===fieldTypes[name].kind?this.rawData[name]&&(clone[name]=[...this.rawData[name]].map(a=>a.dataClone())):clone[name]=this.rawData[name]);return clone}serialize(){return{id:getEntityId(this),rawData:this.dataClone()}}static createEntityClass(schema,context){const clazz=class extends Entity{constructor(data,userIDComponent){super(data,schema,context,userIDComponent)}get entityClass(){return clazz}static get type(){return new _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType(schema)}static get key(){return{tag:"entity",schema:schema}}static get schema(){return schema}};Object.defineProperty(clazz,"name",{value:schema.name});for(const name of Object.keys(schema.fields))Object.defineProperty(clazz.prototype,name,{get(){return this.rawData[name]},set(v){this.rawData[name]=v}});return clazz}}function convertToJsType(primitiveType,schemaName){switch(primitiveType.type){case"Text":case"URL":return"string";case"Number":return"number";case"Boolean":return"boolean";case"Bytes":return"Uint8Array";case"Object":return"object";default:throw new Error(`Unknown field type ${primitiveType.type} in schema ${schemaName}`)}}function validateFieldAndTypes({op:op,name:name,value:value,schema:schema,fieldType:fieldType}){if(void 0===(fieldType=fieldType||schema.fields[name]))throw new Error(`Can't ${op} field ${name}; not in schema ${schema.name}`);if(null!=value)switch(fieldType.kind){case"schema-primitive":if(("Uint8Array"===value.constructor.name?"Uint8Array":typeof value)!==convertToJsType(fieldType,schema.name))throw new TypeError(`Type mismatch ${op}ting field ${name} (type ${fieldType.type}); `+`value '${value}' is type ${typeof value}`);break;case"schema-union":for(const innerType of fieldType.types)if(typeof value===convertToJsType(innerType,schema.name))return;throw new TypeError(`Type mismatch ${op}ting field ${name} (union [${fieldType.types}]); `+`value '${value}' is type ${typeof value}`);case"schema-tuple":if(!Array.isArray(value))throw new TypeError(`Cannot ${op} tuple ${name} with non-array value '${value}'`);if(value.length!==fieldType.types.length)throw new TypeError(`Length mismatch ${op}ting tuple ${name} `+`[${fieldType.types}] with value '${value}'`);fieldType.types.map((innerType,i)=>{if(void 0!==value[i]&&null!==value[i]&&typeof value[i]!==convertToJsType(innerType,schema.name))throw new TypeError(`Type mismatch ${op}ting field ${name} (tuple [${fieldType.types}]); `+`value '${value}' has type ${typeof value[i]} at index ${i}`)});break;case"schema-reference":if(!(value instanceof _reference_js__WEBPACK_IMPORTED_MODULE_3__.Reference))throw new TypeError(`Cannot ${op} reference ${name} with non-reference '${value}'`);if(!_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_4__.TypeChecker.compareTypes({type:value.type},{type:new _type_js__WEBPACK_IMPORTED_MODULE_2__.ReferenceType(fieldType.schema.model)}))throw new TypeError(`Cannot ${op} reference ${name} with value '${value}' of mismatched type`);break;case"schema-collection":if("Set"!==value.constructor.name)throw new TypeError(`Cannot ${op} collection ${name} with non-Set '${value}'`);for(const element of value)validateFieldAndTypes({op:op,name:name,value:element,schema:schema,fieldType:fieldType.schema});break;default:throw new Error(`Unknown kind ${fieldType.kind} in schema ${schema.name}`)}}function sanitizeEntry(type,value,name,context){if(!type)return value;if("schema-reference"===type.kind&&value){if(value instanceof _reference_js__WEBPACK_IMPORTED_MODULE_3__.Reference)return value;if(value.id&&value.storageKey)return new _reference_js__WEBPACK_IMPORTED_MODULE_3__.Reference(value,new _type_js__WEBPACK_IMPORTED_MODULE_2__.ReferenceType(type.schema.model),context);throw new TypeError(`Cannot set reference ${name} with non-reference '${value}'`)}if("schema-collection"===type.kind&&value){if("Set"===value.constructor.name)return value;if(value.length&&value instanceof Object)return new Set(value.map(v=>sanitizeEntry(type.schema,v,name,context)));throw new TypeError(`Cannot set collection ${name} with non-collection '${value}'`)}return value}function createRawDataProxy(data,schema,context){const classJunk=["toJSON","prototype","toString","inspect"],sanitizedData=function(data,schema,context){const sanitizedData={};for(const[name,value]of Object.entries(data)){const sanitizedValue=sanitizeEntry(schema.fields[name],value,name,context);validateFieldAndTypes({op:"set",name:name,value:sanitizedValue,schema:schema}),sanitizedData[name]=sanitizedValue}return sanitizedData}(data,schema,context);return new Proxy(sanitizedData,{get:(target,name)=>{if(classJunk.includes(name)||name.constructor===Symbol)return;const value=target[name];return validateFieldAndTypes({op:"get",name:name,value:value,schema:schema}),value},set:(target,name,value)=>{throw new Error(`Tried to modify entity field '${name}'. Use the mutate method instead.`)}})}function getEntityId(entity){return entity[_symbols_js__WEBPACK_IMPORTED_MODULE_1__.Symbols.identifier]}function setEntityId(entity,id){entity[_symbols_js__WEBPACK_IMPORTED_MODULE_1__.Symbols.identifier]=id}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Symbols",function(){return Symbols});
// @license
const Symbols={identifier:Symbol("id")}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Reference",function(){return Reference}),__webpack_require__.d(__webpack_exports__,"ClientReference",function(){return ClientReference});var ReferenceMode,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_handle_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(25),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18);!function(ReferenceMode){ReferenceMode[ReferenceMode.Unstored=0]="Unstored",ReferenceMode[ReferenceMode.Stored=1]="Stored"}(ReferenceMode||(ReferenceMode={}));class Reference{constructor(data,type,context){this.entity=null,this.storageProxy=null,this.handle=null,this.id=data.id,this.storageKey=data.storageKey,this.context=context,this.type=type}async ensureStorageProxy(){null==this.storageProxy&&(this.storageProxy=await this.context.getStorageProxy(this.storageKey,this.type.referredType),this.handle=Object(_handle_js__WEBPACK_IMPORTED_MODULE_1__.handleFor)(this.storageProxy,this.context.idGenerator),this.storageKey?Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.storageKey===this.storageProxy.storageKey):this.storageKey=this.storageProxy.storageKey)}async dereference(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.context,"Must have context to dereference"),this.entity?this.entity:(await this.ensureStorageProxy(),this.entity=await this.handle.get(this.id),this.entity)}dataClone(){return{storageKey:this.storageKey,id:this.id}}serialize(){return{id:this.id,rawData:this.dataClone()}}}class ClientReference extends Reference{constructor(entity,context){super({id:entity.id,storageKey:null},new _type_js__WEBPACK_IMPORTED_MODULE_2__.ReferenceType(entity.entityClass.type),context),this.mode=ReferenceMode.Unstored,this.entity=entity,this.stored=new Promise(async(resolve,reject)=>{await this.storeReference(entity),resolve()})}async storeReference(entity){await this.ensureStorageProxy(),await this.handle.store(entity),this.mode=ReferenceMode.Stored}async dereference(){return this.mode===ReferenceMode.Unstored?null:super.dereference()}isIdentified(){return this.entity.isIdentified()}static newClientReference(context){return class extends ClientReference{constructor(entity){super(entity,context)}}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Handle",function(){return Handle}),__webpack_require__.d(__webpack_exports__,"Collection",function(){return Collection}),__webpack_require__.d(__webpack_exports__,"Variable",function(){return Variable}),__webpack_require__.d(__webpack_exports__,"BigCollection",function(){return BigCollection}),__webpack_require__.d(__webpack_exports__,"handleFor",function(){return handleFor});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(26),_particle_spec_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(27),_reference_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(24),_type_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(18),_entity_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(22),_id_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(29);function restore(entry,entityClass){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(entityClass,"Handles need entity classes for deserialization");const{id:id,rawData:rawData}=entry,entity=new entityClass(rawData);return entry.id&&entity.identify(entry.id),entity}class Handle{constructor(storage,idGenerator,name,particleId,canRead,canWrite){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!(storage instanceof Handle)),this.storage=storage,this.idGenerator=idGenerator,this.name=name||this.storage.name,this.canRead=canRead,this.canWrite=canWrite,this._particleId=particleId,this.options={keepSynced:!0,notifySync:!0,notifyUpdate:!0,notifyDesync:!1}}reportUserExceptionInHost(exception,particle,method){this.storage.reportExceptionInHost(new _arc_exceptions_js__WEBPACK_IMPORTED_MODULE_1__.UserException(exception,method,this._particleId,particle.spec.name))}reportSystemExceptionInHost(exception,method){this.storage.reportExceptionInHost(new _arc_exceptions_js__WEBPACK_IMPORTED_MODULE_1__.SystemException(exception,method,this._particleId))}configure(options){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.canRead,"configure can only be called on readable Handles");try{const keys=Object.keys(this.options),badKeys=Object.keys(options).filter(o=>!keys.includes(o));if(badKeys.length>0)throw new Error(`Invalid option in Handle.configure(): ${badKeys}`);Object.assign(this.options,options)}catch(e){throw this.reportSystemExceptionInHost(e,"Handle::configure"),e}}_serialize(entity){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(entity,"can't serialize a null entity"),entity instanceof _entity_js__WEBPACK_IMPORTED_MODULE_5__.Entity&&(entity.isIdentified()||entity.createIdentity(_id_js__WEBPACK_IMPORTED_MODULE_6__.Id.fromString(this._id),this.idGenerator)),entity.serialize()}get type(){return this.storage.type}get _id(){return this.storage.id}toManifestString(){return`'${this._id}'`}generateKey(){return this.idGenerator.newChildId(_id_js__WEBPACK_IMPORTED_MODULE_6__.Id.fromString(this._id),"key").toString()}}class Collection extends Handle{_notify(kind,particle,details){switch(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.canRead,"_notify should not be called for non-readable handles"),kind){case"sync":try{particle.onHandleSync(this,this._restore(details))}catch(e){this.reportUserExceptionInHost(e,particle,"onHandleSync")}return;case"update":{const update={};return"add"in details&&(update.added=this._restore(details.add)),"remove"in details&&(update.removed=this._restore(details.remove)),update.originator=details.originatorId===this._particleId,void particle.onHandleUpdate(this,update)}case"desync":return void particle.onHandleDesync(this);default:throw new Error("unsupported")}}async get(id){if(!this.canRead)throw new Error("Handle not readable");return this._restore([await this.storage.get(id)])[0]}async toList(){if(!this.canRead)throw new Error("Handle not readable");return this._restore(await this.storage.toList())}_restore(list){return null!==list?list.map(a=>restore(a,this.entityClass)):null}async store(entity){if(!this.canWrite)throw new Error("Handle not writeable");const serialization=this._serialize(entity),keys=[this.generateKey()];return this.storage.store(serialization,keys,this._particleId)}async clear(){if(!this.canWrite)throw new Error("Handle not writeable");if(this.storage.clear)return this.storage.clear(this._particleId);throw new Error("clear not implemented by storage")}async remove(entity){if(!this.canWrite)throw new Error("Handle not writeable");const serialization=this._serialize(entity);this.storage.remove(serialization.id,[],this._particleId)}}class Variable extends Handle{async _notify(kind,particle,details){switch(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.canRead,"_notify should not be called for non-readable handles"),kind){case"sync":try{await particle.onHandleSync(this,this._restore(details))}catch(e){this.reportUserExceptionInHost(e,particle,"onHandleSync")}return;case"update":try{const data=this._restore(details.data),oldData=this._restore(details.oldData);await particle.onHandleUpdate(this,{data:data,oldData:oldData})}catch(e){this.reportUserExceptionInHost(e,particle,"onHandleUpdate")}return;case"desync":try{await particle.onHandleDesync(this)}catch(e){this.reportUserExceptionInHost(e,particle,"onHandleDesync")}return;default:throw new Error("unsupported")}}async get(){if(!this.canRead)throw new Error("Handle not readable");const model=await this.storage.get();return this._restore(model)}_restore(model){if(null==model)return null;if(this.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.EntityType)return restore(model,this.entityClass);if(this.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.InterfaceType)return _particle_spec_js__WEBPACK_IMPORTED_MODULE_2__.ParticleSpec.fromLiteral(model);if(this.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.ReferenceType)return new _reference_js__WEBPACK_IMPORTED_MODULE_3__.Reference(model,this.type,this.storage.pec);throw new Error(`Don't know how to deliver handle data of type ${this.type}`)}async set(entity){try{if(!this.canWrite)throw new Error("Handle not writeable");const serialization=this._serialize(entity);return this.storage.set(serialization,this._particleId)}catch(e){throw this.reportSystemExceptionInHost(e,"Handle::set"),e}}async clear(){if(!this.canWrite)throw new Error("Handle not writeable");return this.storage.clear(this._particleId)}}class Cursor{constructor(parent,cursorId){this._parent=parent,this._cursorId=cursorId}async next(){const data=await this._parent.storage.cursorNext(this._cursorId);return data.done||(data.value=data.value.map(a=>restore(a,this._parent.entityClass))),data}close(){this._parent.storage.cursorClose(this._cursorId)}}class BigCollection extends Handle{configure(options){throw new Error("BigCollections do not support sync/update configuration")}async _notify(kind,particle,details){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.canRead,"_notify should not be called for non-readable handles"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("sync"===kind,"BigCollection._notify only supports sync events"),await particle.onHandleSync(this,[])}async store(entity){if(!this.canWrite)throw new Error("Handle not writeable");const serialization=this._serialize(entity),keys=[this.generateKey()];return this.storage.store(serialization,keys,this._particleId)}async remove(entity){if(!this.canWrite)throw new Error("Handle not writeable");const serialization=this._serialize(entity);this.storage.remove(serialization.id,[],this._particleId)}async stream({pageSize:pageSize,forward:forward=!0}){if(!this.canRead)throw new Error("Handle not readable");if(isNaN(pageSize)||pageSize<1)throw new Error("Streamed reads require a positive pageSize");const cursorId=await this.storage.stream(pageSize,forward);return new Cursor(this,cursorId)}}function handleFor(storage,idGenerator,name=null,particleId="",canRead=!0,canWrite=!0){let handle;handle=storage.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.CollectionType?new Collection(storage,idGenerator,name,particleId,canRead,canWrite):storage.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.BigCollectionType?new BigCollection(storage,idGenerator,name,particleId,canRead,canWrite):new Variable(storage,idGenerator,name,particleId,canRead,canWrite);const type=storage.type.getContainedType()||storage.type;return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.EntityType&&(handle.entityClass=type.entitySchema.entityClass(storage.pec)),handle}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PropagatedException",function(){return PropagatedException}),__webpack_require__.d(__webpack_exports__,"SystemException",function(){return SystemException}),__webpack_require__.d(__webpack_exports__,"UserException",function(){return UserException}),__webpack_require__.d(__webpack_exports__,"reportSystemException",function(){return reportSystemException}),__webpack_require__.d(__webpack_exports__,"registerSystemExceptionHandler",function(){return registerSystemExceptionHandler}),__webpack_require__.d(__webpack_exports__,"removeSystemExceptionHandler",function(){return removeSystemExceptionHandler});class PropagatedException extends Error{constructor(cause,method,particleId,particleName){super(),this.cause=cause,this.method=method,this.particleId=particleId,this.particleName=particleName,this.stack+=`\nCaused by: ${this.cause.stack}`}toLiteral(){return{exceptionType:this.constructor.name,cause:{name:this.cause.name,message:this.cause.message,stack:this.cause.stack},method:this.method,particleId:this.particleId,particleName:this.particleName,stack:this.stack}}static fromLiteral(literal){const cause=literal.cause;let exception;switch(literal.exceptionType){case SystemException.name:exception=new SystemException(cause,literal.method,literal.particleId,literal.particleName);break;case UserException.name:exception=new UserException(cause,literal.method,literal.particleId,literal.particleName);break;default:throw new Error(`Unknown exception type: ${literal.exceptionType}`)}return exception.stack=literal.stack,exception}}class SystemException extends PropagatedException{get message(){const particleName=this.particleName?this.particleName:this.particleId;return`SystemException: exception ${this.cause.name} raised when invoking system function ${this.method} on behalf of particle ${particleName}: ${this.cause.message}`}}class UserException extends PropagatedException{get message(){const particleName=this.particleName?this.particleName:this.particleId;return`UserException: exception ${this.cause.name} raised when invoking function ${this.method} on particle ${particleName}: ${this.cause.message}`}}const systemHandlers=[];function reportSystemException(exception){for(const handler of systemHandlers)handler(exception)}function registerSystemExceptionHandler(handler){systemHandlers.includes(handler)||systemHandlers.push(handler)}function removeSystemExceptionHandler(handler){const idx=systemHandlers.indexOf(handler);idx>-1&&systemHandlers.splice(idx,1)}registerSystemExceptionHandler(exception=>{throw console.log(exception.method,exception.particleName),exception})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"HandleConnectionSpec",function(){return HandleConnectionSpec}),__webpack_require__.d(__webpack_exports__,"ConsumeSlotConnectionSpec",function(){return ConsumeSlotConnectionSpec}),__webpack_require__.d(__webpack_exports__,"ProvideSlotConnectionSpec",function(){return ProvideSlotConnectionSpec}),__webpack_require__.d(__webpack_exports__,"ParticleSpec",function(){return ParticleSpec});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_modality_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(28),_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(20),_type_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(18);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
function asType(t){return t instanceof _type_js__WEBPACK_IMPORTED_MODULE_3__.Type?t:_type_js__WEBPACK_IMPORTED_MODULE_3__.Type.fromLiteral(t)}function asTypeLiteral(t){return t instanceof _type_js__WEBPACK_IMPORTED_MODULE_3__.Type?t.toLiteral():t}class HandleConnectionSpec{constructor(rawData,typeVarMap){this.parentConnection=null,this.rawData=rawData,this.direction=rawData.direction,this.name=rawData.name,this.type=asType(rawData.type).mergeTypeVariablesByName(typeVarMap),this.isOptional=rawData.isOptional,this.tags=rawData.tags||[],this.dependentConnections=[]}instantiateDependentConnections(particle,typeVarMap){for(const dependentArg of this.rawData.dependentConnections){const dependentConnection=particle.createConnection(dependentArg,typeVarMap);dependentConnection.parentConnection=this,this.dependentConnections.push(dependentConnection)}}get isInput(){return"in"===this.direction||"inout"===this.direction||"host"===this.direction}get isOutput(){return"out"===this.direction||"inout"===this.direction}isCompatibleType(type){return _recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_2__.TypeChecker.compareTypes({type:type},{type:this.type,direction:this.direction})}}class ConsumeSlotConnectionSpec{constructor(slotModel){this.name=slotModel.name,this.isRequired=slotModel.isRequired||!1,this.isSet=slotModel.isSet||!1,this.tags=slotModel.tags||[],this.formFactor=slotModel.formFactor,this.handles=slotModel.handles||[],this.provideSlotConnections=[],slotModel.provideSlotConnections&&slotModel.provideSlotConnections.forEach(ps=>{this.provideSlotConnections.push(new ProvideSlotConnectionSpec(ps))})}get isOptional(){return!this.isRequired}get direction(){return"`consume"}get type(){return _type_js__WEBPACK_IMPORTED_MODULE_3__.SlotType.make(this.formFactor,null)}get dependentConnections(){return this.provideSlotConnections}}class ProvideSlotConnectionSpec extends ConsumeSlotConnectionSpec{}class ParticleSpec{constructor(model){this.model=model,this.name=model.name,this.verbs=model.verbs;const typeVarMap=new Map;this.handleConnectionMap=new Map,model.args.forEach(arg=>this.createConnection(arg,typeVarMap)),model.description=model.description||{},this.validateDescription(model.description),this.pattern=model.description.pattern,this.handleConnectionMap.forEach((connectionSpec,name)=>{connectionSpec.pattern=model.description[name]}),this.implFile=model.implFile,this.implBlobUrl=model.implBlobUrl,this.modality=_modality_js__WEBPACK_IMPORTED_MODULE_1__.Modality.create(model.modality||[]),this.slotConnections=new Map,model.slotConnections&&model.slotConnections.forEach(s=>this.slotConnections.set(s.name,new ConsumeSlotConnectionSpec(s))),this.slotConnections.forEach(slot=>{slot.provideSlotConnections.forEach(ps=>{ps.handles.forEach(v=>Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.handleConnectionMap.has(v),"Cannot provide slot for nonexistent handle constraint "+v))})})}createConnection(arg,typeVarMap){const connection=new HandleConnectionSpec(arg,typeVarMap);return this.handleConnectionMap.set(connection.name,connection),connection.instantiateDependentConnections(this,typeVarMap),connection}get handleConnections(){return this.connections}get connections(){return[...this.handleConnectionMap.values()]}get inputs(){return this.connections.filter(a=>a.isInput)}get outputs(){return this.connections.filter(a=>a.isOutput)}isInput(param){const connection=this.handleConnectionMap.get(param);return connection&&connection.isInput}isOutput(param){const connection=this.handleConnectionMap.get(param);return connection&&connection.isOutput}getConnectionByName(name){return this.handleConnectionMap.get(name)}getSlotSpec(slotName){return this.slotConnections.get(slotName)}get primaryVerb(){return this.verbs.length>0?this.verbs[0]:void 0}isCompatible(modality){return 0===this.slotConnections.size||this.modality.intersection(modality).isResolved()}setImplBlobUrl(url){this.model.implBlobUrl=this.implBlobUrl=url}toLiteral(){const{args:args,name:name,verbs:verbs,description:description,implFile:implFile,implBlobUrl:implBlobUrl,modality:modality,slotConnections:slotConnections}=this.model,connectionToLiteral=({type:type,direction:direction,name:name,isOptional:isOptional,dependentConnections:dependentConnections})=>({type:asTypeLiteral(type),direction:direction,name:name,isOptional:isOptional,dependentConnections:dependentConnections.map(connectionToLiteral)});return{args:args.map(a=>connectionToLiteral(a)),name:name,verbs:verbs,description:description,implFile:implFile,implBlobUrl:implBlobUrl,modality:modality,slotConnections:slotConnections}}static fromLiteral(literal){let{args:args,name:name,verbs:verbs,description:description,implFile:implFile,implBlobUrl:implBlobUrl,modality:modality,slotConnections:slotConnections}=literal;const connectionFromLiteral=({type:type,direction:direction,name:name,isOptional:isOptional,dependentConnections:dependentConnections})=>({type:asType(type),direction:direction,name:name,isOptional:isOptional,dependentConnections:dependentConnections?dependentConnections.map(connectionFromLiteral):[]});return args=args.map(connectionFromLiteral),new ParticleSpec({args:args,name:name,verbs:verbs||[],description:description,implFile:implFile,implBlobUrl:implBlobUrl,modality:modality,slotConnections:slotConnections})}clone(){return ParticleSpec.fromLiteral(this.toLiteral())}cloneWithResolutions(variableMap){const spec=this.clone();return this.handleConnectionMap.forEach((conn,name)=>{spec.handleConnectionMap.get(name).type=conn.type._cloneWithResolutions(variableMap)}),spec}equals(other){return JSON.stringify(this.toLiteral())===JSON.stringify(other.toLiteral())}validateDescription(description){Object.keys(description||[]).forEach(d=>{Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(["kind","location","pattern"].includes(d)||this.handleConnectionMap.has(d),`Unexpected description for ${d}`)})}toInterface(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.slotConnections.size,"please implement slots toInterface");const handles=this.model.args.map(({type:type,name:name,direction:direction})=>({type:asType(type),name:name,direction:direction}));return _type_js__WEBPACK_IMPORTED_MODULE_3__.InterfaceType.make(this.name,handles,[])}toString(){const results=[];let verbs="";this.verbs.length>0&&(verbs=" "+this.verbs.map(verb=>`&${verb}`).join(" ")),results.push(`particle ${this.name}${verbs} in '${this.implFile}'`.trim());const writeConnection=(connection,indent)=>{const tags=connection.tags.map(tag=>` #${tag}`).join("");results.push(`${indent}${connection.direction}${connection.isOptional?"?":""} ${connection.type.toString()} ${connection.name}${tags}`);for(const dependent of connection.dependentConnections)writeConnection(dependent,indent+"  ")};for(const connection of this.handleConnections)connection.parentConnection||writeConnection(connection,"  ");this.modality.names.forEach(a=>results.push(`  modality ${a}`));const slotToString=(s,direction,indent)=>{const tokens=[];s.isRequired&&tokens.push("must"),tokens.push(direction),s.isSet&&tokens.push("set of"),tokens.push(s.name),s.tags.length>0&&tokens.push(s.tags.map(a=>`#${a}`).join(" ")),results.push(`${indent}${tokens.join(" ")}`),s.formFactor&&results.push(`${indent}  formFactor ${s.formFactor}`);for(const handle of s.handles)results.push(`${indent}  handle ${handle}`);s.provideSlotConnections&&s.provideSlotConnections.forEach(p=>slotToString(p,"provide",indent+"  "))};return this.slotConnections.forEach(s=>slotToString(s,"consume","  ")),this.pattern&&(results.push(`  description \`${this.pattern}\``),this.handleConnectionMap.forEach(cs=>{cs.pattern&&results.push(`    ${cs.name} \`${cs.pattern}\``)})),results.join("\n")}toManifestString(){return this.toString()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Modality",function(){return Modality});var ModalityName,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */!function(ModalityName){ModalityName.Dom="dom",ModalityName.DomTouch="dom-touch",ModalityName.Vr="vr",ModalityName.Voice="voice"}(ModalityName||(ModalityName={}));class Modality{constructor(names){this.names=names}static create(names){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(names.every(name=>Modality.all.names.includes(name)),`Unsupported modality in: ${names}`),new Modality(names)}intersection(other){return new Modality(this.names.filter(name=>other.names.includes(name)))}isResolved(){return this.names.length>0}isCompatible(names){return this.intersection(Modality.create(names)).isResolved()}static get Name(){return ModalityName}}Modality.all=new Modality([Modality.Name.Dom,Modality.Name.DomTouch,Modality.Name.Vr,Modality.Name.Voice]),Modality.dom=new Modality([Modality.Name.Dom]),Modality.domTouch=new Modality([Modality.Name.DomTouch]),Modality.voice=new Modality([Modality.Name.Voice]),Modality.vr=new Modality([Modality.Name.Vr])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"IdGenerator",function(){return IdGenerator}),__webpack_require__.d(__webpack_exports__,"Id",function(){return Id}),__webpack_require__.d(__webpack_exports__,"ArcId",function(){return ArcId});var _random_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(30);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */class IdGenerator{constructor(currentSessionId){this._nextComponentId=0,this._currentSessionId=currentSessionId}static newSession(){const sessionId=Math.floor(_random_js__WEBPACK_IMPORTED_MODULE_0__.Random.next()*Math.pow(2,50))+"";return new IdGenerator(sessionId)}static createWithSessionIdForTesting(sessionId){return new IdGenerator(sessionId)}newArcId(name){return ArcId._newArcIdInternal(this._currentSessionId,name)}newChildId(parentId,subcomponent=""){return subcomponent+=this._nextComponentId++,Id._newIdInternal(this._currentSessionId,[...parentId.idTree,subcomponent])}get currentSessionIdForTesting(){return this._currentSessionId}}class Id{constructor(root,idTree=[]){this.idTree=[],this.root=root,this.idTree=idTree}static _newIdInternal(root,idTree=[]){return new Id(root,idTree)}static fromString(str){const bits=str.split(":");if(bits[0].startsWith("!")){const root=bits[0].slice(1),idTree=bits.slice(1).filter(component=>component.length>0);return new Id(root,idTree)}return new Id("",bits)}toString(){return`!${this.root}:${this.idTree.join(":")}`}idTreeAsString(){return this.idTree.join(":")}equal(id){if(id.root!==this.root||id.idTree.length!==this.idTree.length)return!1;for(let i=0;i<id.idTree.length;i++)if(id.idTree[i]!==this.idTree[i])return!1;return!0}}class ArcId extends Id{static _newArcIdInternal(root,name){return new ArcId(root,[name])}static newForTest(id){return IdGenerator.newSession().newArcId(id)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Random",function(){return Random});
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class RNG{}const random=new class extends RNG{next(){return Math.random()}};class Random{static next(){return random.next()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotInfo",function(){return SlotInfo});
// @license
class SlotInfo{constructor(formFactor,handle){this.formFactor=formFactor,this.handle=handle}toLiteral(){return this}static fromLiteral({formFactor:formFactor,handle:handle}){return new SlotInfo(formFactor,handle)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ArcInfo",function(){return ArcInfo}),__webpack_require__.d(__webpack_exports__,"ArcHandle",function(){return ArcHandle});
// @license
class ArcInfo{constructor(arcId,serialization){this.id=arcId.toString(),this.serialization=serialization.replace(/\bimport .*\n/g,"")}static extractSerialization(data){return data.serialization.replace(/\bimport .*\n/g,"")}}class ArcHandle{constructor(id,storageKey,type,tags){this.id=id,this.storageKey=storageKey,this.type=type,this.tags=tags}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"TypeVariableInfo",function(){return TypeVariableInfo});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_schema_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(21),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18);
// @license
class TypeVariableInfo{constructor(name,canWriteSuperset,canReadSubset){this.name=name,this._canWriteSuperset=canWriteSuperset,this._canReadSubset=canReadSubset,this._resolution=null}maybeMergeConstraints(variable){return!!this.maybeMergeCanReadSubset(variable.canReadSubset)&&this.maybeMergeCanWriteSuperset(variable.canWriteSuperset)}maybeMergeCanReadSubset(constraint){if(null==constraint)return!0;if(null==this.canReadSubset)return this.canReadSubset=constraint,!0;if(this.canReadSubset instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.SlotType&&constraint instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.SlotType)return!0;if(this.canReadSubset instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType&&constraint instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType){const mergedSchema=_schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema.intersect(this.canReadSubset.entitySchema,constraint.entitySchema);return!!mergedSchema&&(this.canReadSubset=new _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType(mergedSchema),!0)}return!1}maybeMergeCanWriteSuperset(constraint){if(null==constraint)return!0;if(null==this.canWriteSuperset)return this.canWriteSuperset=constraint,!0;if(this.canWriteSuperset instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.SlotType&&constraint instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.SlotType)return!0;if(this.canWriteSuperset instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType&&constraint instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType){const mergedSchema=_schema_js__WEBPACK_IMPORTED_MODULE_1__.Schema.union(this.canWriteSuperset.entitySchema,constraint.entitySchema);return!!mergedSchema&&(this.canWriteSuperset=new _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType(mergedSchema),!0)}return!1}isSatisfiedBy(type){const constraint=this._canWriteSuperset;if(!constraint)return!0;if(!(constraint instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType&&type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType))throw new Error(`constraint checking not implemented for ${this} and ${type}`);return type.getEntitySchema().isMoreSpecificThan(constraint.getEntitySchema())}get resolution(){return this._resolution?this._resolution.resolvedType():null}isValidResolutionCandidate(value){const elementType=value.resolvedType().getContainedType();return elementType instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable&&elementType.variable===this?{result:!1,detail:"variable cannot resolve to collection of itself"}:{result:!0}}set resolution(value){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._resolution);const isValid=this.isValidResolutionCandidate(value);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(isValid.result,isValid.detail);let probe=value;for(;probe&&probe instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable;){if(probe.variable===this)return;probe=probe.variable.resolution}this._resolution=value,this._canWriteSuperset=null,this._canReadSubset=null}get canWriteSuperset(){return this._resolution?(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._canWriteSuperset),this._resolution instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable?this._resolution.variable.canWriteSuperset:null):this._canWriteSuperset}set canWriteSuperset(value){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._resolution),this._canWriteSuperset=value}get canReadSubset(){return this._resolution?(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._canReadSubset),this._resolution instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.TypeVariable?this._resolution.variable.canReadSubset:null):this._canReadSubset}set canReadSubset(value){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._resolution),this._canReadSubset=value}get hasConstraint(){return null!==this._canReadSubset||null!==this._canWriteSuperset}canEnsureResolved(){return this._resolution?this._resolution.canEnsureResolved():!(!this._canWriteSuperset&&!this._canReadSubset)}maybeEnsureResolved(){return this._resolution?this._resolution.maybeEnsureResolved():this._canWriteSuperset?(this.resolution=this._canWriteSuperset,!0):!!this._canReadSubset&&(this.resolution=this._canReadSubset,!0)}toLiteral(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null==this.resolution),this.toLiteralIgnoringResolutions()}toLiteralIgnoringResolutions(){return{name:this.name,canWriteSuperset:this._canWriteSuperset&&this._canWriteSuperset.toLiteral(),canReadSubset:this._canReadSubset&&this._canReadSubset.toLiteral()}}static fromLiteral(data){return new TypeVariableInfo(data.name,data.canWriteSuperset?_type_js__WEBPACK_IMPORTED_MODULE_2__.Type.fromLiteral(data.canWriteSuperset):null,data.canReadSubset?_type_js__WEBPACK_IMPORTED_MODULE_2__.Type.fromLiteral(data.canReadSubset):null)}isResolved(){return this._resolution&&this._resolution.isResolved()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"CrdtCollectionModel",function(){return CrdtCollectionModel});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);
// @license
class CrdtCollectionModel{constructor(model){if(this.items=new Map,model)for(let{id:id,value:value,keys:keys}of model)keys||(keys=[]),this.items.set(id,{value:value,keys:new Set(keys)})}add(id,value,keys){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(keys.length>0&&"object"==typeof keys,"add requires a list of keys");let item=this.items.get(id),effective=!1;if(item){let newKeys=!1;for(const key of keys)item.keys.has(key)||(newKeys=!0),item.keys.add(key);this._equals(item.value,value)||(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(newKeys,"cannot add without new keys. incoming="+keys.join(",")+" existing="+[...item.keys].join(",")),item.value=value,effective=!0)}else item={value:value,keys:new Set(keys)},this.items.set(id,item),effective=!0;return effective}_equals(value1,value2){if(Boolean(value1)!==Boolean(value2))return!1;if(!value1)return!0;const type1=typeof value1;if(type1!==typeof value2)return!1;if("object"===type1){const keys=Object.keys(value1);return keys.length===Object.keys(value2).length&&keys.every(key=>this._equals(value1[key],value2[key]))}return JSON.stringify(value1)===JSON.stringify(value2)}remove(id,keys){const item=this.items.get(id);if(!item)return!1;for(const key of keys)item.keys.delete(key);const effective=0===item.keys.size;return effective&&this.items.delete(id),effective}toLiteral(){const result=[];for(const[id,{value:value,keys:keys}]of this.items.entries())result.push({id:id,value:value,keys:[...keys]});return result}toList(){return[...this.items.values()].map(item=>item.value)}has(id){return this.items.has(id)}getKeys(id){const item=this.items.get(id);return item?[...item.keys]:[]}getValue(id){const item=this.items.get(id);return item?item.value:null}get size(){return this.items.size}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"KeyBase",function(){return KeyBase});class KeyBase{}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StorageBase",function(){return StorageBase}),__webpack_require__.d(__webpack_exports__,"ChangeEvent",function(){return ChangeEvent}),__webpack_require__.d(__webpack_exports__,"StorageProviderBase",function(){return StorageProviderBase});var EventKind,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(37);!function(EventKind){EventKind.change="Change"}(EventKind||(EventKind={}));class StorageBase{constructor(arcId){this.arcId=arcId,this._debug=!1,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==arcId,"Arcs with storage must have ids")}set debug(d){this._debug=d}async shutdown(){}}class ChangeEvent{constructor(args){Object.assign(this,args)}}class StorageProviderBase{constructor(type,name,id,key){this.referenceMode=!1,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(id,"id must be provided when constructing StorageProviders"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!type.hasUnresolvedVariable,"Storage types must be concrete"),this._type=type,this.listeners=new Map,this.name=name,this.version=0,this.id=id,this.source=null,this._storageKey=key,this.nextLocalID=0}enableReferenceMode(){this.referenceMode=!0}get storageKey(){return this._storageKey}get type(){return this._type}reportExceptionInHost(exception){throw exception}on(kindStr,callback,target){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==target,"must provide a target to register a storage event handler");const kind=EventKind[kindStr],listeners=this.listeners.get(kind)||new Map;listeners.set(callback,{target:target}),this.listeners.set(kind,listeners)}off(kindStr,callback){const kind=EventKind[kindStr],listeners=this.listeners.get(kind);listeners&&listeners.delete(callback)}async _fire(kindStr,details){const kind=EventKind[kindStr],listenerMap=this.listeners.get(kind);if(!listenerMap||0===listenerMap.size)return;const callbacks=[];for(const[callback]of listenerMap.entries())callbacks.push(callback);await 0;for(const callback of callbacks)callback(details)}_compareTo(other){let cmp;return 0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.name,other.name))?cmp:0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareNumbers)(this.version,other.version))?cmp:0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.source,other.source))?cmp:0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.id,other.id))?cmp:0}toString(handleTags){const results=[],handleStr=[];return handleStr.push("store"),this.name&&handleStr.push(`${this.name}`),handleStr.push(`of ${this.type.toString()}`),this.id&&handleStr.push(`'${this.id}'`),handleTags&&handleTags.length&&handleStr.push(`${handleTags.join(" ")}`),this.source&&handleStr.push(`in '${this.source}'`),results.push(handleStr.join(" ")),this.description&&results.push(`  description \`${this.description}\``),results.join("\n")}get apiChannelMappingId(){return this.id}dispose(){}async modelForSynchronization(){return this.toLiteral()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"compareNulls",function(){return compareNulls}),__webpack_require__.d(__webpack_exports__,"compareStrings",function(){return compareStrings}),__webpack_require__.d(__webpack_exports__,"compareNumbers",function(){return compareNumbers}),__webpack_require__.d(__webpack_exports__,"compareBools",function(){return compareBools}),__webpack_require__.d(__webpack_exports__,"compareArrays",function(){return compareArrays}),__webpack_require__.d(__webpack_exports__,"compareObjects",function(){return compareObjects}),__webpack_require__.d(__webpack_exports__,"compareComparables",function(){return compareComparables});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);function compareNulls(o1,o2){return o1===o2?0:null===o1?-1:1}function compareStrings(s1,s2){return null==s1||null==s2?compareNulls(s1,s2):s1.localeCompare(s2)}function compareNumbers(n1,n2){return null==n1||null==n2?compareNulls(n1,n2):n1-n2}function compareBools(b1,b2){return null==b1||null==b2?compareNulls(b1,b2):Number(b1)-Number(b2)}function compareArrays(a1,a2,compare){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=a1),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=a2),a1.length!==a2.length)return compareNumbers(a1.length,a2.length);for(let i=0;i<a1.length;i++){let result;if(0!==(result=compare(a1[i],a2[i])))return result}return 0}function compareObjects(o1,o2,compare){const keys=Object.keys(o1);let result;if(0!==(result=compareNumbers(keys.length,Object.keys(o2).length)))return result;for(const key of keys)if(0!==(result=compare(o1[key],o2[key])))return result;return 0}function compareComparables(o1,o2){return null==o1||null==o2?compareNulls(o1,o2):o1._compareTo(o2)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Runtime",function(){return Runtime});var _description_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(39),_manifest_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(41),_arc_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(54),_runtime_cache_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(86),_id_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(29),_loader_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(56),_testing_fake_slot_composer_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(87),_storageNG_drivers_volatile_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(96);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class Runtime{static getRuntime(){return null==runtime&&(runtime=new Runtime),runtime}static clearRuntimeForTesting(){null!==runtime&&(runtime.destroy(),runtime=null)}static newForNodeTesting(context){return new Runtime(new _loader_js__WEBPACK_IMPORTED_MODULE_5__.Loader,_testing_fake_slot_composer_js__WEBPACK_IMPORTED_MODULE_6__.FakeSlotComposer,context)}constructor(loader,composerClass,context){this.cacheService=new _runtime_cache_js__WEBPACK_IMPORTED_MODULE_3__.RuntimeCacheService,this.loader=loader,this.composerClass=composerClass,this.context=context||new _manifest_js__WEBPACK_IMPORTED_MODULE_1__.Manifest({id:"manifest:default"}),this.volatileMemory=new _storageNG_drivers_volatile_js__WEBPACK_IMPORTED_MODULE_7__.VolatileMemory,runtime=this}getCacheService(){return this.cacheService}getVolatileMemory(){return this.volatileMemory}destroy(){}newArc(name,storageKeyPrefix,options){const id=_id_js__WEBPACK_IMPORTED_MODULE_4__.IdGenerator.newSession().newArcId(name),storageKey=storageKeyPrefix+id.toString();return new _arc_js__WEBPACK_IMPORTED_MODULE_2__.Arc({id:id,storageKey:storageKey,loader:this.loader,slotComposer:new this.composerClass,context:this.context,...options})}static async getArcDescription(arc){return(await _description_js__WEBPACK_IMPORTED_MODULE_0__.Description.create(arc)).getArcDescription()}static async parseManifest(content,options){return _manifest_js__WEBPACK_IMPORTED_MODULE_1__.Manifest.parse(content,options)}static async loadManifest(fileName,loader,options){return _manifest_js__WEBPACK_IMPORTED_MODULE_1__.Manifest.load(fileName,loader,options)}}let runtime=null},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Description",function(){return Description});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(40),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18),_storage_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(36);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class Description{constructor(storeDescById={},arcRecipes,particleDescriptions=[]){this.storeDescById=storeDescById,this.arcRecipes=arcRecipes,this.particleDescriptions=particleDescriptions}static async createForPlan(plan){const particleDescriptions=await Description.initDescriptionHandles(plan.particles);return new Description({},[{patterns:plan.patterns,particles:plan.particles}],particleDescriptions)}static async create(arc,relevance){const allParticles=[].concat(...arc.allDescendingArcs.map(arc=>arc.activeRecipe.particles)),particleDescriptions=await Description.initDescriptionHandles(allParticles,arc,relevance),storeDescById={};for(const{id:id}of arc.activeRecipe.handles){const store=arc.findStoreById(id);store&&store instanceof _storage_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.StorageProviderBase&&(storeDescById[id]=arc.getStoreDescription(store))}return new Description(storeDescById,arc.recipeDeltas,particleDescriptions)}getArcDescription(formatterClass=_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__.DescriptionFormatter){const patterns=[].concat(...this.arcRecipes.map(recipe=>recipe.patterns)),particles=[].concat(...this.arcRecipes.map(recipe=>recipe.particles)),desc=new formatterClass(this.particleDescriptions,this.storeDescById).getDescription({patterns:patterns,particles:particles});if(desc)return desc}getRecipeSuggestion(formatterClass=_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__.DescriptionFormatter){return new formatterClass(this.particleDescriptions,this.storeDescById).getDescription(this.arcRecipes[this.arcRecipes.length-1])}getHandleDescription(recipeHandle){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipeHandle.connections.length>0,"handle has no connections?");const formatter=new _description_formatter_js__WEBPACK_IMPORTED_MODULE_1__.DescriptionFormatter(this.particleDescriptions,this.storeDescById);return formatter.excludeValues=!0,formatter.getHandleDescription(recipeHandle)}static async initDescriptionHandles(allParticles,arc,relevance){return await Promise.all(allParticles.map(particle=>Description._createParticleDescription(particle,arc,relevance)))}static async _createParticleDescription(particle,arc,relevance){let pDesc={_particle:particle,_connections:{}};relevance&&(pDesc._rank=relevance.calcParticleRelevance(particle));const descByName=await Description._getPatternByNameFromDescriptionHandle(particle,arc);(pDesc={...pDesc,...descByName}).pattern=pDesc.pattern||particle.spec.pattern;for(const handleConn of Object.values(particle.connections)){const specConn=particle.spec.handleConnectionMap.get(handleConn.name),pattern=descByName[handleConn.name]||specConn.pattern,store=arc?arc.findStoreById(handleConn.handle.id):null;pDesc._connections[handleConn.name]={pattern:pattern,_handleConn:handleConn,value:await Description._prepareStoreValue(store)}}return pDesc}static async _getPatternByNameFromDescriptionHandle(particle,arc){const descriptionConn=particle.connections.descriptions;if(descriptionConn&&descriptionConn.handle&&descriptionConn.handle.id){const descHandle=arc.findStoreById(descriptionConn.handle.id);if(descHandle){const descByName={};for(const d of await descHandle.toList())descByName[d.rawData.key]=d.rawData.value;return descByName}}return{}}static async _prepareStoreValue(store){if(store)if(store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.CollectionType){const collectionStore=store,values=await collectionStore.toList();if(values&&values.length>0)return{collectionValues:values}}else if(store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.BigCollectionType){const bigCollectionStore=store,cursorId=await bigCollectionStore.stream(1),{value:value,done:done}=await bigCollectionStore.cursorNext(cursorId);if(bigCollectionStore.cursorClose(cursorId),!done&&value[0].rawData.name)return{bigCollectionValues:value[0]}}else if(store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType){const variableStore=store,value=await variableStore.get();if(value&&value.rawData)return{entityValue:value.rawData,valueDescription:store.type.entitySchema.description.value}}else if(store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.InterfaceType){const variableStore=store,interfaceValue=await variableStore.get();if(interfaceValue)return{interfaceValue:interfaceValue}}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DescriptionFormatter",function(){return DescriptionFormatter});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DescriptionFormatter{constructor(particleDescriptions=[],storeDescById={}){this.particleDescriptions=particleDescriptions,this.storeDescById=storeDescById,this.seenHandles=new Set,this.seenParticles=new Set,this.excludeValues=!1}getDescription(recipe){if(recipe.patterns.length>0){let recipePatterns=[];for(const pattern of recipe.patterns)recipePatterns.push(this.patternToSuggestion(pattern,{_recipe:recipe}));if((recipePatterns=recipePatterns.filter(pattern=>Boolean(pattern))).length>0)return this._capitalizeAndPunctuate(this._joinDescriptions(recipePatterns))}const particlesSet=new Set(recipe.particles);let selectedDescriptions=this.particleDescriptions.filter(desc=>particlesSet.has(desc._particle)&&this._isSelectedDescription(desc));if(selectedDescriptions.find(desc=>desc._particle.spec.slotConnections.size>0)&&(selectedDescriptions=selectedDescriptions.filter(desc=>desc._particle.spec.slotConnections.size>0)),(selectedDescriptions=selectedDescriptions.sort(DescriptionFormatter.sort)).length>0)return this._combineSelectedDescriptions(selectedDescriptions)}_isSelectedDescription(desc){return!!desc.pattern}getHandleDescription(recipeHandle){const handleConnection=this._selectHandleConnection(recipeHandle)||recipeHandle.connections[0];return this._formatDescription(handleConnection)}_combineSelectedDescriptions(selectedDescriptions,options={}){const suggestions=[];selectedDescriptions.map(particle=>{this.seenParticles.has(particle._particle)||suggestions.push(this.patternToSuggestion(particle.pattern,particle))});const jointDescription=this._joinDescriptions(suggestions);if(jointDescription)return options.skipFormatting?jointDescription:this._capitalizeAndPunctuate(jointDescription)}_joinDescriptions(strings){const nonEmptyStrings=strings.filter(str=>str),count=nonEmptyStrings.length;if(count>0){const delim=["",""," and ",", and "][Math.min(3,count)],lastString=nonEmptyStrings.pop();return`${nonEmptyStrings.join(", ")}${delim}${lastString}`}}_joinTokens(tokens){return tokens.join("")}_capitalizeAndPunctuate(sentence){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(sentence);const last=sentence.length-1;return`${sentence[0].toUpperCase()}${sentence.slice(1,last)}${sentence[last]}${sentence[last].match(/[a-z0-9()' >\]]/i)?".":""}`}patternToSuggestion(pattern,particleDescription){const tokenResults=this._initTokens(pattern,particleDescription).map(token=>this.tokenToString(token));if(0===tokenResults.filter(res=>null==res).length)return this._joinTokens(tokenResults)}_initTokens(pattern,particleDescription){pattern=pattern.replace(/</g,"&lt;");let results=[];for(;pattern.length>0;){const tokens=pattern.match(/\${[a-zA-Z0-9.]+}(?:\.[_a-zA-Z]+)?/g);let firstToken,tokenIndex;tokens?(firstToken=tokens[0],tokenIndex=pattern.indexOf(firstToken)):(firstToken="",tokenIndex=pattern.length),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(tokenIndex>=0);const nextToken=pattern.substring(0,tokenIndex);nextToken.length>0&&results.push({text:nextToken}),firstToken.length>0&&(results=results.concat(this._initSubTokens(firstToken,particleDescription))),pattern=pattern.substring(tokenIndex+firstToken.length)}return results}_initSubTokens(pattern,particleDescription){const valueTokens=pattern.match(/\${([a-zA-Z0-9.]+)}(?:\.([_a-zA-Z]+))?/),handleNames=valueTokens[1].split("."),extra=3===valueTokens.length?valueTokens[2]:void 0;if(!particleDescription._particle){const particleName=handleNames.shift();if(particleName[0]!==particleName[0].toUpperCase())return console.warn(`Invalid particle name '${particleName}' - must start with a capital letter.`),[];const particleDescriptions=this.particleDescriptions.filter(desc=>desc._particle.name===particleName&&particleDescription._recipe.particles.find(p=>p===desc._particle));if(0===particleDescriptions.length)return console.warn(`Cannot find particles with name ${particleName}.`),[];particleDescription=particleDescriptions[particleDescriptions.length-1]}const particle=particleDescription._particle;if(0===handleNames.length)return[{particleName:particle.spec.name,particleDescription:particleDescription}];const handleConn=particle.connections[handleNames[0]];if(handleConn)return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handleConn.handle,"Missing handle???"),[{fullName:valueTokens[0],handleName:handleConn.name,storeId:handleConn.handle.id,properties:handleNames.splice(1),extra:extra,_handleConn:handleConn,value:particleDescription._connections[handleConn.name].value}];if(2!==handleNames.length)return 1===handleNames.length?console.warn(`Unknown handle connection name '${handleNames[0]}'`):console.warn(`Slot connections tokens must have exactly 2 names, found ${handleNames.length} in '${handleNames.join(".")}'`),[];const providedSlotConn=particle.consumedSlotConnections[handleNames[0]].providedSlots[handleNames[1]];return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(providedSlotConn,`Could not find handle ${handleNames.join(".")}`),[{fullName:valueTokens[0],consumeSlotName:handleNames[0],provideSlotName:handleNames[1],extra:extra,_providedSlotConn:providedSlotConn}]}tokenToString(token){if(token.text)return token.text;if(token.particleName)return this._particleTokenToString(token);if(token.handleName)return this._handleTokenToString(token);if(token.consumeSlotName&&token.provideSlotName)return this._slotTokenToString(token);throw new Error("no handle or slot name")}_particleTokenToString(token){return this._combineSelectedDescriptions([token.particleDescription],{skipFormatting:!0})}_handleTokenToString(token){switch(token.extra){case"_type_":return token._handleConn.type.toPrettyString().toLowerCase();case"_values_":return this._formatStoreValue(token.handleName,token.value);case"_name_":return this._formatDescription(token._handleConn);default:{if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!token.extra,`Unrecognized extra ${token.extra}`),token._handleConn.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.InterfaceType){if(!token.value)return;return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(token.value.interfaceValue,`Missing interface type value for '${token._handleConn.type}'.`),_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__.ParticleSpec.fromLiteral(token.value.interfaceValue).pattern}if(token.properties&&token.properties.length>0)return this._propertyTokenToString(token.handleName,token.value,token.properties);let description=this._formatDescriptionPattern(token._handleConn)||this._formatStoreDescription(token._handleConn);const storeValue=this._formatStoreValue(token.handleName,token.value);if(!description){const storeType=token._handleConn.type;if(storeValue&&!this.excludeValues&&!(storeType instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.CollectionType)&&!(storeType instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.BigCollectionType))return storeValue}return description=description||this._formatHandleType(token._handleConn),!storeValue||this.excludeValues||this.seenHandles.has(token.storeId)?description:(this.seenHandles.add(token.storeId),this._combineDescriptionAndValue(token,description,storeValue))}}}_combineDescriptionAndValue(token,description,storeValue){return description===storeValue?description:`${description} (${storeValue})`}_slotTokenToString(token){switch(token.extra){case"_empty_":return 0===token._providedSlotConn.consumeConnections.length;default:Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!token.extra,`Unrecognized slot extra ${token.extra}`)}const results=token._providedSlotConn.consumeConnections.map(consumeConn=>{const particle=consumeConn.particle,particleDescription=this.particleDescriptions.find(desc=>desc._particle===particle);return this.seenParticles.add(particle),this.patternToSuggestion(particle.spec.pattern,particleDescription)});return this._joinDescriptions(results)}_propertyTokenToString(handleName,value,properties){if(!value)return"";Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(value.entityValue,`Cannot return property ${properties.join(",")} for non EntityType.`);value.entityValue;if(value.entityValue){let propertyValue=value.entityValue;for(const property of properties)propertyValue&&(propertyValue=propertyValue[property]);if(propertyValue)return this._formatEntityProperty(handleName,properties,propertyValue)}}_formatEntityProperty(handleName,properties,value){return value}_formatStoreValue(handleName,value){if(value){if(value.collectionValues)return this._formatCollection(handleName,value.collectionValues);if(value.bigCollectionValues)return this._formatBigCollection(handleName,value.bigCollectionValues);if(value.entityValue)return this._formatSingleton(handleName,value);throw new Error(`invalid store type for handle ${handleName}`)}}_formatCollection(handleName,values){return values[0].rawData.name?values.length>2?`${values[0].rawData.name} plus ${values.length-1} other items`:values.map(v=>v.rawData.name).join(", "):`${values.length} items`}_formatBigCollection(handleName,firstValue){return`collection of items like ${firstValue.rawData.name}`}_formatSingleton(handleName,value){const entityValue=value.entityValue;if(value.valueDescription){let matches,valueDescription=value.valueDescription;for(;matches=valueDescription.match(/\${([a-zA-Z0-9.]+)}/);)valueDescription=valueDescription.replace(matches[0],entityValue[matches[1]]);return valueDescription}if(entityValue.name)return entityValue.name}_formatDescription(handleConnection){return this._formatDescriptionPattern(handleConnection)||this._formatStoreDescription(handleConnection)||this._formatHandleType(handleConnection)}_formatDescriptionPattern(handleConnection){let chosenConnection=handleConnection;if(!chosenConnection.spec.isOutput){const otherConnection=this._selectHandleConnection(handleConnection.handle);otherConnection&&(chosenConnection=otherConnection)}const chosenParticleDescription=this.particleDescriptions.find(desc=>desc._particle===chosenConnection.particle),handleDescription=chosenParticleDescription?chosenParticleDescription._connections[chosenConnection.name]:null;if(handleDescription&&handleDescription.pattern)return this.patternToSuggestion(handleDescription.pattern,chosenParticleDescription)}_formatStoreDescription(handleConn){if(handleConn.handle){if(!handleConn.handle.id)return;const storeDescription=this.storeDescById[handleConn.handle.id],handleType=this._formatHandleType(handleConn);if(storeDescription&&storeDescription!==handleType)return storeDescription}}_formatHandleType(handleConnection){return(handleConnection.handle&&handleConnection.handle.type.isResolved()?handleConnection.handle.type:handleConnection.type).toPrettyString().toLowerCase()}_selectHandleConnection(recipeHandle){const possibleConnections=recipeHandle.connections.filter(connection=>{const connectionSpec=connection.spec,particleDescription=this.particleDescriptions.find(desc=>desc._particle===connection.particle);return!!connectionSpec.pattern||!!particleDescription._connections[connection.name].pattern});if(possibleConnections.sort((c1,c2)=>{const isOutput1=c1.spec.isOutput;if(isOutput1!==c2.spec.isOutput)return isOutput1?-1:1;const d1=this.particleDescriptions.find(desc=>desc._particle===c1.particle);return this.particleDescriptions.find(desc=>desc._particle===c2.particle)._rank-d1._rank}),possibleConnections.length>0)return possibleConnections[0]}static sort(p1,p2){const isRoot=slotSpec=>"root"===slotSpec.name||slotSpec.tags.includes("root"),hasRoot1=Boolean([...p1._particle.spec.slotConnections.values()].find(slotSpec=>isRoot(slotSpec)));if(hasRoot1!==Boolean([...p2._particle.spec.slotConnections.values()].find(slotSpec=>isRoot(slotSpec))))return hasRoot1?-1:1;if(p1._rank!==p2._rank)return p2._rank-p1._rank;let p1Slots=0,p2Slots=0;return p1._particle.spec.slotConnections.forEach(slotSpec=>{slotSpec.isSet||++p1Slots}),p2._particle.spec.slotConnections.forEach(slotSpec=>{slotSpec.isSet||++p2Slots}),p2Slots-p1Slots}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StorageStub",function(){return StorageStub}),__webpack_require__.d(__webpack_exports__,"Manifest",function(){return Manifest});var _gen_runtime_manifest_parser_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(42),_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(17),_platform_digest_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(43),_id_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(29),_interface_info_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(19),_manifest_meta_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(44),_particle_spec_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(27),_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(37),_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(45),_recipe_handle_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(46),_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(47),_recipe_recipe_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(48),_recipe_search_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(52),_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(20),_schema_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(21),_storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(15),_type_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(18);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ManifestError extends Error{constructor(location,message){super(message),this.location=location}}class StorageStub{constructor(type,id,name,storageKey,storageProviderFactory,originalId){this.referenceMode=!1,this.type=type,this.id=id,this.name=name,this.storageKey=storageKey,this.storageProviderFactory=storageProviderFactory,this.originalId=originalId}get version(){}get description(){}async inflate(){const store=await this.storageProviderFactory.connect(this.id,this.type,this.storageKey);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(null!=store,"inflating missing storageKey "+this.storageKey),store.originalId=this.originalId,store}toLiteral(){}toString(handleTags){const results=[],handleStr=[];return handleStr.push("store"),this.name&&handleStr.push(`${this.name}`),handleStr.push(`of ${this.type.toString()}`),this.id&&handleStr.push(`'${this.id}'`),handleTags&&handleTags.length&&handleStr.push(`${handleTags.join(" ")}`),results.push(handleStr.join(" ")),this.description&&results.push(`  description \`${this.description}\``),results.join("\n")}_compareTo(other){let cmp;return 0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__.compareStrings)(this.name,other.name))?cmp:0!==(cmp=Object(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__.compareStrings)(this.id,other.id))?cmp:0}}class ManifestVisitor{traverse(ast){if(["string","number","boolean"].includes(typeof ast)||null===ast)return;if(ast instanceof Array){for(const item of ast)this.traverse(item);return}Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(ast.location,"expected manifest node to have `location`"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(ast.kind,"expected manifest node to have `kind`");let childrenVisited=!1;const visitChildren=()=>{if(!childrenVisited){childrenVisited=!0;for(const key of Object.keys(ast))["location","kind","model"].includes(key)||this.traverse(ast[key])}};this.visit(ast,visitChildren),visitChildren()}visit(node,visitChildren){}}const globalWarningKeys=new Set;class Manifest{constructor({id:id}){if(this._recipes=[],this._imports=[],this._particles={},this._schemas={},this._stores=[],this._interfaces=[],this.storeTags=new Map,this._fileName=null,this._idGenerator=_id_js__WEBPACK_IMPORTED_MODULE_3__.IdGenerator.newSession(),this._storageProviderFactory=void 0,this._meta=new _manifest_meta_js__WEBPACK_IMPORTED_MODULE_5__.ManifestMeta,this._resources={},this.storeManifestUrls=new Map,this.errors=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(id instanceof _id_js__WEBPACK_IMPORTED_MODULE_3__.Id||"string"==typeof id),id instanceof _id_js__WEBPACK_IMPORTED_MODULE_3__.Id)this._id=id;else{const components=id.split(":");this._id=_id_js__WEBPACK_IMPORTED_MODULE_3__.Id._newIdInternal(components[0],components.slice(1))}}get id(){return this._meta.name?_id_js__WEBPACK_IMPORTED_MODULE_3__.Id.fromString(this._meta.name):this._id}get storageProviderFactory(){return null==this._storageProviderFactory&&(this._storageProviderFactory=new _storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_15__.StorageProviderFactory(this.id)),this._storageProviderFactory}get recipes(){return this._recipes}get allRecipes(){return[...new Set(this._findAll(manifest=>manifest._recipes))]}get activeRecipe(){return this._recipes.find(recipe=>"active"===recipe.annotation)}get particles(){return Object.values(this._particles)}get allParticles(){return[...new Set(this._findAll(manifest=>Object.values(manifest._particles)))]}get imports(){return this._imports}get schemas(){return this._schemas}get fileName(){return this._fileName}get stores(){return this._stores}get allStores(){return[...this._findAll(manifest=>manifest._stores)]}get interfaces(){return this._interfaces}get meta(){return this._meta}get resources(){return this._resources}applyMeta(section){void 0!==this._storageProviderFactory&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(section.name===this._meta.name||null==section.name,"can't change manifest ID after storage is constructed"),this._meta.apply(section)}async createStore(type,name,id,tags,storageKey){const store=await this.storageProviderFactory.construct(id,type,storageKey||`volatile://${this.id}`);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(null!==store.version),store.name=name,this.storeManifestUrls.set(store.id,this.fileName),this._addStore(store,tags)}_addStore(store,tags){return this._stores.push(store),this.storeTags.set(store,tags||[]),store}newStorageStub(type,name,id,storageKey,tags,originalId){return this._addStore(new StorageStub(type,id,name,storageKey,this.storageProviderFactory,originalId),tags)}_find(manifestFinder){let result=manifestFinder(this);if(!result)for(const importedManifest of this._imports)if(result=importedManifest._find(manifestFinder))break;return result}*_findAll(manifestFinder){yield*manifestFinder(this);for(const importedManifest of this._imports)yield*importedManifest._findAll(manifestFinder)}findSchemaByName(name){return this._find(manifest=>manifest._schemas[name])}findTypeByName(name){const schema=this.findSchemaByName(name);if(schema)return new _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType(schema);const iface=this.findInterfaceByName(name);return iface?new _type_js__WEBPACK_IMPORTED_MODULE_16__.InterfaceType(iface):void 0}findParticleByName(name){return this._find(manifest=>manifest._particles[name])}findParticlesByVerb(verb){return[...this._findAll(manifest=>Object.values(manifest._particles).filter(particle=>particle.primaryVerb===verb))]}findStoreByName(name){return this._find(manifest=>manifest._stores.find(store=>store.name===name))}findStoreById(id){return this._find(manifest=>manifest._stores.find(store=>store.id===id))}findStoreTags(store){return this._find(manifest=>manifest.storeTags.get(store))}findManifestUrlForHandleId(id){return this._find(manifest=>manifest.storeManifestUrls.get(id))}findStoresByType(type,options={tags:[],subtype:!1}){const tags=options.tags||[],subtype=options.subtype||!1;return[...this._findAll(manifest=>manifest._stores.filter(store=>(function(store){const resolvedType=type.resolvedType();if(!resolvedType.isResolved())return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.CollectionType==store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.CollectionType&&type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.BigCollectionType==store.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.BigCollectionType;if(subtype){const[left,right]=_type_js__WEBPACK_IMPORTED_MODULE_16__.Type.unwrapPair(store.type,resolvedType);return left instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType&&right instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType&&left.entitySchema.isMoreSpecificThan(right.entitySchema)}return _recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_13__.TypeChecker.compareTypes({type:store.type},{type:type})})(store)&&function(manifest,store){return 0===tags.filter(tag=>!manifest.storeTags.get(store).includes(tag)).length}(manifest,store)))].filter(s=>!!_recipe_handle_js__WEBPACK_IMPORTED_MODULE_9__.Handle.effectiveType(type,[{type:s.type,direction:s.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.InterfaceType?"host":"inout"}]))}findInterfaceByName(name){return this._find(manifest=>manifest._interfaces.find(iface=>iface.name===name))}findRecipesByVerb(verb){return[...this._findAll(manifest=>manifest._recipes.filter(recipe=>recipe.verbs.includes(verb)))]}generateID(){return this._idGenerator.newChildId(this.id)}static async load(fileName,loader,options){options=options||{};let{registry:registry,id:id}=options;return(registry=registry||{})&&registry[fileName]?await registry[fileName]:(registry[fileName]=(async()=>{const content=await loader.loadResource(fileName);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(void 0!==content,`${fileName} unable to be loaded by Manifest parser`),await Manifest.parse(content,{id:id,fileName:fileName,loader:loader,registry:registry})})(),await registry[fileName])}static async parse(content,options){options=options||{};let{session_id:session_id,fileName:fileName,loader:loader,registry:registry,context:context,throwImportErrors:throwImportErrors}=options;registry=registry||{};const id=`manifest:${fileName}:`;function dumpErrors(manifest){for(const error of manifest.errors){if(error.key){if(globalWarningKeys.has(error.key))continue;globalWarningKeys.add(error.key)}console.warn(processError(error).message)}}function processError(e,parseError){if(!(e instanceof ManifestError||e.location))return e;const line=content.split("\n")[e.location.start.line-1];let message=e.message||"";if(line){let span=1;span=e.location.end.line===e.location.start.line?e.location.end.column-e.location.start.column:line.length-e.location.start.column,span=Math.max(1,span);let preamble,highlight="";for(let i=0;i<e.location.start.column-1;i++)highlight+=" ";for(let i=0;i<span;i++)highlight+="^";message=`${preamble=parseError?"Parse error in":"Post-parse processing error caused by"} '${fileName}' line ${e.location.start.line}.\n${e.message}\n  ${line}\n  ${highlight}`}const err=new ManifestError(e.location,message);return parseError||(err.stack=e.stack),err}let items=[];try{items=Object(_gen_runtime_manifest_parser_js__WEBPACK_IMPORTED_MODULE_0__.parse)(content)}catch(e){throw processError(e,!0)}const manifest=new Manifest({id:id});manifest._fileName=fileName,context&&manifest._imports.push(context);try{await Promise.all(items.map(async item=>{if("import"===item.kind){const path=loader.path(manifest.fileName),target=loader.join(path,item.path);try{manifest._imports.push(await Manifest.load(target,loader,{registry:registry}))}catch(e){manifest.errors.push(e),manifest.errors.push(new ManifestError(item.location,`Error importing '${target}'`))}}}));const processItems=async(kind,f)=>{for(const item of items)item.kind===kind&&(Manifest._augmentAstWithTypes(manifest,item),await f(item))};await processItems("meta",meta=>manifest.applyMeta(meta.items)),await processItems("resource",item=>this._processResource(manifest,item)),await processItems("schema",item=>this._processSchema(manifest,item)),await processItems("interface",item=>this._processInterface(manifest,item)),await processItems("particle",item=>this._processParticle(manifest,item,loader)),await processItems("store",item=>this._processStore(manifest,item,loader)),await processItems("recipe",item=>this._processRecipe(manifest,item,loader))}catch(e){throw dumpErrors(manifest),processError(e,!1)}if(dumpErrors(manifest),options.throwImportErrors&&manifest.errors.length>0)throw manifest.errors[0];return manifest}static _augmentAstWithTypes(manifest,items){(new class extends ManifestVisitor{constructor(){super()}visit(node,visitChildren){switch(visitChildren(),node.kind){case"schema-inline":{const schemas=[],aliases=[],names=[];for(const name of node.names){const resolved=manifest.resolveTypeName(name);resolved&&resolved.schema&&resolved.schema.isAlias?aliases.push(resolved.schema):names.push(name),resolved&&resolved.schema&&schemas.push(resolved.schema)}const fields={};for(let{name:name,type:type}of node.fields){for(const schema of schemas)if(type){const externalType=schema.fields[name];if(externalType&&!_schema_js__WEBPACK_IMPORTED_MODULE_14__.Schema.typesEqual(externalType,type))throw new ManifestError(node.location,`Type of '${name}' does not match schema (${type} vs ${externalType})`)}else type=schema.fields[name];if(!type)throw new ManifestError(node.location,`Could not infer type of '${name}' field`);fields[name]=type}let schema=new _schema_js__WEBPACK_IMPORTED_MODULE_14__.Schema(names,fields);for(const alias of aliases)if(!(schema=_schema_js__WEBPACK_IMPORTED_MODULE_14__.Schema.union(alias,schema)))throw new ManifestError(node.location,"Could not merge schema aliases");return void(node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType(schema))}case"variable-type":{const constraint=node.constraint&&node.constraint.model;return void(node.model=_type_js__WEBPACK_IMPORTED_MODULE_16__.TypeVariable.make(node.name,constraint,null))}case"slot-type":{const fields={};for(const fieldIndex of Object.keys(node.fields)){const field=node.fields[fieldIndex];fields[field.name]=field.value}return void(node.model=_type_js__WEBPACK_IMPORTED_MODULE_16__.SlotType.make(fields.formFactor,fields.handle))}case"type-name":{const resolved=manifest.resolveTypeName(node.name);if(!resolved)throw new ManifestError(node.location,`Could not resolve type reference to type name '${node.name}'`);if(resolved.schema)node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType(resolved.schema);else{if(!resolved.iface)throw new ManifestError(node.location,"Expected {iface} or {schema}");node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.InterfaceType(resolved.iface)}return}case"collection-type":return void(node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.CollectionType(node.type.model));case"big-collection-type":return void(node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.BigCollectionType(node.type.model));case"reference-type":return void(node.model=new _type_js__WEBPACK_IMPORTED_MODULE_16__.ReferenceType(node.type.model));default:return}}}).traverse(items)}static _processSchema(manifest,schemaItem){let description;const fields={};let names=[...schemaItem.names];for(const item of schemaItem.items)switch(item.kind){case"schema-field":{const field=item;if(fields[field.name])throw new ManifestError(field.location,`Duplicate definition of field '${field.name}'`);fields[field.name]=field.type;break}case"description":if(description)throw new ManifestError(item.location,"Duplicate schema description");description=item;break;default:throw new ManifestError(item.location,`unknown parser artifact ${item.kind} while processing schema`)}for(const parent of schemaItem.parents){const result=manifest.findSchemaByName(parent);if(!result)throw new ManifestError(schemaItem.location,`Could not find parent schema '${parent}'`);for(const[name,type]of Object.entries(result.fields))if(fields[name]&&!_schema_js__WEBPACK_IMPORTED_MODULE_14__.Schema.typesEqual(fields[name],type))throw new ManifestError(schemaItem.location,`'${parent}' defines incompatible type for field '${name}'`);Object.assign(fields,result.fields),names.push(...result.names)}names=[names[0],...names.filter(name=>name!==names[0])];const name=schemaItem.alias||names[0];if(!name)throw new ManifestError(schemaItem.location,"Schema defined without name or alias");const schema=new _schema_js__WEBPACK_IMPORTED_MODULE_14__.Schema(names,fields,description);schemaItem.alias&&(schema.isAlias=!0),manifest._schemas[name]=schema}static _processResource(manifest,schemaItem){manifest._resources[schemaItem.name]=schemaItem.data}static _processParticle(manifest,particleItem,loader){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(null==particleItem.implFile||null!==particleItem.args,"no valid body defined for this particle"),particleItem.args||(particleItem.args=[]),particleItem.hasParticleArgument){const warning=new ManifestError(particleItem.location,"Particle uses deprecated argument body");warning.key="hasParticleArgument",manifest._warnings.push(warning)}particleItem.implFile&&loader&&(particleItem.implFile=loader.join(manifest.fileName,particleItem.implFile));const processArgTypes=args=>{for(const arg of args)arg.type=arg.type.model,processArgTypes(arg.dependentConnections)};processArgTypes(particleItem.args),manifest._particles[particleItem.name]=new _particle_spec_js__WEBPACK_IMPORTED_MODULE_6__.ParticleSpec(particleItem)}static _processInterface(manifest,interfaceItem){const handles=[];for(const arg of interfaceItem.args){const handle={name:void 0,type:void 0,direction:arg.direction};"*"!==arg.name&&(handle.name=arg.name),arg.type&&(handle.type=arg.type.model),handles.push(handle)}const slots=[];for(const slotItem of interfaceItem.slots)slots.push({direction:slotItem.direction,name:slotItem.name,isRequired:slotItem.isRequired,isSet:slotItem.isSet});const ifaceInfo=new _interface_info_js__WEBPACK_IMPORTED_MODULE_4__.InterfaceInfo(interfaceItem.name,handles,slots);manifest._interfaces.push(ifaceInfo)}static _processRecipe(manifest,recipeItem,loader){const recipe=manifest._newRecipe(recipeItem.name);recipeItem.annotation&&(recipe.annotation=recipeItem.annotation),recipeItem.verbs&&(recipe.verbs=recipeItem.verbs),this._buildRecipe(manifest,recipe,recipeItem.items)}static _buildRecipe(manifest,recipe,recipeItems){const items={require:recipeItems.filter(item=>"require"===item.kind),handles:recipeItems.filter(item=>"handle"===item.kind),byHandle:new Map,requireHandles:recipeItems.filter(item=>"requireHandle"===item.kind),byRequireHandle:new Map,particles:recipeItems.filter(item=>"particle"===item.kind),byParticle:new Map,slots:recipeItems.filter(item=>"slot"===item.kind),bySlot:new Map,byName:new Map,connections:recipeItems.filter(item=>"connection"===item.kind),search:recipeItems.find(item=>"search"===item.kind),description:recipeItems.find(item=>"description"===item.kind)};Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!(items.handles.length>0&&items.requireHandles.length>0),"Inconsistent handle definitions");const itemHandles=items.handles.length>0?items.handles:items.requireHandles;for(const item of itemHandles){const handle=recipe.newHandle(),ref=item.ref;if(ref.id){handle.id=ref.id;const targetStore=manifest.findStoreById(handle.id);targetStore&&handle.mapToStorage(targetStore)}else if(ref.name){const targetStore=manifest.findStoreByName(ref.name);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(targetStore,`Could not find handle ${ref.name}`),handle.mapToStorage(targetStore)}handle.tags=ref.tags,item.name&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!items.byName.has(item.name),`duplicate handle name: ${item.name}`),handle.localName=item.name,items.byName.set(item.name,{item:item,handle:handle})),handle.fate=item.fate?item.fate:null,items.byHandle.set(handle,item)}const prepareEndpoint=(connection,info)=>{switch(info.targetType){case"particle":{const particle=manifest.findParticleByName(info.particle);if(!particle)throw new ManifestError(connection.location,`could not find particle '${info.particle}'`);if(null!==info.param&&!particle.handleConnectionMap.has(info.param))throw new ManifestError(connection.location,`param '${info.param}' is not defined by '${info.particle}'`);return new _recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_8__.ParticleEndPoint(particle,info.param)}case"localName":if(!items.byName.has(info.name))throw new ManifestError(connection.location,`local name '${info.name}' does not exist in recipe`);if(null==info.param&&0===info.tags.length&&items.byName.get(info.name).handle)return new _recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_8__.HandleEndPoint(items.byName.get(info.name).handle);throw new ManifestError(connection.location,"references to particles by local name not yet supported");case"tag":return new _recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_8__.TagEndPoint(info.tags);default:throw new ManifestError(connection.location,`endpoint ${info.targetType} not supported`)}};for(const connection of items.connections){const from=prepareEndpoint(connection,connection.from),to=prepareEndpoint(connection,connection.to);recipe.newConnectionConstraint(from,to,connection.direction)}items.search&&(recipe.search=new _recipe_search_js__WEBPACK_IMPORTED_MODULE_12__.Search(items.search.phrase,items.search.tokens));for(const item of items.slots){const slot=recipe.newSlot(void 0);item.ref.id&&(slot.id=item.ref.id),item.ref.tags&&(slot.tags=item.ref.tags),item.name&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!items.byName.has(item.name),`Duplicate slot local name ${item.name}`),slot.localName=item.name,items.byName.set(item.name,slot)),items.bySlot.set(slot,item)}for(const item of items.particles){const particle=recipe.newParticle(item.ref.name);if(particle.verbs=item.ref.verbs,!(recipe instanceof _recipe_recipe_js__WEBPACK_IMPORTED_MODULE_11__.RequireSection)&&item.ref.name){const spec=manifest.findParticleByName(item.ref.name);if(!spec)throw new ManifestError(item.location,`could not find particle ${item.ref.name}`);particle.spec=spec.clone()}item.name&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!items.byName.has(item.name)),particle.localName=item.name,items.byName.set(item.name,{item:item,particle:particle})),items.byParticle.set(particle,item);for(const slotConnectionItem of item.slotConnections){if("provide"===slotConnectionItem.direction)throw new ManifestError(item.location,"invalid slot connection: provide slot must be dependent");let slotConn=particle.consumedSlotConnections[slotConnectionItem.param];if(!slotConn){if(void 0!==particle.spec){if(!particle.spec.slotConnections.has(slotConnectionItem.param))throw new ManifestError(slotConnectionItem.location,`Consumed slot '${slotConnectionItem.param}' is not defined by '${particle.name}'`);slotConnectionItem.dependentSlotConnections.forEach(ps=>{if(!particle.getSlotSpecByName(ps.param))throw new ManifestError(ps.location,`Provided slot '${ps.param}' is not defined by '${particle.name}'`)})}slotConn=particle.addSlotConnection(slotConnectionItem.param)}slotConn.tags=slotConnectionItem.tags||[],slotConnectionItem.dependentSlotConnections.forEach(ps=>{if("consume"===ps.direction)throw new ManifestError(item.location,"invalid slot connection: consume slot must not be dependent");if(0!==ps.dependentSlotConnections.length)throw new ManifestError(item.location,"invalid slot connection: provide slot must not have dependencies");if(recipe instanceof _recipe_recipe_js__WEBPACK_IMPORTED_MODULE_11__.RequireSection){const existingSlot=recipe.parent.slots.find(rslot=>rslot.localName===ps.name);void 0!==existingSlot&&(slotConn.providedSlots[ps.param]=existingSlot,existingSlot.sourceConnection=slotConn,existingSlot.name=ps.param)}let providedSlot=slotConn.providedSlots[ps.param];if(providedSlot){if(ps.name)if(items.byName.has(ps.name)){const theSlot=items.byName.get(ps.name);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(theSlot!==providedSlot),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!theSlot.name&&providedSlot),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!theSlot.sourceConnection&&providedSlot.sourceConnection),providedSlot.id=theSlot.id,providedSlot.tags=theSlot.tags,items.byName.set(ps.name,providedSlot),recipe.removeSlot(theSlot)}else items.byName.set(ps.name,providedSlot);items.bySlot.set(providedSlot,ps)}else providedSlot=items.byName.get(ps.name);providedSlot||((providedSlot=recipe.newSlot(ps.param)).localName=ps.name,providedSlot.sourceConnection=slotConn,ps.name&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!items.byName.has(ps.name)),items.byName.set(ps.name,providedSlot)),items.bySlot.set(providedSlot,ps)),slotConn.providedSlots[ps.param]||(slotConn.providedSlots[ps.param]=providedSlot),providedSlot.localName=ps.name})}}for(const[particle,item]of items.byParticle){for(const connectionItem of item.connections){let connection;"*"===connectionItem.param?connection=particle.addUnnamedConnection():(connection=particle.connections[connectionItem.param])||(connection=particle.addConnectionName(connectionItem.param)),connection.tags=connectionItem.target?connectionItem.target.tags:[];const direction={"->":"out","<-":"in","=":"inout",consume:"`consume",provide:"`provide"}[connectionItem.dir];if(connection.direction){if(!(connection.direction===direction||"inout"===direction||"host"===connection.direction&&"in"===direction||"`consume"===connection.direction&&"in"===direction||"`provide"===connection.direction&&"out"===direction))throw new ManifestError(connectionItem.location,`'${connectionItem.dir}' not compatible with '${connection.direction}' param of '${particle.name}'`)}else{if("*"!==connectionItem.param&&void 0!==particle.spec)throw new ManifestError(connectionItem.location,`param '${connectionItem.param}' is not defined by '${particle.name}'`);connection.direction=direction}let targetHandle,targetParticle;if(connectionItem.target&&connectionItem.target.name){let entry=items.byName.get(connectionItem.target.name);if(entry){if(!entry.item)throw new ManifestError(connectionItem.location,`did not expect '${entry}' expected handle or particle`)}else{const handle=recipe.newHandle();handle.tags=[],handle.localName=connectionItem.target.name,handle.fate="create",handle.item={kind:"handle"},entry={item:handle.item,handle:handle},items.byName.set(handle.localName,entry),items.byHandle.set(handle,handle.item)}if("handle"===entry.item.kind||"requireHandle"===entry.item.kind)targetHandle=entry.handle;else{if("particle"!==entry.item.kind)throw new ManifestError(connectionItem.location,`did not expect ${entry.item.kind}`);targetParticle=entry.particle}}if(connectionItem.target&&connectionItem.target.particle){const hostedParticle=manifest.findParticleByName(connectionItem.target.particle);if(!hostedParticle)throw new ManifestError(connectionItem.target.location,`Could not find hosted particle '${connectionItem.target.particle}'`);if(!(targetHandle=_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_10__.RecipeUtil.constructImmediateValueHandle(connection,hostedParticle,manifest.generateID())))throw new ManifestError(connectionItem.target.location,`Hosted particle '${hostedParticle.name}' does not match interface '${connection.name}'`)}if(targetParticle){let targetConnection;connectionItem.target.param?(targetConnection=targetParticle.connections[connectionItem.target.param])||(targetConnection=targetParticle.addConnectionName(connectionItem.target.param)):targetConnection=targetParticle.addUnnamedConnection(),(targetHandle=targetConnection.handle)||(targetHandle=recipe.newHandle(),targetConnection.connectToHandle(targetHandle))}targetHandle&&connection.connectToHandle(targetHandle)}for(const slotConnectionItem of item.slotConnections){let targetSlot=items.byName.get(slotConnectionItem.name);targetSlot?(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(items.bySlot.has(targetSlot)),targetSlot.name||(targetSlot.name=slotConnectionItem.param),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(targetSlot===items.byName.get(slotConnectionItem.name),`Target slot ${targetSlot.name} doesn't match slot connection ${slotConnectionItem.param}`)):slotConnectionItem.name&&(recipe instanceof _recipe_recipe_js__WEBPACK_IMPORTED_MODULE_11__.RequireSection&&void 0!==(targetSlot=recipe.parent.slots.find(slot=>slot.localName===slotConnectionItem.name))&&(items.bySlot.set(targetSlot,slotConnectionItem),slotConnectionItem.name&&items.byName.set(slotConnectionItem.name,targetSlot)),null==targetSlot&&((targetSlot=recipe.newSlot(slotConnectionItem.param)).localName=slotConnectionItem.name,items.byName.set(slotConnectionItem.name,targetSlot),items.bySlot.set(targetSlot,slotConnectionItem))),targetSlot&&particle.consumedSlotConnections[slotConnectionItem.param].connectToSlot(targetSlot)}}if(items.description&&items.description.description&&(recipe.description=items.description.description),items.require)for(const item of items.require){const requireSection=recipe.newRequireSection();this._buildRecipe(manifest,requireSection,item.items)}}resolveTypeName(name){const schema=this.findSchemaByName(name);if(schema)return{schema:schema};const iface=this.findInterfaceByName(name);return iface?{iface:iface}:null}static async _processStore(manifest,item,loader){const name=item.name;let id=item.id;const originalId=item.originalId,type=item.type.model;null==id&&(id=`${manifest._id}store${manifest._stores.length}`);let json,source,entities,unitType,tags=item.tags;if(null==tags&&(tags=[]),"storage"===item.origin)return void manifest.newStorageStub(type,name,id,item.source,tags,originalId);if("file"===item.origin)item.source=loader.join(manifest.fileName,item.source),json=await loader.loadResource(item.source);else if("resource"===item.origin&&(source=item.source,null==(json=manifest.resources[source])))throw new ManifestError(item.location,`Resource '${source}' referenced by store '${id}' is not defined in this manifest`);try{entities=JSON.parse(json)}catch(e){throw new ManifestError(item.location,`Error parsing JSON from '${source}' (${e.message})'`)}if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.CollectionType)unitType=type.collectionType;else if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.BigCollectionType)unitType=type.bigCollectionType;else{if(0===entities.length)return void await Manifest._createStore(manifest,type,name,id,tags,item,originalId);entities=entities.slice(entities.length-1),unitType=type}if(unitType instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.EntityType){let hasSerializedId=!1;if(entities=entities.map(entity=>{if(null==entity)return null;hasSerializedId=hasSerializedId||entity.$id;const id=entity.$id||manifest.generateID().toString();return delete entity.$id,{id:id,rawData:entity}}),!item.id&&!hasSerializedId){id=`${id}:${await Object(_platform_digest_web_js__WEBPACK_IMPORTED_MODULE_2__.digest)(JSON.stringify(entities.map(entity=>entity.rawData)))}`}}const version=item.version||0,store=await Manifest._createStore(manifest,type,name,id,tags,item,originalId);if(entities.length>0&&entities[0].rawData&&entities[0].rawData.storageKey){let storageKey=entities[0].rawData.storageKey;storageKey=manifest.findStoreByName(storageKey).storageKey,entities=entities.map(({id:id,rawData:rawData})=>({id:id,storageKey:storageKey}))}else entities.length>0&&(store.referenceMode=!1);let model;model=type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.CollectionType?entities.map(value=>({id:value.id,value:value,keys:new Set([value.id])})):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_16__.BigCollectionType?entities.map(value=>{const index=value.rawData.$index;return delete value.rawData.$index,{id:value.id,index:index,value:value,keys:new Set([value.id])}}):entities.map(value=>({id:value.id,value:value})),await store.fromLiteral({version:version,model:model})}static async _createStore(manifest,type,name,id,tags,item,originalId){const store=await manifest.createStore(type,name,id,tags);return store.source=item.source,store.description=item.description,store.originalId=originalId,store}_newRecipe(name){const recipe=new _recipe_recipe_js__WEBPACK_IMPORTED_MODULE_11__.Recipe(name);return this._recipes.push(recipe),recipe}toString(options){options=options||{};const results=[];return this._imports.forEach(i=>{if(options.recursive){results.push(`// import '${i.fileName}'`);i.toString(options);results.push(`${i.toString(options)}`)}else results.push(`import '${i.fileName}'`)}),Object.values(this._schemas).forEach(s=>{results.push(s.toManifestString())}),Object.values(this._particles).forEach(p=>{results.push(p.toString())}),this._recipes.forEach(r=>{results.push(r.toString(options))}),[...this.stores].sort(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__.compareComparables).forEach(store=>{results.push(store.toString(this.storeTags.get(store).map(a=>`#${a}`)))}),results.join("\n")}get idGeneratorForTesting(){return this._idGenerator}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SyntaxError",function(){return SyntaxError}),__webpack_require__.d(__webpack_exports__,"parse",function(){return parse});class SyntaxError extends Error{static buildMessage(expected,found){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(s){return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,ch=>"\\x0"+hex(ch)).replace(/[\x10-\x1F\x7F-\x9F]/g,ch=>"\\x"+hex(ch))}function classEscape(s){return s.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,ch=>"\\x0"+hex(ch)).replace(/[\x10-\x1F\x7F-\x9F]/g,ch=>"\\x"+hex(ch))}function describeExpectation(expectation){switch(expectation.type){case"literal":return'"'+literalEscape(expectation.text)+'"';case"class":const escapedParts=expectation.parts.map(part=>Array.isArray(part)?classEscape(part[0])+"-"+classEscape(part[1]):classEscape(part));return"["+(expectation.inverted?"^":"")+escapedParts+"]";case"any":return"any character";case"end":return"end of input";case"other":return expectation.description}}return"Expected "+function(expected1){const descriptions=expected1.map(describeExpectation);let i,j;if(descriptions.sort(),descriptions.length>0){for(i=1,j=1;i<descriptions.length;i++)descriptions[i-1]!==descriptions[i]&&(descriptions[j]=descriptions[i],j++);descriptions.length=j}switch(descriptions.length){case 1:return descriptions[0];case 2:return descriptions[0]+" or "+descriptions[1];default:return descriptions.slice(0,-1).join(", ")+", or "+descriptions[descriptions.length-1]}}(expected)+" but "+((found1=found)?'"'+literalEscape(found1)+'"':"end of input")+" found.";var found1}constructor(message,expected,found,location){super(),this.message=message,this.expected=expected,this.found=found,this.location=location,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,SyntaxError)}}const parse=function(input,options){options=void 0!==options?options:{};const peg$FAILED={},peg$startRuleFunctions={Manifest:peg$parseManifest};let peg$startRuleFunction=peg$parseManifest;const peg$c0=function(items){const result=items.map(item=>{const manifestItem=item[2];return manifestItem.annotation=optional(item[0],a=>a[1],null),manifestItem});return function checkNormal(result){if(!["string","number","boolean"].includes(typeof result)&&null!==result){if(void 0===result)throw new SyntaxError("result was undefined",[],"",location());if(Array.isArray(result))for(const item of result)checkNormal(item);else{if(result.model)throw new SyntaxError(`unexpected 'model' in ${JSON.stringify(result)}`,[],"",location());if(!result.location)throw new SyntaxError(`no 'location' in ${JSON.stringify(result)}`,[],"",location());if(!result.kind)throw new SyntaxError(`no 'kind' in ${JSON.stringify(result)}`,[],"",location());for(const key of Object.keys(result))["location","kind"].includes(key)||checkNormal(result[key])}}}(result),result},peg$c1=peg$otherExpectation("an annotation (e.g. @foo)"),peg$c2="@",peg$c3=peg$literalExpectation("@",!1),peg$c4=function(annotation){return annotation},peg$c5="resource",peg$c6=peg$literalExpectation("resource",!1),peg$c7=function(name,body){return{kind:"resource",name:name,data:body,location:location()}},peg$c8="start",peg$c9=peg$literalExpectation("start",!1),peg$c10=function(){startIndent=indent},peg$c11=function(lines){return lines.map(line=>line[0].substring(startIndent.length)+line[1]).join("")},peg$c12=/^[^\n]/,peg$c13=peg$classExpectation(["\n"],!0,!1),peg$c14=function(){return text()},peg$c15="store",peg$c16=peg$literalExpectation("store",!1),peg$c17="of",peg$c18=peg$literalExpectation("of",!1),peg$c19="!!",peg$c20=peg$literalExpectation("!!",!1),peg$c21=function(name,type,id,originalId,version,tags,source,items){return items=optional(items,extractIndented,[]),{kind:"store",location:location(),name:name,type:type,id:optional(id,id=>id[1],null),originalId:optional(originalId,originalId=>originalId[1],null),version:optional(version,version=>version[1],null),tags:optional(tags,tags=>tags[1],null),source:source.source,origin:source.origin,description:items.length>0?items[0][2]:null}},peg$c22="in",peg$c23=peg$literalExpectation("in",!1),peg$c24=function(source){return{origin:"file",source:source}},peg$c25=function(source){return{origin:"resource",source:source}},peg$c26="at",peg$c27=peg$literalExpectation("at",!1),peg$c28=function(source){return{origin:"storage",source:source}},peg$c29="description",peg$c30=peg$literalExpectation("description",!1),peg$c31="import",peg$c32=peg$literalExpectation("import",!1),peg$c33=function(path){return{kind:"import",location:location(),path:path}},peg$c34=peg$otherExpectation("an interface"),peg$c35="interface",peg$c36=peg$literalExpectation("interface",!1),peg$c37="<",peg$c38=peg$literalExpectation("<",!1),peg$c39=">",peg$c40=peg$literalExpectation(">",!1),peg$c41=function(name,typeVars,items){return{kind:"interface",location:location(),name:name,args:optional(items,extractIndented,[]).filter(item=>"interface-argument"===item.kind),slots:optional(items,extractIndented,[]).filter(item=>"interface-slot"===item.kind)}},peg$c42="*",peg$c43=peg$literalExpectation("*",!1),peg$c44=function(direction,type,name){return"host"===(direction=optional(direction,dir=>dir[0],null))&&error("Interface cannot have arguments with a 'host' direction."),{kind:"interface-argument",location:location(),direction:direction,type:optional(type,ty=>ty[0],null),name:name}},peg$c45="must",peg$c46=peg$literalExpectation("must",!1),peg$c47="consume",peg$c48=peg$literalExpectation("consume",!1),peg$c49="provide",peg$c50=peg$literalExpectation("provide",!1),peg$c51="set of",peg$c52=peg$literalExpectation("set of",!1),peg$c53=function(isRequired,direction,isSet,name){return{kind:"interface-slot",location:location(),name:optional(name,isRequired=>name[1],null),isRequired:optional(isRequired,isRequired=>"must"===isRequired[0],!1),direction:direction,isSet:!!isSet}},peg$c54="meta",peg$c55=peg$literalExpectation("meta",!1),peg$c56=function(items){return{kind:"meta",items:items=items?extractIndented(items):[],location:location()}},peg$c57="name",peg$c58=peg$literalExpectation("name",!1),peg$c59=":",peg$c60=peg$literalExpectation(":",!1),peg$c61=function(name){return{key:"name",value:name,location:location(),kind:"name"}},peg$c62="storageKey",peg$c63=peg$literalExpectation("storageKey",!1),peg$c64=function(key){return{key:"storageKey",value:key,location:location(),kind:"storageKey"}},peg$c65="particle",peg$c66=peg$literalExpectation("particle",!1),peg$c67=function(name,verbs,implFile,items){let args=[];const modality=[],slotConnections=[];let description=null,hasParticleArgument=!1;return verbs=optional(verbs,parsedOutput=>parsedOutput[1],[]),(items=optional(items,extractIndented,[])).forEach(item=>{"particle-interface"===item.kind?(/[A-Z]/.test(item.verb[0])&&item.verb!==name&&error(`Verb ${item.verb} must start with a lower case character or be same as particle name.`),verbs.push(item.verb),args=item.args,hasParticleArgument=!0):"particle-argument"===item.kind?args.push(item):"particle-slot"===item.kind?slotConnections.push(item):"description"===item.kind?(description={kind:"description",location:location()},item.description.forEach(d=>description[d.name]=d.pattern||d.patterns[0])):item.modality?modality.push(item.modality):error(`Particle ${name} contains an unknown element: ${item.name}`)}),0===modality.length&&modality.push("dom"),{kind:"particle",location:location(),name:name,implFile:optional(implFile,implFile=>implFile[3],null),verbs:verbs,args:args,modality:modality,slotConnections:slotConnections,description:description,hasParticleArgument:hasParticleArgument}},peg$c68=peg$otherExpectation("a particle item"),peg$c69=function(arg,dependentConnections){return arg.dependentConnections=optional(dependentConnections,extractIndented,[]),arg},peg$c70="?",peg$c71=peg$literalExpectation("?",!1),peg$c72=function(direction,isOptional,type,nametag){return{kind:"particle-argument",location:location(),direction:direction,type:type,isOptional:!!isOptional,dependentConnections:[],name:nametag.name,tags:nametag.tags}},peg$c73=peg$otherExpectation("a direction (e.g. inout, in, out, host, `consume, `provide)"),peg$c74="inout",peg$c75=peg$literalExpectation("inout",!1),peg$c76="out",peg$c77=peg$literalExpectation("out",!1),peg$c78="host",peg$c79=peg$literalExpectation("host",!1),peg$c80="`consume",peg$c81=peg$literalExpectation("`consume",!1),peg$c82="`provide",peg$c83=peg$literalExpectation("`provide",!1),peg$c84=function(){return text()},peg$c85="[",peg$c86=peg$literalExpectation("[",!1),peg$c87="]",peg$c88=peg$literalExpectation("]",!1),peg$c89=function(type){return{kind:"collection-type",location:location(),type:type}},peg$c90="BigCollection<",peg$c91=peg$literalExpectation("BigCollection<",!1),peg$c92=function(type){return{kind:"big-collection-type",location:location(),type:type}},peg$c93="Reference<",peg$c94=peg$literalExpectation("Reference<",!1),peg$c95=function(type){return{kind:"reference-type",location:location(),type:type}},peg$c96=peg$otherExpectation("a type variable (e.g. ~foo)"),peg$c97="~",peg$c98=peg$literalExpectation("~",!1),peg$c99="with",peg$c100=peg$literalExpectation("with",!1),peg$c101=function(name,constraint){return{kind:"variable-type",location:location(),name:name,constraint:optional(constraint,constraint=>constraint[3],null)}},peg$c102="Slot",peg$c103=peg$literalExpectation("Slot",!1),peg$c104=/^[^a-z0-9_]/i,peg$c105=peg$classExpectation([["a","z"],["0","9"],"_"],!0,!0),peg$c106="{",peg$c107=peg$literalExpectation("{",!1),peg$c108=",",peg$c109=peg$literalExpectation(",",!1),peg$c110="}",peg$c111=peg$literalExpectation("}",!1),peg$c112=function(fields){return fields=optional(fields,fields=>{const data=fields[2];return[data[0]].concat(data[1].map(tail=>tail[2]))},[]),{kind:"slot-type",location:location(),fields:fields}},peg$c113=function(name,value){return{kind:"slot-field",location:location(),name:name,value:value}},peg$c114=function(name){return{kind:"type-name",location:location(),name:name}},peg$c115=function(head,tail){return[head,...tail.map(a=>a[2])]},peg$c116="modality",peg$c117=peg$literalExpectation("modality",!1),peg$c118=function(modality){return{kind:"particle-modality",location:location(),modality:modality}},peg$c119="dom-touch",peg$c120=peg$literalExpectation("dom-touch",!1),peg$c121="dom",peg$c122=peg$literalExpectation("dom",!1),peg$c123="vr",peg$c124=peg$literalExpectation("vr",!1),peg$c125="voice",peg$c126=peg$literalExpectation("voice",!1),peg$c127="mock-dom-touch",peg$c128=peg$literalExpectation("mock-dom-touch",!1),peg$c129="mock-dom",peg$c130=peg$literalExpectation("mock-dom",!1),peg$c131="mock-vr",peg$c132=peg$literalExpectation("mock-vr",!1),peg$c133="mock-voice",peg$c134=peg$literalExpectation("mock-voice",!1),peg$c135=function(isRequired,isSet,name,tags,items){let formFactor=null;const provideSlotConnections=[];return(items=optional(items,extractIndented,[])).forEach(item=>{"provided-slot"===item.kind?provideSlotConnections.push(item):"form-factor"===item.kind?(formFactor&&error("duplicate form factor for a slot"),formFactor=item.formFactor):error("Unsupported particle slot item ",item)}),{kind:"particle-slot",location:location(),name:name,tags:optional(tags,tags=>tags[1],[]),isRequired:optional(isRequired,isRequired=>"must"===isRequired[0],!1),isSet:!!isSet,formFactor:formFactor,provideSlotConnections:provideSlotConnections}},peg$c136="formFactor",peg$c137=peg$literalExpectation("formFactor",!1),peg$c138="fullscreen",peg$c139=peg$literalExpectation("fullscreen",!1),peg$c140="big",peg$c141=peg$literalExpectation("big",!1),peg$c142="medium",peg$c143=peg$literalExpectation("medium",!1),peg$c144="small",peg$c145=peg$literalExpectation("small",!1),peg$c146=function(formFactor){return{kind:"form-factor",location:location(),formFactor:formFactor}},peg$c147=function(isRequired,isSet,name,tags,items){let formFactor=null;const handles=[];return(items=items?extractIndented(items):[]).forEach(item=>{"form-factor"===item.kind?(formFactor&&error("duplicate form factor for a slot"),formFactor=item.formFactor):handles.push(item.handle)}),{kind:"provided-slot",location:location(),name:name,tags:optional(tags,tags=>tags[1],[]),isRequired:optional(isRequired,isRequired=>"must"===isRequired[0],!1),isSet:!!isSet,formFactor:formFactor,handles:handles}},peg$c148="handle",peg$c149=peg$literalExpectation("handle",!1),peg$c150=function(handle){return{kind:"particle-provided-slot-handle",location:location(),handle:handle}},peg$c151=function(pattern,handleDescriptions){handleDescriptions=optional(handleDescriptions,extractIndented,[]);const patterns=[];return pattern&&patterns.push(pattern),handleDescriptions.filter(desc=>"pattern"===desc.name).forEach(p=>patterns.push(p)),handleDescriptions=handleDescriptions.filter(desc=>"pattern"!==desc.name),{kind:"description",location:location(),description:[{kind:"default-description?",location:location(),name:"pattern",patterns:patterns},...handleDescriptions]}},peg$c152=function(name,pattern){return{kind:"handle-description",location:location(),name:name,pattern:pattern}},peg$c153="recipe",peg$c154=peg$literalExpectation("recipe",!1),peg$c155=function(name,verbs,items){return verbs=optional(verbs,parsedOutput=>parsedOutput[1],[]),{kind:"recipe",location:location(),name:optional(name,name=>name[1],null),verbs:verbs,items:optional(items,extractIndented,[])}},peg$c156="as",peg$c157=peg$literalExpectation("as",!1),peg$c158=function(name){return name},peg$c159=function(ref,name,connections){const handleConnections=[],slotConnections=[];if(connections){connections=extractIndented(connections);for(const conn of connections)"handle-connection"===conn.kind?handleConnections.push(conn):slotConnections.push(conn)}return{kind:"particle",location:location(),name:optional(name,name=>name[1],null),ref:ref,connections:handleConnections,slotConnections:slotConnections}},peg$c160=function(param,dir,target,dependentConnections){return{kind:"handle-connection",location:location(),param:param,dir:dir,target:optional(target,target=>target[1],null),dependentConnections:optional(dependentConnections,extractIndented,[])}},peg$c161=function(param,tags){let name=null,particle=null;return(param=optional(param,param=>param,null))&&(param[0].toUpperCase()===param[0]?particle=param:name=param),{kind:"handle-connection-components",location:location(),name:name,particle:particle,tags:optional(tags,tags=>tags,[])}},peg$c162=function(direction,ref,name,dependentSlotConnections){return{kind:"slot-connection",location:location(),direction:direction,param:ref.param,tags:ref.tags,name:optional(name,name=>name[1],null),dependentSlotConnections:optional(dependentSlotConnections,extractIndented,[])}},peg$c163=function(param,tags){return{kind:"slot-connection-ref",location:location(),param:param,tags:tags}},peg$c164=function(from,direction,to){return{kind:"connection",location:location(),direction:direction,from:from,to:to}},peg$c165="search",peg$c166=peg$literalExpectation("search",!1),peg$c167="tokens",peg$c168=peg$literalExpectation("tokens",!1),peg$c169=function(phrase,tokens){return{kind:"search",location:location(),phrase:phrase,tokens:optional(tokens,tokens=>tokens[1][2].map(t=>t[1]),null)}},peg$c170="<-",peg$c171=peg$literalExpectation("<-",!1),peg$c172="->",peg$c173=peg$literalExpectation("->",!1),peg$c174="=",peg$c175=peg$literalExpectation("=",!1),peg$c176=function(verbs,components){const{param:param,tags:tags}=optional(components,components=>components,{param:null,tags:[]});return{kind:"connection-target",location:location(),targetType:"verb",verbs:verbs,param:param,tags:tags}},peg$c177=function(tags){return{kind:"connection-target",location:location(),targetType:"tag",tags:tags}},peg$c178=function(name,components){const{param:param,tags:tags}=optional(components,components=>components,{param:null,tags:[]});return{kind:"connection-target",targetType:"localName",location:location(),name:name,param:param,tags:tags}},peg$c179=function(particle,components){const{param:param,tags:tags}=optional(components,components=>components,{param:null,tags:[]});return{kind:"connection-target",targetType:"particle",location:location(),particle:particle,param:param,tags:tags}},peg$c180=".",peg$c181=peg$literalExpectation(".",!1),peg$c182=function(param,tags){return{param:optional(param,param=>param,null),tags:optional(tags,tags=>tags[1],[])}},peg$c183="use",peg$c184=peg$literalExpectation("use",!1),peg$c185="map",peg$c186=peg$literalExpectation("map",!1),peg$c187="create",peg$c188=peg$literalExpectation("create",!1),peg$c189="copy",peg$c190=peg$literalExpectation("copy",!1),peg$c191="`slot",peg$c192=peg$literalExpectation("`slot",!1),peg$c193=function(type,ref,name){return{kind:"handle",location:location(),name:optional(name,name=>name[1],null),ref:optional(ref,ref=>ref[1],emptyRef()),fate:type}},peg$c194="require",peg$c195=peg$literalExpectation("require",!1),peg$c196=function(items){return{kind:"require",location:location(),items:extractIndented(items)}},peg$c197=function(name,ref){return{kind:"requireHandle",location:location(),name:optional(name,name=>name[1],null),ref:optional(ref,ref=>ref[1],emptyRef())}},peg$c198="#",peg$c199=peg$literalExpectation("#",!1),peg$c200=/^[a-zA-Z]/,peg$c201=peg$classExpectation([["a","z"],["A","Z"]],!1,!1),peg$c202=/^[a-zA-Z0-9_]/,peg$c203=peg$classExpectation([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),peg$c204=function(){return text().substring(1)},peg$c205=function(head,tail){return[head,...tail&&tail[1]||[]]},peg$c206=peg$otherExpectation("a verb (e.g. &Verb)"),peg$c207="&",peg$c208=peg$literalExpectation("&",!1),peg$c209=function(tags){return tags},peg$c210=function(name,tags){return{location:location(),name:name,tags:tags=optional(tags,list=>list[1],[])}},peg$c211=function(name){return{location:location(),name:name,tags:[]}},peg$c212=function(tags){return{location:location(),name:tags[0],tags:tags}},peg$c213=function(name){return{kind:"particle-ref",location:location(),name:name,verbs:[],tags:[]}},peg$c214=function(verb){return{kind:"particle-ref",location:location(),verbs:[verb],tags:[]}},peg$c215=function(id,tags){return{kind:"handle-ref",location:location(),id:id,tags:tags||[]}},peg$c216=function(name,tags){return{kind:"handle-ref",location:location(),name:name,tags:tags||[]}},peg$c217=function(tags){return{kind:"handle-ref",location:location(),tags:tags}},peg$c218="slot",peg$c219=peg$literalExpectation("slot",!1),peg$c220=function(ref,name){return{kind:"slot",location:location(),ref:optional(ref,ref=>ref[1],emptyRef()),name:optional(name,name=>name[1],"")}},peg$c221=function(names,fields){return{kind:"schema-inline",location:location(),names:optional(names,names=>names.map(name=>name[0]).filter(name=>"*"!==name),[]),fields:optional(fields,fields=>[fields[0],...fields[1].map(tail=>tail[2])],[])}},peg$c222=function(type,name){return{kind:"schema-inline-field",location:location(),name:name,type:optional(type,type=>type[0],null)}},peg$c223="schema",peg$c224=peg$literalExpectation("schema",!1),peg$c225=function(names,parents){return{names:names.map(name=>name[1]).filter(name=>"*"!==name),parents:optional(parents,parents=>parents,[])}},peg$c226="alias",peg$c227=peg$literalExpectation("alias",!1),peg$c228=function(spec,alias,items){return{kind:"schema",location:location(),items:optional(items,extractIndented,[]),alias:alias,...spec}},peg$c229=function(spec,items){return{kind:"schema",location:location(),items:optional(items,extractIndented,[]),...spec}},peg$c230="extends",peg$c231=peg$literalExpectation("extends",!1),peg$c232=function(first,rest){return[first,...rest.map(item=>item[3])]},peg$c233=function(type,name){return{kind:"schema-field",location:location(),type:type,name:name}},peg$c234=function(schema){return{kind:"schema-collection",location:location(),schema:schema}},peg$c235=function(schema){return{kind:"schema-reference",location:location(),schema:schema}},peg$c236="Text",peg$c237=peg$literalExpectation("Text",!1),peg$c238="URL",peg$c239=peg$literalExpectation("URL",!1),peg$c240="Number",peg$c241=peg$literalExpectation("Number",!1),peg$c242="Boolean",peg$c243=peg$literalExpectation("Boolean",!1),peg$c244="Bytes",peg$c245=peg$literalExpectation("Bytes",!1),peg$c246="Object",peg$c247=peg$literalExpectation("Object",!1),peg$c248=function(type){return{kind:"schema-primitive",location:location(),type:type}},peg$c249="(",peg$c250=peg$literalExpectation("(",!1),peg$c251="or",peg$c252=peg$literalExpectation("or",!1),peg$c253=")",peg$c254=peg$literalExpectation(")",!1),peg$c255=function(first,rest){const types=[first];for(const type of rest)types.push(type[3]);return{kind:"schema-union",location:location(),types:types}},peg$c256=function(first,rest){const types=[first];for(const type of rest)types.push(type[3]);return{kind:"schema-tuple",location:location(),types:types}},peg$c257=peg$otherExpectation("a version number (e.g. @012)"),peg$c258=/^[0-9]/,peg$c259=peg$classExpectation([["0","9"]],!1,!1),peg$c260=function(version){return Number(version.join(""))},peg$c261=peg$otherExpectation("indentation"),peg$c262=" ",peg$c263=peg$literalExpectation(" ",!1),peg$c264=function(i){return(i=i.join("")).length>indent.length&&(indents.push(indent),indent=i,!0)},peg$c265=peg$otherExpectation("same indentation"),peg$c266=function(i){return(i=i.join("")).length===indent.length||i.length<indent.length&&(indent=indents.pop(),!1)},peg$c267=peg$otherExpectation("same or more indentation"),peg$c268=function(i){return(i=i.join("")).length>=indent.length||(i.length<indent.length?(indent=indents.pop(),!1):void 0)},peg$c269=/^[^a-zA-Z0-9_]/,peg$c270=peg$classExpectation([["a","z"],["A","Z"],["0","9"],"_"],!0,!1),peg$c271={type:"any"},peg$c272=function(keyword){throw new SyntaxError(`Expected identifier but keyword, '${keyword}' found.`,[],"",location())},peg$c273=peg$otherExpectation("a `backquoted string`"),peg$c274="`",peg$c275=peg$literalExpectation("`",!1),peg$c276=/^[^`]/,peg$c277=peg$classExpectation(["`"],!0,!1),peg$c278=function(pattern){return pattern.join("")},peg$c279=peg$otherExpectation("an identifier (e.g. 'id')"),peg$c280="'",peg$c281=peg$literalExpectation("'",!1),peg$c282=/^[^']/,peg$c283=peg$classExpectation(["'"],!0,!1),peg$c284=function(id){return id.join("")},peg$c285=peg$otherExpectation("an uppercase identifier (e.g. Foo)"),peg$c286=/^[A-Z]/,peg$c287=peg$classExpectation([["A","Z"]],!1,!1),peg$c288=/^[a-z0-9_]/i,peg$c289=peg$classExpectation([["a","z"],["0","9"],"_"],!1,!0),peg$c290=peg$otherExpectation("a lowercase identifier (e.g. foo)"),peg$c291=/^[a-z]/,peg$c292=peg$classExpectation([["a","z"]],!1,!1),peg$c293=peg$otherExpectation("a field name (e.g. foo9)"),peg$c294=peg$otherExpectation("one or more whitespace characters"),peg$c295=peg$otherExpectation("a group of new lines (and optionally comments)"),peg$c296=/^[ ]/,peg$c297=peg$classExpectation([" "],!1,!1),peg$c298="//",peg$c299=peg$literalExpectation("//",!1),peg$c300=peg$otherExpectation("a new line"),peg$c301="\r",peg$c302=peg$literalExpectation("\r",!1),peg$c303="\n",peg$c304=peg$literalExpectation("\n",!1);let peg$currPos=0,peg$savedPos=0;const peg$posDetailsCache=[{line:1,column:1}];let peg$result,peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0;if(void 0!==options.startRule){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$savedPos,peg$currPos)}function location(){return peg$computeLocation(peg$savedPos,peg$currPos)}function error(message,location1){throw function(message,location1){return new SyntaxError(message,[],"",location1)}(message,location1=void 0!==location1?location1:peg$computeLocation(peg$savedPos,peg$currPos))}function peg$literalExpectation(text1,ignoreCase){return{type:"literal",text:text1,ignoreCase:ignoreCase}}function peg$classExpectation(parts,inverted,ignoreCase){return{type:"class",parts:parts,inverted:inverted,ignoreCase:ignoreCase}}function peg$otherExpectation(description){return{type:"other",description:description}}function peg$computePosDetails(pos){let p,details=peg$posDetailsCache[pos];if(details)return details;for(p=pos-1;!peg$posDetailsCache[p];)p--;for(details={line:(details=peg$posDetailsCache[p]).line,column:details.column};p<pos;)10===input.charCodeAt(p)?(details.line++,details.column=1):details.column++,p++;return peg$posDetailsCache[pos]=details,details}function peg$computeLocation(startPos,endPos){const startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}}}function peg$fail(expected1){peg$currPos<peg$maxFailPos||(peg$currPos>peg$maxFailPos&&(peg$maxFailPos=peg$currPos,peg$maxFailExpected=[]),peg$maxFailExpected.push(expected1))}function peg$buildStructuredError(expected1,found,location1){return new SyntaxError(SyntaxError.buildMessage(expected1,found),expected1,found,location1)}function peg$parseManifest(){let s0,s1,s2,s3,s4,s5,s6,s7,s8;if(s0=peg$currPos,(s1=peg$parseeolWhiteSpace())===peg$FAILED&&(s1=null),s1!==peg$FAILED)if((s2=peg$parseIndent())===peg$FAILED&&(s2=null),s2!==peg$FAILED){for(s3=[],s4=peg$currPos,s5=peg$currPos,(s6=peg$parseSameIndent())!==peg$FAILED&&(s7=peg$parseAnnotation())!==peg$FAILED&&(s8=peg$parseeolWhiteSpace())!==peg$FAILED?s5=s6=[s6,s7,s8]:(peg$currPos=s5,s5=peg$FAILED),s5===peg$FAILED&&(s5=null),s5!==peg$FAILED&&(s6=peg$parseSameIndent())!==peg$FAILED&&(s7=peg$parseManifestItem())!==peg$FAILED?s4=s5=[s5,s6,s7]:(peg$currPos=s4,s4=peg$FAILED);s4!==peg$FAILED;)s3.push(s4),s4=peg$currPos,s5=peg$currPos,(s6=peg$parseSameIndent())!==peg$FAILED&&(s7=peg$parseAnnotation())!==peg$FAILED&&(s8=peg$parseeolWhiteSpace())!==peg$FAILED?s5=s6=[s6,s7,s8]:(peg$currPos=s5,s5=peg$FAILED),s5===peg$FAILED&&(s5=null),s5!==peg$FAILED&&(s6=peg$parseSameIndent())!==peg$FAILED&&(s7=peg$parseManifestItem())!==peg$FAILED?s4=s5=[s5,s6,s7]:(peg$currPos=s4,s4=peg$FAILED);s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c0(s3)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseManifestItem(){let s0;return(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10;if(s0=peg$currPos,input.substr(peg$currPos,6)===peg$c153?(s1=peg$c153,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c154)),s1!==peg$FAILED)if(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseupperIdent())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED)if(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED&&(s5=peg$parseVerbList())!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED)if((s4=peg$parseeolWhiteSpace())!==peg$FAILED){if(s5=peg$currPos,(s6=peg$parseIndent())!==peg$FAILED){for(s7=[],s8=peg$currPos,(s9=peg$parseSameIndent())!==peg$FAILED&&(s10=peg$parseRecipeItem())!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED);s8!==peg$FAILED;)s7.push(s8),s8=peg$currPos,(s9=peg$parseSameIndent())!==peg$FAILED&&(s10=peg$parseRecipeItem())!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED);s7!==peg$FAILED?s5=s6=[s6,s7]:(peg$currPos=s5,s5=peg$FAILED)}else peg$currPos=s5,s5=peg$FAILED;s5===peg$FAILED&&(s5=null),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c155(s2,s3,s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12;if(s0=peg$currPos,input.substr(peg$currPos,8)===peg$c65?(s1=peg$c65,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c66)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parseupperIdent())!==peg$FAILED)if(s4=peg$currPos,(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=peg$parseVerbList())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if(s5=peg$currPos,(s6=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c22?(s7=peg$c22,peg$currPos+=2):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c23)),s7!==peg$FAILED&&(s8=peg$parsewhiteSpace())!==peg$FAILED&&(s9=peg$parseid())!==peg$FAILED?s5=s6=[s6,s7,s8,s9]:(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED),s5===peg$FAILED&&(s5=null),s5!==peg$FAILED)if((s6=peg$parseeolWhiteSpace())!==peg$FAILED){if(s7=peg$currPos,(s8=peg$parseIndent())!==peg$FAILED){for(s9=[],s10=peg$currPos,(s11=peg$parseSameIndent())!==peg$FAILED&&(s12=peg$parseParticleItem())!==peg$FAILED?s10=s11=[s11,s12]:(peg$currPos=s10,s10=peg$FAILED);s10!==peg$FAILED;)s9.push(s10),s10=peg$currPos,(s11=peg$parseSameIndent())!==peg$FAILED&&(s12=peg$parseParticleItem())!==peg$FAILED?s10=s11=[s11,s12]:(peg$currPos=s10,s10=peg$FAILED);s9!==peg$FAILED?s7=s8=[s8,s9]:(peg$currPos=s7,s7=peg$FAILED)}else peg$currPos=s7,s7=peg$FAILED;s7===peg$FAILED&&(s7=null),s7!==peg$FAILED?((s8=peg$parseeolWhiteSpace())===peg$FAILED&&(s8=null),s8!==peg$FAILED?(peg$savedPos=s0,s1=peg$c67(s3,s4,s5,s7),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c31?(s1=peg$c31,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c32)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseid())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c33(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8;if(s0=peg$currPos,(s1=peg$parseSchemaSpec())!==peg$FAILED)if((s2=peg$parseeolWhiteSpace())!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parseIndent())!==peg$FAILED){for(s5=[],s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseSchemaItem())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseSchemaItem())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c229(s1,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12;if(s0=peg$currPos,input.substr(peg$currPos,5)===peg$c226?(s1=peg$c226,peg$currPos+=5):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c227)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parseSchemaSpec())!==peg$FAILED)if((s4=peg$parsewhiteSpace())!==peg$FAILED)if((s5=function(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,2)===peg$c156?(s1=peg$c156,peg$currPos+=2):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c157)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseupperIdent())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c158(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())!==peg$FAILED)if((s6=peg$parseeolWhiteSpace())!==peg$FAILED){if(s7=peg$currPos,(s8=peg$parseIndent())!==peg$FAILED){for(s9=[],s10=peg$currPos,(s11=peg$parseSameIndent())!==peg$FAILED&&(s12=peg$parseSchemaItem())!==peg$FAILED?s10=s11=[s11,s12]:(peg$currPos=s10,s10=peg$FAILED);s10!==peg$FAILED;)s9.push(s10),s10=peg$currPos,(s11=peg$parseSameIndent())!==peg$FAILED&&(s12=peg$parseSchemaItem())!==peg$FAILED?s10=s11=[s11,s12]:(peg$currPos=s10,s10=peg$FAILED);s9!==peg$FAILED?s7=s8=[s8,s9]:(peg$currPos=s7,s7=peg$FAILED)}else peg$currPos=s7,s7=peg$FAILED;s7===peg$FAILED&&(s7=null),s7!==peg$FAILED?(peg$savedPos=s0,s1=peg$c228(s3,s5,s7),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15,s16,s17,s18,s19,s20;if(s0=peg$currPos,input.substr(peg$currPos,5)===peg$c15?(s1=peg$c15,peg$currPos+=5):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c16)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parseupperIdent())!==peg$FAILED)if((s4=peg$parsewhiteSpace())!==peg$FAILED)if(input.substr(peg$currPos,2)===peg$c17?(s5=peg$c17,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c18)),s5!==peg$FAILED)if((s6=peg$parsewhiteSpace())!==peg$FAILED)if((s7=function(){let s0;return(s0=peg$parseSchemaInline())===peg$FAILED&&(s0=peg$parseCollectionType())===peg$FAILED&&(s0=peg$parseBigCollectionType())===peg$FAILED&&(s0=peg$parseTypeName()),s0}())!==peg$FAILED)if(s8=peg$currPos,(s9=peg$parsewhiteSpace())!==peg$FAILED&&(s10=peg$parseid())!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED),s8===peg$FAILED&&(s8=null),s8!==peg$FAILED)if(s9=peg$currPos,input.substr(peg$currPos,2)===peg$c19?(s10=peg$c19,peg$currPos+=2):(s10=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c20)),s10!==peg$FAILED&&(s11=peg$parseid())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED),s9===peg$FAILED&&(s9=null),s9!==peg$FAILED)if(s10=peg$currPos,(s11=peg$parsewhiteSpace())!==peg$FAILED&&(s12=function(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,64===input.charCodeAt(peg$currPos)?(s1=peg$c2,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3)),s1!==peg$FAILED){if(s2=[],peg$c258.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c259)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c258.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c259));else s2=peg$FAILED;s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c260(s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c257)),s0}())!==peg$FAILED?s10=s11=[s11,s12]:(peg$currPos=s10,s10=peg$FAILED),s10===peg$FAILED&&(s10=null),s10!==peg$FAILED)if(s11=peg$currPos,(s12=peg$parsewhiteSpace())!==peg$FAILED&&(s13=peg$parseTagList())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED),s11===peg$FAILED&&(s11=null),s11!==peg$FAILED)if((s12=peg$parsewhiteSpace())!==peg$FAILED)if((s13=function(){let s0;return(s0=function(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,2)===peg$c22?(s1=peg$c22,peg$currPos+=2):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c23)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseid())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c24(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,2)===peg$c22?(s1=peg$c22,peg$currPos+=2):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c23)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseupperIdent())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c25(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,2)===peg$c26?(s1=peg$c26,peg$currPos+=2):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c27)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseid())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c28(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}())!==peg$FAILED)if((s14=peg$parseeolWhiteSpace())!==peg$FAILED){if(s15=peg$currPos,(s16=peg$parseIndent())!==peg$FAILED){if(s17=[],s18=peg$currPos,(s19=peg$parseSameIndent())!==peg$FAILED&&(s20=peg$parseManifestStorageDescription())!==peg$FAILED?s18=s19=[s19,s20]:(peg$currPos=s18,s18=peg$FAILED),s18!==peg$FAILED)for(;s18!==peg$FAILED;)s17.push(s18),s18=peg$currPos,(s19=peg$parseSameIndent())!==peg$FAILED&&(s20=peg$parseManifestStorageDescription())!==peg$FAILED?s18=s19=[s19,s20]:(peg$currPos=s18,s18=peg$FAILED);else s17=peg$FAILED;s17!==peg$FAILED?s15=s16=[s16,s17]:(peg$currPos=s15,s15=peg$FAILED)}else peg$currPos=s15,s15=peg$FAILED;s15===peg$FAILED&&(s15=null),s15!==peg$FAILED?(peg$savedPos=s0,s1=peg$c21(s3,s7,s8,s9,s10,s11,s13,s15),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11;if(peg$silentFails++,s0=peg$currPos,input.substr(peg$currPos,9)===peg$c35?(s1=peg$c35,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c36)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parseupperIdent())!==peg$FAILED)if(s4=peg$currPos,(s5=peg$parsewhiteSpace())===peg$FAILED&&(s5=null),s5!==peg$FAILED?(60===input.charCodeAt(peg$currPos)?(s6=peg$c37,peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c38)),s6!==peg$FAILED?((s7=peg$parsewhiteSpace())===peg$FAILED&&(s7=null),s7!==peg$FAILED&&(s8=function(){let s0,s1,s2,s3,s4,s5,s6;if(s0=peg$currPos,(s1=peg$parseTypeVariable())!==peg$FAILED){for(s2=[],s3=peg$currPos,44===input.charCodeAt(peg$currPos)?(s4=peg$c108,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s4!==peg$FAILED&&(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=peg$parseTypeVariable())!==peg$FAILED?s3=s4=[s4,s5,s6]:(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,44===input.charCodeAt(peg$currPos)?(s4=peg$c108,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s4!==peg$FAILED&&(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=peg$parseTypeVariable())!==peg$FAILED?s3=s4=[s4,s5,s6]:(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c115(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}())!==peg$FAILED?((s9=peg$parsewhiteSpace())===peg$FAILED&&(s9=null),s9!==peg$FAILED?(62===input.charCodeAt(peg$currPos)?(s10=peg$c39,peg$currPos++):(s10=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c40)),s10!==peg$FAILED?s4=s5=[s5,s6,s7,s8,s9,s10]:(peg$currPos=s4,s4=peg$FAILED)):(peg$currPos=s4,s4=peg$FAILED)):(peg$currPos=s4,s4=peg$FAILED)):(peg$currPos=s4,s4=peg$FAILED)):(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if((s5=peg$parseeolWhiteSpace())!==peg$FAILED){if(s6=peg$currPos,(s7=peg$parseIndent())!==peg$FAILED){for(s8=[],s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseInterfaceItem())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s9!==peg$FAILED;)s8.push(s9),s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseInterfaceItem())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)}else peg$currPos=s6,s6=peg$FAILED;s6===peg$FAILED&&(s6=null),s6!==peg$FAILED?((s7=peg$parseeolWhiteSpace())===peg$FAILED&&(s7=null),s7!==peg$FAILED?(peg$savedPos=s0,s1=peg$c41(s3,s4,s6),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c34)),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8;if(s0=peg$currPos,input.substr(peg$currPos,4)===peg$c54?(s1=peg$c54,peg$currPos+=4):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c55)),s1!==peg$FAILED)if((s2=peg$parseeolWhiteSpace())!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parseIndent())!==peg$FAILED){for(s5=[],s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseMetaItem())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseMetaItem())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?((s4=peg$parseeolWhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED?(peg$savedPos=s0,s1=peg$c56(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;return s0=peg$currPos,input.substr(peg$currPos,8)===peg$c5?(s1=peg$c5,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseupperIdent())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED&&(s5=peg$parseIndent())!==peg$FAILED&&(s6=peg$parseSameIndent())!==peg$FAILED&&(s7=function(){let s0,s1,s2;return s0=peg$currPos,input.substr(peg$currPos,5)===peg$c8?(s1=peg$c8,peg$currPos+=5):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c9)),s1!==peg$FAILED&&(s2=peg$parseeol())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c10(),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())!==peg$FAILED&&(s8=function(){let s0,s1,s2,s3,s4;if(s0=peg$currPos,s1=[],s2=peg$currPos,(s3=peg$parseSameOrMoreIndent())!==peg$FAILED&&(s4=peg$parseResourceLine())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),s2=peg$currPos,(s3=peg$parseSameOrMoreIndent())!==peg$FAILED&&(s4=peg$parseResourceLine())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED);else s1=peg$FAILED;return s1!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c11(s1)),s0=s1}())!==peg$FAILED?((s9=peg$parseeolWhiteSpace())===peg$FAILED&&(s9=null),s9!==peg$FAILED?(peg$savedPos=s0,s1=peg$c7(s3,s8),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}function peg$parseAnnotation(){let s0,s1,s2;return peg$silentFails++,s0=peg$currPos,64===input.charCodeAt(peg$currPos)?(s1=peg$c2,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3)),s1!==peg$FAILED&&(s2=peg$parselowerIdent())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c4(s2)):(peg$currPos=s0,s0=peg$FAILED),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c1)),s0}function peg$parseResourceLine(){let s0,s1,s2;for(s0=peg$currPos,s1=[],peg$c12.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13));s2!==peg$FAILED;)s1.push(s2),peg$c12.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13));return s1!==peg$FAILED&&(s2=peg$parseeol())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c14()):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseManifestStorageDescription(){let s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,11)===peg$c29?(s1=peg$c29,peg$currPos+=11):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c30)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parsebackquotedString())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?s0=s1=[s1,s2,s3,s4]:(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseInterfaceItem(){let s0;return(s0=function(){let s0,s1,s2,s3,s4,s5,s6;return s0=peg$currPos,s1=peg$currPos,input.substr(peg$currPos,4)===peg$c45?(s2=peg$c45,peg$currPos+=4):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c46)),s2!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED?(input.substr(peg$currPos,7)===peg$c47?(s2=peg$c47,peg$currPos+=7):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c48)),s2===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c49?(s2=peg$c49,peg$currPos+=7):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c50))),s2!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,6)===peg$c51?(s5=peg$c51,peg$currPos+=6):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c52)),s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(s4=peg$currPos,(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=peg$parselowerIdent())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED&&(s5=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c53(s1,s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,s1=peg$currPos,(s2=peg$parseParticleArgumentDirection())!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED?(s2=peg$currPos,(s3=peg$parseParticleArgumentType())!==peg$FAILED&&(s4=peg$parsewhiteSpace())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?((s3=peg$parselowerIdent())===peg$FAILED&&(42===input.charCodeAt(peg$currPos)?(s3=peg$c42,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43))),s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c44(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}function peg$parseMetaItem(){let s0;return(s0=function(){let s0,s1,s2,s3,s4,s5,s6;return s0=peg$currPos,input.substr(peg$currPos,10)===peg$c62?(s1=peg$c62,peg$currPos+=10):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c63)),s1!==peg$FAILED?((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(58===input.charCodeAt(peg$currPos)?(s3=peg$c59,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c60)),s3!==peg$FAILED?((s4=peg$parsewhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED&&(s5=peg$parseid())!==peg$FAILED&&(s6=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c64(s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6;return s0=peg$currPos,input.substr(peg$currPos,4)===peg$c57?(s1=peg$c57,peg$currPos+=4):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c58)),s1!==peg$FAILED?((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(58===input.charCodeAt(peg$currPos)?(s3=peg$c59,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c60)),s3!==peg$FAILED?((s4=peg$parsewhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED&&(s5=peg$parseid())!==peg$FAILED&&(s6=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c61(s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}function peg$parseParticleItem(){let s0,s1;return peg$silentFails++,(s0=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,8)===peg$c116?(s1=peg$c116,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c117)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=function(){let s0;return input.substr(peg$currPos,9)===peg$c119?(s0=peg$c119,peg$currPos+=9):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c120)),s0===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c121?(s0=peg$c121,peg$currPos+=3):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c122)),s0===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c123?(s0=peg$c123,peg$currPos+=2):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c124)),s0===peg$FAILED&&(input.substr(peg$currPos,5)===peg$c125?(s0=peg$c125,peg$currPos+=5):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c126)),s0===peg$FAILED&&(input.substr(peg$currPos,14)===peg$c127?(s0=peg$c127,peg$currPos+=14):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c128)),s0===peg$FAILED&&(input.substr(peg$currPos,8)===peg$c129?(s0=peg$c129,peg$currPos+=8):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c130)),s0===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c131?(s0=peg$c131,peg$currPos+=7):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c132)),s0===peg$FAILED&&(input.substr(peg$currPos,10)===peg$c133?(s0=peg$c133,peg$currPos+=10):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c134))))))))),s0}())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c118(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13;if(s0=peg$currPos,s1=peg$currPos,input.substr(peg$currPos,4)===peg$c45?(s2=peg$c45,peg$currPos+=4):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c46)),s2!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED)if(input.substr(peg$currPos,7)===peg$c47?(s2=peg$c47,peg$currPos+=7):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c48)),s2!==peg$FAILED)if((s3=peg$parsewhiteSpace())!==peg$FAILED)if(s4=peg$currPos,input.substr(peg$currPos,6)===peg$c51?(s5=peg$c51,peg$currPos+=6):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c52)),s5!==peg$FAILED&&(s6=peg$parsewhiteSpace())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if((s5=peg$parselowerIdent())!==peg$FAILED)if(s6=peg$currPos,(s7=peg$parsewhiteSpace())!==peg$FAILED&&(s8=peg$parseTagList())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED),s6===peg$FAILED&&(s6=null),s6!==peg$FAILED)if((s7=peg$parseeolWhiteSpace())!==peg$FAILED){if(s8=peg$currPos,(s9=peg$parseIndent())!==peg$FAILED){for(s10=[],s11=peg$currPos,(s12=peg$parseSameIndent())!==peg$FAILED&&(s13=peg$parseParticleSlotItem())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED);s11!==peg$FAILED;)s10.push(s11),s11=peg$currPos,(s12=peg$parseSameIndent())!==peg$FAILED&&(s13=peg$parseParticleSlotItem())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED);s10!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED)}else peg$currPos=s8,s8=peg$FAILED;s8===peg$FAILED&&(s8=null),s8!==peg$FAILED?(peg$savedPos=s0,s1=peg$c135(s1,s4,s5,s6,s8),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=peg$parseDescription())===peg$FAILED&&(s0=function peg$parseParticleHandle(){let s0,s1,s2,s3,s4,s5,s6,s7,s8;if(s0=peg$currPos,(s1=function(){let s0,s1,s2,s3,s4,s5,s6;return s0=peg$currPos,(s1=peg$parseParticleArgumentDirection())!==peg$FAILED?(63===input.charCodeAt(peg$currPos)?(s2=peg$c70,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c71)),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseParticleArgumentType())!==peg$FAILED&&(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,(s1=peg$parselowerIdent())!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseTagList())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c210(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$currPos,(s1=peg$parsewhiteSpace())!==peg$FAILED&&(s2=peg$parselowerIdent())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c211(s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$currPos,(s1=peg$parsewhiteSpace())!==peg$FAILED&&(s2=peg$parseTagList())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c212(s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED))),s0}())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c72(s1,s2,s4,s6),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())!==peg$FAILED)if((s2=peg$parseeolWhiteSpace())!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parseIndent())!==peg$FAILED){for(s5=[],s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseParticleHandle())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED&&(s8=peg$parseParticleHandle())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c69(s1,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}()),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c68)),s0}function peg$parseParticleArgumentDirection(){let s0,s1;return peg$silentFails++,input.substr(peg$currPos,5)===peg$c74?(s0=peg$c74,peg$currPos+=5):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c75)),s0===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c22?(s0=peg$c22,peg$currPos+=2):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c23)),s0===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c76?(s0=peg$c76,peg$currPos+=3):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c77)),s0===peg$FAILED&&(input.substr(peg$currPos,4)===peg$c78?(s0=peg$c78,peg$currPos+=4):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c79)),s0===peg$FAILED&&(input.substr(peg$currPos,8)===peg$c80?(s0=peg$c80,peg$currPos+=8):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c81)),s0===peg$FAILED&&(s0=peg$currPos,input.substr(peg$currPos,8)===peg$c82?(s1=peg$c82,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c83)),s1!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c84()),s0=s1))))),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c73)),s0}function peg$parseParticleArgumentType(){let s0;return(s0=peg$parseTypeVariable())===peg$FAILED&&(s0=peg$parseCollectionType())===peg$FAILED&&(s0=peg$parseBigCollectionType())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,10)===peg$c93?(s1=peg$c93,peg$currPos+=10):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c94)),s1!==peg$FAILED&&(s2=peg$parseParticleArgumentType())!==peg$FAILED?(62===input.charCodeAt(peg$currPos)?(s3=peg$c39,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c40)),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c95(s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12;if(s0=peg$currPos,input.substr(peg$currPos,4)===peg$c102?(s1=peg$c102,peg$currPos+=4):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c103)),s1!==peg$FAILED)if(s2=peg$currPos,peg$silentFails++,peg$c104.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c105)),peg$silentFails--,s3!==peg$FAILED?(peg$currPos=s2,s2=void 0):s2=peg$FAILED,s2!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parsewhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED)if(123===input.charCodeAt(peg$currPos)?(s5=peg$c106,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c107)),s5!==peg$FAILED){if(s6=peg$currPos,(s7=peg$parseSlotField())!==peg$FAILED){for(s8=[],s9=peg$currPos,44===input.charCodeAt(peg$currPos)?(s10=peg$c108,peg$currPos++):(s10=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s10!==peg$FAILED&&(s11=peg$parsewhiteSpace())!==peg$FAILED&&(s12=peg$parseSlotField())!==peg$FAILED?s9=s10=[s10,s11,s12]:(peg$currPos=s9,s9=peg$FAILED);s9!==peg$FAILED;)s8.push(s9),s9=peg$currPos,44===input.charCodeAt(peg$currPos)?(s10=peg$c108,peg$currPos++):(s10=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s10!==peg$FAILED&&(s11=peg$parsewhiteSpace())!==peg$FAILED&&(s12=peg$parseSlotField())!==peg$FAILED?s9=s10=[s10,s11,s12]:(peg$currPos=s9,s9=peg$FAILED);s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)}else peg$currPos=s6,s6=peg$FAILED;s6===peg$FAILED&&(s6=null),s6!==peg$FAILED?(125===input.charCodeAt(peg$currPos)?(s7=peg$c110,peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c111)),s7!==peg$FAILED?s3=s4=[s4,s5,s6,s7]:(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c112(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=peg$parseSchemaInline())===peg$FAILED&&(s0=peg$parseTypeName()),s0}function peg$parseCollectionType(){let s0,s1,s2,s3;return s0=peg$currPos,91===input.charCodeAt(peg$currPos)?(s1=peg$c85,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c86)),s1!==peg$FAILED&&(s2=peg$parseParticleArgumentType())!==peg$FAILED?(93===input.charCodeAt(peg$currPos)?(s3=peg$c87,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c88)),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c89(s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseBigCollectionType(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,14)===peg$c90?(s1=peg$c90,peg$currPos+=14):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c91)),s1!==peg$FAILED&&(s2=peg$parseParticleArgumentType())!==peg$FAILED?(62===input.charCodeAt(peg$currPos)?(s3=peg$c39,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c40)),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c92(s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseTypeVariable(){let s0,s1,s2,s3,s4,s5,s6,s7;return peg$silentFails++,s0=peg$currPos,126===input.charCodeAt(peg$currPos)?(s1=peg$c97,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c98)),s1!==peg$FAILED&&(s2=peg$parselowerIdent())!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,4)===peg$c99?(s5=peg$c99,peg$currPos+=4):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c100)),s5!==peg$FAILED&&(s6=peg$parsewhiteSpace())!==peg$FAILED&&(s7=peg$parseParticleArgumentType())!==peg$FAILED?s3=s4=[s4,s5,s6,s7]:(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c101(s2,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c96)),s0}function peg$parseSlotField(){let s0,s1,s2,s3,s4,s5;return s0=peg$currPos,(s1=peg$parsefieldName())!==peg$FAILED?((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(58===input.charCodeAt(peg$currPos)?(s3=peg$c59,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c60)),s3!==peg$FAILED?((s4=peg$parsewhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED&&(s5=peg$parselowerIdent())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c113(s1,s5)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseTypeName(){let s0,s1;return s0=peg$currPos,(s1=peg$parseupperIdent())!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c114(s1)),s0=s1}function peg$parseParticleSlotItem(){let s0;return(s0=peg$parseSlotFormFactor())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13;if(s0=peg$currPos,s1=peg$currPos,input.substr(peg$currPos,4)===peg$c45?(s2=peg$c45,peg$currPos+=4):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c46)),s2!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED)if(input.substr(peg$currPos,7)===peg$c49?(s2=peg$c49,peg$currPos+=7):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c50)),s2!==peg$FAILED)if((s3=peg$parsewhiteSpace())!==peg$FAILED)if(s4=peg$currPos,input.substr(peg$currPos,6)===peg$c51?(s5=peg$c51,peg$currPos+=6):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c52)),s5!==peg$FAILED&&(s6=peg$parsewhiteSpace())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if((s5=peg$parselowerIdent())!==peg$FAILED)if(s6=peg$currPos,(s7=peg$parsewhiteSpace())!==peg$FAILED&&(s8=peg$parseTagList())!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED),s6===peg$FAILED&&(s6=null),s6!==peg$FAILED)if((s7=peg$parseeolWhiteSpace())!==peg$FAILED){if(s8=peg$currPos,(s9=peg$parseIndent())!==peg$FAILED){for(s10=[],s11=peg$currPos,(s12=peg$parseSameIndent())!==peg$FAILED&&(s13=peg$parseParticleProvidedSlotItem())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED);s11!==peg$FAILED;)s10.push(s11),s11=peg$currPos,(s12=peg$parseSameIndent())!==peg$FAILED&&(s13=peg$parseParticleProvidedSlotItem())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED);s10!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED)}else peg$currPos=s8,s8=peg$FAILED;s8===peg$FAILED&&(s8=null),s8!==peg$FAILED?(peg$savedPos=s0,s1=peg$c147(s1,s4,s5,s6,s8),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}()),s0}function peg$parseSlotFormFactor(){let s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,10)===peg$c136?(s1=peg$c136,peg$currPos+=10):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c137)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,10)===peg$c138?(s3=peg$c138,peg$currPos+=10):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c139)),s3===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c140?(s3=peg$c140,peg$currPos+=3):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c141)),s3===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c142?(s3=peg$c142,peg$currPos+=6):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c143)),s3===peg$FAILED&&(input.substr(peg$currPos,5)===peg$c144?(s3=peg$c144,peg$currPos+=5):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c145))))),s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c146(s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseParticleProvidedSlotItem(){let s0;return(s0=peg$parseSlotFormFactor())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c148?(s1=peg$c148,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c149)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parselowerIdent())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c150(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}function peg$parseDescription(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10;if(s0=peg$currPos,input.substr(peg$currPos,11)===peg$c29?(s1=peg$c29,peg$currPos+=11):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c30)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parsebackquotedString())!==peg$FAILED)if((s4=peg$parseeolWhiteSpace())!==peg$FAILED){if(s5=peg$currPos,(s6=peg$parseIndent())!==peg$FAILED){if(s7=[],s8=peg$currPos,(s9=peg$parseSameIndent())!==peg$FAILED&&(s10=peg$parseParticleHandleDescription())!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED),s8!==peg$FAILED)for(;s8!==peg$FAILED;)s7.push(s8),s8=peg$currPos,(s9=peg$parseSameIndent())!==peg$FAILED&&(s10=peg$parseParticleHandleDescription())!==peg$FAILED?s8=s9=[s9,s10]:(peg$currPos=s8,s8=peg$FAILED);else s7=peg$FAILED;s7!==peg$FAILED?s5=s6=[s6,s7]:(peg$currPos=s5,s5=peg$FAILED)}else peg$currPos=s5,s5=peg$FAILED;s5===peg$FAILED&&(s5=null),s5!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c151(s3,s5)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseParticleHandleDescription(){let s0,s1,s2,s3,s4;return s0=peg$currPos,(s1=peg$parselowerIdent())!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parsebackquotedString())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c152(s1,s3)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseRecipeItem(){let s0;return(s0=peg$parseRecipeParticle())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5;return s0=peg$currPos,(s1=peg$parseRecipeHandleFate())!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseHandleRef())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED&&(s5=peg$parseLocalName())!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c193(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=peg$parseRequireHandleSection())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8;if(s0=peg$currPos,input.substr(peg$currPos,7)===peg$c194?(s1=peg$c194,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c195)),s1!==peg$FAILED)if((s2=peg$parseeolWhiteSpace())!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parseIndent())!==peg$FAILED){for(s5=[],s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED?((s8=peg$parseRecipeParticle())===peg$FAILED&&(s8=peg$parseRequireHandleSection())===peg$FAILED&&(s8=peg$parseRecipeSlot()),s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)):(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,(s7=peg$parseSameIndent())!==peg$FAILED?((s8=peg$parseRecipeParticle())===peg$FAILED&&(s8=peg$parseRequireHandleSection())===peg$FAILED&&(s8=peg$parseRecipeSlot()),s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)):(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c196(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=peg$parseRecipeSlot())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13;if(s0=peg$currPos,input.substr(peg$currPos,6)===peg$c165?(s1=peg$c165,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c166)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parsebackquotedString())!==peg$FAILED)if((s4=peg$parseeolWhiteSpace())!==peg$FAILED){if(s5=peg$currPos,(s6=peg$parseIndent())!==peg$FAILED){if(s7=peg$currPos,(s8=peg$parseSameIndent())!==peg$FAILED)if(input.substr(peg$currPos,6)===peg$c167?(s9=peg$c167,peg$currPos+=6):(s9=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c168)),s9!==peg$FAILED){if(s10=[],s11=peg$currPos,(s12=peg$parsewhiteSpace())!==peg$FAILED&&(s13=peg$parsebackquotedString())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED),s11!==peg$FAILED)for(;s11!==peg$FAILED;)s10.push(s11),s11=peg$currPos,(s12=peg$parsewhiteSpace())!==peg$FAILED&&(s13=peg$parsebackquotedString())!==peg$FAILED?s11=s12=[s12,s13]:(peg$currPos=s11,s11=peg$FAILED);else s10=peg$FAILED;s10!==peg$FAILED&&(s11=peg$parseeolWhiteSpace())!==peg$FAILED?s7=s8=[s8,s9,s10,s11]:(peg$currPos=s7,s7=peg$FAILED)}else peg$currPos=s7,s7=peg$FAILED;else peg$currPos=s7,s7=peg$FAILED;s7!==peg$FAILED?s5=s6=[s6,s7]:(peg$currPos=s5,s5=peg$FAILED)}else peg$currPos=s5,s5=peg$FAILED;s5===peg$FAILED&&(s5=null),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c169(s3,s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6;return s0=peg$currPos,(s1=peg$parseConnectionTarget())!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parseDirection())!==peg$FAILED&&(s4=peg$parsewhiteSpace())!==peg$FAILED&&(s5=peg$parseConnectionTarget())!==peg$FAILED&&(s6=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c164(s1,s3,s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=peg$parseDescription()),s0}function peg$parseLocalName(){let s0,s1,s2,s3;return s0=peg$currPos,input.substr(peg$currPos,2)===peg$c156?(s1=peg$c156,peg$currPos+=2):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c157)),s1!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parselowerIdent())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c158(s3)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseRecipeParticle(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;if(s0=peg$currPos,(s1=function(){let s0,s1;return s0=peg$currPos,(s1=peg$parseupperIdent())!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c213(s1)),(s0=s1)===peg$FAILED&&(s0=peg$currPos,(s1=peg$parseVerb())!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c214(s1)),s0=s1),s0}())===peg$FAILED&&(42===input.charCodeAt(peg$currPos)?(s1=peg$c42,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43))),s1!==peg$FAILED)if(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseLocalName())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED)if((s3=peg$parseeolWhiteSpace())!==peg$FAILED){if(s4=peg$currPos,(s5=peg$parseIndent())!==peg$FAILED){for(s6=[],s7=peg$currPos,(s8=peg$parseSameIndent())!==peg$FAILED&&(s9=peg$parseRecipeParticleItem())!==peg$FAILED?s7=s8=[s8,s9]:(peg$currPos=s7,s7=peg$FAILED);s7!==peg$FAILED;)s6.push(s7),s7=peg$currPos,(s8=peg$parseSameIndent())!==peg$FAILED&&(s9=peg$parseRecipeParticleItem())!==peg$FAILED?s7=s8=[s8,s9]:(peg$currPos=s7,s7=peg$FAILED);s6!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED)}else peg$currPos=s4,s4=peg$FAILED;s4===peg$FAILED&&(s4=null),s4!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c159(s1,s2,s4)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseRecipeParticleItem(){let s0;return(s0=function peg$parseRecipeParticleSlotConnection(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11;if(s0=peg$currPos,(s1=function(){let s0;return input.substr(peg$currPos,7)===peg$c49?(s0=peg$c49,peg$currPos+=7):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c50)),s0===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c47?(s0=peg$c47,peg$currPos+=7):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c48))),s0}())!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=function(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parselowerIdent())!==peg$FAILED?((s2=peg$parseSpaceTagList())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c163(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())!==peg$FAILED)if(s4=peg$currPos,(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=peg$parseLocalName())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if((s5=peg$parseeolWhiteSpace())!==peg$FAILED){if(s6=peg$currPos,(s7=peg$parseIndent())!==peg$FAILED){for(s8=[],s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseRecipeParticleSlotConnection())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s9!==peg$FAILED;)s8.push(s9),s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseRecipeParticleSlotConnection())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)}else peg$currPos=s6,s6=peg$FAILED;s6===peg$FAILED&&(s6=null),s6!==peg$FAILED?(peg$savedPos=s0,s1=peg$c162(s1,s3,s4,s6),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function peg$parseRecipeParticleConnection(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11;if(s0=peg$currPos,(s1=peg$parselowerIdent())===peg$FAILED&&(42===input.charCodeAt(peg$currPos)?(s1=peg$c42,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43))),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())!==peg$FAILED)if((s3=peg$parseDirection())!==peg$FAILED)if(s4=peg$currPos,(s5=peg$parsewhiteSpace())!==peg$FAILED&&(s6=function(){let s0,s1,s2,s3;return s0=peg$currPos,(s1=peg$parseupperIdent())===peg$FAILED&&(s1=peg$parselowerIdent()),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED?((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED?((s3=peg$parseTagList())===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c161(s1,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())!==peg$FAILED?s4=s5=[s5,s6]:(peg$currPos=s4,s4=peg$FAILED),s4===peg$FAILED&&(s4=null),s4!==peg$FAILED)if((s5=peg$parseeolWhiteSpace())!==peg$FAILED){if(s6=peg$currPos,(s7=peg$parseIndent())!==peg$FAILED){for(s8=[],s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseRecipeParticleConnection())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s9!==peg$FAILED;)s8.push(s9),s9=peg$currPos,(s10=peg$parseSameIndent())!==peg$FAILED&&(s11=peg$parseRecipeParticleConnection())!==peg$FAILED?s9=s10=[s10,s11]:(peg$currPos=s9,s9=peg$FAILED);s8!==peg$FAILED?s6=s7=[s7,s8]:(peg$currPos=s6,s6=peg$FAILED)}else peg$currPos=s6,s6=peg$FAILED;s6===peg$FAILED&&(s6=null),s6!==peg$FAILED?(peg$savedPos=s0,s1=peg$c160(s1,s3,s4,s6),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}()),s0}function peg$parseDirection(){let s0;return input.substr(peg$currPos,2)===peg$c170?(s0=peg$c170,peg$currPos+=2):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c171)),s0===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c172?(s0=peg$c172,peg$currPos+=2):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c173)),s0===peg$FAILED&&(61===input.charCodeAt(peg$currPos)?(s0=peg$c174,peg$currPos++):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c175)),s0===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c47?(s0=peg$c47,peg$currPos+=7):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c48)),s0===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c49?(s0=peg$c49,peg$currPos+=7):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c50)))))),s0}function peg$parseConnectionTarget(){let s0;return(s0=function(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parseVerbList())!==peg$FAILED?((s2=peg$parseConnectionTargetHandleComponents())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c176(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1;return s0=peg$currPos,(s1=peg$parseTagList())!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c177(s1)),s0=s1}())===peg$FAILED&&(s0=function(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parseupperIdent())!==peg$FAILED?((s2=peg$parseConnectionTargetHandleComponents())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c179(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parselowerIdent())!==peg$FAILED?((s2=peg$parseConnectionTargetHandleComponents())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c178(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}()),s0}function peg$parseConnectionTargetHandleComponents(){let s0,s1,s2,s3,s4,s5;return s0=peg$currPos,46===input.charCodeAt(peg$currPos)?(s1=peg$c180,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c181)),s1!==peg$FAILED?((s2=peg$parselowerIdent())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())===peg$FAILED&&(s4=null),s4!==peg$FAILED&&(s5=peg$parseTagList())!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c182(s2,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseRecipeHandleFate(){let s0;return 63===input.charCodeAt(peg$currPos)?(s0=peg$c70,peg$currPos++):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c71)),s0===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c183?(s0=peg$c183,peg$currPos+=3):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c184)),s0===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c185?(s0=peg$c185,peg$currPos+=3):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c186)),s0===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c187?(s0=peg$c187,peg$currPos+=6):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c188)),s0===peg$FAILED&&(input.substr(peg$currPos,4)===peg$c189?(s0=peg$c189,peg$currPos+=4):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c190)),s0===peg$FAILED&&(input.substr(peg$currPos,5)===peg$c191?(s0=peg$c191,peg$currPos+=5):(s0=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c192))))))),s0}function peg$parseRequireHandleSection(){let s0,s1,s2,s3,s4,s5;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c148?(s1=peg$c148,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c149)),s1!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseLocalName())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED&&(s5=peg$parseHandleRef())!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c197(s2,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseTagList(){let s0,s1,s2,s3,s4;return s0=peg$currPos,(s1=function(){let s0,s1,s2,s3,s4;if(s0=peg$currPos,35===input.charCodeAt(peg$currPos)?(s1=peg$c198,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c199)),s1!==peg$FAILED)if(peg$c200.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c201)),s2!==peg$FAILED){for(s3=[],peg$c202.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c203));s4!==peg$FAILED;)s3.push(s4),peg$c202.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c203));s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c204()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseTagList())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c205(s1,s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseVerb(){let s0,s1,s2,s3,s4;if(peg$silentFails++,s0=peg$currPos,38===input.charCodeAt(peg$currPos)?(s1=peg$c207,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c208)),s1!==peg$FAILED)if(peg$c200.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c201)),s2!==peg$FAILED){for(s3=[],peg$c202.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c203));s4!==peg$FAILED;)s3.push(s4),peg$c202.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c203));s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c204()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c206)),s0}function peg$parseVerbList(){let s0,s1,s2,s3,s4;return s0=peg$currPos,(s1=peg$parseVerb())!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseVerbList())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c205(s1,s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseSpaceTagList(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parsewhiteSpace())!==peg$FAILED&&(s2=peg$parseTagList())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c209(s2)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseHandleRef(){let s0,s1,s2;return s0=peg$currPos,(s1=peg$parseid())!==peg$FAILED?((s2=peg$parseSpaceTagList())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c215(s1,s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$currPos,(s1=peg$parseupperIdent())!==peg$FAILED?((s2=peg$parseSpaceTagList())===peg$FAILED&&(s2=null),s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c216(s1,s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$currPos,(s1=peg$parseTagList())!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c217(s1)),s0=s1)),s0}function peg$parseRecipeSlot(){let s0,s1,s2,s3,s4,s5;return s0=peg$currPos,input.substr(peg$currPos,4)===peg$c218?(s1=peg$c218,peg$currPos+=4):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c219)),s1!==peg$FAILED?(s2=peg$currPos,(s3=peg$parsewhiteSpace())!==peg$FAILED&&(s4=peg$parseHandleRef())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2===peg$FAILED&&(s2=null),s2!==peg$FAILED?(s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED&&(s5=peg$parseLocalName())!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c220(s2,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseSchemaInline(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;if(s0=peg$currPos,s1=[],s2=peg$currPos,(s3=peg$parseupperIdent())===peg$FAILED&&(42===input.charCodeAt(peg$currPos)?(s3=peg$c42,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43))),s3!==peg$FAILED&&(s4=peg$parsewhiteSpace())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),s2=peg$currPos,(s3=peg$parseupperIdent())===peg$FAILED&&(42===input.charCodeAt(peg$currPos)?(s3=peg$c42,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43))),s3!==peg$FAILED&&(s4=peg$parsewhiteSpace())!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED);else s1=peg$FAILED;if(s1!==peg$FAILED)if(123===input.charCodeAt(peg$currPos)?(s2=peg$c106,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c107)),s2!==peg$FAILED){if(s3=peg$currPos,(s4=peg$parseSchemaInlineField())!==peg$FAILED){for(s5=[],s6=peg$currPos,44===input.charCodeAt(peg$currPos)?(s7=peg$c108,peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s7!==peg$FAILED&&(s8=peg$parsewhiteSpace())!==peg$FAILED&&(s9=peg$parseSchemaInlineField())!==peg$FAILED?s6=s7=[s7,s8,s9]:(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,44===input.charCodeAt(peg$currPos)?(s7=peg$c108,peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s7!==peg$FAILED&&(s8=peg$parsewhiteSpace())!==peg$FAILED&&(s9=peg$parseSchemaInlineField())!==peg$FAILED?s6=s7=[s7,s8,s9]:(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?(125===input.charCodeAt(peg$currPos)?(s4=peg$c110,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c111)),s4!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c221(s1,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseSchemaInlineField(){let s0,s1,s2,s3;return s0=peg$currPos,s1=peg$currPos,(s2=peg$parseSchemaType())!==peg$FAILED&&(s3=peg$parsewhiteSpace())!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED&&(s2=peg$parsefieldName())!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c222(s1,s2)):(peg$currPos=s0,s0=peg$FAILED),s0}function peg$parseSchemaSpec(){let s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,6)===peg$c223?(s1=peg$c223,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c224)),s1!==peg$FAILED){if(s2=[],s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c42,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43)),s5===peg$FAILED&&(s5=peg$parseupperIdent()),s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,(s4=peg$parsewhiteSpace())!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c42,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43)),s5===peg$FAILED&&(s5=peg$parseupperIdent()),s5!==peg$FAILED?s3=s4=[s4,s5]:(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);else s2=peg$FAILED;s2!==peg$FAILED?((s3=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9,s10;if(s0=peg$currPos,(s1=peg$parsewhiteSpace())!==peg$FAILED)if(input.substr(peg$currPos,7)===peg$c230?(s2=peg$c230,peg$currPos+=7):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c231)),s2!==peg$FAILED)if((s3=peg$parsewhiteSpace())!==peg$FAILED)if((s4=peg$parseupperIdent())!==peg$FAILED){for(s5=[],s6=peg$currPos,(s7=peg$parsewhiteSpace())===peg$FAILED&&(s7=null),s7!==peg$FAILED?(44===input.charCodeAt(peg$currPos)?(s8=peg$c108,peg$currPos++):(s8=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s8!==peg$FAILED&&(s9=peg$parsewhiteSpace())!==peg$FAILED&&(s10=peg$parseupperIdent())!==peg$FAILED?s6=s7=[s7,s8,s9,s10]:(peg$currPos=s6,s6=peg$FAILED)):(peg$currPos=s6,s6=peg$FAILED);s6!==peg$FAILED;)s5.push(s6),s6=peg$currPos,(s7=peg$parsewhiteSpace())===peg$FAILED&&(s7=null),s7!==peg$FAILED?(44===input.charCodeAt(peg$currPos)?(s8=peg$c108,peg$currPos++):(s8=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s8!==peg$FAILED&&(s9=peg$parsewhiteSpace())!==peg$FAILED&&(s10=peg$parseupperIdent())!==peg$FAILED?s6=s7=[s7,s8,s9,s10]:(peg$currPos=s6,s6=peg$FAILED)):(peg$currPos=s6,s6=peg$FAILED);s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c232(s4,s5),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s3=null),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c225(s2,s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseSchemaItem(){let s0;return(s0=function(){let s0,s1,s2,s3,s4;return s0=peg$currPos,(s1=peg$parseSchemaType())!==peg$FAILED&&(s2=peg$parsewhiteSpace())!==peg$FAILED&&(s3=peg$parsefieldName())!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?(peg$savedPos=s0,s1=peg$c233(s1,s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED),s0}())===peg$FAILED&&(s0=peg$parseDescription()),s0}function peg$parseSchemaType(){let s0;return(s0=peg$parseSchemaReferenceType())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,91===input.charCodeAt(peg$currPos)?(s1=peg$c85,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c86)),s1!==peg$FAILED){for(s2=[],s3=peg$parsewhiteSpace();s3!==peg$FAILED;)s2.push(s3),s3=peg$parsewhiteSpace();if(s2!==peg$FAILED)if((s3=peg$parseSchemaReferenceType())!==peg$FAILED){for(s4=[],s5=peg$parsewhiteSpace();s5!==peg$FAILED;)s4.push(s5),s5=peg$parsewhiteSpace();s4!==peg$FAILED?(93===input.charCodeAt(peg$currPos)?(s5=peg$c87,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c88)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c234(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED}else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=peg$parseSchemaPrimitiveType())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;if(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c249,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c250)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED)if((s3=peg$parseSchemaPrimitiveType())!==peg$FAILED){if(s4=[],s5=peg$currPos,(s6=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c251?(s7=peg$c251,peg$currPos+=2):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c252)),s7!==peg$FAILED&&(s8=peg$parsewhiteSpace())!==peg$FAILED&&(s9=peg$parseSchemaPrimitiveType())!==peg$FAILED?s5=s6=[s6,s7,s8,s9]:(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED),s5!==peg$FAILED)for(;s5!==peg$FAILED;)s4.push(s5),s5=peg$currPos,(s6=peg$parsewhiteSpace())!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c251?(s7=peg$c251,peg$currPos+=2):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c252)),s7!==peg$FAILED&&(s8=peg$parsewhiteSpace())!==peg$FAILED&&(s9=peg$parseSchemaPrimitiveType())!==peg$FAILED?s5=s6=[s6,s7,s8,s9]:(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED);else s4=peg$FAILED;s4!==peg$FAILED?((s5=peg$parsewhiteSpace())===peg$FAILED&&(s5=null),s5!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s6=peg$c253,peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c254)),s6!==peg$FAILED?(peg$savedPos=s0,s1=peg$c255(s3,s4),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}())===peg$FAILED&&(s0=function(){let s0,s1,s2,s3,s4,s5,s6,s7,s8,s9;if(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c249,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c250)),s1!==peg$FAILED)if((s2=peg$parsewhiteSpace())===peg$FAILED&&(s2=null),s2!==peg$FAILED)if((s3=peg$parseSchemaPrimitiveType())!==peg$FAILED){for(s4=[],s5=peg$currPos,(s6=peg$parsewhiteSpace())===peg$FAILED&&(s6=null),s6!==peg$FAILED?(44===input.charCodeAt(peg$currPos)?(s7=peg$c108,peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s7!==peg$FAILED?((s8=peg$parsewhiteSpace())===peg$FAILED&&(s8=null),s8!==peg$FAILED&&(s9=peg$parseSchemaPrimitiveType())!==peg$FAILED?s5=s6=[s6,s7,s8,s9]:(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED);s5!==peg$FAILED;)s4.push(s5),s5=peg$currPos,(s6=peg$parsewhiteSpace())===peg$FAILED&&(s6=null),s6!==peg$FAILED?(44===input.charCodeAt(peg$currPos)?(s7=peg$c108,peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c109)),s7!==peg$FAILED?((s8=peg$parsewhiteSpace())===peg$FAILED&&(s8=null),s8!==peg$FAILED&&(s9=peg$parseSchemaPrimitiveType())!==peg$FAILED?s5=s6=[s6,s7,s8,s9]:(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED)):(peg$currPos=s5,s5=peg$FAILED);s4!==peg$FAILED?((s5=peg$parsewhiteSpace())===peg$FAILED&&(s5=null),s5!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s6=peg$c253,peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c254)),s6!==peg$FAILED?(peg$savedPos=s0,s1=peg$c256(s3,s4),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return s0}()),s0}function peg$parseSchemaReferenceType(){let s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,10)===peg$c93?(s1=peg$c93,peg$currPos+=10):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c94)),s1!==peg$FAILED){for(s2=[],s3=peg$parsewhiteSpace();s3!==peg$FAILED;)s2.push(s3),s3=peg$parsewhiteSpace();if(s2!==peg$FAILED)if((s3=peg$parseSchemaInline())===peg$FAILED&&(s3=peg$parseTypeName()),s3!==peg$FAILED){for(s4=[],s5=peg$parsewhiteSpace();s5!==peg$FAILED;)s4.push(s5),s5=peg$parsewhiteSpace();s4!==peg$FAILED?(62===input.charCodeAt(peg$currPos)?(s5=peg$c39,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c40)),s5!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c235(s3)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseSchemaPrimitiveType(){let s0,s1;return s0=peg$currPos,input.substr(peg$currPos,4)===peg$c236?(s1=peg$c236,peg$currPos+=4):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c237)),s1===peg$FAILED&&(input.substr(peg$currPos,3)===peg$c238?(s1=peg$c238,peg$currPos+=3):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c239)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c240?(s1=peg$c240,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c241)),s1===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c242?(s1=peg$c242,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c243)),s1===peg$FAILED&&(input.substr(peg$currPos,5)===peg$c244?(s1=peg$c244,peg$currPos+=5):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c245)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c246?(s1=peg$c246,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c247))))))),s1!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c248(s1)),s0=s1}function peg$parseIndent(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,peg$silentFails++,s1=peg$currPos,s2=[],32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));else s2=peg$FAILED;return s2!==peg$FAILED?(peg$savedPos=peg$currPos,(s3=(s3=peg$c264(s2))?void 0:peg$FAILED)!==peg$FAILED?s1=s2=[s2,s3]:(peg$currPos=s1,s1=peg$FAILED)):(peg$currPos=s1,s1=peg$FAILED),peg$silentFails--,s1!==peg$FAILED?(peg$currPos=s0,s0=void 0):s0=peg$FAILED,peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c261)),s0}function peg$parseSameIndent(){let s0,s1,s2,s3,s4;for(peg$silentFails++,s0=peg$currPos,s1=peg$currPos,peg$silentFails++,s2=peg$currPos,s3=[],32===input.charCodeAt(peg$currPos)?(s4=peg$c262,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s4!==peg$FAILED;)s3.push(s4),32===input.charCodeAt(peg$currPos)?(s4=peg$c262,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));if(s3!==peg$FAILED?(peg$savedPos=peg$currPos,(s4=(s4=peg$c266(s3))?void 0:peg$FAILED)!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED)):(peg$currPos=s2,s2=peg$FAILED),peg$silentFails--,s2!==peg$FAILED?(peg$currPos=s1,s1=void 0):s1=peg$FAILED,s1!==peg$FAILED){for(s2=[],32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s3!==peg$FAILED;)s2.push(s3),32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s2!==peg$FAILED?s0=s1=[s1,s2]:(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c265)),s0}function peg$parseSameOrMoreIndent(){let s0,s1,s2,s3,s4;for(peg$silentFails++,s0=peg$currPos,s1=peg$currPos,peg$silentFails++,s2=peg$currPos,s3=[],32===input.charCodeAt(peg$currPos)?(s4=peg$c262,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s4!==peg$FAILED;)s3.push(s4),32===input.charCodeAt(peg$currPos)?(s4=peg$c262,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));if(s3!==peg$FAILED?(peg$savedPos=peg$currPos,(s4=(s4=peg$c268(s3))?void 0:peg$FAILED)!==peg$FAILED?s2=s3=[s3,s4]:(peg$currPos=s2,s2=peg$FAILED)):(peg$currPos=s2,s2=peg$FAILED),peg$silentFails--,s2!==peg$FAILED?(peg$currPos=s1,s1=void 0):s1=peg$FAILED,s1!==peg$FAILED){for(s2=[],32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s3!==peg$FAILED;)s2.push(s3),32===input.charCodeAt(peg$currPos)?(s3=peg$c262,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c14()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c267)),s0}function peg$parsebackquotedString(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,96===input.charCodeAt(peg$currPos)?(s1=peg$c274,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c275)),s1!==peg$FAILED){if(s2=[],peg$c276.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c277)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c276.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c277));else s2=peg$FAILED;s2!==peg$FAILED?(96===input.charCodeAt(peg$currPos)?(s3=peg$c274,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c275)),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c278(s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c273)),s0}function peg$parseid(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,39===input.charCodeAt(peg$currPos)?(s1=peg$c280,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c281)),s1!==peg$FAILED){if(s2=[],peg$c282.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c283)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c282.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c283));else s2=peg$FAILED;s2!==peg$FAILED?(39===input.charCodeAt(peg$currPos)?(s3=peg$c280,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c281)),s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c284(s2)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c279)),s0}function peg$parseupperIdent(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,peg$c286.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c287)),s1!==peg$FAILED){for(s2=[],peg$c288.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s3!==peg$FAILED;)s2.push(s3),peg$c288.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c14()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c285)),s0}function peg$parselowerIdent(){let s0,s1,s2,s3,s4;if(peg$silentFails++,s0=peg$currPos,s1=peg$currPos,peg$silentFails++,s2=function(){let s0,s1,s2,s3;return s0=peg$currPos,(s1=peg$parseDirection())===peg$FAILED&&(s1=peg$parseParticleArgumentDirection())===peg$FAILED&&(s1=peg$parseRecipeHandleFate())===peg$FAILED&&(input.substr(peg$currPos,8)===peg$c65?(s1=peg$c65,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c66)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c153?(s1=peg$c153,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c154)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c31?(s1=peg$c31,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c32)),s1===peg$FAILED&&(input.substr(peg$currPos,9)===peg$c35?(s1=peg$c35,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c36)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c223?(s1=peg$c223,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c224)),s1===peg$FAILED&&(input.substr(peg$currPos,7)===peg$c194?(s1=peg$c194,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c195)),s1===peg$FAILED&&(input.substr(peg$currPos,6)===peg$c148?(s1=peg$c148,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c149))))))))),s1!==peg$FAILED?(peg$c269.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c270)),s2===peg$FAILED&&(s2=peg$currPos,peg$silentFails++,input.length>peg$currPos?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c271)),peg$silentFails--,s3===peg$FAILED?s2=void 0:(peg$currPos=s2,s2=peg$FAILED)),s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c272(s1)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0}(),peg$silentFails--,s2===peg$FAILED?s1=void 0:(peg$currPos=s1,s1=peg$FAILED),s1!==peg$FAILED)if(peg$c291.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c292)),s2!==peg$FAILED){for(s3=[],peg$c288.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s4!==peg$FAILED;)s3.push(s4),peg$c288.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s3!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c14()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c290)),s0}function peg$parsefieldName(){let s0,s1,s2,s3;if(peg$silentFails++,s0=peg$currPos,peg$c291.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c292)),s1!==peg$FAILED){for(s2=[],peg$c288.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s3!==peg$FAILED;)s2.push(s3),peg$c288.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c289));s2!==peg$FAILED?(peg$savedPos=s0,s0=s1=peg$c14()):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c293)),s0}function peg$parsewhiteSpace(){let s0,s1;if(peg$silentFails++,s0=[],32===input.charCodeAt(peg$currPos)?(s1=peg$c262,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263)),s1!==peg$FAILED)for(;s1!==peg$FAILED;)s0.push(s1),32===input.charCodeAt(peg$currPos)?(s1=peg$c262,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c263));else s0=peg$FAILED;return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c294)),s0}function peg$parseeolWhiteSpace(){let s0,s1,s2,s3,s4;for(peg$silentFails++,s0=peg$currPos,s1=[],peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));s2!==peg$FAILED;)s1.push(s2),peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));if(s1!==peg$FAILED?(s2=peg$currPos,peg$silentFails++,input.length>peg$currPos?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c271)),peg$silentFails--,s3===peg$FAILED?s2=void 0:(peg$currPos=s2,s2=peg$FAILED),s2!==peg$FAILED?s0=s1=[s1,s2]:(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED){for(s0=peg$currPos,s1=[],peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));s2!==peg$FAILED;)s1.push(s2),peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));if(s1!==peg$FAILED)if(input.substr(peg$currPos,2)===peg$c298?(s2=peg$c298,peg$currPos+=2):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c299)),s2!==peg$FAILED){for(s3=[],peg$c12.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13));s4!==peg$FAILED;)s3.push(s4),peg$c12.test(input.charAt(peg$currPos))?(s4=input.charAt(peg$currPos),peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13));s3!==peg$FAILED&&(s4=peg$parseeolWhiteSpace())!==peg$FAILED?s0=s1=[s1,s2,s3,s4]:(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;else peg$currPos=s0,s0=peg$FAILED;if(s0===peg$FAILED){for(s0=peg$currPos,s1=[],peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));s2!==peg$FAILED;)s1.push(s2),peg$c296.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c297));s1!==peg$FAILED&&(s2=peg$parseeol())!==peg$FAILED?((s3=peg$parseeolWhiteSpace())===peg$FAILED&&(s3=null),s3!==peg$FAILED?s0=s1=[s1,s2,s3]:(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)}}return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c295)),s0}function peg$parseeol(){let s0,s1,s2,s3;return peg$silentFails++,s0=peg$currPos,13===input.charCodeAt(peg$currPos)?(s1=peg$c301,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c302)),s1===peg$FAILED&&(s1=null),s1!==peg$FAILED?(10===input.charCodeAt(peg$currPos)?(s2=peg$c303,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c304)),s2!==peg$FAILED?(13===input.charCodeAt(peg$currPos)?(s3=peg$c301,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c302)),s3===peg$FAILED&&(s3=null),s3!==peg$FAILED?s0=s1=[s1,s2,s3]:(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c300)),s0}let indent="",startIndent="";const indents=[],emptyRef=()=>({kind:"handle-ref",id:null,name:null,tags:[],location:location()});function extractIndented(items){return items[1].map(item=>item[1])}function optional(result,extract,defaultValue){if(null!==result){const value=extract(result);if(null!==value)return value}return null===defaultValue?null:defaultValue}if((peg$result=peg$startRuleFunction())!==peg$FAILED&&peg$currPos===input.length)return peg$result;throw peg$result!==peg$FAILED&&peg$currPos<input.length&&peg$fail({type:"end"}),peg$buildStructuredError(peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos))}},function(module,__webpack_exports__,__webpack_require__){"use strict";async function digest(str){const buffer=(new TextEncoder).encode(str),digest=await crypto.subtle.digest("SHA-1",buffer);return Array.from(new Uint8Array(digest)).map(x=>("00"+x.toString(16)).slice(-2)).join("")}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"digest",function(){return digest})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ManifestMeta",function(){return ManifestMeta});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ManifestMeta{constructor(){this.storageKey=null,this.name=null}apply(items){items.forEach(item=>{this[item.key]=item.value})}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"EndPoint",function(){return EndPoint}),__webpack_require__.d(__webpack_exports__,"ParticleEndPoint",function(){return ParticleEndPoint}),__webpack_require__.d(__webpack_exports__,"InstanceEndPoint",function(){return InstanceEndPoint}),__webpack_require__.d(__webpack_exports__,"HandleEndPoint",function(){return HandleEndPoint}),__webpack_require__.d(__webpack_exports__,"TagEndPoint",function(){return TagEndPoint}),__webpack_require__.d(__webpack_exports__,"ConnectionConstraint",function(){return ConnectionConstraint});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_comparable_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(37);class EndPoint{}class ParticleEndPoint extends EndPoint{constructor(particle,connection){super(),this.particle=particle,this.connection=connection}_clone(cloneMap){return new ParticleEndPoint(this.particle,this.connection)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.particle.name,other.particle.name))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.connection,other.connection))?cmp:0}toString(nameMap){return this.connection?`${this.particle.name}.${this.connection}`:`${this.particle.name}`}}class InstanceEndPoint extends EndPoint{constructor(instance,connection){super(),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(instance),this.instance=instance,this.connection=connection}_clone(cloneMap){return new InstanceEndPoint(cloneMap.get(this.instance),this.connection)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareComparables)(this.instance,other.instance))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.connection,other.connection))?cmp:0}toString(nameMap){return this.connection?`${nameMap.get(this.instance)}.${this.connection}`:`${nameMap.get(this.instance)}`}}class HandleEndPoint extends EndPoint{constructor(handle){super(),this.handle=handle}_clone(cloneMap){return new HandleEndPoint(this.handle)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.handle.localName,other.handle.localName))?cmp:0}toString(nameMap){return`${this.handle.localName}`}}class TagEndPoint extends EndPoint{constructor(tags){super(),this.tags=tags}_clone(cloneMap){return new TagEndPoint(this.tags)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareArrays)(this.tags,other.tags,_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings))?cmp:0}toString(nameMap){return this.tags.map(a=>`#${a}`).join(" ")}}class ConnectionConstraint{constructor(fromConnection,toConnection,direction,type){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(direction),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type),this.from=fromConnection,this.to=toConnection,this.direction=direction,this.type=type,Object.freeze(this)}_copyInto(recipe,cloneMap){if("constraint"===this.type){if(!(this.from instanceof InstanceEndPoint||this.to instanceof InstanceEndPoint))return recipe.newConnectionConstraint(this.from._clone(),this.to._clone(),this.direction);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1)}return recipe.newObligation(this.from._clone(cloneMap),this.to._clone(cloneMap),this.direction)}_compareTo(other){let cmp;return 0!==(cmp=this.from._compareTo(other.from))?cmp:0!==(cmp=this.to._compareTo(other.to))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.direction,other.direction))?cmp:0}toString(nameMap,options){let unresolved="";return options&&!0===options.showUnresolved&&"obligation"===this.type&&(unresolved=" // unresolved obligation"),`${this.from.toString(nameMap)} ${this.direction} ${this.to.toString(nameMap)}${unresolved}`}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Handle",function(){return Handle});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_type_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(18),_type_checker_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(20),_comparable_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(37);class Handle{constructor(recipe){this._id=null,this._localName=void 0,this._tags=[],this._type=void 0,this._fate=null,this._originalFate=null,this._originalId=null,this._connections=[],this._mappedType=void 0,this._storageKey=void 0,this._pattern=void 0,this._immediateValue=void 0,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe),this._recipe=recipe}_copyInto(recipe,cloneMap,variableMap){let handle=void 0;return null!==this._id&&["map","use","copy"].includes(this.fate)&&(handle=recipe.findHandle(this._id)),null==handle&&((handle=recipe.newHandle())._id=this._id,handle._tags=[...this._tags],handle._type=this._type?this._type._cloneWithResolutions(variableMap):void 0,handle._fate=this._fate,handle._originalFate=this._originalFate,handle._originalId=this._originalId,handle._mappedType=this._mappedType,handle._storageKey=this._storageKey,handle._immediateValue=this._immediateValue,handle._connections=[],handle._pattern=this._pattern),handle}mergeInto(handle){for(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.recipe===handle.recipe,"Cannot merge handles from different recipes.");this.connections.length>0;){const[connection]=this.connections;connection.disconnectHandle(),connection.connectToHandle(handle)}handle._immediateValue=this._immediateValue,handle.tags=handle.tags.concat(this.tags),handle.recipe.removeHandle(this),handle.fate=this._mergedFate([this.fate,handle.fate])}_mergedFate(fates){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(fates.length>0,"Cannot merge empty fates list"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!fates.includes("map")&&!fates.includes("copy"),"Merging map/copy not supported yet"),fates.every(fate=>"use"===fate)?"use":"create"}_startNormalize(){this._localName=null,this._tags.sort()}_finishNormalize(){for(const connection of this._connections)Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(connection),`Handle connection '${connection.name}' is not frozen.`);this._connections.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareComparables),Object.freeze(this)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareStrings)(this._id,other._id))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareStrings)(this._localName,other._localName))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareArrays)(this._tags,other._tags,_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareStrings))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareStrings)(this.fate,other.fate))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_3__.compareStrings)(this._immediateValue&&this._immediateValue.toString()||"",other._immediateValue&&other._immediateValue.toString()||""))?cmp:0}get fate(){return this._fate||"?"}set fate(fate){null==this._originalFate&&(this._originalFate=this._fate),this._fate=fate}get originalFate(){return this._originalFate||"?"}get originalId(){return this._originalId}get recipe(){return this._recipe}get tags(){return this._tags}set tags(tags){this._tags=tags}get type(){return this._type}get id(){return this._id}set id(id){this._originalId||(this._originalId=this._id),this._id=id}mapToStorage(storage){if(!storage)throw new Error("Cannot map to undefined storage");this._id=storage.id,this._originalId=storage.originalId,this._type=void 0,this._mappedType=storage.type,this._storageKey=storage.storageKey}get localName(){return this._localName}set localName(name){this._localName=name}get connections(){return this._connections}get storageKey(){return this._storageKey}set storageKey(key){this._storageKey=key}get pattern(){return this._pattern}set pattern(pattern){this._pattern=pattern}get mappedType(){return this._mappedType}set mappedType(mappedType){this._mappedType=mappedType}get immediateValue(){return this._immediateValue}set immediateValue(value){this._immediateValue=value}static effectiveType(handleType,connections){const variableMap=new Map,typeSet=connections.filter(connection=>null!=connection.type).map(connection=>({type:connection.type._cloneWithResolutions(variableMap),direction:connection.direction}));return _type_checker_js__WEBPACK_IMPORTED_MODULE_2__.TypeChecker.processTypeList(handleType?handleType._cloneWithResolutions(variableMap):null,typeSet)}static resolveEffectiveType(handleType,connections){const typeSet=connections.filter(connection=>null!=connection.type).map(connection=>({type:connection.type,direction:connection.direction}));return _type_checker_js__WEBPACK_IMPORTED_MODULE_2__.TypeChecker.processTypeList(handleType,typeSet)}_isValid(options){const tags=new Set;for(const connection of this._connections){if("map"===this.fate&&["out","inout"].includes(connection.direction))return options&&options.errors&&options.errors.set(this,`Invalid fate '${this.fate}' for handle '${this}'; it is used for '${connection.direction}' ${connection.getQualifiedName()} connection`),!1;connection.tags.forEach(tag=>tags.add(tag))}const type=Handle.resolveEffectiveType(this._mappedType,this._connections);return type?(this._type=type,this._tags.forEach(tag=>tags.add(tag)),this._tags=[...tags],!0):(options&&options.errors&&options.errors.set(this,`Type validations failed for handle '${this}'`),!1)}isResolved(options){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this));let resolved=!0;if(this.type){let mustBeResolved=!0;"create"!==this.fate&&"`slot"!==this.fate||(mustBeResolved=!1),(mustBeResolved&&!this.type.isResolved()||!this.type.canEnsureResolved())&&(options&&options.details.push("unresolved type"),resolved=!1)}else options&&options.details.push("missing type"),resolved=!1;switch(this.fate){case"?":options&&options.details.push("missing fate"),resolved=!1;break;case"copy":case"map":case"use":options&&null===this.id&&options.details.push("missing id"),resolved=resolved&&null!==this.id;break;case"`slot":case"create":break;default:throw options&&options.details.push(`invalid fate ${this.fate}`),new Error(`Unexpected fate: ${this.fate}`)}return resolved}toString(nameMap,options){if(this._immediateValue)return;options=options||{};const result=[];if(result.push(this.fate),this.id&&result.push(`'${this.id}'`),result.push(...this.tags.map(a=>`#${a}`)),result.push(`as ${nameMap&&nameMap.get(this)||this.localName}`),this.type)if(result.push("//"),this.type.isResolved())result.push(this.type.resolvedType().toString({hideFields:null==options.hideFields||options.hideFields}));else if(result.push(this.type.toString()),options.showUnresolved&&this.type.canEnsureResolved()){const type=_type_js__WEBPACK_IMPORTED_MODULE_1__.Type.fromLiteral(this.type.toLiteral());type.maybeEnsureResolved(),result.push("//"),result.push(type.resolvedType().toString({hideFields:null==options.hideFields||options.hideFields}))}if(options.showUnresolved){const unresolvedOptions={details:[]};this.isResolved(unresolvedOptions)||result.push(` // unresolved handle: ${unresolvedOptions.details.join(", ")}`)}return result.join(" ")}findConnectionByDirection(dir){return this._connections.find(conn=>conn.direction===dir)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"RecipeUtil",function(){return RecipeUtil});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_type_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(18),_recipe_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(48);class Shape{constructor(recipe,particles,handles,hcs){this.recipe=recipe,this.particles=particles,this.handles=handles,this.reverse=new Map;for(const p of Object.keys(particles))this.reverse.set(particles[p],p);for(const h of handles.keys())this.reverse.set(handles.get(h),h);for(const hc of Object.keys(hcs))this.reverse.set(hcs[hc],hc)}}class RecipeUtil{static makeShape(particles,handles,map,recipe){recipe=recipe||new _recipe_js__WEBPACK_IMPORTED_MODULE_2__.Recipe;const pMap={},hMap=new Map,hcMap={};return particles.forEach(particle=>pMap[particle]=recipe.newParticle(particle)),handles.forEach(handle=>hMap.set(handle,recipe.newHandle())),Object.keys(map).forEach(key=>{Object.keys(map[key]).forEach(name=>{const handle=map[key][name];let direction="=";handle.direction&&(direction={"->":"out","<-":"in","=":"="}[handle.direction]);const tags=handle.tags||[];handle.localName&&(hMap.get(handle.handle).localName=handle.localName);const connection=pMap[key].addConnectionName(name);connection.direction=direction,hMap.get(handle.handle).tags=tags,connection.connectToHandle(hMap.get(handle.handle)),hcMap[key+":"+name]=pMap[key].connections[name]})}),new Shape(recipe,pMap,hMap,hcMap)}static recipeToShape(recipe){const particles={};let id=0;recipe.particles.forEach(particle=>particles[particle.name]=particle);const handles=new Map;recipe.handles.forEach(handle=>handles.set("h"+id++,handle));const hcs={};return recipe.handleConnections.forEach(hc=>hcs[hc.particle.name+":"+hc.name]=hc),new Shape(recipe,particles,handles,hcs)}static find(recipe,shape){function _buildNewHCMatches(recipe,shapeHC,match,outputList){const{forward:forward,reverse:reverse,score:score}=match;let matchFound=!1;for(const recipeParticle of recipe.particles)if(recipeParticle.spec)for(const recipeConnSpec of recipeParticle.spec.handleConnections){if(reverse.has(recipeConnSpec))continue;if(recipeParticle.name!==shapeHC.particle.name)continue;if(shapeHC.name&&shapeHC.name!==recipeConnSpec.name)continue;const acceptedDirections={in:["in","inout"],out:["out","inout"],"=":["in","out","inout"],inout:["inout"],host:["host"],"`consume":["consume"],"`provide":["provide"]};if(recipeConnSpec.direction&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.keys(acceptedDirections).includes(shapeHC.direction),`${shapeHC.direction} not in ${Object.keys(acceptedDirections)}`),!acceptedDirections[shapeHC.direction].includes(recipeConnSpec.direction)))continue;const recipeHC=recipeParticle.connections[recipeConnSpec.name];if(shapeHC.handle&&recipeHC&&recipeHC.handle&&shapeHC.handle.localName&&shapeHC.handle.localName!==recipeHC.handle.localName)continue;if(reverse.has(recipeParticle)){if(reverse.get(recipeParticle)!==shapeHC.particle)continue}else if(forward.has(shapeHC.particle))continue;if(shapeHC.handle&&recipeHC&&recipeHC.handle){if(reverse.has(recipeHC.handle)){if(reverse.get(recipeHC.handle)!==shapeHC.handle)continue}else if(forward.has(shapeHC.handle)&&null!==forward.get(shapeHC.handle))continue;if("create"!==shapeHC.handle.fate||"create"!==recipeHC.handle.fate&&"create"!==recipeHC.handle.originalFate){if(Boolean(shapeHC.handle.immediateValue)!==Boolean(recipeHC.handle.immediateValue))continue;if(recipeHC.handle.immediateValue){if(!recipeHC.handle.immediateValue.equals(shapeHC.handle.immediateValue))continue}else if(shapeHC.handle.id!==recipeHC.handle.id&&shapeHC.handle.id!==recipeHC.handle.originalId)continue}}const newMatch={forward:new Map(forward),reverse:new Map(reverse),score:score};Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.reverse.has(recipeParticle)||newMatch.reverse.get(recipeParticle)===shapeHC.particle),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.forward.has(shapeHC.particle)||newMatch.forward.get(shapeHC.particle)===recipeParticle),newMatch.forward.set(shapeHC.particle,recipeParticle),newMatch.reverse.set(recipeParticle,shapeHC.particle),shapeHC.handle&&(recipeHC&&recipeHC.handle?(newMatch.forward.set(shapeHC.handle,recipeHC.handle),newMatch.reverse.set(recipeHC.handle,shapeHC.handle)):newMatch.forward.has(shapeHC.handle)||(newMatch.forward.set(shapeHC.handle,null),newMatch.score-=2)),newMatch.forward.set(shapeHC,recipeConnSpec),newMatch.reverse.set(recipeConnSpec,shapeHC),outputList.push(newMatch),matchFound=!0}if(!1===matchFound){if(match.forward.get(shapeHC.particle))return;const newMatches=[];_buildNewParticleMatches(recipe,shapeHC.particle,match,newMatches),newMatches.forEach(newMatch=>{shapeHC.handle&&!newMatch.forward.has(shapeHC.handle)&&(newMatch.forward.set(shapeHC.handle,null),newMatch.score-=2),newMatch.forward.set(shapeHC,null),newMatch.score-=1,outputList.push(newMatch)})}}function _buildNewParticleMatches(recipe,shapeParticle,match,newMatches){const{forward:forward,reverse:reverse,score:score}=match;let matchFound=!1;for(const recipeParticle of recipe.particles){if(reverse.has(recipeParticle))continue;if(recipeParticle.name!==shapeParticle.name)continue;let handleNamesMatch=!0;for(const connectionName of Object.keys(recipeParticle.connections)){const recipeConnection=recipeParticle.connections[connectionName];if(!recipeConnection.handle)continue;const shapeConnection=shapeParticle.connections[connectionName];if(shapeConnection&&shapeConnection.handle&&shapeConnection.handle.localName&&shapeConnection.handle.localName!==recipeConnection.handle.localName){handleNamesMatch=!1;break}}if(!handleNamesMatch)continue;const newMatch={forward:new Map(forward),reverse:new Map(reverse),score:score};Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.forward.has(shapeParticle)||newMatch.forward.get(shapeParticle)===recipeParticle),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.reverse.has(recipeParticle)||newMatch.reverse.get(recipeParticle)===shapeParticle),newMatch.forward.set(shapeParticle,recipeParticle),newMatch.reverse.set(recipeParticle,shapeParticle),newMatches.push(newMatch),matchFound=!0}if(!1===matchFound){const newMatch={forward:new Map,reverse:new Map,score:0};forward.forEach((value,key)=>{Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.forward.has(key)||newMatch.forward.get(key)===value),newMatch.forward.set(key,value)}),reverse.forEach((value,key)=>{Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!newMatch.reverse.has(key)||newMatch.reverse.get(key)===value),newMatch.reverse.set(key,value)}),newMatch.forward.has(shapeParticle)||(newMatch.forward.set(shapeParticle,null),newMatch.score=match.score-1),newMatches.push(newMatch)}}function _assignHandlesToEmptyPosition(match,emptyHandles,nullHandles){if(1===emptyHandles.length){const matches=[],{forward:forward,reverse:reverse,score:score}=match;for(const nullHandle of nullHandles){let tagsMatch=!0;for(const tag of nullHandle.tags)if(!emptyHandles[0].tags.includes(tag)){tagsMatch=!1;break}if(!tagsMatch)continue;const newMatch={forward:new Map(forward),reverse:new Map(reverse),score:score+1};newMatch.forward.set(nullHandle,emptyHandles[0]),newMatch.reverse.set(emptyHandles[0],nullHandle),matches.push(newMatch)}return matches}const thisHandle=emptyHandles.pop(),matches=_assignHandlesToEmptyPosition(match,emptyHandles,nullHandles);let newMatches=[];for(const match of matches){const nullHandles=[...shape.handles.values()].filter(handle=>null===match.forward.get(handle));nullHandles.length>0?newMatches=newMatches.concat(_assignHandlesToEmptyPosition(match,[thisHandle],nullHandles)):newMatches.concat(match)}return newMatches}let matches=[{forward:new Map,reverse:new Map,score:0}];for(const shapeHC of shape.recipe.handleConnections){const newMatches=[];for(const match of matches)_buildNewHCMatches(recipe,shapeHC,match,newMatches);matches=newMatches}for(const shapeParticle of shape.recipe.particles){if(Object.keys(shapeParticle.connections).length>0)continue;if(shapeParticle.unnamedConnections.length>0)continue;const newMatches=[];for(const match of matches)_buildNewParticleMatches(recipe,shapeParticle,match,newMatches);matches=newMatches}const emptyHandles=recipe.handles.filter(handle=>0===handle.connections.length);if(emptyHandles.length>0){let newMatches=[];for(const match of matches){const nullHandles=[...shape.handles.values()].filter(handle=>null===match.forward.get(handle));newMatches=nullHandles.length>0?newMatches.concat(_assignHandlesToEmptyPosition(match,emptyHandles,nullHandles)):newMatches.concat(match)}matches=newMatches}return matches.map(({forward:forward,score:score})=>{const match={};return forward.forEach((value,key)=>match[shape.reverse.get(key)]=value),{match:match,score:score}})}static constructImmediateValueHandle(connection,particleSpec,id){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(connection.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.InterfaceType),!(connection.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_1__.InterfaceType&&connection.type.interfaceInfo.restrictType(particleSpec)))return null;const handleType=connection.type.clone(new Map);handleType.maybeEnsureResolved();const handle=connection.recipe.newHandle();return handle.id=id.toString(),handle.mappedType=handleType,handle.fate="copy",handle.immediateValue=particleSpec,handle}static directionCounts(handle){const counts={in:0,out:0,inout:0,unknown:0};for(const connection of handle.connections){let direction=connection.direction;void 0===counts[direction]&&(direction="unknown"),counts[direction]++}return counts.in+=counts.inout,counts.out+=counts.inout,counts}static matchesRecipe(recipe,otherRecipe){const shape=RecipeUtil.recipeToShape(otherRecipe);return RecipeUtil.find(recipe,shape).some(r=>0===r.score)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Recipe",function(){return Recipe}),__webpack_require__.d(__webpack_exports__,"RequireSection",function(){return RequireSection});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_digest_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(43),_modality_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(28),_type_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(18),_connection_constraint_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(45),_handle_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(46),_particle_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(49),_type_checker_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(20),_search_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(52),_slot_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(53),_comparable_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(37);class Recipe{constructor(name){this._requires=[],this._particles=[],this._handles=[],this._slots=[],this._localName=void 0,this.annotation=void 0,this._connectionConstraints=[],this._obligations=[],this._verbs=[],this._search=null,this._patterns=[],this._name=name}newConnectionConstraint(from,to,direction){const result=new _connection_constraint_js__WEBPACK_IMPORTED_MODULE_4__.ConnectionConstraint(from,to,direction,"constraint");return this._connectionConstraints.push(result),result}newObligation(from,to,direction){const result=new _connection_constraint_js__WEBPACK_IMPORTED_MODULE_4__.ConnectionConstraint(from,to,direction,"obligation");return this._obligations.push(result),result}removeObligation(obligation){const idx=this._obligations.indexOf(obligation);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>-1),this._obligations.splice(idx,1)}removeConstraint(constraint){const idx=this._connectionConstraints.indexOf(constraint);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>=0),this._connectionConstraints.splice(idx,1)}clearConnectionConstraints(){this._connectionConstraints.length=0}newRequireSection(){const require=new RequireSection(this);return this._requires.push(require),require}newParticle(name){const particle=new _particle_js__WEBPACK_IMPORTED_MODULE_6__.Particle(this,name);return this._particles.push(particle),particle}removeParticle(particle){const idx=this._particles.indexOf(particle);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>-1),this._particles.splice(idx,1);for(const slotConnection of Object.values(particle._consumedSlotConnections))slotConnection.remove()}newHandle(){const handle=new _handle_js__WEBPACK_IMPORTED_MODULE_5__.Handle(this);return this._handles.push(handle),handle}removeHandle(handle){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(0===handle.connections.length);const idx=this._handles.indexOf(handle);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>-1),this._handles.splice(idx,1)}newSlot(name){const slot=new _slot_js__WEBPACK_IMPORTED_MODULE_9__.Slot(this,name);return this._slots.push(slot),slot}addSlot(slot){-1===this.slots.indexOf(slot)&&this.slots.push(slot)}removeSlot(slot){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(0===slot.consumeConnections.length);let idx=this._slots.indexOf(slot);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>-1),this._slots.splice(idx,1);for(const requires of this.requires)-1!==(idx=requires.slots.indexOf(slot))&&requires.slots.splice(idx,1)}isResolved(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this),"Recipe must be normalized to be resolved."),!(this._obligations.length>0)&&(0===this._connectionConstraints.length&&this.requires.every(require=>require.isEmpty())&&(null===this._search||this._search.isResolved())&&this._handles.every(handle=>handle.isResolved())&&this._particles.every(particle=>particle.isResolved())&&this.modality.isResolved()&&this.allRequiredSlotsPresent()&&this._slots.every(slot=>slot.isResolved())&&this.handleConnections.every(connection=>connection.isResolved())&&this.slotConnections.every(slotConnection=>slotConnection.isResolved()))}isCompatible(modality){return this.particles.every(p=>!p.spec||p.spec.isCompatible(modality))}get modality(){return this.particles.filter(p=>Boolean(p.spec&&p.spec.slotConnections.size>0)).map(p=>p.spec.modality).reduce((modality,total)=>modality.intersection(total),_modality_js__WEBPACK_IMPORTED_MODULE_2__.Modality.all)}allRequiredSlotsPresent(){for(const particle of this.particles){if(0===particle.spec.slotConnections.size)continue;let atLeastOneSlotConnection=!1;for(const[name,slotSpec]of particle.spec.slotConnections){if(slotSpec.isRequired&&!particle.consumedSlotConnections[name])return!1;if(particle.consumedSlotConnections[name])for(const providedSlotSpec of slotSpec.provideSlotConnections)if(providedSlotSpec.isRequired&&!particle.getProvidedSlotByName(name,providedSlotSpec.name))return!1;particle.consumedSlotConnections[name]&&(atLeastOneSlotConnection=!0)}if(!atLeastOneSlotConnection)return!1}return!0}_findDuplicate(items,options){const seenHandles=new Set,duplicateHandle=items.find(handle=>{if(handle.id){if(seenHandles.has(handle.id))return handle;seenHandles.add(handle.id)}});return duplicateHandle&&options&&options.errors&&options.errors.set(duplicateHandle,`Has Duplicate ${duplicateHandle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_5__.Handle?"Handle":"Slot"} '${duplicateHandle.id}'`),duplicateHandle}_isValid(options){return!this._findDuplicate(this._handles,options)&&!this._findDuplicate(this._slots,options)&&this._handles.every(handle=>handle._isValid(options))&&this._particles.every(particle=>particle._isValid(options))&&this._slots.every(slot=>slot._isValid(options))&&this.handleConnections.every(connection=>connection._isValid(options))&&this.slotConnections.every(connection=>connection._isValid(options))&&(!this.search||this.search.isValid())}get requires(){return this._requires}get name(){return this._name}set name(name){this._name=name}get localName(){return this._localName}set localName(name){this._localName=name}get particles(){return this._particles}set particles(particles){this._particles=particles}get handles(){return this._handles}set handles(handles){this._handles=handles}get slots(){return this._slots}set slots(slots){this._slots=slots}get connectionConstraints(){return this._connectionConstraints}get obligations(){return this._obligations}get verbs(){return this._verbs}set verbs(verbs){this._verbs=verbs}get search(){return this._search}set search(search){this._search=search}setSearchPhrase(phrase){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._search,"Cannot override search phrase"),phrase&&(this._search=new _search_js__WEBPACK_IMPORTED_MODULE_8__.Search(phrase))}get slotConnections(){const slotConnections=[];return this._particles.forEach(particle=>{slotConnections.push(...Object.values(particle.consumedSlotConnections))}),slotConnections}get handleConnections(){const handleConnections=[];return this._particles.forEach(particle=>{handleConnections.push(...Object.values(particle.connections)),handleConnections.push(...particle._unnamedConnections)}),handleConnections}isEmpty(){return 0===this.particles.length&&0===this.handles.length&&0===this.slots.length&&0===this._connectionConstraints.length}findHandle(id){for(const handle of this.handles)if(handle.id===id)return handle;return null}findSlot(id){for(const slot of this.slots)if(slot.id===id)return slot;return null}get patterns(){return this._patterns}set patterns(patterns){this._patterns=patterns}set description(description){const pattern=description.find(desc=>"pattern"===desc.name);pattern&&pattern.patterns.forEach(pattern=>this._patterns.push(pattern)),description.forEach(desc=>{if("pattern"!==desc.name){const handle=this.handles.find(handle=>handle.localName===desc.name);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handle,`Cannot set description pattern for nonexistent handle ${desc.name}.`),handle.pattern=desc.pattern}})}async digest(){return Object(_platform_digest_web_js__WEBPACK_IMPORTED_MODULE_1__.digest)(this.toString())}normalize(options){if(Object.isFrozen(this))return options&&options.errors&&options.errors.set(this,"already normalized"),!1;if(!this._isValid()){this._findDuplicate(this._handles,options),this._findDuplicate(this._slots,options);const checkForInvalid=list=>list.forEach(item=>!item._isValid(options));return checkForInvalid(this._handles),checkForInvalid(this._particles),checkForInvalid(this._slots),checkForInvalid(this.handleConnections),checkForInvalid(this.slotConnections),!1}for(const particle of this._particles)particle._startNormalize();for(const handle of this._handles)handle._startNormalize();for(const slot of this._slots)slot._startNormalize();const connections=this.handleConnections;for(const connection of connections)connection._normalize();connections.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables);const slotConnections=this.slotConnections;for(const slotConnection of slotConnections)slotConnection._normalize();slotConnections.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables),this.search&&this.search._normalize();for(const require of this.requires)require.normalize();for(const particle of this._particles)particle._finishNormalize();for(const handle of this._handles)handle._finishNormalize();for(const slot of this._slots)slot._finishNormalize();const seenHandles=new Set,seenParticles=new Set,seenSlots=new Set,particles=[],handles=[],slots=[];let ordered=connections.filter(c=>!(c.type&&c.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_3__.InterfaceType));ordered=ordered.concat(connections.filter(c=>!!c.type&&!!(c.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_3__.InterfaceType)));for(const connection of ordered)seenParticles.has(connection.particle)||(particles.push(connection.particle),seenParticles.add(connection.particle)),connection.handle&&!seenHandles.has(connection.handle)&&(handles.push(connection.handle),seenHandles.add(connection.handle));for(const slotConnection of slotConnections)slotConnection.targetSlot&&!seenSlots.has(slotConnection.targetSlot)&&(slots.push(slotConnection.targetSlot),seenSlots.add(slotConnection.targetSlot)),Object.values(slotConnection.providedSlots).forEach(ps=>{seenSlots.has(ps)||(slots.push(ps),seenSlots.add(ps))});const orphanedHandles=this._handles.filter(handle=>!seenHandles.has(handle));orphanedHandles.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables),handles.push(...orphanedHandles);const orphanedParticles=this._particles.filter(particle=>!seenParticles.has(particle));orphanedParticles.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables),particles.push(...orphanedParticles);const orphanedSlots=this._slots.filter(slot=>!seenSlots.has(slot));return orphanedSlots.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables),slots.push(...orphanedSlots),this._particles=particles,this._handles=handles,this._slots=slots,this._connectionConstraints.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_10__.compareComparables),this._verbs.sort(),this._patterns.sort(),Object.freeze(this._particles),Object.freeze(this._handles),Object.freeze(this._slots),Object.freeze(this._connectionConstraints),Object.freeze(this),!0}clone(map){const recipe=new Recipe(this.name);return null==map&&(map=new Map),this._copyInto(recipe,map),recipe._cloneMap=map,recipe}mergeInto(recipe){const cloneMap=new Map,numHandles=recipe._handles.length,numParticles=recipe._particles.length,numSlots=recipe._slots.length;return this._copyInto(recipe,cloneMap),{handles:recipe._handles.slice(numHandles),particles:recipe._particles.slice(numParticles),slots:recipe._slots.slice(numSlots),cloneMap:cloneMap}}_copyInto(recipe,cloneMap){const variableMap=new Map;function cloneTheThing(object){const clonedObject=object._copyInto(recipe,cloneMap,variableMap);cloneMap.set(object,clonedObject)}recipe._name=this.name,recipe._verbs=recipe._verbs.concat(...this._verbs),this._handles.forEach(cloneTheThing),this._particles.forEach(cloneTheThing),this._slots.forEach(cloneTheThing),this._connectionConstraints.forEach(cloneTheThing),this._obligations.forEach(cloneTheThing),recipe.verbs=recipe.verbs.slice(),this.search&&this.search._copyInto(recipe);for(const require of this.requires){const newRequires=recipe.newRequireSection();require._copyInto(newRequires,cloneMap),newRequires._cloneMap=cloneMap}recipe.patterns=recipe.patterns.concat(this.patterns)}updateToClone(dict){const result={};return Object.keys(dict).forEach(key=>result[key]=this._cloneMap.get(dict[key])),result}_makeLocalNameMap(){const names=new Set;for(const particle of this.particles)names.add(particle.localName);for(const handle of this.handles)names.add(handle.localName);for(const slot of this.slots)names.add(slot.localName);const nameMap=new Map;let i=0;for(const particle of this.particles){let localName=particle.localName;if(!localName)do{localName=`particle${i++}`}while(names.has(localName));nameMap.set(particle,localName)}i=0;for(const handle of this.handles){let localName=handle.localName;if(!localName)do{localName=`handle${i++}`}while(names.has(localName));nameMap.set(handle,localName)}i=0;for(const slot of this.slots){let localName=slot.localName;if(!localName)do{localName=`slot${i++}`}while(names.has(localName));nameMap.set(slot,localName)}return nameMap}toString(options){const nameMap=this._makeLocalNameMap(),result=[],verbs=this.verbs.length>0?` ${this.verbs.map(verb=>`&${verb}`).join(" ")}`:"";result.push(`recipe${this.name?` ${this.name}`:""}${verbs}`),options&&options.showUnresolved&&this.search&&result.push(this.search.toString(options).replace(/^|(\n)/g,"$1  "));for(const constraint of this._connectionConstraints){let constraintStr=constraint.toString().replace(/^|(\n)/g,"$1  ");options&&options.showUnresolved&&(constraintStr=constraintStr.concat(" // unresolved connection-constraint")),result.push(constraintStr)}result.push(...this.handles.map(h=>h.toString(nameMap,options)).filter(strValue=>strValue).map(strValue=>strValue.replace(/^|(\n)/g,"$1  ")));for(const slot of this.slots){const slotString=slot.toString(nameMap,options);slotString&&result.push(slotString.replace(/^|(\n)/g,"$1  "))}for(const require of this.requires)require.isEmpty()||result.push(require.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));for(const particle of this.particles)result.push(particle.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));if(this.patterns.length>0||this.handles.find(h=>void 0!==h.pattern)){result.push(`  description \`${this.patterns[0]}\``);for(let i=1;i<this.patterns.length;++i)result.push(`    pattern \`${this.patterns[i]}\``);this.handles.forEach(h=>{h.pattern&&result.push(`    ${h.localName} \`${h.pattern}\``)})}if(this._obligations.length>0){result.push("  obligations");for(const obligation of this._obligations){const obligationStr=obligation.toString(nameMap,options).replace(/^|(\n)/g,"$1    ");result.push(obligationStr)}}return result.join("\n")}getFreeHandles(){return this.handles.filter(handle=>0===handle.connections.length)}get allSpecifiedConnections(){return[].concat(...this.particles.filter(p=>p.spec&&p.spec.connections).map(particle=>particle.spec.connections.map(connSpec=>({particle:particle,connSpec:connSpec}))))}getFreeConnections(type){return this.allSpecifiedConnections.filter(({particle:particle,connSpec:connSpec})=>!connSpec.isOptional&&"descriptions"!==connSpec.name&&"host"!==connSpec.direction&&!particle.connections[connSpec.name]&&(!type||_type_checker_js__WEBPACK_IMPORTED_MODULE_7__.TypeChecker.compareTypes({type:type},{type:connSpec.type})))}findHandleByID(id){return this.handles.find(handle=>handle.id===id)}getUnnamedUntypedConnections(){return this.handleConnections.find(hc=>!hc.type||!hc.name||hc.isOptional)}getParticlesByImplFile(files){return this.particles.filter(particle=>particle.spec&&files.has(particle.spec.implFile))}findSlotByID(id){let slot=this.slots.find(s=>s.id===id);if(null==slot)if(this instanceof RequireSection)slot=this.parent.slots.find(s=>s.id===id);else for(const require of this.requires)if(void 0!==(slot=require.slots.find(s=>s.id===id)))break;return slot}}class RequireSection extends Recipe{constructor(parent,name){super(name),this.parent=parent}toString(nameMap,options){null==nameMap&&(nameMap=this._makeLocalNameMap());const result=[];result.push("require"),options&&options.showUnresolved&&this.search&&result.push(this.search.toString(options).replace(/^|(\n)/g,"$1  "));for(const constraint of this.connectionConstraints){let constraintStr=constraint.toString().replace(/^|(\n)/g,"$1  ");options&&options.showUnresolved&&(constraintStr=constraintStr.concat(" // unresolved connection-constraint")),result.push(constraintStr)}result.push(...this.handles.map(h=>h.toString(nameMap,options)).filter(strValue=>strValue).map(strValue=>strValue.replace(/^|(\n)/g,"$1  ")));for(const slot of this.slots){const slotString=slot.toString(nameMap,options);slotString&&result.push(slotString.replace(/^|(\n)/g,"$1  "))}for(const particle of this.particles)result.push(particle.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));if(this.patterns.length>0||this.handles.find(h=>void 0!==h.pattern)){result.push(`  description \`${this.patterns[0]}\``);for(let i=1;i<this.patterns.length;++i)result.push(`    pattern \`${this.patterns[i]}\``);this.handles.forEach(h=>{h.pattern&&result.push(`    ${h.localName} \`${h.pattern}\``)})}if(this.obligations.length>0){result.push("  obligations");for(const obligation of this.obligations){const obligationStr=obligation.toString(nameMap,options).replace(/^|(\n)/g,"$1    ");result.push(obligationStr)}}return result.join("\n")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Particle",function(){return Particle});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_handle_connection_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(50),_recipe_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(48),_type_checker_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(20),_slot_connection_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(51),_comparable_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(37);class Particle{constructor(recipe,name){this._id=void 0,this._localName=void 0,this.spec=void 0,this._verbs=[],this._tags=[],this._connections={},this._unnamedConnections=[],this._consumedSlotConnections={},Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe),this._recipe=recipe,this._name=name}_copyInto(recipe,cloneMap,variableMap){const particle=recipe.newParticle(this._name);particle._id=this._id,particle._verbs=[...this._verbs],particle._tags=[...this._tags],particle.spec=this.spec?this.spec.cloneWithResolutions(variableMap):void 0,Object.keys(this._connections).forEach(key=>{particle._connections[key]=this._connections[key]._clone(particle,cloneMap)}),particle._unnamedConnections=this._unnamedConnections.map(connection=>connection._clone(particle,cloneMap)),particle._cloneConnectionRawTypes(variableMap);for(const[key,slotConn]of Object.entries(this.consumedSlotConnections)){particle.consumedSlotConnections[key]=slotConn._clone(particle,cloneMap),cloneMap.has(slotConn.targetSlot)&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe instanceof _recipe_js__WEBPACK_IMPORTED_MODULE_2__.RequireSection),particle.consumedSlotConnections[key].connectToSlot(cloneMap.get(slotConn.targetSlot)),-1===particle.recipe.slots.indexOf(cloneMap.get(slotConn.targetSlot))&&particle.recipe.slots.push(cloneMap.get(slotConn.targetSlot)));for(const[name,slot]of Object.entries(slotConn.providedSlots))if(cloneMap.has(slot)){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe instanceof _recipe_js__WEBPACK_IMPORTED_MODULE_2__.RequireSection);const clonedSlot=cloneMap.get(slot);clonedSlot.sourceConnection=particle.consumedSlotConnections[key],particle.consumedSlotConnections[key].providedSlots[name]=clonedSlot,-1===particle.recipe.slots.indexOf(clonedSlot)&&particle.recipe.slots.push(clonedSlot)}}return particle}_cloneConnectionRawTypes(variableMap){for(const connection of Object.values(this._connections))connection.cloneTypeWithResolutions(variableMap);for(const connection of this._unnamedConnections)connection.cloneTypeWithResolutions(variableMap)}_startNormalize(){this._localName=null,this._verbs.sort(),this._tags.sort();const normalizedConnections={};for(const key of Object.keys(this._connections).sort())normalizedConnections[key]=this._connections[key];this._connections=normalizedConnections;const normalizedSlotConnections={};for(const key of Object.keys(this._consumedSlotConnections).sort())normalizedSlotConnections[key]=this._consumedSlotConnections[key];this._consumedSlotConnections=normalizedSlotConnections}_finishNormalize(){this._unnamedConnections.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareComparables),Object.freeze(this)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareStrings)(this._id?this._id.toString():"",other._id?other._id.toString():""))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareStrings)(this._name,other._name))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareStrings)(this._localName,other._localName))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareArrays)(this._verbs,other._verbs,_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareStrings))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareArrays)(this._tags,other._tags,_comparable_js__WEBPACK_IMPORTED_MODULE_5__.compareStrings))?cmp:0}matches(particle){if(this.name&&particle.name&&this.name!==particle.name)return!1;for(const[name,slotConn]of Object.entries(this.consumedSlotConnections)){if(null==particle.consumedSlotConnections[name]||null==particle.consumedSlotConnections[name].targetSlot)return!1;if(slotConn.targetSlot&&slotConn.targetSlot.id&&slotConn.targetSlot.id!==particle.consumedSlotConnections[name].targetSlot.id)return!1;for(const pname of Object.keys(slotConn.providedSlots)){const slot=slotConn.providedSlots[pname],pslot=particle.consumedSlotConnections[name].providedSlots[pname];if(null==pslot||slot.id&&pslot.id&&slot.id!==pslot.id)return!1}}return!0}_isValid(options){return!this.spec||(!(!this.name&&!this.primaryVerb)||(options&&options.errors&&options.errors.set(this,"Particle has no name and no verb"),!1))}isResolved(options){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this)),!this.spec)return options&&options.showUnresolved&&(options.details="missing spec"),!1;if(this.spec.slotConnections.size>0){if(0===Object.values(this.consumedSlotConnections).filter(connection=>void 0!==connection.targetSlot).length)return options&&options.showUnresolved&&(options.details="unfullfilled slot connections"),!1}if(!this.spec)return options&&options.showUnresolved&&(options.details="missing spec"),!1;const unresolvedRequiredConnections=this.getUnboundConnections().filter(connSpec=>{let parent=connSpec.parentConnection;for(;null!==parent;){if(!this.connections[parent.name])return!1;parent=parent.parentConnection}return!0});return unresolvedRequiredConnections.length>0?(options&&options.showUnresolved&&(options.details=`unresolved connections: ${unresolvedRequiredConnections.map(c=>c.name).join(", ")}`),!1):0===this.unnamedConnections.length||(options&&options.showUnresolved&&(options.details=`${this.unnamedConnections.length} unnamed connections`),!1)}get recipe(){return this._recipe}get localName(){return this._localName}set localName(name){this._localName=name}get id(){return this._id}set id(id){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._id,"Particle ID can only be set once."),this._id=id}get name(){return this._name}set name(name){this._name=name}get connections(){return this._connections}get unnamedConnections(){return this._unnamedConnections}get consumedSlotConnections(){return this._consumedSlotConnections}get primaryVerb(){return this._verbs.length>0?this._verbs[0]:void 0}set verbs(verbs){this._verbs=verbs}set tags(tags){this._tags=tags}addUnnamedConnection(){const connection=new _handle_connection_js__WEBPACK_IMPORTED_MODULE_1__.HandleConnection(void 0,this);return this._unnamedConnections.push(connection),connection}addConnectionName(name){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(name,"Cannot create connection with no name"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null==this._connections[name]),this._connections[name]=new _handle_connection_js__WEBPACK_IMPORTED_MODULE_1__.HandleConnection(name,this),this._connections[name]}allConnections(){return Object.values(this._connections).concat(this._unnamedConnections)}ensureConnectionName(name){return this._connections[name]||this.addConnectionName(name)}getConnectionByName(name){return this._connections[name]}nameConnection(connection,name){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._connections[name],`Connection "${name}" already has a handle`);const idx=this._unnamedConnections.indexOf(connection);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>=0,`Cannot name '${name}' nonexistent unnamed connection.`),connection._name=name;const connectionSpec=this.spec.getConnectionByName(name);connection.type=connectionSpec.type,connection.direction!==connectionSpec.direction&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("inout"===connection.direction,`Unnamed connection cannot adjust direction ${connection.direction} to ${name}'s direction ${connectionSpec.direction}`),connection.direction=connectionSpec.direction),this._connections[name]=connection,this._unnamedConnections.splice(idx,1)}getUnboundConnections(type){return this.spec.handleConnections.filter(connSpec=>!connSpec.isOptional&&!this.getConnectionByName(connSpec.name)&&(!type||_type_checker_js__WEBPACK_IMPORTED_MODULE_3__.TypeChecker.compareTypes({type:type},{type:connSpec.type})))}addSlotConnection(name){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!(name in this._consumedSlotConnections),"slot connection already exists"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.spec||this.spec.slotConnections.has(name),"slot connection not in particle spec");const slotConn=new _slot_connection_js__WEBPACK_IMPORTED_MODULE_4__.SlotConnection(name,this);this._consumedSlotConnections[name]=slotConn;const slotSpec=this.getSlotSpecByName(name);return slotSpec&&slotSpec.provideSlotConnections.forEach(providedSlot=>{const slot=this.recipe.newSlot(providedSlot.name);slot.sourceConnection=slotConn,slotConn.providedSlots[providedSlot.name]=slot}),slotConn}addSlotConnectionAsCopy(name){const slotConn=new _slot_connection_js__WEBPACK_IMPORTED_MODULE_4__.SlotConnection(name,this);return this._consumedSlotConnections[name]=slotConn,slotConn}removeSlotConnection(slotConnection){this._consumedSlotConnections[slotConnection.name]=null,slotConnection.disconnectFromSlot()}remove(){this.recipe.removeParticle(this)}getSlotConnectionBySpec(spec){return Object.values(this._consumedSlotConnections).find(slotConn=>slotConn.getSlotSpec()===spec)}getSlotSpecByName(name){if(!this.spec)return;const slot=this.spec.slotConnections.get(name);if(slot)return slot;for(const slot of this.spec.slotConnections.values())for(const provided of slot.provideSlotConnections)if(provided.name===name)return provided}getSlotConnectionByName(name){return this._consumedSlotConnections[name]}getProvidedSlotByName(consumeName,name){return this.consumedSlotConnections[consumeName]&&this.consumedSlotConnections[consumeName].providedSlots[name]}getSlotSpecs(){return this.spec?this.spec.slotConnections:new Map}toString(nameMap,options){let result=[];this.name?(result.push(this.name),result.push(`as ${nameMap&&nameMap.get(this)||this.localName}`),this.primaryVerb&&this.primaryVerb!==this.name&&result.push(`// verb=${this.primaryVerb}`)):result.push(`&${this.primaryVerb}`),options&&options.showUnresolved&&(this.isResolved(options)||result.push(`// unresolved particle: ${options.details}`)),result=[result.join(" ")];for(const connection of this.unnamedConnections)result.push(connection.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));for(const connection of Object.values(this.connections))result.push(connection.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));for(const slotConnection of Object.values(this._consumedSlotConnections))result.push(slotConnection.toString(nameMap,options).replace(/^|(\n)/g,"$1  "));return result.join("\n")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"HandleConnection",function(){return HandleConnection});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_type_checker_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(20),_comparable_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(37);class HandleConnection{constructor(name,particle){this._tags=[],this.resolvedType=void 0,this._direction=void 0,this._handle=void 0,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particle),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particle.recipe),this._recipe=particle.recipe,this._name=name,this._particle=particle}_clone(particle,cloneMap){if(cloneMap.has(this))return cloneMap.get(this);const handleConnection=new HandleConnection(this._name,particle);return handleConnection._tags=[...this._tags],handleConnection.resolvedType=this.resolvedType,handleConnection._direction=this._direction,null!=this._handle&&(handleConnection._handle=cloneMap.get(this._handle),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==handleConnection._handle),handleConnection._handle.connections.push(handleConnection)),cloneMap.set(this,handleConnection),handleConnection}cloneTypeWithResolutions(variableMap){this.resolvedType&&(this.resolvedType=this.resolvedType._cloneWithResolutions(variableMap))}_normalize(){this._tags.sort(),Object.freeze(this)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareComparables)(this._particle,other._particle))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareStrings)(this._name,other._name))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareArrays)(this._tags,other._tags,_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareStrings))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareComparables)(this._handle,other._handle))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareStrings)(this._direction,other._direction))?cmp:0}get recipe(){return this._recipe}get name(){return this._name}getQualifiedName(){return`${this.particle.name}::${this.name}`}get tags(){return this._tags}get type(){if(this.resolvedType)return this.resolvedType;const spec=this.spec;return spec?spec.type:null}get direction(){if(this._direction)return this._direction;const spec=this.spec;return spec?spec.direction:null}get isInput(){return"in"===this.direction||"inout"===this.direction}get isOutput(){return"out"===this.direction||"inout"===this.direction}get handle(){return this._handle}get particle(){return this._particle}set tags(tags){this._tags=tags}set type(type){this.resolvedType=type,this._resetHandleType()}set direction(direction){this._direction=direction,this._resetHandleType()}get spec(){return null==this.particle.spec?null:this.particle.spec.handleConnectionMap.get(this.name)}get isOptional(){return null!=this.spec&&this.spec.isOptional}_isValid(options){if(this.direction&&!["in","out","inout","host","`consume","`provide"].includes(this.direction))return options&&options.errors&&options.errors.set(this,`Invalid direction '${this.direction}' for handle connection '${this.getQualifiedName()}'`),!1;if(this.particle.spec&&this.name){const connectionSpec=this.spec;if(!connectionSpec)return options&&options.errors&&options.errors.set(this,`Connection ${this.name} is not defined by ${this.particle.name}.`),!1;if(this.direction!==connectionSpec.direction&&(!["in","out"].includes(this.direction)||"inout"!==connectionSpec.direction))return options&&options.errors&&options.errors.set(this,`Direction '${this.direction}' for handle connection '${this.getQualifiedName()}' doesn't match particle spec's direction '${connectionSpec.direction}'`),!1;if(this.resolvedType){if(!connectionSpec.isCompatibleType(this.resolvedType))return options&&options.errors&&options.errors.set(this,`Type '${this.resolvedType.toString()} for handle connection '${this.getQualifiedName()}' doesn't match particle spec's type '${connectionSpec.type.toString()}'`),!1}else this.resolvedType=connectionSpec.type}return!0}isResolved(options){let parent;return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this)),!this.spec||!this.spec.parentConnection||(parent=this.particle.connections[this.spec.parentConnection.name])&&parent.handle?this.handle?this.direction?!!this.type||(options&&(options.details="missing type"),!1):(options&&(options.details="missing direction"),!1):!!this.isOptional||(options&&(options.details="missing handle"),!1):(options&&(options.details="parent connection missing handle"),!1)}_resetHandleType(){this._handle&&(this._handle._type=void 0)}connectToHandle(handle){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handle.recipe===this.recipe),this._handle=handle,this._resetHandleType(),this._handle.connections.push(this)}disconnectHandle(){const idx=this._handle.connections.indexOf(this);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>=0),this._handle.connections.splice(idx,1),this._handle=void 0}toString(nameMap,options){const result=[];return result.push(this.name||"*"),result.push({in:"<-",out:"->",inout:"=",host:"=","`consume":"<-","`provide":"->"}[this.direction]||this.direction||"="),this.handle&&(this.handle.immediateValue?result.push(this.handle.immediateValue.name):result.push(`${nameMap&&nameMap.get(this.handle)||this.handle.localName}`)),result.push(...this.tags.map(a=>`#${a}`)),options&&options.showUnresolved&&(this.isResolved(options)||result.push(`// unresolved handle-connection: ${options.details}`)),result.join(" ")}findSpecsForUnnamedHandles(){return this.particle.spec.handleConnections.filter(specConn=>!specConn.isOptional&&_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:this.handle.type},{type:specConn.type})&&!this.particle.getConnectionByName(specConn.name))}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotConnection",function(){return SlotConnection});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_recipe_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(48),_comparable_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(37);class SlotConnection{constructor(name,particle){this._targetSlot=void 0,this._providedSlots={},this._tags=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particle),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particle.recipe),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(name),this._recipe=particle.recipe,this._particle=particle,this._name=name}remove(){this._particle.removeSlotConnection(this)}get recipe(){return this._recipe}get particle(){return this._particle}get name(){return this._name}getQualifiedName(){return`${this.particle.name}::${this.name}`}get targetSlot(){return this._targetSlot}set targetSlot(targetSlot){this._targetSlot=targetSlot}get providedSlots(){return this._providedSlots}get tags(){return this._tags}set tags(tags){this._tags=tags}getSlotSpec(){return this.particle.spec&&this.particle.spec.getSlotSpec(this.name)}connectToSlot(targetSlot){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targetSlot),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.targetSlot),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.recipe instanceof _recipe_js__WEBPACK_IMPORTED_MODULE_1__.RequireSection||this.recipe===targetSlot.recipe,"Cannot connect to slot from different recipe"),this._targetSlot=targetSlot,targetSlot.consumeConnections.push(this)}disconnectFromSlot(){this._targetSlot&&(this._targetSlot.removeConsumeConnection(this),this._targetSlot=void 0)}_clone(particle,cloneMap){if(cloneMap.has(this))return cloneMap.get(this);const slotConnection=particle.addSlotConnectionAsCopy(this.name);return slotConnection.tags=this.tags,cloneMap.set(this,slotConnection),slotConnection}_normalize(){const normalizedSlots={};for(const key of Object.keys(this._providedSlots).sort())normalizedSlots[key]=this._providedSlots[key];this._providedSlots=normalizedSlots,Object.freeze(this)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareStrings)(this.name,other.name))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareComparables)(this._targetSlot,other._targetSlot))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_2__.compareComparables)(this._particle,other._particle))?cmp:0}_isValid(options){return!this._targetSlot||!this._targetSlot.sourceConnection||this._targetSlot===this._targetSlot.sourceConnection.providedSlots[this._targetSlot.name]||(options&&options.errors&&options.errors.set(this,`Invalid target slot '${this._targetSlot.name}' for slot connection '${this.name}' of particle ${this.particle.name}`),!1)}isResolved(options){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this)),this.name?this.particle?null!=this.getSlotSpec()&&!this.getSlotSpec().isRequired||this.targetSlot&&(this.targetSlot.id||this.targetSlot.sourceConnection.isConnected())?!this.targetSlot||(null==this.getSlotSpec()||this.getSlotSpec().provideSlotConnections.every(providedSlot=>!providedSlot.isRequired||0!==this.providedSlots[providedSlot.name].consumeConnections.length||(options&&(options.details="missing consuming slot"),!1))):(options&&(options.details="missing target-slot"),!1):(options&&(options.details="missing particle"),!1):(options&&(options.details="missing name"),!1)}isConnectedToInternalSlot(){return this.targetSlot&&!!this.targetSlot.sourceConnection}isConnectedToRemoteSlot(){return this.targetSlot&&!!this.targetSlot.id}isConnected(){return this.isConnectedToInternalSlot()||this.isConnectedToRemoteSlot()}toString(nameMap,options){const consumeRes=[];consumeRes.push("consume"),consumeRes.push(`${this.name}`),this.targetSlot&&consumeRes.push(`as ${nameMap&&nameMap.get(this.targetSlot)||this.targetSlot.localName}`),options&&options.showUnresolved&&(this.isResolved(options)||consumeRes.push(`// unresolved slot-connection: ${options.details}`));const result=[];return result.push(consumeRes.join(" ")),Object.keys(this.providedSlots).forEach(psName=>{const providedSlot=this.providedSlots[psName],provideRes=[];if(provideRes.push("  provide"),this.getSlotSpec()){const providedSlotSpec=this.particle.getSlotSpecByName(psName);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(providedSlotSpec,`Cannot find providedSlotSpec for ${psName}`)}provideRes.push(`${psName} as ${nameMap&&nameMap.get(providedSlot)||providedSlot}`),result.push(provideRes.join(" "))}),result.join("\n")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Search",function(){return Search});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);class Search{constructor(phrase,unresolvedTokens){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(phrase),this._phrase=phrase;const tokens=this.phrase.toLowerCase().split(/[^a-z0-9]/g);this._unresolvedTokens=[],(unresolvedTokens||tokens).forEach(token=>this._unresolvedTokens.push(token)),this._resolvedTokens=tokens.slice();for(const token of this.unresolvedTokens){const index=this._resolvedTokens.indexOf(token);index>=0&&this._resolvedTokens.splice(index,1)}Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(tokens.length===this.unresolvedTokens.length+this.resolvedTokens.length)}_append(phrase,unresolvedTokens,resolvedTokens){this._phrase.length>0&&(this._phrase=this.phrase.concat(" ")),this._phrase=this._phrase.concat(phrase),resolvedTokens.forEach(t=>this._resolvedTokens.push(t)),unresolvedTokens.forEach(t=>this._unresolvedTokens.push(t))}get phrase(){return this._phrase}get unresolvedTokens(){return this._unresolvedTokens}get resolvedTokens(){return this._resolvedTokens}resolveToken(token){const index=this.unresolvedTokens.indexOf(token.toLowerCase());Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(index>=0,`Cannot resolved nonexistent token ${token}`),this._unresolvedTokens.splice(index,1),this._resolvedTokens.push(token.toLowerCase())}isValid(){return this._unresolvedTokens.length>0||this._resolvedTokens.length>0}isResolved(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this)),this._resolvedTokens.length>0}_normalize(){this._unresolvedTokens.sort(),this._resolvedTokens.sort(),Object.freeze(this)}_copyInto(recipe){return recipe.search?recipe.search._append(this.phrase,this.unresolvedTokens,this.resolvedTokens):(recipe.search=new Search(this.phrase,this.unresolvedTokens),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.search.resolvedTokens.length===this.resolvedTokens.length,`${recipe.search.resolvedTokens} is not same as ${this.resolvedTokens}`)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.resolvedTokens.every(rt=>recipe.search.resolvedTokens.indexOf(rt)>=0)&&this.unresolvedTokens.every(rt=>recipe.search.unresolvedTokens.indexOf(rt)>=0)),recipe.search}toString(options){const result=[];result.push(`search \`${this.phrase}\``);const tokenStr=[];return tokenStr.push("  tokens"),this.unresolvedTokens.length>0&&tokenStr.push(this.unresolvedTokens.map(t=>`\`${t}\``).join(" ")),this.resolvedTokens.length>0&&tokenStr.push(`// ${this.resolvedTokens.map(t=>`\`${t}\``).join(" ")}`),options&&options.showUnresolved&&this.unresolvedTokens.length>0&&tokenStr.push("// unresolved search tokens"),result.push(tokenStr.join(" ")),result.join("\n")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Slot",function(){return Slot});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_comparable_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(37);class Slot{constructor(recipe,name){this._id=void 0,this._localName=void 0,this._tags=[],this._sourceConnection=void 0,this._formFactor=void 0,this._consumeConnections=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe),this._recipe=recipe,this._name=name}get recipe(){return this._recipe}get id(){return this._id}set id(id){this._id=id}get localName(){return this._localName}set localName(localName){this._localName=localName}get name(){return this._name}set name(name){this._name=name}get tags(){return this._tags}set tags(tags){this._tags=tags}get formFactor(){return this._formFactor}set formFactor(formFactor){this._formFactor=formFactor}get sourceConnection(){return this._sourceConnection}set sourceConnection(sourceConnection){this._sourceConnection=sourceConnection}get consumeConnections(){return this._consumeConnections}get spec(){return this.sourceConnection&&this.sourceConnection.getSlotSpec()?this.sourceConnection.particle.getSlotSpecByName(this.name):{isSet:!1,tags:[]}}get handles(){const handles=[];if(this.sourceConnection&&this.sourceConnection.getSlotSpec())for(const handleName of this.sourceConnection.particle.getSlotSpecByName(this.name).handles){const handleConn=this.sourceConnection.particle.connections[handleName];(handleConn||handleConn.handle)&&handles.push(handleConn.handle)}return handles}_copyInto(recipe,cloneMap){let slot=void 0;return cloneMap.has(this)?cloneMap.get(this):(!this.sourceConnection&&this.id&&(slot=recipe.findSlot(this.id)),null==slot&&((slot=recipe.newSlot(this.name))._id=this.id,slot._formFactor=this.formFactor,slot._localName=this._localName,slot._tags=[...this._tags],slot._sourceConnection=cloneMap.get(this._sourceConnection),slot.sourceConnection&&(slot.sourceConnection._providedSlots[slot.name]=slot)),this._consumeConnections.forEach(connection=>{cloneMap.get(connection)&&null==cloneMap.get(connection).targetSlot&&cloneMap.get(connection).connectToSlot(slot)}),slot)}_startNormalize(){this.localName=null,this._tags.sort()}_finishNormalize(){this._consumeConnections.forEach(cc=>Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(cc))),this._consumeConnections.sort(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareComparables),Object.freeze(this)}_compareTo(other){let cmp;return 0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.id,other.id))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.localName,other.localName))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings)(this.formFactor,other.formFactor))?cmp:0!==(cmp=Object(_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareArrays)(this._tags,other._tags,_comparable_js__WEBPACK_IMPORTED_MODULE_1__.compareStrings))?cmp:0}findHandleByID(id){return this.handles.find(handle=>handle.id===id)}removeConsumeConnection(slotConnection){const idx=this._consumeConnections.indexOf(slotConnection);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(idx>-1),this._consumeConnections.splice(idx,1),0===this._consumeConnections.length&&this.remove()}remove(){this._recipe.removeSlot(this)}isResolved(options){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Object.isFrozen(this)),options&&options.showUnresolved&&(options.details=[],this._sourceConnection||options.details.push("missing source-connection"),this.id||options.details.push("missing id"),options.details=options.details.join("; ")),Boolean(this._sourceConnection||this.id)}_isValid(options){return!0}toString(nameMap,options){const result=[];result.push("slot"),this.id&&result.push(`'${this.id}'`),this.tags.length>0&&result.push(this.tags.map(tag=>`#${tag}`).join(" ")),result.push(`as ${nameMap&&nameMap.get(this)||this.localName}`);const includeUnresolved=options&&options.showUnresolved&&!this.isResolved(options);return includeUnresolved&&result.push(`// unresolved slot: ${options.details}`),this.id||includeUnresolved?result.join(" "):""}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Arc",function(){return Arc});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_fake_pec_factory_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(55),_id_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(29),_manifest_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(41),_particle_execution_host_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(79),_recipe_handle_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(46),_recipe_recipe_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(48),_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(37),_storage_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(36),_storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(15),_type_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(18),_mutex_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(85);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class Arc{constructor({id:id,context:context,pecFactory:pecFactory,slotComposer:slotComposer,loader:loader,storageKey:storageKey,storageProviderFactory:storageProviderFactory,speculative:speculative,innerArc:innerArc,stub:stub,inspectorFactory:inspectorFactory}){this._activeRecipe=new _recipe_recipe_js__WEBPACK_IMPORTED_MODULE_6__.Recipe,this._recipeDeltas=[],this.dataChangeCallbacks=new Map,this.storesById=new Map,this.storageKeys={},this.storeTags=new Map,this.storeDescriptions=new Map,this.innerArcsByParticle=new Map,this.instantiateMutex=new _mutex_js__WEBPACK_IMPORTED_MODULE_11__.Mutex,this.idGenerator=_id_js__WEBPACK_IMPORTED_MODULE_2__.IdGenerator.newSession(),this.loadedParticleInfo=new Map,this._context=context||new _manifest_js__WEBPACK_IMPORTED_MODULE_3__.Manifest({id:id}),this.pecFactory=pecFactory||Object(_fake_pec_factory_js__WEBPACK_IMPORTED_MODULE_1__.FakePecFactory)(loader).bind(null),"string"==typeof id?(console.error(`Arc created with string ID ${id}!!! This should be an object of type Id instead. This warning will turn into an `+"exception soon (end of April 2019)."),this.id=_id_js__WEBPACK_IMPORTED_MODULE_2__.ArcId.fromString(id)):this.id=id,this.isSpeculative=!!speculative,this.isInnerArc=!!innerArc,this.isStub=!!stub,this._loader=loader,this.inspectorFactory=inspectorFactory,this.inspector=inspectorFactory&&inspectorFactory.create(this),this.storageKey=storageKey;const pecId=this.generateID(),innerPecPort=this.pecFactory(pecId,this.idGenerator);this.pec=new _particle_execution_host_js__WEBPACK_IMPORTED_MODULE_4__.ParticleExecutionHost(innerPecPort,slotComposer,this),this.storageProviderFactory=storageProviderFactory||new _storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_9__.StorageProviderFactory(this.id)}get loader(){return this._loader}get modality(){return this.pec.slotComposer&&this.pec.slotComposer.modality?this.pec.slotComposer.modality:this.activeRecipe.modality}dispose(){for(const innerArc of this.innerArcs)innerArc.dispose();if(this.pec.stop(),this.pec.close(),!this.isInnerArc&&this.pec.slotComposer){const allArcs=this.allDescendingArcs;this.pec.slotComposer.consumers.forEach(consumer=>Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(allArcs.includes(consumer.arc))),this.pec.slotComposer.dispose()}}async _waitForIdle(){for(;;){const messageCount=this.pec.messageCount,innerArcs=this.innerArcs;if(await Promise.all([this.pec.idle,...innerArcs.map(async arc=>arc.idle)]),this.innerArcs.length===innerArcs.length&&this.pec.messageCount===messageCount+2)break}}get idle(){return this.waitForIdlePromise||(this.waitForIdlePromise=this._waitForIdle().then(()=>this.waitForIdlePromise=null)),this.waitForIdlePromise}findInnerArcs(particle){return this.innerArcsByParticle.get(particle)||[]}get innerArcs(){return[].concat(...this.innerArcsByParticle.values())}get allDescendingArcs(){return[this].concat(...this.innerArcs.map(arc=>arc.allDescendingArcs))}createInnerArc(transformationParticle){const id=this.generateID("inner"),innerArc=new Arc({id:id,pecFactory:this.pecFactory,slotComposer:this.pec.slotComposer,loader:this._loader,context:this.context,innerArc:!0,speculative:this.isSpeculative,inspectorFactory:this.inspectorFactory});let particleInnerArcs=this.innerArcsByParticle.get(transformationParticle);return particleInnerArcs||(particleInnerArcs=[],this.innerArcsByParticle.set(transformationParticle,particleInnerArcs)),particleInnerArcs.push(innerArc),innerArc}async _serializeHandle(handle,context,id){const type=handle.type.getContainedType()||handle.type;type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.InterfaceType&&(context.interfaces+=type.interfaceInfo.toString()+"\n");const key=this.storageProviderFactory.parseStringAsKey(handle.storageKey),handleTags=[...this.storeTags.get(handle)||new Set].map(a=>`#${a}`).join(" "),actualHandle=this.activeRecipe.findHandle(handle.id),originalId=actualHandle?actualHandle.originalId:null;let combinedId=`'${handle.id}'`;switch(originalId&&(combinedId+=`!!'${originalId}'`),key.protocol){case"firebase":case"pouchdb":context.handles+=`store ${id} of ${handle.type.toString()} ${combinedId} @${null===handle.version?0:handle.version} ${handleTags} at '${handle.storageKey}'\n`;break;case"volatile":{let serializedData=[];if(handleTags.includes("volatile")||(serializedData=(await handle.toLiteral()).model.map(model=>{const{id:id,value:value}=model,index=model.index;if(null==value)return null;let result;if(value.rawData){result={$id:id};for(const field of Object.keys(value.rawData))result[field]=value.rawData[field]}else result=value;return void 0!==index&&(result.$index=index),result})),handle.referenceMode&&serializedData.length>0){const storageKey=serializedData[0].storageKey;if(!context.dataResources.has(storageKey)){const storeId=`${id}_Data`;context.dataResources.set(storageKey,storeId),handle instanceof _storage_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.StorageProviderBase&&(await handle.ensureBackingStore(),await this._serializeHandle(handle.backingStore,context,storeId))}const storeId=context.dataResources.get(storageKey);serializedData.forEach(a=>{a.storageKey=storeId})}context.resources+=`resource ${id}Resource\n`;const indent="  ";context.resources+=indent+"start\n";const data=JSON.stringify(serializedData);context.resources+=data.split("\n").map(line=>indent+line).join("\n"),context.resources+="\n",context.handles+=`store ${id} of ${handle.type.toString()} ${combinedId} @${handle.version||0} ${handleTags} in ${id}Resource\n`;break}default:throw new Error(`unknown storageKey protocol ${key.protocol}`)}}async _serializeHandles(){const context={handles:"",resources:"",interfaces:"",dataResources:new Map};let id=0;const importSet=new Set,handlesToSerialize=new Set,contextSet=new Set(this.context.stores.map(store=>store.id));for(const handle of this._activeRecipe.handles)if("map"===handle.fate)importSet.add(this.context.findManifestUrlForHandleId(handle.id));else{if(handle.immediateValue)continue;handlesToSerialize.add(handle.id)}for(const url of importSet.values())context.resources+=`import '${url}'\n`;for(const handle of this._stores)handlesToSerialize.has(handle.id)&&!contextSet.has(handle.id)&&await this._serializeHandle(handle,context,`Store${id++}`);return context.resources+context.interfaces+context.handles}_serializeParticles(){const particleSpecs=[];particleSpecs.push(...this._activeRecipe.particles.map(entry=>entry.spec)),particleSpecs.push(...this._activeRecipe.handles.filter(h=>h.immediateValue).map(h=>h.immediateValue));const results=[];return particleSpecs.forEach(spec=>{for(const connection of spec.handleConnections)connection.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.InterfaceType&&results.push(connection.type.interfaceInfo.toString());results.push(spec.toString())}),results.join("\n")}_serializeStorageKey(){return this.storageKey?`storageKey: '${this.storageKey}'\n`:""}async serialize(){return await this.idle,`\nmeta\n  name: '${this.id}'\n  ${this._serializeStorageKey()}\n\n${await this._serializeHandles()}\n\n${this._serializeParticles()}\n\n@active\n${this.activeRecipe.toString()}`}async persistSerialization(serialization){const storage=this.storageProviderFactory,key=storage.parseStringAsKey(this.storageKey).childKeyForArcInfo(),arcInfoType=new _type_js__WEBPACK_IMPORTED_MODULE_10__.ArcType,store=await storage.connectOrConstruct("store",arcInfoType,key.toString());store.referenceMode=!1,await store.set(arcInfoType.newInstance(this.id,serialization))}static async deserialize({serialization:serialization,pecFactory:pecFactory,slotComposer:slotComposer,loader:loader,fileName:fileName,context:context,inspectorFactory:inspectorFactory}){const manifest=await _manifest_js__WEBPACK_IMPORTED_MODULE_3__.Manifest.parse(serialization,{loader:loader,fileName:fileName,context:context}),arc=new Arc({id:_id_js__WEBPACK_IMPORTED_MODULE_2__.Id.fromString(manifest.meta.name),storageKey:manifest.meta.storageKey,slotComposer:slotComposer,pecFactory:pecFactory,loader:loader,storageProviderFactory:manifest.storageProviderFactory,context:context,inspectorFactory:inspectorFactory});await Promise.all(manifest.stores.map(async store=>{const tags=manifest.storeTags.get(store);store instanceof _manifest_js__WEBPACK_IMPORTED_MODULE_3__.StorageStub&&(store=await store.inflate()),arc._registerStore(store,tags)}));const recipe=manifest.activeRecipe.clone(),options={errors:new Map};return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.normalize(options),`Couldn't normalize recipe ${recipe.toString()}:\n${[...options.errors.values()].join("\n")}`),await arc.instantiate(recipe),arc}get context(){return this._context}get activeRecipe(){return this._activeRecipe}get allRecipes(){return[this.activeRecipe].concat(this.context.allRecipes)}get recipes(){return[this.activeRecipe]}get recipeDeltas(){return this._recipeDeltas}loadedParticleSpecs(){return[...this.loadedParticleInfo.values()].map(({spec:spec})=>spec)}async _instantiateParticle(recipeParticle){recipeParticle.id=this.generateID("particle");const info={spec:recipeParticle.spec,stores:new Map};this.loadedParticleInfo.set(recipeParticle.id.toString(),info),await this._provisionSpecUrl(recipeParticle.spec);for(const[name,connection]of Object.entries(recipeParticle.connections)){const store=this.findStoreById(connection.handle.id);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store,`can't find store of id ${connection.handle.id}`),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==info.spec.handleConnectionMap.get(name),"can't connect handle to a connection that doesn't exist"),info.stores.set(name,store)}this.pec.instantiate(recipeParticle,info.stores)}async _provisionSpecUrl(spec){spec.implBlobUrl||this.loader&&this.loader.provisionObjectUrl&&spec.setImplBlobUrl(await this.loader.provisionObjectUrl(spec.implFile))}generateID(component=""){return this.idGenerator.newChildId(this.id,component)}get _stores(){return[...this.storesById.values()]}async cloneForSpeculativeExecution(){const arc=new Arc({id:this.generateID(),pecFactory:this.pecFactory,context:this.context,loader:this._loader,speculative:!0,innerArc:this.isInnerArc,inspectorFactory:this.inspectorFactory}),storeMap=new Map;for(const store of this._stores){const clone=await arc.storageProviderFactory.construct(store.id,store.type,"volatile");await clone.cloneFrom(store),storeMap.set(store,clone),this.storeDescriptions.has(store)&&arc.storeDescriptions.set(clone,this.storeDescriptions.get(store))}this.loadedParticleInfo.forEach((info,id)=>{const stores=new Map;info.stores.forEach((store,name)=>stores.set(name,storeMap.get(store))),arc.loadedParticleInfo.set(id,{spec:info.spec,stores:stores})});const{cloneMap:cloneMap}=this._activeRecipe.mergeInto(arc._activeRecipe);this._recipeDeltas.forEach(recipe=>arc._recipeDeltas.push({particles:recipe.particles.map(p=>cloneMap.get(p)),handles:recipe.handles.map(h=>cloneMap.get(h)),slots:recipe.slots.map(s=>cloneMap.get(s)),patterns:recipe.patterns}));for(const[particle,innerArcs]of this.innerArcsByParticle.entries())arc.innerArcsByParticle.set(cloneMap.get(particle),await Promise.all(innerArcs.map(async arc=>arc.cloneForSpeculativeExecution())));for(const v of storeMap.values())arc._registerStore(v,[]);return arc}async instantiate(recipe){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.isResolved(),`Cannot instantiate an unresolved recipe: ${recipe.toString({showUnresolved:!0})}`),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.isCompatible(this.modality),`Cannot instantiate recipe ${recipe.toString()} with [${recipe.modality.names}] modalities in '${this.modality.names}' arc`);const release=await this.instantiateMutex.acquire();try{await this._doInstantiate(recipe)}finally{release()}}async _doInstantiate(recipe){const{handles:handles,particles:particles,slots:slots}=recipe.mergeInto(this._activeRecipe);this._recipeDeltas.push({particles:particles,handles:handles,slots:slots,patterns:recipe.patterns}),slots.forEach(slot=>slot.id=slot.id||`slotid-${this.generateID().toString()}`);for(const recipeHandle of handles){if(["copy","create"].includes(recipeHandle.fate)){let type=recipeHandle.type;"create"===recipeHandle.fate&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type.maybeEnsureResolved(),`Can't assign resolved type to ${type}`),type=type.resolvedType(),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type.isResolved(),`Can't create handle for unresolved type ${type}`);const newStore=await this.createStore(type,null,this.generateID().toString(),recipeHandle.tags,recipeHandle.immediateValue?"volatile":null);if(recipeHandle.immediateValue){const particleSpec=recipeHandle.immediateValue,type=recipeHandle.type;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.InterfaceType&&type.interfaceInfo.particleMatches(particleSpec));const particleClone=particleSpec.clone().toLiteral();particleClone.id=newStore.id,await newStore.set(particleClone)}else if("copy"===recipeHandle.fate){const copiedStoreRef=this.findStoreById(recipeHandle.id);let copiedStore;copiedStore=copiedStoreRef instanceof _manifest_js__WEBPACK_IMPORTED_MODULE_3__.StorageStub?await copiedStoreRef.inflate():copiedStoreRef,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(copiedStore,`Cannot find store ${recipeHandle.id}`),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==copiedStore.version,`Copied store ${recipeHandle.id} doesn't have version.`),await newStore.cloneFrom(copiedStore),this._tagStore(newStore,this.findStoreTags(copiedStore));const copiedStoreDesc=this.getStoreDescription(copiedStore);copiedStoreDesc&&this.storeDescriptions.set(newStore,copiedStoreDesc)}recipeHandle.id=newStore.id,recipeHandle.fate="use",recipeHandle.storageKey=newStore.storageKey;continue}if(this.storesById.has(recipeHandle.id))continue;let storageKey=recipeHandle.storageKey;storageKey||(storageKey=this.keyForId(recipeHandle.id)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(storageKey,`couldn't find storage key for handle '${recipeHandle}'`);const type=recipeHandle.type.resolvedType();Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type.isResolved());const store=await this.storageProviderFactory.connect(recipeHandle.id,type,storageKey);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store,`store '${recipeHandle.id}' was not found`),this._registerStore(store,recipeHandle.tags)}await Promise.all(particles.map(recipeParticle=>this._instantiateParticle(recipeParticle))),this.pec.slotComposer&&await this.pec.slotComposer.initializeRecipe(this,particles),this.inspector&&this.inspector.recipeInstantiated(particles,this.activeRecipe.toString())}async createStore(type,name,id,tags,storageKey){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.Type,`can't createStore with type ${type} that isn't a Type`),type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.RelationType&&(type=new _type_js__WEBPACK_IMPORTED_MODULE_10__.CollectionType(type)),null==id&&(id=this.generateID().toString()),null==storageKey&&this.storageKey&&(storageKey=this.storageProviderFactory.parseStringAsKey(this.storageKey).childKeyForHandle(id).toString());(null==storageKey||(tags=>tags&&tags.includes("volatile"))(tags))&&(storageKey="volatile");const store=await this.storageProviderFactory.construct(id,type,storageKey);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store,`failed to create store with id [${id}]`),store.name=name,this._registerStore(store,tags),store}_registerStore(store,tags){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.storesById.has(store.id),`Store already registered '${store.id}'`),tags=tags||[],tags=Array.isArray(tags)?tags:[tags],this.storesById.set(store.id,store),this.storeTags.set(store,new Set(tags)),this.storageKeys[store.id]=store.storageKey,store.on("change",()=>this._onDataChange(),this)}_tagStore(store,tags){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.storesById.has(store.id)&&this.storeTags.has(store),`Store not registered '${store.id}'`);const storeTags=this.storeTags.get(store);(tags=tags||new Set).forEach(tag=>storeTags.add(tag))}_onDataChange(){for(const callback of this.dataChangeCallbacks.values())callback()}onDataChange(callback,registration){this.dataChangeCallbacks.set(registration,callback)}clearDataChange(registration){this.dataChangeCallbacks.delete(registration)}static _typeToKey(type){const elementType=type.getContainedType();if(elementType){const key=this._typeToKey(elementType);if(key)return`list:${key}`}else{if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.EntityType)return type.entitySchema.name;if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.InterfaceType)return type.interfaceInfo;if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.TypeVariable&&type.isResolved())return Arc._typeToKey(type.resolvedType())}return null}findStoresByType(type,options){const typeKey=Arc._typeToKey(type);let stores=[...this.storesById.values()].filter(handle=>{if(typeKey){const handleKey=Arc._typeToKey(handle.type);if(typeKey===handleKey)return!0}else{if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.TypeVariable&&!type.isResolved()&&handle.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.EntityType)return!0;const elementType=type.getContainedType();if(elementType&&elementType instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.TypeVariable&&!elementType.isResolved()&&type.tag===handle.type.tag)return!0}return!1});return options&&options.tags&&options.tags.length>0&&(stores=stores.filter(store=>0===options.tags.filter(tag=>!this.storeTags.get(store).has(tag)).length)),stores.filter(s=>!!_recipe_handle_js__WEBPACK_IMPORTED_MODULE_5__.Handle.effectiveType(type,[{type:s.type,direction:s.type instanceof _type_js__WEBPACK_IMPORTED_MODULE_10__.InterfaceType?"host":"inout"}]))}findStoreById(id){const store=this.storesById.get(id);return null==store?this._context.findStoreById(id):store}findStoreTags(store){return this.storeTags.has(store)?this.storeTags.get(store):new Set(this._context.findStoreTags(store))}getStoreDescription(store){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store,"Cannot fetch description for nonexistent store"),this.storeDescriptions.get(store)||store.description}getVersionByStore({includeArc:includeArc=!0,includeContext:includeContext=!1}){const versionById={};return includeArc&&this.storesById.forEach((handle,id)=>versionById[id]=handle.version),includeContext&&this._context.allStores.forEach(handle=>versionById[handle.id]=handle.version),versionById}keyForId(id){return this.storageKeys[id]}toContextString(){const results=[];return[...this.storesById.values()].sort(_recipe_comparable_js__WEBPACK_IMPORTED_MODULE_7__.compareComparables).forEach(store=>{results.push(store.toString([...this.storeTags.get(store)]))}),this._activeRecipe.isEmpty()||results.push(this._activeRecipe.toString()),results.join("\n")}get apiChannelMappingId(){return this.id.toString()}get idGeneratorForTesting(){return this.idGenerator}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"FakePecFactory",function(){return FakePecFactory});var _loader_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(56),_message_channel_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(66),_particle_execution_context_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(67),_testing_stub_loader_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(78);
// @license
function FakePecFactory(loader){return(pecId,idGenerator)=>{const channel=new _message_channel_js__WEBPACK_IMPORTED_MODULE_1__.MessageChannel,loaderToUse=loader instanceof _testing_stub_loader_js__WEBPACK_IMPORTED_MODULE_3__.StubLoader?loader.clone():new _loader_js__WEBPACK_IMPORTED_MODULE_0__.Loader;new _particle_execution_context_js__WEBPACK_IMPORTED_MODULE_2__.ParticleExecutionContext(channel.port1,pecId,idGenerator,loaderToUse);return channel.port2}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Loader",function(){return Loader});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(57),_platform_fs_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(58),_platform_vm_web_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(59),_converters_jsonldToManifest_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(60),_dom_particle_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(61),_multiplexer_dom_particle_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(64),_particle_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(63),_reference_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(24),_transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(65);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const html=(strings,...values)=>(strings[0]+values.map((v,i)=>v+strings[i+1]).join("")).trim();class Loader{path(fileName){return fileName.replace(/[\/][^\/]+$/,"/")}join(prefix,path){return/^https?:\/\//.test(path)?path:"/"===path[0]||":"===path[1]?path:(prefix=this.path(prefix),path=this.normalizeDots(`${prefix}${path}`))}normalizeDots(path){const norm=s=>s.replace(/(?:^|\/)[^.\/]*\/\.\./g,"");for(let n=norm(path=(path=path.replace(/\\/g,"/")).replace(/\/\.\//g,"/"));n!==path;n=norm(path=n));return path=path.replace(/([^:])(\/\/)/g,"$1/")}async loadResource(file){return/^https?:\/\//.test(file)?this._loadURL(file):this._loadFile(file,"utf-8")}async loadBinary(file){return/^https?:\/\//.test(file)?Object(_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__.fetch)(file).then(res=>res.arrayBuffer()):this._loadFile(file,null)}async _loadFile(file,encoding){return new Promise((resolve,reject)=>{_platform_fs_web_js__WEBPACK_IMPORTED_MODULE_2__.fs.readFile(file,{encoding:encoding},(err,data)=>{err?reject(err):resolve(encoding?data:data.buffer)})})}async _loadURL(url){return/\/\/schema.org\//.test(url)?url.endsWith("/Thing")?Object(_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__.fetch)("https://schema.org/Product.jsonld").then(res=>res.text()).then(data=>_converters_jsonldToManifest_js__WEBPACK_IMPORTED_MODULE_4__.JsonldToManifest.convert(data,{"@id":"schema:Thing"})):Object(_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__.fetch)(url+".jsonld").then(res=>res.text()).then(data=>_converters_jsonldToManifest_js__WEBPACK_IMPORTED_MODULE_4__.JsonldToManifest.convert(data)):Object(_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__.fetch)(url).then(res=>res.text())}async loadParticleClass(spec){const clazz=await this.requireParticle(spec.implFile);return clazz.spec=spec,clazz}async requireParticle(fileName){null===fileName&&(fileName="");const src=await this.loadResource(fileName),script=new _platform_vm_web_js__WEBPACK_IMPORTED_MODULE_3__.vm.Script(src,{filename:fileName,displayErrors:!0}),result=[],self={defineParticle(particleWrapper){result.push(particleWrapper)},console:console,fetch:_platform_fetch_web_js__WEBPACK_IMPORTED_MODULE_1__.fetch,setTimeout:setTimeout,importScripts:s=>null};return script.runInNewContext(self,{filename:fileName,displayErrors:!0}),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(result.length>0&&"function"==typeof result[0],`Error while instantiating particle implementation from ${fileName}`),this.unwrapParticle(result[0])}setParticleExecutionContext(pec){this.pec=pec}unwrapParticle(particleWrapper){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.pec),particleWrapper({Particle:_particle_js__WEBPACK_IMPORTED_MODULE_7__.Particle,DomParticle:_dom_particle_js__WEBPACK_IMPORTED_MODULE_5__.DomParticle,TransformationDomParticle:_transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_9__.TransformationDomParticle,MultiplexerDomParticle:_multiplexer_dom_particle_js__WEBPACK_IMPORTED_MODULE_6__.MultiplexerDomParticle,Reference:_reference_js__WEBPACK_IMPORTED_MODULE_8__.ClientReference.newClientReference(this.pec),html:html})}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"fetch",function(){return localFetch});const localFetch=fetch},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"fs",function(){return fs});const fs={}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"vm",function(){return vm});const vm={}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"JsonldToManifest",function(){return JsonldToManifest});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const supportedTypes=["Text","URL","Number","Boolean"];class JsonldToManifest{static convert(jsonld,theClass){const obj=JSON.parse(jsonld),classes={},properties={};obj["@graph"]||(obj["@graph"]=[obj]);for(const item of obj["@graph"])"rdf:Property"===item["@type"]?properties[item["@id"]]=item:"rdfs:Class"===item["@type"]&&(classes[item["@id"]]=item,item.subclasses=[],item.superclass=null);for(const clazz of Object.values(classes))if(void 0!==clazz["rdfs:subClassOf"]){null==clazz["rdfs:subClassOf"].length&&(clazz["rdfs:subClassOf"]=[clazz["rdfs:subClassOf"]]);for(const subClass of clazz["rdfs:subClassOf"]){const superclass=subClass["@id"];null==clazz.superclass&&(clazz.superclass=[]),classes[superclass]?(classes[superclass].subclasses.push(clazz),clazz.superclass.push(classes[superclass])):clazz.superclass.push({"@id":superclass})}}for(const clazz of Object.values(classes))0===clazz.subclasses.length&&null==theClass&&(theClass=clazz);const relevantProperties=[];for(const property of Object.values(properties)){let domains=property["schema:domainIncludes"];if(domains||(domains={"@id":theClass["@id"]}),domains.length||(domains=[domains]),(domains=domains.map(a=>a["@id"])).includes(theClass["@id"])){const name=property["@id"].split(":")[1];let type=property["schema:rangeIncludes"];type||console.log(property),type.length||(type=[type]),(type=(type=type.map(a=>a["@id"].split(":")[1])).filter(type=>supportedTypes.includes(type))).length>0&&relevantProperties.push({name:name,type:type})}}const className=theClass["@id"].split(":")[1],superNames=theClass&&theClass.superclass?theClass.superclass.map(a=>a["@id"].split(":")[1]):[];let s="";for(const superName of superNames)s+=`import 'https://schema.org/${superName}'\n\n`;if(s+=`schema ${className}`,superNames.length>0&&(s+=` extends ${superNames.join(", ")}`),relevantProperties.length>0)for(const property of relevantProperties){let type;s+=`\n  ${type=property.type.length>1?"("+property.type.join(" or ")+")":property.type[0]} ${property.name}`}return s+="\n"}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DomParticle",function(){return DomParticle});var _modalities_dom_components_xen_xen_state_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),_dom_particle_base_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(62),_handle_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(25);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DomParticle extends(Object(_modalities_dom_components_xen_xen_state_js__WEBPACK_IMPORTED_MODULE_0__.XenStateMixin)(_dom_particle_base_js__WEBPACK_IMPORTED_MODULE_1__.DomParticleBase)){constructor(){super()}willReceiveProps(...args){}update(...args){}shouldRender(...args){return!0}render(...args){return{}}setState(state){return this._setState(state)}get state(){return this._state}set state(state){this.setState(state)}get props(){return this._props}configureHandles(handles){}get config(){return{handleNames:this.spec.inputs.map(i=>i.name),slotNames:[...this.spec.slotConnections.values()].map(s=>s.name)}}_willReceiveProps(...args){this.willReceiveProps(...args)}_update(...args){this.update(...args),this.shouldRender(...args)&&(this.relevance=1),this.config.slotNames.forEach(s=>this.renderSlot(s,["model"]))}get _views(){return console.warn(`Particle ${this.spec.name} uses deprecated _views getter.`),this.handles}async setHandles(handles){this.configureHandles(handles),this.handles=handles,this._handlesToSync=new Set;for(const name of this.config.handleNames){const handle=handles.get(name);handle&&handle.options.keepSynced&&handle.options.notifySync&&this._handlesToSync.add(name)}this._handlesToSync.size||this._invalidate()}async onHandleSync(handle,model){this._handlesToSync.delete(handle.name),0===this._handlesToSync.size&&await this._handlesToProps()}async onHandleUpdate(handle,update){this._debounce("handleUpdateDebounce",()=>{this._handlesToProps()},300)}async _handlesToProps(){const props=Object.create(null),{handleNames:handleNames}=this.config;await Promise.all(handleNames.map(name=>this._addNamedHandleData(props,name))),this._setProps(props)}async _addNamedHandleData(dictionary,handleName){const handle=this.handles.get(handleName);handle&&(dictionary[handleName]=await this._getHandleData(handle))}async _getHandleData(handle){return handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_2__.Collection?await handle.toList():handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_2__.Variable?await handle.get():handle}fireEvent(slotName,{handler:handler,data:data}){this[handler]&&this[handler]({data:data},this._state)}_debounce(key,func,delay){const subkey=`_debounce_${key}`;this._state[subkey]||this.startBusy();super._debounce(key,()=>{this.doneBusy(),func(),this._state[subkey]=null},delay)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DomParticleBase",function(){return DomParticleBase});var _handle_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(25),_particle_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(63);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DomParticleBase extends _particle_js__WEBPACK_IMPORTED_MODULE_1__.Particle{get template(){return""}getTemplate(slotName){return this.template}getTemplateName(slotName){return"default"}shouldRender(stateArgs){return!0}render(stateArgs){return{}}renderSlot(slotName,contentTypes){const stateArgs=this._getStateArgs(),slot=this.getSlot(slotName);if(slot){if(this.currentSlotName=slotName,contentTypes.forEach(ct=>slot.requestedContentTypes.add(ct)),this.shouldRender(...stateArgs)){const content={};if(slot.requestedContentTypes.has("template")&&(content.template=this.getTemplate(slot.slotName)),slot.requestedContentTypes.has("model")&&(content.model=this.render(...stateArgs)),content.templateName=this.getTemplateName(slot.slotName),slot.providedSlots.size>0&&(content.template&&("string"==typeof content.template?content.template=this.slotNamesToModelReferences(slot,content.template):content.template=Object.entries(content.template).reduce((templateDictionary,[templateName,templateValue])=>(templateDictionary[templateName]=this.slotNamesToModelReferences(slot,templateValue),templateDictionary),{})),content.model)){const slotIDs={};slot.providedSlots.forEach((slotId,slotName)=>slotIDs[`$${slotName}`]=slotId),content.model=this.enhanceModelWithSlotIDs(content.model,slotIDs)}slot.render(content)}else slot.isRendered&&slot.render({});this.currentSlotName=void 0}}slotNamesToModelReferences(slot,template){return slot.providedSlots.forEach((slotId,slotName)=>{template=template.replace(new RegExp(`slotid="${slotName}"`,"gi"),`slotname="${slotName}" slotid$="{{$${slotName}}}"`)}),template}enhanceModelWithSlotIDs(model,slotIDs,topLevel=!0){topLevel&&(model={...slotIDs,...model}),model.hasOwnProperty("$template")&&model.hasOwnProperty("models")&&Array.isArray(model.models)&&(model.models=model.models.map(m=>this.enhanceModelWithSlotIDs(m,slotIDs)));for(const[key,value]of Object.entries(model))value&&"object"==typeof value&&(model[key]=this.enhanceModelWithSlotIDs(value,slotIDs,!1));return model}_getStateArgs(){return[]}forceRenderTemplate(slotName=""){this.slotProxiesByName.forEach((slot,name)=>{slotName&&name!==slotName||slot.requestedContentTypes.add("template")})}fireEvent(slotName,{handler:handler,data:data}){this[handler]&&this[handler]({data:data})}setParticleDescription(pattern){if("string"==typeof pattern)return super.setParticleDescription(pattern);if(pattern.template&&pattern.model)return super.setDescriptionPattern("_template_",pattern.template),void super.setDescriptionPattern("_model_",JSON.stringify(pattern.model));throw new Error("Description pattern must either be string or have template and model")}async clearHandle(handleName){const handle=this.handles.get(handleName);if(!(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Variable||handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection))throw new Error("Variable/Collection required");handle.clear()}async mergeEntitiesToHandle(handleName,entities){const idMap={},handle=this.handles.get(handleName);if(!(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection))throw new Error("Collection required");(await handle.toList()).forEach(entity=>idMap[entity.id]=entity);for(const entity of entities)idMap[entity.id]||handle.store(entity)}async appendEntitiesToHandle(handleName,entities){const handle=this.handles.get(handleName);if(handle){if(!(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection||handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.BigCollection))throw new Error("Collection required");Promise.all(entities.map(entity=>handle.store(entity)))}}async appendRawDataToHandle(handleName,rawDataArray){const handle=this.handles.get(handleName);if(handle&&handle.entityClass){if(!(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection||handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.BigCollection))throw new Error("Collection required");{const entityClass=handle.entityClass;Promise.all(rawDataArray.map(raw=>handle.store(new entityClass(raw))))}}}updateVariable(handleName,rawData){const handle=this.handles.get(handleName);if(handle&&handle.entityClass){if(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Variable){const entity=new(0,handle.entityClass)(rawData);return handle.set(entity),entity}throw new Error("Variable required")}}async updateSet(handleName,entity){const handle=this.handles.get(handleName);if(handle){if(!(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection||handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.BigCollection))throw new Error("Collection required");await handle.remove(entity),await handle.store(entity)}}boxQuery(box,userid){return box&&box.filter(item=>userid===item.getUserID().split("|")[0])}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Particle",function(){return Particle});var _handle_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(25);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */class Particle{constructor(){this.relevances=[],this._idle=Promise.resolve(),this._busy=0,this.slotProxiesByName=new Map,this.spec=this.constructor.spec,0===this.spec.inputs.length&&(this.extraData=!0)}setCapabilities(capabilities){if(this.capabilities)throw new Error("capabilities should only be set once");this.capabilities=capabilities||{}}async setHandles(handles){}async onHandleSync(handle,model){}async onHandleUpdate(handle,update){}async onHandleDesync(handle){}async constructInnerArc(){if(!this.capabilities.constructInnerArc)throw new Error("This particle is not allowed to construct inner arcs");return this.capabilities.constructInnerArc(this)}get busy(){return this._busy>0}get idle(){return this._idle}set relevance(r){this.relevances.push(r)}startBusy(){0===this._busy&&(this._idle=new Promise(resolve=>this._idleResolver=resolve)),this._busy++}doneBusy(){this._busy--,0===this._busy&&this._idleResolver()}inputs(){return this.spec.inputs}outputs(){return this.spec.outputs}hasSlotProxy(name){return this.slotProxiesByName.has(name)}addSlotProxy(slotlet){this.slotProxiesByName.set(slotlet.slotName,slotlet)}removeSlotProxy(name){this.slotProxiesByName.delete(name)}async service(request){return this.capabilities.serviceRequest?new Promise(resolve=>{this.capabilities.serviceRequest(this,request,response=>resolve(response))}):(console.warn(`${this.spec.name} has no service support.`),null)}getSlot(name){return this.slotProxiesByName.get(name)}static buildManifest(strings,...bits){const output=[];for(let i=0;i<bits.length;i++){const str=strings[i],indent=/ *$/.exec(str)[0];let bitStr;bitStr=(bitStr="string"==typeof bits[i]?bits[i]:bits[i].toManifestString()).replace(/(\n)/g,"$1"+indent),output.push(str),output.push(bitStr)}return strings.length>bits.length&&output.push(strings[strings.length-1]),output.join("")}setParticleDescription(pattern){return this.setDescriptionPattern("pattern",pattern)}setDescriptionPattern(connectionName,pattern){const descriptions=this.handles.get("descriptions");if(descriptions){const entityClass=descriptions.entityClass;return(descriptions instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.Collection||descriptions instanceof _handle_js__WEBPACK_IMPORTED_MODULE_0__.BigCollection)&&descriptions.store(new entityClass({key:connectionName,value:pattern},this.spec.name+"-"+connectionName)),!0}throw new Error("A particle needs a description handle to set a decription pattern")}renderSlot(slotName,contentTypes){}renderHostedSlot(slotName,hostedSlotId,content){}fireEvent(slotName,event){}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MultiplexerDomParticle",function(){return MultiplexerDomParticle});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27),_transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(65);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class MultiplexerDomParticle extends _transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_2__.TransformationDomParticle{constructor(){super(...arguments),this._itemSubIdByHostedSlotId=new Map,this._connByHostedConn=new Map}async _mapParticleConnections(listHandleName,particleHandleName,hostedParticle,handles,arc){const otherMappedHandles=[],otherConnections=[];let index=2;const skipConnectionNames=[listHandleName,particleHandleName];for(const[connectionName,otherHandle]of handles){if(skipConnectionNames.includes(connectionName))continue;const otherHandleStore=otherHandle.storage;otherMappedHandles.push(`use '${await arc.mapHandle(otherHandleStore)}' as v${index}`);const hostedOtherConnection=hostedParticle.handleConnections.find(conn=>conn.isCompatibleType(otherHandle.type));hostedOtherConnection&&(otherConnections.push(`${hostedOtherConnection.name} = v${index++}`),this._connByHostedConn.set(hostedOtherConnection.name,connectionName))}return[otherMappedHandles,otherConnections]}async setHandles(handles){this.handleIds={};const arc=await this.constructInnerArc(),particleHandle=handles.get("hostedParticle");let hostedParticle=null,otherMappedHandles=[],otherConnections=[];particleHandle&&(hostedParticle=await particleHandle.get())&&([otherMappedHandles,otherConnections]=await this._mapParticleConnections("list","hostedParticle",hostedParticle,handles,arc)),this.setState({arc:arc,type:handles.get("list").type,hostedParticle:hostedParticle,otherMappedHandles:otherMappedHandles,otherConnections:otherConnections}),await super.setHandles(handles)}async willReceiveProps({list:list},{arc:arc,type:type,hostedParticle:hostedParticle,otherMappedHandles:otherMappedHandles,otherConnections:otherConnections}){list.length>0&&(this.relevance=.1);for(const[index,item]of this.getListEntries(list)){let resolvedHostedParticle=hostedParticle;if(this.handleIds[item.id]){(await this.handleIds[item.id]).set(item);continue}const itemHandlePromise=arc.createHandle(type.getContainedType(),`item${index}`);this.handleIds[item.id]=itemHandlePromise;const itemHandle=await itemHandlePromise;if(!resolvedHostedParticle){if(!item.renderParticleSpec)continue;resolvedHostedParticle=_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__.ParticleSpec.fromLiteral(JSON.parse(item.renderParticleSpec));const listHandleName="list",particleHandleName="renderParticle";[otherMappedHandles,otherConnections]=await this._mapParticleConnections(listHandleName,particleHandleName,resolvedHostedParticle,this.handles,arc)}const hostedSlotName=[...resolvedHostedParticle.slotConnections.keys()][0],slotName=[...this.spec.slotConnections.values()][0].name,slotId=await arc.createSlot(this,slotName,itemHandle._id);if(slotId){this._itemSubIdByHostedSlotId.set(slotId,item.id);try{const recipe=this.constructInnerRecipe(resolvedHostedParticle,item,itemHandle,{name:hostedSlotName,id:slotId},{connections:otherConnections,handles:otherMappedHandles});await arc.loadRecipe(recipe),itemHandle.set(item)}catch(e){console.log(e)}}}}combineHostedModel(slotName,hostedSlotId,content){const subId=this._itemSubIdByHostedSlotId.get(hostedSlotId);if(!subId)return;const items=this._state.renderModel?this._state.renderModel.items:[],listIndex=items.findIndex(item=>item.subId===subId),item={...content.model,subId:subId};listIndex>=0&&listIndex<items.length?items[listIndex]=item:items.push(item),this._setState({renderModel:{items:items}})}combineHostedTemplate(slotName,hostedSlotId,content){const subId=this._itemSubIdByHostedSlotId.get(hostedSlotId);if(!subId)return;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(content.templateName,`Template name is missing for slot '${slotName}' (hosted slot ID: '${hostedSlotId}')`);const templateName={...this._state.templateName,[subId]:`${content.templateName}`};if(this._setState({templateName:templateName}),content.template){let template=content.template;template=template.replace(new RegExp('slotid="[a-z]+"',"gi"),'$& subid$="{{subId}}"'),this._connByHostedConn.forEach((conn,hostedConn)=>{template=template.replace(new RegExp(`{{${hostedConn}.description}}`,"g"),`{{${conn}.description}}`)}),this._setState({template:{...this._state.template,[content.templateName]:template}}),this.forceRenderTemplate()}}getListEntries(list){return list.entries()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"TransformationDomParticle",function(){return TransformationDomParticle});var _dom_particle_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(61);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */class TransformationDomParticle extends _dom_particle_js__WEBPACK_IMPORTED_MODULE_0__.DomParticle{getTemplate(slotName){return this._state.template}getTemplateName(slotName){return this._state.templateName}render(props,state){return state.renderModel}shouldRender(props,state){return Boolean((state.template||state.templateName)&&state.renderModel)}renderHostedSlot(slotName,hostedSlotId,content){this.combineHostedTemplate(slotName,hostedSlotId,content),this.combineHostedModel(slotName,hostedSlotId,content)}combineHostedTemplate(slotName,hostedSlotId,content){}combineHostedModel(slotName,hostedSlotId,content){}static propsToItems(propsValues){return propsValues?propsValues.map(({rawData:rawData,id:id})=>({...rawData,subId:id})):[]}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MessagePort",function(){return MessagePort}),__webpack_require__.d(__webpack_exports__,"MessageChannel",function(){return MessageChannel});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class MessagePort{constructor(channel,id,other){this._channel=channel,this._id=id,this._other=other,this._onmessage=void 0}postMessage(message){this._channel._post(this._other,message)}set onmessage(f){this._onmessage=f}close(){this.postMessage=(()=>{})}}class MessageEvent{constructor(message){this.data=message}}class MessageChannel{constructor(){this.port1=new MessagePort(this,0,1),this.port2=new MessagePort(this,1,0),this._ports=[this.port1,this.port2]}async _post(id,message){if(message=JSON.parse(JSON.stringify(message)),this._ports[id]._onmessage)try{await 0,await this._ports[id]._onmessage(new MessageEvent(message))}catch(e){console.error("Exception in particle code\n",e)}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(global){__webpack_require__.d(__webpack_exports__,"ParticleExecutionContext",function(){return ParticleExecutionContext});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_api_channel_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(69),_handle_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(25),_slot_proxy_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(70),_storage_proxy_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(71),_wasm_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(73);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ParticleExecutionContext{constructor(port,pecId,idGenerator,loader){this.particles=[],this.pendingLoads=[],this.scheduler=new _storage_proxy_js__WEBPACK_IMPORTED_MODULE_4__.StorageProxyScheduler,this.keyedProxies={};const pec=this;this.apiPort=new class extends _api_channel_js__WEBPACK_IMPORTED_MODULE_1__.PECInnerPort{onDefineHandle(identifier,type,name){return _storage_proxy_js__WEBPACK_IMPORTED_MODULE_4__.StorageProxy.newProxy(identifier,type,this,pec,pec.scheduler,name)}onGetBackingStoreCallback(callback,type,name,id,storageKey){const proxy=_storage_proxy_js__WEBPACK_IMPORTED_MODULE_4__.StorageProxy.newProxy(id,type,this,pec,pec.scheduler,name);return proxy.storageKey=storageKey,[proxy,()=>callback(proxy,storageKey)]}onCreateHandleCallback(callback,type,name,id){const proxy=_storage_proxy_js__WEBPACK_IMPORTED_MODULE_4__.StorageProxy.newProxy(id,type,this,pec,pec.scheduler,name);return[proxy,()=>callback(proxy)]}onMapHandleCallback(callback,id){return[id,()=>callback(id)]}onCreateSlotCallback(callback,hostedSlotId){return[hostedSlotId,()=>callback(hostedSlotId)]}onInnerArcRender(transformationParticle,transformationSlotName,hostedSlotId,content){transformationParticle.renderHostedSlot(transformationSlotName,hostedSlotId,content)}onStop(){global.close&&global.close()}async onInstantiateParticle(id,spec,proxies){return pec.instantiateParticle(id,spec,proxies)}onSimpleCallback(callback,data){callback(data)}onConstructArcCallback(callback,arc){callback(arc)}onAwaitIdle(version){pec.idle.then(a=>{setTimeout(()=>{this.Idle(version,pec.relevance)},0)})}onUIEvent(particle,slotName,event){particle.fireEvent(slotName,event)}onStartRender(particle,slotName,providedSlots,contentTypes){particle.addSlotProxy(new _slot_proxy_js__WEBPACK_IMPORTED_MODULE_3__.SlotProxy(this,particle,slotName,providedSlots)),particle.renderSlot(slotName,contentTypes)}onStopRender(particle,slotName){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particle.hasSlotProxy(slotName),`Stop render called for particle ${particle.spec.name} slot ${slotName} without start render being called.`),particle.removeSlotProxy(slotName)}}(port),this.pecId=pecId,this.idGenerator=idGenerator,this.loader=loader,loader.setParticleExecutionContext(this)}generateID(){return this.idGenerator.newChildId(this.pecId).toString()}innerArcHandle(arcId,particleId){const pec=this;return{createHandle:async(type,name,hostParticle)=>new Promise((resolve,reject)=>pec.apiPort.ArcCreateHandle(proxy=>{const handle=Object(_handle_js__WEBPACK_IMPORTED_MODULE_2__.handleFor)(proxy,pec.idGenerator,name,particleId);resolve(handle),hostParticle&&proxy.register(hostParticle,handle)},arcId,type,name)),mapHandle:async handle=>new Promise((resolve,reject)=>pec.apiPort.ArcMapHandle(id=>{resolve(id)},arcId,handle)),createSlot:async(transformationParticle,transformationSlotName,handleId)=>new Promise((resolve,reject)=>pec.apiPort.ArcCreateSlot(hostedSlotId=>resolve(hostedSlotId),arcId,transformationParticle,transformationSlotName,handleId)),loadRecipe:async recipe=>new Promise((resolve,reject)=>pec.apiPort.ArcLoadRecipe(arcId,recipe,response=>{response.error?reject(response.error):resolve(response)}))}}getStorageProxy(storageKey,type){return this.keyedProxies[storageKey]||(this.keyedProxies[storageKey]=new Promise((resolve,reject)=>{this.apiPort.GetBackingStore((proxy,storageKey)=>{this.keyedProxies[storageKey]=proxy,resolve(proxy)},storageKey,type)})),this.keyedProxies[storageKey]}defaultCapabilitySet(){return{constructInnerArc:async particle=>new Promise((resolve,reject)=>this.apiPort.ConstructInnerArc(arcId=>resolve(this.innerArcHandle(arcId,particle.id)),particle)),serviceRequest:(particle,args,callback)=>{this.apiPort.ServiceRequest(particle,args,callback)}}}async instantiateParticle(id,spec,proxies){let resolve;const p=new Promise(res=>resolve=res);let particle;if(this.pendingLoads.push(p),spec.implFile&&spec.implFile.endsWith(".wasm"))(particle=await this.loadWasmParticle(spec)).setCapabilities({});else{const clazz=await this.loader.loadParticleClass(spec);(particle=new clazz).setCapabilities(this.defaultCapabilitySet())}this.particles.push(particle);const handleMap=new Map,registerList=[];return proxies.forEach((proxy,name)=>{const connSpec=spec.handleConnectionMap.get(name),handle=Object(_handle_js__WEBPACK_IMPORTED_MODULE_2__.handleFor)(proxy,this.idGenerator,name,id,connSpec.isInput,connSpec.isOutput);handleMap.set(name,handle),registerList.push({proxy:proxy,particle:particle,handle:handle})}),[particle,async()=>{await particle.setHandles(handleMap),registerList.forEach(({proxy:proxy,particle:particle,handle:handle})=>proxy.register(particle,handle));const idx=this.pendingLoads.indexOf(p);this.pendingLoads.splice(idx,1),resolve()}]}async loadWasmParticle(spec){const buffer=await this.loader.loadBinary(spec.implFile);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(buffer&&buffer.byteLength>0),_wasm_js__WEBPACK_IMPORTED_MODULE_5__.WasmParticle.spec=spec;const particle=new _wasm_js__WEBPACK_IMPORTED_MODULE_5__.WasmParticle;return await particle.initialize(buffer),_wasm_js__WEBPACK_IMPORTED_MODULE_5__.WasmParticle.spec=null,particle}get relevance(){const rMap=new Map;return this.particles.forEach(p=>{0!==p.relevances.length&&(rMap.set(p,p.relevances),p.relevances.length=0)}),rMap}get busy(){return!!(this.pendingLoads.length>0||this.scheduler.busy)||this.particles.filter(particle=>particle.busy).length>0}get idle(){if(!this.busy)return Promise.resolve();const busyParticlePromises=this.particles.filter(async particle=>particle.busy).map(async particle=>particle.idle);return Promise.all([this.scheduler.idle,...this.pendingLoads,...busyParticlePromises]).then(()=>this.idle)}}}.call(this,__webpack_require__(68))},function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){"object"==typeof window&&(g=window)}module.exports=g},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"APIPort",function(){return APIPort}),__webpack_require__.d(__webpack_exports__,"PECOuterPort",function(){return PECOuterPort}),__webpack_require__.d(__webpack_exports__,"PECInnerPort",function(){return PECInnerPort});var MappingType,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18),_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(26),__decorate=function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};!function(MappingType){MappingType[MappingType.Mapped=0]="Mapped",MappingType[MappingType.LocalMapped=1]="LocalMapped",MappingType[MappingType.RemoteMapped=2]="RemoteMapped",MappingType[MappingType.Direct=3]="Direct",MappingType[MappingType.ObjectMap=4]="ObjectMap",MappingType[MappingType.List=5]="List",MappingType[MappingType.ByLiteral=6]="ByLiteral"}(MappingType||(MappingType={}));const targets=new Map;function setPropertyKey(target,propertyKey){targets.has(target)||targets.set(target,new Map),targets.get(target).has(propertyKey)||targets.get(target).set(propertyKey,[])}function set(target,propertyKey,parameterIndex,info){setPropertyKey(target,propertyKey),targets.get(target).get(propertyKey)[parameterIndex]=info}function Direct(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.Direct})}function Mapped(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.Mapped})}function ByLiteral(constructor){return(target,propertyKey,parameterIndex)=>{const info={type:MappingType.ByLiteral,converter:constructor};set(target.constructor,propertyKey,parameterIndex,info)}}function ObjectMap(key,value){return(target,propertyKey,parameterIndex)=>{const info={type:MappingType.ObjectMap,key:{type:key},value:{type:value}};set(target.constructor,propertyKey,parameterIndex,info)}}function LocalMapped(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.LocalMapped})}function RemoteMapped(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.RemoteMapped})}function NoArgs(target,propertyKey){setPropertyKey(target.constructor,propertyKey)}function Initializer(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.Direct,initializer:!0})}function Identifier(target,propertyKey,parameterIndex){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor).get(propertyKey)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor).get(propertyKey)[parameterIndex]),targets.get(target.constructor).get(propertyKey)[parameterIndex].identifier=!0}function RemoteIgnore(target,propertyKey,parameterIndex){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor).get(propertyKey)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(targets.get(target.constructor).get(propertyKey)[parameterIndex]),targets.get(target.constructor).get(propertyKey)[parameterIndex].ignore=!0}class ThingMapper{constructor(prefix){this._prefix=prefix,this._nextIdentifier=0,this._idMap=new Map,this._reverseIdMap=new Map}_newIdentifier(){return this._prefix+this._nextIdentifier++}createMappingForThing(thing,requestedId){let id;return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._reverseIdMap.has(thing)),id=requestedId||(thing.apiChannelMappingId?thing.apiChannelMappingId:this._newIdentifier()),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this._idMap.has(id),`${requestedId?"requestedId":thing.apiChannelMappingId?"apiChannelMappingId":"newIdentifier()"} ${id} already in use`),this.establishThingMapping(id,thing),id}maybeCreateMappingForThing(thing){return this.hasMappingForThing(thing)?this.identifierForThing(thing):this.createMappingForThing(thing)}async establishThingMapping(id,thing){let continuation;Array.isArray(thing)&&([thing,continuation]=thing),this._idMap.set(id,thing),thing instanceof Promise?(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null==continuation),await this.establishThingMapping(id,await thing)):(this._reverseIdMap.set(thing,id),continuation&&await continuation())}hasMappingForThing(thing){return this._reverseIdMap.has(thing)}identifierForThing(thing){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this._reverseIdMap.has(thing),`Missing thing [${thing}]`),this._reverseIdMap.get(thing)}thingForIdentifier(id){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this._idMap.has(id),`Missing id: ${id}`),this._idMap.get(id)}}class APIPort{constructor(messagePort,prefix){this._port=messagePort,this._mapper=new ThingMapper(prefix),this._port.onmessage=(async e=>this._processMessage(e)),this.inspector=null,this.attachStack=!1,this.messageCount=0,this._testingHook()}_testingHook(){}close(){this._port.close()}async _processMessage(e){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==this["before"+e.data.messageType]);const count=this.messageCount++;this.inspector&&this.inspector.pecMessage("on"+e.data.messageType,e.data.messageBody,count,e.data.stack),this["before"+e.data.messageType](e.data.messageBody)}send(name,args){const call={messageType:name,messageBody:args,stack:this.attachStack?(new Error).stack:void 0},count=this.messageCount++;this.inspector&&this.inspector.pecMessage(name,args,count,(new Error).stack),this._port.postMessage(call)}}function getArgs(func){return func.toString().match(/.*?\(([^)]*)\)/)[1].split(",").map(arg=>arg.replace(/\/\*.*\*\//,"").trim()).filter(arg=>arg)}function convert(info,value,mapper){switch(info.type){case MappingType.Mapped:return mapper.identifierForThing(value);case MappingType.LocalMapped:return mapper.maybeCreateMappingForThing(value);case MappingType.RemoteMapped:case MappingType.Direct:return value;case MappingType.ObjectMap:{const r={};return value.forEach((childvalue,key)=>r[convert(info.key,key,mapper)]=convert(info.value,childvalue,mapper)),r}case MappingType.List:return value.map(v=>convert(info.value,v,mapper));case MappingType.ByLiteral:return value.toLiteral();default:throw new Error(`Can't yet send MappingType ${info.type}`)}}function unconvert(info,value,mapper){switch(info.type){case MappingType.Mapped:return mapper.thingForIdentifier(value);case MappingType.LocalMapped:return value;case MappingType.RemoteMapped:return mapper.thingForIdentifier(value);case MappingType.Direct:return value;case MappingType.ObjectMap:{const r=new Map;for(const key of Object.keys(value))r.set(unconvert(info.key,key,mapper),unconvert(info.value,value[key],mapper));return r}case MappingType.List:return value.map(v=>unconvert(info.value,v,mapper));case MappingType.ByLiteral:return info.converter.fromLiteral(value);default:throw new Error(`Can't yet recieve MappingType ${info.type}`)}}class PECOuterPort extends APIPort{constructor(messagePort,arc){super(messagePort,"o"),this.inspector=arc.inspector,this.inspector&&this.inspector.onceActive.then(()=>this.DevToolsConnected())}Stop(){}DefineHandle(store,type,name){}InstantiateParticle(particle,id,spec,stores){}UIEvent(particle,slotName,event){}SimpleCallback(callback,data){}AwaitIdle(version){}StartRender(particle,slotName,providedSlots,contentTypes){}StopRender(particle,slotName){}GetBackingStoreCallback(store,callback,type,name,id,storageKey){}ConstructArcCallback(callback,arc){}CreateHandleCallback(handle,callback,type,name,id){}MapHandleCallback(newHandle,callback,id){}CreateSlotCallback(slot,callback,hostedSlotId){}InnerArcRender(transformationParticle,transformationSlotName,hostedSlotId,content){}DevToolsConnected(){}}var value;__decorate([NoArgs],PECOuterPort.prototype,"Stop",null),__decorate([__param(0,function(target,propertyKey,parameterIndex){set(target.constructor,propertyKey,parameterIndex,{type:MappingType.Direct,initializer:!0,redundant:!0})}),__param(1,ByLiteral(_type_js__WEBPACK_IMPORTED_MODULE_2__.Type)),__param(2,Direct)],PECOuterPort.prototype,"DefineHandle",null),__decorate([__param(0,Initializer),__param(1,Identifier),__param(1,Direct),__param(2,ByLiteral(_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__.ParticleSpec)),__param(3,ObjectMap(MappingType.Direct,MappingType.Mapped))],PECOuterPort.prototype,"InstantiateParticle",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,Direct)],PECOuterPort.prototype,"UIEvent",null),__decorate([__param(0,RemoteMapped),__param(1,Direct)],PECOuterPort.prototype,"SimpleCallback",null),__decorate([__param(0,Direct)],PECOuterPort.prototype,"AwaitIdle",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,ObjectMap(MappingType.Direct,MappingType.Direct)),__param(3,(value=MappingType.Direct,(target,propertyKey,parameterIndex)=>{const info={type:MappingType.List,value:{type:value}};set(target.constructor,propertyKey,parameterIndex,info)}))],PECOuterPort.prototype,"StartRender",null),__decorate([__param(0,Mapped),__param(1,Direct)],PECOuterPort.prototype,"StopRender",null),__decorate([__param(0,Initializer),__param(1,RemoteMapped),__param(2,ByLiteral(_type_js__WEBPACK_IMPORTED_MODULE_2__.Type)),__param(3,Direct),__param(4,Identifier),__param(4,Direct),__param(5,Direct)],PECOuterPort.prototype,"GetBackingStoreCallback",null),__decorate([__param(0,RemoteMapped),__param(1,LocalMapped)],PECOuterPort.prototype,"ConstructArcCallback",null),__decorate([__param(0,Initializer),__param(1,RemoteMapped),__param(2,ByLiteral(_type_js__WEBPACK_IMPORTED_MODULE_2__.Type)),__param(3,Direct),__param(4,Identifier),__param(4,Direct)],PECOuterPort.prototype,"CreateHandleCallback",null),__decorate([__param(0,RemoteIgnore),__param(0,Initializer),__param(1,RemoteMapped),__param(2,Direct)],PECOuterPort.prototype,"MapHandleCallback",null),__decorate([__param(0,RemoteIgnore),__param(0,Initializer),__param(1,RemoteMapped),__param(2,Direct)],PECOuterPort.prototype,"CreateSlotCallback",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,Direct),__param(3,Direct)],PECOuterPort.prototype,"InnerArcRender",null),__decorate([NoArgs],PECOuterPort.prototype,"DevToolsConnected",null);let PECInnerPort=class extends APIPort{constructor(messagePort){super(messagePort,"i")}Render(particle,slotName,content){}InitializeProxy(handle,callback){}SynchronizeProxy(handle,callback){}HandleGet(handle,callback){}HandleToList(handle,callback){}HandleSet(handle,data,particleId,barrier){}HandleClear(handle,particleId,barrier){}HandleStore(handle,callback,data,particleId){}HandleRemove(handle,callback,data,particleId){}HandleRemoveMultiple(handle,callback,data,particleId){}HandleStream(handle,callback,pageSize,forward){}StreamCursorNext(handle,callback,cursorId){}StreamCursorClose(handle,cursorId){}Idle(version,relevance){}GetBackingStore(callback,storageKey,type){}ConstructInnerArc(callback,particle){}ArcCreateHandle(callback,arc,type,name){}ArcMapHandle(callback,arc,handle){}ServiceRequest(particle,content,callback){}ArcCreateSlot(callback,arc,transformationParticle,transformationSlotName,handleId){}ArcLoadRecipe(arc,recipe,callback){}ReportExceptionInHost(exception){}onDevToolsConnected(){this.attachStack=!0}};var target;__decorate([__param(0,Mapped),__param(1,Direct),__param(2,Direct)],PECInnerPort.prototype,"Render",null),__decorate([__param(0,Mapped),__param(1,LocalMapped)],PECInnerPort.prototype,"InitializeProxy",null),__decorate([__param(0,Mapped),__param(1,LocalMapped)],PECInnerPort.prototype,"SynchronizeProxy",null),__decorate([__param(0,Mapped),__param(1,LocalMapped)],PECInnerPort.prototype,"HandleGet",null),__decorate([__param(0,Mapped),__param(1,LocalMapped)],PECInnerPort.prototype,"HandleToList",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,Direct),__param(3,Direct)],PECInnerPort.prototype,"HandleSet",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,Direct)],PECInnerPort.prototype,"HandleClear",null),__decorate([__param(0,Mapped),__param(1,LocalMapped),__param(2,Direct),__param(3,Direct)],PECInnerPort.prototype,"HandleStore",null),__decorate([__param(0,Mapped),__param(1,LocalMapped),__param(2,Direct),__param(3,Direct)],PECInnerPort.prototype,"HandleRemove",null),__decorate([__param(0,Mapped),__param(1,LocalMapped),__param(2,Direct),__param(3,Direct)],PECInnerPort.prototype,"HandleRemoveMultiple",null),__decorate([__param(0,Mapped),__param(1,LocalMapped),__param(2,Direct),__param(3,Direct)],PECInnerPort.prototype,"HandleStream",null),__decorate([__param(0,Mapped),__param(1,LocalMapped),__param(2,Direct)],PECInnerPort.prototype,"StreamCursorNext",null),__decorate([__param(0,Mapped),__param(1,Direct)],PECInnerPort.prototype,"StreamCursorClose",null),__decorate([__param(0,Direct),__param(1,ObjectMap(MappingType.Mapped,MappingType.Direct))],PECInnerPort.prototype,"Idle",null),__decorate([__param(0,LocalMapped),__param(1,Direct),__param(2,ByLiteral(_type_js__WEBPACK_IMPORTED_MODULE_2__.Type))],PECInnerPort.prototype,"GetBackingStore",null),__decorate([__param(0,LocalMapped),__param(1,Mapped)],PECInnerPort.prototype,"ConstructInnerArc",null),__decorate([__param(0,LocalMapped),__param(1,RemoteMapped),__param(2,ByLiteral(_type_js__WEBPACK_IMPORTED_MODULE_2__.Type)),__param(3,Direct)],PECInnerPort.prototype,"ArcCreateHandle",null),__decorate([__param(0,LocalMapped),__param(1,RemoteMapped),__param(2,Mapped)],PECInnerPort.prototype,"ArcMapHandle",null),__decorate([__param(0,Mapped),__param(1,Direct),__param(2,LocalMapped)],PECInnerPort.prototype,"ServiceRequest",null),__decorate([__param(0,LocalMapped),__param(1,RemoteMapped),__param(2,Mapped),__param(3,Direct),__param(4,Direct)],PECInnerPort.prototype,"ArcCreateSlot",null),__decorate([__param(0,RemoteMapped),__param(1,Direct),__param(2,LocalMapped)],PECInnerPort.prototype,"ArcLoadRecipe",null),__decorate([__param(0,ByLiteral(_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_3__.PropagatedException))],PECInnerPort.prototype,"ReportExceptionInHost",null),PECInnerPort=__decorate([(target=PECOuterPort,constructor=>{const doConstruct=(me,other)=>{const functions=targets.get(me);for(const f of functions.keys()){const argNames=getArgs(me.prototype[f]),descriptor=functions.get(f),initializer=descriptor.findIndex(d=>d.initializer),requestedId=descriptor.findIndex(d=>d.identifier),impl=function(...args){const messageBody={};for(let i=0;i<descriptor.length;i++)i!==initializer&&(messageBody[argNames[i]]=convert(descriptor[i],args[i],this._mapper));-1!==initializer&&(descriptor[initializer].redundant?(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(-1===requestedId),messageBody.identifier=this._mapper.maybeCreateMappingForThing(args[initializer])):messageBody.identifier=this._mapper.createMappingForThing(args[initializer],args[requestedId])),this.send(f,messageBody)},before=async function(messageBody){const args=[],promises=[];for(let i=0;i<descriptor.length;i++){if(i===initializer&&(-1!==requestedId||descriptor[i].ignore))continue;const argName=i===initializer?"identifier":argNames[i],result=unconvert(descriptor[i],messageBody[argName],this._mapper);result instanceof Promise?(promises.push({promise:result,position:args.length}),args.push(()=>unconvert(descriptor[i],messageBody[argName],this._mapper))):args.push(result)}promises.length>0&&(await Promise.all(promises.map(a=>a.promise)),promises.forEach(a=>args[a.position]=args[a.position]()));const result=this["on"+f](...args);initializer>-1&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(messageBody.identifier),await this._mapper.establishThingMapping(messageBody.identifier,result))};Object.defineProperty(me.prototype,f,{get:()=>impl}),Object.defineProperty(other.prototype,"before"+f,{get:()=>before})}};doConstruct(constructor,target),doConstruct(target,constructor)})],PECInnerPort)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotProxy",function(){return SlotProxy});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class SlotProxy{constructor(apiPort,particle,slotName,providedSlots){this.handlers=new Map,this.requestedContentTypes=new Set,this._isRendered=!1,this.apiPort=apiPort,this.slotName=slotName,this.particle=particle,this.providedSlots=providedSlots}get isRendered(){return this._isRendered}render(content){this.apiPort.Render(this.particle,this.slotName,content),Object.keys(content).forEach(key=>{this.requestedContentTypes.delete(key)}),this._isRendered=0===this.requestedContentTypes.size&&Object.keys(content).length>0}registerEventHandler(name,f){this.handlers.has(name)||this.handlers.set(name,[]),this.handlers.get(name).push(f)}clearEventHandlers(name){this.handlers.set(name,[])}fireEvent(event){for(const handler of this.handlers.get(event.handler)||[])handler(event)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StorageProxy",function(){return StorageProxy}),__webpack_require__.d(__webpack_exports__,"CollectionProxy",function(){return CollectionProxy}),__webpack_require__.d(__webpack_exports__,"VariableProxy",function(){return VariableProxy}),__webpack_require__.d(__webpack_exports__,"BigCollectionProxy",function(){return BigCollectionProxy}),__webpack_require__.d(__webpack_exports__,"StorageProxyScheduler",function(){return StorageProxyScheduler});var SyncState,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(72),_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(26),_storage_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(34),_type_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(18),_id_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(29);!function(SyncState){SyncState[SyncState.none=0]="none",SyncState[SyncState.pending=1]="pending",SyncState[SyncState.full=2]="full"}(SyncState||(SyncState={}));class StorageProxy{constructor(id,type,port,pec,scheduler,name){this.version=void 0,this.listenerAttached=!1,this.keepSynced=!1,this.synchronized=SyncState.none,this.observers=[],this.updates=[],this.barrier=null,this.id=id,this.type=type,this.port=port,this.scheduler=scheduler,this.name=name,this.updates=[],this.pec=pec}static newProxy(id,type,port,pec,scheduler,name){return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.CollectionType?new CollectionProxy(id,type,port,pec,scheduler,name):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.BigCollectionType?new BigCollectionProxy(id,type,port,pec,scheduler,name):new VariableProxy(id,type,port,pec,scheduler,name)}reportExceptionInHost(exception){_platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_1__.mapStackTrace?Object(_platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_1__.mapStackTrace)(exception.cause.stack,mappedStack=>{exception.cause.stack=mappedStack,this.port.ReportExceptionInHost(exception)}):this.port.ReportExceptionInHost(exception)}register(particle,handle){if(handle.canRead&&(this.observers.push({particle:particle,handle:handle}),this.listenerAttached||(this.port.InitializeProxy(this,x=>this._onUpdate(x)),this.listenerAttached=!0),handle.options.keepSynced&&(this.keepSynced||(this.port.SynchronizeProxy(this,x=>this._onSynchronize(x)),this.keepSynced=!0),handle.options.notifySync&&this.synchronized===SyncState.full))){const syncModel=this._getModelForSync();this.scheduler.enqueue(particle,handle,["sync",particle,syncModel])}}_onSynchronize({version:version,model:model}){if(void 0!==this.version&&version<=this.version)return void console.warn(`StorageProxy '${this.id}' received stale model version ${version}; `+`current is ${this.version}`);if(!this._synchronizeModel(version,model))return;for(this.synchronized=SyncState.full;this.updates.length>0&&this.updates[0].version<=version;)this.updates.shift();const syncModel=this._getModelForSync();this._notify("sync",syncModel,options=>options.keepSynced&&options.notifySync),this._processUpdates()}_onUpdate(update){if(this.observers.find(({handle:handle})=>!handle.options.keepSynced&&handle.options.notifyUpdate)){const handleUpdate=this._processUpdate(update,!1);this._notify("update",handleUpdate,options=>!options.keepSynced&&options.notifyUpdate)}this.keepSynced&&(update.version<=this.version?console.warn(`StorageProxy '${this.id}' received stale update version ${update.version}; `+`current is ${this.version}`):(this.updates.push(update),this.updates.sort((a,b)=>a.version-b.version),this._processUpdates()))}_notify(kind,details,predicate=(ignored=>!0)){for(const{handle:handle,particle:particle}of this.observers)predicate(handle.options)&&this.scheduler.enqueue(particle,handle,[kind,particle,details])}_processUpdates(){const updateIsNext=update=>update.version===this.version+1||!(!this.barrier||update.barrier!==this.barrier);for(;this.updates.length>0&&updateIsNext(this.updates[0]);){const update=this.updates.shift(),handleUpdate=this._processUpdate(update);this.version=update.version,handleUpdate&&this._notify("update",handleUpdate,options=>options.keepSynced&&options.notifyUpdate)}if(this.updates.length>0){if(this.synchronized!==SyncState.none){this.synchronized=SyncState.none,this.port.SynchronizeProxy(this,x=>this._onSynchronize(x));for(const{handle:handle,particle:particle}of this.observers)handle.options.notifyDesync&&this.scheduler.enqueue(particle,handle,["desync",particle,{}])}}else this.synchronized!==SyncState.full&&(this.synchronized=SyncState.full)}generateBarrier(){return this.pec.idGenerator.newChildId(_id_js__WEBPACK_IMPORTED_MODULE_5__.Id.fromString(this.id),"barrier").toString()}}class CollectionProxy extends StorageProxy{constructor(){super(...arguments),this.model=new _storage_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_3__.CrdtCollectionModel}_getModelForSync(){return this.model.toList()}_synchronizeModel(version,model){return this.version=version,this.model=new _storage_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_3__.CrdtCollectionModel(model),!0}_processUpdate(update,apply=!0){if(this.synchronized===SyncState.full)for(const{handle:handle}of this.observers)if(update.originatorId===handle._particleId)return null;const added=[],removed=[];if("add"in update)for(const{value:value,keys:keys,effective:effective}of update.add)(apply&&this.model.add(value.id,value,keys)||!apply&&effective)&&added.push(value);else{if(!("remove"in update))throw new Error(`StorageProxy received invalid update event: ${JSON.stringify(update)}`);for(const{value:value,keys:keys,effective:effective}of update.remove){const localValue=this.model.getValue(value.id);(apply&&this.model.remove(value.id,keys)||!apply&&effective)&&removed.push(localValue)}}if(added.length||removed.length){const result={originatorId:update.originatorId};return added.length&&(result.add=added),removed.length&&(result.remove=removed),result}return null}async toList(){return this.synchronized===SyncState.full?Promise.resolve(this.model.toList()):new Promise(resolve=>this.port.HandleToList(this,resolve))}async get(id){return this.synchronized===SyncState.full?Promise.resolve(this.model.getValue(id)):new Promise((resolve,reject)=>this.port.HandleToList(this,r=>resolve(r.find(entity=>entity.id===id))))}async store(value,keys,particleId){const id=value.id,data={value:value,keys:keys};if(this.port.HandleStore(this,()=>{},data,particleId),this.synchronized!==SyncState.full)return Promise.resolve();if(!this.model.add(id,value,keys))return Promise.resolve();const update={originatorId:particleId,add:[value]};return this._notify("update",update,options=>options.notifyUpdate),Promise.resolve()}async clear(particleId){this.synchronized!==SyncState.full&&this.port.HandleRemoveMultiple(this,()=>{},[],particleId);let items=this.model.toList().map(item=>({id:item.id,keys:this.model.getKeys(item.id)}));return this.port.HandleRemoveMultiple(this,()=>{},items,particleId),(items=(items=items.map(({id:id,keys:keys})=>({rawData:this.model.getValue(id).rawData,id:id,keys:keys}))).filter(item=>this.model.remove(item.id,item.keys))).length>0&&this._notify("update",{originatorId:particleId,remove:items},options=>options.notifyUpdate),Promise.resolve()}async remove(id,keys,particleId){if(this.synchronized!==SyncState.full){const data={id:id,keys:[]};return this.port.HandleRemove(this,()=>{},data,particleId),Promise.resolve()}const value=this.model.getValue(id);if(!value)return Promise.resolve();0===keys.length&&(keys=this.model.getKeys(id));const data={id:id,keys:keys};if(this.port.HandleRemove(this,()=>{},data,particleId),!this.model.remove(id,keys))return Promise.resolve();const update={originatorId:particleId,remove:[value]};return this._notify("update",update,options=>options.notifyUpdate),Promise.resolve()}}class VariableProxy extends StorageProxy{constructor(){super(...arguments),this.model=null}_getModelForSync(){return this.model}_synchronizeModel(version,model){return null==this.barrier&&(this.version=version,this.model=0===model.length?null:model[0].value,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==this.model),!0)}_processUpdate(update,apply=!0){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("data"in update),!apply)return update;if(null!=this.barrier){if(update.barrier===this.barrier&&(this.barrier=null,this.synchronized!==SyncState.full)){this.synchronized=SyncState.full;const syncModel=this._getModelForSync();this._notify("sync",syncModel,options=>options.keepSynced&&options.notifySync)}return null}const oldData=this.model;return this.model=update.data,{...update,oldData:oldData}}async get(){return this.synchronized===SyncState.full?Promise.resolve(this.model):new Promise(resolve=>this.port.HandleGet(this,resolve))}async set(entity,particleId){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==entity),JSON.stringify(this.model)===JSON.stringify(entity))return Promise.resolve();let barrier;barrier=this.listenerAttached?this.generateBarrier():null;const oldData=this.model;this.model=JSON.parse(JSON.stringify(entity)),this.barrier=barrier,this.port.HandleSet(this,entity,particleId,barrier);const update={originatorId:particleId,data:entity,oldData:oldData};return this._notify("update",update,options=>options.notifyUpdate),Promise.resolve()}async clear(particleId){if(null==this.model)return Promise.resolve();const barrier=this.generateBarrier(),oldData=this.model;this.model=null,this.barrier=barrier,this.port.HandleClear(this,particleId,barrier);const update={originatorId:particleId,data:null,oldData:oldData};return this._notify("update",update,options=>options.notifyUpdate),Promise.resolve()}}class BigCollectionProxy extends StorageProxy{register(particle,handle){handle.canRead&&this.scheduler.enqueue(particle,handle,["sync",particle,{}])}_getModelForSync(){throw new Error("_getModelForSync not implemented for BigCollectionProxy")}_processUpdate(){throw new Error("_processUpdate not implemented for BigCollectionProxy")}_synchronizeModel(){throw new Error("_synchronizeModel not implemented for BigCollectionProxy")}async get(id){throw new Error("unimplemented")}async store(value,keys,particleId){return new Promise(resolve=>this.port.HandleStore(this,resolve,{value:value,keys:keys},particleId))}async remove(id,keys,particleId){return new Promise(resolve=>this.port.HandleRemove(this,resolve,{id:id,keys:[]},particleId))}async stream(pageSize,forward){return new Promise(resolve=>this.port.HandleStream(this,resolve,pageSize,forward))}async cursorNext(cursorId){return new Promise(resolve=>this.port.StreamCursorNext(this,resolve,cursorId))}async cursorClose(cursorId){return this.port.StreamCursorClose(this,cursorId),Promise.resolve()}}class StorageProxyScheduler{constructor(){this._scheduled=!1,this._queues=new Map,this._idleResolver=null,this._idle=null,this._scheduled=!1,this._queues=new Map}enqueue(particle,handle,args){this._queues.has(particle)||this._queues.set(particle,new Map);const byHandle=this._queues.get(particle);byHandle.has(handle)||byHandle.set(handle,[]),byHandle.get(handle).push(args),this._schedule()}get busy(){return this._queues.size>0}_updateIdle(){this._idleResolver&&!this.busy&&(this._idleResolver(),this._idle=null,this._idleResolver=null)}get idle(){return this.busy?(this._idle||(this._idle=new Promise(resolve=>this._idleResolver=resolve)),this._idle):Promise.resolve()}_schedule(){this._scheduled||(this._scheduled=!0,setTimeout(()=>{this._scheduled=!1,this._dispatch()},0))}_dispatch(){for(;this._queues.size>0;){const particle=[...this._queues.keys()][0],byHandle=this._queues.get(particle);this._queues.delete(particle);for(const[handle,queue]of byHandle.entries())for(const args of queue)try{handle._notify(...args)}catch(e){console.error("Error dispatching to particle",e),handle.storage.reportExceptionInHost(new _arc_exceptions_js__WEBPACK_IMPORTED_MODULE_2__.SystemException(e,handle._particleId,"StorageProxyScheduler::_dispatch"))}}this._updateIdle()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"mapStackTrace",function(){return mapStackTrace});const mapStackTrace=window.sourceMappedStackTrace&&window.sourceMappedStackTrace.mapStackTrace},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"toProtoJSON",function(){return toProtoJSON}),__webpack_require__.d(__webpack_exports__,"EntityProtoConverter",function(){return EntityProtoConverter}),__webpack_require__.d(__webpack_exports__,"EntityPackager",function(){return EntityPackager}),__webpack_require__.d(__webpack_exports__,"WasmParticle",function(){return WasmParticle});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_protobufjs_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(74),_particle_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(63),_handle_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(25);
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
function jsonBaseType(type){const kind="schema-primitive"===type.kind?type.type:type.kind;switch(kind){case"Text":return"string";case"URL":return"Url";case"Number":return"double";case"Boolean":return"bool";case"Bytes":case"Object":case"schema-union":case"schema-tuple":case"schema-reference":throw new Error(`'${kind}' not yet supported for schema to proto-json conversion`);case"schema-collection":throw new Error("Nested collections not yet supported for schema to proto-json conversion");default:throw new Error(`Unknown type '${kind}' in schema`)}}function toProtoJSON(schema){let id=0,hasUrl=!1;const fields={};for(const[name,type]of Object.entries(schema.fields).sort()){let field;id++,field="schema-collection"===type.kind?{rule:"repeated",type:jsonBaseType(type.schema),id:id}:{type:jsonBaseType(type),id:id},hasUrl=hasUrl||"Url"===field.type,fields[name]=field}const json={nested:{[schema.name]:{fields:fields}}};return hasUrl&&(json.nested.Url={fields:{href:{type:"string",id:1}}}),json}class EntityProtoConverter{constructor(schema){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(schema.names.length>0,"At least one schema name is required for proto conversion");const protoRoot=_platform_protobufjs_web_js__WEBPACK_IMPORTED_MODULE_1__.protobufjs.Root.fromJSON(toProtoJSON(schema));this.schema=schema,this.message=protoRoot.lookupType(schema.name)}encode(entity){const proto=this.message.create(),scalar=(field,value)=>"URL"===field.type?{href:value}:value;for(const[name,value]of Object.entries(entity.toLiteral())){const field=this.schema.fields[name];"schema-collection"===field.kind?proto[name]=[...value].map(v=>scalar(field.schema,v)):proto[name]=scalar(field,value)}return this.message.encode(proto).finish()}decode(buffer){const proto=this.message.decode(buffer),scalar=(field,value)=>"URL"===field.type?value.href:value,data={};for(const[name,value]of Object.entries(proto.toJSON())){const field=this.schema.fields[name];"schema-collection"===field.kind?data[name]=value.map(v=>scalar(field.schema,v)):data[name]=scalar(field,value)}return new(this.schema.entityClass())(data)}}class EntityPackager{constructor(schema){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(schema.names.length>0,"At least one schema name is required for entity packaging"),this.schema=schema}encode(entity){let encoded="";for(const[name,value]of Object.entries(entity.toLiteral()))encoded+=this.encodeField(this.schema.fields[name],name,value);return encoded}encodeField(field,name,value){switch(field.kind){case"schema-primitive":return name+":"+field.type.substr(0,1)+this.encodeValue(field.type,value)+"|";case"schema-collection":{if("schema-primitive"!==field.schema.kind)throw new Error(`Collections of type '${field.schema.kind}' not yet supported for entity packaging`);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(value instanceof Set);let encoded=name+":C"+field.schema.type.slice(0,1)+value.size+":";for(const item of value)encoded+=this.encodeValue(field.schema.type,item);return encoded+"|"}case"schema-union":case"schema-tuple":case"schema-reference":throw new Error(`'${field.kind}' not yet supported for entity packaging`);default:throw new Error(`Unknown field kind '${field.kind}' in schema`)}}encodeValue(type,value){switch(type){case"Text":case"URL":return value.length+":"+value;case"Number":return value+":";case"Boolean":return value?"1":"0";case"Bytes":case"Object":throw new Error(`'${type}' not yet supported for entity packaging`);default:throw new Error(`Unknown primitive value type '${type}' in schema`)}}decode(str){const data=new StringDecoder(str).decode();return new(this.schema.entityClass())(data)}}class StringDecoder{constructor(str){this.str=str}decode(){const data={};for(;!this.done();){const name=this.upTo(":"),typeChar=this.chomp(1);if("C"===typeChar){const items=new Set,containedType=this.chomp(1),size=Number(this.upTo(":"));for(let i=0;i<size;i++)items.add(this.decodeValue(containedType));data[name]=items}else data[name]=this.decodeValue(typeChar);this.validate("|")}return data}done(){return 0===this.str.length}upTo(char){const i=this.str.indexOf(char);if(i<0)throw new Error(`Packaged entity decoding fail: expected '${char}' separator in '${this.str}'`);const token=this.str.slice(0,i);return this.str=this.str.slice(i+1),token}chomp(len){if(len>this.str.length)throw new Error(`Packaged entity decoding fail: expected '${len}' chars to remain in '${this.str}'`);const token=this.str.slice(0,len);return this.str=this.str.slice(len),token}validate(token){if(this.chomp(token.length)!==token)throw new Error(`Packaged entity decoding fail: expected '${token}' at start of '${this.str}'`)}decodeValue(typeChar){switch(typeChar){case"T":case"U":{const len=Number(this.upTo(":"));return this.chomp(len)}case"N":return Number(this.upTo(":"));case"B":return Boolean("1"===this.chomp(1));default:throw new Error(`Packaged entity decoding fail: unknown or unsupported primitive value type '${typeChar}'`)}}}function errFunc(label){return err=>{throw new Error(label+": "+err)}}function returnZero(){return 0}class WasmParticle extends _particle_js__WEBPACK_IMPORTED_MODULE_2__.Particle{constructor(){super(...arguments),this.handleMap=new Map,this.revHandleMap=new Map,this.converters=new Map,this.logInfo=null}async initialize(buffer){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.spec.name.length>0),this.memory=new WebAssembly.Memory({initial:256,maximum:256}),this.heap=new Uint8Array(this.memory.buffer);const env={memory:this.memory,__memory_base:1024,table:new WebAssembly.Table({initial:1,maximum:1,element:"anyfunc"}),__table_base:0,DYNAMICTOP_PTR:4096,_emscripten_get_heap_size:()=>this.heap.length,_emscripten_resize_heap:size=>!1,_emscripten_memcpy_big:(dst,src,num)=>this.heap.set(this.heap.subarray(src,src+num),dst),abort:errFunc("abort"),_abort:errFunc("_abort"),___assert_fail:errFunc("___assert_fail"),___setErrNo:errFunc("___setErrNo"),abortOnCannotGrowMemory:errFunc("abortOnCannotGrowMemory"),___cxa_throw:errFunc("___cxa_throw"),___cxa_allocate_exception:errFunc("___cxa_allocate_exception"),___cxa_uncaught_exception:errFunc("___cxa_uncaught_exception"),_handleSet:async(wasmHandle,encoded)=>this.setVariable(wasmHandle,encoded),_render:(slotName,content)=>this.renderImpl(slotName,content),__setLogInfo:(file,line)=>this.logInfo=[this.readString(file),line],___syscall146:(which,varargs)=>this.sysWritev(which,varargs),___syscall140:returnZero,___syscall6:returnZero,___syscall54:returnZero},global={NaN:NaN,Infinity:1/0};try{this.wasm=await WebAssembly.instantiate(buffer,{env:env,global:global})}catch(err){const match=err.message.match(/table import .* initial ([0-9]+)/);if(!match)throw err;const n=Number(match[1]);env.table=new WebAssembly.Table({initial:n,maximum:n,element:"anyfunc"}),this.wasm=await WebAssembly.instantiate(buffer,{env:env,global:global})}this.exports=this.wasm.instance.exports,this.innerParticle=this.exports[`_new${this.spec.name}`](),console.clear()}async setHandles(handles){for(const[name,handle]of handles){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handle instanceof _handle_js__WEBPACK_IMPORTED_MODULE_3__.Variable);const p=this.storeString(name),wasmHandle=this.exports._newHandle(this.innerParticle,p);this.handleMap.set(handle,wasmHandle),this.revHandleMap.set(wasmHandle,handle)}this.exports._initParticle(this.innerParticle)}async onHandleSync(handle,model){if(model){const converter=this.getOrCreateConverter(handle),p=this.storeString(converter.encode(model));this.exports._syncHandle(this.innerParticle,this.handleMap.get(handle),p),this.exports._free(p)}else this.exports._syncHandle(this.innerParticle,this.handleMap.get(handle),0)}async onHandleUpdate(handle,update){}async onHandleDesync(handle){}async setVariable(wasmHandle,encoded){const handle=this.revHandleMap.get(wasmHandle),payload=this.readString(encoded),converter=this.getOrCreateConverter(handle);console.log(`Received on '${handle.name}' handle: ${payload}`);const entity=converter.decode(payload);await handle.set(entity)}renderSlot(slotName,contentTypes){const p=this.storeString(slotName);this.exports._requestRender(this.innerParticle,p),this.exports._free(p)}renderHostedSlot(slotName,hostedSlotId,content){}renderImpl(slotName,content){const slot=this.slotProxiesByName.get(this.readString(slotName));slot&&(["template","model"].forEach(ct=>slot.requestedContentTypes.add(ct)),slot.render({template:this.readString(content),model:{},templateName:"default"}))}fireEvent(slotName,event){const sp=this.storeString(slotName),hp=this.storeString(event.handler);this.exports._fireEvent(this.innerParticle,sp,hp),this.exports._free(sp),this.exports._free(hp)}getOrCreateConverter(handle){const schema=handle.entityClass.schema;let converter=this.converters.get(schema);return converter||(converter=new EntityPackager(schema),this.converters.set(schema,converter)),converter}storeBuffer(buf){const p=this.exports._malloc(buf.length);return this.heap.set(buf,p),p}storeString(str){const p=this.exports._malloc(str.length+1);for(let i=0;i<str.length;i++)this.heap[p+i]=str.charCodeAt(i);return this.heap[p+str.length]=0,p}readString(idx){let str="";for(;idx<this.heap.length&&0!==this.heap[idx];)str+=String.fromCharCode(this.heap[idx++]);return str}sysWritev(which,varargs){const heap32=new Int32Array(this.memory.buffer),get=()=>heap32[(varargs+=4)-4>>2],output=1===get()?console.log:console.error,iov=get(),iovcnt=get();let str=this.logInfo?`[${this.spec.name}|${this.logInfo[0]}:${this.logInfo[1]}] `:"",ret=0;for(let i=0;i<iovcnt;i++){const ptr=heap32[iov+8*i>>2],len=heap32[iov+(8*i+4)>>2];for(let j=0;j<len;j++){const curr=this.heap[ptr+j];0===curr||10===curr?(output(str),str=""):str+=String.fromCharCode(curr)}ret+=len}return this.logInfo=null,ret}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _node_modules_protobufjs_dist_protobuf_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(75);__webpack_require__.d(__webpack_exports__,"protobufjs",function(){return _node_modules_protobufjs_dist_protobuf_js__WEBPACK_IMPORTED_MODULE_0__})},function(module,exports,__webpack_require__){(function(global,module){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;
/*!
 * protobuf.js v6.8.8 (c) 2016, daniel wirtz
 * compiled thu, 19 jul 2018 00:33:25 utc
 * licensed under the bsd-3-clause license
 * see: https://github.com/dcodeio/protobuf.js for details
 */
/*!
 * protobuf.js v6.8.8 (c) 2016, daniel wirtz
 * compiled thu, 19 jul 2018 00:33:25 utc
 * licensed under the bsd-3-clause license
 * see: https://github.com/dcodeio/protobuf.js for details
 */
!function(undefined){"use strict";!function(modules,cache,entries){var protobuf=function $require(name){var $module=cache[name];return $module||modules[name][0].call($module=cache[name]={exports:{}},$require,$module,$module.exports),$module.exports}(entries[0]);protobuf.util.global.protobuf=protobuf,__WEBPACK_AMD_DEFINE_ARRAY__=[__webpack_require__(77)],(__WEBPACK_AMD_DEFINE_RESULT__=function(Long){return Long&&Long.isLong&&(protobuf.util.Long=Long,protobuf.configure()),protobuf}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__))===undefined||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__),module&&module.exports&&(module.exports=protobuf)}({1:[function(require,module,exports){module.exports=function(fn,ctx){var params=new Array(arguments.length-1),offset=0,index=2,pending=!0;for(;index<arguments.length;)params[offset++]=arguments[index++];return new Promise(function(resolve,reject){params[offset]=function(err){if(pending)if(pending=!1,err)reject(err);else{for(var params=new Array(arguments.length-1),offset=0;offset<params.length;)params[offset++]=arguments[offset];resolve.apply(null,params)}};try{fn.apply(ctx||null,params)}catch(err){pending&&(pending=!1,reject(err))}})}},{}],2:[function(require,module,exports){var base64=exports;base64.length=function(string){var p=string.length;if(!p)return 0;for(var n=0;--p%4>1&&"="===string.charAt(p);)++n;return Math.ceil(3*string.length)/4-n};for(var b64=new Array(64),s64=new Array(123),i=0;i<64;)s64[b64[i]=i<26?i+65:i<52?i+71:i<62?i-4:i-59|43]=i++;base64.encode=function(buffer,start,end){for(var t,parts=null,chunk=[],i=0,j=0;start<end;){var b=buffer[start++];switch(j){case 0:chunk[i++]=b64[b>>2],t=(3&b)<<4,j=1;break;case 1:chunk[i++]=b64[t|b>>4],t=(15&b)<<2,j=2;break;case 2:chunk[i++]=b64[t|b>>6],chunk[i++]=b64[63&b],j=0}i>8191&&((parts||(parts=[])).push(String.fromCharCode.apply(String,chunk)),i=0)}return j&&(chunk[i++]=b64[t],chunk[i++]=61,1===j&&(chunk[i++]=61)),parts?(i&&parts.push(String.fromCharCode.apply(String,chunk.slice(0,i))),parts.join("")):String.fromCharCode.apply(String,chunk.slice(0,i))};base64.decode=function(string,buffer,offset){for(var t,start=offset,j=0,i=0;i<string.length;){var c=string.charCodeAt(i++);if(61===c&&j>1)break;if((c=s64[c])===undefined)throw Error("invalid encoding");switch(j){case 0:t=c,j=1;break;case 1:buffer[offset++]=t<<2|(48&c)>>4,t=c,j=2;break;case 2:buffer[offset++]=(15&t)<<4|(60&c)>>2,t=c,j=3;break;case 3:buffer[offset++]=(3&t)<<6|c,j=0}}if(1===j)throw Error("invalid encoding");return offset-start},base64.test=function(string){return/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(string)}},{}],3:[function(require,module,exports){function codegen(functionParams,functionName){"string"==typeof functionParams&&(functionName=functionParams,functionParams=undefined);var body=[];function Codegen(formatStringOrScope){if("string"!=typeof formatStringOrScope){var source=toString();if(codegen.verbose&&console.log("codegen: "+source),source="return "+source,formatStringOrScope){for(var scopeKeys=Object.keys(formatStringOrScope),scopeParams=new Array(scopeKeys.length+1),scopeValues=new Array(scopeKeys.length),scopeOffset=0;scopeOffset<scopeKeys.length;)scopeParams[scopeOffset]=scopeKeys[scopeOffset],scopeValues[scopeOffset]=formatStringOrScope[scopeKeys[scopeOffset++]];return scopeParams[scopeOffset]=source,Function.apply(null,scopeParams).apply(null,scopeValues)}return Function(source)()}for(var formatParams=new Array(arguments.length-1),formatOffset=0;formatOffset<formatParams.length;)formatParams[formatOffset]=arguments[++formatOffset];if(formatOffset=0,formatStringOrScope=formatStringOrScope.replace(/%([%dfijs])/g,function($0,$1){var value=formatParams[formatOffset++];switch($1){case"d":case"f":return String(Number(value));case"i":return String(Math.floor(value));case"j":return JSON.stringify(value);case"s":return String(value)}return"%"}),formatOffset!==formatParams.length)throw Error("parameter count mismatch");return body.push(formatStringOrScope),Codegen}function toString(functionNameOverride){return"function "+(functionNameOverride||functionName||"")+"("+(functionParams&&functionParams.join(",")||"")+"){\n  "+body.join("\n  ")+"\n}"}return Codegen.toString=toString,Codegen}module.exports=codegen,codegen.verbose=!1},{}],4:[function(require,module,exports){function EventEmitter(){this._listeners={}}module.exports=EventEmitter,EventEmitter.prototype.on=function(evt,fn,ctx){return(this._listeners[evt]||(this._listeners[evt]=[])).push({fn:fn,ctx:ctx||this}),this},EventEmitter.prototype.off=function(evt,fn){if(evt===undefined)this._listeners={};else if(fn===undefined)this._listeners[evt]=[];else for(var listeners=this._listeners[evt],i=0;i<listeners.length;)listeners[i].fn===fn?listeners.splice(i,1):++i;return this},EventEmitter.prototype.emit=function(evt){var listeners=this._listeners[evt];if(listeners){for(var args=[],i=1;i<arguments.length;)args.push(arguments[i++]);for(i=0;i<listeners.length;)listeners[i].fn.apply(listeners[i++].ctx,args)}return this}},{}],5:[function(require,module,exports){module.exports=fetch;var asPromise=require(1),fs=require(7)("fs");function fetch(filename,options,callback){return"function"==typeof options?(callback=options,options={}):options||(options={}),callback?!options.xhr&&fs&&fs.readFile?fs.readFile(filename,function(err,contents){return err&&"undefined"!=typeof XMLHttpRequest?fetch.xhr(filename,options,callback):err?callback(err):callback(null,options.binary?contents:contents.toString("utf8"))}):fetch.xhr(filename,options,callback):asPromise(fetch,this,filename,options)}fetch.xhr=function(filename,options,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(4!==xhr.readyState)return undefined;if(0!==xhr.status&&200!==xhr.status)return callback(Error("status "+xhr.status));if(options.binary){var buffer=xhr.response;if(!buffer){buffer=[];for(var i=0;i<xhr.responseText.length;++i)buffer.push(255&xhr.responseText.charCodeAt(i))}return callback(null,"undefined"!=typeof Uint8Array?new Uint8Array(buffer):buffer)}return callback(null,xhr.responseText)},options.binary&&("overrideMimeType"in xhr&&xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.responseType="arraybuffer"),xhr.open("GET",filename),xhr.send()}},{1:1,7:7}],6:[function(require,module,exports){function factory(exports){return"undefined"!=typeof Float32Array?function(){var f32=new Float32Array([-0]),f8b=new Uint8Array(f32.buffer),le=128===f8b[3];function writeFloat_f32_cpy(val,buf,pos){f32[0]=val,buf[pos]=f8b[0],buf[pos+1]=f8b[1],buf[pos+2]=f8b[2],buf[pos+3]=f8b[3]}function writeFloat_f32_rev(val,buf,pos){f32[0]=val,buf[pos]=f8b[3],buf[pos+1]=f8b[2],buf[pos+2]=f8b[1],buf[pos+3]=f8b[0]}function readFloat_f32_cpy(buf,pos){return f8b[0]=buf[pos],f8b[1]=buf[pos+1],f8b[2]=buf[pos+2],f8b[3]=buf[pos+3],f32[0]}function readFloat_f32_rev(buf,pos){return f8b[3]=buf[pos],f8b[2]=buf[pos+1],f8b[1]=buf[pos+2],f8b[0]=buf[pos+3],f32[0]}exports.writeFloatLE=le?writeFloat_f32_cpy:writeFloat_f32_rev,exports.writeFloatBE=le?writeFloat_f32_rev:writeFloat_f32_cpy,exports.readFloatLE=le?readFloat_f32_cpy:readFloat_f32_rev,exports.readFloatBE=le?readFloat_f32_rev:readFloat_f32_cpy}():function(){function writeFloat_ieee754(writeUint,val,buf,pos){var sign=val<0?1:0;if(sign&&(val=-val),0===val)writeUint(1/val>0?0:2147483648,buf,pos);else if(isNaN(val))writeUint(2143289344,buf,pos);else if(val>3.4028234663852886e38)writeUint((sign<<31|2139095040)>>>0,buf,pos);else if(val<1.1754943508222875e-38)writeUint((sign<<31|Math.round(val/1.401298464324817e-45))>>>0,buf,pos);else{var exponent=Math.floor(Math.log(val)/Math.LN2);writeUint((sign<<31|exponent+127<<23|8388607&Math.round(val*Math.pow(2,-exponent)*8388608))>>>0,buf,pos)}}function readFloat_ieee754(readUint,buf,pos){var uint=readUint(buf,pos),sign=2*(uint>>31)+1,exponent=uint>>>23&255,mantissa=8388607&uint;return 255===exponent?mantissa?NaN:sign*(1/0):0===exponent?1.401298464324817e-45*sign*mantissa:sign*Math.pow(2,exponent-150)*(mantissa+8388608)}exports.writeFloatLE=writeFloat_ieee754.bind(null,writeUintLE),exports.writeFloatBE=writeFloat_ieee754.bind(null,writeUintBE),exports.readFloatLE=readFloat_ieee754.bind(null,readUintLE),exports.readFloatBE=readFloat_ieee754.bind(null,readUintBE)}(),"undefined"!=typeof Float64Array?function(){var f64=new Float64Array([-0]),f8b=new Uint8Array(f64.buffer),le=128===f8b[7];function writeDouble_f64_cpy(val,buf,pos){f64[0]=val,buf[pos]=f8b[0],buf[pos+1]=f8b[1],buf[pos+2]=f8b[2],buf[pos+3]=f8b[3],buf[pos+4]=f8b[4],buf[pos+5]=f8b[5],buf[pos+6]=f8b[6],buf[pos+7]=f8b[7]}function writeDouble_f64_rev(val,buf,pos){f64[0]=val,buf[pos]=f8b[7],buf[pos+1]=f8b[6],buf[pos+2]=f8b[5],buf[pos+3]=f8b[4],buf[pos+4]=f8b[3],buf[pos+5]=f8b[2],buf[pos+6]=f8b[1],buf[pos+7]=f8b[0]}function readDouble_f64_cpy(buf,pos){return f8b[0]=buf[pos],f8b[1]=buf[pos+1],f8b[2]=buf[pos+2],f8b[3]=buf[pos+3],f8b[4]=buf[pos+4],f8b[5]=buf[pos+5],f8b[6]=buf[pos+6],f8b[7]=buf[pos+7],f64[0]}function readDouble_f64_rev(buf,pos){return f8b[7]=buf[pos],f8b[6]=buf[pos+1],f8b[5]=buf[pos+2],f8b[4]=buf[pos+3],f8b[3]=buf[pos+4],f8b[2]=buf[pos+5],f8b[1]=buf[pos+6],f8b[0]=buf[pos+7],f64[0]}exports.writeDoubleLE=le?writeDouble_f64_cpy:writeDouble_f64_rev,exports.writeDoubleBE=le?writeDouble_f64_rev:writeDouble_f64_cpy,exports.readDoubleLE=le?readDouble_f64_cpy:readDouble_f64_rev,exports.readDoubleBE=le?readDouble_f64_rev:readDouble_f64_cpy}():function(){function writeDouble_ieee754(writeUint,off0,off1,val,buf,pos){var sign=val<0?1:0;if(sign&&(val=-val),0===val)writeUint(0,buf,pos+off0),writeUint(1/val>0?0:2147483648,buf,pos+off1);else if(isNaN(val))writeUint(0,buf,pos+off0),writeUint(2146959360,buf,pos+off1);else if(val>1.7976931348623157e308)writeUint(0,buf,pos+off0),writeUint((sign<<31|2146435072)>>>0,buf,pos+off1);else{var mantissa;if(val<2.2250738585072014e-308)writeUint((mantissa=val/5e-324)>>>0,buf,pos+off0),writeUint((sign<<31|mantissa/4294967296)>>>0,buf,pos+off1);else{var exponent=Math.floor(Math.log(val)/Math.LN2);1024===exponent&&(exponent=1023),writeUint(4503599627370496*(mantissa=val*Math.pow(2,-exponent))>>>0,buf,pos+off0),writeUint((sign<<31|exponent+1023<<20|1048576*mantissa&1048575)>>>0,buf,pos+off1)}}}function readDouble_ieee754(readUint,off0,off1,buf,pos){var lo=readUint(buf,pos+off0),hi=readUint(buf,pos+off1),sign=2*(hi>>31)+1,exponent=hi>>>20&2047,mantissa=4294967296*(1048575&hi)+lo;return 2047===exponent?mantissa?NaN:sign*(1/0):0===exponent?5e-324*sign*mantissa:sign*Math.pow(2,exponent-1075)*(mantissa+4503599627370496)}exports.writeDoubleLE=writeDouble_ieee754.bind(null,writeUintLE,0,4),exports.writeDoubleBE=writeDouble_ieee754.bind(null,writeUintBE,4,0),exports.readDoubleLE=readDouble_ieee754.bind(null,readUintLE,0,4),exports.readDoubleBE=readDouble_ieee754.bind(null,readUintBE,4,0)}(),exports}function writeUintLE(val,buf,pos){buf[pos]=255&val,buf[pos+1]=val>>>8&255,buf[pos+2]=val>>>16&255,buf[pos+3]=val>>>24}function writeUintBE(val,buf,pos){buf[pos]=val>>>24,buf[pos+1]=val>>>16&255,buf[pos+2]=val>>>8&255,buf[pos+3]=255&val}function readUintLE(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16|buf[pos+3]<<24)>>>0}function readUintBE(buf,pos){return(buf[pos]<<24|buf[pos+1]<<16|buf[pos+2]<<8|buf[pos+3])>>>0}module.exports=factory(factory)},{}],7:[function(require,module,exports){function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},{}],8:[function(require,module,exports){var path=exports,isAbsolute=path.isAbsolute=function(path){return/^(?:\/|\w+:)/.test(path)},normalize=path.normalize=function(path){var parts=(path=path.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),absolute=isAbsolute(path),prefix="";absolute&&(prefix=parts.shift()+"/");for(var i=0;i<parts.length;)".."===parts[i]?i>0&&".."!==parts[i-1]?parts.splice(--i,2):absolute?parts.splice(i,1):++i:"."===parts[i]?parts.splice(i,1):++i;return prefix+parts.join("/")};path.resolve=function(originPath,includePath,alreadyNormalized){return alreadyNormalized||(includePath=normalize(includePath)),isAbsolute(includePath)?includePath:(alreadyNormalized||(originPath=normalize(originPath)),(originPath=originPath.replace(/(?:\/|^)[^\/]+$/,"")).length?normalize(originPath+"/"+includePath):includePath)}},{}],9:[function(require,module,exports){module.exports=function(alloc,slice,size){var SIZE=size||8192,MAX=SIZE>>>1,slab=null,offset=SIZE;return function(size){if(size<1||size>MAX)return alloc(size);offset+size>SIZE&&(slab=alloc(SIZE),offset=0);var buf=slice.call(slab,offset,offset+=size);return 7&offset&&(offset=1+(7|offset)),buf}}},{}],10:[function(require,module,exports){var utf8=exports;utf8.length=function(string){for(var len=0,c=0,i=0;i<string.length;++i)(c=string.charCodeAt(i))<128?len+=1:c<2048?len+=2:55296==(64512&c)&&56320==(64512&string.charCodeAt(i+1))?(++i,len+=4):len+=3;return len},utf8.read=function(buffer,start,end){if(end-start<1)return"";for(var t,parts=null,chunk=[],i=0;start<end;)(t=buffer[start++])<128?chunk[i++]=t:t>191&&t<224?chunk[i++]=(31&t)<<6|63&buffer[start++]:t>239&&t<365?(t=((7&t)<<18|(63&buffer[start++])<<12|(63&buffer[start++])<<6|63&buffer[start++])-65536,chunk[i++]=55296+(t>>10),chunk[i++]=56320+(1023&t)):chunk[i++]=(15&t)<<12|(63&buffer[start++])<<6|63&buffer[start++],i>8191&&((parts||(parts=[])).push(String.fromCharCode.apply(String,chunk)),i=0);return parts?(i&&parts.push(String.fromCharCode.apply(String,chunk.slice(0,i))),parts.join("")):String.fromCharCode.apply(String,chunk.slice(0,i))},utf8.write=function(string,buffer,offset){for(var c1,c2,start=offset,i=0;i<string.length;++i)(c1=string.charCodeAt(i))<128?buffer[offset++]=c1:c1<2048?(buffer[offset++]=c1>>6|192,buffer[offset++]=63&c1|128):55296==(64512&c1)&&56320==(64512&(c2=string.charCodeAt(i+1)))?(c1=65536+((1023&c1)<<10)+(1023&c2),++i,buffer[offset++]=c1>>18|240,buffer[offset++]=c1>>12&63|128,buffer[offset++]=c1>>6&63|128,buffer[offset++]=63&c1|128):(buffer[offset++]=c1>>12|224,buffer[offset++]=c1>>6&63|128,buffer[offset++]=63&c1|128);return offset-start}},{}],11:[function(require,module,exports){module.exports=common;var timeType,commonRe=/\/|\./;function common(name,json){commonRe.test(name)||(name="google/protobuf/"+name+".proto",json={nested:{google:{nested:{protobuf:{nested:json}}}}}),common[name]=json}common("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}}),common("duration",{Duration:timeType={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),common("timestamp",{Timestamp:timeType}),common("empty",{Empty:{fields:{}}}),common("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),common("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),common("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),common.get=function(file){return common[file]||null}},{}],12:[function(require,module,exports){var converter=exports,Enum=require(15),util=require(37);function genValuePartial_fromObject(gen,field,fieldIndex,prop){if(field.resolvedType)if(field.resolvedType instanceof Enum){gen("switch(d%s){",prop);for(var values=field.resolvedType.values,keys=Object.keys(values),i=0;i<keys.length;++i)field.repeated&&values[keys[i]]===field.typeDefault&&gen("default:"),gen("case%j:",keys[i])("case %i:",values[keys[i]])("m%s=%j",prop,values[keys[i]])("break");gen("}")}else gen('if(typeof d%s!=="object")',prop)("throw TypeError(%j)",field.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",prop,fieldIndex,prop);else{var isUnsigned=!1;switch(field.type){case"double":case"float":gen("m%s=Number(d%s)",prop,prop);break;case"uint32":case"fixed32":gen("m%s=d%s>>>0",prop,prop);break;case"int32":case"sint32":case"sfixed32":gen("m%s=d%s|0",prop,prop);break;case"uint64":isUnsigned=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":gen("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",prop,prop,isUnsigned)('else if(typeof d%s==="string")',prop)("m%s=parseInt(d%s,10)",prop,prop)('else if(typeof d%s==="number")',prop)("m%s=d%s",prop,prop)('else if(typeof d%s==="object")',prop)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",prop,prop,prop,isUnsigned?"true":"");break;case"bytes":gen('if(typeof d%s==="string")',prop)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",prop,prop,prop)("else if(d%s.length)",prop)("m%s=d%s",prop,prop);break;case"string":gen("m%s=String(d%s)",prop,prop);break;case"bool":gen("m%s=Boolean(d%s)",prop,prop)}}return gen}function genValuePartial_toObject(gen,field,fieldIndex,prop){if(field.resolvedType)field.resolvedType instanceof Enum?gen("d%s=o.enums===String?types[%i].values[m%s]:m%s",prop,fieldIndex,prop,prop):gen("d%s=types[%i].toObject(m%s,o)",prop,fieldIndex,prop);else{var isUnsigned=!1;switch(field.type){case"double":case"float":gen("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",prop,prop,prop,prop);break;case"uint64":isUnsigned=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":gen('if(typeof m%s==="number")',prop)("d%s=o.longs===String?String(m%s):m%s",prop,prop,prop)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",prop,prop,prop,prop,isUnsigned?"true":"",prop);break;case"bytes":gen("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",prop,prop,prop,prop,prop);break;default:gen("d%s=m%s",prop,prop)}}return gen}converter.fromObject=function(mtype){var fields=mtype.fieldsArray,gen=util.codegen(["d"],mtype.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!fields.length)return gen("return new this.ctor");gen("var m=new this.ctor");for(var i=0;i<fields.length;++i){var field=fields[i].resolve(),prop=util.safeProp(field.name);field.map?(gen("if(d%s){",prop)('if(typeof d%s!=="object")',prop)("throw TypeError(%j)",field.fullName+": object expected")("m%s={}",prop)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",prop),genValuePartial_fromObject(gen,field,i,prop+"[ks[i]]")("}")("}")):field.repeated?(gen("if(d%s){",prop)("if(!Array.isArray(d%s))",prop)("throw TypeError(%j)",field.fullName+": array expected")("m%s=[]",prop)("for(var i=0;i<d%s.length;++i){",prop),genValuePartial_fromObject(gen,field,i,prop+"[i]")("}")("}")):(field.resolvedType instanceof Enum||gen("if(d%s!=null){",prop),genValuePartial_fromObject(gen,field,i,prop),field.resolvedType instanceof Enum||gen("}"))}return gen("return m")},converter.toObject=function(mtype){var fields=mtype.fieldsArray.slice().sort(util.compareFieldsById);if(!fields.length)return util.codegen()("return {}");for(var gen=util.codegen(["m","o"],mtype.name+"$toObject")("if(!o)")("o={}")("var d={}"),repeatedFields=[],mapFields=[],normalFields=[],i=0;i<fields.length;++i)fields[i].partOf||(fields[i].resolve().repeated?repeatedFields:fields[i].map?mapFields:normalFields).push(fields[i]);if(repeatedFields.length){for(gen("if(o.arrays||o.defaults){"),i=0;i<repeatedFields.length;++i)gen("d%s=[]",util.safeProp(repeatedFields[i].name));gen("}")}if(mapFields.length){for(gen("if(o.objects||o.defaults){"),i=0;i<mapFields.length;++i)gen("d%s={}",util.safeProp(mapFields[i].name));gen("}")}if(normalFields.length){for(gen("if(o.defaults){"),i=0;i<normalFields.length;++i){var field=normalFields[i],prop=util.safeProp(field.name);if(field.resolvedType instanceof Enum)gen("d%s=o.enums===String?%j:%j",prop,field.resolvedType.valuesById[field.typeDefault],field.typeDefault);else if(field.long)gen("if(util.Long){")("var n=new util.Long(%i,%i,%j)",field.typeDefault.low,field.typeDefault.high,field.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",prop)("}else")("d%s=o.longs===String?%j:%i",prop,field.typeDefault.toString(),field.typeDefault.toNumber());else if(field.bytes){var arrayDefault="["+Array.prototype.slice.call(field.typeDefault).join(",")+"]";gen("if(o.bytes===String)d%s=%j",prop,String.fromCharCode.apply(String,field.typeDefault))("else{")("d%s=%s",prop,arrayDefault)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",prop,prop)("}")}else gen("d%s=%j",prop,field.typeDefault)}gen("}")}var hasKs2=!1;for(i=0;i<fields.length;++i){field=fields[i];var index=mtype._fieldsArray.indexOf(field);prop=util.safeProp(field.name);field.map?(hasKs2||(hasKs2=!0,gen("var ks2")),gen("if(m%s&&(ks2=Object.keys(m%s)).length){",prop,prop)("d%s={}",prop)("for(var j=0;j<ks2.length;++j){"),genValuePartial_toObject(gen,field,index,prop+"[ks2[j]]")("}")):field.repeated?(gen("if(m%s&&m%s.length){",prop,prop)("d%s=[]",prop)("for(var j=0;j<m%s.length;++j){",prop),genValuePartial_toObject(gen,field,index,prop+"[j]")("}")):(gen("if(m%s!=null&&m.hasOwnProperty(%j)){",prop,field.name),genValuePartial_toObject(gen,field,index,prop),field.partOf&&gen("if(o.oneofs)")("d%s=%j",util.safeProp(field.partOf.name),field.name)),gen("}")}return gen("return d")}},{15:15,37:37}],13:[function(require,module,exports){module.exports=function(mtype){var gen=util.codegen(["r","l"],mtype.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(mtype.fieldsArray.filter(function(field){return field.map}).length?",k":""))("while(r.pos<c){")("var t=r.uint32()");mtype.group&&gen("if((t&7)===4)")("break");gen("switch(t>>>3){");for(var i=0;i<mtype.fieldsArray.length;++i){var field=mtype._fieldsArray[i].resolve(),type=field.resolvedType instanceof Enum?"int32":field.type,ref="m"+util.safeProp(field.name);gen("case %i:",field.id),field.map?(gen("r.skip().pos++")("if(%s===util.emptyObject)",ref)("%s={}",ref)("k=r.%s()",field.keyType)("r.pos++"),types.long[field.keyType]!==undefined?types.basic[type]===undefined?gen('%s[typeof k==="object"?util.longToHash(k):k]=types[%i].decode(r,r.uint32())',ref,i):gen('%s[typeof k==="object"?util.longToHash(k):k]=r.%s()',ref,type):types.basic[type]===undefined?gen("%s[k]=types[%i].decode(r,r.uint32())",ref,i):gen("%s[k]=r.%s()",ref,type)):field.repeated?(gen("if(!(%s&&%s.length))",ref,ref)("%s=[]",ref),types.packed[type]!==undefined&&gen("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",ref,type)("}else"),types.basic[type]===undefined?gen(field.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",ref,i):gen("%s.push(r.%s())",ref,type)):types.basic[type]===undefined?gen(field.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",ref,i):gen("%s=r.%s()",ref,type),gen("break")}for(gen("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<mtype._fieldsArray.length;++i){var rfield=mtype._fieldsArray[i];rfield.required&&gen("if(!m.hasOwnProperty(%j))",rfield.name)("throw util.ProtocolError(%j,{instance:m})",missing(rfield))}return gen("return m")};var Enum=require(15),types=require(36),util=require(37);function missing(field){return"missing required '"+field.name+"'"}},{15:15,36:36,37:37}],14:[function(require,module,exports){module.exports=function(mtype){for(var ref,gen=util.codegen(["m","w"],mtype.name+"$encode")("if(!w)")("w=Writer.create()"),fields=mtype.fieldsArray.slice().sort(util.compareFieldsById),i=0;i<fields.length;++i){var field=fields[i].resolve(),index=mtype._fieldsArray.indexOf(field),type=field.resolvedType instanceof Enum?"int32":field.type,wireType=types.basic[type];ref="m"+util.safeProp(field.name),field.map?(gen("if(%s!=null&&m.hasOwnProperty(%j)){",ref,field.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",ref)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(field.id<<3|2)>>>0,8|types.mapKey[field.keyType],field.keyType),wireType===undefined?gen("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",index,ref):gen(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|wireType,type,ref),gen("}")("}")):field.repeated?(gen("if(%s!=null&&%s.length){",ref,ref),field.packed&&types.packed[type]!==undefined?gen("w.uint32(%i).fork()",(field.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",ref)("w.%s(%s[i])",type,ref)("w.ldelim()"):(gen("for(var i=0;i<%s.length;++i)",ref),wireType===undefined?genTypePartial(gen,field,index,ref+"[i]"):gen("w.uint32(%i).%s(%s[i])",(field.id<<3|wireType)>>>0,type,ref)),gen("}")):(field.optional&&gen("if(%s!=null&&m.hasOwnProperty(%j))",ref,field.name),wireType===undefined?genTypePartial(gen,field,index,ref):gen("w.uint32(%i).%s(%s)",(field.id<<3|wireType)>>>0,type,ref))}return gen("return w")};var Enum=require(15),types=require(36),util=require(37);function genTypePartial(gen,field,fieldIndex,ref){return field.resolvedType.group?gen("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",fieldIndex,ref,(field.id<<3|3)>>>0,(field.id<<3|4)>>>0):gen("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",fieldIndex,ref,(field.id<<3|2)>>>0)}},{15:15,36:36,37:37}],15:[function(require,module,exports){module.exports=Enum;var ReflectionObject=require(24);((Enum.prototype=Object.create(ReflectionObject.prototype)).constructor=Enum).className="Enum";var Namespace=require(23),util=require(37);function Enum(name,values,options,comment,comments){if(ReflectionObject.call(this,name,options),values&&"object"!=typeof values)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=comment,this.comments=comments||{},this.reserved=undefined,values)for(var keys=Object.keys(values),i=0;i<keys.length;++i)"number"==typeof values[keys[i]]&&(this.valuesById[this.values[keys[i]]=values[keys[i]]]=keys[i])}Enum.fromJSON=function(name,json){var enm=new Enum(name,json.values,json.options,json.comment,json.comments);return enm.reserved=json.reserved,enm},Enum.prototype.toJSON=function(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:undefined,"comment",keepComments?this.comment:undefined,"comments",keepComments?this.comments:undefined])},Enum.prototype.add=function(name,id,comment){if(!util.isString(name))throw TypeError("name must be a string");if(!util.isInteger(id))throw TypeError("id must be an integer");if(this.values[name]!==undefined)throw Error("duplicate name '"+name+"' in "+this);if(this.isReservedId(id))throw Error("id "+id+" is reserved in "+this);if(this.isReservedName(name))throw Error("name '"+name+"' is reserved in "+this);if(this.valuesById[id]!==undefined){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+id+" in "+this);this.values[name]=id}else this.valuesById[this.values[name]=id]=name;return this.comments[name]=comment||null,this},Enum.prototype.remove=function(name){if(!util.isString(name))throw TypeError("name must be a string");var val=this.values[name];if(null==val)throw Error("name '"+name+"' does not exist in "+this);return delete this.valuesById[val],delete this.values[name],delete this.comments[name],this},Enum.prototype.isReservedId=function(id){return Namespace.isReservedId(this.reserved,id)},Enum.prototype.isReservedName=function(name){return Namespace.isReservedName(this.reserved,name)}},{23:23,24:24,37:37}],16:[function(require,module,exports){module.exports=Field;var ReflectionObject=require(24);((Field.prototype=Object.create(ReflectionObject.prototype)).constructor=Field).className="Field";var Type,Enum=require(15),types=require(36),util=require(37),ruleRe=/^required|optional|repeated$/;function Field(name,id,type,rule,extend,options,comment){if(util.isObject(rule)?(comment=extend,options=rule,rule=extend=undefined):util.isObject(extend)&&(comment=options,options=extend,extend=undefined),ReflectionObject.call(this,name,options),!util.isInteger(id)||id<0)throw TypeError("id must be a non-negative integer");if(!util.isString(type))throw TypeError("type must be a string");if(rule!==undefined&&!ruleRe.test(rule=rule.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(extend!==undefined&&!util.isString(extend))throw TypeError("extend must be a string");this.rule=rule&&"optional"!==rule?rule:undefined,this.type=type,this.id=id,this.extend=extend||undefined,this.required="required"===rule,this.optional=!this.required,this.repeated="repeated"===rule,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!util.Long&&types.long[type]!==undefined,this.bytes="bytes"===type,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=comment}Field.fromJSON=function(name,json){return new Field(name,json.id,json.type,json.rule,json.extend,json.options,json.comment)},Object.defineProperty(Field.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),Field.prototype.setOption=function(name,value,ifNotSet){return"packed"===name&&(this._packed=null),ReflectionObject.prototype.setOption.call(this,name,value,ifNotSet)},Field.prototype.toJSON=function(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["rule","optional"!==this.rule&&this.rule||undefined,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",keepComments?this.comment:undefined])},Field.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=types.defaults[this.type])===undefined&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof Type?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof Enum&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(this.options.packed===undefined||!this.resolvedType||this.resolvedType instanceof Enum)||delete this.options.packed,Object.keys(this.options).length||(this.options=undefined)),this.long)this.typeDefault=util.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var buf;util.base64.test(this.typeDefault)?util.base64.decode(this.typeDefault,buf=util.newBuffer(util.base64.length(this.typeDefault)),0):util.utf8.write(this.typeDefault,buf=util.newBuffer(util.utf8.length(this.typeDefault)),0),this.typeDefault=buf}return this.map?this.defaultValue=util.emptyObject:this.repeated?this.defaultValue=util.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof Type&&(this.parent.ctor.prototype[this.name]=this.defaultValue),ReflectionObject.prototype.resolve.call(this)},Field.d=function(fieldId,fieldType,fieldRule,defaultValue){return"function"==typeof fieldType?fieldType=util.decorateType(fieldType).name:fieldType&&"object"==typeof fieldType&&(fieldType=util.decorateEnum(fieldType).name),function(prototype,fieldName){util.decorateType(prototype.constructor).add(new Field(fieldName,fieldId,fieldType,fieldRule,{default:defaultValue}))}},Field._configure=function(Type_){Type=Type_}},{15:15,24:24,36:36,37:37}],17:[function(require,module,exports){var protobuf=module.exports=require(18);protobuf.build="light",protobuf.load=function(filename,root,callback){return"function"==typeof root?(callback=root,root=new protobuf.Root):root||(root=new protobuf.Root),root.load(filename,callback)},protobuf.loadSync=function(filename,root){return root||(root=new protobuf.Root),root.loadSync(filename)},protobuf.encoder=require(14),protobuf.decoder=require(13),protobuf.verifier=require(40),protobuf.converter=require(12),protobuf.ReflectionObject=require(24),protobuf.Namespace=require(23),protobuf.Root=require(29),protobuf.Enum=require(15),protobuf.Type=require(35),protobuf.Field=require(16),protobuf.OneOf=require(25),protobuf.MapField=require(20),protobuf.Service=require(33),protobuf.Method=require(22),protobuf.Message=require(21),protobuf.wrappers=require(41),protobuf.types=require(36),protobuf.util=require(37),protobuf.ReflectionObject._configure(protobuf.Root),protobuf.Namespace._configure(protobuf.Type,protobuf.Service,protobuf.Enum),protobuf.Root._configure(protobuf.Type),protobuf.Field._configure(protobuf.Type)},{12:12,13:13,14:14,15:15,16:16,18:18,20:20,21:21,22:22,23:23,24:24,25:25,29:29,33:33,35:35,36:36,37:37,40:40,41:41}],18:[function(require,module,exports){var protobuf=exports;function configure(){protobuf.Reader._configure(protobuf.BufferReader),protobuf.util._configure()}protobuf.build="minimal",protobuf.Writer=require(42),protobuf.BufferWriter=require(43),protobuf.Reader=require(27),protobuf.BufferReader=require(28),protobuf.util=require(39),protobuf.rpc=require(31),protobuf.roots=require(30),protobuf.configure=configure,protobuf.Writer._configure(protobuf.BufferWriter),configure()},{27:27,28:28,30:30,31:31,39:39,42:42,43:43}],19:[function(require,module,exports){var protobuf=module.exports=require(17);protobuf.build="full",protobuf.tokenize=require(34),protobuf.parse=require(26),protobuf.common=require(11),protobuf.Root._configure(protobuf.Type,protobuf.parse,protobuf.common)},{11:11,17:17,26:26,34:34}],20:[function(require,module,exports){module.exports=MapField;var Field=require(16);((MapField.prototype=Object.create(Field.prototype)).constructor=MapField).className="MapField";var types=require(36),util=require(37);function MapField(name,id,keyType,type,options,comment){if(Field.call(this,name,id,type,undefined,undefined,options,comment),!util.isString(keyType))throw TypeError("keyType must be a string");this.keyType=keyType,this.resolvedKeyType=null,this.map=!0}MapField.fromJSON=function(name,json){return new MapField(name,json.id,json.keyType,json.type,json.options,json.comment)},MapField.prototype.toJSON=function(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",keepComments?this.comment:undefined])},MapField.prototype.resolve=function(){if(this.resolved)return this;if(types.mapKey[this.keyType]===undefined)throw Error("invalid key type: "+this.keyType);return Field.prototype.resolve.call(this)},MapField.d=function(fieldId,fieldKeyType,fieldValueType){return"function"==typeof fieldValueType?fieldValueType=util.decorateType(fieldValueType).name:fieldValueType&&"object"==typeof fieldValueType&&(fieldValueType=util.decorateEnum(fieldValueType).name),function(prototype,fieldName){util.decorateType(prototype.constructor).add(new MapField(fieldName,fieldId,fieldKeyType,fieldValueType))}}},{16:16,36:36,37:37}],21:[function(require,module,exports){module.exports=Message;var util=require(39);function Message(properties){if(properties)for(var keys=Object.keys(properties),i=0;i<keys.length;++i)this[keys[i]]=properties[keys[i]]}Message.create=function(properties){return this.$type.create(properties)},Message.encode=function(message,writer){return this.$type.encode(message,writer)},Message.encodeDelimited=function(message,writer){return this.$type.encodeDelimited(message,writer)},Message.decode=function(reader){return this.$type.decode(reader)},Message.decodeDelimited=function(reader){return this.$type.decodeDelimited(reader)},Message.verify=function(message){return this.$type.verify(message)},Message.fromObject=function(object){return this.$type.fromObject(object)},Message.toObject=function(message,options){return this.$type.toObject(message,options)},Message.prototype.toJSON=function(){return this.$type.toObject(this,util.toJSONOptions)}},{39:39}],22:[function(require,module,exports){module.exports=Method;var ReflectionObject=require(24);((Method.prototype=Object.create(ReflectionObject.prototype)).constructor=Method).className="Method";var util=require(37);function Method(name,type,requestType,responseType,requestStream,responseStream,options,comment){if(util.isObject(requestStream)?(options=requestStream,requestStream=responseStream=undefined):util.isObject(responseStream)&&(options=responseStream,responseStream=undefined),type!==undefined&&!util.isString(type))throw TypeError("type must be a string");if(!util.isString(requestType))throw TypeError("requestType must be a string");if(!util.isString(responseType))throw TypeError("responseType must be a string");ReflectionObject.call(this,name,options),this.type=type||"rpc",this.requestType=requestType,this.requestStream=!!requestStream||undefined,this.responseType=responseType,this.responseStream=!!responseStream||undefined,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=comment}Method.fromJSON=function(name,json){return new Method(name,json.type,json.requestType,json.responseType,json.requestStream,json.responseStream,json.options,json.comment)},Method.prototype.toJSON=function(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["type","rpc"!==this.type&&this.type||undefined,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",keepComments?this.comment:undefined])},Method.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),ReflectionObject.prototype.resolve.call(this))}},{24:24,37:37}],23:[function(require,module,exports){module.exports=Namespace;var ReflectionObject=require(24);((Namespace.prototype=Object.create(ReflectionObject.prototype)).constructor=Namespace).className="Namespace";var Type,Service,Enum,Field=require(16),util=require(37);function arrayToJSON(array,toJSONOptions){if(!array||!array.length)return undefined;for(var obj={},i=0;i<array.length;++i)obj[array[i].name]=array[i].toJSON(toJSONOptions);return obj}function Namespace(name,options){ReflectionObject.call(this,name,options),this.nested=undefined,this._nestedArray=null}function clearCache(namespace){return namespace._nestedArray=null,namespace}Namespace.fromJSON=function(name,json){return new Namespace(name,json.options).addJSON(json.nested)},Namespace.arrayToJSON=arrayToJSON,Namespace.isReservedId=function(reserved,id){if(reserved)for(var i=0;i<reserved.length;++i)if("string"!=typeof reserved[i]&&reserved[i][0]<=id&&reserved[i][1]>=id)return!0;return!1},Namespace.isReservedName=function(reserved,name){if(reserved)for(var i=0;i<reserved.length;++i)if(reserved[i]===name)return!0;return!1},Object.defineProperty(Namespace.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=util.toArray(this.nested))}}),Namespace.prototype.toJSON=function(toJSONOptions){return util.toObject(["options",this.options,"nested",arrayToJSON(this.nestedArray,toJSONOptions)])},Namespace.prototype.addJSON=function(nestedJson){if(nestedJson)for(var nested,names=Object.keys(nestedJson),i=0;i<names.length;++i)nested=nestedJson[names[i]],this.add((nested.fields!==undefined?Type.fromJSON:nested.values!==undefined?Enum.fromJSON:nested.methods!==undefined?Service.fromJSON:nested.id!==undefined?Field.fromJSON:Namespace.fromJSON)(names[i],nested));return this},Namespace.prototype.get=function(name){return this.nested&&this.nested[name]||null},Namespace.prototype.getEnum=function(name){if(this.nested&&this.nested[name]instanceof Enum)return this.nested[name].values;throw Error("no such enum: "+name)},Namespace.prototype.add=function(object){if(!(object instanceof Field&&object.extend!==undefined||object instanceof Type||object instanceof Enum||object instanceof Service||object instanceof Namespace))throw TypeError("object must be a valid nested object");if(this.nested){var prev=this.get(object.name);if(prev){if(!(prev instanceof Namespace&&object instanceof Namespace)||prev instanceof Type||prev instanceof Service)throw Error("duplicate name '"+object.name+"' in "+this);for(var nested=prev.nestedArray,i=0;i<nested.length;++i)object.add(nested[i]);this.remove(prev),this.nested||(this.nested={}),object.setOptions(prev.options,!0)}}else this.nested={};return this.nested[object.name]=object,object.onAdd(this),clearCache(this)},Namespace.prototype.remove=function(object){if(!(object instanceof ReflectionObject))throw TypeError("object must be a ReflectionObject");if(object.parent!==this)throw Error(object+" is not a member of "+this);return delete this.nested[object.name],Object.keys(this.nested).length||(this.nested=undefined),object.onRemove(this),clearCache(this)},Namespace.prototype.define=function(path,json){if(util.isString(path))path=path.split(".");else if(!Array.isArray(path))throw TypeError("illegal path");if(path&&path.length&&""===path[0])throw Error("path must be relative");for(var ptr=this;path.length>0;){var part=path.shift();if(ptr.nested&&ptr.nested[part]){if(!((ptr=ptr.nested[part])instanceof Namespace))throw Error("path conflicts with non-namespace objects")}else ptr.add(ptr=new Namespace(part))}return json&&ptr.addJSON(json),ptr},Namespace.prototype.resolveAll=function(){for(var nested=this.nestedArray,i=0;i<nested.length;)nested[i]instanceof Namespace?nested[i++].resolveAll():nested[i++].resolve();return this.resolve()},Namespace.prototype.lookup=function(path,filterTypes,parentAlreadyChecked){if("boolean"==typeof filterTypes?(parentAlreadyChecked=filterTypes,filterTypes=undefined):filterTypes&&!Array.isArray(filterTypes)&&(filterTypes=[filterTypes]),util.isString(path)&&path.length){if("."===path)return this.root;path=path.split(".")}else if(!path.length)return this;if(""===path[0])return this.root.lookup(path.slice(1),filterTypes);var found=this.get(path[0]);if(found){if(1===path.length){if(!filterTypes||filterTypes.indexOf(found.constructor)>-1)return found}else if(found instanceof Namespace&&(found=found.lookup(path.slice(1),filterTypes,!0)))return found}else for(var i=0;i<this.nestedArray.length;++i)if(this._nestedArray[i]instanceof Namespace&&(found=this._nestedArray[i].lookup(path,filterTypes,!0)))return found;return null===this.parent||parentAlreadyChecked?null:this.parent.lookup(path,filterTypes)},Namespace.prototype.lookupType=function(path){var found=this.lookup(path,[Type]);if(!found)throw Error("no such type: "+path);return found},Namespace.prototype.lookupEnum=function(path){var found=this.lookup(path,[Enum]);if(!found)throw Error("no such Enum '"+path+"' in "+this);return found},Namespace.prototype.lookupTypeOrEnum=function(path){var found=this.lookup(path,[Type,Enum]);if(!found)throw Error("no such Type or Enum '"+path+"' in "+this);return found},Namespace.prototype.lookupService=function(path){var found=this.lookup(path,[Service]);if(!found)throw Error("no such Service '"+path+"' in "+this);return found},Namespace._configure=function(Type_,Service_,Enum_){Type=Type_,Service=Service_,Enum=Enum_}},{16:16,24:24,37:37}],24:[function(require,module,exports){module.exports=ReflectionObject,ReflectionObject.className="ReflectionObject";var Root,util=require(37);function ReflectionObject(name,options){if(!util.isString(name))throw TypeError("name must be a string");if(options&&!util.isObject(options))throw TypeError("options must be an object");this.options=options,this.name=name,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(ReflectionObject.prototype,{root:{get:function(){for(var ptr=this;null!==ptr.parent;)ptr=ptr.parent;return ptr}},fullName:{get:function(){for(var path=[this.name],ptr=this.parent;ptr;)path.unshift(ptr.name),ptr=ptr.parent;return path.join(".")}}}),ReflectionObject.prototype.toJSON=function(){throw Error()},ReflectionObject.prototype.onAdd=function(parent){this.parent&&this.parent!==parent&&this.parent.remove(this),this.parent=parent,this.resolved=!1;var root=parent.root;root instanceof Root&&root._handleAdd(this)},ReflectionObject.prototype.onRemove=function(parent){var root=parent.root;root instanceof Root&&root._handleRemove(this),this.parent=null,this.resolved=!1},ReflectionObject.prototype.resolve=function(){return this.resolved?this:(this.root instanceof Root&&(this.resolved=!0),this)},ReflectionObject.prototype.getOption=function(name){return this.options?this.options[name]:undefined},ReflectionObject.prototype.setOption=function(name,value,ifNotSet){return ifNotSet&&this.options&&this.options[name]!==undefined||((this.options||(this.options={}))[name]=value),this},ReflectionObject.prototype.setOptions=function(options,ifNotSet){if(options)for(var keys=Object.keys(options),i=0;i<keys.length;++i)this.setOption(keys[i],options[keys[i]],ifNotSet);return this},ReflectionObject.prototype.toString=function(){var className=this.constructor.className,fullName=this.fullName;return fullName.length?className+" "+fullName:className},ReflectionObject._configure=function(Root_){Root=Root_}},{37:37}],25:[function(require,module,exports){module.exports=OneOf;var ReflectionObject=require(24);((OneOf.prototype=Object.create(ReflectionObject.prototype)).constructor=OneOf).className="OneOf";var Field=require(16),util=require(37);function OneOf(name,fieldNames,options,comment){if(Array.isArray(fieldNames)||(options=fieldNames,fieldNames=undefined),ReflectionObject.call(this,name,options),fieldNames!==undefined&&!Array.isArray(fieldNames))throw TypeError("fieldNames must be an Array");this.oneof=fieldNames||[],this.fieldsArray=[],this.comment=comment}function addFieldsToParent(oneof){if(oneof.parent)for(var i=0;i<oneof.fieldsArray.length;++i)oneof.fieldsArray[i].parent||oneof.parent.add(oneof.fieldsArray[i])}OneOf.fromJSON=function(name,json){return new OneOf(name,json.oneof,json.options,json.comment)},OneOf.prototype.toJSON=function(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",this.options,"oneof",this.oneof,"comment",keepComments?this.comment:undefined])},OneOf.prototype.add=function(field){if(!(field instanceof Field))throw TypeError("field must be a Field");return field.parent&&field.parent!==this.parent&&field.parent.remove(field),this.oneof.push(field.name),this.fieldsArray.push(field),field.partOf=this,addFieldsToParent(this),this},OneOf.prototype.remove=function(field){if(!(field instanceof Field))throw TypeError("field must be a Field");var index=this.fieldsArray.indexOf(field);if(index<0)throw Error(field+" is not a member of "+this);return this.fieldsArray.splice(index,1),(index=this.oneof.indexOf(field.name))>-1&&this.oneof.splice(index,1),field.partOf=null,this},OneOf.prototype.onAdd=function(parent){ReflectionObject.prototype.onAdd.call(this,parent);for(var i=0;i<this.oneof.length;++i){var field=parent.get(this.oneof[i]);field&&!field.partOf&&(field.partOf=this,this.fieldsArray.push(field))}addFieldsToParent(this)},OneOf.prototype.onRemove=function(parent){for(var field,i=0;i<this.fieldsArray.length;++i)(field=this.fieldsArray[i]).parent&&field.parent.remove(field);ReflectionObject.prototype.onRemove.call(this,parent)},OneOf.d=function(){for(var fieldNames=new Array(arguments.length),index=0;index<arguments.length;)fieldNames[index]=arguments[index++];return function(prototype,oneofName){util.decorateType(prototype.constructor).add(new OneOf(oneofName,fieldNames)),Object.defineProperty(prototype,oneofName,{get:util.oneOfGetter(fieldNames),set:util.oneOfSetter(fieldNames)})}}},{16:16,24:24,37:37}],26:[function(require,module,exports){module.exports=parse,parse.filename=null,parse.defaults={keepCase:!1};var tokenize=require(34),Root=require(29),Type=require(35),Field=require(16),MapField=require(20),OneOf=require(25),Enum=require(15),Service=require(33),Method=require(22),types=require(36),util=require(37),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,fqTypeRefRe=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function parse(source,root,options){root instanceof Root||(options=root,root=new Root),options||(options=parse.defaults);var pkg,imports,weakImports,syntax,token,tn=tokenize(source,options.alternateCommentMode||!1),next=tn.next,push=tn.push,peek=tn.peek,skip=tn.skip,cmnt=tn.cmnt,head=!0,isProto3=!1,ptr=root,applyCase=options.keepCase?function(name){return name}:util.camelCase;function illegal(token,name,insideTryCatch){var filename=parse.filename;return insideTryCatch||(parse.filename=null),Error("illegal "+(name||"token")+" '"+token+"' ("+(filename?filename+", ":"")+"line "+tn.line+")")}function readString(){var token,values=[];do{if('"'!==(token=next())&&"'"!==token)throw illegal(token);values.push(next()),skip(token),token=peek()}while('"'===token||"'"===token);return values.join("")}function readValue(acceptTypeRef){var token=next();switch(token){case"'":case'"':return push(token),readString();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return function(token,insideTryCatch){var sign=1;"-"===token.charAt(0)&&(sign=-1,token=token.substring(1));switch(token){case"inf":case"INF":case"Inf":return sign*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(token))return sign*parseInt(token,10);if(base16Re.test(token))return sign*parseInt(token,16);if(base8Re.test(token))return sign*parseInt(token,8);if(numberRe.test(token))return sign*parseFloat(token);throw illegal(token,"number",insideTryCatch)}(token,!0)}catch(e){if(acceptTypeRef&&typeRefRe.test(token))return token;throw illegal(token,"value")}}function readRanges(target,acceptStrings){var token,start;do{!acceptStrings||'"'!==(token=peek())&&"'"!==token?target.push([start=parseId(next()),skip("to",!0)?parseId(next()):start]):target.push(readString())}while(skip(",",!0));skip(";")}function parseId(token,acceptNegative){switch(token){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!acceptNegative&&"-"===token.charAt(0))throw illegal(token,"id");if(base10NegRe.test(token))return parseInt(token,10);if(base16NegRe.test(token))return parseInt(token,16);if(base8NegRe.test(token))return parseInt(token,8);throw illegal(token,"id")}function parsePackage(){if(pkg!==undefined)throw illegal("package");if(pkg=next(),!typeRefRe.test(pkg))throw illegal(pkg,"name");ptr=ptr.define(pkg),skip(";")}function parseImport(){var whichImports,token=peek();switch(token){case"weak":whichImports=weakImports||(weakImports=[]),next();break;case"public":next();default:whichImports=imports||(imports=[])}token=readString(),skip(";"),whichImports.push(token)}function parseSyntax(){if(skip("="),syntax=readString(),!(isProto3="proto3"===syntax)&&"proto2"!==syntax)throw illegal(syntax,"syntax");skip(";")}function parseCommon(parent,token){switch(token){case"option":return parseOption(parent,token),skip(";"),!0;case"message":return function(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"type name");var type=new Type(token);ifBlock(type,function(token){if(!parseCommon(type,token))switch(token){case"map":!function(parent){skip("<");var keyType=next();if(types.mapKey[keyType]===undefined)throw illegal(keyType,"type");skip(",");var valueType=next();if(!typeRefRe.test(valueType))throw illegal(valueType,"type");skip(">");var name=next();if(!nameRe.test(name))throw illegal(name,"name");skip("=");var field=new MapField(applyCase(name),parseId(next()),keyType,valueType);ifBlock(field,function(token){if("option"!==token)throw illegal(token);parseOption(field,token),skip(";")},function(){parseInlineOptions(field)}),parent.add(field)}(type);break;case"required":case"optional":case"repeated":parseField(type,token);break;case"oneof":!function(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"name");var oneof=new OneOf(applyCase(token));ifBlock(oneof,function(token){"option"===token?(parseOption(oneof,token),skip(";")):(push(token),parseField(oneof,"optional"))}),parent.add(oneof)}(type,token);break;case"extensions":readRanges(type.extensions||(type.extensions=[]));break;case"reserved":readRanges(type.reserved||(type.reserved=[]),!0);break;default:if(!isProto3||!typeRefRe.test(token))throw illegal(token);push(token),parseField(type,"optional")}}),parent.add(type)}(parent,token),!0;case"enum":return function(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"name");var enm=new Enum(token);ifBlock(enm,function(token){switch(token){case"option":parseOption(enm,token),skip(";");break;case"reserved":readRanges(enm.reserved||(enm.reserved=[]),!0);break;default:!function(parent,token){if(!nameRe.test(token))throw illegal(token,"name");skip("=");var value=parseId(next(),!0),dummy={};ifBlock(dummy,function(token){if("option"!==token)throw illegal(token);parseOption(dummy,token),skip(";")},function(){parseInlineOptions(dummy)}),parent.add(token,value,dummy.comment)}(enm,token)}}),parent.add(enm)}(parent,token),!0;case"service":return function(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"service name");var service=new Service(token);ifBlock(service,function(token){if(!parseCommon(service,token)){if("rpc"!==token)throw illegal(token);!function(parent,token){var type=token;if(!nameRe.test(token=next()))throw illegal(token,"name");var requestType,requestStream,responseType,responseStream,name=token;skip("("),skip("stream",!0)&&(requestStream=!0);if(!typeRefRe.test(token=next()))throw illegal(token);requestType=token,skip(")"),skip("returns"),skip("("),skip("stream",!0)&&(responseStream=!0);if(!typeRefRe.test(token=next()))throw illegal(token);responseType=token,skip(")");var method=new Method(name,type,requestType,responseType,requestStream,responseStream);ifBlock(method,function(token){if("option"!==token)throw illegal(token);parseOption(method,token),skip(";")}),parent.add(method)}(service,token)}}),parent.add(service)}(parent,token),!0;case"extend":return function(parent,token){if(!typeRefRe.test(token=next()))throw illegal(token,"reference");var reference=token;ifBlock(null,function(token){switch(token){case"required":case"repeated":case"optional":parseField(parent,token,reference);break;default:if(!isProto3||!typeRefRe.test(token))throw illegal(token);push(token),parseField(parent,"optional",reference)}})}(parent,token),!0}return!1}function ifBlock(obj,fnIf,fnElse){var trailingLine=tn.line;if(obj&&(obj.comment=cmnt(),obj.filename=parse.filename),skip("{",!0)){for(var token;"}"!==(token=next());)fnIf(token);skip(";",!0)}else fnElse&&fnElse(),skip(";"),obj&&"string"!=typeof obj.comment&&(obj.comment=cmnt(trailingLine))}function parseField(parent,rule,extend){var type=next();if("group"!==type){if(!typeRefRe.test(type))throw illegal(type,"type");var name=next();if(!nameRe.test(name))throw illegal(name,"name");name=applyCase(name),skip("=");var field=new Field(name,parseId(next()),type,rule,extend);ifBlock(field,function(token){if("option"!==token)throw illegal(token);parseOption(field,token),skip(";")},function(){parseInlineOptions(field)}),parent.add(field),isProto3||!field.repeated||types.packed[type]===undefined&&types.basic[type]!==undefined||field.setOption("packed",!1,!0)}else!function(parent,rule){var name=next();if(!nameRe.test(name))throw illegal(name,"name");var fieldName=util.lcFirst(name);name===fieldName&&(name=util.ucFirst(name));skip("=");var id=parseId(next()),type=new Type(name);type.group=!0;var field=new Field(fieldName,id,name,rule);field.filename=parse.filename,ifBlock(type,function(token){switch(token){case"option":parseOption(type,token),skip(";");break;case"required":case"optional":case"repeated":parseField(type,token);break;default:throw illegal(token)}}),parent.add(type).add(field)}(parent,rule)}function parseOption(parent,token){var isCustom=skip("(",!0);if(!typeRefRe.test(token=next()))throw illegal(token,"name");var name=token;isCustom&&(skip(")"),name="("+name+")",token=peek(),fqTypeRefRe.test(token)&&(name+=token,next())),skip("="),parseOptionValue(parent,name)}function parseOptionValue(parent,name){if(skip("{",!0))do{if(!nameRe.test(token=next()))throw illegal(token,"name");"{"===peek()?parseOptionValue(parent,name+"."+token):(skip(":"),"{"===peek()?parseOptionValue(parent,name+"."+token):setOption(parent,name+"."+token,readValue(!0))),skip(",",!0)}while(!skip("}",!0));else setOption(parent,name,readValue(!0))}function setOption(parent,name,value){parent.setOption&&parent.setOption(name,value)}function parseInlineOptions(parent){if(skip("[",!0)){do{parseOption(parent,"option")}while(skip(",",!0));skip("]")}return parent}for(;null!==(token=next());)switch(token){case"package":if(!head)throw illegal(token);parsePackage();break;case"import":if(!head)throw illegal(token);parseImport();break;case"syntax":if(!head)throw illegal(token);parseSyntax();break;case"option":if(!head)throw illegal(token);parseOption(ptr,token),skip(";");break;default:if(parseCommon(ptr,token)){head=!1;continue}throw illegal(token)}return parse.filename=null,{package:pkg,imports:imports,weakImports:weakImports,syntax:syntax,root:root}}},{15:15,16:16,20:20,22:22,25:25,29:29,33:33,34:34,35:35,36:36,37:37}],27:[function(require,module,exports){module.exports=Reader;var BufferReader,util=require(39),LongBits=util.LongBits,utf8=util.utf8;function indexOutOfRange(reader,writeLength){return RangeError("index out of range: "+reader.pos+" + "+(writeLength||1)+" > "+reader.len)}function Reader(buffer){this.buf=buffer,this.pos=0,this.len=buffer.length}var value,create_array="undefined"!=typeof Uint8Array?function(buffer){if(buffer instanceof Uint8Array||Array.isArray(buffer))return new Reader(buffer);throw Error("illegal buffer")}:function(buffer){if(Array.isArray(buffer))return new Reader(buffer);throw Error("illegal buffer")};function readLongVarint(){var bits=new LongBits(0,0),i=0;if(!(this.len-this.pos>4)){for(;i<3;++i){if(this.pos>=this.len)throw indexOutOfRange(this);if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<7*i)>>>0,this.buf[this.pos++]<128)return bits}return bits.lo=(bits.lo|(127&this.buf[this.pos++])<<7*i)>>>0,bits}for(;i<4;++i)if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<7*i)>>>0,this.buf[this.pos++]<128)return bits;if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<28)>>>0,bits.hi=(bits.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return bits;if(i=0,this.len-this.pos>4){for(;i<5;++i)if(bits.hi=(bits.hi|(127&this.buf[this.pos])<<7*i+3)>>>0,this.buf[this.pos++]<128)return bits}else for(;i<5;++i){if(this.pos>=this.len)throw indexOutOfRange(this);if(bits.hi=(bits.hi|(127&this.buf[this.pos])<<7*i+3)>>>0,this.buf[this.pos++]<128)return bits}throw Error("invalid varint encoding")}function readFixed32_end(buf,end){return(buf[end-4]|buf[end-3]<<8|buf[end-2]<<16|buf[end-1]<<24)>>>0}function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader.create=util.Buffer?function(buffer){return(Reader.create=function(buffer){return util.Buffer.isBuffer(buffer)?new BufferReader(buffer):create_array(buffer)})(buffer)}:create_array,Reader.prototype._slice=util.Array.prototype.subarray||util.Array.prototype.slice,Reader.prototype.uint32=(value=4294967295,function(){if(value=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return value;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return value}),Reader.prototype.int32=function(){return 0|this.uint32()},Reader.prototype.sint32=function(){var value=this.uint32();return value>>>1^-(1&value)|0},Reader.prototype.bool=function(){return 0!==this.uint32()},Reader.prototype.fixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.sfixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return 0|readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.float=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var value=util.float.readFloatLE(this.buf,this.pos);return this.pos+=4,value},Reader.prototype.double=function(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var value=util.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,value},Reader.prototype.bytes=function(){var length=this.uint32(),start=this.pos,end=this.pos+length;if(end>this.len)throw indexOutOfRange(this,length);return this.pos+=length,Array.isArray(this.buf)?this.buf.slice(start,end):start===end?new this.buf.constructor(0):this._slice.call(this.buf,start,end)},Reader.prototype.string=function(){var bytes=this.bytes();return utf8.read(bytes,0,bytes.length)},Reader.prototype.skip=function(length){if("number"==typeof length){if(this.pos+length>this.len)throw indexOutOfRange(this,length);this.pos+=length}else do{if(this.pos>=this.len)throw indexOutOfRange(this)}while(128&this.buf[this.pos++]);return this},Reader.prototype.skipType=function(wireType){switch(wireType){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(wireType=7&this.uint32());)this.skipType(wireType);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+wireType+" at offset "+this.pos)}return this},Reader._configure=function(BufferReader_){BufferReader=BufferReader_;var fn=util.Long?"toLong":"toNumber";util.merge(Reader.prototype,{int64:function(){return readLongVarint.call(this)[fn](!1)},uint64:function(){return readLongVarint.call(this)[fn](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[fn](!1)},fixed64:function(){return readFixed64.call(this)[fn](!0)},sfixed64:function(){return readFixed64.call(this)[fn](!1)}})}},{39:39}],28:[function(require,module,exports){module.exports=BufferReader;var Reader=require(27);(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util=require(39);function BufferReader(buffer){Reader.call(this,buffer)}util.Buffer&&(BufferReader.prototype._slice=util.Buffer.prototype.slice),BufferReader.prototype.string=function(){var len=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+len,this.len))}},{27:27,39:39}],29:[function(require,module,exports){module.exports=Root;var Namespace=require(23);((Root.prototype=Object.create(Namespace.prototype)).constructor=Root).className="Root";var Type,parse,common,Field=require(16),Enum=require(15),OneOf=require(25),util=require(37);function Root(options){Namespace.call(this,"",options),this.deferred=[],this.files=[]}function SYNC(){}Root.fromJSON=function(json,root){return root||(root=new Root),json.options&&root.setOptions(json.options),root.addJSON(json.nested)},Root.prototype.resolvePath=util.path.resolve,Root.prototype.load=function load(filename,options,callback){"function"==typeof options&&(callback=options,options=undefined);var self=this;if(!callback)return util.asPromise(load,self,filename,options);var sync=callback===SYNC;function finish(err,root){if(callback){var cb=callback;if(callback=null,sync)throw err;cb(err,root)}}function process(filename,source){try{if(util.isString(source)&&"{"===source.charAt(0)&&(source=JSON.parse(source)),util.isString(source)){parse.filename=filename;var resolved,parsed=parse(source,self,options),i=0;if(parsed.imports)for(;i<parsed.imports.length;++i)(resolved=self.resolvePath(filename,parsed.imports[i]))&&fetch(resolved);if(parsed.weakImports)for(i=0;i<parsed.weakImports.length;++i)(resolved=self.resolvePath(filename,parsed.weakImports[i]))&&fetch(resolved,!0)}else self.setOptions(source.options).addJSON(source.nested)}catch(err){finish(err)}sync||queued||finish(null,self)}function fetch(filename,weak){var idx=filename.lastIndexOf("google/protobuf/");if(idx>-1){var altname=filename.substring(idx);altname in common&&(filename=altname)}if(!(self.files.indexOf(filename)>-1))if(self.files.push(filename),filename in common)sync?process(filename,common[filename]):(++queued,setTimeout(function(){--queued,process(filename,common[filename])}));else if(sync){var source;try{source=util.fs.readFileSync(filename).toString("utf8")}catch(err){return void(weak||finish(err))}process(filename,source)}else++queued,util.fetch(filename,function(err,source){--queued,callback&&(err?weak?queued||finish(null,self):finish(err):process(filename,source))})}var queued=0;util.isString(filename)&&(filename=[filename]);for(var resolved,i=0;i<filename.length;++i)(resolved=self.resolvePath("",filename[i]))&&fetch(resolved);return sync?self:(queued||finish(null,self),undefined)},Root.prototype.loadSync=function(filename,options){if(!util.isNode)throw Error("not supported");return this.load(filename,options,SYNC)},Root.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(field){return"'extend "+field.extend+"' in "+field.parent.fullName}).join(", "));return Namespace.prototype.resolveAll.call(this)};var exposeRe=/^[A-Z]/;function tryHandleExtension(root,field){var extendedType=field.parent.lookup(field.extend);if(extendedType){var sisterField=new Field(field.fullName,field.id,field.type,field.rule,undefined,field.options);return sisterField.declaringField=field,field.extensionField=sisterField,extendedType.add(sisterField),!0}return!1}Root.prototype._handleAdd=function(object){if(object instanceof Field)object.extend===undefined||object.extensionField||tryHandleExtension(0,object)||this.deferred.push(object);else if(object instanceof Enum)exposeRe.test(object.name)&&(object.parent[object.name]=object.values);else if(!(object instanceof OneOf)){if(object instanceof Type)for(var i=0;i<this.deferred.length;)tryHandleExtension(0,this.deferred[i])?this.deferred.splice(i,1):++i;for(var j=0;j<object.nestedArray.length;++j)this._handleAdd(object._nestedArray[j]);exposeRe.test(object.name)&&(object.parent[object.name]=object)}},Root.prototype._handleRemove=function(object){if(object instanceof Field){if(object.extend!==undefined)if(object.extensionField)object.extensionField.parent.remove(object.extensionField),object.extensionField=null;else{var index=this.deferred.indexOf(object);index>-1&&this.deferred.splice(index,1)}}else if(object instanceof Enum)exposeRe.test(object.name)&&delete object.parent[object.name];else if(object instanceof Namespace){for(var i=0;i<object.nestedArray.length;++i)this._handleRemove(object._nestedArray[i]);exposeRe.test(object.name)&&delete object.parent[object.name]}},Root._configure=function(Type_,parse_,common_){Type=Type_,parse=parse_,common=common_}},{15:15,16:16,23:23,25:25,37:37}],30:[function(require,module,exports){module.exports={}},{}],31:[function(require,module,exports){exports.Service=require(32)},{32:32}],32:[function(require,module,exports){module.exports=Service;var util=require(39);function Service(rpcImpl,requestDelimited,responseDelimited){if("function"!=typeof rpcImpl)throw TypeError("rpcImpl must be a function");util.EventEmitter.call(this),this.rpcImpl=rpcImpl,this.requestDelimited=Boolean(requestDelimited),this.responseDelimited=Boolean(responseDelimited)}(Service.prototype=Object.create(util.EventEmitter.prototype)).constructor=Service,Service.prototype.rpcCall=function rpcCall(method,requestCtor,responseCtor,request,callback){if(!request)throw TypeError("request must be specified");var self=this;if(!callback)return util.asPromise(rpcCall,self,method,requestCtor,responseCtor,request);if(!self.rpcImpl)return setTimeout(function(){callback(Error("already ended"))},0),undefined;try{return self.rpcImpl(method,requestCtor[self.requestDelimited?"encodeDelimited":"encode"](request).finish(),function(err,response){if(err)return self.emit("error",err,method),callback(err);if(null===response)return self.end(!0),undefined;if(!(response instanceof responseCtor))try{response=responseCtor[self.responseDelimited?"decodeDelimited":"decode"](response)}catch(err){return self.emit("error",err,method),callback(err)}return self.emit("data",response,method),callback(null,response)})}catch(err){return self.emit("error",err,method),setTimeout(function(){callback(err)},0),undefined}},Service.prototype.end=function(endedByRPC){return this.rpcImpl&&(endedByRPC||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},{39:39}],33:[function(require,module,exports){module.exports=Service;var Namespace=require(23);((Service.prototype=Object.create(Namespace.prototype)).constructor=Service).className="Service";var Method=require(22),util=require(37),rpc=require(31);function Service(name,options){Namespace.call(this,name,options),this.methods={},this._methodsArray=null}function clearCache(service){return service._methodsArray=null,service}Service.fromJSON=function(name,json){var service=new Service(name,json.options);if(json.methods)for(var names=Object.keys(json.methods),i=0;i<names.length;++i)service.add(Method.fromJSON(names[i],json.methods[names[i]]));return json.nested&&service.addJSON(json.nested),service.comment=json.comment,service},Service.prototype.toJSON=function(toJSONOptions){var inherited=Namespace.prototype.toJSON.call(this,toJSONOptions),keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",inherited&&inherited.options||undefined,"methods",Namespace.arrayToJSON(this.methodsArray,toJSONOptions)||{},"nested",inherited&&inherited.nested||undefined,"comment",keepComments?this.comment:undefined])},Object.defineProperty(Service.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=util.toArray(this.methods))}}),Service.prototype.get=function(name){return this.methods[name]||Namespace.prototype.get.call(this,name)},Service.prototype.resolveAll=function(){for(var methods=this.methodsArray,i=0;i<methods.length;++i)methods[i].resolve();return Namespace.prototype.resolve.call(this)},Service.prototype.add=function(object){if(this.get(object.name))throw Error("duplicate name '"+object.name+"' in "+this);return object instanceof Method?(this.methods[object.name]=object,object.parent=this,clearCache(this)):Namespace.prototype.add.call(this,object)},Service.prototype.remove=function(object){if(object instanceof Method){if(this.methods[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.methods[object.name],object.parent=null,clearCache(this)}return Namespace.prototype.remove.call(this,object)},Service.prototype.create=function(rpcImpl,requestDelimited,responseDelimited){for(var method,rpcService=new rpc.Service(rpcImpl,requestDelimited,responseDelimited),i=0;i<this.methodsArray.length;++i){var methodName=util.lcFirst((method=this._methodsArray[i]).resolve().name).replace(/[^$\w_]/g,"");rpcService[methodName]=util.codegen(["r","c"],util.isReserved(methodName)?methodName+"_":methodName)("return this.rpcCall(m,q,s,r,c)")({m:method,q:method.resolvedRequestType.ctor,s:method.resolvedResponseType.ctor})}return rpcService}},{22:22,23:23,31:31,37:37}],34:[function(require,module,exports){module.exports=tokenize;var delimRe=/[\s{}=;:[\],'"()<>]/g,stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,setCommentRe=/^ *[*\/]+ */,setCommentAltRe=/^\s*\*?\/*/,setCommentSplitRe=/\n/g,whitespaceRe=/\s/,unescapeRe=/\\(.?)/g,unescapeMap={0:"\0",r:"\r",n:"\n",t:"\t"};function unescape(str){return str.replace(unescapeRe,function($0,$1){switch($1){case"\\":case"":return $1;default:return unescapeMap[$1]||""}})}function tokenize(source,alternateCommentMode){source=source.toString();var offset=0,length=source.length,line=1,commentType=null,commentText=null,commentLine=0,commentLineEmpty=!1,stack=[],stringDelim=null;function illegal(subject){return Error("illegal "+subject+" (line "+line+")")}function charAt(pos){return source.charAt(pos)}function setComment(start,end){commentType=source.charAt(start++),commentLine=line,commentLineEmpty=!1;var c,commentOffset=start-(alternateCommentMode?2:3);do{if(--commentOffset<0||"\n"===(c=source.charAt(commentOffset))){commentLineEmpty=!0;break}}while(" "===c||"\t"===c);for(var lines=source.substring(start,end).split(setCommentSplitRe),i=0;i<lines.length;++i)lines[i]=lines[i].replace(alternateCommentMode?setCommentAltRe:setCommentRe,"").trim();commentText=lines.join("\n").trim()}function isDoubleSlashCommentLine(startOffset){var endOffset=findEndOfLine(startOffset),lineText=source.substring(startOffset,endOffset);return/^\s*\/{1,2}/.test(lineText)}function findEndOfLine(cursor){for(var endOffset=cursor;endOffset<length&&"\n"!==charAt(endOffset);)endOffset++;return endOffset}function next(){if(stack.length>0)return stack.shift();if(stringDelim)return function(){var re="'"===stringDelim?stringSingleRe:stringDoubleRe;re.lastIndex=offset-1;var match=re.exec(source);if(!match)throw illegal("string");return offset=re.lastIndex,push(stringDelim),stringDelim=null,unescape(match[1])}();var repeat,prev,curr,start,isDoc;do{if(offset===length)return null;for(repeat=!1;whitespaceRe.test(curr=charAt(offset));)if("\n"===curr&&++line,++offset===length)return null;if("/"===charAt(offset)){if(++offset===length)throw illegal("comment");if("/"===charAt(offset))if(alternateCommentMode){if(start=offset,isDoc=!1,isDoubleSlashCommentLine(offset)){isDoc=!0;do{if((offset=findEndOfLine(offset))===length)break;offset++}while(isDoubleSlashCommentLine(offset))}else offset=Math.min(length,findEndOfLine(offset)+1);isDoc&&setComment(start,offset),line++,repeat=!0}else{for(isDoc="/"===charAt(start=offset+1);"\n"!==charAt(++offset);)if(offset===length)return null;++offset,isDoc&&setComment(start,offset-1),++line,repeat=!0}else{if("*"!==(curr=charAt(offset)))return"/";start=offset+1,isDoc=alternateCommentMode||"*"===charAt(start);do{if("\n"===curr&&++line,++offset===length)throw illegal("comment");prev=curr,curr=charAt(offset)}while("*"!==prev||"/"!==curr);++offset,isDoc&&setComment(start,offset-2),repeat=!0}}}while(repeat);var end=offset;if(delimRe.lastIndex=0,!delimRe.test(charAt(end++)))for(;end<length&&!delimRe.test(charAt(end));)++end;var token=source.substring(offset,offset=end);return'"'!==token&&"'"!==token||(stringDelim=token),token}function push(token){stack.push(token)}function peek(){if(!stack.length){var token=next();if(null===token)return null;push(token)}return stack[0]}return Object.defineProperty({next:next,peek:peek,push:push,skip:function(expected,optional){var actual=peek();if(actual===expected)return next(),!0;if(!optional)throw illegal("token '"+actual+"', '"+expected+"' expected");return!1},cmnt:function(trailingLine){var ret=null;return trailingLine===undefined?commentLine===line-1&&(alternateCommentMode||"*"===commentType||commentLineEmpty)&&(ret=commentText):(commentLine<trailingLine&&peek(),commentLine!==trailingLine||commentLineEmpty||!alternateCommentMode&&"/"!==commentType||(ret=commentText)),ret}},"line",{get:function(){return line}})}tokenize.unescape=unescape},{}],35:[function(require,module,exports){module.exports=Type;var Namespace=require(23);((Type.prototype=Object.create(Namespace.prototype)).constructor=Type).className="Type";var Enum=require(15),OneOf=require(25),Field=require(16),MapField=require(20),Service=require(33),Message=require(21),Reader=require(27),Writer=require(42),util=require(37),encoder=require(14),decoder=require(13),verifier=require(40),converter=require(12),wrappers=require(41);function Type(name,options){Namespace.call(this,name,options),this.fields={},this.oneofs=undefined,this.extensions=undefined,this.reserved=undefined,this.group=undefined,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function clearCache(type){return type._fieldsById=type._fieldsArray=type._oneofsArray=null,delete type.encode,delete type.decode,delete type.verify,type}Object.defineProperties(Type.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var names=Object.keys(this.fields),i=0;i<names.length;++i){var field=this.fields[names[i]],id=field.id;if(this._fieldsById[id])throw Error("duplicate id "+id+" in "+this);this._fieldsById[id]=field}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=util.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=util.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=Type.generateConstructor(this)())},set:function(ctor){var prototype=ctor.prototype;prototype instanceof Message||((ctor.prototype=new Message).constructor=ctor,util.merge(ctor.prototype,prototype)),ctor.$type=ctor.prototype.$type=this,util.merge(ctor,Message,!0),this._ctor=ctor;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var ctorProperties={};for(i=0;i<this.oneofsArray.length;++i)ctorProperties[this._oneofsArray[i].resolve().name]={get:util.oneOfGetter(this._oneofsArray[i].oneof),set:util.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(ctor.prototype,ctorProperties)}}}),Type.generateConstructor=function(mtype){for(var field,gen=util.codegen(["p"],mtype.name),i=0;i<mtype.fieldsArray.length;++i)(field=mtype._fieldsArray[i]).map?gen("this%s={}",util.safeProp(field.name)):field.repeated&&gen("this%s=[]",util.safeProp(field.name));return gen("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},Type.fromJSON=function(name,json){var type=new Type(name,json.options);type.extensions=json.extensions,type.reserved=json.reserved;for(var names=Object.keys(json.fields),i=0;i<names.length;++i)type.add((void 0!==json.fields[names[i]].keyType?MapField.fromJSON:Field.fromJSON)(names[i],json.fields[names[i]]));if(json.oneofs)for(names=Object.keys(json.oneofs),i=0;i<names.length;++i)type.add(OneOf.fromJSON(names[i],json.oneofs[names[i]]));if(json.nested)for(names=Object.keys(json.nested),i=0;i<names.length;++i){var nested=json.nested[names[i]];type.add((nested.id!==undefined?Field.fromJSON:nested.fields!==undefined?Type.fromJSON:nested.values!==undefined?Enum.fromJSON:nested.methods!==undefined?Service.fromJSON:Namespace.fromJSON)(names[i],nested))}return json.extensions&&json.extensions.length&&(type.extensions=json.extensions),json.reserved&&json.reserved.length&&(type.reserved=json.reserved),json.group&&(type.group=!0),json.comment&&(type.comment=json.comment),type},Type.prototype.toJSON=function(toJSONOptions){var inherited=Namespace.prototype.toJSON.call(this,toJSONOptions),keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",inherited&&inherited.options||undefined,"oneofs",Namespace.arrayToJSON(this.oneofsArray,toJSONOptions),"fields",Namespace.arrayToJSON(this.fieldsArray.filter(function(obj){return!obj.declaringField}),toJSONOptions)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:undefined,"reserved",this.reserved&&this.reserved.length?this.reserved:undefined,"group",this.group||undefined,"nested",inherited&&inherited.nested||undefined,"comment",keepComments?this.comment:undefined])},Type.prototype.resolveAll=function(){for(var fields=this.fieldsArray,i=0;i<fields.length;)fields[i++].resolve();var oneofs=this.oneofsArray;for(i=0;i<oneofs.length;)oneofs[i++].resolve();return Namespace.prototype.resolveAll.call(this)},Type.prototype.get=function(name){return this.fields[name]||this.oneofs&&this.oneofs[name]||this.nested&&this.nested[name]||null},Type.prototype.add=function(object){if(this.get(object.name))throw Error("duplicate name '"+object.name+"' in "+this);if(object instanceof Field&&object.extend===undefined){if(this._fieldsById?this._fieldsById[object.id]:this.fieldsById[object.id])throw Error("duplicate id "+object.id+" in "+this);if(this.isReservedId(object.id))throw Error("id "+object.id+" is reserved in "+this);if(this.isReservedName(object.name))throw Error("name '"+object.name+"' is reserved in "+this);return object.parent&&object.parent.remove(object),this.fields[object.name]=object,object.message=this,object.onAdd(this),clearCache(this)}return object instanceof OneOf?(this.oneofs||(this.oneofs={}),this.oneofs[object.name]=object,object.onAdd(this),clearCache(this)):Namespace.prototype.add.call(this,object)},Type.prototype.remove=function(object){if(object instanceof Field&&object.extend===undefined){if(!this.fields||this.fields[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.fields[object.name],object.parent=null,object.onRemove(this),clearCache(this)}if(object instanceof OneOf){if(!this.oneofs||this.oneofs[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.oneofs[object.name],object.parent=null,object.onRemove(this),clearCache(this)}return Namespace.prototype.remove.call(this,object)},Type.prototype.isReservedId=function(id){return Namespace.isReservedId(this.reserved,id)},Type.prototype.isReservedName=function(name){return Namespace.isReservedName(this.reserved,name)},Type.prototype.create=function(properties){return new this.ctor(properties)},Type.prototype.setup=function(){for(var fullName=this.fullName,types=[],i=0;i<this.fieldsArray.length;++i)types.push(this._fieldsArray[i].resolve().resolvedType);this.encode=encoder(this)({Writer:Writer,types:types,util:util}),this.decode=decoder(this)({Reader:Reader,types:types,util:util}),this.verify=verifier(this)({types:types,util:util}),this.fromObject=converter.fromObject(this)({types:types,util:util}),this.toObject=converter.toObject(this)({types:types,util:util});var wrapper=wrappers[fullName];if(wrapper){var originalThis=Object.create(this);originalThis.fromObject=this.fromObject,this.fromObject=wrapper.fromObject.bind(originalThis),originalThis.toObject=this.toObject,this.toObject=wrapper.toObject.bind(originalThis)}return this},Type.prototype.encode=function(message,writer){return this.setup().encode(message,writer)},Type.prototype.encodeDelimited=function(message,writer){return this.encode(message,writer&&writer.len?writer.fork():writer).ldelim()},Type.prototype.decode=function(reader,length){return this.setup().decode(reader,length)},Type.prototype.decodeDelimited=function(reader){return reader instanceof Reader||(reader=Reader.create(reader)),this.decode(reader,reader.uint32())},Type.prototype.verify=function(message){return this.setup().verify(message)},Type.prototype.fromObject=function(object){return this.setup().fromObject(object)},Type.prototype.toObject=function(message,options){return this.setup().toObject(message,options)},Type.d=function(typeName){return function(target){util.decorateType(target,typeName)}}},{12:12,13:13,14:14,15:15,16:16,20:20,21:21,23:23,25:25,27:27,33:33,37:37,40:40,41:41,42:42}],36:[function(require,module,exports){var types=exports,util=require(37),s=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function bake(values,offset){var i=0,o={};for(offset|=0;i<values.length;)o[s[i+offset]]=values[i++];return o}types.basic=bake([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),types.defaults=bake([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",util.emptyArray,null]),types.long=bake([0,0,0,1,1],7),types.mapKey=bake([0,0,0,5,5,0,0,0,1,1,0,2],2),types.packed=bake([1,5,0,0,0,5,5,0,0,0,1,1,0])},{37:37}],37:[function(require,module,exports){var Type,Enum,util=module.exports=require(39),roots=require(30);util.codegen=require(3),util.fetch=require(5),util.path=require(8),util.fs=util.inquire("fs"),util.toArray=function(object){if(object){for(var keys=Object.keys(object),array=new Array(keys.length),index=0;index<keys.length;)array[index]=object[keys[index++]];return array}return[]},util.toObject=function(array){for(var object={},index=0;index<array.length;){var key=array[index++],val=array[index++];val!==undefined&&(object[key]=val)}return object};var safePropBackslashRe=/\\/g,safePropQuoteRe=/"/g;util.isReserved=function(name){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(name)},util.safeProp=function(prop){return!/^[$\w_]+$/.test(prop)||util.isReserved(prop)?'["'+prop.replace(safePropBackslashRe,"\\\\").replace(safePropQuoteRe,'\\"')+'"]':"."+prop},util.ucFirst=function(str){return str.charAt(0).toUpperCase()+str.substring(1)};var camelCaseRe=/_([a-z])/g;util.camelCase=function(str){return str.substring(0,1)+str.substring(1).replace(camelCaseRe,function($0,$1){return $1.toUpperCase()})},util.compareFieldsById=function(a,b){return a.id-b.id},util.decorateType=function(ctor,typeName){if(ctor.$type)return typeName&&ctor.$type.name!==typeName&&(util.decorateRoot.remove(ctor.$type),ctor.$type.name=typeName,util.decorateRoot.add(ctor.$type)),ctor.$type;Type||(Type=require(35));var type=new Type(typeName||ctor.name);return util.decorateRoot.add(type),type.ctor=ctor,Object.defineProperty(ctor,"$type",{value:type,enumerable:!1}),Object.defineProperty(ctor.prototype,"$type",{value:type,enumerable:!1}),type};var decorateEnumIndex=0;util.decorateEnum=function(object){if(object.$type)return object.$type;Enum||(Enum=require(15));var enm=new Enum("Enum"+decorateEnumIndex++,object);return util.decorateRoot.add(enm),Object.defineProperty(object,"$type",{value:enm,enumerable:!1}),enm},Object.defineProperty(util,"decorateRoot",{get:function(){return roots.decorated||(roots.decorated=new(require(29)))}})},{15:15,29:29,3:3,30:30,35:35,39:39,5:5,8:8}],38:[function(require,module,exports){module.exports=LongBits;var util=require(39);function LongBits(lo,hi){this.lo=lo>>>0,this.hi=hi>>>0}var zero=LongBits.zero=new LongBits(0,0);zero.toNumber=function(){return 0},zero.zzEncode=zero.zzDecode=function(){return this},zero.length=function(){return 1};var zeroHash=LongBits.zeroHash="\0\0\0\0\0\0\0\0";LongBits.fromNumber=function(value){if(0===value)return zero;var sign=value<0;sign&&(value=-value);var lo=value>>>0,hi=(value-lo)/4294967296>>>0;return sign&&(hi=~hi>>>0,lo=~lo>>>0,++lo>4294967295&&(lo=0,++hi>4294967295&&(hi=0))),new LongBits(lo,hi)},LongBits.from=function(value){if("number"==typeof value)return LongBits.fromNumber(value);if(util.isString(value)){if(!util.Long)return LongBits.fromNumber(parseInt(value,10));value=util.Long.fromString(value)}return value.low||value.high?new LongBits(value.low>>>0,value.high>>>0):zero},LongBits.prototype.toNumber=function(unsigned){if(!unsigned&&this.hi>>>31){var lo=1+~this.lo>>>0,hi=~this.hi>>>0;return lo||(hi=hi+1>>>0),-(lo+4294967296*hi)}return this.lo+4294967296*this.hi},LongBits.prototype.toLong=function(unsigned){return util.Long?new util.Long(0|this.lo,0|this.hi,Boolean(unsigned)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(unsigned)}};var charCodeAt=String.prototype.charCodeAt;LongBits.fromHash=function(hash){return hash===zeroHash?zero:new LongBits((charCodeAt.call(hash,0)|charCodeAt.call(hash,1)<<8|charCodeAt.call(hash,2)<<16|charCodeAt.call(hash,3)<<24)>>>0,(charCodeAt.call(hash,4)|charCodeAt.call(hash,5)<<8|charCodeAt.call(hash,6)<<16|charCodeAt.call(hash,7)<<24)>>>0)},LongBits.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},LongBits.prototype.zzEncode=function(){var mask=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^mask)>>>0,this.lo=(this.lo<<1^mask)>>>0,this},LongBits.prototype.zzDecode=function(){var mask=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^mask)>>>0,this.hi=(this.hi>>>1^mask)>>>0,this},LongBits.prototype.length=function(){var part0=this.lo,part1=(this.lo>>>28|this.hi<<4)>>>0,part2=this.hi>>>24;return 0===part2?0===part1?part0<16384?part0<128?1:2:part0<2097152?3:4:part1<16384?part1<128?5:6:part1<2097152?7:8:part2<128?9:10}},{39:39}],39:[function(require,module,exports){var util=exports;function merge(dst,src,ifNotSet){for(var keys=Object.keys(src),i=0;i<keys.length;++i)dst[keys[i]]!==undefined&&ifNotSet||(dst[keys[i]]=src[keys[i]]);return dst}function newError(name){function CustomError(message,properties){if(!(this instanceof CustomError))return new CustomError(message,properties);Object.defineProperty(this,"message",{get:function(){return message}}),Error.captureStackTrace?Error.captureStackTrace(this,CustomError):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),properties&&merge(this,properties)}return(CustomError.prototype=Object.create(Error.prototype)).constructor=CustomError,Object.defineProperty(CustomError.prototype,"name",{get:function(){return name}}),CustomError.prototype.toString=function(){return this.name+": "+this.message},CustomError}util.asPromise=require(1),util.base64=require(2),util.EventEmitter=require(4),util.float=require(6),util.inquire=require(7),util.utf8=require(10),util.pool=require(9),util.LongBits=require(38),util.global="undefined"!=typeof window&&window||void 0!==global&&global||"undefined"!=typeof self&&self||this,util.emptyArray=Object.freeze?Object.freeze([]):[],util.emptyObject=Object.freeze?Object.freeze({}):{},util.isNode=Boolean(util.global.process&&util.global.process.versions&&util.global.process.versions.node),util.isInteger=Number.isInteger||function(value){return"number"==typeof value&&isFinite(value)&&Math.floor(value)===value},util.isString=function(value){return"string"==typeof value||value instanceof String},util.isObject=function(value){return value&&"object"==typeof value},util.isset=util.isSet=function(obj,prop){var value=obj[prop];return!(null==value||!obj.hasOwnProperty(prop))&&("object"!=typeof value||(Array.isArray(value)?value.length:Object.keys(value).length)>0)},util.Buffer=function(){try{var Buffer=util.inquire("buffer").Buffer;return Buffer.prototype.utf8Write?Buffer:null}catch(e){return null}}(),util._Buffer_from=null,util._Buffer_allocUnsafe=null,util.newBuffer=function(sizeOrArray){return"number"==typeof sizeOrArray?util.Buffer?util._Buffer_allocUnsafe(sizeOrArray):new util.Array(sizeOrArray):util.Buffer?util._Buffer_from(sizeOrArray):"undefined"==typeof Uint8Array?sizeOrArray:new Uint8Array(sizeOrArray)},util.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,util.Long=util.global.dcodeIO&&util.global.dcodeIO.Long||util.global.Long||util.inquire("long"),util.key2Re=/^true|false|0|1$/,util.key32Re=/^-?(?:0|[1-9][0-9]*)$/,util.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,util.longToHash=function(value){return value?util.LongBits.from(value).toHash():util.LongBits.zeroHash},util.longFromHash=function(hash,unsigned){var bits=util.LongBits.fromHash(hash);return util.Long?util.Long.fromBits(bits.lo,bits.hi,unsigned):bits.toNumber(Boolean(unsigned))},util.merge=merge,util.lcFirst=function(str){return str.charAt(0).toLowerCase()+str.substring(1)},util.newError=newError,util.ProtocolError=newError("ProtocolError"),util.oneOfGetter=function(fieldNames){for(var fieldMap={},i=0;i<fieldNames.length;++i)fieldMap[fieldNames[i]]=1;return function(){for(var keys=Object.keys(this),i=keys.length-1;i>-1;--i)if(1===fieldMap[keys[i]]&&this[keys[i]]!==undefined&&null!==this[keys[i]])return keys[i]}},util.oneOfSetter=function(fieldNames){return function(name){for(var i=0;i<fieldNames.length;++i)fieldNames[i]!==name&&delete this[fieldNames[i]]}},util.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},util._configure=function(){var Buffer=util.Buffer;Buffer?(util._Buffer_from=Buffer.from!==Uint8Array.from&&Buffer.from||function(value,encoding){return new Buffer(value,encoding)},util._Buffer_allocUnsafe=Buffer.allocUnsafe||function(size){return new Buffer(size)}):util._Buffer_from=util._Buffer_allocUnsafe=null}},{1:1,10:10,2:2,38:38,4:4,6:6,7:7,9:9}],40:[function(require,module,exports){module.exports=function(mtype){var gen=util.codegen(["m"],mtype.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),oneofs=mtype.oneofsArray,seenFirstField={};oneofs.length&&gen("var p={}");for(var i=0;i<mtype.fieldsArray.length;++i){var field=mtype._fieldsArray[i].resolve(),ref="m"+util.safeProp(field.name);if(field.optional&&gen("if(%s!=null&&m.hasOwnProperty(%j)){",ref,field.name),field.map)gen("if(!util.isObject(%s))",ref)("return%j",invalid(field,"object"))("var k=Object.keys(%s)",ref)("for(var i=0;i<k.length;++i){"),genVerifyKey(gen,field,"k[i]"),genVerifyValue(gen,field,i,ref+"[k[i]]")("}");else if(field.repeated)gen("if(!Array.isArray(%s))",ref)("return%j",invalid(field,"array"))("for(var i=0;i<%s.length;++i){",ref),genVerifyValue(gen,field,i,ref+"[i]")("}");else{if(field.partOf){var oneofProp=util.safeProp(field.partOf.name);1===seenFirstField[field.partOf.name]&&gen("if(p%s===1)",oneofProp)("return%j",field.partOf.name+": multiple values"),seenFirstField[field.partOf.name]=1,gen("p%s=1",oneofProp)}genVerifyValue(gen,field,i,ref)}field.optional&&gen("}")}return gen("return null")};var Enum=require(15),util=require(37);function invalid(field,expected){return field.name+": "+expected+(field.repeated&&"array"!==expected?"[]":field.map&&"object"!==expected?"{k:"+field.keyType+"}":"")+" expected"}function genVerifyValue(gen,field,fieldIndex,ref){if(field.resolvedType)if(field.resolvedType instanceof Enum){gen("switch(%s){",ref)("default:")("return%j",invalid(field,"enum value"));for(var keys=Object.keys(field.resolvedType.values),j=0;j<keys.length;++j)gen("case %i:",field.resolvedType.values[keys[j]]);gen("break")("}")}else gen("{")("var e=types[%i].verify(%s);",fieldIndex,ref)("if(e)")("return%j+e",field.name+".")("}");else switch(field.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":gen("if(!util.isInteger(%s))",ref)("return%j",invalid(field,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":gen("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",ref,ref,ref,ref)("return%j",invalid(field,"integer|Long"));break;case"float":case"double":gen('if(typeof %s!=="number")',ref)("return%j",invalid(field,"number"));break;case"bool":gen('if(typeof %s!=="boolean")',ref)("return%j",invalid(field,"boolean"));break;case"string":gen("if(!util.isString(%s))",ref)("return%j",invalid(field,"string"));break;case"bytes":gen('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',ref,ref,ref)("return%j",invalid(field,"buffer"))}return gen}function genVerifyKey(gen,field,ref){switch(field.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":gen("if(!util.key32Re.test(%s))",ref)("return%j",invalid(field,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":gen("if(!util.key64Re.test(%s))",ref)("return%j",invalid(field,"integer|Long key"));break;case"bool":gen("if(!util.key2Re.test(%s))",ref)("return%j",invalid(field,"boolean key"))}return gen}},{15:15,37:37}],41:[function(require,module,exports){var wrappers=exports,Message=require(21);wrappers[".google.protobuf.Any"]={fromObject:function(object){if(object&&object["@type"]){var type=this.lookup(object["@type"]);if(type){var type_url="."===object["@type"].charAt(0)?object["@type"].substr(1):object["@type"];return this.create({type_url:"/"+type_url,value:type.encode(type.fromObject(object)).finish()})}}return this.fromObject(object)},toObject:function(message,options){if(options&&options.json&&message.type_url&&message.value){var name=message.type_url.substring(message.type_url.lastIndexOf("/")+1),type=this.lookup(name);type&&(message=type.decode(message.value))}if(!(message instanceof this.ctor)&&message instanceof Message){var object=message.$type.toObject(message,options);return object["@type"]=message.$type.fullName,object}return this.toObject(message,options)}}},{21:21}],42:[function(require,module,exports){module.exports=Writer;var BufferWriter,util=require(39),LongBits=util.LongBits,base64=util.base64,utf8=util.utf8;function Op(fn,len,val){this.fn=fn,this.len=len,this.next=undefined,this.val=val}function noop(){}function State(writer){this.head=writer.head,this.tail=writer.tail,this.len=writer.len,this.next=writer.states}function Writer(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}function writeByte(val,buf,pos){buf[pos]=255&val}function VarintOp(len,val){this.len=len,this.next=undefined,this.val=val}function writeVarint64(val,buf,pos){for(;val.hi;)buf[pos++]=127&val.lo|128,val.lo=(val.lo>>>7|val.hi<<25)>>>0,val.hi>>>=7;for(;val.lo>127;)buf[pos++]=127&val.lo|128,val.lo=val.lo>>>7;buf[pos++]=val.lo}function writeFixed32(val,buf,pos){buf[pos]=255&val,buf[pos+1]=val>>>8&255,buf[pos+2]=val>>>16&255,buf[pos+3]=val>>>24}Writer.create=util.Buffer?function(){return(Writer.create=function(){return new BufferWriter})()}:function(){return new Writer},Writer.alloc=function(size){return new util.Array(size)},util.Array!==Array&&(Writer.alloc=util.pool(Writer.alloc,util.Array.prototype.subarray)),Writer.prototype._push=function(fn,len,val){return this.tail=this.tail.next=new Op(fn,len,val),this.len+=len,this},VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=function(val,buf,pos){for(;val>127;)buf[pos++]=127&val|128,val>>>=7;buf[pos]=val},Writer.prototype.uint32=function(value){return this.len+=(this.tail=this.tail.next=new VarintOp((value>>>=0)<128?1:value<16384?2:value<2097152?3:value<268435456?4:5,value)).len,this},Writer.prototype.int32=function(value){return value<0?this._push(writeVarint64,10,LongBits.fromNumber(value)):this.uint32(value)},Writer.prototype.sint32=function(value){return this.uint32((value<<1^value>>31)>>>0)},Writer.prototype.uint64=function(value){var bits=LongBits.from(value);return this._push(writeVarint64,bits.length(),bits)},Writer.prototype.int64=Writer.prototype.uint64,Writer.prototype.sint64=function(value){var bits=LongBits.from(value).zzEncode();return this._push(writeVarint64,bits.length(),bits)},Writer.prototype.bool=function(value){return this._push(writeByte,1,value?1:0)},Writer.prototype.fixed32=function(value){return this._push(writeFixed32,4,value>>>0)},Writer.prototype.sfixed32=Writer.prototype.fixed32,Writer.prototype.fixed64=function(value){var bits=LongBits.from(value);return this._push(writeFixed32,4,bits.lo)._push(writeFixed32,4,bits.hi)},Writer.prototype.sfixed64=Writer.prototype.fixed64,Writer.prototype.float=function(value){return this._push(util.float.writeFloatLE,4,value)},Writer.prototype.double=function(value){return this._push(util.float.writeDoubleLE,8,value)};var writeBytes=util.Array.prototype.set?function(val,buf,pos){buf.set(val,pos)}:function(val,buf,pos){for(var i=0;i<val.length;++i)buf[pos+i]=val[i]};Writer.prototype.bytes=function(value){var len=value.length>>>0;if(!len)return this._push(writeByte,1,0);if(util.isString(value)){var buf=Writer.alloc(len=base64.length(value));base64.decode(value,buf,0),value=buf}return this.uint32(len)._push(writeBytes,len,value)},Writer.prototype.string=function(value){var len=utf8.length(value);return len?this.uint32(len)._push(utf8.write,len,value):this._push(writeByte,1,0)},Writer.prototype.fork=function(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this},Writer.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this},Writer.prototype.ldelim=function(){var head=this.head,tail=this.tail,len=this.len;return this.reset().uint32(len),len&&(this.tail.next=head.next,this.tail=tail,this.len+=len),this},Writer.prototype.finish=function(){for(var head=this.head.next,buf=this.constructor.alloc(this.len),pos=0;head;)head.fn(head.val,buf,pos),pos+=head.len,head=head.next;return buf},Writer._configure=function(BufferWriter_){BufferWriter=BufferWriter_}},{39:39}],43:[function(require,module,exports){module.exports=BufferWriter;var Writer=require(42);(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util=require(39),Buffer=util.Buffer;function BufferWriter(){Writer.call(this)}BufferWriter.alloc=function(size){return(BufferWriter.alloc=util._Buffer_allocUnsafe)(size)};var writeBytesBuffer=Buffer&&Buffer.prototype instanceof Uint8Array&&"set"===Buffer.prototype.set.name?function(val,buf,pos){buf.set(val,pos)}:function(val,buf,pos){if(val.copy)val.copy(buf,pos,0,val.length);else for(var i=0;i<val.length;)buf[pos++]=val[i++]};function writeStringBuffer(val,buf,pos){val.length<40?util.utf8.write(val,buf,pos):buf.utf8Write(val,pos)}BufferWriter.prototype.bytes=function(value){util.isString(value)&&(value=util._Buffer_from(value,"base64"));var len=value.length>>>0;return this.uint32(len),len&&this._push(writeBytesBuffer,len,value),this},BufferWriter.prototype.string=function(value){var len=Buffer.byteLength(value);return this.uint32(len),len&&this._push(writeStringBuffer,len,value),this}},{39:39,42:42}]},{},[19])}()}).call(this,__webpack_require__(68),__webpack_require__(76)(module))},function(module,exports){module.exports=function(module){return module.webpackPolyfill||(module.deprecate=function(){},module.paths=[],module.children||(module.children=[]),Object.defineProperty(module,"loaded",{enumerable:!0,get:function(){return module.l}}),Object.defineProperty(module,"id",{enumerable:!0,get:function(){return module.i}}),module.webpackPolyfill=1),module}},function(module,exports){module.exports=Long;var wasm=null;try{wasm=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}function Long(low,high,unsigned){this.low=0|low,this.high=0|high,this.unsigned=!!unsigned}function isLong(obj){return!0===(obj&&obj.__isLong__)}Long.prototype.__isLong__,Object.defineProperty(Long.prototype,"__isLong__",{value:!0}),Long.isLong=isLong;var INT_CACHE={},UINT_CACHE={};function fromInt(value,unsigned){var obj,cachedObj,cache;return unsigned?(cache=0<=(value>>>=0)&&value<256)&&(cachedObj=UINT_CACHE[value])?cachedObj:(obj=fromBits(value,(0|value)<0?-1:0,!0),cache&&(UINT_CACHE[value]=obj),obj):(cache=-128<=(value|=0)&&value<128)&&(cachedObj=INT_CACHE[value])?cachedObj:(obj=fromBits(value,value<0?-1:0,!1),cache&&(INT_CACHE[value]=obj),obj)}function fromNumber(value,unsigned){if(isNaN(value))return unsigned?UZERO:ZERO;if(unsigned){if(value<0)return UZERO;if(value>=TWO_PWR_64_DBL)return MAX_UNSIGNED_VALUE}else{if(value<=-TWO_PWR_63_DBL)return MIN_VALUE;if(value+1>=TWO_PWR_63_DBL)return MAX_VALUE}return value<0?fromNumber(-value,unsigned).neg():fromBits(value%TWO_PWR_32_DBL|0,value/TWO_PWR_32_DBL|0,unsigned)}function fromBits(lowBits,highBits,unsigned){return new Long(lowBits,highBits,unsigned)}Long.fromInt=fromInt,Long.fromNumber=fromNumber,Long.fromBits=fromBits;var pow_dbl=Math.pow;function fromString(str,unsigned,radix){if(0===str.length)throw Error("empty string");if("NaN"===str||"Infinity"===str||"+Infinity"===str||"-Infinity"===str)return ZERO;if("number"==typeof unsigned?(radix=unsigned,unsigned=!1):unsigned=!!unsigned,(radix=radix||10)<2||36<radix)throw RangeError("radix");var p;if((p=str.indexOf("-"))>0)throw Error("interior hyphen");if(0===p)return fromString(str.substring(1),unsigned,radix).neg();for(var radixToPower=fromNumber(pow_dbl(radix,8)),result=ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(size<8){var power=fromNumber(pow_dbl(radix,size));result=result.mul(power).add(fromNumber(value))}else result=(result=result.mul(radixToPower)).add(fromNumber(value))}return result.unsigned=unsigned,result}function fromValue(val,unsigned){return"number"==typeof val?fromNumber(val,unsigned):"string"==typeof val?fromString(val,unsigned):fromBits(val.low,val.high,"boolean"==typeof unsigned?unsigned:val.unsigned)}Long.fromString=fromString,Long.fromValue=fromValue;var TWO_PWR_32_DBL=4294967296,TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=fromInt(1<<24),ZERO=fromInt(0);Long.ZERO=ZERO;var UZERO=fromInt(0,!0);Long.UZERO=UZERO;var ONE=fromInt(1);Long.ONE=ONE;var UONE=fromInt(1,!0);Long.UONE=UONE;var NEG_ONE=fromInt(-1);Long.NEG_ONE=NEG_ONE;var MAX_VALUE=fromBits(-1,2147483647,!1);Long.MAX_VALUE=MAX_VALUE;var MAX_UNSIGNED_VALUE=fromBits(-1,-1,!0);Long.MAX_UNSIGNED_VALUE=MAX_UNSIGNED_VALUE;var MIN_VALUE=fromBits(0,-2147483648,!1);Long.MIN_VALUE=MIN_VALUE;var LongPrototype=Long.prototype;LongPrototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},LongPrototype.toNumber=function(){return this.unsigned?(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0):this.high*TWO_PWR_32_DBL+(this.low>>>0)},LongPrototype.toString=function(radix){if((radix=radix||10)<2||36<radix)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(MIN_VALUE)){var radixLong=fromNumber(radix),div=this.div(radixLong),rem1=div.mul(radixLong).sub(this);return div.toString(radix)+rem1.toInt().toString(radix)}return"-"+this.neg().toString(radix)}for(var radixToPower=fromNumber(pow_dbl(radix,6),this.unsigned),rem=this,result="";;){var remDiv=rem.div(radixToPower),digits=(rem.sub(remDiv.mul(radixToPower)).toInt()>>>0).toString(radix);if((rem=remDiv).isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},LongPrototype.getHighBits=function(){return this.high},LongPrototype.getHighBitsUnsigned=function(){return this.high>>>0},LongPrototype.getLowBits=function(){return this.low},LongPrototype.getLowBitsUnsigned=function(){return this.low>>>0},LongPrototype.getNumBitsAbs=function(){if(this.isNegative())return this.eq(MIN_VALUE)?64:this.neg().getNumBitsAbs();for(var val=0!=this.high?this.high:this.low,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high?bit+33:bit+1},LongPrototype.isZero=function(){return 0===this.high&&0===this.low},LongPrototype.eqz=LongPrototype.isZero,LongPrototype.isNegative=function(){return!this.unsigned&&this.high<0},LongPrototype.isPositive=function(){return this.unsigned||this.high>=0},LongPrototype.isOdd=function(){return 1==(1&this.low)},LongPrototype.isEven=function(){return 0==(1&this.low)},LongPrototype.equals=function(other){return isLong(other)||(other=fromValue(other)),(this.unsigned===other.unsigned||this.high>>>31!=1||other.high>>>31!=1)&&(this.high===other.high&&this.low===other.low)},LongPrototype.eq=LongPrototype.equals,LongPrototype.notEquals=function(other){return!this.eq(other)},LongPrototype.neq=LongPrototype.notEquals,LongPrototype.ne=LongPrototype.notEquals,LongPrototype.lessThan=function(other){return this.comp(other)<0},LongPrototype.lt=LongPrototype.lessThan,LongPrototype.lessThanOrEqual=function(other){return this.comp(other)<=0},LongPrototype.lte=LongPrototype.lessThanOrEqual,LongPrototype.le=LongPrototype.lessThanOrEqual,LongPrototype.greaterThan=function(other){return this.comp(other)>0},LongPrototype.gt=LongPrototype.greaterThan,LongPrototype.greaterThanOrEqual=function(other){return this.comp(other)>=0},LongPrototype.gte=LongPrototype.greaterThanOrEqual,LongPrototype.ge=LongPrototype.greaterThanOrEqual,LongPrototype.compare=function(other){if(isLong(other)||(other=fromValue(other)),this.eq(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();return thisNeg&&!otherNeg?-1:!thisNeg&&otherNeg?1:this.unsigned?other.high>>>0>this.high>>>0||other.high===this.high&&other.low>>>0>this.low>>>0?-1:1:this.sub(other).isNegative()?-1:1},LongPrototype.comp=LongPrototype.compare,LongPrototype.negate=function(){return!this.unsigned&&this.eq(MIN_VALUE)?MIN_VALUE:this.not().add(ONE)},LongPrototype.neg=LongPrototype.negate,LongPrototype.add=function(addend){isLong(addend)||(addend=fromValue(addend));var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=addend.high>>>16,b32=65535&addend.high,b16=addend.low>>>16,c48=0,c32=0,c16=0,c00=0;return c16+=(c00+=a00+(65535&addend.low))>>>16,c32+=(c16+=a16+b16)>>>16,c48+=(c32+=a32+b32)>>>16,c48+=a48+b48,fromBits((c16&=65535)<<16|(c00&=65535),(c48&=65535)<<16|(c32&=65535),this.unsigned)},LongPrototype.subtract=function(subtrahend){return isLong(subtrahend)||(subtrahend=fromValue(subtrahend)),this.add(subtrahend.neg())},LongPrototype.sub=LongPrototype.subtract,LongPrototype.multiply=function(multiplier){if(this.isZero())return ZERO;if(isLong(multiplier)||(multiplier=fromValue(multiplier)),wasm)return fromBits(wasm.mul(this.low,this.high,multiplier.low,multiplier.high),wasm.get_high(),this.unsigned);if(multiplier.isZero())return ZERO;if(this.eq(MIN_VALUE))return multiplier.isOdd()?MIN_VALUE:ZERO;if(multiplier.eq(MIN_VALUE))return this.isOdd()?MIN_VALUE:ZERO;if(this.isNegative())return multiplier.isNegative()?this.neg().mul(multiplier.neg()):this.neg().mul(multiplier).neg();if(multiplier.isNegative())return this.mul(multiplier.neg()).neg();if(this.lt(TWO_PWR_24)&&multiplier.lt(TWO_PWR_24))return fromNumber(this.toNumber()*multiplier.toNumber(),this.unsigned);var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=multiplier.high>>>16,b32=65535&multiplier.high,b16=multiplier.low>>>16,b00=65535&multiplier.low,c48=0,c32=0,c16=0,c00=0;return c16+=(c00+=a00*b00)>>>16,c32+=(c16+=a16*b00)>>>16,c16&=65535,c32+=(c16+=a00*b16)>>>16,c48+=(c32+=a32*b00)>>>16,c32&=65535,c48+=(c32+=a16*b16)>>>16,c32&=65535,c48+=(c32+=a00*b32)>>>16,c48+=a48*b00+a32*b16+a16*b32+a00*b48,fromBits((c16&=65535)<<16|(c00&=65535),(c48&=65535)<<16|(c32&=65535),this.unsigned)},LongPrototype.mul=LongPrototype.multiply,LongPrototype.divide=function(divisor){if(isLong(divisor)||(divisor=fromValue(divisor)),divisor.isZero())throw Error("division by zero");var approx,rem,res;if(wasm)return this.unsigned||-2147483648!==this.high||-1!==divisor.low||-1!==divisor.high?fromBits((this.unsigned?wasm.div_u:wasm.div_s)(this.low,this.high,divisor.low,divisor.high),wasm.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?UZERO:ZERO;if(this.unsigned){if(divisor.unsigned||(divisor=divisor.toUnsigned()),divisor.gt(this))return UZERO;if(divisor.gt(this.shru(1)))return UONE;res=UZERO}else{if(this.eq(MIN_VALUE))return divisor.eq(ONE)||divisor.eq(NEG_ONE)?MIN_VALUE:divisor.eq(MIN_VALUE)?ONE:(approx=this.shr(1).div(divisor).shl(1)).eq(ZERO)?divisor.isNegative()?ONE:NEG_ONE:(rem=this.sub(divisor.mul(approx)),res=approx.add(rem.div(divisor)));if(divisor.eq(MIN_VALUE))return this.unsigned?UZERO:ZERO;if(this.isNegative())return divisor.isNegative()?this.neg().div(divisor.neg()):this.neg().div(divisor).neg();if(divisor.isNegative())return this.div(divisor.neg()).neg();res=ZERO}for(rem=this;rem.gte(divisor);){approx=Math.max(1,Math.floor(rem.toNumber()/divisor.toNumber()));for(var log2=Math.ceil(Math.log(approx)/Math.LN2),delta=log2<=48?1:pow_dbl(2,log2-48),approxRes=fromNumber(approx),approxRem=approxRes.mul(divisor);approxRem.isNegative()||approxRem.gt(rem);)approxRem=(approxRes=fromNumber(approx-=delta,this.unsigned)).mul(divisor);approxRes.isZero()&&(approxRes=ONE),res=res.add(approxRes),rem=rem.sub(approxRem)}return res},LongPrototype.div=LongPrototype.divide,LongPrototype.modulo=function(divisor){return isLong(divisor)||(divisor=fromValue(divisor)),wasm?fromBits((this.unsigned?wasm.rem_u:wasm.rem_s)(this.low,this.high,divisor.low,divisor.high),wasm.get_high(),this.unsigned):this.sub(this.div(divisor).mul(divisor))},LongPrototype.mod=LongPrototype.modulo,LongPrototype.rem=LongPrototype.modulo,LongPrototype.not=function(){return fromBits(~this.low,~this.high,this.unsigned)},LongPrototype.and=function(other){return isLong(other)||(other=fromValue(other)),fromBits(this.low&other.low,this.high&other.high,this.unsigned)},LongPrototype.or=function(other){return isLong(other)||(other=fromValue(other)),fromBits(this.low|other.low,this.high|other.high,this.unsigned)},LongPrototype.xor=function(other){return isLong(other)||(other=fromValue(other)),fromBits(this.low^other.low,this.high^other.high,this.unsigned)},LongPrototype.shiftLeft=function(numBits){return isLong(numBits)&&(numBits=numBits.toInt()),0==(numBits&=63)?this:numBits<32?fromBits(this.low<<numBits,this.high<<numBits|this.low>>>32-numBits,this.unsigned):fromBits(0,this.low<<numBits-32,this.unsigned)},LongPrototype.shl=LongPrototype.shiftLeft,LongPrototype.shiftRight=function(numBits){return isLong(numBits)&&(numBits=numBits.toInt()),0==(numBits&=63)?this:numBits<32?fromBits(this.low>>>numBits|this.high<<32-numBits,this.high>>numBits,this.unsigned):fromBits(this.high>>numBits-32,this.high>=0?0:-1,this.unsigned)},LongPrototype.shr=LongPrototype.shiftRight,LongPrototype.shiftRightUnsigned=function(numBits){if(isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63))return this;var high=this.high;return numBits<32?fromBits(this.low>>>numBits|high<<32-numBits,high>>>numBits,this.unsigned):fromBits(32===numBits?high:high>>>numBits-32,0,this.unsigned)},LongPrototype.shru=LongPrototype.shiftRightUnsigned,LongPrototype.shr_u=LongPrototype.shiftRightUnsigned,LongPrototype.toSigned=function(){return this.unsigned?fromBits(this.low,this.high,!1):this},LongPrototype.toUnsigned=function(){return this.unsigned?this:fromBits(this.low,this.high,!0)},LongPrototype.toBytes=function(le){return le?this.toBytesLE():this.toBytesBE()},LongPrototype.toBytesLE=function(){var hi=this.high,lo=this.low;return[255&lo,lo>>>8&255,lo>>>16&255,lo>>>24,255&hi,hi>>>8&255,hi>>>16&255,hi>>>24]},LongPrototype.toBytesBE=function(){var hi=this.high,lo=this.low;return[hi>>>24,hi>>>16&255,hi>>>8&255,255&hi,lo>>>24,lo>>>16&255,lo>>>8&255,255&lo]},Long.fromBytes=function(bytes,unsigned,le){return le?Long.fromBytesLE(bytes,unsigned):Long.fromBytesBE(bytes,unsigned)},Long.fromBytesLE=function(bytes,unsigned){return new Long(bytes[0]|bytes[1]<<8|bytes[2]<<16|bytes[3]<<24,bytes[4]|bytes[5]<<8|bytes[6]<<16|bytes[7]<<24,unsigned)},Long.fromBytesBE=function(bytes,unsigned){return new Long(bytes[4]<<24|bytes[5]<<16|bytes[6]<<8|bytes[7],bytes[0]<<24|bytes[1]<<16|bytes[2]<<8|bytes[3],unsigned)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StubLoader",function(){return StubLoader});var _loader_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(56);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */class StubLoader extends _loader_js__WEBPACK_IMPORTED_MODULE_0__.Loader{constructor(fileMap){super(),this._fileMap=fileMap,fileMap.hasOwnProperty("*")&&(this._cannedResponse=fileMap["*"])}loadResource(path){return this._fileMap.hasOwnProperty(path)?this._fileMap[path]:this._cannedResponse||super.loadResource(path)}path(fileName){return this._fileMap.hasOwnProperty(fileName)||this._cannedResponse?fileName:super.path(fileName)}join(prefix,path){return this._fileMap.hasOwnProperty(prefix)||this._cannedResponse?path:super.join(prefix,path)}clone(){return new StubLoader(this._fileMap)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ParticleExecutionHost",function(){return ParticleExecutionHost});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_api_channel_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(69),_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(26),_manifest_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(41),_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(80),_services_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(84);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ParticleExecutionHost{constructor(port,slotComposer,arc){this.nextIdentifier=0,this.idleVersion=0,this.close=(()=>{port.close(),this._apiPort.close()}),this.arc=arc,this.slotComposer=slotComposer;const pec=this;this._apiPort=new class extends _api_channel_js__WEBPACK_IMPORTED_MODULE_1__.PECOuterPort{onRender(particle,slotName,content){pec.slotComposer&&pec.slotComposer.renderSlot(particle,slotName,content)}onInitializeProxy(handle,callback){handle.on("change",data=>this.SimpleCallback(callback,data),{})}async onSynchronizeProxy(handle,callback){const data=await handle.modelForSynchronization();this.SimpleCallback(callback,data)}async onHandleGet(handle,callback){const data=await handle.get();this.SimpleCallback(callback,data)}async onHandleToList(handle,callback){const data=await handle.toList();this.SimpleCallback(callback,data)}onHandleSet(handle,data,particleId,barrier){handle.set(data,particleId,barrier)}onHandleClear(handle,particleId,barrier){handle.clear(particleId,barrier)}async onHandleStore(handle,callback,data,particleId){await handle.store(data.value,data.keys,particleId),this.SimpleCallback(callback,{})}async onHandleRemove(handle,callback,data,particleId){await handle.remove(data.id,data.keys,particleId),this.SimpleCallback(callback,{})}async onHandleRemoveMultiple(handle,callback,data,particleId){await handle.removeMultiple(data,particleId),this.SimpleCallback(callback,{})}async onHandleStream(handle,callback,pageSize,forward){this.SimpleCallback(callback,await handle.stream(pageSize,forward))}async onStreamCursorNext(handle,callback,cursorId){this.SimpleCallback(callback,await handle.cursorNext(cursorId))}onStreamCursorClose(handle,cursorId){handle.cursorClose(cursorId)}onIdle(version,relevance){version===pec.idleVersion&&(pec.idlePromise=void 0,pec.idleResolve(relevance))}async onGetBackingStore(callback,storageKey,type){storageKey||(storageKey=pec.arc.storageProviderFactory.baseStorageKey(type,pec.arc.storageKey||"volatile"));const store=await pec.arc.storageProviderFactory.baseStorageFor(type,storageKey);this.GetBackingStoreCallback(store,callback,type.collectionOf(),type.toString(),store.id,storageKey)}onConstructInnerArc(callback,particle){const arc=pec.arc.createInnerArc(particle);this.ConstructArcCallback(callback,arc)}async onArcCreateHandle(callback,arc,type,name){const store=await arc.createStore(type,name,null,[],"volatile");this.CreateHandleCallback(store,callback,type,name,store.id)}onArcMapHandle(callback,arc,handle){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(pec.arc.findStoreById(handle.id),`Cannot map nonexistent handle ${handle.id}`),this.MapHandleCallback({},callback,handle.id)}onArcCreateSlot(callback,arc,transformationParticle,transformationSlotName,handleId){let hostedSlotId;pec.slotComposer&&(hostedSlotId=pec.slotComposer.createHostedSlot(arc,transformationParticle,transformationSlotName,handleId)),this.CreateSlotCallback({},callback,hostedSlotId)}async onArcLoadRecipe(arc,recipe,callback){const manifest=await _manifest_js__WEBPACK_IMPORTED_MODULE_3__.Manifest.parse(recipe,{loader:arc.loader,fileName:""}),successResponse={providedSlotIds:{}};let error=void 0,recipe0=manifest.recipes[0];if(recipe0){for(const slot of recipe0.slots)if(slot.id=slot.id||`slotid-${arc.generateID()}`,slot.sourceConnection){const particlelocalName=slot.sourceConnection.particle.localName;particlelocalName&&(successResponse.providedSlotIds[`${particlelocalName}.${slot.name}`]=slot.id)}const missingHandles=[];for(const handle of recipe0.handles){const fromHandle=pec.arc.findStoreById(handle.id)||manifest.findStoreById(handle.id);fromHandle?handle.mapToStorage(fromHandle):missingHandles.push(handle)}if(missingHandles.length>0){let recipeToResolve=recipe0;for(const resolver of[new _recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_4__.RecipeResolver(arc),new _recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_4__.RecipeResolver(pec.arc)])recipeToResolve=await resolver.resolve(recipeToResolve)||recipeToResolve;recipeToResolve===recipe0?error=`Recipe couldn't load due to missing handles [recipe=${recipe0}, missingHandles=${missingHandles.join("\n")}].`:recipe0=recipeToResolve}if(!error){const options={errors:new Map};missingHandles.length>0||recipe0.normalize(options)?recipe0.isResolved()?(manifest.stores.forEach(async store=>{store instanceof _manifest_js__WEBPACK_IMPORTED_MODULE_3__.StorageStub?pec.arc._registerStore(await store.inflate(),[]):pec.arc._registerStore(store,[])}),arc.instantiate(recipe0)):error=`Recipe is not resolvable:\n${recipe0.toString({showUnresolved:!0})}`:error=`Recipe ${recipe0} could not be normalized:\n${[...options.errors.values()].join("\n")}`}}else error="No recipe defined";this.SimpleCallback(callback,error?{error:error}:successResponse)}onReportExceptionInHost(exception){exception.particleName||(exception.particleName=pec.arc.loadedParticleInfo.get(exception.particleId).spec.name),Object(_arc_exceptions_js__WEBPACK_IMPORTED_MODULE_2__.reportSystemException)(exception)}async onServiceRequest(particle,request,callback){const response=await _services_js__WEBPACK_IMPORTED_MODULE_5__.Services.request(request);this.SimpleCallback(callback,response)}}(port,arc)}stop(){this._apiPort.Stop()}get idle(){return null==this.idlePromise&&(this.idlePromise=new Promise((resolve,reject)=>{this.idleResolve=resolve})),this.idleVersion=this.nextIdentifier,this._apiPort.AwaitIdle(this.nextIdentifier++),this.idlePromise}get messageCount(){return this._apiPort.messageCount}sendEvent(particle,slotName,event){this._apiPort.UIEvent(particle,slotName,event)}instantiate(particle,stores){stores.forEach((store,name)=>{this._apiPort.DefineHandle(store,store.type.resolvedType(),name)}),this._apiPort.InstantiateParticle(particle,particle.id.toString(),particle.spec,stores)}startRender({particle:particle,slotName:slotName,providedSlots:providedSlots,contentTypes:contentTypes}){this._apiPort.StartRender(particle,slotName,providedSlots,contentTypes)}stopRender({particle:particle,slotName:slotName}){this._apiPort.StopRender(particle,slotName)}innerArcRender(transformationParticle,transformationSlotName,hostedSlotId,content){this._apiPort.InnerArcRender(transformationParticle,transformationSlotName,hostedSlotId,content)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ResolveWalker",function(){return ResolveWalker}),__webpack_require__.d(__webpack_exports__,"ResolveRecipeAction",function(){return ResolveRecipeAction}),__webpack_require__.d(__webpack_exports__,"RecipeResolver",function(){return RecipeResolver});var _recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(47),_recipe_recipe_walker_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(81),_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(83),_recipe_walker_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(82);class ResolveWalker extends _recipe_recipe_walker_js__WEBPACK_IMPORTED_MODULE_1__.RecipeWalker{constructor(tactic,arc){super(tactic),this.arc=arc}onHandle(recipe,handle){const arc=this.arc;if(0===handle.connections.length||handle.id&&handle.storageKey||!handle.type||!handle.fate)return;let mappable;if(handle.id){if(!handle.storageKey){let storeById;switch(handle.fate){case"use":storeById=arc.findStoreById(handle.id);break;case"map":case"copy":storeById=arc.context.findStoreById(handle.id);break;case"create":case"?":break;default:throw new Error(`unexpected fate ${handle.fate}`)}mappable=storeById?[storeById]:[]}}else{_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_0__.RecipeUtil.directionCounts(handle);switch(handle.fate){case"use":mappable=arc.findStoresByType(handle.type,{tags:handle.tags});break;case"map":case"copy":mappable=arc.context.findStoresByType(handle.type,{tags:handle.tags,subtype:!0});break;case"create":case"?":mappable=[];break;default:throw new Error(`unexpected fate ${handle.fate}`)}}return 1===(mappable=mappable.filter(incomingHandle=>{for(const existingHandle of recipe.handles)if(incomingHandle.id===existingHandle.id&&existingHandle!==handle)return!1;return!0})).length?(recipe,handle)=>(handle.mapToStorage(mappable[0]),0):void 0}onSlotConnection(recipe,slotConnection){const arc=this.arc;if(slotConnection.isConnected())return;const slotSpec=slotConnection.getSlotSpec(),particle=slotConnection.particle,{local:local,remote:remote}=_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_2__.SlotUtils.findAllSlotCandidates(particle,slotSpec,arc),allSlots=[...local,...remote];if(1!==allSlots.length)return;const selectedSlot=allSlots[0];return(recipe,slotConnection)=>(_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_2__.SlotUtils.connectSlotConnection(slotConnection,selectedSlot),1)}onPotentialSlotConnection(recipe,particle,slotSpec){const arc=this.arc,{local:local,remote:remote}=_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_2__.SlotUtils.findAllSlotCandidates(particle,slotSpec,arc),allSlots=[...local,...remote];if(1!==allSlots.length)return;const selectedSlot=allSlots[0];return(recipe,particle,slotSpec)=>{const newSlotConnection=particle.addSlotConnection(slotSpec.name);return _recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_2__.SlotUtils.connectSlotConnection(newSlotConnection,selectedSlot),1}}onObligation(recipe,obligation){const fromParticle=obligation.from.instance,toParticle=obligation.to.instance;for(const fromConnection of Object.values(fromParticle.connections))for(const toConnection of Object.values(toParticle.connections))if(fromConnection.handle&&fromConnection.handle===toConnection.handle)return(recipe,obligation)=>(recipe.removeObligation(obligation),1)}}class ResolveRecipeAction extends _recipe_walker_js__WEBPACK_IMPORTED_MODULE_3__.Action{async generate(inputParams){return ResolveWalker.walk(this.getResults(inputParams),new ResolveWalker(ResolveWalker.Permuted,this.arc),this)}}class RecipeResolver{constructor(arc){this.resolver=new ResolveRecipeAction(arc)}async resolve(recipe){recipe=recipe.clone();const options={errors:new Map};if(!recipe.normalize(options))return console.warn(`could not normalize a recipe: ${[...options.errors.values()].join("\n")}.\n${recipe.toString()}`),null;const result=await this.resolver.generate({generated:[{result:recipe,score:1}],terminal:[]});return 0===result.length?null:result[0].result}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"RecipeWalker",function(){return RecipeWalker});var _walker_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(82);class RecipeWalker extends _walker_js__WEBPACK_IMPORTED_MODULE_0__.Walker{onResult(result){super.onResult(result);const recipe=result.result;if(this.onRecipe&&this.visit(this.onRecipe.bind(this)),this.onParticle)for(const particle of recipe.particles)this.visit(this.onParticle.bind(this),particle);if(this.onPotentialHandleConnection)for(const particle of recipe.particles)if(particle.spec)for(const connectionSpec of particle.spec.handleConnectionMap.values())particle.connections[connectionSpec.name]||this.visit(this.onPotentialHandleConnection.bind(this),particle,connectionSpec);if(this.onHandleConnection)for(const handleConnection of recipe.handleConnections)this.visit(this.onHandleConnection.bind(this),handleConnection);if(this.onHandle)for(const handle of recipe.handles)this.visit(this.onHandle.bind(this),handle);if(this.onPotentialSlotConnection)for(const particle of recipe.particles)for(const[name,slotSpec]of particle.getSlotSpecs())particle.getSlotConnectionByName(name)||this.visit(this.onPotentialSlotConnection.bind(this),particle,slotSpec);if(this.onSlotConnection)for(const slotConnection of recipe.slotConnections)this.visit(this.onSlotConnection.bind(this),slotConnection);if(this.onSlot)for(const slot of recipe.slots)this.visit(this.onSlot.bind(this),slot);if(this.onObligation)for(const obligation of recipe.obligations)this.visit(this.onObligation.bind(this),obligation);if(this.onRequiredParticle)for(const require of recipe.requires)for(const particle of require.particles)this.visit(this.onRequiredParticle.bind(this),particle)}createDescendant(recipe,score){const valid=recipe.normalize(),hash=valid?recipe.digest():null;super.createWalkerDescendant(recipe,score,hash,valid)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"WalkerTactic",function(){return WalkerTactic}),__webpack_require__.d(__webpack_exports__,"Action",function(){return Action}),__webpack_require__.d(__webpack_exports__,"Walker",function(){return Walker});var WalkerTactic,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);!function(WalkerTactic){WalkerTactic.Permuted="permuted",WalkerTactic.Independent="independent"}(WalkerTactic||(WalkerTactic={}));class Action{constructor(arc,args){this._arc=arc,this._args=args}get arc(){return this._arc}getResults(inputParams){return inputParams.generated}async generate(inputParams){return[]}}class Walker{constructor(tactic){this.descendants=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(tactic),this.tactic=tactic}onAction(action){this.currentAction=action}onResult(result){this.currentResult=result,this.updateList=[]}onResultDone(){this.runUpdateList(this.currentResult.result,this.updateList),this.currentResult=void 0,this.updateList=void 0}onActionDone(){this.currentAction=void 0}static walk(results,walker,action){return walker.onAction(action),results.forEach(result=>{walker.onResult(result),walker.onResultDone()}),walker.onActionDone(),walker.descendants}visit(visitor,...context){const continuation=visitor(this.currentResult.result,...context);this.isEmptyResult(continuation)||this.updateList.push({continuation:continuation,context:context})}runUpdateList(start,updateList){const updated=[];if(updateList.length)switch(this.tactic){case WalkerTactic.Permuted:{let permutations=[[]];updateList.forEach(({continuation:continuation,context:context})=>{const newResults=[];"function"==typeof continuation&&(continuation=[continuation]),continuation.forEach(f=>{permutations.forEach(p=>{const newP=p.slice();newP.push({continuation:f,context:context}),newResults.push(newP)})}),permutations=newResults});for(let permutation of permutations){const cloneMap=new Map,newResult=start.clone(cloneMap);let score=0;0!==(permutation=permutation.filter(p=>null!==p.continuation)).length&&(permutation.forEach(({continuation:continuation,context:context})=>{score=continuation(newResult,...context.map(c=>cloneMap.get(c)||c))}),updated.push({result:newResult,score:score}))}break}case WalkerTactic.Independent:updateList.forEach(({continuation:continuation,context:context})=>{"function"==typeof continuation&&(continuation=[continuation]);let score=0;continuation.forEach(f=>{null==f&&(f=(()=>0));const cloneMap=new Map,newResult=start.clone(cloneMap);score=f(newResult,...context.map(c=>cloneMap.get(c)||c)),updated.push({result:newResult,score:score})})});break;default:throw new Error(`${this.tactic} not supported`)}for(const newResult of updated)this.createDescendant(newResult.result,newResult.score)}createWalkerDescendant(item,score,hash,valid){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.currentResult,"no current result"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.currentAction,"no current action"),this.currentResult.score&&(score+=this.currentResult.score),this.descendants.push({result:item,score:score,derivation:[{parent:this.currentResult,strategy:this.currentAction}],hash:hash,valid:valid})}isEmptyResult(result){return!result||(result.constructor===Array&&result.length<=0||(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("function"==typeof result||result.length),!1))}}Walker.Permuted=WalkerTactic.Permuted,Walker.Independent=WalkerTactic.Independent},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotUtils",function(){return SlotUtils});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_recipe_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(48);class SlotUtils{static getClonedSlot(recipe,selectedSlot){let clonedSlot=recipe.updateToClone({selectedSlot:selectedSlot}).selectedSlot;return clonedSlot||(selectedSlot.id&&(clonedSlot=recipe.findSlotByID(selectedSlot.id)),null==clonedSlot&&((clonedSlot=recipe instanceof _recipe_js__WEBPACK_IMPORTED_MODULE_1__.RequireSection?recipe.parent.newSlot(selectedSlot.name):recipe.newSlot(selectedSlot.name)).id=selectedSlot.id)),clonedSlot}static connectSlotConnection(slotConnection,selectedSlot){const recipe=slotConnection.recipe;if(!slotConnection.targetSlot){const clonedSlot=SlotUtils.getClonedSlot(recipe,selectedSlot);slotConnection.connectToSlot(clonedSlot)}Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!selectedSlot.id||!slotConnection.targetSlot.id||selectedSlot.id===slotConnection.targetSlot.id,`Cannot override slot id '${slotConnection.targetSlot.id}' with '${selectedSlot.id}'`),slotConnection.targetSlot.id=selectedSlot.id||slotConnection.targetSlot.id,slotConnection.targetSlot.tags=[...selectedSlot.tags]}static findAllSlotCandidates(particle,slotSpec,arc){const slotConn=particle.getSlotConnectionByName(slotSpec.name);return{local:slotConn&&slotConn.targetSlot?[]:SlotUtils._findSlotCandidates(particle,slotSpec,particle.recipe.slots),remote:SlotUtils._findSlotCandidates(particle,slotSpec,arc.pec.slotComposer.getAvailableContexts())}}static _findSlotCandidates(particle,slotSpec,slots){const possibleSlots=slots.filter(s=>this.slotMatches(particle,slotSpec,s));return possibleSlots.sort((slot1,slot2)=>slot1.name<slot2.name),possibleSlots}static slotMatches(particle,slotSpec,slot){if(!SlotUtils.specMatch(slotSpec,slot.spec))return!1;const potentialSlotConn=particle.getSlotConnectionBySpec(slotSpec);return!!SlotUtils.tagsOrNameMatch(slotSpec,slot.spec,potentialSlotConn,slot)&&!!SlotUtils.handlesMatch(particle,slot)}static specMatch(slotSpec,providedSlotSpec){return slotSpec&&providedSlotSpec&&slotSpec.isSet===providedSlotSpec.isSet}static handlesMatch(particle,slot){return 0===slot.handles.length||!!Object.values(particle.connections).find(handleConn=>slot.handles.includes(handleConn.handle)||handleConn.handle&&handleConn.handle.id&&slot.handles.map(sh=>sh.id).includes(handleConn.handle.id))}static tagsOrNameMatch(consumeSlotSpec,provideSlotSpec,consumeSlotConn,provideSlot){const consumeTags=[].concat(consumeSlotSpec.tags||[],consumeSlotConn?consumeSlotConn.tags:[],consumeSlotConn&&consumeSlotConn.targetSlot?consumeSlotConn.targetSlot.tags:[]),provideTags=[].concat(provideSlotSpec.tags||[],provideSlot?provideSlot.tags:[],provideSlot?provideSlot.name:provideSlotSpec.name?provideSlotSpec.name:[]);return!!(consumeTags.length>0&&consumeTags.some(t=>provideTags.includes(t)))||consumeSlotSpec.name===(provideSlot?provideSlot.name:provideSlotSpec.name)}static replaceOldSlot(recipe,oldSlot,newSlot){if(oldSlot&&(!oldSlot.id||oldSlot.id!==newSlot.id)){if(void 0!==oldSlot.sourceConnection){if(void 0===newSlot.sourceConnection)return!1;const clonedSlot=SlotUtils.getClonedSlot(oldSlot.sourceConnection.recipe,newSlot);oldSlot.sourceConnection.providedSlots[oldSlot.name]=clonedSlot}for(;oldSlot.consumeConnections.length>0;){const conn=oldSlot.consumeConnections[0];conn.disconnectFromSlot(),SlotUtils.connectSlotConnection(conn,newSlot)}}return!0}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Services",function(){return Services});class Services{static register(name,service){Services.registry[name]=service}static async request(request){let{service:name,invoke:invoke,call:call}=request;call&&([name,invoke]=call.split("."));const service=Services.registry[name];return service&&service[invoke]?await service[invoke](request):null}}Services.registry={},Object.freeze(Services),Services.register("test",{classify:async request=>({data:"it's a pig, that don't fly straight"})})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Mutex",function(){return Mutex});class Mutex{constructor(){this.next=Promise.resolve(),this.depth=0}get locked(){return 0!==this.depth}async acquire(){let release;const current=this.next.then(()=>(this.depth++,()=>{release(),this.depth--}));return this.next=new Promise(resolve=>{release=resolve}),current}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"RuntimeCacheService",function(){return RuntimeCacheService});class RuntimeCacheService{constructor(){this.map=new Map,this.nextID=0}getOrCreateCache(name){return this.map.has(name)||this.map.set(name,new Map),this.map.get(name)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"FakeSlotComposer",function(){return FakeSlotComposer});var _modality_handler_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(88),_slot_composer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(95);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class FakeSlotComposer extends _slot_composer_js__WEBPACK_IMPORTED_MODULE_1__.SlotComposer{constructor(options={}){void 0===options.modalityHandler&&(options.modalityHandler=_modality_handler_js__WEBPACK_IMPORTED_MODULE_0__.ModalityHandler.createHeadlessHandler()),super({rootContainer:{root:"root-context"},...options})}renderSlot(particle,slotName,content){super.renderSlot(particle,slotName,content);const slotConsumer=this.getSlotConsumer(particle,slotName);slotConsumer&&slotConsumer.updateProvidedContexts()}get contexts(){return this._contexts}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ModalityHandler",function(){return ModalityHandler});var _description_dom_formatter_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(89),_headless_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(90),_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(91);
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ModalityHandler{constructor(slotConsumerClass,descriptionFormatter){this.slotConsumerClass=slotConsumerClass,this.descriptionFormatter=descriptionFormatter}static createHeadlessHandler(){return new ModalityHandler(_headless_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.HeadlessSlotDomConsumer)}}ModalityHandler.headlessHandler=new ModalityHandler(_headless_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.HeadlessSlotDomConsumer),ModalityHandler.domHandler=new ModalityHandler(_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_2__.SlotDomConsumer,_description_dom_formatter_js__WEBPACK_IMPORTED_MODULE_0__.DescriptionDomFormatter)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DescriptionDomFormatter",function(){return DescriptionDomFormatter});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(40);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DescriptionDomFormatter extends _description_formatter_js__WEBPACK_IMPORTED_MODULE_1__.DescriptionFormatter{constructor(){super(...arguments),this.nextID=0}_isSelectedDescription(desc){return super._isSelectedDescription(desc)||!!desc.template&&!!desc.model}_combineSelectedDescriptions(selectedDescriptions,options){const suggestionByParticleDesc=new Map;for(const particleDesc of selectedDescriptions){if(this.seenParticles.has(particleDesc._particle))continue;let{template:template,model:model}=this._retrieveTemplateAndModel(particleDesc,suggestionByParticleDesc.size,options||{});Object.keys(model).map(tokenKey=>{return this._initSubTokens(model[tokenKey],particleDesc).map(token=>{const tokenValue=this.tokenToString(token);if(null==tokenValue)return!1;if(tokenValue&&tokenValue.template&&tokenValue.model)template=template.replace(`{{${tokenKey}}}`,tokenValue.template),delete model[tokenKey],model={...model,...tokenValue.model};else{const newTokenKey=`${tokenKey}${++this.nextID}`;template=template.replace(`{{${tokenKey}}}`,`{{${newTokenKey}}}`),delete model[tokenKey],model[newTokenKey]=tokenValue}return!0}).every(t=>!!t)}).every(s=>!!s)&&suggestionByParticleDesc.set(particleDesc,{template:template,model:model})}const suggestions=[];if(selectedDescriptions.forEach(desc=>{suggestionByParticleDesc.has(desc)&&suggestions.push(suggestionByParticleDesc.get(desc))}),suggestions.length>0){const result=this._joinDescriptions(suggestions);return options&&options.skipFormatting||(result.template+="."),result}}_retrieveTemplateAndModel(particleDesc,index,options){if(particleDesc._template_&&particleDesc._model_)return{template:particleDesc._template_,model:JSON.parse(particleDesc._model_)};Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(particleDesc.pattern,"Description must contain template and model, or pattern");let template="";const model={};return this._initTokens(particleDesc.pattern,particleDesc).forEach((token,i)=>{if(token.text)template=template.concat(`${0!==index||0!==i||options.skipFormatting?token.text:token.text[0].toUpperCase()+token.text.slice(1)}`);else{const sanitizedFullName=token.fullName.replace(/[.{}_$]/g,"");let attribute="";0!==i||options.skipFormatting||(template=template.concat("<style>\n            [firstletter]::first-letter { text-transform: capitalize; }\n            [firstletter] {display: inline-block}\n            </style>"),attribute=" firstletter"),template=template.concat(`<span${attribute}>{{${sanitizedFullName}}}</span>`),model[sanitizedFullName]=token.fullName}}),{template:template,model:model}}_capitalizeAndPunctuate(sentence){if("string"==typeof sentence)return{template:super._capitalizeAndPunctuate(sentence),model:{}};const tokens=sentence.template.match(/<[a-zA-Z0-9]+>{{([a-zA-Z0-9]*)}}<\/[a-zA-Z0-9]+>/);if(tokens&&tokens.length>1&&sentence.model[tokens[1]]){const modelToken=sentence.model[tokens[1]];modelToken.length>0&&(sentence.model[tokens[1]]=`${modelToken[0].toUpperCase()}${modelToken.substr(1)}`)}return sentence.template+=".",sentence}_joinDescriptions(descs){if(descs.every(desc=>"string"==typeof desc))return super._joinDescriptions(descs);const result={template:"",model:{}},count=descs.length;return descs.forEach((desc,i)=>{let delim;"string"==typeof desc&&(desc={template:desc,model:{}}),result.template+=desc.template,result.model={...result.model,...desc.model},i<count-2?delim=", ":i===count-2&&(delim=["",""," and ",", and "][Math.min(3,count)]),delim&&(result.template+=delim)}),result}_joinTokens(tokens){if(tokens.every(token=>"string"==typeof token))return super._joinTokens(tokens);const nonEmptyTokens=(tokens=tokens.map(token=>"object"!=typeof token?{template:`<span>{{text${++this.nextID}}}</span>`,model:{[`text${this.nextID}`]:token}}:token)).filter(token=>token&&!!token.template&&!!token.model);return{template:nonEmptyTokens.map(token=>token.template).join(""),model:nonEmptyTokens.map(token=>token.model).reduce((prev,curr)=>({...prev,...curr}),{})}}_combineDescriptionAndValue(token,description,storeValue){if(description.template&&description.model)return{template:`${description.template} (${storeValue.template})`,model:{...description.model,...storeValue.model}};const descKey=`${token.handleName}Description${++this.nextID}`;return{template:`<span>{{${descKey}}}</span> (${storeValue.template})`,model:{[descKey]:description,...storeValue.model}}}_formatEntityProperty(handleName,properties,value){const key=`${handleName}${properties.join("")}Value${++this.nextID}`;return{template:`<b>{{${key}}}</b>`,model:{[`${key}`]:value}}}_formatCollection(handleName,values){const handleKey=`${handleName}${++this.nextID}`;return values[0].rawData.name?values.length>2?{template:`<b>{{${handleKey}FirstName}}</b> plus <b>{{${handleKey}OtherCount}}</b> other items`,model:{[`${handleKey}FirstName`]:values[0].rawData.name,[`${handleKey}OtherCount`]:values.length-1}}:{template:values.map((v,i)=>`<b>{{${handleKey}${i}}}</b>`).join(", "),model:Object.assign({},...values.map((v,i)=>({[`${handleKey}${i}`]:v.rawData.name})))}:{template:`<b>{{${handleKey}Length}}</b> items`,model:{[`${handleKey}Length`]:values.length}}}_formatBigCollection(handleName,firstValue){return{template:`collection of items like {{${handleName}FirstName}}`,model:{[`${handleName}FirstName`]:firstValue.rawData.name}}}_formatSingleton(handleName,value){const formattedValue=super._formatSingleton(handleName,value);if(formattedValue)return{template:`<b>{{${handleName}Var}}</b>`,model:{[`${handleName}Var`]:formattedValue}}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"HeadlessSlotDomConsumer",function(){return HeadlessSlotDomConsumer});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(91);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class HeadlessSlotDomConsumer extends _slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.SlotDomConsumer{constructor(arc,consumeConn){super(arc,consumeConn),this._content={},this.contentAvailable=new Promise(resolve=>this._contentAvailableResolve=resolve)}setContent(content,handler){super.setContent(content,handler),content?(this._content.templateName=content.templateName,content.template&&(this._content.template=content.template),this._content.model=content.model,this._contentAvailableResolve()):this._content={}}createNewContainer(container,subId){return container}isSameContainer(container,contextContainer){return container===contextContainer}getInnerContainer(slotId){const model=Array.from(this.renderings,([_,{model:model}])=>model)[0],providedContext=this.findProvidedContext(ctx=>ctx.id===slotId);if(providedContext){if(providedContext.spec.isSet&&model&&model.items&&model.items.models){const innerContainers={};for(const itemModel of model.items.models)Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(itemModel.id),innerContainers[itemModel.id]=itemModel.id;return innerContainers}return slotId}console.warn(`Cannot find provided spec for ${slotId} in ${this.consumeConn.getQualifiedName()}`)}createTemplateElement(template){return template}static findRootContainers(container){return container}static clear(container){}_onUpdate(rendering){}_stampTemplate(template){}_initMutationObserver(){return null}_observe(){}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotDomConsumer",function(){return SlotDomConsumer});var _modalities_dom_components_icons_css_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(92),_modalities_dom_components_xen_xen_template_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5),_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(17),_slot_consumer_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(93),_slot_context_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(94),_runtime_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(38);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const templateByName=()=>_runtime_js__WEBPACK_IMPORTED_MODULE_5__.Runtime.getRuntime().getCacheService().getOrCreateCache("templateByName");let commonStyleTemplate;class SlotDomConsumer extends _slot_consumer_js__WEBPACK_IMPORTED_MODULE_3__.SlotConsumer{constructor(arc,consumeConn,containerKind){super(arc,consumeConn,containerKind),this._observer=this._initMutationObserver()}constructRenderRequest(){const request=["model"],prefixes=[this.templatePrefix];return SlotDomConsumer.hasTemplate(prefixes.join("::"))||request.push("template"),request}static hasTemplate(templatePrefix){return[...templateByName().keys()].find(key=>key.startsWith(templatePrefix))}isSameContainer(container,contextContainer){return container.parentNode===contextContainer}createNewContainer(contextContainer,subId){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(contextContainer,"contextContainer cannot be null");const newContainer=document.createElement(this.containerKind||"div");return this.consumeConn&&newContainer.setAttribute("particle-host",this.consumeConn.getQualifiedName()),contextContainer.appendChild(newContainer),newContainer.attachShadow({mode:"open"}),newContainer.shadowRoot}deleteContainer(container){(container=container.host||container).parentNode&&container.parentNode.removeChild(container)}formatContent(content,subId){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(this.slotContext instanceof _slot_context_js__WEBPACK_IMPORTED_MODULE_4__.ProvidedSlotContext,"Content formatting can only be done for provided SlotContext");const contextSpec=this.slotContext.spec,newContent={};if(Object.keys(content).indexOf("model")>=0)if(content.model){let formattedModel;if(!(formattedModel=contextSpec.isSet&&this.consumeConn.getSlotSpec().isSet?this._modelForSetSlotConsumedAsSetSlot(content.model,subId):contextSpec.isSet&&!this.consumeConn.getSlotSpec().isSet?this._modelForSetSlotConsumedAsSingletonSlot(content.model,subId):this._modelForSingletonSlot(content.model,subId)))return;newContent.model={...formattedModel,...content.descriptions}}else newContent.model=void 0;return content.templateName&&(newContent.templateName="string"==typeof content.templateName?content.templateName:content.templateName[subId],content.template&&(newContent.template="string"==typeof content.template?content.template:content.template[newContent.templateName])),newContent}_modelForSingletonSlot(model,subId){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(!subId,"subId should be absent for a Singleton Slot"),model}_modelForSetSlotConsumedAsSetSlot(model,subId){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(model.items&&model.items.every(item=>item.subId),"model for a Set Slot consumed as a Set Slot needs to have items array, with every element having subId"),model.items.find(item=>item.subId===subId)}_modelForSetSlotConsumedAsSingletonSlot(model,subId){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(model.subId,"model for a Set Slot consumed as a Singleton Slot needs to have subId"),subId===model.subId?model:null}setContainerContent(rendering,content,subId){if(rendering.container){if(!content||0===Object.keys(content).length)return this.clearContainer(rendering),void(rendering.model=null);this._setTemplate(rendering,this.templatePrefix,content.templateName,content.template),rendering.model=content.model,this._onUpdate(rendering)}}clearContainer(rendering){rendering.liveDom&&(rendering.liveDom.root.textContent=""),rendering.liveDom=null}dispose(){this._observer&&this._observer.disconnect(),this.renderings.forEach(([subId,{container:container}])=>this.deleteContainer(container))}static clear(container){container.textContent=""}static clearCache(){templateByName().clear()}static findRootContainers(topContainer){const containerBySlotId={};return Array.from(topContainer.querySelectorAll("[slotid]")).forEach(container=>{const slotId=container.getAttribute("slotid");Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(!containerBySlotId[slotId],`Duplicate root slot ${slotId}`),containerBySlotId[slotId]=container}),containerBySlotId}createTemplateElement(template){return Object.assign(document.createElement("template"),{innerHTML:template})}get templatePrefix(){return this.consumeConn.getQualifiedName()}_setTemplate(rendering,templatePrefix,templateName,template){templateName&&(rendering.templateName=[templatePrefix,templateName].filter(s=>s).join("::"),template&&(templateByName().has(rendering.templateName)&&this.clearContainer(rendering),templateByName().set(rendering.templateName,this.createTemplateElement(template))))}_onUpdate(rendering){if(this._observe(rendering.container),rendering.templateName){const template=templateByName().get(rendering.templateName);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(template,`No template for ${rendering.templateName}`),this._stampTemplate(rendering,template)}this._updateModel(rendering)}_observe(container){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(container,"Cannot observe without a container"),this._observer&&this._observer.observe(container,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["subid"]})}_stampTemplate(rendering,template){if(!rendering.liveDom){commonStyleTemplate||(commonStyleTemplate=_modalities_dom_components_xen_xen_template_js__WEBPACK_IMPORTED_MODULE_1__.Template.createTemplate(`<style>${_modalities_dom_components_icons_css_js__WEBPACK_IMPORTED_MODULE_0__.default}</style>`)),_modalities_dom_components_xen_xen_template_js__WEBPACK_IMPORTED_MODULE_1__.Template.stamp(commonStyleTemplate).appendTo(rendering.container);const mapper=this._eventMapper.bind(this,this.eventHandler);rendering.liveDom=_modalities_dom_components_xen_xen_template_js__WEBPACK_IMPORTED_MODULE_1__.Template.stamp(template).events(mapper).appendTo(rendering.container)}}_eventMapper(eventHandler,node,eventName,handlerName){node.addEventListener(eventName,event=>{event.stopPropagation(),"xen:forward"===eventName&&(node=event.detail.target,handlerName=event.detail.handlerName);const{altKey:altKey,ctrlKey:ctrlKey,metaKey:metaKey,shiftKey:shiftKey,code:code,key:key,repeat:repeat}=event,detail={key:node.key,value:node.value,keys:{altKey:altKey,ctrlKey:ctrlKey,metaKey:metaKey,shiftKey:shiftKey,code:code,key:key,repeat:repeat}};eventHandler({detail:detail,handler:handlerName,data:detail})})}_updateModel(rendering){rendering.liveDom&&rendering.liveDom.set(rendering.model)}initInnerContainers(container){Array.from(container.querySelectorAll("[slotid]")).forEach(innerContainer=>{if(!this.isDirectInnerSlot(container,innerContainer))return;const slotId=this.getNodeValue(innerContainer,"slotid"),providedContext=this.findProvidedContext(ctx=>ctx.id===slotId);if(!providedContext)return void console.warn(`Slot ${this.consumeConn.getSlotSpec().name} has unexpected inner slot ${slotId}`);const subId=this.getNodeValue(innerContainer,"subid");Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_2__.assert)(Boolean(subId)===providedContext.spec.isSet,`Sub-id ${subId} for slot ${providedContext.name} doesn't match set spec: ${providedContext.spec.isSet}`),providedContext.sourceSlotConsumer._initInnerSlotContainer(slotId,subId,innerContainer)})}getNodeValue(node,name){return node[name]||node.getAttribute(name)}isDirectInnerSlot(container,innerContainer){if(innerContainer===container)return!0;const parentOf=elt=>elt.parentNode;let parentNode=parentOf(innerContainer);for(;parentNode;){if(parentNode===container)return!0;if(parentNode.getAttribute&&parentNode.getAttribute("slotid"))return!1;parentNode=parentOf(parentNode)}return!1}_initMutationObserver(){return this.consumeConn?new MutationObserver(async records=>{this._observer.disconnect();const updateContainersBySubId=new Map;for(const[subId,{container:container}]of this.renderings)records.some(r=>this.isDirectInnerSlot(container,r.target))&&updateContainersBySubId.set(subId,container);const containers=[...updateContainersBySubId.values()];containers.length>0&&(this._clearInnerSlotContainers([...updateContainersBySubId.keys()]),containers.forEach(container=>this.initInnerContainers(container)),this.updateProvidedContexts(),containers.forEach(container=>this._observe(container)))}):null}formatHostedContent(content){if(content.templateName){if("string"!=typeof content.templateName)throw new Error("TODO: Implement this!");content.templateName=`${this.consumeConn.getQualifiedName()}::${content.templateName}`}return content}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_exports__.default='\n  icon {\n    font-family: "Material Icons";\n    font-size: 24px;\n    font-style: normal;\n    -webkit-font-feature-settings: "liga";\n    -webkit-font-smoothing: antialiased;\n    cursor: pointer;\n    user-select: none;\n    flex-shrink: 0;\n    /* partial FOUC prevention */\n    display: inline-block;\n    width: 24px;\n    height: 24px;\n    overflow: hidden;\n  }\n  icon[hidden] {\n    /* required because of display rule above,\n    display rule required for overflow: hidden */\n    display: none;\n  }\n'},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotConsumer",function(){return SlotConsumer});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_slot_context_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(94);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class SlotConsumer{constructor(arc,consumeConn,containerKind){this.directlyProvidedSlotContexts=[],this.hostedSlotContexts=[],this._renderingBySubId=new Map,this.innerContainerBySlotId={},this.arc=arc,this.consumeConn=consumeConn,this.containerKind=containerKind}getRendering(subId){return this._renderingBySubId.get(subId)}get renderings(){return[...this._renderingBySubId.entries()]}addRenderingBySubId(subId,rendering){this._renderingBySubId.set(subId,rendering)}addHostedSlotContexts(context){context.containerAvailable=Boolean(this.slotContext.containerAvailable),this.hostedSlotContexts.push(context)}get allProvidedSlotContexts(){return[...this.generateProvidedContexts()]}findProvidedContext(predicate){return this.generateProvidedContexts(predicate).next().value}*generateProvidedContexts(predicate=(_=>!0)){for(const context of this.directlyProvidedSlotContexts)predicate(context)&&(yield context);for(const hostedContext of this.hostedSlotContexts)for(const hostedConsumer of hostedContext.slotConsumers)yield*hostedConsumer.generateProvidedContexts(predicate)}onContainerUpdate(newContainer,originalContainer){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.slotContext instanceof _slot_context_js__WEBPACK_IMPORTED_MODULE_1__.ProvidedSlotContext,"Container can only be updated in non-hosted context");const context=this.slotContext;if(Boolean(newContainer)!==Boolean(originalContainer)&&(newContainer?this.startRender():this.stopRender()),this.hostedSlotContexts.forEach(ctx=>ctx.containerAvailable=Boolean(newContainer)),newContainer!==originalContainer){const contextContainerBySubId=new Map;context&&context.spec.isSet?Object.keys(context.container||{}).forEach(subId=>contextContainerBySubId.set(subId,context.container[subId])):contextContainerBySubId.set(void 0,context.container);for(const[subId,container]of contextContainerBySubId){this._renderingBySubId.has(subId)||this._renderingBySubId.set(subId,{});const rendering=this.getRendering(subId);rendering.container&&this.isSameContainer(rendering.container,container)||(rendering.container&&this.clearContainer(rendering),rendering.container=this.createNewContainer(container,subId))}for(const[subId,rendering]of this.renderings)contextContainerBySubId.has(subId)||(this.deleteContainer(rendering.container),this._renderingBySubId.delete(subId))}}createProvidedContexts(){return this.consumeConn.getSlotSpec().provideSlotConnections.map(spec=>new _slot_context_js__WEBPACK_IMPORTED_MODULE_1__.ProvidedSlotContext(this.consumeConn.providedSlots[spec.name].id,spec.name,[],null,spec,this))}updateProvidedContexts(){this.allProvidedSlotContexts.forEach(providedContext=>{providedContext.container=providedContext.sourceSlotConsumer.getInnerContainer(providedContext.id)})}startRender(){if(this.consumeConn&&this.startRenderCallback){const providedSlots=new Map(this.allProvidedSlotContexts.map(context=>[context.name,context.id]));this.startRenderCallback({particle:this.consumeConn.particle,slotName:this.consumeConn.name,providedSlots:providedSlots,contentTypes:this.constructRenderRequest()})}}stopRender(){this.consumeConn&&this.stopRenderCallback&&this.stopRenderCallback({particle:this.consumeConn.particle,slotName:this.consumeConn.name})}setContent(content,handler){content&&Object.keys(content).length>0&&this.description&&(content.descriptions=this._populateHandleDescriptions()),this.eventHandler=handler;for(const[subId,rendering]of this.renderings)this.setContainerContent(rendering,this.formatContent(content,subId),subId)}_populateHandleDescriptions(){if(!this.consumeConn)return null;const descriptions=new Map;return Object.values(this.consumeConn.particle.connections).map(handleConn=>{handleConn.handle&&(descriptions[`${handleConn.name}.description`]=this.description.getHandleDescription(handleConn.handle).toString())}),descriptions}getInnerContainer(slotId){return this.innerContainerBySlotId[slotId]}_initInnerSlotContainer(slotId,subId,container){subId?(this.innerContainerBySlotId[slotId]||(this.innerContainerBySlotId[slotId]={}),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.innerContainerBySlotId[slotId][subId],`Multiple ${slotId}:${subId} inner slots cannot be provided`),this.innerContainerBySlotId[slotId][subId]=container):this.innerContainerBySlotId[slotId]=container}_clearInnerSlotContainers(subIds){subIds.forEach(subId=>{subId?Object.values(this.innerContainerBySlotId).forEach(inner=>delete inner[subId]):this.innerContainerBySlotId={}})}isSameContainer(container,contextContainer){return!container&&!contextContainer||container===contextContainer}constructRenderRequest(){return[]}dispose(){}createNewContainer(contextContainer,subId){return null}deleteContainer(container){}clearContainer(rendering){}setContainerContent(rendering,content,subId){}formatContent(content,subId){return null}formatHostedContent(content){return null}static clear(container){}static findRootContainers(topContainer){return{}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotContext",function(){return SlotContext}),__webpack_require__.d(__webpack_exports__,"HostedSlotContext",function(){return HostedSlotContext}),__webpack_require__.d(__webpack_exports__,"ProvidedSlotContext",function(){return ProvidedSlotContext});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_particle_spec_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class SlotContext{constructor(id,sourceSlotConsumer=null){this.slotConsumers=[],this.id=id,this.sourceSlotConsumer=sourceSlotConsumer}addSlotConsumer(slotConsumer){this.slotConsumers.push(slotConsumer),slotConsumer.slotContext=this}clearSlotConsumers(){this.slotConsumers.forEach(slotConsumer=>slotConsumer.slotContext=null),this.slotConsumers.length=0}}class HostedSlotContext extends SlotContext{constructor(id,transformationSlotConsumer,storeId){super(id,transformationSlotConsumer),this._containerAvailable=!1,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(transformationSlotConsumer),this.storeId=storeId,transformationSlotConsumer.addHostedSlotContexts(this)}onRenderSlot(consumer,content,handler){this.sourceSlotConsumer.arc.pec.innerArcRender(this.sourceSlotConsumer.consumeConn.particle,this.sourceSlotConsumer.consumeConn.name,this.id,consumer.formatHostedContent(content))}addSlotConsumer(consumer){super.addSlotConsumer(consumer),this.containerAvailable&&consumer.startRender()}get containerAvailable(){return this._containerAvailable}set containerAvailable(containerAvailable){if(this._containerAvailable!==containerAvailable){this._containerAvailable=containerAvailable;for(const consumer of this.slotConsumers)containerAvailable?consumer.startRender():consumer.stopRender()}}}class ProvidedSlotContext extends SlotContext{constructor(id,name,tags,container,spec,sourceSlotConsumer=null){super(id,sourceSlotConsumer),this.tags=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Boolean(container)!==Boolean(spec),"Exactly one of either container or slotSpec may be set"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(Boolean(spec)==Boolean(spec),"Spec and source slot can only be set together"),this.name=name,this.tags=tags||[],this._container=container,this.spec=spec||new _particle_spec_js__WEBPACK_IMPORTED_MODULE_1__.ProvideSlotConnectionSpec({name:name}),this.sourceSlotConsumer&&this.sourceSlotConsumer.directlyProvidedSlotContexts.push(this),this.handles=this.spec&&this.sourceSlotConsumer?this.spec.handles.map(handle=>this.sourceSlotConsumer.consumeConn.particle.connections[handle].handle).filter(a=>void 0!==a):[]}onRenderSlot(consumer,content,handler){consumer.setContent(content,handler)}get container(){return this._container}get containerAvailable(){return Boolean(this._container)}static createContextForContainer(id,name,container,tags){return new ProvidedSlotContext(id,name,tags,container,null)}isSameContainer(container){return this.spec.isSet?Boolean(this.container)===Boolean(container)&&(!this.container||Object.keys(this.container).length===Object.keys(container).length&&Object.keys(this.container).every(key=>Object.keys(container).some(newKey=>newKey===key))&&Object.values(this.container).every(currentContainer=>Object.values(container).some(newContainer=>newContainer===currentContainer))):!container&&!this.container||this.container===container}set container(container){if(this.isSameContainer(container))return;const originalContainer=this.container;this._container=container,this.slotConsumers.forEach(slotConsumer=>slotConsumer.onContainerUpdate(this.container,originalContainer))}addSlotConsumer(slotConsumer){super.addSlotConsumer(slotConsumer),this.container&&slotConsumer.onContainerUpdate(this.container,null)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SlotComposer",function(){return SlotComposer});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_description_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(39),_modality_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(28),_slot_context_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(94);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class SlotComposer{constructor(options){if(this._consumers=[],this._contexts=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(options.modalityHandler,`Missing or invalid modality handler: ${options.modalityHandler}`),options.rootContainer=options.rootContainer||options.rootContext||(options.containers||Object).root,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==options.rootContainer!=(!0===options.noRoot),"Root container is mandatory unless it is explicitly skipped"),this._containerKind=options.containerKind,options.modalityName&&(this.modality=_modality_js__WEBPACK_IMPORTED_MODULE_2__.Modality.create([options.modalityName])),this.modalityHandler=options.modalityHandler,options.noRoot)return;const containerByName=options.containers||this.modalityHandler.slotConsumerClass.findRootContainers(options.rootContainer)||{};0===Object.keys(containerByName).length&&(containerByName.root=options.rootContainer),Object.keys(containerByName).forEach(slotName=>{this._contexts.push(_slot_context_js__WEBPACK_IMPORTED_MODULE_3__.ProvidedSlotContext.createContextForContainer(`rootslotid-${slotName}`,slotName,containerByName[slotName],[`${slotName}`]))})}get consumers(){return this._consumers}get containerKind(){return this._containerKind}getSlotConsumer(particle,slotName){return this.consumers.find(s=>s.consumeConn.particle===particle&&s.consumeConn.name===slotName)}findContainerByName(name){const contexts=this.findContextsByName(name);if(0===contexts.length)console.warn(`No containers for '${name}'`);else if(1===contexts.length)return contexts[0].container;console.warn(`Ambiguous containers for '${name}'`)}findContextsByName(name){return this._contexts.filter(ctx=>ctx instanceof _slot_context_js__WEBPACK_IMPORTED_MODULE_3__.ProvidedSlotContext).filter(ctx=>ctx.name===name)}findContextById(slotId){return this._contexts.find(({id:id})=>id===slotId)}createHostedSlot(innerArc,transformationParticle,transformationSlotName,storeId){const transformationSlotConsumer=this.getSlotConsumer(transformationParticle,transformationSlotName);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(transformationSlotConsumer,`Transformation particle ${transformationParticle.name} with consumed ${transformationSlotName} not found`);const hostedSlotId=innerArc.generateID().toString();return this._contexts.push(new _slot_context_js__WEBPACK_IMPORTED_MODULE_3__.HostedSlotContext(hostedSlotId,transformationSlotConsumer,storeId)),hostedSlotId}_addSlotConsumer(slot){slot.startRenderCallback=slot.arc.pec.startRender.bind(slot.arc.pec),slot.stopRenderCallback=slot.arc.pec.stopRender.bind(slot.arc.pec),this._consumers.push(slot)}async initializeRecipe(arc,recipeParticles){const newConsumers=[];recipeParticles.forEach(p=>{Object.values(p.consumedSlotConnections).forEach(cs=>{if(!cs.targetSlot)return void Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!cs.getSlotSpec().isRequired,`No target slot for particle's ${p.name} required consumed slot: ${cs.name}.`);const slotConsumer=new this.modalityHandler.slotConsumerClass(arc,cs,this._containerKind),providedContexts=slotConsumer.createProvidedContexts();this._contexts=this._contexts.concat(providedContexts),newConsumers.push(slotConsumer)})}),newConsumers.forEach(consumer=>{this._addSlotConsumer(consumer);const context=this.findContextById(consumer.consumeConn.targetSlot.id);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(context,`No context found for ${consumer.consumeConn.getQualifiedName()}`),context.addSlotConsumer(consumer)});const allArcs=this.consumers.map(consumer=>consumer.arc),uniqueArcs=[...new Set(allArcs).values()],descriptions=await Promise.all(uniqueArcs.map(arc=>_description_js__WEBPACK_IMPORTED_MODULE_1__.Description.create(arc))),consumerByArc=new Map(descriptions.map((description,index)=>[uniqueArcs[index],description]));for(const consumer of this.consumers)consumer.description=consumerByArc.get(consumer.arc)}renderSlot(particle,slotName,content){const slotConsumer=this.getSlotConsumer(particle,slotName);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(slotConsumer,`Cannot find slot (or hosted slot) ${slotName} for particle ${particle.name}`),slotConsumer.slotContext.onRenderSlot(slotConsumer,content,async eventlet=>{if(slotConsumer.arc.pec.sendEvent(particle,slotName,eventlet),eventlet.data&&eventlet.data.key)for(const ctx of slotConsumer.hostedSlotContexts)if(ctx.storeId)for(const hostedConsumer of ctx.slotConsumers){const store=hostedConsumer.arc.findStoreById(ctx.storeId);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store),store.get().then(value=>{value&&value.id===eventlet.data.key&&hostedConsumer.arc.pec.sendEvent(hostedConsumer.consumeConn.particle,hostedConsumer.consumeConn.name,eventlet)})}})}getAvailableContexts(){return this._contexts}dispose(){this.consumers.forEach(consumer=>consumer.dispose()),this._contexts.forEach(context=>{context.clearSlotConsumers(),context instanceof _slot_context_js__WEBPACK_IMPORTED_MODULE_3__.ProvidedSlotContext&&context.container&&this.modalityHandler.slotConsumerClass.clear(context.container)}),this._contexts=this._contexts.filter(c=>!c.sourceSlotConsumer),this._consumers.length=0}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"VolatileStorageKey",function(){return VolatileStorageKey}),__webpack_require__.d(__webpack_exports__,"VolatileMemory",function(){return VolatileMemory}),__webpack_require__.d(__webpack_exports__,"VolatileDriver",function(){return VolatileDriver}),__webpack_require__.d(__webpack_exports__,"VolatileStorageDriverProvider",function(){return VolatileStorageDriverProvider});var _driver_factory_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(97),_storage_key_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(98),_runtime_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(38);
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class VolatileStorageKey extends _storage_key_js__WEBPACK_IMPORTED_MODULE_1__.StorageKey{constructor(unique){super("volatile"),this.unique=unique}}class VolatileMemory{constructor(){this.entries=new Map}}class VolatileDriver extends _driver_factory_js__WEBPACK_IMPORTED_MODULE_0__.Driver{constructor(storageKey,exists){switch(super(storageKey,exists),this.pendingVersion=0,this.pendingModel=null,this.memory=_runtime_js__WEBPACK_IMPORTED_MODULE_2__.Runtime.getRuntime().getVolatileMemory(),exists){case _driver_factory_js__WEBPACK_IMPORTED_MODULE_0__.Exists.ShouldCreate:if(this.memory.entries.has(storageKey))throw new Error(`requested creation of memory location ${storageKey} can't proceed as location already exists`);this.data={data:null,version:0,drivers:[]},this.memory.entries.set(storageKey,this.data);break;case _driver_factory_js__WEBPACK_IMPORTED_MODULE_0__.Exists.ShouldExist:if(!this.memory.entries.has(storageKey))throw new Error(`requested connection to memory location ${storageKey} can't proceed as location doesn't exist`);case _driver_factory_js__WEBPACK_IMPORTED_MODULE_0__.Exists.MayExist:{const data=this.memory.entries.get(storageKey);data?(this.data=data,this.pendingModel=data.data,this.pendingVersion=data.version):(this.data={data:null,version:0,drivers:[]},this.memory.entries.set(storageKey,this.data));break}default:throw new Error(`unknown Exists code ${exists}`)}this.data.drivers.push(this)}registerReceiver(receiver){this.receiver=receiver,this.pendingModel&&(receiver(this.pendingModel,this.pendingVersion),this.pendingModel=null)}async send(model,version){return this.data.version===version-1&&(this.data.data=model,this.data.version+=1,this.data.drivers.forEach(driver=>{driver!==this&&driver.receiver(model,this.data.version)}),!0)}async write(key,value){throw new Error("Method not implemented.")}async read(key){throw new Error("Method not implemented.")}}class VolatileStorageDriverProvider{willSupport(storageKey){return"volatile"===storageKey.protocol}driver(storageKey,exists){if(!this.willSupport(storageKey))throw new Error(`This provider does not support storageKey ${storageKey.toString()}`);return new VolatileDriver(storageKey,exists)}static register(){_driver_factory_js__WEBPACK_IMPORTED_MODULE_0__.DriverFactory.register(new VolatileStorageDriverProvider)}}VolatileStorageDriverProvider.register()},function(module,__webpack_exports__,__webpack_require__){"use strict";
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
var Exists;__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Exists",function(){return Exists}),__webpack_require__.d(__webpack_exports__,"Driver",function(){return Driver}),__webpack_require__.d(__webpack_exports__,"DriverFactory",function(){return DriverFactory}),function(Exists){Exists[Exists.ShouldExist=0]="ShouldExist",Exists[Exists.ShouldCreate=1]="ShouldCreate",Exists[Exists.MayExist=2]="MayExist"}(Exists||(Exists={}));class Driver{constructor(storageKey,exists){this.storageKey=storageKey,this.exists=exists}}class DriverFactory{static clearRegistrationsForTesting(){this.providers=[]}static driverInstance(storageKey,exists){for(const provider of this.providers)if(provider.willSupport(storageKey))return provider.driver(storageKey,exists);return null}static register(storageDriverProvider){this.providers.push(storageDriverProvider)}static willSupport(storageKey){for(const provider of this.providers)if(provider.willSupport(storageKey))return!0;return!1}}DriverFactory.providers=[]},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StorageKey",function(){return StorageKey});class StorageKey{constructor(protocol){this.protocol=protocol}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SyntheticStorage",function(){return SyntheticStorage});var Scope,Category,_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_manifest_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(41),_synthetic_types_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(32),_type_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(18),_util_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(100),_key_base_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(35),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(36);!function(Scope){Scope[Scope.arc=1]="arc"}(Scope||(Scope={})),function(Category){Category[Category.handles=1]="handles"}(Category||(Category={}));class SyntheticKey extends _key_base_js__WEBPACK_IMPORTED_MODULE_5__.KeyBase{constructor(key,storageFactory){super();const match=key.match(/^synthetic:\/\/([^\/]+)\/([^\/]+)\/(.+)$/);if(null===match||4!==match.length)throw new Error(`invalid synthetic key: ${key}`);if(this.scope=Scope[match[1]],this.category=Category[match[2]],this.scope!==Scope.arc)throw new Error(`invalid scope '${match[1]}' for synthetic key: ${key}`);{this.targetType=new _type_js__WEBPACK_IMPORTED_MODULE_3__.ArcType;const key=storageFactory.parseStringAsKey(match[3]).childKeyForArcInfo();this.targetKey=key.toString()}if(this.category!==Category.handles)throw new Error(`invalid category '${match[2]}' for synthetic key: ${key}`);this.syntheticType=new _type_js__WEBPACK_IMPORTED_MODULE_3__.HandleType}get protocol(){return"synthetic"}base(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"base not supported for synthetic keys"),null}get arcId(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"arcId not supported for synthetic keys"),null}childKeyForHandle(id){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"childKeyForHandle not supported for synthetic keys"),null}childKeyForArcInfo(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"childKeyForArcInfo not supported for synthetic keys"),null}childKeyForSuggestions(userId,arcId){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"childKeyForSuggestions not supported for synthetic keys"),null}childKeyForSearch(userId){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"childKeyForSearch not supported for synthetic keys"),null}toString(){return`${this.protocol}://${Scope[this.scope]}/${Category[this.category]}/${this.targetKey}`}}class SyntheticStorage extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_6__.StorageBase{constructor(arcId,storageFactory){super(arcId),this.storageFactory=storageFactory}async construct(id,type,keyFragment){throw new Error("cannot construct SyntheticStorage providers; use connect")}async connect(id,type,key){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null===type,"SyntheticStorage does not accept a type parameter");const synthKey=new SyntheticKey(key,this.storageFactory),targetStore=await this.storageFactory.connect(id,synthKey.targetType,synthKey.targetKey);return null===targetStore?null:new SyntheticCollection(synthKey.syntheticType,id,key,targetStore,this.storageFactory)}async baseStorageFor(type,key){throw new Error("baseStorageFor not implemented for SyntheticStorage")}baseStorageKey(type,key){throw new Error("baseStorageKey not implemented for SyntheticStorage")}parseStringAsKey(s){return new SyntheticKey(s,this.storageFactory)}}class SyntheticCollection extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_6__.StorageProviderBase{constructor(type,id,key,targetStore,storageFactory){let resolveInitialized;super(type,void 0,id,key),this.model=[],this.backingStore=void 0,this.targetStore=targetStore,this.storageFactory=storageFactory,this.initialized=new Promise(resolve=>resolveInitialized=resolve);const process=async data=>{await this.process(data,!1),resolveInitialized(),targetStore.on("change",details=>this.process(details.data,!0),this)};targetStore.get().then(data=>process(data))}async process(data,fireEvent){let handles;try{if(data){const manifest=await _manifest_js__WEBPACK_IMPORTED_MODULE_1__.Manifest.parse(_synthetic_types_js__WEBPACK_IMPORTED_MODULE_2__.ArcInfo.extractSerialization(data),{});handles=manifest.activeRecipe&&manifest.activeRecipe.handles}}catch(e){console.warn(`Error parsing manifest at ${this.storageKey}:\n${e.message}`)}const oldModel=this.model;this.model=[];for(const handle of handles||[])this.storageFactory.isPersistent(handle.storageKey)&&this.model.push(new _synthetic_types_js__WEBPACK_IMPORTED_MODULE_2__.ArcHandle(handle.id,handle.storageKey,handle.mappedType,handle.tags));if(fireEvent){const diff=Object(_util_js__WEBPACK_IMPORTED_MODULE_4__.setDiffCustom)(oldModel,this.model,JSON.stringify),add=diff.add.map(arcHandle=>({value:arcHandle})),remove=diff.remove.map(arcHandle=>({value:arcHandle}));this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_6__.ChangeEvent({add:add,remove:remove}))}}async toList(){return await this.initialized,this.model}async toLiteral(){throw new Error("unimplemented")}async cloneFrom(){throw new Error("cloneFrom should never be called on SyntheticCollection!")}async ensureBackingStore(){throw new Error("ensureBackingStore should never be called on SyntheticCollection!")}async getMultiple(ids){throw new Error("unimplemented")}async storeMultiple(values,keys,originatorId){throw new Error("unimplemented")}async removeMultiple(items,originatorId){throw new Error("unimplemented")}async get(id){throw new Error("unimplemented")}remove(id,keys,originatorId){throw new Error("unimplemented")}store(value,keys,originatorId){throw new Error("unimplemented")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"setDiff",function(){return setDiff}),__webpack_require__.d(__webpack_exports__,"setDiffCustom",function(){return setDiffCustom});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);
// @license
function setDiff(from,to){const result={add:[],remove:[]},items=new Set([...from,...to]),fromSet=new Set(from),toSet=new Set(to);for(const item of items)if(fromSet.has(item)){if(toSet.has(item))continue;result.remove.push(item)}else Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(toSet.has(item)),result.add.push(item);return result}function setDiffCustom(from,to,keyFn){const result={add:[],remove:[]},items=new Map,fromSet=new Map,toSet=new Map;for(const item of from){const key=keyFn(item);items.set(key,item),fromSet.set(key,item)}for(const item of to){const key=keyFn(item);items.set(key,item),toSet.set(key,item)}for(const[key,item]of items)if(fromSet.has(key)){if(toSet.has(key))continue;result.remove.push(item)}else Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(toSet.has(key)),result.add.push(item);return result}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbStorage",function(){return PouchDbStorage});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(102),_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(36),_pouch_db_big_collection_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(103),_pouch_db_collection_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(106),_pouch_db_key_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(105),_pouch_db_variable_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(108);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB.plugin(_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDbDebug),_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB.debug.disable();class PouchDbStorage extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.StorageBase{constructor(arcId){super(arcId),this.providerByLocationCache=new Map,this.baseStores=new Map,this.baseStorePromises=new Map}set debug(d){super.debug=d,d?_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB.debug.enable("*"):_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB.debug.disable()}isTypeReferenceMode(type){if(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.EntityType){const schema=type.getEntitySchema();if("Suggestions"===schema.name||"Search"===schema.name)return!1}return!(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.ArcType)&&(!(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.ReferenceType)&&!(type.isTypeContainer()&&type.getContainedType()instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.ReferenceType))}async construct(id,type,keyFragment){const refMode=this.isTypeReferenceMode(type),provider=await this._construct(id,type,keyFragment,refMode);return provider.referenceMode&&await provider.ensureBackingStore(),provider}async _construct(id,type,keyFragment,refMode){const key=new _pouch_db_key_js__WEBPACK_IMPORTED_MODULE_6__.PouchDbKey(keyFragment),provider=this.newProvider(type,void 0,id,key.toString(),refMode);return this.providerByLocationCache.set(key.location,provider),provider}async connect(id,type,key){const pouchKey=new _pouch_db_key_js__WEBPACK_IMPORTED_MODULE_6__.PouchDbKey(key),provider=this.providerByLocationCache.get(pouchKey.location);if(provider)return provider;try{return await this.dbForKey(pouchKey).get(pouchKey.location),this.construct(id,type,key)}catch(err){if(err.name&&"not_found"===err.name)return null;throw err}}async shutdown(){PouchDbStorage.syncHandler&&PouchDbStorage.syncHandler.cancel();for(const db of PouchDbStorage.dbLocationToInstance.values())try{await db.close(),await db.destroy()}catch(err){}PouchDbStorage.dbLocationToInstance.clear()}baseStorageKey(type,keyString){const key=new _pouch_db_key_js__WEBPACK_IMPORTED_MODULE_6__.PouchDbKey(keyString);return key.location=`backingStores/${type.toString()}`,key.toString()}async baseStorageFor(type,key){if(this.baseStores.has(type))return this.baseStores.get(type);if(this.baseStorePromises.has(type))return this.baseStorePromises.get(type);const storagePromise=this._construct(type.toString(),type.collectionOf(),key,!1);this.baseStorePromises.set(type,storagePromise);const storage=await storagePromise;return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(storage,"baseStorageFor should not fail"),this.baseStores.set(type,storage),storage}parseStringAsKey(s){return new _pouch_db_key_js__WEBPACK_IMPORTED_MODULE_6__.PouchDbKey(s)}newProvider(type,name,id,key,refMode){return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.CollectionType?new _pouch_db_collection_js__WEBPACK_IMPORTED_MODULE_5__.PouchDbCollection(type,this,name,id,key,refMode):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_2__.BigCollectionType?new _pouch_db_big_collection_js__WEBPACK_IMPORTED_MODULE_4__.PouchDbBigCollection(type,this,name,id,key,refMode):new _pouch_db_variable_js__WEBPACK_IMPORTED_MODULE_7__.PouchDbVariable(type,this,name,id,key,refMode)}static async resetPouchDbStorageForTesting(){for(const db of PouchDbStorage.dbLocationToInstance.values())await db.allDocs({include_docs:!0}).then(allDocs=>allDocs.rows.map(row=>({_id:row.id,_rev:row.doc._rev,_deleted:!0}))).then(async deleteDocs=>db.bulkDocs(deleteDocs))}static async dumpDB(){for(const db of PouchDbStorage.dbLocationToInstance.values())await db.allDocs({include_docs:!0}).then(allDocs=>{console.log(allDocs)})}dbForKey(key){let db=PouchDbStorage.dbLocationToInstance.get(key.dbCacheKey());if(db)return db;if("local"===key.dbLocation)db=new _platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB(key.dbName);else if("memory"===key.dbLocation)_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB.plugin(_platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDbMemory),db=new _platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB(key.dbName,{adapter:"memory"});else{db=new _platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB(key.dbName);const dbUrl=`${key.dbLocation.startsWith("localhost")?"http://":"https://"}${key.dbLocation}/${key.dbName}`;console.log("Connecting to "+dbUrl);const remoteDb=new _platform_pouchdb_web_js__WEBPACK_IMPORTED_MODULE_1__.PouchDB(dbUrl);if(!remoteDb||!db)throw new Error("unable to connect to remote database "+dbUrl+" for "+key.toString());remoteDb.info().then(info=>{console.log("Connected to Remote Database",info)}).catch(err=>{console.warn("Error connecting to Remote Database",err)}),this.setupSync(db,remoteDb)}if(!db)throw new Error("unable to connect to database for "+key.toString());return PouchDbStorage.dbLocationToInstance.set(key.dbCacheKey(),db),db}setupSync(localDb,remoteDb){console.log("Replicating DBs");const syncHandler=localDb.sync(remoteDb,{live:!0,retry:!0});syncHandler.on("change",info=>{if("pull"===info.direction)for(const doc of info.change.docs){const handler=this.providerByLocationCache.get(doc._id);handler&&handler.onRemoteStateSynced(doc)}}),syncHandler.on("paused",err=>{console.log("DB Replication paused",err)}).on("active",()=>{console.log("DB Replication active")}).on("denied",err=>{console.log("DB Replication denied",err)}).on("complete",info=>{console.log("DB Replication complete",info)}).on("error",err=>{console.log("DB Replication error",err)}),PouchDbStorage.syncHandler=syncHandler}}PouchDbStorage.dbLocationToInstance=new Map},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDB",function(){return PouchDB}),__webpack_require__.d(__webpack_exports__,"PouchDbMemory",function(){return PouchDbMemory}),__webpack_require__.d(__webpack_exports__,"PouchDbDebug",function(){return PouchDbDebug});const{PouchDB:PouchDB,PouchDbMemory:PouchDbMemory,PouchDbDebug:PouchDbDebug}=window.PouchDB},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbBigCollection",function(){return PouchDbBigCollection});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(104);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class PouchDbBigCollection extends _pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_1__.PouchDbStorageProvider{constructor(type,storageEngine,name,id,key,refMode){super(type,storageEngine,name,id,key,refMode)}backingType(){return this.type.getContainedType()}async get(id){throw new Error("NotImplemented")}async store(value,keys,originatorId){throw Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required"),new Error("NotImplemented")}async remove(id,keys,originatorId){throw new Error("NotImplemented")}async stream(pageSize,forward=!0){throw new Error("NotImplemented")}async cursorNext(cursorId){throw new Error("NotImplemented")}async cursorClose(cursorId){throw new Error("NotImplemented")}cursorVersion(cursorId){throw new Error("NotImplemented")}async toLiteral(){throw new Error("NotImplemented")}async cloneFrom(){throw new Error("NotImplemented")}clearItemsForTesting(){throw new Error("NotImplemented")}onRemoteStateSynced(doc){throw new Error("NotImplemented")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbStorageProvider",function(){return PouchDbStorageProvider});var _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(36),_pouch_db_key_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(105);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class PouchDbStorageProvider extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_0__.StorageProviderBase{constructor(type,storageEngine,name,id,key,refMode){super(type,name,id,key),this.backingStore=null,this.storageEngine=storageEngine,this.pouchDbKey=new _pouch_db_key_js__WEBPACK_IMPORTED_MODULE_1__.PouchDbKey(key),this.referenceMode=refMode,this.initialized=new Promise(resolve=>this.resolveInitialized=resolve)}async ensureBackingStore(){if(this.backingStore)return this.backingStore;if(!this.pendingBackingStore){const key=this.storageEngine.baseStorageKey(this.backingType(),this.storageKey);this.pendingBackingStore=this.storageEngine.baseStorageFor(this.type,key),this.pendingBackingStore.then(backingStore=>this.backingStore=backingStore)}return this.pendingBackingStore}get db(){return this.storageEngine.dbForKey(this.pouchDbKey)}bumpVersion(otherVersion=0){this.version=Math.max(this.version,otherVersion)+1}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbKey",function(){return PouchDbKey});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_key_base_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(35);
// @license
class PouchDbKey extends _key_base_js__WEBPACK_IMPORTED_MODULE_1__.KeyBase{constructor(key){if(super(),!key.startsWith("pouchdb://"))throw new Error(`can't construct pouchdb key for input key ${key}`);const parts=key.replace(/^pouchdb:\/\//,"").split("/");if(this.protocol="pouchdb",this.dbLocation=parts[0]||"memory",this.dbName=parts[1]||"user",this.location=parts.slice(2).join("/")||"",this.toString()!==key)throw new Error("PouchDb keys must match "+this.toString()+" vs "+key)}base(){const str=this.toString();return str.substring(0,str.length-this.arcId.length)}get arcId(){return this.location.substring(this.location.lastIndexOf("/")+1)}childKeyForHandle(id){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(id&&id.length>0,"invalid id"),this.buildChildKey(`handles/${id}`)}childKeyForArcInfo(){return this.buildChildKey("arc-info")}childKeyForSuggestions(userId,arcId){return this.buildChildKey(`${userId}/suggestions/${arcId}`)}childKeyForSearch(userId){return this.buildChildKey(`${userId}/search`)}buildChildKey(leaf){let location="";null!=this.location&&this.location.length>0&&(location=this.location+"/"),location+=leaf;const newKey=new PouchDbKey(this.toString());return newKey.location=location,newKey}toString(){return"pouchdb://"+[this.dbLocation,this.dbName,this.location].join("/")}dbCacheKey(){return[this.dbLocation,this.dbName].join("/")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbCollection",function(){return PouchDbCollection});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_mutex_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(85),_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(34),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(36),_pouch_db_upsert_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(107),_pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(104);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class PouchDbCollection extends _pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_5__.PouchDbStorageProvider{constructor(type,storageEngine,name,id,key,refMode){super(type,storageEngine,name,id,key,refMode),this.upsertMutex=new _mutex_js__WEBPACK_IMPORTED_MODULE_1__.Mutex,this.getModel().then(()=>{this.resolveInitialized()}).catch(err=>{console.warn("error init",err)}),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==this.version)}backingType(){return this.type.getContainedType()}async cloneFrom(handle){await this.initialized,this.referenceMode=handle.referenceMode;const literal=await handle.toLiteral();if(this.referenceMode&&literal.model.length>0){const[backingStore,handleBackingStore]=await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]);literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:value.id,storageKey:backingStore.storageKey}}));const underlying=await handleBackingStore.getMultiple(literal.model.map(({id:id})=>id));await backingStore.storeMultiple(underlying,[this.storageKey])}const updatedCrdtModel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(literal.model),updatedCrdtModelLiteral=(await this.upsert(async doc=>(doc.referenceMode=this.referenceMode,doc.model=updatedCrdtModel.toLiteral(),doc.version=Math.max(this.version,doc.version)+1,doc))).model,dataToFire=0===updatedCrdtModelLiteral.length?null:updatedCrdtModelLiteral[0].value;this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.ChangeEvent({data:dataToFire,version:this.version}))}async modelForSynchronization(){return await this.initialized,{version:this.version,model:await this._toList()}}async toLiteral(){return await this.initialized,{version:this.version,model:(await this.getModel()).toLiteral()}}async _toList(){if(await this.initialized,this.referenceMode){const items=(await this.getModel()).toLiteral();if(0===items.length)return[];const refSet=new Set;items.forEach(item=>refSet.add(item.value.storageKey)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(1===refSet.size,"multiple storageKeys in reference set of collection not yet supported.");refSet.values().next().value;const backingStore=await this.ensureBackingStore(),ids=items.map(item=>item.value.id),backingStoreValues=await backingStore.getMultiple(ids),retval=[];for(const item of items){const backingStoreValue=backingStoreValues.shift();retval.push({id:item.value.id,value:backingStoreValue,keys:item.keys})}return retval}return(await this.getModel()).toLiteral()}async toList(){return await this.initialized,(await this._toList()).map(item=>item.value)}async getMultiple(ids){await this.initialized,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"getMultiple not implemented for referenceMode stores for "+this.storageKey);const model=await this.getModel();return ids.map(id=>model.getValue(id))}async storeMultiple(values,keys,originatorId=null){await this.initialized,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"storeMultiple not implemented for referenceMode stores"),await this.upsert(async doc=>{const crdtmodel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model);return values.map(value=>crdtmodel.add(value.id,value,keys)),doc.model=crdtmodel.toLiteral(),doc.version++,doc})}async get(id){if(await this.initialized,this.referenceMode){const ref=(await this.getModel()).getValue(id);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==ref,`no reference for id [id=${id}, collection.id=${this.id}, storageKey=${this._storageKey}, referenceMode=${this.referenceMode}].`);const backingStore=await this.ensureBackingStore(),backedValue=await backingStore.get(ref.id);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==backedValue,`should never return a null entity value [ref.id=${ref.id}, collection.id=${this.id}, storageKey=${this._storageKey}, referenceMode=${this.referenceMode}].`),backedValue}const modelValue=(await this.getModel()).getValue(id);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==modelValue,`should never return a null entity value [id=${id}, collection.id=${this.id}, storageKey=${this._storageKey}, referenceMode=${this.referenceMode}].`),modelValue}async store(value,keys,originatorId){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required");value.id;const item={value:value,keys:keys,effective:!1};if(this.referenceMode){const referredType=this.type.getContainedType(),storageKey=this.storageEngine.baseStorageKey(referredType,this.storageKey);await this.initialized,(await this.ensureBackingStore()).store(value,keys);await this.upsert(async doc=>{const crdtmodel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model);return item.effective=crdtmodel.add(value.id,{id:value.id,storageKey:storageKey},keys),doc.model=crdtmodel.toLiteral(),doc})}else{await this.initialized;await this.upsert(async doc=>{const crdtmodel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model);return item.effective=crdtmodel.add(value.id,value,keys),doc.model=crdtmodel.toLiteral(),doc})}this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.ChangeEvent({add:[item],version:this.version,originatorId:originatorId}))}async removeMultiple(items,originatorId){await this.initialized;await this.upsert(async doc=>{const crdtmodel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model);return 0===items.length&&(items=crdtmodel.toList().map(item=>({id:item.id,keys:[]}))),items.forEach(item=>{0===item.keys.length&&(item.keys=crdtmodel.getKeys(item.id)),item.value=crdtmodel.getValue(item.id),null!==item.value&&(item.effective=crdtmodel.remove(item.id,item.keys))}),doc.model=crdtmodel.toLiteral(),doc});this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.ChangeEvent({remove:items,version:this.version,originatorId:originatorId}))}async remove(id,keys=[],originatorId){await this.initialized;await this.upsert(async doc=>{const crdtmodel=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model);0===keys.length&&(keys=crdtmodel.getKeys(id));const value=crdtmodel.getValue(id);if(null!==value){const effective=crdtmodel.remove(id,keys);this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_3__.ChangeEvent({remove:[{value:value,keys:keys,effective:effective}],version:this.version,originatorId:originatorId}))}return doc.model=crdtmodel.toLiteral(),doc})}onRemoteStateSynced(doc){doc.model;this.bumpVersion()}async getModel(){const doc=await this.upsert(async doc=>doc);return new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel(doc.model)}async upsert(mutatorFn){const defaultDoc={referenceMode:this.referenceMode,type:this.type.toLiteral(),model:(new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_2__.CrdtCollectionModel).toLiteral(),version:0},release=await this.upsertMutex.acquire();try{const doc=await Object(_pouch_db_upsert_js__WEBPACK_IMPORTED_MODULE_4__.upsert)(this.db,this.pouchDbKey.location,mutatorFn,defaultDoc);return this.version=doc.version,this.referenceMode=doc.referenceMode,doc}finally{release()}}async clearItemsForTesting(){await this.initialized;try{const doc=await this.db.get(this.pouchDbKey.location);await this.db.remove(doc)}catch(err){"not_found"!==err.name&&console.warn("clearItemsForTesting: error removing",err)}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"upsert",function(){return upsert});
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const DEFAULT_MAX_RETRIES=100;async function upsert(db,docId,mutatorFn,defaultValue){let upsertAttempts=0;for(;upsertAttempts++<DEFAULT_MAX_RETRIES;){let doc,existingDoc=!1;try{doc=await db.get(docId),existingDoc=!0}catch(err){if("not_found"!==err.name)throw err;doc={_rev:void 0,_id:docId,...defaultValue}}const newDoc=await mutatorFn({...doc});if(existingDoc&&JSON.stringify(newDoc)===JSON.stringify(doc))return newDoc;try{newDoc._id=docId,newDoc.version++;await db.put(newDoc);return newDoc}catch(err){if("conflict"!==err.name)throw console.warn("PouchDbCollection.getModelAndUpdate (err,doc)=",err,doc),err}}throw new Error("Unable to store key="+docId)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PouchDbVariable",function(){return PouchDbVariable});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(36),_pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(104),_pouch_db_upsert_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(107);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class PouchDbVariable extends _pouch_db_storage_provider_js__WEBPACK_IMPORTED_MODULE_2__.PouchDbStorageProvider{constructor(type,storageEngine,name,id,key,refMode){super(type,storageEngine,name,id,key,refMode),this.localKeyId=0,this.version=0,this.upsert(async doc=>doc).then(doc=>{this.resolveInitialized()}).catch(err=>{throw console.warn("Error init "+this.storageKey,err),err})}backingType(){return this.type}async clone(){const variable=new PouchDbVariable(this.type,this.storageEngine,this.name,this.id,null,this.referenceMode);return await variable.cloneFrom(this),variable}async cloneFrom(handle){const literal=await handle.toLiteral();if(this.referenceMode=handle.referenceMode,handle.referenceMode&&literal.model.length>0){const[backingStore,handleBackingStore]=await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]);literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:value.id,storageKey:backingStore.storageKey}}));const underlying=await handleBackingStore.getMultiple(literal.model.map(({id:id})=>id));await backingStore.storeMultiple(underlying,[this.storageKey])}if(await this.fromLiteral(literal),literal&&literal.model&&1===literal.model.length){const newvalue=literal.model[0].value;newvalue&&await this.upsert(async doc=>(doc.value=newvalue,doc.referenceMode=this.referenceMode,doc.version=Math.max(this.version,doc.version)+1,doc)),this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_1__.ChangeEvent({data:newvalue,version:this.version}))}}async modelForSynchronization(){await this.initialized;const value=(await this.upsert(async doc=>doc)).value;if(this.referenceMode&&null!==value){const backingStore=await this.ensureBackingStore(),result=await backingStore.get(value.id);return{version:this.version,model:[{id:value.id,value:result}]}}return super.modelForSynchronization()}async toLiteral(){await this.initialized;const value=(await this.upsert(async doc=>doc)).value;let model=[];return null!=value&&(model=[{id:value.id,keys:[],value:value}]),{version:this.version,model:model}}async fromLiteral({version:version,model:model}){await this.initialized;const value=0===model.length?null:model[0].value;this.referenceMode&&value&&value.rawData&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,`shouldn't have rawData ${JSON.stringify(value.rawData)} here`),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value);const newDoc=await this.upsert(async doc=>(doc.value=value,doc.referenceMode=this.referenceMode,doc.version=Math.max(version,doc.version)+1,doc));this.version=newDoc.version}async get(){await this.initialized;try{let value=(await this.upsert(async doc=>doc)).value;if(null==value&&console.warn("value is null and refmode="+this.referenceMode),this.referenceMode&&value){const backingStore=await this.ensureBackingStore();value=await backingStore.get(value.id)}return value}catch(err){return console.warn("PouchDbVariable.get err=",err),null}}async set(value,originatorId=null,barrier=null){let stored;if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value),this.referenceMode&&value){const referredType=this.type,storageKey=this.storageEngine.baseStorageKey(referredType,this.storageKey),backingStore=await this.ensureBackingStore();await backingStore.store(value,[this.storageKey+this.localKeyId++]),stored=await this.upsert(async doc=>(doc.referenceMode=this.referenceMode,doc.version=this.version,doc.value={id:value.id,storageKey:storageKey},doc))}else if(null==value)try{const doc=await this.db.get(this.pouchDbKey.location);await this.db.remove(doc)}catch(err){if("not_found"!==err.name)throw console.warn("PouchDbVariable.remove err=",err),err}else stored=await this.upsert(async doc=>(doc.referenceMode=this.referenceMode,doc.version=this.version,doc.value=value,doc));this.bumpVersion();const data=this.referenceMode?value:stored.value;await this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_1__.ChangeEvent({data:data,version:this.version,originatorId:originatorId,barrier:barrier}))}async clear(originatorId=null,barrier=null){await this.set(null,originatorId,barrier)}onRemoteStateSynced(doc){const value=doc.value;this.bumpVersion(doc.version),value?this.ensureBackingStore().then(async store=>{const data=await store.get(value.id);data?this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_1__.ChangeEvent({data:data,version:this.version})):console.log("PouchDbVariable.onRemoteSynced: possible race condition for id="+value.id)}):null!=value&&this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_1__.ChangeEvent({data:value,version:this.version}))}async upsert(mutatorFn){const defaultDoc={value:null,version:0,referenceMode:this.referenceMode},doc=await Object(_pouch_db_upsert_js__WEBPACK_IMPORTED_MODULE_3__.upsert)(this.db,this.pouchDbKey.location,mutatorFn,defaultDoc);return this.referenceMode=doc.referenceMode,this.version=doc.version,doc}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(110),__webpack_require__(111)},function(module,exports){!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=44)}({2:function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){"object"==typeof window&&(g=window)}module.exports=g},44:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var firebase_app__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(45),firebase_app__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(firebase_app__WEBPACK_IMPORTED_MODULE_0__);__webpack_require__(51),__webpack_require__(55);window.firebase={firebase:firebase_app__WEBPACK_IMPORTED_MODULE_0___default()}},45:function(module,exports,__webpack_require__){"use strict";var ex,firebase=(ex=__webpack_require__(46))&&"object"==typeof ex&&"default"in ex?ex.default:ex;
/**
 * @license
 * Copyright 2018 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */module.exports=firebase},46:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _a,tslib_1=__webpack_require__(47),util=__webpack_require__(48),logger$1=__webpack_require__(50),ERRORS=((_a={})["no-app"]="No Firebase App '{$name}' has been created - call Firebase App.initializeApp()",_a["bad-app-name"]="Illegal App name: '{$name}",_a["duplicate-app"]="Firebase App named '{$name}' already exists",_a["app-deleted"]="Firebase App named '{$name}' already deleted",_a["duplicate-service"]="Firebase service named '{$name}' already registered",_a["invalid-app-argument"]="firebase.{$name}() takes either no argument or a Firebase App instance.",_a),ERROR_FACTORY=new util.ErrorFactory("app","Firebase",ERRORS),DEFAULT_ENTRY_NAME="[DEFAULT]",tokenListeners=[],FirebaseAppImpl=function(){function FirebaseAppImpl(options,config,firebase_){this.firebase_=firebase_,this.isDeleted_=!1,this.services_={},this.name_=config.name,this.automaticDataCollectionEnabled_=config.automaticDataCollectionEnabled||!1,this.options_=util.deepCopy(options),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(callback){tokenListeners.push(callback),setTimeout(function(){return callback(null)},0)},removeAuthTokenListener:function(callback){tokenListeners=tokenListeners.filter(function(listener){return listener!==callback})}}}return Object.defineProperty(FirebaseAppImpl.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(val){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=val},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),FirebaseAppImpl.prototype.delete=function(){var _this=this;return new Promise(function(resolve){_this.checkDestroyed_(),resolve()}).then(function(){_this.firebase_.INTERNAL.removeApp(_this.name_);for(var services=[],_i=0,_a=Object.keys(_this.services_);_i<_a.length;_i++)for(var serviceKey=_a[_i],_b=0,_c=Object.keys(_this.services_[serviceKey]);_b<_c.length;_b++){var instanceKey=_c[_b];services.push(_this.services_[serviceKey][instanceKey])}return Promise.all(services.map(function(service){return service.INTERNAL.delete()}))}).then(function(){_this.isDeleted_=!0,_this.services_={}})},FirebaseAppImpl.prototype._getService=function(name,instanceIdentifier){if(void 0===instanceIdentifier&&(instanceIdentifier=DEFAULT_ENTRY_NAME),this.checkDestroyed_(),this.services_[name]||(this.services_[name]={}),!this.services_[name][instanceIdentifier]){var instanceSpecifier=instanceIdentifier!==DEFAULT_ENTRY_NAME?instanceIdentifier:void 0,service=this.firebase_.INTERNAL.factories[name](this,this.extendApp.bind(this),instanceSpecifier);this.services_[name][instanceIdentifier]=service}return this.services_[name][instanceIdentifier]},FirebaseAppImpl.prototype.extendApp=function(props){var _this=this;util.deepExtend(this,props),props.INTERNAL&&props.INTERNAL.addAuthTokenListener&&(tokenListeners.forEach(function(listener){_this.INTERNAL.addAuthTokenListener(listener)}),tokenListeners=[])},FirebaseAppImpl.prototype.checkDestroyed_=function(){if(this.isDeleted_)throw ERROR_FACTORY.create("app-deleted",{name:this.name_})},FirebaseAppImpl}();FirebaseAppImpl.prototype.name&&FirebaseAppImpl.prototype.options||FirebaseAppImpl.prototype.delete||console.log("dc");var version="6.0.4";
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function contains(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var logger=new logger$1.Logger("@firebase/app");if(util.isBrowser()&&"firebase"in self){logger.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var sdkVersion=self.firebase.SDK_VERSION;sdkVersion&&sdkVersion.indexOf("LITE")>=0&&logger.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var firebaseNamespace=
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function createFirebaseNamespace(){var namespace=function(firebaseAppImpl){var apps={},factories={},appHooks={},namespace={__esModule:!0,initializeApp:function(options,rawConfig){if(void 0===rawConfig&&(rawConfig={}),"object"!=typeof rawConfig||null===rawConfig){var name_1=rawConfig;rawConfig={name:name_1}}var config=rawConfig;void 0===config.name&&(config.name=DEFAULT_ENTRY_NAME);var name=config.name;if("string"!=typeof name||!name)throw ERROR_FACTORY.create("bad-app-name",{name:String(name)});if(contains(apps,name))throw ERROR_FACTORY.create("duplicate-app",{name:name});var app=new firebaseAppImpl(options,config,namespace);return apps[name]=app,callAppHooks(app,"create"),app},app:app,apps:null,SDK_VERSION:version,INTERNAL:{registerService:function(name,createService,serviceProperties,appHook,allowMultipleInstances){if(void 0===allowMultipleInstances&&(allowMultipleInstances=!1),factories[name])throw ERROR_FACTORY.create("duplicate-service",{name:name});function serviceNamespace(appArg){if(void 0===appArg&&(appArg=app()),"function"!=typeof appArg[name])throw ERROR_FACTORY.create("invalid-app-argument",{name:name});return appArg[name]()}return factories[name]=createService,appHook&&(appHooks[name]=appHook,getApps().forEach(function(app){appHook("create",app)})),void 0!==serviceProperties&&util.deepExtend(serviceNamespace,serviceProperties),namespace[name]=serviceNamespace,firebaseAppImpl.prototype[name]=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return this._getService.bind(this,name).apply(this,allowMultipleInstances?args:[])},serviceNamespace},removeApp:function(name){callAppHooks(apps[name],"delete"),delete apps[name]},factories:factories,useAsService:useAsService}};function app(name){if(!contains(apps,name=name||DEFAULT_ENTRY_NAME))throw ERROR_FACTORY.create("no-app",{name:name});return apps[name]}function getApps(){return Object.keys(apps).map(function(name){return apps[name]})}function callAppHooks(app,eventName){for(var _i=0,_a=Object.keys(factories);_i<_a.length;_i++){var factoryName=useAsService(0,_a[_i]);if(null===factoryName)return;appHooks[factoryName]&&appHooks[factoryName](eventName,app)}}function useAsService(app,name){return"serverAuth"===name?null:name}return util.patchProperty(namespace,"default",namespace),Object.defineProperty(namespace,"apps",{get:getApps}),util.patchProperty(app,"App",firebaseAppImpl),namespace}(FirebaseAppImpl);return namespace.INTERNAL=tslib_1.__assign({},namespace.INTERNAL,{createFirebaseNamespace:createFirebaseNamespace,extendNamespace:function(props){util.deepExtend(namespace,props)},createSubscribe:util.createSubscribe,ErrorFactory:util.ErrorFactory,deepExtend:util.deepExtend}),namespace}(),initializeApp=firebaseNamespace.initializeApp;firebaseNamespace.initializeApp=function(){return util.isNode()&&logger.warn('\n      Warning: This is a browser-targeted Firebase bundle but it appears it is being\n      run in a Node environment.  If running in a Node environment, make sure you\n      are using the bundle specified by the "main" field in package.json.\n      \n      If you are using Webpack, you can specify "main" as the first item in\n      "resolve.mainFields":\n      https://webpack.js.org/configuration/resolve/#resolvemainfields\n      \n      If using Rollup, use the rollup-plugin-node-resolve plugin and set "module"\n      to false and "main" to true:\n      https://github.com/rollup/rollup-plugin-node-resolve\n      '),initializeApp.apply(void 0,arguments)};var firebase=firebaseNamespace;exports.default=firebase,exports.firebase=firebase},47:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"__extends",function(){return __extends}),__webpack_require__.d(__webpack_exports__,"__assign",function(){return __assign}),__webpack_require__.d(__webpack_exports__,"__rest",function(){return __rest}),__webpack_require__.d(__webpack_exports__,"__decorate",function(){return __decorate}),__webpack_require__.d(__webpack_exports__,"__param",function(){return __param}),__webpack_require__.d(__webpack_exports__,"__metadata",function(){return __metadata}),__webpack_require__.d(__webpack_exports__,"__awaiter",function(){return __awaiter}),__webpack_require__.d(__webpack_exports__,"__generator",function(){return __generator}),__webpack_require__.d(__webpack_exports__,"__exportStar",function(){return __exportStar}),__webpack_require__.d(__webpack_exports__,"__values",function(){return __values}),__webpack_require__.d(__webpack_exports__,"__read",function(){return __read}),__webpack_require__.d(__webpack_exports__,"__spread",function(){return __spread}),__webpack_require__.d(__webpack_exports__,"__await",function(){return __await}),__webpack_require__.d(__webpack_exports__,"__asyncGenerator",function(){return __asyncGenerator}),__webpack_require__.d(__webpack_exports__,"__asyncDelegator",function(){return __asyncDelegator}),__webpack_require__.d(__webpack_exports__,"__asyncValues",function(){return __asyncValues}),__webpack_require__.d(__webpack_exports__,"__makeTemplateObject",function(){return __makeTemplateObject}),__webpack_require__.d(__webpack_exports__,"__importStar",function(){return __importStar}),__webpack_require__.d(__webpack_exports__,"__importDefault",function(){return __importDefault});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&(t[p[i]]=s[p[i]])}return t}function __decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function __param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}function __metadata(metadataKey,metadataValue){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)}function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __exportStar(m,exports){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}function __values(o){var m="function"==typeof Symbol&&o[Symbol.iterator],i=0;return m?m.call(o):{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}}}function __read(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar}function __spread(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar}function __await(v){return this instanceof __await?(this.v=v,this):new __await(v)}function __asyncGenerator(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,g=generator.apply(thisArg,_arguments||[]),q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){g[n]&&(i[n]=function(v){return new Promise(function(a,b){q.push([n,v,a,b])>1||resume(n,v)})})}function resume(n,v){try{(r=g[n](v)).value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}catch(e){settle(q[0][3],e)}var r}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){f(v),q.shift(),q.length&&resume(q[0][0],q[0][1])}}function __asyncDelegator(o){var i,p;return i={},verb("next"),verb("throw",function(e){throw e}),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:"return"===n}:f?f(v):v}:f}}function __asyncValues(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,m=o[Symbol.asyncIterator];return m?m.call(o):(o=__values(o),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise(function(resolve,reject){(function(resolve,reject,d,v){Promise.resolve(v).then(function(v){resolve({value:v,done:d})},reject)})(resolve,reject,(v=o[n](v)).done,v.value)})}}}function __makeTemplateObject(cooked,raw){return Object.defineProperty?Object.defineProperty(cooked,"raw",{value:raw}):cooked.raw=raw,cooked}function __importStar(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result}function __importDefault(mod){return mod&&mod.__esModule?mod:{default:mod}}},48:function(module,exports,__webpack_require__){"use strict";(function(global){Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=__webpack_require__(49),CONSTANTS={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},assert=function(assertion,message){if(!assertion)throw assertionError(message)},assertionError=function(message){return new Error("Firebase Database ("+CONSTANTS.SDK_VERSION+") INTERNAL ASSERT FAILED: "+message)},stringToByteArray=function(str){for(var out=[],p=0,i=0;i<str.length;i++){var c=str.charCodeAt(i);c<128?out[p++]=c:c<2048?(out[p++]=c>>6|192,out[p++]=63&c|128):55296==(64512&c)&&i+1<str.length&&56320==(64512&str.charCodeAt(i+1))?(c=65536+((1023&c)<<10)+(1023&str.charCodeAt(++i)),out[p++]=c>>18|240,out[p++]=c>>12&63|128,out[p++]=c>>6&63|128,out[p++]=63&c|128):(out[p++]=c>>12|224,out[p++]=c>>6&63|128,out[p++]=63&c|128)}return out},base64={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(input,opt_webSafe){if(!Array.isArray(input))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var byteToCharMap=opt_webSafe?this.byteToCharMapWebSafe_:this.byteToCharMap_,output=[],i=0;i<input.length;i+=3){var byte1=input[i],haveByte2=i+1<input.length,byte2=haveByte2?input[i+1]:0,haveByte3=i+2<input.length,byte3=haveByte3?input[i+2]:0,outByte1=byte1>>2,outByte2=(3&byte1)<<4|byte2>>4,outByte3=(15&byte2)<<2|byte3>>6,outByte4=63&byte3;haveByte3||(outByte4=64,haveByte2||(outByte3=64)),output.push(byteToCharMap[outByte1],byteToCharMap[outByte2],byteToCharMap[outByte3],byteToCharMap[outByte4])}return output.join("")},encodeString:function(input,opt_webSafe){return this.HAS_NATIVE_SUPPORT&&!opt_webSafe?btoa(input):this.encodeByteArray(stringToByteArray(input),opt_webSafe)},decodeString:function(input,opt_webSafe){return this.HAS_NATIVE_SUPPORT&&!opt_webSafe?atob(input):function(bytes){for(var out=[],pos=0,c=0;pos<bytes.length;){var c1=bytes[pos++];if(c1<128)out[c++]=String.fromCharCode(c1);else if(c1>191&&c1<224){var c2=bytes[pos++];out[c++]=String.fromCharCode((31&c1)<<6|63&c2)}else if(c1>239&&c1<365){var u=((7&c1)<<18|(63&(c2=bytes[pos++]))<<12|(63&(c3=bytes[pos++]))<<6|63&bytes[pos++])-65536;out[c++]=String.fromCharCode(55296+(u>>10)),out[c++]=String.fromCharCode(56320+(1023&u))}else{c2=bytes[pos++];var c3=bytes[pos++];out[c++]=String.fromCharCode((15&c1)<<12|(63&c2)<<6|63&c3)}}return out.join("")}(this.decodeStringToByteArray(input,opt_webSafe))},decodeStringToByteArray:function(input,opt_webSafe){this.init_();for(var charToByteMap=opt_webSafe?this.charToByteMapWebSafe_:this.charToByteMap_,output=[],i=0;i<input.length;){var byte1=charToByteMap[input.charAt(i++)],byte2=i<input.length?charToByteMap[input.charAt(i)]:0,byte3=++i<input.length?charToByteMap[input.charAt(i)]:64,byte4=++i<input.length?charToByteMap[input.charAt(i)]:64;if(++i,null==byte1||null==byte2||null==byte3||null==byte4)throw Error();var outByte1=byte1<<2|byte2>>4;if(output.push(outByte1),64!=byte3){var outByte2=byte2<<4&240|byte3>>2;if(output.push(outByte2),64!=byte4){var outByte3=byte3<<6&192|byte4;output.push(outByte3)}}}return output},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var i=0;i<this.ENCODED_VALS.length;i++)this.byteToCharMap_[i]=this.ENCODED_VALS.charAt(i),this.charToByteMap_[this.byteToCharMap_[i]]=i,this.byteToCharMapWebSafe_[i]=this.ENCODED_VALS_WEBSAFE.charAt(i),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[i]]=i,i>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(i)]=i,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(i)]=i)}}},base64Decode=function(str){try{return base64.decodeString(str,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function deepExtend(target,source){if(!(source instanceof Object))return source;switch(source.constructor){case Date:return new Date(source.getTime());case Object:void 0===target&&(target={});break;case Array:target=[];break;default:return source}for(var prop in source)source.hasOwnProperty(prop)&&(target[prop]=deepExtend(target[prop],source[prop]));return target}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Deferred=function(){function Deferred(){var _this=this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve,_this.reject=reject})}return Deferred.prototype.wrapCallback=function(callback){var _this=this;return function(error,value){error?_this.reject(error):_this.resolve(value),"function"==typeof callback&&(_this.promise.catch(function(){}),1===callback.length?callback(error):callback(error,value))}},Deferred}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getUA(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var ERROR_NAME="FirebaseError",FirebaseError=function(_super){function FirebaseError(code,message){var _this=_super.call(this,message)||this;return _this.code=code,_this.name=ERROR_NAME,Object.setPrototypeOf(_this,FirebaseError.prototype),Error.captureStackTrace&&Error.captureStackTrace(_this,ErrorFactory.prototype.create),_this}return tslib_1.__extends(FirebaseError,_super),FirebaseError}(Error),ErrorFactory=function(){function ErrorFactory(service,serviceName,errors){this.service=service,this.serviceName=serviceName,this.errors=errors}return ErrorFactory.prototype.create=function(code){for(var data=[],_i=1;_i<arguments.length;_i++)data[_i-1]=arguments[_i];for(var customData=data[0]||{},fullCode=this.service+"/"+code,template=this.errors[code],message=template?function(template,data){return template.replace(PATTERN,function(_,key){var value=data[key];return null!=value?value.toString():"<"+key+"?>"})}(template,customData):"Error",fullMessage=this.serviceName+": "+message+" ("+fullCode+").",error=new FirebaseError(fullCode,fullMessage),_a=0,_b=Object.keys(customData);_a<_b.length;_a++){var key=_b[_a];"_"!==key.slice(-1)&&(key in error&&console.warn('Overwriting FirebaseError base field "'+key+'" can cause unexpected behavior.'),error[key]=customData[key])}return error},ErrorFactory}();var PATTERN=/\{\$([^}]+)}/g;
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jsonEval(str){return JSON.parse(str)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var decode=function(token){var header={},claims={},data={},signature="";try{var parts=token.split(".");header=jsonEval(base64Decode(parts[0])||""),claims=jsonEval(base64Decode(parts[1])||""),signature=parts[2],data=claims.d||{},delete claims.d}catch(e){}return{header:header,claims:claims,data:data,signature:signature}},forEach=function(obj,fn){for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&fn(key,obj[key])},extend=function(objTo,objFrom){return forEach(objFrom,function(key,value){objTo[key]=value}),objTo},findKey=function(obj,fn,opt_this){for(var key in obj)if(fn.call(opt_this,obj[key],key,obj))return key},Sha1=function(){function Sha1(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(var i=1;i<this.blockSize;++i)this.pad_[i]=0;this.reset()}return Sha1.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},Sha1.prototype.compress_=function(buf,opt_offset){opt_offset||(opt_offset=0);var W=this.W_;if("string"==typeof buf)for(var i=0;i<16;i++)W[i]=buf.charCodeAt(opt_offset)<<24|buf.charCodeAt(opt_offset+1)<<16|buf.charCodeAt(opt_offset+2)<<8|buf.charCodeAt(opt_offset+3),opt_offset+=4;else for(i=0;i<16;i++)W[i]=buf[opt_offset]<<24|buf[opt_offset+1]<<16|buf[opt_offset+2]<<8|buf[opt_offset+3],opt_offset+=4;for(i=16;i<80;i++){var t=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=4294967295&(t<<1|t>>>31)}var f,k,a=this.chain_[0],b=this.chain_[1],c=this.chain_[2],d=this.chain_[3],e=this.chain_[4];for(i=0;i<80;i++){i<40?i<20?(f=d^b&(c^d),k=1518500249):(f=b^c^d,k=1859775393):i<60?(f=b&c|d&(b|c),k=2400959708):(f=b^c^d,k=3395469782);t=(a<<5|a>>>27)+f+e+k+W[i]&4294967295;e=d,d=c,c=4294967295&(b<<30|b>>>2),b=a,a=t}this.chain_[0]=this.chain_[0]+a&4294967295,this.chain_[1]=this.chain_[1]+b&4294967295,this.chain_[2]=this.chain_[2]+c&4294967295,this.chain_[3]=this.chain_[3]+d&4294967295,this.chain_[4]=this.chain_[4]+e&4294967295},Sha1.prototype.update=function(bytes,opt_length){if(null!=bytes){void 0===opt_length&&(opt_length=bytes.length);for(var lengthMinusBlock=opt_length-this.blockSize,n=0,buf=this.buf_,inbuf=this.inbuf_;n<opt_length;){if(0==inbuf)for(;n<=lengthMinusBlock;)this.compress_(bytes,n),n+=this.blockSize;if("string"==typeof bytes){for(;n<opt_length;)if(buf[inbuf]=bytes.charCodeAt(n),++n,++inbuf==this.blockSize){this.compress_(buf),inbuf=0;break}}else for(;n<opt_length;)if(buf[inbuf]=bytes[n],++n,++inbuf==this.blockSize){this.compress_(buf),inbuf=0;break}}this.inbuf_=inbuf,this.total_+=opt_length}},Sha1.prototype.digest=function(){var digest=[],totalBits=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var i=this.blockSize-1;i>=56;i--)this.buf_[i]=255&totalBits,totalBits/=256;this.compress_(this.buf_);var n=0;for(i=0;i<5;i++)for(var j=24;j>=0;j-=8)digest[n]=this.chain_[i]>>j&255,++n;return digest},Sha1}();var ObserverProxy=function(){function ObserverProxy(executor,onNoObservers){var _this=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=onNoObservers,this.task.then(function(){executor(_this)}).catch(function(e){_this.error(e)})}return ObserverProxy.prototype.next=function(value){this.forEachObserver(function(observer){observer.next(value)})},ObserverProxy.prototype.error=function(error){this.forEachObserver(function(observer){observer.error(error)}),this.close(error)},ObserverProxy.prototype.complete=function(){this.forEachObserver(function(observer){observer.complete()}),this.close()},ObserverProxy.prototype.subscribe=function(nextOrObserver,error,complete){var observer,_this=this;if(void 0===nextOrObserver&&void 0===error&&void 0===complete)throw new Error("Missing Observer.");void 0===(observer=function(obj,methods){if("object"!=typeof obj||null===obj)return!1;for(var _i=0,methods_1=methods;_i<methods_1.length;_i++){var method=methods_1[_i];if(method in obj&&"function"==typeof obj[method])return!0}return!1}(nextOrObserver,["next","error","complete"])?nextOrObserver:{next:nextOrObserver,error:error,complete:complete}).next&&(observer.next=noop),void 0===observer.error&&(observer.error=noop),void 0===observer.complete&&(observer.complete=noop);var unsub=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{_this.finalError?observer.error(_this.finalError):observer.complete()}catch(e){}}),this.observers.push(observer),unsub},ObserverProxy.prototype.unsubscribeOne=function(i){void 0!==this.observers&&void 0!==this.observers[i]&&(delete this.observers[i],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},ObserverProxy.prototype.forEachObserver=function(fn){if(!this.finalized)for(var i=0;i<this.observers.length;i++)this.sendOne(i,fn)},ObserverProxy.prototype.sendOne=function(i,fn){var _this=this;this.task.then(function(){if(void 0!==_this.observers&&void 0!==_this.observers[i])try{fn(_this.observers[i])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})},ObserverProxy.prototype.close=function(err){var _this=this;this.finalized||(this.finalized=!0,void 0!==err&&(this.finalError=err),this.task.then(function(){_this.observers=void 0,_this.onNoObservers=void 0}))},ObserverProxy}();function noop(){}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function errorPrefix(fnName,argumentNumber,optional){var argName="";switch(argumentNumber){case 1:argName=optional?"first":"First";break;case 2:argName=optional?"second":"Second";break;case 3:argName=optional?"third":"Third";break;case 4:argName=optional?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}var error=fnName+" failed: ";return error+=argName+" argument "}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
exports.CONSTANTS=CONSTANTS,exports.Deferred=Deferred,exports.ErrorFactory=ErrorFactory,exports.FirebaseError=FirebaseError,exports.Sha1=Sha1,exports.assert=assert,exports.assertionError=assertionError,exports.async=function(fn,onError){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];Promise.resolve(!0).then(function(){fn.apply(void 0,args)}).catch(function(error){onError&&onError(error)})}},exports.base64=base64,exports.base64Decode=base64Decode,exports.base64Encode=function(str){var utf8Bytes=stringToByteArray(str);return base64.encodeByteArray(utf8Bytes,!0)},exports.clone=function(obj){return extend({},obj)},exports.contains=function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)},exports.createSubscribe=function(executor,onNoObservers){var proxy=new ObserverProxy(executor,onNoObservers);return proxy.subscribe.bind(proxy)},exports.decode=decode,exports.deepCopy=
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function(value){return deepExtend(void 0,value)},exports.deepExtend=deepExtend,exports.errorPrefix=errorPrefix,exports.every=function(obj,fn){for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)&&!fn(key,obj[key]))return!1;return!0},exports.extend=extend,exports.findKey=findKey,exports.findValue=function(obj,fn,opt_this){var key=findKey(obj,fn,opt_this);return key&&obj[key]},exports.forEach=forEach,exports.getAnyKey=function(obj){for(var key in obj)return key},exports.getCount=function(obj){var rv=0;for(var key in obj)rv++;return rv},exports.getUA=getUA,exports.getValues=function(obj){var res=[],i=0;for(var key in obj)res[i++]=obj[key];return res},exports.isAdmin=function(token){var claims=decode(token).claims;return"object"==typeof claims&&!0===claims.admin},exports.isBrowser=function(){return"object"==typeof self&&self.self===self},exports.isEmpty=function(obj){for(var key in obj)return!1;return!0},exports.isMobileCordova=function(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(getUA())},exports.isNode=function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return!1}},exports.isNodeSdk=function(){return!0===CONSTANTS.NODE_CLIENT||!0===CONSTANTS.NODE_ADMIN},exports.isNonNullObject=function(obj){return"object"==typeof obj&&null!==obj},exports.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},exports.isValidFormat=function(token){var claims=decode(token).claims;return!!claims&&"object"==typeof claims&&claims.hasOwnProperty("iat")},exports.isValidTimestamp=function(token){var validSince,validUntil,claims=decode(token).claims,now=Math.floor((new Date).getTime()/1e3);return"object"==typeof claims&&(claims.hasOwnProperty("nbf")?validSince=claims.nbf:claims.hasOwnProperty("iat")&&(validSince=claims.iat),validUntil=claims.hasOwnProperty("exp")?claims.exp:validSince+86400),now&&validSince&&validUntil&&now>=validSince&&now<=validUntil},exports.issuedAtTime=function(token){var claims=decode(token).claims;return"object"==typeof claims&&claims.hasOwnProperty("iat")?claims.iat:null},exports.jsonEval=jsonEval,exports.map=function(obj,f,opt_obj){var res={};for(var key in obj)res[key]=f.call(opt_obj,obj[key],key,obj);return res},exports.patchProperty=function(obj,prop,value){obj[prop]=value},exports.querystring=function(querystringParams){var params=[];return forEach(querystringParams,function(key,value){Array.isArray(value)?value.forEach(function(arrayVal){params.push(encodeURIComponent(key)+"="+encodeURIComponent(arrayVal))}):params.push(encodeURIComponent(key)+"="+encodeURIComponent(value))}),params.length?"&"+params.join("&"):""},exports.querystringDecode=function(querystring){var obj={};return querystring.replace(/^\?/,"").split("&").forEach(function(token){if(token){var key=token.split("=");obj[key[0]]=key[1]}}),obj},exports.safeGet=function(obj,key){if(Object.prototype.hasOwnProperty.call(obj,key))return obj[key]},exports.stringLength=function(str){for(var p=0,i=0;i<str.length;i++){var c=str.charCodeAt(i);c<128?p++:c<2048?p+=2:c>=55296&&c<=56319?(p+=4,i++):p+=3}return p},exports.stringToByteArray=function(str){for(var out=[],p=0,i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c>=55296&&c<=56319){var high=c-55296;assert(++i<str.length,"Surrogate pair missing trail surrogate."),c=65536+(high<<10)+(str.charCodeAt(i)-56320)}c<128?out[p++]=c:c<2048?(out[p++]=c>>6|192,out[p++]=63&c|128):c<65536?(out[p++]=c>>12|224,out[p++]=c>>6&63|128,out[p++]=63&c|128):(out[p++]=c>>18|240,out[p++]=c>>12&63|128,out[p++]=c>>6&63|128,out[p++]=63&c|128)}return out},exports.stringify=function(data){return JSON.stringify(data)},exports.validateArgCount=function(fnName,minCount,maxCount,argCount){var argError;if(argCount<minCount?argError="at least "+minCount:argCount>maxCount&&(argError=0===maxCount?"none":"no more than "+maxCount),argError)throw new Error(fnName+" failed: Was called with "+argCount+(1===argCount?" argument.":" arguments.")+" Expects "+argError+".")},exports.validateCallback=function(fnName,argumentNumber,callback,optional){if((!optional||callback)&&"function"!=typeof callback)throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid function.")},exports.validateContextObject=function(fnName,argumentNumber,context,optional){if((!optional||context)&&("object"!=typeof context||null===context))throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid context object.")}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */,exports.validateNamespace=function(fnName,argumentNumber,namespace,optional){if((!optional||namespace)&&"string"!=typeof namespace)throw new Error(errorPrefix(fnName,argumentNumber,optional)+"must be a valid firebase namespace.")}}).call(this,__webpack_require__(2))},49:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"__extends",function(){return __extends}),__webpack_require__.d(__webpack_exports__,"__assign",function(){return __assign}),__webpack_require__.d(__webpack_exports__,"__rest",function(){return __rest}),__webpack_require__.d(__webpack_exports__,"__decorate",function(){return __decorate}),__webpack_require__.d(__webpack_exports__,"__param",function(){return __param}),__webpack_require__.d(__webpack_exports__,"__metadata",function(){return __metadata}),__webpack_require__.d(__webpack_exports__,"__awaiter",function(){return __awaiter}),__webpack_require__.d(__webpack_exports__,"__generator",function(){return __generator}),__webpack_require__.d(__webpack_exports__,"__exportStar",function(){return __exportStar}),__webpack_require__.d(__webpack_exports__,"__values",function(){return __values}),__webpack_require__.d(__webpack_exports__,"__read",function(){return __read}),__webpack_require__.d(__webpack_exports__,"__spread",function(){return __spread}),__webpack_require__.d(__webpack_exports__,"__await",function(){return __await}),__webpack_require__.d(__webpack_exports__,"__asyncGenerator",function(){return __asyncGenerator}),__webpack_require__.d(__webpack_exports__,"__asyncDelegator",function(){return __asyncDelegator}),__webpack_require__.d(__webpack_exports__,"__asyncValues",function(){return __asyncValues}),__webpack_require__.d(__webpack_exports__,"__makeTemplateObject",function(){return __makeTemplateObject}),__webpack_require__.d(__webpack_exports__,"__importStar",function(){return __importStar}),__webpack_require__.d(__webpack_exports__,"__importDefault",function(){return __importDefault});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&(t[p[i]]=s[p[i]])}return t}function __decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function __param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}function __metadata(metadataKey,metadataValue){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)}function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __exportStar(m,exports){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}function __values(o){var m="function"==typeof Symbol&&o[Symbol.iterator],i=0;return m?m.call(o):{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}}}function __read(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar}function __spread(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar}function __await(v){return this instanceof __await?(this.v=v,this):new __await(v)}function __asyncGenerator(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,g=generator.apply(thisArg,_arguments||[]),q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){g[n]&&(i[n]=function(v){return new Promise(function(a,b){q.push([n,v,a,b])>1||resume(n,v)})})}function resume(n,v){try{(r=g[n](v)).value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}catch(e){settle(q[0][3],e)}var r}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){f(v),q.shift(),q.length&&resume(q[0][0],q[0][1])}}function __asyncDelegator(o){var i,p;return i={},verb("next"),verb("throw",function(e){throw e}),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:"return"===n}:f?f(v):v}:f}}function __asyncValues(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,m=o[Symbol.asyncIterator];return m?m.call(o):(o=__values(o),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise(function(resolve,reject){(function(resolve,reject,d,v){Promise.resolve(v).then(function(v){resolve({value:v,done:d})},reject)})(resolve,reject,(v=o[n](v)).done,v.value)})}}}function __makeTemplateObject(cooked,raw){return Object.defineProperty?Object.defineProperty(cooked,"raw",{value:raw}):cooked.raw=raw,cooked}function __importStar(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result}function __importDefault(mod){return mod&&mod.__esModule?mod:{default:mod}}},50:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"LogLevel",function(){return LogLevel}),__webpack_require__.d(__webpack_exports__,"Logger",function(){return Logger}),__webpack_require__.d(__webpack_exports__,"setLogLevel",function(){return setLogLevel});
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var LogLevel,instances=[];!function(LogLevel){LogLevel[LogLevel.DEBUG=0]="DEBUG",LogLevel[LogLevel.VERBOSE=1]="VERBOSE",LogLevel[LogLevel.INFO=2]="INFO",LogLevel[LogLevel.WARN=3]="WARN",LogLevel[LogLevel.ERROR=4]="ERROR",LogLevel[LogLevel.SILENT=5]="SILENT"}(LogLevel||(LogLevel={}));var defaultLogLevel=LogLevel.INFO,defaultLogHandler=function(instance,logType){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];if(!(logType<instance.logLevel)){var now=(new Date).toISOString();switch(logType){case LogLevel.DEBUG:case LogLevel.VERBOSE:console.log.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case LogLevel.INFO:console.info.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case LogLevel.WARN:console.warn.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;case LogLevel.ERROR:console.error.apply(console,["["+now+"]  "+instance.name+":"].concat(args));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+logType+")")}}},Logger=function(){function Logger(name){this.name=name,this._logLevel=defaultLogLevel,this._logHandler=defaultLogHandler,instances.push(this)}return Object.defineProperty(Logger.prototype,"logLevel",{get:function(){return this._logLevel},set:function(val){if(!(val in LogLevel))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=val},enumerable:!0,configurable:!0}),Object.defineProperty(Logger.prototype,"logHandler",{get:function(){return this._logHandler},set:function(val){if("function"!=typeof val)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=val},enumerable:!0,configurable:!0}),Logger.prototype.debug=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this._logHandler.apply(this,[this,LogLevel.DEBUG].concat(args))},Logger.prototype.log=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this._logHandler.apply(this,[this,LogLevel.VERBOSE].concat(args))},Logger.prototype.info=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this._logHandler.apply(this,[this,LogLevel.INFO].concat(args))},Logger.prototype.warn=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this._logHandler.apply(this,[this,LogLevel.WARN].concat(args))},Logger.prototype.error=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this._logHandler.apply(this,[this,LogLevel.ERROR].concat(args))},Logger}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function setLogLevel(level){instances.forEach(function(inst){inst.logLevel=level})}},51:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(52)},52:function(module,exports,__webpack_require__){"use strict";(function(process){Object.defineProperty(exports,"__esModule",{value:!0});var ex,id,firebase=(ex=__webpack_require__(46))&&"object"==typeof ex&&"default"in ex?ex.default:ex,tslib_1=__webpack_require__(54),util=__webpack_require__(48),logger$1=__webpack_require__(50),DOMStorageWrapper=function(){function DOMStorageWrapper(domStorage_){this.domStorage_=domStorage_,this.prefix_="firebase:"}return DOMStorageWrapper.prototype.set=function(key,value){null==value?this.domStorage_.removeItem(this.prefixedName_(key)):this.domStorage_.setItem(this.prefixedName_(key),util.stringify(value))},DOMStorageWrapper.prototype.get=function(key){var storedVal=this.domStorage_.getItem(this.prefixedName_(key));return null==storedVal?null:util.jsonEval(storedVal)},DOMStorageWrapper.prototype.remove=function(key){this.domStorage_.removeItem(this.prefixedName_(key))},DOMStorageWrapper.prototype.prefixedName_=function(name){return this.prefix_+name},DOMStorageWrapper.prototype.toString=function(){return this.domStorage_.toString()},DOMStorageWrapper}(),MemoryStorage=function(){function MemoryStorage(){this.cache_={},this.isInMemoryStorage=!0}return MemoryStorage.prototype.set=function(key,value){null==value?delete this.cache_[key]:this.cache_[key]=value},MemoryStorage.prototype.get=function(key){return util.contains(this.cache_,key)?this.cache_[key]:null},MemoryStorage.prototype.remove=function(key){delete this.cache_[key]},MemoryStorage}(),createStoragefor=function(domStorageName){try{if("undefined"!=typeof window&&void 0!==window[domStorageName]){var domStorage=window[domStorageName];return domStorage.setItem("firebase:sentinel","cache"),domStorage.removeItem("firebase:sentinel"),new DOMStorageWrapper(domStorage)}}catch(e){}return new MemoryStorage},PersistentStorage=createStoragefor("localStorage"),SessionStorage=createStoragefor("sessionStorage"),logClient=new logger$1.Logger("@firebase/database"),LUIDGenerator=(id=1,function(){return id++}),sha1=function(str){var utf8Bytes=util.stringToByteArray(str),sha1=new util.Sha1;sha1.update(utf8Bytes);var sha1Bytes=sha1.digest();return util.base64.encodeByteArray(sha1Bytes)},buildLogMessage_=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];for(var message="",i=0;i<var_args.length;i++)Array.isArray(var_args[i])||var_args[i]&&"object"==typeof var_args[i]&&"number"==typeof var_args[i].length?message+=buildLogMessage_.apply(null,var_args[i]):"object"==typeof var_args[i]?message+=util.stringify(var_args[i]):message+=var_args[i],message+=" ";return message},logger=null,firstLog_=!0,enableLogging=function(logger_,persistent){util.assert(!persistent||!0===logger_||!1===logger_,"Can't turn on custom loggers persistently."),!0===logger_?(logClient.logLevel=logger$1.LogLevel.VERBOSE,logger=logClient.log.bind(logClient),persistent&&SessionStorage.set("logging_enabled",!0)):"function"==typeof logger_?logger=logger_:(logger=null,SessionStorage.remove("logging_enabled"))},log=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];if(!0===firstLog_&&(firstLog_=!1,null===logger&&!0===SessionStorage.get("logging_enabled")&&enableLogging(!0)),logger){var message=buildLogMessage_.apply(null,var_args);logger(message)}},logWrapper=function(prefix){return function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];log.apply(void 0,[prefix].concat(var_args))}},error=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];var message="FIREBASE INTERNAL ERROR: "+buildLogMessage_.apply(void 0,var_args);logClient.error(message)},fatal=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];var message="FIREBASE FATAL ERROR: "+buildLogMessage_.apply(void 0,var_args);throw logClient.error(message),new Error(message)},warn=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];var message="FIREBASE WARNING: "+buildLogMessage_.apply(void 0,var_args);logClient.warn(message)},isInvalidJSONNumber=function(data){return"number"==typeof data&&(data!=data||data==Number.POSITIVE_INFINITY||data==Number.NEGATIVE_INFINITY)},MIN_NAME="[MIN_NAME]",MAX_NAME="[MAX_NAME]",nameCompare=function(a,b){if(a===b)return 0;if(a===MIN_NAME||b===MAX_NAME)return-1;if(b===MIN_NAME||a===MAX_NAME)return 1;var aAsInt=tryParseInt(a),bAsInt=tryParseInt(b);return null!==aAsInt?null!==bAsInt?aAsInt-bAsInt==0?a.length-b.length:aAsInt-bAsInt:-1:null!==bAsInt?1:a<b?-1:1},stringCompare=function(a,b){return a===b?0:a<b?-1:1},requireKey=function(key,obj){if(obj&&key in obj)return obj[key];throw new Error("Missing required key ("+key+") in object: "+util.stringify(obj))},ObjectToUniqueKey=function(obj){if("object"!=typeof obj||null===obj)return util.stringify(obj);var keys=[];for(var k in obj)keys.push(k);keys.sort();for(var key="{",i=0;i<keys.length;i++)0!==i&&(key+=","),key+=util.stringify(keys[i]),key+=":",key+=ObjectToUniqueKey(obj[keys[i]]);return key+="}"},splitStringBySize=function(str,segsize){var len=str.length;if(len<=segsize)return[str];for(var dataSegs=[],c=0;c<len;c+=segsize)c+segsize>len?dataSegs.push(str.substring(c,len)):dataSegs.push(str.substring(c,c+segsize));return dataSegs},each=function(obj,fn){if(Array.isArray(obj))for(var i=0;i<obj.length;++i)fn(i,obj[i]);else util.forEach(obj,function(key,val){return fn(val,key)})},doubleToIEEE754String=function(v){util.assert(!isInvalidJSONNumber(v),"Invalid JSON number");var s,e,f,ln,i,bits,str;for(0===v?(e=0,f=0,s=1/v==-1/0?1:0):(s=v<0,(v=Math.abs(v))>=Math.pow(2,-1022)?(e=(ln=Math.min(Math.floor(Math.log(v)/Math.LN2),1023))+1023,f=Math.round(v*Math.pow(2,52-ln)-Math.pow(2,52))):(e=0,f=Math.round(v/Math.pow(2,-1074)))),bits=[],i=52;i;i-=1)bits.push(f%2?1:0),f=Math.floor(f/2);for(i=11;i;i-=1)bits.push(e%2?1:0),e=Math.floor(e/2);bits.push(s?1:0),bits.reverse(),str=bits.join("");var hexByteString="";for(i=0;i<64;i+=8){var hexByte=parseInt(str.substr(i,8),2).toString(16);1===hexByte.length&&(hexByte="0"+hexByte),hexByteString+=hexByte}return hexByteString.toLowerCase()},INTEGER_REGEXP_=new RegExp("^-?\\d{1,10}$"),tryParseInt=function(str){if(INTEGER_REGEXP_.test(str)){var intVal=Number(str);if(intVal>=-2147483648&&intVal<=2147483647)return intVal}return null},exceptionGuard=function(fn){try{fn()}catch(e){setTimeout(function(){var stack=e.stack||"";throw warn("Exception was thrown by user callback.",stack),e},Math.floor(0))}},beingCrawled=function(){return("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},setTimeoutNonBlocking=function(fn,time){var timeout=setTimeout(fn,time);return"object"==typeof timeout&&timeout.unref&&timeout.unref(),timeout},Path=function(){function Path(pathOrString,pieceNum){if(void 0===pieceNum){this.pieces_=pathOrString.split("/");for(var copyTo=0,i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[copyTo]=this.pieces_[i],copyTo++);this.pieces_.length=copyTo,this.pieceNum_=0}else this.pieces_=pathOrString,this.pieceNum_=pieceNum}return Object.defineProperty(Path,"Empty",{get:function(){return new Path("")},enumerable:!0,configurable:!0}),Path.prototype.getFront=function(){return this.pieceNum_>=this.pieces_.length?null:this.pieces_[this.pieceNum_]},Path.prototype.getLength=function(){return this.pieces_.length-this.pieceNum_},Path.prototype.popFront=function(){var pieceNum=this.pieceNum_;return pieceNum<this.pieces_.length&&pieceNum++,new Path(this.pieces_,pieceNum)},Path.prototype.getBack=function(){return this.pieceNum_<this.pieces_.length?this.pieces_[this.pieces_.length-1]:null},Path.prototype.toString=function(){for(var pathString="",i=this.pieceNum_;i<this.pieces_.length;i++)""!==this.pieces_[i]&&(pathString+="/"+this.pieces_[i]);return pathString||"/"},Path.prototype.toUrlEncodedString=function(){for(var pathString="",i=this.pieceNum_;i<this.pieces_.length;i++)""!==this.pieces_[i]&&(pathString+="/"+encodeURIComponent(String(this.pieces_[i])));return pathString||"/"},Path.prototype.slice=function(begin){return void 0===begin&&(begin=0),this.pieces_.slice(this.pieceNum_+begin)},Path.prototype.parent=function(){if(this.pieceNum_>=this.pieces_.length)return null;for(var pieces=[],i=this.pieceNum_;i<this.pieces_.length-1;i++)pieces.push(this.pieces_[i]);return new Path(pieces,0)},Path.prototype.child=function(childPathObj){for(var pieces=[],i=this.pieceNum_;i<this.pieces_.length;i++)pieces.push(this.pieces_[i]);if(childPathObj instanceof Path)for(i=childPathObj.pieceNum_;i<childPathObj.pieces_.length;i++)pieces.push(childPathObj.pieces_[i]);else{var childPieces=childPathObj.split("/");for(i=0;i<childPieces.length;i++)childPieces[i].length>0&&pieces.push(childPieces[i])}return new Path(pieces,0)},Path.prototype.isEmpty=function(){return this.pieceNum_>=this.pieces_.length},Path.relativePath=function(outerPath,innerPath){var outer=outerPath.getFront(),inner=innerPath.getFront();if(null===outer)return innerPath;if(outer===inner)return Path.relativePath(outerPath.popFront(),innerPath.popFront());throw new Error("INTERNAL ERROR: innerPath ("+innerPath+") is not within outerPath ("+outerPath+")")},Path.comparePaths=function(left,right){for(var leftKeys=left.slice(),rightKeys=right.slice(),i=0;i<leftKeys.length&&i<rightKeys.length;i++){var cmp=nameCompare(leftKeys[i],rightKeys[i]);if(0!==cmp)return cmp}return leftKeys.length===rightKeys.length?0:leftKeys.length<rightKeys.length?-1:1},Path.prototype.equals=function(other){if(this.getLength()!==other.getLength())return!1;for(var i=this.pieceNum_,j=other.pieceNum_;i<=this.pieces_.length;i++,j++)if(this.pieces_[i]!==other.pieces_[j])return!1;return!0},Path.prototype.contains=function(other){var i=this.pieceNum_,j=other.pieceNum_;if(this.getLength()>other.getLength())return!1;for(;i<this.pieces_.length;){if(this.pieces_[i]!==other.pieces_[j])return!1;++i,++j}return!0},Path}(),ValidationPath=function(){function ValidationPath(path,errorPrefix_){this.errorPrefix_=errorPrefix_,this.parts_=path.slice(),this.byteLength_=Math.max(1,this.parts_.length);for(var i=0;i<this.parts_.length;i++)this.byteLength_+=util.stringLength(this.parts_[i]);this.checkValid_()}return Object.defineProperty(ValidationPath,"MAX_PATH_DEPTH",{get:function(){return 32},enumerable:!0,configurable:!0}),Object.defineProperty(ValidationPath,"MAX_PATH_LENGTH_BYTES",{get:function(){return 768},enumerable:!0,configurable:!0}),ValidationPath.prototype.push=function(child){this.parts_.length>0&&(this.byteLength_+=1),this.parts_.push(child),this.byteLength_+=util.stringLength(child),this.checkValid_()},ValidationPath.prototype.pop=function(){var last=this.parts_.pop();this.byteLength_-=util.stringLength(last),this.parts_.length>0&&(this.byteLength_-=1)},ValidationPath.prototype.checkValid_=function(){if(this.byteLength_>ValidationPath.MAX_PATH_LENGTH_BYTES)throw new Error(this.errorPrefix_+"has a key path longer than "+ValidationPath.MAX_PATH_LENGTH_BYTES+" bytes ("+this.byteLength_+").");if(this.parts_.length>ValidationPath.MAX_PATH_DEPTH)throw new Error(this.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+ValidationPath.MAX_PATH_DEPTH+") or object contains a cycle "+this.toErrorString())},ValidationPath.prototype.toErrorString=function(){return 0==this.parts_.length?"":"in property '"+this.parts_.join(".")+"'"},ValidationPath}(),LONG_POLLING="long_polling",RepoInfo=function(){function RepoInfo(host,secure,namespace,webSocketOnly,persistenceKey){void 0===persistenceKey&&(persistenceKey=""),this.secure=secure,this.namespace=namespace,this.webSocketOnly=webSocketOnly,this.persistenceKey=persistenceKey,this.host=host.toLowerCase(),this.domain=this.host.substr(this.host.indexOf(".")+1),this.internalHost=PersistentStorage.get("host:"+host)||this.host}return RepoInfo.prototype.needsQueryParam=function(){return this.host!==this.internalHost||this.isCustomHost()},RepoInfo.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},RepoInfo.prototype.isDemoHost=function(){return"firebaseio-demo.com"===this.domain},RepoInfo.prototype.isCustomHost=function(){return"firebaseio.com"!==this.domain&&"firebaseio-demo.com"!==this.domain},RepoInfo.prototype.updateHost=function(newHost){newHost!==this.internalHost&&(this.internalHost=newHost,this.isCacheableHost()&&PersistentStorage.set("host:"+this.host,this.internalHost))},RepoInfo.prototype.connectionURL=function(type,params){var connURL;if(util.assert("string"==typeof type,"typeof type must == string"),util.assert("object"==typeof params,"typeof params must == object"),"websocket"===type)connURL=(this.secure?"wss://":"ws://")+this.internalHost+"/.ws?";else{if(type!==LONG_POLLING)throw new Error("Unknown connection type: "+type);connURL=(this.secure?"https://":"http://")+this.internalHost+"/.lp?"}this.needsQueryParam()&&(params.ns=this.namespace);var pairs=[];return util.forEach(params,function(key,value){pairs.push(key+"="+value)}),connURL+pairs.join("&")},RepoInfo.prototype.toString=function(){var str=this.toURLString();return this.persistenceKey&&(str+="<"+this.persistenceKey+">"),str},RepoInfo.prototype.toURLString=function(){return(this.secure?"https://":"http://")+this.host},RepoInfo}();var PUSH_CHARS,lastPushTime,lastRandChars,__EMPTY_NODE,MAX_NODE,parseRepoInfo=function(dataURL){var parsedUrl=parseURL(dataURL),namespace=parsedUrl.subdomain;"firebase"===parsedUrl.domain&&fatal(parsedUrl.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),namespace&&"undefined"!=namespace||"localhost"===parsedUrl.domain||fatal("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),parsedUrl.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&warn("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");var webSocketOnly="ws"===parsedUrl.scheme||"wss"===parsedUrl.scheme;return{repoInfo:new RepoInfo(parsedUrl.host,parsedUrl.secure,namespace,webSocketOnly),path:new Path(parsedUrl.pathString)}},parseURL=function(dataURL){var host="",domain="",subdomain="",pathString="",secure=!0,scheme="https",port=443;if("string"==typeof dataURL){var colonInd=dataURL.indexOf("//");colonInd>=0&&(scheme=dataURL.substring(0,colonInd-1),dataURL=dataURL.substring(colonInd+2));var slashInd=dataURL.indexOf("/");-1===slashInd&&(slashInd=dataURL.length);var questionMarkInd=dataURL.indexOf("?");-1===questionMarkInd&&(questionMarkInd=dataURL.length),host=dataURL.substring(0,Math.min(slashInd,questionMarkInd)),slashInd<questionMarkInd&&(pathString=
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function(pathString){for(var pathStringDecoded="",pieces=pathString.split("/"),i=0;i<pieces.length;i++)if(pieces[i].length>0){var piece=pieces[i];try{piece=decodeURIComponent(piece.replace(/\+/g," "))}catch(e){}pathStringDecoded+="/"+piece}return pathStringDecoded}(dataURL.substring(slashInd,questionMarkInd)));var queryParams=function(queryString){var results={};"?"===queryString.charAt(0)&&(queryString=queryString.substring(1));for(var _i=0,_a=queryString.split("&");_i<_a.length;_i++){var segment=_a[_i];if(0!==segment.length){var kv=segment.split("=");2===kv.length?results[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1]):warn("Invalid query segment '"+segment+"' in query '"+queryString+"'")}}return results}(dataURL.substring(Math.min(dataURL.length,questionMarkInd)));(colonInd=host.indexOf(":"))>=0?(secure="https"===scheme||"wss"===scheme,port=parseInt(host.substring(colonInd+1),10)):colonInd=dataURL.length;var parts=host.split(".");3===parts.length?(domain=parts[1],subdomain=parts[0].toLowerCase()):2===parts.length?domain=parts[0]:"localhost"===parts[0].slice(0,colonInd).toLowerCase()&&(domain="localhost"),""===subdomain&&"ns"in queryParams&&(subdomain=queryParams.ns)}return{host:host,port:port,domain:domain,subdomain:subdomain,secure:secure,scheme:scheme,pathString:pathString}},INVALID_KEY_REGEX_=/[\[\].#$\/\u0000-\u001F\u007F]/,INVALID_PATH_REGEX_=/[\[\].#$\u0000-\u001F\u007F]/,isValidKey=function(key){return"string"==typeof key&&0!==key.length&&!INVALID_KEY_REGEX_.test(key)},isValidPathString=function(pathString){return"string"==typeof pathString&&0!==pathString.length&&!INVALID_PATH_REGEX_.test(pathString)},isValidPriority=function(priority){return null===priority||"string"==typeof priority||"number"==typeof priority&&!isInvalidJSONNumber(priority)||priority&&"object"==typeof priority&&util.contains(priority,".sv")},validateFirebaseDataArg=function(fnName,argumentNumber,data,path,optional){optional&&void 0===data||validateFirebaseData(util.errorPrefix(fnName,argumentNumber,optional),data,path)},validateFirebaseData=function(errorPrefix,data,path_){var path=path_ instanceof Path?new ValidationPath(path_,errorPrefix):path_;if(void 0===data)throw new Error(errorPrefix+"contains undefined "+path.toErrorString());if("function"==typeof data)throw new Error(errorPrefix+"contains a function "+path.toErrorString()+" with contents = "+data.toString());if(isInvalidJSONNumber(data))throw new Error(errorPrefix+"contains "+data.toString()+" "+path.toErrorString());if("string"==typeof data&&data.length>10485760/3&&util.stringLength(data)>10485760)throw new Error(errorPrefix+"contains a string greater than 10485760 utf8 bytes "+path.toErrorString()+" ('"+data.substring(0,50)+"...')");if(data&&"object"==typeof data){var hasDotValue_1=!1,hasActualChild_1=!1;if(util.forEach(data,function(key,value){if(".value"===key)hasDotValue_1=!0;else if(".priority"!==key&&".sv"!==key&&(hasActualChild_1=!0,!isValidKey(key)))throw new Error(errorPrefix+" contains an invalid key ("+key+") "+path.toErrorString()+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');path.push(key),validateFirebaseData(errorPrefix,value,path),path.pop()}),hasDotValue_1&&hasActualChild_1)throw new Error(errorPrefix+' contains ".value" child '+path.toErrorString()+" in addition to actual children.")}},validateFirebaseMergeDataArg=function(fnName,argumentNumber,data,path,optional){if(!optional||void 0!==data){var errorPrefix=util.errorPrefix(fnName,argumentNumber,optional);if(!data||"object"!=typeof data||Array.isArray(data))throw new Error(errorPrefix+" must be an object containing the children to replace.");var mergePaths=[];util.forEach(data,function(key,value){var curPath=new Path(key);if(validateFirebaseData(errorPrefix,value,path.child(curPath)),".priority"===curPath.getBack()&&!isValidPriority(value))throw new Error(errorPrefix+"contains an invalid value for '"+curPath.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");mergePaths.push(curPath)}),function(errorPrefix,mergePaths){var i,curPath;for(i=0;i<mergePaths.length;i++)for(var keys=(curPath=mergePaths[i]).slice(),j=0;j<keys.length;j++)if(".priority"===keys[j]&&j===keys.length-1);else if(!isValidKey(keys[j]))throw new Error(errorPrefix+"contains an invalid key ("+keys[j]+") in path "+curPath.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');mergePaths.sort(Path.comparePaths);var prevPath=null;for(i=0;i<mergePaths.length;i++){if(curPath=mergePaths[i],null!==prevPath&&prevPath.contains(curPath))throw new Error(errorPrefix+"contains a path "+prevPath.toString()+" that is ancestor of another path "+curPath.toString());prevPath=curPath}}(errorPrefix,mergePaths)}},validatePriority=function(fnName,argumentNumber,priority,optional){if(!optional||void 0!==priority){if(isInvalidJSONNumber(priority))throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+"is "+priority.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!isValidPriority(priority))throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},validateEventType=function(fnName,argumentNumber,eventType,optional){if(!optional||void 0!==eventType)switch(eventType){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},validateKey=function(fnName,argumentNumber,key,optional){if(!(optional&&void 0===key||isValidKey(key)))throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+'was an invalid key = "'+key+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},validatePathString=function(fnName,argumentNumber,pathString,optional){if(!(optional&&void 0===pathString||isValidPathString(pathString)))throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+'was an invalid path = "'+pathString+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},validateWritablePath=function(fnName,path){if(".info"===path.getFront())throw new Error(fnName+" failed = Can't modify data under /.info/")},validateUrl=function(fnName,argumentNumber,parsedUrl){var pathString=parsedUrl.path.toString();if("string"!=typeof parsedUrl.repoInfo.host||0===parsedUrl.repoInfo.host.length||!isValidKey(parsedUrl.repoInfo.namespace)&&"localhost"!==parsedUrl.repoInfo.host.split(":")[0]||0!==pathString.length&&!function(pathString){return pathString&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/")),isValidPathString(pathString)}(pathString))throw new Error(util.errorPrefix(fnName,argumentNumber,!1)+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')},OnDisconnect=function(){function OnDisconnect(repo_,path_){this.repo_=repo_,this.path_=path_}return OnDisconnect.prototype.cancel=function(onComplete){util.validateArgCount("OnDisconnect.cancel",0,1,arguments.length),util.validateCallback("OnDisconnect.cancel",1,onComplete,!0);var deferred=new util.Deferred;return this.repo_.onDisconnectCancel(this.path_,deferred.wrapCallback(onComplete)),deferred.promise},OnDisconnect.prototype.remove=function(onComplete){util.validateArgCount("OnDisconnect.remove",0,1,arguments.length),validateWritablePath("OnDisconnect.remove",this.path_),util.validateCallback("OnDisconnect.remove",1,onComplete,!0);var deferred=new util.Deferred;return this.repo_.onDisconnectSet(this.path_,null,deferred.wrapCallback(onComplete)),deferred.promise},OnDisconnect.prototype.set=function(value,onComplete){util.validateArgCount("OnDisconnect.set",1,2,arguments.length),validateWritablePath("OnDisconnect.set",this.path_),validateFirebaseDataArg("OnDisconnect.set",1,value,this.path_,!1),util.validateCallback("OnDisconnect.set",2,onComplete,!0);var deferred=new util.Deferred;return this.repo_.onDisconnectSet(this.path_,value,deferred.wrapCallback(onComplete)),deferred.promise},OnDisconnect.prototype.setWithPriority=function(value,priority,onComplete){util.validateArgCount("OnDisconnect.setWithPriority",2,3,arguments.length),validateWritablePath("OnDisconnect.setWithPriority",this.path_),validateFirebaseDataArg("OnDisconnect.setWithPriority",1,value,this.path_,!1),validatePriority("OnDisconnect.setWithPriority",2,priority,!1),util.validateCallback("OnDisconnect.setWithPriority",3,onComplete,!0);var deferred=new util.Deferred;return this.repo_.onDisconnectSetWithPriority(this.path_,value,priority,deferred.wrapCallback(onComplete)),deferred.promise},OnDisconnect.prototype.update=function(objectToMerge,onComplete){if(util.validateArgCount("OnDisconnect.update",1,2,arguments.length),validateWritablePath("OnDisconnect.update",this.path_),Array.isArray(objectToMerge)){for(var newObjectToMerge={},i=0;i<objectToMerge.length;++i)newObjectToMerge[""+i]=objectToMerge[i];objectToMerge=newObjectToMerge,warn("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}validateFirebaseMergeDataArg("OnDisconnect.update",1,objectToMerge,this.path_,!1),util.validateCallback("OnDisconnect.update",2,onComplete,!0);var deferred=new util.Deferred;return this.repo_.onDisconnectUpdate(this.path_,objectToMerge,deferred.wrapCallback(onComplete)),deferred.promise},OnDisconnect}(),TransactionResult=function(){function TransactionResult(committed,snapshot){this.committed=committed,this.snapshot=snapshot}return TransactionResult.prototype.toJSON=function(){return util.validateArgCount("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},TransactionResult}(),nextPushId=(PUSH_CHARS="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",lastPushTime=0,lastRandChars=[],function(now){var i,duplicateTime=now===lastPushTime;lastPushTime=now;var timeStampChars=new Array(8);for(i=7;i>=0;i--)timeStampChars[i]=PUSH_CHARS.charAt(now%64),now=Math.floor(now/64);util.assert(0===now,"Cannot push at time == 0");var id=timeStampChars.join("");if(duplicateTime){for(i=11;i>=0&&63===lastRandChars[i];i--)lastRandChars[i]=0;lastRandChars[i]++}else for(i=0;i<12;i++)lastRandChars[i]=Math.floor(64*Math.random());for(i=0;i<12;i++)id+=PUSH_CHARS.charAt(lastRandChars[i]);return util.assert(20===id.length,"nextPushId: Length should be 20."),id}),NamedNode=function(){function NamedNode(name,node){this.name=name,this.node=node}return NamedNode.Wrap=function(name,node){return new NamedNode(name,node)},NamedNode}(),Index=function(){function Index(){}return Index.prototype.getCompare=function(){return this.compare.bind(this)},Index.prototype.indexedValueChanged=function(oldNode,newNode){var oldWrapped=new NamedNode(MIN_NAME,oldNode),newWrapped=new NamedNode(MIN_NAME,newNode);return 0!==this.compare(oldWrapped,newWrapped)},Index.prototype.minPost=function(){return NamedNode.MIN},Index}(),KeyIndex=function(_super){function KeyIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(KeyIndex,_super),Object.defineProperty(KeyIndex,"__EMPTY_NODE",{get:function(){return __EMPTY_NODE},set:function(val){__EMPTY_NODE=val},enumerable:!0,configurable:!0}),KeyIndex.prototype.compare=function(a,b){return nameCompare(a.name,b.name)},KeyIndex.prototype.isDefinedOn=function(node){throw util.assertionError("KeyIndex.isDefinedOn not expected to be called.")},KeyIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!1},KeyIndex.prototype.minPost=function(){return NamedNode.MIN},KeyIndex.prototype.maxPost=function(){return new NamedNode(MAX_NAME,__EMPTY_NODE)},KeyIndex.prototype.makePost=function(indexValue,name){return util.assert("string"==typeof indexValue,"KeyIndex indexValue must always be a string."),new NamedNode(indexValue,__EMPTY_NODE)},KeyIndex.prototype.toString=function(){return".key"},KeyIndex}(Index),KEY_INDEX=new KeyIndex;var __childrenNodeConstructor,nodeFromJSON,MAX_NODE$1,priorityHashText=function(priority){return"number"==typeof priority?"number:"+doubleToIEEE754String(priority):"string:"+priority},validatePriorityNode=function(priorityNode){if(priorityNode.isLeafNode()){var val=priorityNode.val();util.assert("string"==typeof val||"number"==typeof val||"object"==typeof val&&util.contains(val,".sv"),"Priority must be a string or number.")}else util.assert(priorityNode===MAX_NODE||priorityNode.isEmpty(),"priority of unexpected type.");util.assert(priorityNode===MAX_NODE||priorityNode.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},LeafNode=function(){function LeafNode(value_,priorityNode_){void 0===priorityNode_&&(priorityNode_=LeafNode.__childrenNodeConstructor.EMPTY_NODE),this.value_=value_,this.priorityNode_=priorityNode_,this.lazyHash_=null,util.assert(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),validatePriorityNode(this.priorityNode_)}return Object.defineProperty(LeafNode,"__childrenNodeConstructor",{get:function(){return __childrenNodeConstructor},set:function(val){__childrenNodeConstructor=val},enumerable:!0,configurable:!0}),LeafNode.prototype.isLeafNode=function(){return!0},LeafNode.prototype.getPriority=function(){return this.priorityNode_},LeafNode.prototype.updatePriority=function(newPriorityNode){return new LeafNode(this.value_,newPriorityNode)},LeafNode.prototype.getImmediateChild=function(childName){return".priority"===childName?this.priorityNode_:LeafNode.__childrenNodeConstructor.EMPTY_NODE},LeafNode.prototype.getChild=function(path){return path.isEmpty()?this:".priority"===path.getFront()?this.priorityNode_:LeafNode.__childrenNodeConstructor.EMPTY_NODE},LeafNode.prototype.hasChild=function(){return!1},LeafNode.prototype.getPredecessorChildName=function(childName,childNode){return null},LeafNode.prototype.updateImmediateChild=function(childName,newChildNode){return".priority"===childName?this.updatePriority(newChildNode):newChildNode.isEmpty()&&".priority"!==childName?this:LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(childName,newChildNode).updatePriority(this.priorityNode_)},LeafNode.prototype.updateChild=function(path,newChildNode){var front=path.getFront();return null===front?newChildNode:newChildNode.isEmpty()&&".priority"!==front?this:(util.assert(".priority"!==front||1===path.getLength(),".priority must be the last token in a path"),this.updateImmediateChild(front,LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateChild(path.popFront(),newChildNode)))},LeafNode.prototype.isEmpty=function(){return!1},LeafNode.prototype.numChildren=function(){return 0},LeafNode.prototype.forEachChild=function(index,action){return!1},LeafNode.prototype.val=function(exportFormat){return exportFormat&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},LeafNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash="";this.priorityNode_.isEmpty()||(toHash+="priority:"+priorityHashText(this.priorityNode_.val())+":");var type=typeof this.value_;toHash+=type+":",toHash+="number"===type?doubleToIEEE754String(this.value_):this.value_,this.lazyHash_=sha1(toHash)}return this.lazyHash_},LeafNode.prototype.getValue=function(){return this.value_},LeafNode.prototype.compareTo=function(other){return other===LeafNode.__childrenNodeConstructor.EMPTY_NODE?1:other instanceof LeafNode.__childrenNodeConstructor?-1:(util.assert(other.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(other))},LeafNode.prototype.compareToLeafNode_=function(otherLeaf){var otherLeafType=typeof otherLeaf.value_,thisLeafType=typeof this.value_,otherIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(otherLeafType),thisIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(thisLeafType);return util.assert(otherIndex>=0,"Unknown leaf type: "+otherLeafType),util.assert(thisIndex>=0,"Unknown leaf type: "+thisLeafType),otherIndex===thisIndex?"object"===thisLeafType?0:this.value_<otherLeaf.value_?-1:this.value_===otherLeaf.value_?0:1:thisIndex-otherIndex},LeafNode.prototype.withIndex=function(){return this},LeafNode.prototype.isIndexed=function(){return!0},LeafNode.prototype.equals=function(other){if(other===this)return!0;if(other.isLeafNode()){var otherLeaf=other;return this.value_===otherLeaf.value_&&this.priorityNode_.equals(otherLeaf.priorityNode_)}return!1},LeafNode.VALUE_TYPE_ORDER=["object","boolean","number","string"],LeafNode}();var _defaultIndexMap,EMPTY_NODE,PRIORITY_INDEX=new(function(_super){function PriorityIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PriorityIndex,_super),PriorityIndex.prototype.compare=function(a,b){var aPriority=a.node.getPriority(),bPriority=b.node.getPriority(),indexCmp=aPriority.compareTo(bPriority);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},PriorityIndex.prototype.isDefinedOn=function(node){return!node.getPriority().isEmpty()},PriorityIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.getPriority().equals(newNode.getPriority())},PriorityIndex.prototype.minPost=function(){return NamedNode.MIN},PriorityIndex.prototype.maxPost=function(){return new NamedNode(MAX_NAME,new LeafNode("[PRIORITY-POST]",MAX_NODE$1))},PriorityIndex.prototype.makePost=function(indexValue,name){var priorityNode=nodeFromJSON(indexValue);return new NamedNode(name,new LeafNode("[PRIORITY-POST]",priorityNode))},PriorityIndex.prototype.toString=function(){return".priority"},PriorityIndex}(Index)),SortedMapIterator=function(){function SortedMapIterator(node,startKey,comparator,isReverse_,resultGenerator_){void 0===resultGenerator_&&(resultGenerator_=null),this.isReverse_=isReverse_,this.resultGenerator_=resultGenerator_,this.nodeStack_=[];for(var cmp=1;!node.isEmpty();)if(node=node,cmp=startKey?comparator(node.key,startKey):1,isReverse_&&(cmp*=-1),cmp<0)node=this.isReverse_?node.left:node.right;else{if(0===cmp){this.nodeStack_.push(node);break}this.nodeStack_.push(node),node=this.isReverse_?node.right:node.left}}return SortedMapIterator.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var result,node=this.nodeStack_.pop();if(result=this.resultGenerator_?this.resultGenerator_(node.key,node.value):{key:node.key,value:node.value},this.isReverse_)for(node=node.left;!node.isEmpty();)this.nodeStack_.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack_.push(node),node=node.left;return result},SortedMapIterator.prototype.hasNext=function(){return this.nodeStack_.length>0},SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var node=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(node.key,node.value):{key:node.key,value:node.value}},SortedMapIterator}(),LLRBNode=function(){function LLRBNode(key,value,color,left,right){this.key=key,this.value=value,this.color=null!=color?color:LLRBNode.RED,this.left=null!=left?left:SortedMap.EMPTY_NODE,this.right=null!=right?right:SortedMap.EMPTY_NODE}return LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=right?right:this.right)},LLRBNode.prototype.count=function(){return this.left.count()+1+this.right.count()},LLRBNode.prototype.isEmpty=function(){return!1},LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||action(this.key,this.value)||this.right.inorderTraversal(action)},LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)},LLRBNode.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},LLRBNode.prototype.minKey=function(){return this.min_().key},LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},LLRBNode.prototype.insert=function(key,value,comparator){var cmp,n;return(n=(cmp=comparator(key,(n=this).key))<0?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator))).fixUp_()},LLRBNode.prototype.removeMin_=function(){if(this.left.isEmpty())return SortedMap.EMPTY_NODE;var n=this;return n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),(n=n.copy(null,null,null,n.left.removeMin_(),null)).fixUp_()},LLRBNode.prototype.remove=function(key,comparator){var n,smallest;if(comparator(key,(n=this).key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===comparator(key,n.key)){if(n.right.isEmpty())return SortedMap.EMPTY_NODE;smallest=n.right.min_(),n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp_()},LLRBNode.prototype.isRed_=function(){return this.color},LLRBNode.prototype.fixUp_=function(){var n=this;return n.right.isRed_()&&!n.left.isRed_()&&(n=n.rotateLeft_()),n.left.isRed_()&&n.left.left.isRed_()&&(n=n.rotateRight_()),n.left.isRed_()&&n.right.isRed_()&&(n=n.colorFlip_()),n},LLRBNode.prototype.moveRedLeft_=function(){var n=this.colorFlip_();return n.right.left.isRed_()&&(n=(n=(n=n.copy(null,null,null,null,n.right.rotateRight_())).rotateLeft_()).colorFlip_()),n},LLRBNode.prototype.moveRedRight_=function(){var n=this.colorFlip_();return n.left.left.isRed_()&&(n=(n=n.rotateRight_()).colorFlip_()),n},LLRBNode.prototype.rotateLeft_=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)},LLRBNode.prototype.rotateRight_=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)},LLRBNode.prototype.colorFlip_=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)},LLRBNode.prototype.checkMaxDepth_=function(){var blackDepth=this.check_();return Math.pow(2,blackDepth)<=this.count()+1},LLRBNode.prototype.check_=function(){var blackDepth;if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");if((blackDepth=this.left.check_())!==this.right.check_())throw new Error("Black depths differ");return blackDepth+(this.isRed_()?0:1)},LLRBNode.RED=!0,LLRBNode.BLACK=!1,LLRBNode}(),LLRBEmptyNode=function(){function LLRBEmptyNode(){}return LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this},LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode(key,value,null)},LLRBEmptyNode.prototype.remove=function(key,comparator){return this},LLRBEmptyNode.prototype.count=function(){return 0},LLRBEmptyNode.prototype.isEmpty=function(){return!0},LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1},LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1},LLRBEmptyNode.prototype.minKey=function(){return null},LLRBEmptyNode.prototype.maxKey=function(){return null},LLRBEmptyNode.prototype.check_=function(){return 0},LLRBEmptyNode.prototype.isRed_=function(){return!1},LLRBEmptyNode}(),SortedMap=function(){function SortedMap(comparator_,root_){void 0===root_&&(root_=SortedMap.EMPTY_NODE),this.comparator_=comparator_,this.root_=root_}return SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator_,this.root_.insert(key,value,this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator_,this.root_.remove(key,this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.get=function(key){for(var cmp,node=this.root_;!node.isEmpty();){if(0===(cmp=this.comparator_(key,node.key)))return node.value;cmp<0?node=node.left:cmp>0&&(node=node.right)}return null},SortedMap.prototype.getPredecessorKey=function(key){for(var cmp,node=this.root_,rightParent=null;!node.isEmpty();){if(0===(cmp=this.comparator_(key,node.key))){if(node.left.isEmpty())return rightParent?rightParent.key:null;for(node=node.left;!node.right.isEmpty();)node=node.right;return node.key}cmp<0?node=node.left:cmp>0&&(rightParent=node,node=node.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},SortedMap.prototype.isEmpty=function(){return this.root_.isEmpty()},SortedMap.prototype.count=function(){return this.root_.count()},SortedMap.prototype.minKey=function(){return this.root_.minKey()},SortedMap.prototype.maxKey=function(){return this.root_.maxKey()},SortedMap.prototype.inorderTraversal=function(action){return this.root_.inorderTraversal(action)},SortedMap.prototype.reverseTraversal=function(action){return this.root_.reverseTraversal(action)},SortedMap.prototype.getIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!1,resultGenerator)},SortedMap.prototype.getIteratorFrom=function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!1,resultGenerator)},SortedMap.prototype.getReverseIteratorFrom=function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!0,resultGenerator)},SortedMap.prototype.getReverseIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!0,resultGenerator)},SortedMap.EMPTY_NODE=new LLRBEmptyNode,SortedMap}(),LOG_2=Math.log(2),Base12Num=function(){function Base12Num(length){var num;this.count=(num=length+1,parseInt(Math.log(num)/LOG_2,10)),this.current_=this.count-1;var bits,mask=(bits=this.count,parseInt(Array(bits+1).join("1"),2));this.bits_=length+1&mask}return Base12Num.prototype.nextBitIsOne=function(){var result=!(this.bits_&1<<this.current_);return this.current_--,result},Base12Num}(),buildChildSet=function(childList,cmp,keyFn,mapSortFn){childList.sort(cmp);var buildBalancedTree=function(low,high){var namedNode,key,length=high-low;if(0==length)return null;if(1==length)return namedNode=childList[low],key=keyFn?keyFn(namedNode):namedNode,new LLRBNode(key,namedNode.node,LLRBNode.BLACK,null,null);var middle=parseInt(length/2,10)+low,left=buildBalancedTree(low,middle),right=buildBalancedTree(middle+1,high);return namedNode=childList[middle],key=keyFn?keyFn(namedNode):namedNode,new LLRBNode(key,namedNode.node,LLRBNode.BLACK,left,right)},root=function(base12){for(var node=null,root=null,index=childList.length,buildPennant=function(chunkSize,color){var low=index-chunkSize,high=index;index-=chunkSize;var childTree=buildBalancedTree(low+1,high),namedNode=childList[low],key=keyFn?keyFn(namedNode):namedNode;attachPennant(new LLRBNode(key,namedNode.node,color,null,childTree))},attachPennant=function(pennant){node?(node.left=pennant,node=pennant):(root=pennant,node=pennant)},i=0;i<base12.count;++i){var isOne=base12.nextBitIsOne(),chunkSize=Math.pow(2,base12.count-(i+1));isOne?buildPennant(chunkSize,LLRBNode.BLACK):(buildPennant(chunkSize,LLRBNode.BLACK),buildPennant(chunkSize,LLRBNode.RED))}return root}(new Base12Num(childList.length));return new SortedMap(mapSortFn||cmp,root)},fallbackObject={},IndexMap=function(){function IndexMap(indexes_,indexSet_){this.indexes_=indexes_,this.indexSet_=indexSet_}return Object.defineProperty(IndexMap,"Default",{get:function(){return util.assert(fallbackObject&&PRIORITY_INDEX,"ChildrenNode.ts has not been loaded"),_defaultIndexMap=_defaultIndexMap||new IndexMap({".priority":fallbackObject},{".priority":PRIORITY_INDEX})},enumerable:!0,configurable:!0}),IndexMap.prototype.get=function(indexKey){var sortedMap=util.safeGet(this.indexes_,indexKey);if(!sortedMap)throw new Error("No index defined for "+indexKey);return sortedMap===fallbackObject?null:sortedMap},IndexMap.prototype.hasIndex=function(indexDefinition){return util.contains(this.indexSet_,indexDefinition.toString())},IndexMap.prototype.addIndex=function(indexDefinition,existingChildren){util.assert(indexDefinition!==KEY_INDEX,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var newIndex,childList=[],sawIndexedValue=!1,iter=existingChildren.getIterator(NamedNode.Wrap),next=iter.getNext();next;)sawIndexedValue=sawIndexedValue||indexDefinition.isDefinedOn(next.node),childList.push(next),next=iter.getNext();newIndex=sawIndexedValue?buildChildSet(childList,indexDefinition.getCompare()):fallbackObject;var indexName=indexDefinition.toString(),newIndexSet=util.clone(this.indexSet_);newIndexSet[indexName]=indexDefinition;var newIndexes=util.clone(this.indexes_);return newIndexes[indexName]=newIndex,new IndexMap(newIndexes,newIndexSet)},IndexMap.prototype.addToIndexes=function(namedNode,existingChildren){var _this=this;return new IndexMap(util.map(this.indexes_,function(indexedChildren,indexName){var index=util.safeGet(_this.indexSet_,indexName);if(util.assert(index,"Missing index implementation for "+indexName),indexedChildren===fallbackObject){if(index.isDefinedOn(namedNode.node)){for(var childList=[],iter=existingChildren.getIterator(NamedNode.Wrap),next=iter.getNext();next;)next.name!=namedNode.name&&childList.push(next),next=iter.getNext();return childList.push(namedNode),buildChildSet(childList,index.getCompare())}return fallbackObject}var existingSnap=existingChildren.get(namedNode.name),newChildren=indexedChildren;return existingSnap&&(newChildren=newChildren.remove(new NamedNode(namedNode.name,existingSnap))),newChildren.insert(namedNode,namedNode.node)}),this.indexSet_)},IndexMap.prototype.removeFromIndexes=function(namedNode,existingChildren){return new IndexMap(util.map(this.indexes_,function(indexedChildren){if(indexedChildren===fallbackObject)return indexedChildren;var existingSnap=existingChildren.get(namedNode.name);return existingSnap?indexedChildren.remove(new NamedNode(namedNode.name,existingSnap)):indexedChildren}),this.indexSet_)},IndexMap}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function NAME_ONLY_COMPARATOR(left,right){return nameCompare(left.name,right.name)}function NAME_COMPARATOR(left,right){return nameCompare(left,right)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ChildrenNode=function(){function ChildrenNode(children_,priorityNode_,indexMap_){this.children_=children_,this.priorityNode_=priorityNode_,this.indexMap_=indexMap_,this.lazyHash_=null,this.priorityNode_&&validatePriorityNode(this.priorityNode_),this.children_.isEmpty()&&util.assert(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}return Object.defineProperty(ChildrenNode,"EMPTY_NODE",{get:function(){return EMPTY_NODE||(EMPTY_NODE=new ChildrenNode(new SortedMap(NAME_COMPARATOR),null,IndexMap.Default))},enumerable:!0,configurable:!0}),ChildrenNode.prototype.isLeafNode=function(){return!1},ChildrenNode.prototype.getPriority=function(){return this.priorityNode_||EMPTY_NODE},ChildrenNode.prototype.updatePriority=function(newPriorityNode){return this.children_.isEmpty()?this:new ChildrenNode(this.children_,newPriorityNode,this.indexMap_)},ChildrenNode.prototype.getImmediateChild=function(childName){if(".priority"===childName)return this.getPriority();var child=this.children_.get(childName);return null===child?EMPTY_NODE:child},ChildrenNode.prototype.getChild=function(path){var front=path.getFront();return null===front?this:this.getImmediateChild(front).getChild(path.popFront())},ChildrenNode.prototype.hasChild=function(childName){return null!==this.children_.get(childName)},ChildrenNode.prototype.updateImmediateChild=function(childName,newChildNode){if(util.assert(newChildNode,"We should always be passing snapshot nodes"),".priority"===childName)return this.updatePriority(newChildNode);var newPriority,namedNode=new NamedNode(childName,newChildNode),newChildren=void 0,newIndexMap=void 0;return newChildNode.isEmpty()?(newChildren=this.children_.remove(childName),newIndexMap=this.indexMap_.removeFromIndexes(namedNode,this.children_)):(newChildren=this.children_.insert(childName,newChildNode),newIndexMap=this.indexMap_.addToIndexes(namedNode,this.children_)),newPriority=newChildren.isEmpty()?EMPTY_NODE:this.priorityNode_,new ChildrenNode(newChildren,newPriority,newIndexMap)},ChildrenNode.prototype.updateChild=function(path,newChildNode){var front=path.getFront();if(null===front)return newChildNode;util.assert(".priority"!==path.getFront()||1===path.getLength(),".priority must be the last token in a path");var newImmediateChild=this.getImmediateChild(front).updateChild(path.popFront(),newChildNode);return this.updateImmediateChild(front,newImmediateChild)},ChildrenNode.prototype.isEmpty=function(){return this.children_.isEmpty()},ChildrenNode.prototype.numChildren=function(){return this.children_.count()},ChildrenNode.prototype.val=function(exportFormat){if(this.isEmpty())return null;var obj={},numKeys=0,maxKey=0,allIntegerKeys=!0;if(this.forEachChild(PRIORITY_INDEX,function(key,childNode){obj[key]=childNode.val(exportFormat),numKeys++,allIntegerKeys&&ChildrenNode.INTEGER_REGEXP_.test(key)?maxKey=Math.max(maxKey,Number(key)):allIntegerKeys=!1}),!exportFormat&&allIntegerKeys&&maxKey<2*numKeys){var array=[];for(var key in obj)array[key]=obj[key];return array}return exportFormat&&!this.getPriority().isEmpty()&&(obj[".priority"]=this.getPriority().val()),obj},ChildrenNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash_1="";this.getPriority().isEmpty()||(toHash_1+="priority:"+priorityHashText(this.getPriority().val())+":"),this.forEachChild(PRIORITY_INDEX,function(key,childNode){var childHash=childNode.hash();""!==childHash&&(toHash_1+=":"+key+":"+childHash)}),this.lazyHash_=""===toHash_1?"":sha1(toHash_1)}return this.lazyHash_},ChildrenNode.prototype.getPredecessorChildName=function(childName,childNode,index){var idx=this.resolveIndex_(index);if(idx){var predecessor=idx.getPredecessorKey(new NamedNode(childName,childNode));return predecessor?predecessor.name:null}return this.children_.getPredecessorKey(childName)},ChildrenNode.prototype.getFirstChildName=function(indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx){var minKey=idx.minKey();return minKey&&minKey.name}return this.children_.minKey()},ChildrenNode.prototype.getFirstChild=function(indexDefinition){var minKey=this.getFirstChildName(indexDefinition);return minKey?new NamedNode(minKey,this.children_.get(minKey)):null},ChildrenNode.prototype.getLastChildName=function(indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx){var maxKey=idx.maxKey();return maxKey&&maxKey.name}return this.children_.maxKey()},ChildrenNode.prototype.getLastChild=function(indexDefinition){var maxKey=this.getLastChildName(indexDefinition);return maxKey?new NamedNode(maxKey,this.children_.get(maxKey)):null},ChildrenNode.prototype.forEachChild=function(index,action){var idx=this.resolveIndex_(index);return idx?idx.inorderTraversal(function(wrappedNode){return action(wrappedNode.name,wrappedNode.node)}):this.children_.inorderTraversal(action)},ChildrenNode.prototype.getIterator=function(indexDefinition){return this.getIteratorFrom(indexDefinition.minPost(),indexDefinition)},ChildrenNode.prototype.getIteratorFrom=function(startPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getIteratorFrom(startPost,function(key){return key});for(var iterator=this.children_.getIteratorFrom(startPost.name,NamedNode.Wrap),next=iterator.peek();null!=next&&indexDefinition.compare(next,startPost)<0;)iterator.getNext(),next=iterator.peek();return iterator},ChildrenNode.prototype.getReverseIterator=function(indexDefinition){return this.getReverseIteratorFrom(indexDefinition.maxPost(),indexDefinition)},ChildrenNode.prototype.getReverseIteratorFrom=function(endPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getReverseIteratorFrom(endPost,function(key){return key});for(var iterator=this.children_.getReverseIteratorFrom(endPost.name,NamedNode.Wrap),next=iterator.peek();null!=next&&indexDefinition.compare(next,endPost)>0;)iterator.getNext(),next=iterator.peek();return iterator},ChildrenNode.prototype.compareTo=function(other){return this.isEmpty()?other.isEmpty()?0:-1:other.isLeafNode()||other.isEmpty()?1:other===MAX_NODE$2?-1:0},ChildrenNode.prototype.withIndex=function(indexDefinition){if(indexDefinition===KEY_INDEX||this.indexMap_.hasIndex(indexDefinition))return this;var newIndexMap=this.indexMap_.addIndex(indexDefinition,this.children_);return new ChildrenNode(this.children_,this.priorityNode_,newIndexMap)},ChildrenNode.prototype.isIndexed=function(index){return index===KEY_INDEX||this.indexMap_.hasIndex(index)},ChildrenNode.prototype.equals=function(other){if(other===this)return!0;if(other.isLeafNode())return!1;var otherChildrenNode=other;if(this.getPriority().equals(otherChildrenNode.getPriority())){if(this.children_.count()===otherChildrenNode.children_.count()){for(var thisIter=this.getIterator(PRIORITY_INDEX),otherIter=otherChildrenNode.getIterator(PRIORITY_INDEX),thisCurrent=thisIter.getNext(),otherCurrent=otherIter.getNext();thisCurrent&&otherCurrent;){if(thisCurrent.name!==otherCurrent.name||!thisCurrent.node.equals(otherCurrent.node))return!1;thisCurrent=thisIter.getNext(),otherCurrent=otherIter.getNext()}return null===thisCurrent&&null===otherCurrent}return!1}return!1},ChildrenNode.prototype.resolveIndex_=function(indexDefinition){return indexDefinition===KEY_INDEX?null:this.indexMap_.get(indexDefinition.toString())},ChildrenNode.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,ChildrenNode}(),MAX_NODE$2=new(function(_super){function MaxNode(){return _super.call(this,new SortedMap(NAME_COMPARATOR),ChildrenNode.EMPTY_NODE,IndexMap.Default)||this}return tslib_1.__extends(MaxNode,_super),MaxNode.prototype.compareTo=function(other){return other===this?0:1},MaxNode.prototype.equals=function(other){return other===this},MaxNode.prototype.getPriority=function(){return this},MaxNode.prototype.getImmediateChild=function(childName){return ChildrenNode.EMPTY_NODE},MaxNode.prototype.isEmpty=function(){return!1},MaxNode}(ChildrenNode));Object.defineProperties(NamedNode,{MIN:{value:new NamedNode(MIN_NAME,ChildrenNode.EMPTY_NODE)},MAX:{value:new NamedNode(MAX_NAME,MAX_NODE$2)}}),KeyIndex.__EMPTY_NODE=ChildrenNode.EMPTY_NODE,LeafNode.__childrenNodeConstructor=ChildrenNode,MAX_NODE=MAX_NODE$2,function(val){MAX_NODE$1=val}(MAX_NODE$2);
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var USE_HINZE=!0;function nodeFromJSON$1(json,priority){if(void 0===priority&&(priority=null),null===json)return ChildrenNode.EMPTY_NODE;if("object"==typeof json&&".priority"in json&&(priority=json[".priority"]),util.assert(null===priority||"string"==typeof priority||"number"==typeof priority||"object"==typeof priority&&".sv"in priority,"Invalid priority type found: "+typeof priority),"object"==typeof json&&".value"in json&&null!==json[".value"]&&(json=json[".value"]),"object"!=typeof json||".sv"in json)return new LeafNode(json,nodeFromJSON$1(priority));if(json instanceof Array||!USE_HINZE){var node_1=ChildrenNode.EMPTY_NODE,jsonObj_1=json;return util.forEach(jsonObj_1,function(key,childData){if(util.contains(jsonObj_1,key)&&"."!==key.substring(0,1)){var childNode=nodeFromJSON$1(childData);!childNode.isLeafNode()&&childNode.isEmpty()||(node_1=node_1.updateImmediateChild(key,childNode))}}),node_1.updatePriority(nodeFromJSON$1(priority))}var children_1=[],childrenHavePriority_1=!1,hinzeJsonObj_1=json;if(util.forEach(hinzeJsonObj_1,function(key,child){if("string"!=typeof key||"."!==key.substring(0,1)){var childNode=nodeFromJSON$1(hinzeJsonObj_1[key]);childNode.isEmpty()||(childrenHavePriority_1=childrenHavePriority_1||!childNode.getPriority().isEmpty(),children_1.push(new NamedNode(key,childNode)))}}),0==children_1.length)return ChildrenNode.EMPTY_NODE;var childSet=buildChildSet(children_1,NAME_ONLY_COMPARATOR,function(namedNode){return namedNode.name},NAME_COMPARATOR);if(childrenHavePriority_1){var sortedChildSet=buildChildSet(children_1,PRIORITY_INDEX.getCompare());return new ChildrenNode(childSet,nodeFromJSON$1(priority),new IndexMap({".priority":sortedChildSet},{".priority":PRIORITY_INDEX}))}return new ChildrenNode(childSet,nodeFromJSON$1(priority),IndexMap.Default)}!function(val){nodeFromJSON=val}(nodeFromJSON$1);
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var __referenceConstructor,OperationType,VALUE_INDEX=new(function(_super){function ValueIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(ValueIndex,_super),ValueIndex.prototype.compare=function(a,b){var indexCmp=a.node.compareTo(b.node);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},ValueIndex.prototype.isDefinedOn=function(node){return!0},ValueIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.equals(newNode)},ValueIndex.prototype.minPost=function(){return NamedNode.MIN},ValueIndex.prototype.maxPost=function(){return NamedNode.MAX},ValueIndex.prototype.makePost=function(indexValue,name){var valueNode=nodeFromJSON$1(indexValue);return new NamedNode(name,valueNode)},ValueIndex.prototype.toString=function(){return".value"},ValueIndex}(Index)),PathIndex=function(_super){function PathIndex(indexPath_){var _this=_super.call(this)||this;return _this.indexPath_=indexPath_,util.assert(!indexPath_.isEmpty()&&".priority"!==indexPath_.getFront(),"Can't create PathIndex with empty path or .priority key"),_this}return tslib_1.__extends(PathIndex,_super),PathIndex.prototype.extractChild=function(snap){return snap.getChild(this.indexPath_)},PathIndex.prototype.isDefinedOn=function(node){return!node.getChild(this.indexPath_).isEmpty()},PathIndex.prototype.compare=function(a,b){var aChild=this.extractChild(a.node),bChild=this.extractChild(b.node),indexCmp=aChild.compareTo(bChild);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},PathIndex.prototype.makePost=function(indexValue,name){var valueNode=nodeFromJSON$1(indexValue),node=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,valueNode);return new NamedNode(name,node)},PathIndex.prototype.maxPost=function(){var node=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,MAX_NODE$2);return new NamedNode(MAX_NAME,node)},PathIndex.prototype.toString=function(){return this.indexPath_.slice().join("/")},PathIndex}(Index),DataSnapshot=function(){function DataSnapshot(node_,ref_,index_){this.node_=node_,this.ref_=ref_,this.index_=index_}return DataSnapshot.prototype.val=function(){return util.validateArgCount("DataSnapshot.val",0,0,arguments.length),this.node_.val()},DataSnapshot.prototype.exportVal=function(){return util.validateArgCount("DataSnapshot.exportVal",0,0,arguments.length),this.node_.val(!0)},DataSnapshot.prototype.toJSON=function(){return util.validateArgCount("DataSnapshot.toJSON",0,1,arguments.length),this.exportVal()},DataSnapshot.prototype.exists=function(){return util.validateArgCount("DataSnapshot.exists",0,0,arguments.length),!this.node_.isEmpty()},DataSnapshot.prototype.child=function(childPathString){util.validateArgCount("DataSnapshot.child",0,1,arguments.length),childPathString=String(childPathString),validatePathString("DataSnapshot.child",1,childPathString,!1);var childPath=new Path(childPathString),childRef=this.ref_.child(childPath);return new DataSnapshot(this.node_.getChild(childPath),childRef,PRIORITY_INDEX)},DataSnapshot.prototype.hasChild=function(childPathString){util.validateArgCount("DataSnapshot.hasChild",1,1,arguments.length),validatePathString("DataSnapshot.hasChild",1,childPathString,!1);var childPath=new Path(childPathString);return!this.node_.getChild(childPath).isEmpty()},DataSnapshot.prototype.getPriority=function(){return util.validateArgCount("DataSnapshot.getPriority",0,0,arguments.length),this.node_.getPriority().val()},DataSnapshot.prototype.forEach=function(action){var _this=this;return util.validateArgCount("DataSnapshot.forEach",1,1,arguments.length),util.validateCallback("DataSnapshot.forEach",1,action,!1),!this.node_.isLeafNode()&&!!this.node_.forEachChild(this.index_,function(key,node){return action(new DataSnapshot(node,_this.ref_.child(key),PRIORITY_INDEX))})},DataSnapshot.prototype.hasChildren=function(){return util.validateArgCount("DataSnapshot.hasChildren",0,0,arguments.length),!this.node_.isLeafNode()&&!this.node_.isEmpty()},Object.defineProperty(DataSnapshot.prototype,"key",{get:function(){return this.ref_.getKey()},enumerable:!0,configurable:!0}),DataSnapshot.prototype.numChildren=function(){return util.validateArgCount("DataSnapshot.numChildren",0,0,arguments.length),this.node_.numChildren()},DataSnapshot.prototype.getRef=function(){return util.validateArgCount("DataSnapshot.ref",0,0,arguments.length),this.ref_},Object.defineProperty(DataSnapshot.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),DataSnapshot}(),DataEvent=function(){function DataEvent(eventType,eventRegistration,snapshot,prevName){this.eventType=eventType,this.eventRegistration=eventRegistration,this.snapshot=snapshot,this.prevName=prevName}return DataEvent.prototype.getPath=function(){var ref=this.snapshot.getRef();return"value"===this.eventType?ref.path:ref.getParent().path},DataEvent.prototype.getEventType=function(){return this.eventType},DataEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},DataEvent.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+util.stringify(this.snapshot.exportVal())},DataEvent}(),CancelEvent=function(){function CancelEvent(eventRegistration,error,path){this.eventRegistration=eventRegistration,this.error=error,this.path=path}return CancelEvent.prototype.getPath=function(){return this.path},CancelEvent.prototype.getEventType=function(){return"cancel"},CancelEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},CancelEvent.prototype.toString=function(){return this.path.toString()+":cancel"},CancelEvent}(),ValueEventRegistration=function(){function ValueEventRegistration(callback_,cancelCallback_,context_){this.callback_=callback_,this.cancelCallback_=cancelCallback_,this.context_=context_}return ValueEventRegistration.prototype.respondsTo=function(eventType){return"value"===eventType},ValueEventRegistration.prototype.createEvent=function(change,query){var index=query.getQueryParams().getIndex();return new DataEvent("value",this,new DataSnapshot(change.snapshotNode,query.getRef(),index))},ValueEventRegistration.prototype.getEventRunner=function(eventData){var ctx=this.context_;if("cancel"===eventData.getEventType()){util.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var cancelCB_1=this.cancelCallback_;return function(){cancelCB_1.call(ctx,eventData.error)}}var cb_1=this.callback_;return function(){cb_1.call(ctx,eventData.snapshot)}},ValueEventRegistration.prototype.createCancelEvent=function(error,path){return this.cancelCallback_?new CancelEvent(this,error,path):null},ValueEventRegistration.prototype.matches=function(other){return other instanceof ValueEventRegistration&&(!other.callback_||!this.callback_||other.callback_===this.callback_&&other.context_===this.context_)},ValueEventRegistration.prototype.hasAnyCallback=function(){return null!==this.callback_},ValueEventRegistration}(),ChildEventRegistration=function(){function ChildEventRegistration(callbacks_,cancelCallback_,context_){this.callbacks_=callbacks_,this.cancelCallback_=cancelCallback_,this.context_=context_}return ChildEventRegistration.prototype.respondsTo=function(eventType){var eventToCheck="children_added"===eventType?"child_added":eventType;return eventToCheck="children_removed"===eventToCheck?"child_removed":eventToCheck,util.contains(this.callbacks_,eventToCheck)},ChildEventRegistration.prototype.createCancelEvent=function(error,path){return this.cancelCallback_?new CancelEvent(this,error,path):null},ChildEventRegistration.prototype.createEvent=function(change,query){util.assert(null!=change.childName,"Child events should have a childName.");var ref=query.getRef().child(change.childName),index=query.getQueryParams().getIndex();return new DataEvent(change.type,this,new DataSnapshot(change.snapshotNode,ref,index),change.prevName)},ChildEventRegistration.prototype.getEventRunner=function(eventData){var ctx=this.context_;if("cancel"===eventData.getEventType()){util.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var cancelCB_2=this.cancelCallback_;return function(){cancelCB_2.call(ctx,eventData.error)}}var cb_2=this.callbacks_[eventData.eventType];return function(){cb_2.call(ctx,eventData.snapshot,eventData.prevName)}},ChildEventRegistration.prototype.matches=function(other){if(other instanceof ChildEventRegistration){if(!this.callbacks_||!other.callbacks_)return!0;if(this.context_===other.context_){var otherCount=util.getCount(other.callbacks_);if(otherCount===util.getCount(this.callbacks_)){if(1===otherCount){var otherKey=util.getAnyKey(other.callbacks_),thisKey=util.getAnyKey(this.callbacks_);return!(thisKey!==otherKey||other.callbacks_[otherKey]&&this.callbacks_[thisKey]&&other.callbacks_[otherKey]!==this.callbacks_[thisKey])}return util.every(this.callbacks_,function(eventType,cb){return other.callbacks_[eventType]===cb})}}}return!1},ChildEventRegistration.prototype.hasAnyCallback=function(){return null!==this.callbacks_},ChildEventRegistration}(),Query=function(){function Query(repo,path,queryParams_,orderByCalled_){this.repo=repo,this.path=path,this.queryParams_=queryParams_,this.orderByCalled_=orderByCalled_}return Object.defineProperty(Query,"__referenceConstructor",{get:function(){return util.assert(__referenceConstructor,"Reference.ts has not been loaded"),__referenceConstructor},set:function(val){__referenceConstructor=val},enumerable:!0,configurable:!0}),Query.validateQueryEndpoints_=function(params){var startNode=null,endNode=null;if(params.hasStart()&&(startNode=params.getIndexStartValue()),params.hasEnd()&&(endNode=params.getIndexEndValue()),params.getIndex()===KEY_INDEX){var tooManyArgsError="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",wrongArgTypeError="Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.";if(params.hasStart()){if(params.getIndexStartName()!=MIN_NAME)throw new Error(tooManyArgsError);if("string"!=typeof startNode)throw new Error(wrongArgTypeError)}if(params.hasEnd()){if(params.getIndexEndName()!=MAX_NAME)throw new Error(tooManyArgsError);if("string"!=typeof endNode)throw new Error(wrongArgTypeError)}}else if(params.getIndex()===PRIORITY_INDEX){if(null!=startNode&&!isValidPriority(startNode)||null!=endNode&&!isValidPriority(endNode))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), endAt(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(util.assert(params.getIndex()instanceof PathIndex||params.getIndex()===VALUE_INDEX,"unknown index type."),null!=startNode&&"object"==typeof startNode||null!=endNode&&"object"==typeof endNode)throw new Error("Query: First argument passed to startAt(), endAt(), or equalTo() cannot be an object.")},Query.validateLimit_=function(params){if(params.hasStart()&&params.hasEnd()&&params.hasLimit()&&!params.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), endAt(), and limit(). Use limitToFirst() or limitToLast() instead.")},Query.prototype.validateNoPreviousOrderByCall_=function(fnName){if(!0===this.orderByCalled_)throw new Error(fnName+": You can't combine multiple orderBy calls.")},Query.prototype.getQueryParams=function(){return this.queryParams_},Query.prototype.getRef=function(){return util.validateArgCount("Query.ref",0,0,arguments.length),new Query.__referenceConstructor(this.repo,this.path)},Query.prototype.on=function(eventType,callback,cancelCallbackOrContext,context){util.validateArgCount("Query.on",2,4,arguments.length),validateEventType("Query.on",1,eventType,!1),util.validateCallback("Query.on",2,callback,!1);var ret=Query.getCancelAndContextArgs_("Query.on",cancelCallbackOrContext,context);if("value"===eventType)this.onValueEvent(callback,ret.cancel,ret.context);else{var callbacks={};callbacks[eventType]=callback,this.onChildEvent(callbacks,ret.cancel,ret.context)}return callback},Query.prototype.onValueEvent=function(callback,cancelCallback,context){var container=new ValueEventRegistration(callback,cancelCallback||null,context||null);this.repo.addEventCallbackForQuery(this,container)},Query.prototype.onChildEvent=function(callbacks,cancelCallback,context){var container=new ChildEventRegistration(callbacks,cancelCallback,context);this.repo.addEventCallbackForQuery(this,container)},Query.prototype.off=function(eventType,callback,context){util.validateArgCount("Query.off",0,3,arguments.length),validateEventType("Query.off",1,eventType,!0),util.validateCallback("Query.off",2,callback,!0),util.validateContextObject("Query.off",3,context,!0);var container=null,callbacks=null;"value"===eventType?container=new ValueEventRegistration(callback||null,null,context||null):eventType&&(callback&&((callbacks={})[eventType]=callback),container=new ChildEventRegistration(callbacks,null,context||null));this.repo.removeEventCallbackForQuery(this,container)},Query.prototype.once=function(eventType,userCallback,failureCallbackOrContext,context){var _this=this;util.validateArgCount("Query.once",1,4,arguments.length),validateEventType("Query.once",1,eventType,!1),util.validateCallback("Query.once",2,userCallback,!0);var ret=Query.getCancelAndContextArgs_("Query.once",failureCallbackOrContext,context),firstCall=!0,deferred=new util.Deferred;deferred.promise.catch(function(){});var onceCallback=function(snapshot){firstCall&&(firstCall=!1,_this.off(eventType,onceCallback),userCallback&&userCallback.bind(ret.context)(snapshot),deferred.resolve(snapshot))};return this.on(eventType,onceCallback,function(err){_this.off(eventType,onceCallback),ret.cancel&&ret.cancel.bind(ret.context)(err),deferred.reject(err)}),deferred.promise},Query.prototype.limitToFirst=function(limit){if(util.validateArgCount("Query.limitToFirst",1,1,arguments.length),"number"!=typeof limit||Math.floor(limit)!==limit||limit<=0)throw new Error("Query.limitToFirst: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToFirst: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Query(this.repo,this.path,this.queryParams_.limitToFirst(limit),this.orderByCalled_)},Query.prototype.limitToLast=function(limit){if(util.validateArgCount("Query.limitToLast",1,1,arguments.length),"number"!=typeof limit||Math.floor(limit)!==limit||limit<=0)throw new Error("Query.limitToLast: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToLast: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Query(this.repo,this.path,this.queryParams_.limitToLast(limit),this.orderByCalled_)},Query.prototype.orderByChild=function(path){if(util.validateArgCount("Query.orderByChild",1,1,arguments.length),"$key"===path)throw new Error('Query.orderByChild: "$key" is invalid.  Use Query.orderByKey() instead.');if("$priority"===path)throw new Error('Query.orderByChild: "$priority" is invalid.  Use Query.orderByPriority() instead.');if("$value"===path)throw new Error('Query.orderByChild: "$value" is invalid.  Use Query.orderByValue() instead.');validatePathString("Query.orderByChild",1,path,!1),this.validateNoPreviousOrderByCall_("Query.orderByChild");var parsedPath=new Path(path);if(parsedPath.isEmpty())throw new Error("Query.orderByChild: cannot pass in empty path.  Use Query.orderByValue() instead.");var index=new PathIndex(parsedPath),newParams=this.queryParams_.orderBy(index);return Query.validateQueryEndpoints_(newParams),new Query(this.repo,this.path,newParams,!0)},Query.prototype.orderByKey=function(){util.validateArgCount("Query.orderByKey",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByKey");var newParams=this.queryParams_.orderBy(KEY_INDEX);return Query.validateQueryEndpoints_(newParams),new Query(this.repo,this.path,newParams,!0)},Query.prototype.orderByPriority=function(){util.validateArgCount("Query.orderByPriority",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByPriority");var newParams=this.queryParams_.orderBy(PRIORITY_INDEX);return Query.validateQueryEndpoints_(newParams),new Query(this.repo,this.path,newParams,!0)},Query.prototype.orderByValue=function(){util.validateArgCount("Query.orderByValue",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByValue");var newParams=this.queryParams_.orderBy(VALUE_INDEX);return Query.validateQueryEndpoints_(newParams),new Query(this.repo,this.path,newParams,!0)},Query.prototype.startAt=function(value,name){void 0===value&&(value=null),util.validateArgCount("Query.startAt",0,2,arguments.length),validateFirebaseDataArg("Query.startAt",1,value,this.path,!0),validateKey("Query.startAt",2,name,!0);var newParams=this.queryParams_.startAt(value,name);if(Query.validateLimit_(newParams),Query.validateQueryEndpoints_(newParams),this.queryParams_.hasStart())throw new Error("Query.startAt: Starting point was already set (by another call to startAt or equalTo).");return void 0===value&&(value=null,name=null),new Query(this.repo,this.path,newParams,this.orderByCalled_)},Query.prototype.endAt=function(value,name){void 0===value&&(value=null),util.validateArgCount("Query.endAt",0,2,arguments.length),validateFirebaseDataArg("Query.endAt",1,value,this.path,!0),validateKey("Query.endAt",2,name,!0);var newParams=this.queryParams_.endAt(value,name);if(Query.validateLimit_(newParams),Query.validateQueryEndpoints_(newParams),this.queryParams_.hasEnd())throw new Error("Query.endAt: Ending point was already set (by another call to endAt or equalTo).");return new Query(this.repo,this.path,newParams,this.orderByCalled_)},Query.prototype.equalTo=function(value,name){if(util.validateArgCount("Query.equalTo",1,2,arguments.length),validateFirebaseDataArg("Query.equalTo",1,value,this.path,!1),validateKey("Query.equalTo",2,name,!0),this.queryParams_.hasStart())throw new Error("Query.equalTo: Starting point was already set (by another call to startAt or equalTo).");if(this.queryParams_.hasEnd())throw new Error("Query.equalTo: Ending point was already set (by another call to endAt or equalTo).");return this.startAt(value,name).endAt(value,name)},Query.prototype.toString=function(){return util.validateArgCount("Query.toString",0,0,arguments.length),this.repo.toString()+this.path.toUrlEncodedString()},Query.prototype.toJSON=function(){return util.validateArgCount("Query.toJSON",0,1,arguments.length),this.toString()},Query.prototype.queryObject=function(){return this.queryParams_.getQueryObject()},Query.prototype.queryIdentifier=function(){var obj=this.queryObject(),id=ObjectToUniqueKey(obj);return"{}"===id?"default":id},Query.prototype.isEqual=function(other){if(util.validateArgCount("Query.isEqual",1,1,arguments.length),!(other instanceof Query)){throw new Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.")}var sameRepo=this.repo===other.repo,samePath=this.path.equals(other.path),sameQueryIdentifier=this.queryIdentifier()===other.queryIdentifier();return sameRepo&&samePath&&sameQueryIdentifier},Query.getCancelAndContextArgs_=function(fnName,cancelOrContext,context){var ret={cancel:null,context:null};if(cancelOrContext&&context)ret.cancel=cancelOrContext,util.validateCallback(fnName,3,ret.cancel,!0),ret.context=context,util.validateContextObject(fnName,4,ret.context,!0);else if(cancelOrContext)if("object"==typeof cancelOrContext&&null!==cancelOrContext)ret.context=cancelOrContext;else{if("function"!=typeof cancelOrContext)throw new Error(util.errorPrefix(fnName,3,!0)+" must either be a cancel callback or a context object.");ret.cancel=cancelOrContext}return ret},Object.defineProperty(Query.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),Query}(),CountedSet=function(){function CountedSet(){this.set={}}return CountedSet.prototype.add=function(item,val){this.set[item]=null===val||val},CountedSet.prototype.contains=function(key){return util.contains(this.set,key)},CountedSet.prototype.get=function(item){return this.contains(item)?this.set[item]:void 0},CountedSet.prototype.remove=function(item){delete this.set[item]},CountedSet.prototype.clear=function(){this.set={}},CountedSet.prototype.isEmpty=function(){return util.isEmpty(this.set)},CountedSet.prototype.count=function(){return util.getCount(this.set)},CountedSet.prototype.each=function(fn){util.forEach(this.set,function(k,v){return fn(k,v)})},CountedSet.prototype.keys=function(){var keys=[];return util.forEach(this.set,function(k){keys.push(k)}),keys},CountedSet}(),SparseSnapshotTree=function(){function SparseSnapshotTree(){this.value_=null,this.children_=null}return SparseSnapshotTree.prototype.find=function(path){if(null!=this.value_)return this.value_.getChild(path);if(path.isEmpty()||null==this.children_)return null;var childKey=path.getFront();return path=path.popFront(),this.children_.contains(childKey)?this.children_.get(childKey).find(path):null},SparseSnapshotTree.prototype.remember=function(path,data){if(path.isEmpty())this.value_=data,this.children_=null;else if(null!==this.value_)this.value_=this.value_.updateChild(path,data);else{null==this.children_&&(this.children_=new CountedSet);var childKey=path.getFront();this.children_.contains(childKey)||this.children_.add(childKey,new SparseSnapshotTree);var child=this.children_.get(childKey);path=path.popFront(),child.remember(path,data)}},SparseSnapshotTree.prototype.forget=function(path){if(path.isEmpty())return this.value_=null,this.children_=null,!0;if(null!==this.value_){if(this.value_.isLeafNode())return!1;var value=this.value_;this.value_=null;var self_1=this;return value.forEachChild(PRIORITY_INDEX,function(key,tree){self_1.remember(new Path(key),tree)}),this.forget(path)}if(null!==this.children_){var childKey=path.getFront();if(path=path.popFront(),this.children_.contains(childKey))this.children_.get(childKey).forget(path)&&this.children_.remove(childKey);return!!this.children_.isEmpty()&&(this.children_=null,!0)}return!0},SparseSnapshotTree.prototype.forEachTree=function(prefixPath,func){null!==this.value_?func(prefixPath,this.value_):this.forEachChild(function(key,tree){var path=new Path(prefixPath.toString()+"/"+key);tree.forEachTree(path,func)})},SparseSnapshotTree.prototype.forEachChild=function(func){null!==this.children_&&this.children_.each(function(key,tree){func(key,tree)})},SparseSnapshotTree}(),resolveDeferredValue=function(value,serverValues){return value&&"object"==typeof value?(util.assert(".sv"in value,"Unexpected leaf node or priority contents"),serverValues[value[".sv"]]):value},resolveDeferredValueSnapshot=function(node,serverValues){var newNode,rawPri=node.getPriority().val(),priority=resolveDeferredValue(rawPri,serverValues);if(node.isLeafNode()){var leafNode=node,value=resolveDeferredValue(leafNode.getValue(),serverValues);return value!==leafNode.getValue()||priority!==leafNode.getPriority().val()?new LeafNode(value,nodeFromJSON$1(priority)):node}var childrenNode=node;return newNode=childrenNode,priority!==childrenNode.getPriority().val()&&(newNode=newNode.updatePriority(new LeafNode(priority))),childrenNode.forEachChild(PRIORITY_INDEX,function(childName,childNode){var newChildNode=resolveDeferredValueSnapshot(childNode,serverValues);newChildNode!==childNode&&(newNode=newNode.updateImmediateChild(childName,newChildNode))}),newNode};!function(OperationType){OperationType[OperationType.OVERWRITE=0]="OVERWRITE",OperationType[OperationType.MERGE=1]="MERGE",OperationType[OperationType.ACK_USER_WRITE=2]="ACK_USER_WRITE",OperationType[OperationType.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(OperationType||(OperationType={}));var emptyChildrenSingleton,__referenceConstructor$1,OperationSource=function(){function OperationSource(fromUser,fromServer,queryId,tagged){this.fromUser=fromUser,this.fromServer=fromServer,this.queryId=queryId,this.tagged=tagged,util.assert(!tagged||fromServer,"Tagged queries must be from server.")}return OperationSource.User=new OperationSource(!0,!1,null,!1),OperationSource.Server=new OperationSource(!1,!0,null,!1),OperationSource.forServerTaggedQuery=function(queryId){return new OperationSource(!1,!0,queryId,!0)},OperationSource}(),AckUserWrite=function(){function AckUserWrite(path,affectedTree,revert){this.path=path,this.affectedTree=affectedTree,this.revert=revert,this.type=OperationType.ACK_USER_WRITE,this.source=OperationSource.User}return AckUserWrite.prototype.operationForChild=function(childName){if(this.path.isEmpty()){if(null!=this.affectedTree.value)return util.assert(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var childTree=this.affectedTree.subtree(new Path(childName));return new AckUserWrite(Path.Empty,childTree,this.revert)}return util.assert(this.path.getFront()===childName,"operationForChild called for unrelated child."),new AckUserWrite(this.path.popFront(),this.affectedTree,this.revert)},AckUserWrite}(),EmptyChildren=function(){return emptyChildrenSingleton||(emptyChildrenSingleton=new SortedMap(stringCompare)),emptyChildrenSingleton},ImmutableTree=function(){function ImmutableTree(value,children){void 0===children&&(children=EmptyChildren()),this.value=value,this.children=children}return ImmutableTree.fromObject=function(obj){var tree=ImmutableTree.Empty;return util.forEach(obj,function(childPath,childSnap){tree=tree.set(new Path(childPath),childSnap)}),tree},ImmutableTree.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},ImmutableTree.prototype.findRootMostMatchingPathAndValue=function(relativePath,predicate){if(null!=this.value&&predicate(this.value))return{path:Path.Empty,value:this.value};if(relativePath.isEmpty())return null;var front=relativePath.getFront(),child=this.children.get(front);if(null!==child){var childExistingPathAndValue=child.findRootMostMatchingPathAndValue(relativePath.popFront(),predicate);return null!=childExistingPathAndValue?{path:new Path(front).child(childExistingPathAndValue.path),value:childExistingPathAndValue.value}:null}return null},ImmutableTree.prototype.findRootMostValueAndPath=function(relativePath){return this.findRootMostMatchingPathAndValue(relativePath,function(){return!0})},ImmutableTree.prototype.subtree=function(relativePath){if(relativePath.isEmpty())return this;var front=relativePath.getFront(),childTree=this.children.get(front);return null!==childTree?childTree.subtree(relativePath.popFront()):ImmutableTree.Empty},ImmutableTree.prototype.set=function(relativePath,toSet){if(relativePath.isEmpty())return new ImmutableTree(toSet,this.children);var front=relativePath.getFront(),newChild=(this.children.get(front)||ImmutableTree.Empty).set(relativePath.popFront(),toSet),newChildren=this.children.insert(front,newChild);return new ImmutableTree(this.value,newChildren)},ImmutableTree.prototype.remove=function(relativePath){if(relativePath.isEmpty())return this.children.isEmpty()?ImmutableTree.Empty:new ImmutableTree(null,this.children);var front=relativePath.getFront(),child=this.children.get(front);if(child){var newChild=child.remove(relativePath.popFront()),newChildren=void 0;return newChildren=newChild.isEmpty()?this.children.remove(front):this.children.insert(front,newChild),null===this.value&&newChildren.isEmpty()?ImmutableTree.Empty:new ImmutableTree(this.value,newChildren)}return this},ImmutableTree.prototype.get=function(relativePath){if(relativePath.isEmpty())return this.value;var front=relativePath.getFront(),child=this.children.get(front);return child?child.get(relativePath.popFront()):null},ImmutableTree.prototype.setTree=function(relativePath,newTree){if(relativePath.isEmpty())return newTree;var front=relativePath.getFront(),newChild=(this.children.get(front)||ImmutableTree.Empty).setTree(relativePath.popFront(),newTree),newChildren=void 0;return newChildren=newChild.isEmpty()?this.children.remove(front):this.children.insert(front,newChild),new ImmutableTree(this.value,newChildren)},ImmutableTree.prototype.fold=function(fn){return this.fold_(Path.Empty,fn)},ImmutableTree.prototype.fold_=function(pathSoFar,fn){var accum={};return this.children.inorderTraversal(function(childKey,childTree){accum[childKey]=childTree.fold_(pathSoFar.child(childKey),fn)}),fn(pathSoFar,this.value,accum)},ImmutableTree.prototype.findOnPath=function(path,f){return this.findOnPath_(path,Path.Empty,f)},ImmutableTree.prototype.findOnPath_=function(pathToFollow,pathSoFar,f){var result=!!this.value&&f(pathSoFar,this.value);if(result)return result;if(pathToFollow.isEmpty())return null;var front=pathToFollow.getFront(),nextChild=this.children.get(front);return nextChild?nextChild.findOnPath_(pathToFollow.popFront(),pathSoFar.child(front),f):null},ImmutableTree.prototype.foreachOnPath=function(path,f){return this.foreachOnPath_(path,Path.Empty,f)},ImmutableTree.prototype.foreachOnPath_=function(pathToFollow,currentRelativePath,f){if(pathToFollow.isEmpty())return this;this.value&&f(currentRelativePath,this.value);var front=pathToFollow.getFront(),nextChild=this.children.get(front);return nextChild?nextChild.foreachOnPath_(pathToFollow.popFront(),currentRelativePath.child(front),f):ImmutableTree.Empty},ImmutableTree.prototype.foreach=function(f){this.foreach_(Path.Empty,f)},ImmutableTree.prototype.foreach_=function(currentRelativePath,f){this.children.inorderTraversal(function(childName,childTree){childTree.foreach_(currentRelativePath.child(childName),f)}),this.value&&f(currentRelativePath,this.value)},ImmutableTree.prototype.foreachChild=function(f){this.children.inorderTraversal(function(childName,childTree){childTree.value&&f(childName,childTree.value)})},ImmutableTree.Empty=new ImmutableTree(null),ImmutableTree}(),ListenComplete=function(){function ListenComplete(source,path){this.source=source,this.path=path,this.type=OperationType.LISTEN_COMPLETE}return ListenComplete.prototype.operationForChild=function(childName){return this.path.isEmpty()?new ListenComplete(this.source,Path.Empty):new ListenComplete(this.source,this.path.popFront())},ListenComplete}(),Overwrite=function(){function Overwrite(source,path,snap){this.source=source,this.path=path,this.snap=snap,this.type=OperationType.OVERWRITE}return Overwrite.prototype.operationForChild=function(childName){return this.path.isEmpty()?new Overwrite(this.source,Path.Empty,this.snap.getImmediateChild(childName)):new Overwrite(this.source,this.path.popFront(),this.snap)},Overwrite}(),Merge=function(){function Merge(source,path,children){this.source=source,this.path=path,this.children=children,this.type=OperationType.MERGE}return Merge.prototype.operationForChild=function(childName){if(this.path.isEmpty()){var childTree=this.children.subtree(new Path(childName));return childTree.isEmpty()?null:childTree.value?new Overwrite(this.source,Path.Empty,childTree.value):new Merge(this.source,Path.Empty,childTree)}return util.assert(this.path.getFront()===childName,"Can't get a merge for a child not on the path of the operation"),new Merge(this.source,this.path.popFront(),this.children)},Merge.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},Merge}(),CacheNode=function(){function CacheNode(node_,fullyInitialized_,filtered_){this.node_=node_,this.fullyInitialized_=fullyInitialized_,this.filtered_=filtered_}return CacheNode.prototype.isFullyInitialized=function(){return this.fullyInitialized_},CacheNode.prototype.isFiltered=function(){return this.filtered_},CacheNode.prototype.isCompleteForPath=function(path){if(path.isEmpty())return this.isFullyInitialized()&&!this.filtered_;var childKey=path.getFront();return this.isCompleteForChild(childKey)},CacheNode.prototype.isCompleteForChild=function(key){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(key)},CacheNode.prototype.getNode=function(){return this.node_},CacheNode}(),ViewCache=function(){function ViewCache(eventCache_,serverCache_){this.eventCache_=eventCache_,this.serverCache_=serverCache_}return ViewCache.prototype.updateEventSnap=function(eventSnap,complete,filtered){return new ViewCache(new CacheNode(eventSnap,complete,filtered),this.serverCache_)},ViewCache.prototype.updateServerSnap=function(serverSnap,complete,filtered){return new ViewCache(this.eventCache_,new CacheNode(serverSnap,complete,filtered))},ViewCache.prototype.getEventCache=function(){return this.eventCache_},ViewCache.prototype.getCompleteEventSnap=function(){return this.eventCache_.isFullyInitialized()?this.eventCache_.getNode():null},ViewCache.prototype.getServerCache=function(){return this.serverCache_},ViewCache.prototype.getCompleteServerSnap=function(){return this.serverCache_.isFullyInitialized()?this.serverCache_.getNode():null},ViewCache.Empty=new ViewCache(new CacheNode(ChildrenNode.EMPTY_NODE,!1,!1),new CacheNode(ChildrenNode.EMPTY_NODE,!1,!1)),ViewCache}(),Change=function(){function Change(type,snapshotNode,childName,oldSnap,prevName){this.type=type,this.snapshotNode=snapshotNode,this.childName=childName,this.oldSnap=oldSnap,this.prevName=prevName}return Change.valueChange=function(snapshot){return new Change(Change.VALUE,snapshot)},Change.childAddedChange=function(childKey,snapshot){return new Change(Change.CHILD_ADDED,snapshot,childKey)},Change.childRemovedChange=function(childKey,snapshot){return new Change(Change.CHILD_REMOVED,snapshot,childKey)},Change.childChangedChange=function(childKey,newSnapshot,oldSnapshot){return new Change(Change.CHILD_CHANGED,newSnapshot,childKey,oldSnapshot)},Change.childMovedChange=function(childKey,snapshot){return new Change(Change.CHILD_MOVED,snapshot,childKey)},Change.CHILD_ADDED="child_added",Change.CHILD_REMOVED="child_removed",Change.CHILD_CHANGED="child_changed",Change.CHILD_MOVED="child_moved",Change.VALUE="value",Change}(),IndexedFilter=function(){function IndexedFilter(index_){this.index_=index_}return IndexedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){util.assert(snap.isIndexed(this.index_),"A node must be indexed if only a child is updated");var oldChild=snap.getImmediateChild(key);return oldChild.getChild(affectedPath).equals(newChild.getChild(affectedPath))&&oldChild.isEmpty()==newChild.isEmpty()?snap:(null!=optChangeAccumulator&&(newChild.isEmpty()?snap.hasChild(key)?optChangeAccumulator.trackChildChange(Change.childRemovedChange(key,oldChild)):util.assert(snap.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):oldChild.isEmpty()?optChangeAccumulator.trackChildChange(Change.childAddedChange(key,newChild)):optChangeAccumulator.trackChildChange(Change.childChangedChange(key,newChild,oldChild))),snap.isLeafNode()&&newChild.isEmpty()?snap:snap.updateImmediateChild(key,newChild).withIndex(this.index_))},IndexedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){return null!=optChangeAccumulator&&(oldSnap.isLeafNode()||oldSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){newSnap.hasChild(key)||optChangeAccumulator.trackChildChange(Change.childRemovedChange(key,childNode))}),newSnap.isLeafNode()||newSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){if(oldSnap.hasChild(key)){var oldChild=oldSnap.getImmediateChild(key);oldChild.equals(childNode)||optChangeAccumulator.trackChildChange(Change.childChangedChange(key,childNode,oldChild))}else optChangeAccumulator.trackChildChange(Change.childAddedChange(key,childNode))})),newSnap.withIndex(this.index_)},IndexedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap.isEmpty()?ChildrenNode.EMPTY_NODE:oldSnap.updatePriority(newPriority)},IndexedFilter.prototype.filtersNodes=function(){return!1},IndexedFilter.prototype.getIndexedFilter=function(){return this},IndexedFilter.prototype.getIndex=function(){return this.index_},IndexedFilter}(),ChildChangeAccumulator=function(){function ChildChangeAccumulator(){this.changeMap_={}}return ChildChangeAccumulator.prototype.trackChildChange=function(change){var type=change.type,childKey=change.childName;util.assert(type==Change.CHILD_ADDED||type==Change.CHILD_CHANGED||type==Change.CHILD_REMOVED,"Only child changes supported for tracking"),util.assert(".priority"!==childKey,"Only non-priority child changes can be tracked.");var oldChange=util.safeGet(this.changeMap_,childKey);if(oldChange){var oldType=oldChange.type;if(type==Change.CHILD_ADDED&&oldType==Change.CHILD_REMOVED)this.changeMap_[childKey]=Change.childChangedChange(childKey,change.snapshotNode,oldChange.snapshotNode);else if(type==Change.CHILD_REMOVED&&oldType==Change.CHILD_ADDED)delete this.changeMap_[childKey];else if(type==Change.CHILD_REMOVED&&oldType==Change.CHILD_CHANGED)this.changeMap_[childKey]=Change.childRemovedChange(childKey,oldChange.oldSnap);else if(type==Change.CHILD_CHANGED&&oldType==Change.CHILD_ADDED)this.changeMap_[childKey]=Change.childAddedChange(childKey,change.snapshotNode);else{if(type!=Change.CHILD_CHANGED||oldType!=Change.CHILD_CHANGED)throw util.assertionError("Illegal combination of changes: "+change+" occurred after "+oldChange);this.changeMap_[childKey]=Change.childChangedChange(childKey,change.snapshotNode,oldChange.oldSnap)}}else this.changeMap_[childKey]=change},ChildChangeAccumulator.prototype.getChanges=function(){return util.getValues(this.changeMap_)},ChildChangeAccumulator}(),NO_COMPLETE_CHILD_SOURCE=new(function(){function NoCompleteChildSource_(){}return NoCompleteChildSource_.prototype.getCompleteChild=function(childKey){return null},NoCompleteChildSource_.prototype.getChildAfterChild=function(index,child,reverse){return null},NoCompleteChildSource_}()),WriteTreeCompleteChildSource=function(){function WriteTreeCompleteChildSource(writes_,viewCache_,optCompleteServerCache_){void 0===optCompleteServerCache_&&(optCompleteServerCache_=null),this.writes_=writes_,this.viewCache_=viewCache_,this.optCompleteServerCache_=optCompleteServerCache_}return WriteTreeCompleteChildSource.prototype.getCompleteChild=function(childKey){var node=this.viewCache_.getEventCache();if(node.isCompleteForChild(childKey))return node.getNode().getImmediateChild(childKey);var serverNode=null!=this.optCompleteServerCache_?new CacheNode(this.optCompleteServerCache_,!0,!1):this.viewCache_.getServerCache();return this.writes_.calcCompleteChild(childKey,serverNode)},WriteTreeCompleteChildSource.prototype.getChildAfterChild=function(index,child,reverse){var completeServerData=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:this.viewCache_.getCompleteServerSnap(),nodes=this.writes_.calcIndexedSlice(completeServerData,child,1,reverse,index);return 0===nodes.length?null:nodes[0]},WriteTreeCompleteChildSource}(),ProcessorResult=function(){return function(viewCache,changes){this.viewCache=viewCache,this.changes=changes}}(),ViewProcessor=function(){function ViewProcessor(filter_){this.filter_=filter_}return ViewProcessor.prototype.assertIndexed=function(viewCache){util.assert(viewCache.getEventCache().getNode().isIndexed(this.filter_.getIndex()),"Event snap not indexed"),util.assert(viewCache.getServerCache().getNode().isIndexed(this.filter_.getIndex()),"Server snap not indexed")},ViewProcessor.prototype.applyOperation=function(oldViewCache,operation,writesCache,completeCache){var newViewCache,filterServerNode,accumulator=new ChildChangeAccumulator;if(operation.type===OperationType.OVERWRITE){var overwrite=operation;overwrite.source.fromUser?newViewCache=this.applyUserOverwrite_(oldViewCache,overwrite.path,overwrite.snap,writesCache,completeCache,accumulator):(util.assert(overwrite.source.fromServer,"Unknown source."),filterServerNode=overwrite.source.tagged||oldViewCache.getServerCache().isFiltered()&&!overwrite.path.isEmpty(),newViewCache=this.applyServerOverwrite_(oldViewCache,overwrite.path,overwrite.snap,writesCache,completeCache,filterServerNode,accumulator))}else if(operation.type===OperationType.MERGE){var merge=operation;merge.source.fromUser?newViewCache=this.applyUserMerge_(oldViewCache,merge.path,merge.children,writesCache,completeCache,accumulator):(util.assert(merge.source.fromServer,"Unknown source."),filterServerNode=merge.source.tagged||oldViewCache.getServerCache().isFiltered(),newViewCache=this.applyServerMerge_(oldViewCache,merge.path,merge.children,writesCache,completeCache,filterServerNode,accumulator))}else if(operation.type===OperationType.ACK_USER_WRITE){var ackUserWrite=operation;newViewCache=ackUserWrite.revert?this.revertUserWrite_(oldViewCache,ackUserWrite.path,writesCache,completeCache,accumulator):this.ackUserWrite_(oldViewCache,ackUserWrite.path,ackUserWrite.affectedTree,writesCache,completeCache,accumulator)}else{if(operation.type!==OperationType.LISTEN_COMPLETE)throw util.assertionError("Unknown operation type: "+operation.type);newViewCache=this.listenComplete_(oldViewCache,operation.path,writesCache,accumulator)}var changes=accumulator.getChanges();return ViewProcessor.maybeAddValueEvent_(oldViewCache,newViewCache,changes),new ProcessorResult(newViewCache,changes)},ViewProcessor.maybeAddValueEvent_=function(oldViewCache,newViewCache,accumulator){var eventSnap=newViewCache.getEventCache();if(eventSnap.isFullyInitialized()){var isLeafOrEmpty=eventSnap.getNode().isLeafNode()||eventSnap.getNode().isEmpty(),oldCompleteSnap=oldViewCache.getCompleteEventSnap();(accumulator.length>0||!oldViewCache.getEventCache().isFullyInitialized()||isLeafOrEmpty&&!eventSnap.getNode().equals(oldCompleteSnap)||!eventSnap.getNode().getPriority().equals(oldCompleteSnap.getPriority()))&&accumulator.push(Change.valueChange(newViewCache.getCompleteEventSnap()))}},ViewProcessor.prototype.generateEventCacheAfterServerEvent_=function(viewCache,changePath,writesCache,source,accumulator){var oldEventSnap=viewCache.getEventCache();if(null!=writesCache.shadowingWrite(changePath))return viewCache;var newEventCache=void 0,serverNode=void 0;if(changePath.isEmpty())if(util.assert(viewCache.getServerCache().isFullyInitialized(),"If change path is empty, we must have complete server data"),viewCache.getServerCache().isFiltered()){var serverCache=viewCache.getCompleteServerSnap(),completeChildren=serverCache instanceof ChildrenNode?serverCache:ChildrenNode.EMPTY_NODE,completeEventChildren=writesCache.calcCompleteEventChildren(completeChildren);newEventCache=this.filter_.updateFullNode(viewCache.getEventCache().getNode(),completeEventChildren,accumulator)}else{var completeNode=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap());newEventCache=this.filter_.updateFullNode(viewCache.getEventCache().getNode(),completeNode,accumulator)}else{var childKey=changePath.getFront();if(".priority"==childKey){util.assert(1==changePath.getLength(),"Can't have a priority with additional path components");var oldEventNode=oldEventSnap.getNode();serverNode=viewCache.getServerCache().getNode();var updatedPriority=writesCache.calcEventCacheAfterServerOverwrite(changePath,oldEventNode,serverNode);newEventCache=null!=updatedPriority?this.filter_.updatePriority(oldEventNode,updatedPriority):oldEventSnap.getNode()}else{var childChangePath=changePath.popFront(),newEventChild=void 0;if(oldEventSnap.isCompleteForChild(childKey)){serverNode=viewCache.getServerCache().getNode();var eventChildUpdate=writesCache.calcEventCacheAfterServerOverwrite(changePath,oldEventSnap.getNode(),serverNode);newEventChild=null!=eventChildUpdate?oldEventSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,eventChildUpdate):oldEventSnap.getNode().getImmediateChild(childKey)}else newEventChild=writesCache.calcCompleteChild(childKey,viewCache.getServerCache());newEventCache=null!=newEventChild?this.filter_.updateChild(oldEventSnap.getNode(),childKey,newEventChild,childChangePath,source,accumulator):oldEventSnap.getNode()}}return viewCache.updateEventSnap(newEventCache,oldEventSnap.isFullyInitialized()||changePath.isEmpty(),this.filter_.filtersNodes())},ViewProcessor.prototype.applyServerOverwrite_=function(oldViewCache,changePath,changedSnap,writesCache,completeCache,filterServerNode,accumulator){var newServerCache,oldServerSnap=oldViewCache.getServerCache(),serverFilter=filterServerNode?this.filter_:this.filter_.getIndexedFilter();if(changePath.isEmpty())newServerCache=serverFilter.updateFullNode(oldServerSnap.getNode(),changedSnap,null);else if(serverFilter.filtersNodes()&&!oldServerSnap.isFiltered()){var newServerNode=oldServerSnap.getNode().updateChild(changePath,changedSnap);newServerCache=serverFilter.updateFullNode(oldServerSnap.getNode(),newServerNode,null)}else{var childKey=changePath.getFront();if(!oldServerSnap.isCompleteForPath(changePath)&&changePath.getLength()>1)return oldViewCache;var childChangePath=changePath.popFront(),newChildNode=oldServerSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,changedSnap);newServerCache=".priority"==childKey?serverFilter.updatePriority(oldServerSnap.getNode(),newChildNode):serverFilter.updateChild(oldServerSnap.getNode(),childKey,newChildNode,childChangePath,NO_COMPLETE_CHILD_SOURCE,null)}var newViewCache=oldViewCache.updateServerSnap(newServerCache,oldServerSnap.isFullyInitialized()||changePath.isEmpty(),serverFilter.filtersNodes()),source=new WriteTreeCompleteChildSource(writesCache,newViewCache,completeCache);return this.generateEventCacheAfterServerEvent_(newViewCache,changePath,writesCache,source,accumulator)},ViewProcessor.prototype.applyUserOverwrite_=function(oldViewCache,changePath,changedSnap,writesCache,completeCache,accumulator){var newViewCache,newEventCache,oldEventSnap=oldViewCache.getEventCache(),source=new WriteTreeCompleteChildSource(writesCache,oldViewCache,completeCache);if(changePath.isEmpty())newEventCache=this.filter_.updateFullNode(oldViewCache.getEventCache().getNode(),changedSnap,accumulator),newViewCache=oldViewCache.updateEventSnap(newEventCache,!0,this.filter_.filtersNodes());else{var childKey=changePath.getFront();if(".priority"===childKey)newEventCache=this.filter_.updatePriority(oldViewCache.getEventCache().getNode(),changedSnap),newViewCache=oldViewCache.updateEventSnap(newEventCache,oldEventSnap.isFullyInitialized(),oldEventSnap.isFiltered());else{var childChangePath=changePath.popFront(),oldChild=oldEventSnap.getNode().getImmediateChild(childKey),newChild=void 0;if(childChangePath.isEmpty())newChild=changedSnap;else{var childNode=source.getCompleteChild(childKey);newChild=null!=childNode?".priority"===childChangePath.getBack()&&childNode.getChild(childChangePath.parent()).isEmpty()?childNode:childNode.updateChild(childChangePath,changedSnap):ChildrenNode.EMPTY_NODE}if(oldChild.equals(newChild))newViewCache=oldViewCache;else{var newEventSnap=this.filter_.updateChild(oldEventSnap.getNode(),childKey,newChild,childChangePath,source,accumulator);newViewCache=oldViewCache.updateEventSnap(newEventSnap,oldEventSnap.isFullyInitialized(),this.filter_.filtersNodes())}}}return newViewCache},ViewProcessor.cacheHasChild_=function(viewCache,childKey){return viewCache.getEventCache().isCompleteForChild(childKey)},ViewProcessor.prototype.applyUserMerge_=function(viewCache,path,changedChildren,writesCache,serverCache,accumulator){var _this=this,curViewCache=viewCache;return changedChildren.foreach(function(relativePath,childNode){var writePath=path.child(relativePath);ViewProcessor.cacheHasChild_(viewCache,writePath.getFront())&&(curViewCache=_this.applyUserOverwrite_(curViewCache,writePath,childNode,writesCache,serverCache,accumulator))}),changedChildren.foreach(function(relativePath,childNode){var writePath=path.child(relativePath);ViewProcessor.cacheHasChild_(viewCache,writePath.getFront())||(curViewCache=_this.applyUserOverwrite_(curViewCache,writePath,childNode,writesCache,serverCache,accumulator))}),curViewCache},ViewProcessor.prototype.applyMerge_=function(node,merge){return merge.foreach(function(relativePath,childNode){node=node.updateChild(relativePath,childNode)}),node},ViewProcessor.prototype.applyServerMerge_=function(viewCache,path,changedChildren,writesCache,serverCache,filterServerNode,accumulator){var _this=this;if(viewCache.getServerCache().getNode().isEmpty()&&!viewCache.getServerCache().isFullyInitialized())return viewCache;var viewMergeTree,curViewCache=viewCache;viewMergeTree=path.isEmpty()?changedChildren:ImmutableTree.Empty.setTree(path,changedChildren);var serverNode=viewCache.getServerCache().getNode();return viewMergeTree.children.inorderTraversal(function(childKey,childTree){if(serverNode.hasChild(childKey)){var serverChild=viewCache.getServerCache().getNode().getImmediateChild(childKey),newChild=_this.applyMerge_(serverChild,childTree);curViewCache=_this.applyServerOverwrite_(curViewCache,new Path(childKey),newChild,writesCache,serverCache,filterServerNode,accumulator)}}),viewMergeTree.children.inorderTraversal(function(childKey,childMergeTree){var isUnknownDeepMerge=!viewCache.getServerCache().isCompleteForChild(childKey)&&null==childMergeTree.value;if(!serverNode.hasChild(childKey)&&!isUnknownDeepMerge){var serverChild=viewCache.getServerCache().getNode().getImmediateChild(childKey),newChild=_this.applyMerge_(serverChild,childMergeTree);curViewCache=_this.applyServerOverwrite_(curViewCache,new Path(childKey),newChild,writesCache,serverCache,filterServerNode,accumulator)}}),curViewCache},ViewProcessor.prototype.ackUserWrite_=function(viewCache,ackPath,affectedTree,writesCache,completeCache,accumulator){if(null!=writesCache.shadowingWrite(ackPath))return viewCache;var filterServerNode=viewCache.getServerCache().isFiltered(),serverCache=viewCache.getServerCache();if(null!=affectedTree.value){if(ackPath.isEmpty()&&serverCache.isFullyInitialized()||serverCache.isCompleteForPath(ackPath))return this.applyServerOverwrite_(viewCache,ackPath,serverCache.getNode().getChild(ackPath),writesCache,completeCache,filterServerNode,accumulator);if(ackPath.isEmpty()){var changedChildren_1=ImmutableTree.Empty;return serverCache.getNode().forEachChild(KEY_INDEX,function(name,node){changedChildren_1=changedChildren_1.set(new Path(name),node)}),this.applyServerMerge_(viewCache,ackPath,changedChildren_1,writesCache,completeCache,filterServerNode,accumulator)}return viewCache}var changedChildren_2=ImmutableTree.Empty;return affectedTree.foreach(function(mergePath,value){var serverCachePath=ackPath.child(mergePath);serverCache.isCompleteForPath(serverCachePath)&&(changedChildren_2=changedChildren_2.set(mergePath,serverCache.getNode().getChild(serverCachePath)))}),this.applyServerMerge_(viewCache,ackPath,changedChildren_2,writesCache,completeCache,filterServerNode,accumulator)},ViewProcessor.prototype.listenComplete_=function(viewCache,path,writesCache,accumulator){var oldServerNode=viewCache.getServerCache(),newViewCache=viewCache.updateServerSnap(oldServerNode.getNode(),oldServerNode.isFullyInitialized()||path.isEmpty(),oldServerNode.isFiltered());return this.generateEventCacheAfterServerEvent_(newViewCache,path,writesCache,NO_COMPLETE_CHILD_SOURCE,accumulator)},ViewProcessor.prototype.revertUserWrite_=function(viewCache,path,writesCache,completeServerCache,accumulator){var complete;if(null!=writesCache.shadowingWrite(path))return viewCache;var source=new WriteTreeCompleteChildSource(writesCache,viewCache,completeServerCache),oldEventCache=viewCache.getEventCache().getNode(),newEventCache=void 0;if(path.isEmpty()||".priority"===path.getFront()){var newNode=void 0;if(viewCache.getServerCache().isFullyInitialized())newNode=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap());else{var serverChildren=viewCache.getServerCache().getNode();util.assert(serverChildren instanceof ChildrenNode,"serverChildren would be complete if leaf node"),newNode=writesCache.calcCompleteEventChildren(serverChildren)}newNode=newNode,newEventCache=this.filter_.updateFullNode(oldEventCache,newNode,accumulator)}else{var childKey=path.getFront(),newChild=writesCache.calcCompleteChild(childKey,viewCache.getServerCache());null==newChild&&viewCache.getServerCache().isCompleteForChild(childKey)&&(newChild=oldEventCache.getImmediateChild(childKey)),(newEventCache=null!=newChild?this.filter_.updateChild(oldEventCache,childKey,newChild,path.popFront(),source,accumulator):viewCache.getEventCache().getNode().hasChild(childKey)?this.filter_.updateChild(oldEventCache,childKey,ChildrenNode.EMPTY_NODE,path.popFront(),source,accumulator):oldEventCache).isEmpty()&&viewCache.getServerCache().isFullyInitialized()&&(complete=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap())).isLeafNode()&&(newEventCache=this.filter_.updateFullNode(newEventCache,complete,accumulator))}return complete=viewCache.getServerCache().isFullyInitialized()||null!=writesCache.shadowingWrite(Path.Empty),viewCache.updateEventSnap(newEventCache,complete,this.filter_.filtersNodes())},ViewProcessor}(),EventGenerator=function(){function EventGenerator(query_){this.query_=query_,this.index_=this.query_.getQueryParams().getIndex()}return EventGenerator.prototype.generateEventsForChanges=function(changes,eventCache,eventRegistrations){var _this=this,events=[],moves=[];return changes.forEach(function(change){change.type===Change.CHILD_CHANGED&&_this.index_.indexedValueChanged(change.oldSnap,change.snapshotNode)&&moves.push(Change.childMovedChange(change.childName,change.snapshotNode))}),this.generateEventsForType_(events,Change.CHILD_REMOVED,changes,eventRegistrations,eventCache),this.generateEventsForType_(events,Change.CHILD_ADDED,changes,eventRegistrations,eventCache),this.generateEventsForType_(events,Change.CHILD_MOVED,moves,eventRegistrations,eventCache),this.generateEventsForType_(events,Change.CHILD_CHANGED,changes,eventRegistrations,eventCache),this.generateEventsForType_(events,Change.VALUE,changes,eventRegistrations,eventCache),events},EventGenerator.prototype.generateEventsForType_=function(events,eventType,changes,registrations,eventCache){var _this=this,filteredChanges=changes.filter(function(change){return change.type===eventType});filteredChanges.sort(this.compareChanges_.bind(this)),filteredChanges.forEach(function(change){var materializedChange=_this.materializeSingleChange_(change,eventCache);registrations.forEach(function(registration){registration.respondsTo(change.type)&&events.push(registration.createEvent(materializedChange,_this.query_))})})},EventGenerator.prototype.materializeSingleChange_=function(change,eventCache){return"value"===change.type||"child_removed"===change.type?change:(change.prevName=eventCache.getPredecessorChildName(change.childName,change.snapshotNode,this.index_),change)},EventGenerator.prototype.compareChanges_=function(a,b){if(null==a.childName||null==b.childName)throw util.assertionError("Should only compare child_ events.");var aWrapped=new NamedNode(a.childName,a.snapshotNode),bWrapped=new NamedNode(b.childName,b.snapshotNode);return this.index_.compare(aWrapped,bWrapped)},EventGenerator}(),View=function(){function View(query_,initialViewCache){this.query_=query_,this.eventRegistrations_=[];var params=this.query_.getQueryParams(),indexFilter=new IndexedFilter(params.getIndex()),filter=params.getNodeFilter();this.processor_=new ViewProcessor(filter);var initialServerCache=initialViewCache.getServerCache(),initialEventCache=initialViewCache.getEventCache(),serverSnap=indexFilter.updateFullNode(ChildrenNode.EMPTY_NODE,initialServerCache.getNode(),null),eventSnap=filter.updateFullNode(ChildrenNode.EMPTY_NODE,initialEventCache.getNode(),null),newServerCache=new CacheNode(serverSnap,initialServerCache.isFullyInitialized(),indexFilter.filtersNodes()),newEventCache=new CacheNode(eventSnap,initialEventCache.isFullyInitialized(),filter.filtersNodes());this.viewCache_=new ViewCache(newEventCache,newServerCache),this.eventGenerator_=new EventGenerator(this.query_)}return View.prototype.getQuery=function(){return this.query_},View.prototype.getServerCache=function(){return this.viewCache_.getServerCache().getNode()},View.prototype.getCompleteServerCache=function(path){var cache=this.viewCache_.getCompleteServerSnap();return cache&&(this.query_.getQueryParams().loadsAllData()||!path.isEmpty()&&!cache.getImmediateChild(path.getFront()).isEmpty())?cache.getChild(path):null},View.prototype.isEmpty=function(){return 0===this.eventRegistrations_.length},View.prototype.addEventRegistration=function(eventRegistration){this.eventRegistrations_.push(eventRegistration)},View.prototype.removeEventRegistration=function(eventRegistration,cancelError){var cancelEvents=[];if(cancelError){util.assert(null==eventRegistration,"A cancel should cancel all event registrations.");var path_1=this.query_.path;this.eventRegistrations_.forEach(function(registration){cancelError=cancelError;var maybeEvent=registration.createCancelEvent(cancelError,path_1);maybeEvent&&cancelEvents.push(maybeEvent)})}if(eventRegistration){for(var remaining=[],i=0;i<this.eventRegistrations_.length;++i){var existing=this.eventRegistrations_[i];if(existing.matches(eventRegistration)){if(eventRegistration.hasAnyCallback()){remaining=remaining.concat(this.eventRegistrations_.slice(i+1));break}}else remaining.push(existing)}this.eventRegistrations_=remaining}else this.eventRegistrations_=[];return cancelEvents},View.prototype.applyOperation=function(operation,writesCache,completeServerCache){operation.type===OperationType.MERGE&&null!==operation.source.queryId&&(util.assert(this.viewCache_.getCompleteServerSnap(),"We should always have a full cache before handling merges"),util.assert(this.viewCache_.getCompleteEventSnap(),"Missing event cache, even though we have a server cache"));var oldViewCache=this.viewCache_,result=this.processor_.applyOperation(oldViewCache,operation,writesCache,completeServerCache);return this.processor_.assertIndexed(result.viewCache),util.assert(result.viewCache.getServerCache().isFullyInitialized()||!oldViewCache.getServerCache().isFullyInitialized(),"Once a server snap is complete, it should never go back"),this.viewCache_=result.viewCache,this.generateEventsForChanges_(result.changes,result.viewCache.getEventCache().getNode(),null)},View.prototype.getInitialEvents=function(registration){var eventSnap=this.viewCache_.getEventCache(),initialChanges=[];eventSnap.getNode().isLeafNode()||eventSnap.getNode().forEachChild(PRIORITY_INDEX,function(key,childNode){initialChanges.push(Change.childAddedChange(key,childNode))});return eventSnap.isFullyInitialized()&&initialChanges.push(Change.valueChange(eventSnap.getNode())),this.generateEventsForChanges_(initialChanges,eventSnap.getNode(),registration)},View.prototype.generateEventsForChanges_=function(changes,eventCache,eventRegistration){var registrations=eventRegistration?[eventRegistration]:this.eventRegistrations_;return this.eventGenerator_.generateEventsForChanges(changes,eventCache,registrations)},View}(),SyncPoint=function(){function SyncPoint(){this.views_={}}return Object.defineProperty(SyncPoint,"__referenceConstructor",{get:function(){return util.assert(__referenceConstructor$1,"Reference.ts has not been loaded"),__referenceConstructor$1},set:function(val){util.assert(!__referenceConstructor$1,"__referenceConstructor has already been defined"),__referenceConstructor$1=val},enumerable:!0,configurable:!0}),SyncPoint.prototype.isEmpty=function(){return util.isEmpty(this.views_)},SyncPoint.prototype.applyOperation=function(operation,writesCache,optCompleteServerCache){var queryId=operation.source.queryId;if(null!==queryId){var view=util.safeGet(this.views_,queryId);return util.assert(null!=view,"SyncTree gave us an op for an invalid query."),view.applyOperation(operation,writesCache,optCompleteServerCache)}var events_1=[];return util.forEach(this.views_,function(key,view){events_1=events_1.concat(view.applyOperation(operation,writesCache,optCompleteServerCache))}),events_1},SyncPoint.prototype.addEventRegistration=function(query,eventRegistration,writesCache,serverCache,serverCacheComplete){var queryId=query.queryIdentifier(),view=util.safeGet(this.views_,queryId);if(!view){var eventCache=writesCache.calcCompleteEventCache(serverCacheComplete?serverCache:null),eventCacheComplete=!1;eventCache?eventCacheComplete=!0:serverCache instanceof ChildrenNode?(eventCache=writesCache.calcCompleteEventChildren(serverCache),eventCacheComplete=!1):(eventCache=ChildrenNode.EMPTY_NODE,eventCacheComplete=!1);var viewCache=new ViewCache(new CacheNode(eventCache,eventCacheComplete,!1),new CacheNode(serverCache,serverCacheComplete,!1));view=new View(query,viewCache),this.views_[queryId]=view}return view.addEventRegistration(eventRegistration),view.getInitialEvents(eventRegistration)},SyncPoint.prototype.removeEventRegistration=function(query,eventRegistration,cancelError){var queryId=query.queryIdentifier(),removed=[],cancelEvents=[],hadCompleteView=this.hasCompleteView();if("default"===queryId){var self_1=this;util.forEach(this.views_,function(viewQueryId,view){cancelEvents=cancelEvents.concat(view.removeEventRegistration(eventRegistration,cancelError)),view.isEmpty()&&(delete self_1.views_[viewQueryId],view.getQuery().getQueryParams().loadsAllData()||removed.push(view.getQuery()))})}else{var view=util.safeGet(this.views_,queryId);view&&(cancelEvents=cancelEvents.concat(view.removeEventRegistration(eventRegistration,cancelError)),view.isEmpty()&&(delete this.views_[queryId],view.getQuery().getQueryParams().loadsAllData()||removed.push(view.getQuery())))}return hadCompleteView&&!this.hasCompleteView()&&removed.push(new SyncPoint.__referenceConstructor(query.repo,query.path)),{removed:removed,events:cancelEvents}},SyncPoint.prototype.getQueryViews=function(){var _this=this;return Object.keys(this.views_).map(function(key){return _this.views_[key]}).filter(function(view){return!view.getQuery().getQueryParams().loadsAllData()})},SyncPoint.prototype.getCompleteServerCache=function(path){var serverCache=null;return util.forEach(this.views_,function(key,view){serverCache=serverCache||view.getCompleteServerCache(path)}),serverCache},SyncPoint.prototype.viewForQuery=function(query){if(query.getQueryParams().loadsAllData())return this.getCompleteView();var queryId=query.queryIdentifier();return util.safeGet(this.views_,queryId)},SyncPoint.prototype.viewExistsForQuery=function(query){return null!=this.viewForQuery(query)},SyncPoint.prototype.hasCompleteView=function(){return null!=this.getCompleteView()},SyncPoint.prototype.getCompleteView=function(){return util.findValue(this.views_,function(view){return view.getQuery().getQueryParams().loadsAllData()})||null},SyncPoint}(),CompoundWrite=function(){function CompoundWrite(writeTree_){this.writeTree_=writeTree_}return CompoundWrite.prototype.addWrite=function(path,node){if(path.isEmpty())return new CompoundWrite(new ImmutableTree(node));var rootmost=this.writeTree_.findRootMostValueAndPath(path);if(null!=rootmost){var rootMostPath=rootmost.path,value=rootmost.value,relativePath=Path.relativePath(rootMostPath,path);return value=value.updateChild(relativePath,node),new CompoundWrite(this.writeTree_.set(rootMostPath,value))}var subtree=new ImmutableTree(node);return new CompoundWrite(this.writeTree_.setTree(path,subtree))},CompoundWrite.prototype.addWrites=function(path,updates){var newWrite=this;return util.forEach(updates,function(childKey,node){newWrite=newWrite.addWrite(path.child(childKey),node)}),newWrite},CompoundWrite.prototype.removeWrite=function(path){return path.isEmpty()?CompoundWrite.Empty:new CompoundWrite(this.writeTree_.setTree(path,ImmutableTree.Empty))},CompoundWrite.prototype.hasCompleteWrite=function(path){return null!=this.getCompleteNode(path)},CompoundWrite.prototype.getCompleteNode=function(path){var rootmost=this.writeTree_.findRootMostValueAndPath(path);return null!=rootmost?this.writeTree_.get(rootmost.path).getChild(Path.relativePath(rootmost.path,path)):null},CompoundWrite.prototype.getCompleteChildren=function(){var children=[],node=this.writeTree_.value;return null!=node?node.isLeafNode()||node.forEachChild(PRIORITY_INDEX,function(childName,childNode){children.push(new NamedNode(childName,childNode))}):this.writeTree_.children.inorderTraversal(function(childName,childTree){null!=childTree.value&&children.push(new NamedNode(childName,childTree.value))}),children},CompoundWrite.prototype.childCompoundWrite=function(path){if(path.isEmpty())return this;var shadowingNode=this.getCompleteNode(path);return new CompoundWrite(null!=shadowingNode?new ImmutableTree(shadowingNode):this.writeTree_.subtree(path))},CompoundWrite.prototype.isEmpty=function(){return this.writeTree_.isEmpty()},CompoundWrite.prototype.apply=function(node){return CompoundWrite.applySubtreeWrite_(Path.Empty,this.writeTree_,node)},CompoundWrite.Empty=new CompoundWrite(new ImmutableTree(null)),CompoundWrite.applySubtreeWrite_=function(relativePath,writeTree,node){if(null!=writeTree.value)return node.updateChild(relativePath,writeTree.value);var priorityWrite_1=null;return writeTree.children.inorderTraversal(function(childKey,childTree){".priority"===childKey?(util.assert(null!==childTree.value,"Priority writes must always be leaf nodes"),priorityWrite_1=childTree.value):node=CompoundWrite.applySubtreeWrite_(relativePath.child(childKey),childTree,node)}),node.getChild(relativePath).isEmpty()||null===priorityWrite_1||(node=node.updateChild(relativePath.child(".priority"),priorityWrite_1)),node},CompoundWrite}(),WriteTree=function(){function WriteTree(){this.visibleWrites_=CompoundWrite.Empty,this.allWrites_=[],this.lastWriteId_=-1}return WriteTree.prototype.childWrites=function(path){return new WriteTreeRef(path,this)},WriteTree.prototype.addOverwrite=function(path,snap,writeId,visible){util.assert(writeId>this.lastWriteId_,"Stacking an older write on top of newer ones"),void 0===visible&&(visible=!0),this.allWrites_.push({path:path,snap:snap,writeId:writeId,visible:visible}),visible&&(this.visibleWrites_=this.visibleWrites_.addWrite(path,snap)),this.lastWriteId_=writeId},WriteTree.prototype.addMerge=function(path,changedChildren,writeId){util.assert(writeId>this.lastWriteId_,"Stacking an older merge on top of newer ones"),this.allWrites_.push({path:path,children:changedChildren,writeId:writeId,visible:!0}),this.visibleWrites_=this.visibleWrites_.addWrites(path,changedChildren),this.lastWriteId_=writeId},WriteTree.prototype.getWrite=function(writeId){for(var i=0;i<this.allWrites_.length;i++){var record=this.allWrites_[i];if(record.writeId===writeId)return record}return null},WriteTree.prototype.removeWrite=function(writeId){var _this=this,idx=this.allWrites_.findIndex(function(s){return s.writeId===writeId});util.assert(idx>=0,"removeWrite called with nonexistent writeId.");var writeToRemove=this.allWrites_[idx];this.allWrites_.splice(idx,1);for(var removedWriteWasVisible=writeToRemove.visible,removedWriteOverlapsWithOtherWrites=!1,i=this.allWrites_.length-1;removedWriteWasVisible&&i>=0;){var currentWrite=this.allWrites_[i];currentWrite.visible&&(i>=idx&&this.recordContainsPath_(currentWrite,writeToRemove.path)?removedWriteWasVisible=!1:writeToRemove.path.contains(currentWrite.path)&&(removedWriteOverlapsWithOtherWrites=!0)),i--}if(removedWriteWasVisible){if(removedWriteOverlapsWithOtherWrites)return this.resetTree_(),!0;if(writeToRemove.snap)this.visibleWrites_=this.visibleWrites_.removeWrite(writeToRemove.path);else{var children=writeToRemove.children;util.forEach(children,function(childName){_this.visibleWrites_=_this.visibleWrites_.removeWrite(writeToRemove.path.child(childName))})}return!0}return!1},WriteTree.prototype.getCompleteWriteData=function(path){return this.visibleWrites_.getCompleteNode(path)},WriteTree.prototype.calcCompleteEventCache=function(treePath,completeServerCache,writeIdsToExclude,includeHiddenWrites){if(writeIdsToExclude||includeHiddenWrites){var merge=this.visibleWrites_.childCompoundWrite(treePath);if(!includeHiddenWrites&&merge.isEmpty())return completeServerCache;if(includeHiddenWrites||null!=completeServerCache||merge.hasCompleteWrite(Path.Empty)){var mergeAtPath=WriteTree.layerTree_(this.allWrites_,function(write){return(write.visible||includeHiddenWrites)&&(!writeIdsToExclude||!~writeIdsToExclude.indexOf(write.writeId))&&(write.path.contains(treePath)||treePath.contains(write.path))},treePath);layeredCache=completeServerCache||ChildrenNode.EMPTY_NODE;return mergeAtPath.apply(layeredCache)}return null}var shadowingNode=this.visibleWrites_.getCompleteNode(treePath);if(null!=shadowingNode)return shadowingNode;var subMerge=this.visibleWrites_.childCompoundWrite(treePath);if(subMerge.isEmpty())return completeServerCache;if(null!=completeServerCache||subMerge.hasCompleteWrite(Path.Empty)){var layeredCache=completeServerCache||ChildrenNode.EMPTY_NODE;return subMerge.apply(layeredCache)}return null},WriteTree.prototype.calcCompleteEventChildren=function(treePath,completeServerChildren){var completeChildren=ChildrenNode.EMPTY_NODE,topLevelSet=this.visibleWrites_.getCompleteNode(treePath);if(topLevelSet)return topLevelSet.isLeafNode()||topLevelSet.forEachChild(PRIORITY_INDEX,function(childName,childSnap){completeChildren=completeChildren.updateImmediateChild(childName,childSnap)}),completeChildren;if(completeServerChildren){var merge_1=this.visibleWrites_.childCompoundWrite(treePath);return completeServerChildren.forEachChild(PRIORITY_INDEX,function(childName,childNode){var node=merge_1.childCompoundWrite(new Path(childName)).apply(childNode);completeChildren=completeChildren.updateImmediateChild(childName,node)}),merge_1.getCompleteChildren().forEach(function(namedNode){completeChildren=completeChildren.updateImmediateChild(namedNode.name,namedNode.node)}),completeChildren}return this.visibleWrites_.childCompoundWrite(treePath).getCompleteChildren().forEach(function(namedNode){completeChildren=completeChildren.updateImmediateChild(namedNode.name,namedNode.node)}),completeChildren},WriteTree.prototype.calcEventCacheAfterServerOverwrite=function(treePath,childPath,existingEventSnap,existingServerSnap){util.assert(existingEventSnap||existingServerSnap,"Either existingEventSnap or existingServerSnap must exist");var path=treePath.child(childPath);if(this.visibleWrites_.hasCompleteWrite(path))return null;var childMerge=this.visibleWrites_.childCompoundWrite(path);return childMerge.isEmpty()?existingServerSnap.getChild(childPath):childMerge.apply(existingServerSnap.getChild(childPath))},WriteTree.prototype.calcCompleteChild=function(treePath,childKey,existingServerSnap){var path=treePath.child(childKey),shadowingNode=this.visibleWrites_.getCompleteNode(path);return null!=shadowingNode?shadowingNode:existingServerSnap.isCompleteForChild(childKey)?this.visibleWrites_.childCompoundWrite(path).apply(existingServerSnap.getNode().getImmediateChild(childKey)):null},WriteTree.prototype.shadowingWrite=function(path){return this.visibleWrites_.getCompleteNode(path)},WriteTree.prototype.calcIndexedSlice=function(treePath,completeServerData,startPost,count,reverse,index){var toIterate,merge=this.visibleWrites_.childCompoundWrite(treePath),shadowingNode=merge.getCompleteNode(Path.Empty);if(null!=shadowingNode)toIterate=shadowingNode;else{if(null==completeServerData)return[];toIterate=merge.apply(completeServerData)}if((toIterate=toIterate.withIndex(index)).isEmpty()||toIterate.isLeafNode())return[];for(var nodes=[],cmp=index.getCompare(),iter=reverse?toIterate.getReverseIteratorFrom(startPost,index):toIterate.getIteratorFrom(startPost,index),next=iter.getNext();next&&nodes.length<count;)0!==cmp(next,startPost)&&nodes.push(next),next=iter.getNext();return nodes},WriteTree.prototype.recordContainsPath_=function(writeRecord,path){return writeRecord.snap?writeRecord.path.contains(path):!!util.findKey(writeRecord.children,function(childSnap,childName){return writeRecord.path.child(childName).contains(path)})},WriteTree.prototype.resetTree_=function(){this.visibleWrites_=WriteTree.layerTree_(this.allWrites_,WriteTree.DefaultFilter_,Path.Empty),this.allWrites_.length>0?this.lastWriteId_=this.allWrites_[this.allWrites_.length-1].writeId:this.lastWriteId_=-1},WriteTree.DefaultFilter_=function(write){return write.visible},WriteTree.layerTree_=function(writes,filter,treeRoot){for(var compoundWrite=CompoundWrite.Empty,i=0;i<writes.length;++i){var write=writes[i];if(filter(write)){var writePath=write.path,relativePath=void 0;if(write.snap)treeRoot.contains(writePath)?(relativePath=Path.relativePath(treeRoot,writePath),compoundWrite=compoundWrite.addWrite(relativePath,write.snap)):writePath.contains(treeRoot)&&(relativePath=Path.relativePath(writePath,treeRoot),compoundWrite=compoundWrite.addWrite(Path.Empty,write.snap.getChild(relativePath)));else{if(!write.children)throw util.assertionError("WriteRecord should have .snap or .children");if(treeRoot.contains(writePath))relativePath=Path.relativePath(treeRoot,writePath),compoundWrite=compoundWrite.addWrites(relativePath,write.children);else if(writePath.contains(treeRoot))if((relativePath=Path.relativePath(writePath,treeRoot)).isEmpty())compoundWrite=compoundWrite.addWrites(Path.Empty,write.children);else{var child=util.safeGet(write.children,relativePath.getFront());if(child){var deepNode=child.getChild(relativePath.popFront());compoundWrite=compoundWrite.addWrite(Path.Empty,deepNode)}}}}}return compoundWrite},WriteTree}(),WriteTreeRef=function(){function WriteTreeRef(path,writeTree){this.treePath_=path,this.writeTree_=writeTree}return WriteTreeRef.prototype.calcCompleteEventCache=function(completeServerCache,writeIdsToExclude,includeHiddenWrites){return this.writeTree_.calcCompleteEventCache(this.treePath_,completeServerCache,writeIdsToExclude,includeHiddenWrites)},WriteTreeRef.prototype.calcCompleteEventChildren=function(completeServerChildren){return this.writeTree_.calcCompleteEventChildren(this.treePath_,completeServerChildren)},WriteTreeRef.prototype.calcEventCacheAfterServerOverwrite=function(path,existingEventSnap,existingServerSnap){return this.writeTree_.calcEventCacheAfterServerOverwrite(this.treePath_,path,existingEventSnap,existingServerSnap)},WriteTreeRef.prototype.shadowingWrite=function(path){return this.writeTree_.shadowingWrite(this.treePath_.child(path))},WriteTreeRef.prototype.calcIndexedSlice=function(completeServerData,startPost,count,reverse,index){return this.writeTree_.calcIndexedSlice(this.treePath_,completeServerData,startPost,count,reverse,index)},WriteTreeRef.prototype.calcCompleteChild=function(childKey,existingServerCache){return this.writeTree_.calcCompleteChild(this.treePath_,childKey,existingServerCache)},WriteTreeRef.prototype.child=function(childName){return new WriteTreeRef(this.treePath_.child(childName),this.writeTree_)},WriteTreeRef}(),SyncTree=function(){function SyncTree(listenProvider_){this.listenProvider_=listenProvider_,this.syncPointTree_=ImmutableTree.Empty,this.pendingWriteTree_=new WriteTree,this.tagToQueryMap_={},this.queryToTagMap_={}}return SyncTree.prototype.applyUserOverwrite=function(path,newData,writeId,visible){return this.pendingWriteTree_.addOverwrite(path,newData,writeId,visible),visible?this.applyOperationToSyncPoints_(new Overwrite(OperationSource.User,path,newData)):[]},SyncTree.prototype.applyUserMerge=function(path,changedChildren,writeId){this.pendingWriteTree_.addMerge(path,changedChildren,writeId);var changeTree=ImmutableTree.fromObject(changedChildren);return this.applyOperationToSyncPoints_(new Merge(OperationSource.User,path,changeTree))},SyncTree.prototype.ackUserWrite=function(writeId,revert){void 0===revert&&(revert=!1);var write=this.pendingWriteTree_.getWrite(writeId);if(this.pendingWriteTree_.removeWrite(writeId)){var affectedTree_1=ImmutableTree.Empty;return null!=write.snap?affectedTree_1=affectedTree_1.set(Path.Empty,!0):util.forEach(write.children,function(pathString,node){affectedTree_1=affectedTree_1.set(new Path(pathString),node)}),this.applyOperationToSyncPoints_(new AckUserWrite(write.path,affectedTree_1,revert))}return[]},SyncTree.prototype.applyServerOverwrite=function(path,newData){return this.applyOperationToSyncPoints_(new Overwrite(OperationSource.Server,path,newData))},SyncTree.prototype.applyServerMerge=function(path,changedChildren){var changeTree=ImmutableTree.fromObject(changedChildren);return this.applyOperationToSyncPoints_(new Merge(OperationSource.Server,path,changeTree))},SyncTree.prototype.applyListenComplete=function(path){return this.applyOperationToSyncPoints_(new ListenComplete(OperationSource.Server,path))},SyncTree.prototype.applyTaggedQueryOverwrite=function(path,snap,tag){var queryKey=this.queryKeyForTag_(tag);if(null!=queryKey){var r=SyncTree.parseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=Path.relativePath(queryPath,path),op=new Overwrite(OperationSource.forServerTaggedQuery(queryId),relativePath,snap);return this.applyTaggedOperation_(queryPath,op)}return[]},SyncTree.prototype.applyTaggedQueryMerge=function(path,changedChildren,tag){var queryKey=this.queryKeyForTag_(tag);if(queryKey){var r=SyncTree.parseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=Path.relativePath(queryPath,path),changeTree=ImmutableTree.fromObject(changedChildren),op=new Merge(OperationSource.forServerTaggedQuery(queryId),relativePath,changeTree);return this.applyTaggedOperation_(queryPath,op)}return[]},SyncTree.prototype.applyTaggedListenComplete=function(path,tag){var queryKey=this.queryKeyForTag_(tag);if(queryKey){var r=SyncTree.parseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=Path.relativePath(queryPath,path),op=new ListenComplete(OperationSource.forServerTaggedQuery(queryId),relativePath);return this.applyTaggedOperation_(queryPath,op)}return[]},SyncTree.prototype.addEventRegistration=function(query,eventRegistration){var path=query.path,serverCache=null,foundAncestorDefaultView=!1;this.syncPointTree_.foreachOnPath(path,function(pathToSyncPoint,sp){var relativePath=Path.relativePath(pathToSyncPoint,path);serverCache=serverCache||sp.getCompleteServerCache(relativePath),foundAncestorDefaultView=foundAncestorDefaultView||sp.hasCompleteView()});var serverCacheComplete,syncPoint=this.syncPointTree_.get(path);(syncPoint?(foundAncestorDefaultView=foundAncestorDefaultView||syncPoint.hasCompleteView(),serverCache=serverCache||syncPoint.getCompleteServerCache(Path.Empty)):(syncPoint=new SyncPoint,this.syncPointTree_=this.syncPointTree_.set(path,syncPoint)),null!=serverCache)?serverCacheComplete=!0:(serverCacheComplete=!1,serverCache=ChildrenNode.EMPTY_NODE,this.syncPointTree_.subtree(path).foreachChild(function(childName,childSyncPoint){var completeCache=childSyncPoint.getCompleteServerCache(Path.Empty);completeCache&&(serverCache=serverCache.updateImmediateChild(childName,completeCache))}));var viewAlreadyExists=syncPoint.viewExistsForQuery(query);if(!viewAlreadyExists&&!query.getQueryParams().loadsAllData()){var queryKey=SyncTree.makeQueryKey_(query);util.assert(!(queryKey in this.queryToTagMap_),"View does not exist, but we have a tag");var tag=SyncTree.getNextQueryTag_();this.queryToTagMap_[queryKey]=tag,this.tagToQueryMap_["_"+tag]=queryKey}var writesCache=this.pendingWriteTree_.childWrites(path),events=syncPoint.addEventRegistration(query,eventRegistration,writesCache,serverCache,serverCacheComplete);if(!viewAlreadyExists&&!foundAncestorDefaultView){var view=syncPoint.viewForQuery(query);events=events.concat(this.setupListener_(query,view))}return events},SyncTree.prototype.removeEventRegistration=function(query,eventRegistration,cancelError){var _this=this,path=query.path,maybeSyncPoint=this.syncPointTree_.get(path),cancelEvents=[];if(maybeSyncPoint&&("default"===query.queryIdentifier()||maybeSyncPoint.viewExistsForQuery(query))){var removedAndEvents=maybeSyncPoint.removeEventRegistration(query,eventRegistration,cancelError);maybeSyncPoint.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(path));var removed=removedAndEvents.removed;cancelEvents=removedAndEvents.events;var removingDefault=-1!==removed.findIndex(function(query){return query.getQueryParams().loadsAllData()}),covered=this.syncPointTree_.findOnPath(path,function(relativePath,parentSyncPoint){return parentSyncPoint.hasCompleteView()});if(removingDefault&&!covered){var subtree=this.syncPointTree_.subtree(path);if(!subtree.isEmpty())for(var newViews=this.collectDistinctViewsForSubTree_(subtree),i=0;i<newViews.length;++i){var view=newViews[i],newQuery=view.getQuery(),listener=this.createListenerForView_(view);this.listenProvider_.startListening(SyncTree.queryForListening_(newQuery),this.tagForQuery_(newQuery),listener.hashFn,listener.onComplete)}}if(!covered&&removed.length>0&&!cancelError)if(removingDefault){this.listenProvider_.stopListening(SyncTree.queryForListening_(query),null)}else removed.forEach(function(queryToRemove){var tagToRemove=_this.queryToTagMap_[SyncTree.makeQueryKey_(queryToRemove)];_this.listenProvider_.stopListening(SyncTree.queryForListening_(queryToRemove),tagToRemove)});this.removeTags_(removed)}return cancelEvents},SyncTree.prototype.calcCompleteEventCache=function(path,writeIdsToExclude){var writeTree=this.pendingWriteTree_,serverCache=this.syncPointTree_.findOnPath(path,function(pathSoFar,syncPoint){var relativePath=Path.relativePath(pathSoFar,path),serverCache=syncPoint.getCompleteServerCache(relativePath);if(serverCache)return serverCache});return writeTree.calcCompleteEventCache(path,serverCache,writeIdsToExclude,!0)},SyncTree.prototype.collectDistinctViewsForSubTree_=function(subtree){return subtree.fold(function(relativePath,maybeChildSyncPoint,childMap){if(maybeChildSyncPoint&&maybeChildSyncPoint.hasCompleteView())return[maybeChildSyncPoint.getCompleteView()];var views_1=[];return maybeChildSyncPoint&&(views_1=maybeChildSyncPoint.getQueryViews()),util.forEach(childMap,function(key,childViews){views_1=views_1.concat(childViews)}),views_1})},SyncTree.prototype.removeTags_=function(queries){for(var j=0;j<queries.length;++j){var removedQuery=queries[j];if(!removedQuery.getQueryParams().loadsAllData()){var removedQueryKey=SyncTree.makeQueryKey_(removedQuery),removedQueryTag=this.queryToTagMap_[removedQueryKey];delete this.queryToTagMap_[removedQueryKey],delete this.tagToQueryMap_["_"+removedQueryTag]}}},SyncTree.queryForListening_=function(query){return query.getQueryParams().loadsAllData()&&!query.getQueryParams().isDefault()?query.getRef():query},SyncTree.prototype.setupListener_=function(query,view){var path=query.path,tag=this.tagForQuery_(query),listener=this.createListenerForView_(view),events=this.listenProvider_.startListening(SyncTree.queryForListening_(query),tag,listener.hashFn,listener.onComplete),subtree=this.syncPointTree_.subtree(path);if(tag)util.assert(!subtree.value.hasCompleteView(),"If we're adding a query, it shouldn't be shadowed");else for(var queriesToStop=subtree.fold(function(relativePath,maybeChildSyncPoint,childMap){if(!relativePath.isEmpty()&&maybeChildSyncPoint&&maybeChildSyncPoint.hasCompleteView())return[maybeChildSyncPoint.getCompleteView().getQuery()];var queries_1=[];return maybeChildSyncPoint&&(queries_1=queries_1.concat(maybeChildSyncPoint.getQueryViews().map(function(view){return view.getQuery()}))),util.forEach(childMap,function(key,childQueries){queries_1=queries_1.concat(childQueries)}),queries_1}),i=0;i<queriesToStop.length;++i){var queryToStop=queriesToStop[i];this.listenProvider_.stopListening(SyncTree.queryForListening_(queryToStop),this.tagForQuery_(queryToStop))}return events},SyncTree.prototype.createListenerForView_=function(view){var _this=this,query=view.getQuery(),tag=this.tagForQuery_(query);return{hashFn:function(){return(view.getServerCache()||ChildrenNode.EMPTY_NODE).hash()},onComplete:function(status){if("ok"===status)return tag?_this.applyTaggedListenComplete(query.path,tag):_this.applyListenComplete(query.path);var error=function(code,query){var reason="Unknown Error";"too_big"===code?reason="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"==code?reason="Client doesn't have permission to access the desired data.":"unavailable"==code&&(reason="The service is unavailable");var error=new Error(code+" at "+query.path.toString()+": "+reason);return error.code=code.toUpperCase(),error}(status,query);return _this.removeEventRegistration(query,null,error)}}},SyncTree.makeQueryKey_=function(query){return query.path.toString()+"$"+query.queryIdentifier()},SyncTree.parseQueryKey_=function(queryKey){var splitIndex=queryKey.indexOf("$");return util.assert(-1!==splitIndex&&splitIndex<queryKey.length-1,"Bad queryKey."),{queryId:queryKey.substr(splitIndex+1),path:new Path(queryKey.substr(0,splitIndex))}},SyncTree.prototype.queryKeyForTag_=function(tag){return this.tagToQueryMap_["_"+tag]},SyncTree.prototype.tagForQuery_=function(query){var queryKey=SyncTree.makeQueryKey_(query);return util.safeGet(this.queryToTagMap_,queryKey)},SyncTree.getNextQueryTag_=function(){return SyncTree.nextQueryTag_++},SyncTree.prototype.applyTaggedOperation_=function(queryPath,operation){var syncPoint=this.syncPointTree_.get(queryPath);util.assert(syncPoint,"Missing sync point for query tag that we're tracking");var writesCache=this.pendingWriteTree_.childWrites(queryPath);return syncPoint.applyOperation(operation,writesCache,null)},SyncTree.prototype.applyOperationToSyncPoints_=function(operation){return this.applyOperationHelper_(operation,this.syncPointTree_,null,this.pendingWriteTree_.childWrites(Path.Empty))},SyncTree.prototype.applyOperationHelper_=function(operation,syncPointTree,serverCache,writesCache){if(operation.path.isEmpty())return this.applyOperationDescendantsHelper_(operation,syncPointTree,serverCache,writesCache);var syncPoint=syncPointTree.get(Path.Empty);null==serverCache&&null!=syncPoint&&(serverCache=syncPoint.getCompleteServerCache(Path.Empty));var events=[],childName=operation.path.getFront(),childOperation=operation.operationForChild(childName),childTree=syncPointTree.children.get(childName);if(childTree&&childOperation){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null,childWritesCache=writesCache.child(childName);events=events.concat(this.applyOperationHelper_(childOperation,childTree,childServerCache,childWritesCache))}return syncPoint&&(events=events.concat(syncPoint.applyOperation(operation,writesCache,serverCache))),events},SyncTree.prototype.applyOperationDescendantsHelper_=function(operation,syncPointTree,serverCache,writesCache){var _this=this,syncPoint=syncPointTree.get(Path.Empty);null==serverCache&&null!=syncPoint&&(serverCache=syncPoint.getCompleteServerCache(Path.Empty));var events=[];return syncPointTree.children.inorderTraversal(function(childName,childTree){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null,childWritesCache=writesCache.child(childName),childOperation=operation.operationForChild(childName);childOperation&&(events=events.concat(_this.applyOperationDescendantsHelper_(childOperation,childTree,childServerCache,childWritesCache)))}),syncPoint&&(events=events.concat(syncPoint.applyOperation(operation,writesCache,serverCache))),events},SyncTree.nextQueryTag_=1,SyncTree}(),SnapshotHolder=function(){function SnapshotHolder(){this.rootNode_=ChildrenNode.EMPTY_NODE}return SnapshotHolder.prototype.getNode=function(path){return this.rootNode_.getChild(path)},SnapshotHolder.prototype.updateSnapshot=function(path,newSnapshotNode){this.rootNode_=this.rootNode_.updateChild(path,newSnapshotNode)},SnapshotHolder}(),AuthTokenProvider=function(){function AuthTokenProvider(app_){this.app_=app_}return AuthTokenProvider.prototype.getToken=function(forceRefresh){return this.app_.INTERNAL.getToken(forceRefresh).then(null,function(error){return error&&"auth/token-not-initialized"===error.code?(log("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(error)})},AuthTokenProvider.prototype.addTokenChangeListener=function(listener){this.app_.INTERNAL.addAuthTokenListener(listener)},AuthTokenProvider.prototype.removeTokenChangeListener=function(listener){this.app_.INTERNAL.removeAuthTokenListener(listener)},AuthTokenProvider.prototype.notifyForInvalidToken=function(){var errorMessage='Provided authentication credentials for the app named "'+this.app_.name+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.app_.options?errorMessage+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.app_.options?errorMessage+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':errorMessage+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',warn(errorMessage)},AuthTokenProvider}(),StatsCollection=function(){function StatsCollection(){this.counters_={}}return StatsCollection.prototype.incrementCounter=function(name,amount){void 0===amount&&(amount=1),util.contains(this.counters_,name)||(this.counters_[name]=0),this.counters_[name]+=amount},StatsCollection.prototype.get=function(){return util.deepCopy(this.counters_)},StatsCollection}(),StatsManager=function(){function StatsManager(){}return StatsManager.getCollection=function(repoInfo){var hashString=repoInfo.toString();return this.collections_[hashString]||(this.collections_[hashString]=new StatsCollection),this.collections_[hashString]},StatsManager.getOrCreateReporter=function(repoInfo,creatorFunction){var hashString=repoInfo.toString();return this.reporters_[hashString]||(this.reporters_[hashString]=creatorFunction()),this.reporters_[hashString]},StatsManager.collections_={},StatsManager.reporters_={},StatsManager}(),StatsListener=function(){function StatsListener(collection_){this.collection_=collection_,this.last_=null}return StatsListener.prototype.get=function(){var newStats=this.collection_.get(),delta=util.clone(newStats);return this.last_&&util.forEach(this.last_,function(stat,value){delta[stat]=delta[stat]-value}),this.last_=newStats,delta},StatsListener}(),FIRST_STATS_MIN_TIME=1e4,FIRST_STATS_MAX_TIME=3e4,StatsReporter=function(){function StatsReporter(collection,server_){this.server_=server_,this.statsToReport_={},this.statsListener_=new StatsListener(collection);var timeout=FIRST_STATS_MIN_TIME+(FIRST_STATS_MAX_TIME-FIRST_STATS_MIN_TIME)*Math.random();setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(timeout))}return StatsReporter.prototype.includeStat=function(stat){this.statsToReport_[stat]=!0},StatsReporter.prototype.reportStats_=function(){var _this=this,stats=this.statsListener_.get(),reportedStats={},haveStatsToReport=!1;util.forEach(stats,function(stat,value){value>0&&util.contains(_this.statsToReport_,stat)&&(reportedStats[stat]=value,haveStatsToReport=!0)}),haveStatsToReport&&this.server_.reportStats(reportedStats),setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},StatsReporter}(),EventQueue=function(){function EventQueue(){this.eventLists_=[],this.recursionDepth_=0}return EventQueue.prototype.queueEvents=function(eventDataList){for(var currList=null,i=0;i<eventDataList.length;i++){var eventData=eventDataList[i],eventPath=eventData.getPath();null===currList||eventPath.equals(currList.getPath())||(this.eventLists_.push(currList),currList=null),null===currList&&(currList=new EventList(eventPath)),currList.add(eventData)}currList&&this.eventLists_.push(currList)},EventQueue.prototype.raiseEventsAtPath=function(path,eventDataList){this.queueEvents(eventDataList),this.raiseQueuedEventsMatchingPredicate_(function(eventPath){return eventPath.equals(path)})},EventQueue.prototype.raiseEventsForChangedPath=function(changedPath,eventDataList){this.queueEvents(eventDataList),this.raiseQueuedEventsMatchingPredicate_(function(eventPath){return eventPath.contains(changedPath)||changedPath.contains(eventPath)})},EventQueue.prototype.raiseQueuedEventsMatchingPredicate_=function(predicate){this.recursionDepth_++;for(var sentAll=!0,i=0;i<this.eventLists_.length;i++){var eventList=this.eventLists_[i];if(eventList)predicate(eventList.getPath())?(this.eventLists_[i].raise(),this.eventLists_[i]=null):sentAll=!1}sentAll&&(this.eventLists_=[]),this.recursionDepth_--},EventQueue}(),EventList=function(){function EventList(path_){this.path_=path_,this.events_=[]}return EventList.prototype.add=function(eventData){this.events_.push(eventData)},EventList.prototype.raise=function(){for(var i=0;i<this.events_.length;i++){var eventData=this.events_[i];if(null!==eventData){this.events_[i]=null;var eventFn=eventData.getEventRunner();logger&&log("event: "+eventData.toString()),exceptionGuard(eventFn)}}},EventList.prototype.getPath=function(){return this.path_},EventList}(),EventEmitter=function(){function EventEmitter(allowedEvents_){this.allowedEvents_=allowedEvents_,this.listeners_={},util.assert(Array.isArray(allowedEvents_)&&allowedEvents_.length>0,"Requires a non-empty array")}return EventEmitter.prototype.trigger=function(eventType){for(var var_args=[],_i=1;_i<arguments.length;_i++)var_args[_i-1]=arguments[_i];if(Array.isArray(this.listeners_[eventType]))for(var listeners=this.listeners_[eventType].slice(),i=0;i<listeners.length;i++)listeners[i].callback.apply(listeners[i].context,var_args)},EventEmitter.prototype.on=function(eventType,callback,context){this.validateEventType_(eventType),this.listeners_[eventType]=this.listeners_[eventType]||[],this.listeners_[eventType].push({callback:callback,context:context});var eventData=this.getInitialEvent(eventType);eventData&&callback.apply(context,eventData)},EventEmitter.prototype.off=function(eventType,callback,context){this.validateEventType_(eventType);for(var listeners=this.listeners_[eventType]||[],i=0;i<listeners.length;i++)if(listeners[i].callback===callback&&(!context||context===listeners[i].context))return void listeners.splice(i,1)},EventEmitter.prototype.validateEventType_=function(eventType){util.assert(this.allowedEvents_.find(function(et){return et===eventType}),"Unknown event: "+eventType)},EventEmitter}(),VisibilityMonitor=function(_super){function VisibilityMonitor(){var hidden,visibilityChange,_this=_super.call(this,["visible"])||this;return"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(visibilityChange="visibilitychange",hidden="hidden"):void 0!==document.mozHidden?(visibilityChange="mozvisibilitychange",hidden="mozHidden"):void 0!==document.msHidden?(visibilityChange="msvisibilitychange",hidden="msHidden"):void 0!==document.webkitHidden&&(visibilityChange="webkitvisibilitychange",hidden="webkitHidden")),_this.visible_=!0,visibilityChange&&document.addEventListener(visibilityChange,function(){var visible=!document[hidden];visible!==_this.visible_&&(_this.visible_=visible,_this.trigger("visible",visible))},!1),_this}return tslib_1.__extends(VisibilityMonitor,_super),VisibilityMonitor.getInstance=function(){return new VisibilityMonitor},VisibilityMonitor.prototype.getInitialEvent=function(eventType){return util.assert("visible"===eventType,"Unknown event type: "+eventType),[this.visible_]},VisibilityMonitor}(EventEmitter),OnlineMonitor=function(_super){function OnlineMonitor(){var _this=_super.call(this,["online"])||this;return _this.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||util.isMobileCordova()||(window.addEventListener("online",function(){_this.online_||(_this.online_=!0,_this.trigger("online",!0))},!1),window.addEventListener("offline",function(){_this.online_&&(_this.online_=!1,_this.trigger("online",!1))},!1)),_this}return tslib_1.__extends(OnlineMonitor,_super),OnlineMonitor.getInstance=function(){return new OnlineMonitor},OnlineMonitor.prototype.getInitialEvent=function(eventType){return util.assert("online"===eventType,"Unknown event type: "+eventType),[this.online_]},OnlineMonitor.prototype.currentlyOnline=function(){return this.online_},OnlineMonitor}(EventEmitter),PacketReceiver=function(){function PacketReceiver(onMessage_){this.onMessage_=onMessage_,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}return PacketReceiver.prototype.closeAfter=function(responseNum,callback){this.closeAfterResponse=responseNum,this.onClose=callback,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},PacketReceiver.prototype.handleResponse=function(requestNum,data){var _this=this;this.pendingResponses[requestNum]=data;for(var _loop_1=function(){var toProcess=this_1.pendingResponses[this_1.currentResponseNum];delete this_1.pendingResponses[this_1.currentResponseNum];for(var _loop_2=function(i){toProcess[i]&&exceptionGuard(function(){_this.onMessage_(toProcess[i])})},i=0;i<toProcess.length;++i)_loop_2(i);if(this_1.currentResponseNum===this_1.closeAfterResponse)return this_1.onClose&&(this_1.onClose(),this_1.onClose=null),"break";this_1.currentResponseNum++},this_1=this;this.pendingResponses[this.currentResponseNum];){if("break"===_loop_1())break}},PacketReceiver}(),FIREBASE_LONGPOLL_COMMAND_CB_NAME="pLPCommand",FIREBASE_LONGPOLL_DATA_CB_NAME="pRTLPCB",BrowserPollConnection=function(){function BrowserPollConnection(connId,repoInfo,transportSessionId,lastSessionId){this.connId=connId,this.repoInfo=repoInfo,this.transportSessionId=transportSessionId,this.lastSessionId=lastSessionId,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=logWrapper(connId),this.stats_=StatsManager.getCollection(repoInfo),this.urlFn=function(params){return repoInfo.connectionURL(LONG_POLLING,params)}}return BrowserPollConnection.prototype.open=function(onMessage,onDisconnect){var _this=this;this.curSegmentNum=0,this.onDisconnect_=onDisconnect,this.myPacketOrderer=new PacketReceiver(onMessage),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(function(){_this.log_("Timed out trying to connect."),_this.onClosed_(),_this.connectTimeoutTimer_=null},Math.floor(3e4)),function(fn){if(util.isNodeSdk()||"complete"===document.readyState)fn();else{var called_1=!1,wrappedFn_1=function(){document.body?called_1||(called_1=!0,fn()):setTimeout(wrappedFn_1,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",wrappedFn_1,!1),window.addEventListener("load",wrappedFn_1,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&wrappedFn_1()}),window.attachEvent("onload",wrappedFn_1))}}(function(){if(!_this.isClosed_){_this.scriptTagHolder=new FirebaseIFrameScriptHolder(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var command=args[0],arg1=args[1],arg2=args[2];if(_this.incrementIncomingBytes_(args),_this.scriptTagHolder)if(_this.connectTimeoutTimer_&&(clearTimeout(_this.connectTimeoutTimer_),_this.connectTimeoutTimer_=null),_this.everConnected_=!0,"start"==command)_this.id=arg1,_this.password=arg2;else{if("close"!==command)throw new Error("Unrecognized command received: "+command);arg1?(_this.scriptTagHolder.sendNewPolls=!1,_this.myPacketOrderer.closeAfter(arg1,function(){_this.onClosed_()})):_this.onClosed_()}},function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var pN=args[0],data=args[1];_this.incrementIncomingBytes_(args),_this.myPacketOrderer.handleResponse(pN,data)},function(){_this.onClosed_()},_this.urlFn);var urlParams={start:"t"};urlParams.ser=Math.floor(1e8*Math.random()),_this.scriptTagHolder.uniqueCallbackIdentifier&&(urlParams.cb=_this.scriptTagHolder.uniqueCallbackIdentifier),urlParams.v="5",_this.transportSessionId&&(urlParams.s=_this.transportSessionId),_this.lastSessionId&&(urlParams.ls=_this.lastSessionId),!util.isNodeSdk()&&"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(urlParams.r="f");var connectURL=_this.urlFn(urlParams);_this.log_("Connecting via long-poll to "+connectURL),_this.scriptTagHolder.addTag(connectURL,function(){})}})},BrowserPollConnection.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},BrowserPollConnection.forceAllow=function(){BrowserPollConnection.forceAllow_=!0},BrowserPollConnection.forceDisallow=function(){BrowserPollConnection.forceDisallow_=!0},BrowserPollConnection.isAvailable=function(){return BrowserPollConnection.forceAllow_||!BrowserPollConnection.forceDisallow_&&"undefined"!=typeof document&&null!=document.createElement&&!("object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&!("object"==typeof Windows&&"object"==typeof Windows.UI)&&!util.isNodeSdk()},BrowserPollConnection.prototype.markConnectionHealthy=function(){},BrowserPollConnection.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},BrowserPollConnection.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},BrowserPollConnection.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},BrowserPollConnection.prototype.send=function(data){var dataStr=util.stringify(data);this.bytesSent+=dataStr.length,this.stats_.incrementCounter("bytes_sent",dataStr.length);for(var base64data=util.base64Encode(dataStr),dataSegs=splitStringBySize(base64data,1840),i=0;i<dataSegs.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,dataSegs.length,dataSegs[i]),this.curSegmentNum++},BrowserPollConnection.prototype.addDisconnectPingFrame=function(id,pw){if(!util.isNodeSdk()){this.myDisconnFrame=document.createElement("iframe");var urlParams={dframe:"t"};urlParams.id=id,urlParams.pw=pw,this.myDisconnFrame.src=this.urlFn(urlParams),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}},BrowserPollConnection.prototype.incrementIncomingBytes_=function(args){var bytesReceived=util.stringify(args).length;this.bytesReceived+=bytesReceived,this.stats_.incrementCounter("bytes_received",bytesReceived)},BrowserPollConnection}(),FirebaseIFrameScriptHolder=function(){function FirebaseIFrameScriptHolder(commandCB,onMessageCB,onDisconnect,urlFn){if(this.onDisconnect=onDisconnect,this.urlFn=urlFn,this.outstandingRequests=new CountedSet,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,util.isNodeSdk())this.commandCB=commandCB,this.onMessageCB=onMessageCB;else{this.uniqueCallbackIdentifier=LUIDGenerator(),window[FIREBASE_LONGPOLL_COMMAND_CB_NAME+this.uniqueCallbackIdentifier]=commandCB,window[FIREBASE_LONGPOLL_DATA_CB_NAME+this.uniqueCallbackIdentifier]=onMessageCB,this.myIFrame=FirebaseIFrameScriptHolder.createIFrame_();var script="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length))script='<script>document.domain="'+document.domain+'";<\/script>';var iframeContents="<html><body>"+script+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(iframeContents),this.myIFrame.doc.close()}catch(e){log("frame writing exception"),e.stack&&log(e.stack),log(e)}}}return FirebaseIFrameScriptHolder.createIFrame_=function(){var iframe=document.createElement("iframe");if(iframe.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(iframe);try{iframe.contentWindow.document||log("No IE domain setting required")}catch(e){var domain=document.domain;iframe.src="javascript:void((function(){document.open();document.domain='"+domain+"';document.close();})())"}return iframe.contentDocument?iframe.doc=iframe.contentDocument:iframe.contentWindow?iframe.doc=iframe.contentWindow.document:iframe.document&&(iframe.doc=iframe.document),iframe},FirebaseIFrameScriptHolder.prototype.close=function(){var _this=this;if(this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(function(){null!==_this.myIFrame&&(document.body.removeChild(_this.myIFrame),_this.myIFrame=null)},Math.floor(0))),util.isNodeSdk()&&this.myID){var urlParams={disconn:"t"};urlParams.id=this.myID,urlParams.pw=this.myPW;var theURL=this.urlFn(urlParams);FirebaseIFrameScriptHolder.nodeRestRequest(theURL)}var onDisconnect=this.onDisconnect;onDisconnect&&(this.onDisconnect=null,onDisconnect())},FirebaseIFrameScriptHolder.prototype.startLongPoll=function(id,pw){for(this.myID=id,this.myPW=pw,this.alive=!0;this.newRequest_(););},FirebaseIFrameScriptHolder.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.count()<(this.pendingSegs.length>0?2:1)){this.currentSerial++;var urlParams={};urlParams.id=this.myID,urlParams.pw=this.myPW,urlParams.ser=this.currentSerial;for(var theURL=this.urlFn(urlParams),curDataString="",i=0;this.pendingSegs.length>0;){if(!(this.pendingSegs[0].d.length+30+curDataString.length<=1870))break;var theSeg=this.pendingSegs.shift();curDataString=curDataString+"&seg"+i+"="+theSeg.seg+"&ts"+i+"="+theSeg.ts+"&d"+i+"="+theSeg.d,i++}return theURL+=curDataString,this.addLongPollTag_(theURL,this.currentSerial),!0}return!1},FirebaseIFrameScriptHolder.prototype.enqueueSegment=function(segnum,totalsegs,data){this.pendingSegs.push({seg:segnum,ts:totalsegs,d:data}),this.alive&&this.newRequest_()},FirebaseIFrameScriptHolder.prototype.addLongPollTag_=function(url,serial){var _this=this;this.outstandingRequests.add(serial,1);var doNewRequest=function(){_this.outstandingRequests.remove(serial),_this.newRequest_()},keepaliveTimeout=setTimeout(doNewRequest,Math.floor(25e3));this.addTag(url,function(){clearTimeout(keepaliveTimeout),doNewRequest()})},FirebaseIFrameScriptHolder.prototype.addTag=function(url,loadCB){var _this=this;util.isNodeSdk()?this.doNodeLongPoll(url,loadCB):setTimeout(function(){try{if(!_this.sendNewPolls)return;var newScript_1=_this.myIFrame.doc.createElement("script");newScript_1.type="text/javascript",newScript_1.async=!0,newScript_1.src=url,newScript_1.onload=newScript_1.onreadystatechange=function(){var rstate=newScript_1.readyState;rstate&&"loaded"!==rstate&&"complete"!==rstate||(newScript_1.onload=newScript_1.onreadystatechange=null,newScript_1.parentNode&&newScript_1.parentNode.removeChild(newScript_1),loadCB())},newScript_1.onerror=function(){log("Long-poll script failed to load: "+url),_this.sendNewPolls=!1,_this.close()},_this.myIFrame.doc.body.appendChild(newScript_1)}catch(e){}},Math.floor(1))},FirebaseIFrameScriptHolder}(),WebSocketImpl=null;
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */"undefined"!=typeof MozWebSocket?WebSocketImpl=MozWebSocket:"undefined"!=typeof WebSocket&&(WebSocketImpl=WebSocket);var WebSocketConnection=function(){function WebSocketConnection(connId,repoInfo,transportSessionId,lastSessionId){this.connId=connId,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=logWrapper(this.connId),this.stats_=StatsManager.getCollection(repoInfo),this.connURL=WebSocketConnection.connectionURL_(repoInfo,transportSessionId,lastSessionId)}return WebSocketConnection.connectionURL_=function(repoInfo,transportSessionId,lastSessionId){var urlParams={v:"5"};return!util.isNodeSdk()&&"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(urlParams.r="f"),transportSessionId&&(urlParams.s=transportSessionId),lastSessionId&&(urlParams.ls=lastSessionId),repoInfo.connectionURL("websocket",urlParams)},WebSocketConnection.prototype.open=function(onMessage,onDisconnect){var _this=this;this.onDisconnect=onDisconnect,this.onMessage=onMessage,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,PersistentStorage.set("previous_websocket_failure",!0);try{if(util.isNodeSdk()){var device=util.CONSTANTS.NODE_ADMIN?"AdminNode":"Node",options={headers:{"User-Agent":"Firebase/5/"+firebase.SDK_VERSION+"/"+process.platform+"/"+device}},env=process.env,proxy=0==this.connURL.indexOf("wss://")?env.HTTPS_PROXY||env.https_proxy:env.HTTP_PROXY||env.http_proxy;proxy&&(options.proxy={origin:proxy}),this.mySock=new WebSocketImpl(this.connURL,[],options)}else this.mySock=new WebSocketImpl(this.connURL)}catch(e){this.log_("Error instantiating WebSocket.");var error=e.message||e.data;return error&&this.log_(error),void this.onClosed_()}this.mySock.onopen=function(){_this.log_("Websocket connected."),_this.everConnected_=!0},this.mySock.onclose=function(){_this.log_("Websocket connection was disconnected."),_this.mySock=null,_this.onClosed_()},this.mySock.onmessage=function(m){_this.handleIncomingFrame(m)},this.mySock.onerror=function(e){_this.log_("WebSocket error.  Closing connection.");var error=e.message||e.data;error&&_this.log_(error),_this.onClosed_()}},WebSocketConnection.prototype.start=function(){},WebSocketConnection.forceDisallow=function(){WebSocketConnection.forceDisallow_=!0},WebSocketConnection.isAvailable=function(){var isOldAndroid=!1;if("undefined"!=typeof navigator&&navigator.userAgent){var oldAndroidMatch=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);oldAndroidMatch&&oldAndroidMatch.length>1&&parseFloat(oldAndroidMatch[1])<4.4&&(isOldAndroid=!0)}return!isOldAndroid&&null!==WebSocketImpl&&!WebSocketConnection.forceDisallow_},WebSocketConnection.previouslyFailed=function(){return PersistentStorage.isInMemoryStorage||!0===PersistentStorage.get("previous_websocket_failure")},WebSocketConnection.prototype.markConnectionHealthy=function(){PersistentStorage.remove("previous_websocket_failure")},WebSocketConnection.prototype.appendFrame_=function(data){if(this.frames.push(data),this.frames.length==this.totalFrames){var fullMess=this.frames.join("");this.frames=null;var jsonMess=util.jsonEval(fullMess);this.onMessage(jsonMess)}},WebSocketConnection.prototype.handleNewFrameCount_=function(frameCount){this.totalFrames=frameCount,this.frames=[]},WebSocketConnection.prototype.extractFrameCount_=function(data){if(util.assert(null===this.frames,"We already have a frame buffer"),data.length<=6){var frameCount=Number(data);if(!isNaN(frameCount))return this.handleNewFrameCount_(frameCount),null}return this.handleNewFrameCount_(1),data},WebSocketConnection.prototype.handleIncomingFrame=function(mess){if(null!==this.mySock){var data=mess.data;if(this.bytesReceived+=data.length,this.stats_.incrementCounter("bytes_received",data.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(data);else{var remainingData=this.extractFrameCount_(data);null!==remainingData&&this.appendFrame_(remainingData)}}},WebSocketConnection.prototype.send=function(data){this.resetKeepAlive();var dataStr=util.stringify(data);this.bytesSent+=dataStr.length,this.stats_.incrementCounter("bytes_sent",dataStr.length);var dataSegs=splitStringBySize(dataStr,16384);dataSegs.length>1&&this.sendString_(String(dataSegs.length));for(var i=0;i<dataSegs.length;i++)this.sendString_(dataSegs[i])},WebSocketConnection.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},WebSocketConnection.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},WebSocketConnection.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},WebSocketConnection.prototype.resetKeepAlive=function(){var _this=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(function(){_this.mySock&&_this.sendString_("0"),_this.resetKeepAlive()},Math.floor(45e3))},WebSocketConnection.prototype.sendString_=function(str){try{this.mySock.send(str)}catch(e){this.log_("Exception thrown from WebSocket.send():",e.message||e.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},WebSocketConnection.responsesRequiredToBeHealthy=2,WebSocketConnection.healthyTimeout=3e4,WebSocketConnection}(),TransportManager=function(){function TransportManager(repoInfo){this.initTransports_(repoInfo)}return Object.defineProperty(TransportManager,"ALL_TRANSPORTS",{get:function(){return[BrowserPollConnection,WebSocketConnection]},enumerable:!0,configurable:!0}),TransportManager.prototype.initTransports_=function(repoInfo){var isWebSocketsAvailable=WebSocketConnection&&WebSocketConnection.isAvailable(),isSkipPollConnection=isWebSocketsAvailable&&!WebSocketConnection.previouslyFailed();if(repoInfo.webSocketOnly&&(isWebSocketsAvailable||warn("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),isSkipPollConnection=!0),isSkipPollConnection)this.transports_=[WebSocketConnection];else{var transports_1=this.transports_=[];each(TransportManager.ALL_TRANSPORTS,function(i,transport){transport&&transport.isAvailable()&&transports_1.push(transport)})}},TransportManager.prototype.initialTransport=function(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")},TransportManager.prototype.upgradeTransport=function(){return this.transports_.length>1?this.transports_[1]:null},TransportManager}(),Connection=function(){function Connection(id,repoInfo_,onMessage_,onReady_,onDisconnect_,onKill_,lastSessionId){this.id=id,this.repoInfo_=repoInfo_,this.onMessage_=onMessage_,this.onReady_=onReady_,this.onDisconnect_=onDisconnect_,this.onKill_=onKill_,this.lastSessionId=lastSessionId,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=logWrapper("c:"+this.id+":"),this.transportManager_=new TransportManager(repoInfo_),this.log_("Connection created"),this.start_()}return Connection.prototype.start_=function(){var _this=this,conn=this.transportManager_.initialTransport();this.conn_=new conn(this.nextTransportId_(),this.repoInfo_,void 0,this.lastSessionId),this.primaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;var onMessageReceived=this.connReceiver_(this.conn_),onConnectionLost=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(function(){_this.conn_&&_this.conn_.open(onMessageReceived,onConnectionLost)},Math.floor(0));var healthyTimeout_ms=conn.healthyTimeout||0;healthyTimeout_ms>0&&(this.healthyTimeout_=setTimeoutNonBlocking(function(){_this.healthyTimeout_=null,_this.isHealthy_||(_this.conn_&&_this.conn_.bytesReceived>102400?(_this.log_("Connection exceeded healthy timeout but has received "+_this.conn_.bytesReceived+" bytes.  Marking connection healthy."),_this.isHealthy_=!0,_this.conn_.markConnectionHealthy()):_this.conn_&&_this.conn_.bytesSent>10240?_this.log_("Connection exceeded healthy timeout but has sent "+_this.conn_.bytesSent+" bytes.  Leaving connection alive."):(_this.log_("Closing unhealthy connection after timeout."),_this.close()))},Math.floor(healthyTimeout_ms)))},Connection.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},Connection.prototype.disconnReceiver_=function(conn){var _this=this;return function(everConnected){conn===_this.conn_?_this.onConnectionLost_(everConnected):conn===_this.secondaryConn_?(_this.log_("Secondary connection lost."),_this.onSecondaryConnectionLost_()):_this.log_("closing an old connection")}},Connection.prototype.connReceiver_=function(conn){var _this=this;return function(message){2!=_this.state_&&(conn===_this.rx_?_this.onPrimaryMessageReceived_(message):conn===_this.secondaryConn_?_this.onSecondaryMessageReceived_(message):_this.log_("message on old connection"))}},Connection.prototype.sendRequest=function(dataMsg){var msg={t:"d",d:dataMsg};this.sendData_(msg)},Connection.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},Connection.prototype.onSecondaryControl_=function(controlData){if("t"in controlData){var cmd=controlData.t;"a"===cmd?this.upgradeIfSecondaryHealthy_():"r"===cmd?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===cmd&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}},Connection.prototype.onSecondaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData),data=requireKey("d",parsedData);if("c"==layer)this.onSecondaryControl_(data);else{if("d"!=layer)throw new Error("Unknown protocol layer: "+layer);this.pendingDataMessages.push(data)}},Connection.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},Connection.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},Connection.prototype.onPrimaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData),data=requireKey("d",parsedData);"c"==layer?this.onControl_(data):"d"==layer&&this.onDataMessage_(data)},Connection.prototype.onDataMessage_=function(message){this.onPrimaryResponse_(),this.onMessage_(message)},Connection.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},Connection.prototype.onControl_=function(controlData){var cmd=requireKey("t",controlData);if("d"in controlData){var payload=controlData.d;if("h"===cmd)this.onHandshake_(payload);else if("n"===cmd){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===cmd?this.onConnectionShutdown_(payload):"r"===cmd?this.onReset_(payload):"e"===cmd?error("Server Error: "+payload):"o"===cmd?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):error("Unknown control packet command: "+cmd)}},Connection.prototype.onHandshake_=function(handshake){var timestamp=handshake.ts,version=handshake.v,host=handshake.h;this.sessionId=handshake.s,this.repoInfo_.updateHost(host),0==this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,timestamp),"5"!==version&&warn("Protocol version mismatch detected"),this.tryStartUpgrade_())},Connection.prototype.tryStartUpgrade_=function(){var conn=this.transportManager_.upgradeTransport();conn&&this.startUpgrade_(conn)},Connection.prototype.startUpgrade_=function(conn){var _this=this;this.secondaryConn_=new conn(this.nextTransportId_(),this.repoInfo_,this.sessionId),this.secondaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;var onMessage=this.connReceiver_(this.secondaryConn_),onDisconnect=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(onMessage,onDisconnect),setTimeoutNonBlocking(function(){_this.secondaryConn_&&(_this.log_("Timed out trying to upgrade."),_this.secondaryConn_.close())},Math.floor(6e4))},Connection.prototype.onReset_=function(host){this.log_("Reset packet received.  New host: "+host),this.repoInfo_.updateHost(host),1===this.state_?this.close():(this.closeConnections_(),this.start_())},Connection.prototype.onConnectionEstablished_=function(conn,timestamp){var _this=this;this.log_("Realtime connection established."),this.conn_=conn,this.state_=1,this.onReady_&&(this.onReady_(timestamp,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):setTimeoutNonBlocking(function(){_this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))},Connection.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},Connection.prototype.onSecondaryConnectionLost_=function(){var conn=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==conn&&this.rx_!==conn||this.close()},Connection.prototype.onConnectionLost_=function(everConnected){this.conn_=null,everConnected||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(PersistentStorage.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},Connection.prototype.onConnectionShutdown_=function(reason){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(reason),this.onKill_=null),this.onDisconnect_=null,this.close()},Connection.prototype.sendData_=function(data){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(data)},Connection.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},Connection.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},Connection}(),ServerActions=function(){function ServerActions(){}return ServerActions.prototype.put=function(pathString,data,onComplete,hash){},ServerActions.prototype.merge=function(pathString,data,onComplete,hash){},ServerActions.prototype.refreshAuthToken=function(token){},ServerActions.prototype.onDisconnectPut=function(pathString,data,onComplete){},ServerActions.prototype.onDisconnectMerge=function(pathString,data,onComplete){},ServerActions.prototype.onDisconnectCancel=function(pathString,onComplete){},ServerActions.prototype.reportStats=function(stats){},ServerActions}(),RECONNECT_MIN_DELAY=1e3,RECONNECT_MAX_DELAY_DEFAULT=3e5,PersistentConnection=function(_super){function PersistentConnection(repoInfo_,onDataUpdate_,onConnectStatus_,onServerInfoUpdate_,authTokenProvider_,authOverride_){var _this=_super.call(this)||this;if(_this.repoInfo_=repoInfo_,_this.onDataUpdate_=onDataUpdate_,_this.onConnectStatus_=onConnectStatus_,_this.onServerInfoUpdate_=onServerInfoUpdate_,_this.authTokenProvider_=authTokenProvider_,_this.authOverride_=authOverride_,_this.id=PersistentConnection.nextPersistentConnectionId_++,_this.log_=logWrapper("p:"+_this.id+":"),_this.interruptReasons_={},_this.listens_={},_this.outstandingPuts_=[],_this.outstandingPutCount_=0,_this.onDisconnectRequestQueue_=[],_this.connected_=!1,_this.reconnectDelay_=RECONNECT_MIN_DELAY,_this.maxReconnectDelay_=RECONNECT_MAX_DELAY_DEFAULT,_this.securityDebugCallback_=null,_this.lastSessionId=null,_this.establishConnectionTimer_=null,_this.visible_=!1,_this.requestCBHash_={},_this.requestNumber_=0,_this.realtime_=null,_this.authToken_=null,_this.forceTokenRefresh_=!1,_this.invalidAuthTokenCount_=0,_this.firstConnection_=!0,_this.lastConnectionAttemptTime_=null,_this.lastConnectionEstablishedTime_=null,authOverride_&&!util.isNodeSdk())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return _this.scheduleConnect_(0),VisibilityMonitor.getInstance().on("visible",_this.onVisible_,_this),-1===repoInfo_.host.indexOf("fblocal")&&OnlineMonitor.getInstance().on("online",_this.onOnline_,_this),_this}return tslib_1.__extends(PersistentConnection,_super),PersistentConnection.prototype.sendRequest=function(action,body,onResponse){var curReqNum=++this.requestNumber_,msg={r:curReqNum,a:action,b:body};this.log_(util.stringify(msg)),util.assert(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(msg),onResponse&&(this.requestCBHash_[curReqNum]=onResponse)},PersistentConnection.prototype.listen=function(query,currentHashFn,tag,onComplete){var queryId=query.queryIdentifier(),pathString=query.path.toString();this.log_("Listen called for "+pathString+" "+queryId),this.listens_[pathString]=this.listens_[pathString]||{},util.assert(query.getQueryParams().isDefault()||!query.getQueryParams().loadsAllData(),"listen() called for non-default but complete query"),util.assert(!this.listens_[pathString][queryId],"listen() called twice for same path/queryId.");var listenSpec={onComplete:onComplete,hashFn:currentHashFn,query:query,tag:tag};this.listens_[pathString][queryId]=listenSpec,this.connected_&&this.sendListen_(listenSpec)},PersistentConnection.prototype.sendListen_=function(listenSpec){var _this=this,query=listenSpec.query,pathString=query.path.toString(),queryId=query.queryIdentifier();this.log_("Listen on "+pathString+" for "+queryId);var req={p:pathString};listenSpec.tag&&(req.q=query.queryObject(),req.t=listenSpec.tag),req.h=listenSpec.hashFn(),this.sendRequest("q",req,function(message){var payload=message.d,status=message.s;PersistentConnection.warnOnListenWarnings_(payload,query),(_this.listens_[pathString]&&_this.listens_[pathString][queryId])===listenSpec&&(_this.log_("listen response",message),"ok"!==status&&_this.removeListen_(pathString,queryId),listenSpec.onComplete&&listenSpec.onComplete(status,payload))})},PersistentConnection.warnOnListenWarnings_=function(payload,query){if(payload&&"object"==typeof payload&&util.contains(payload,"w")){var warnings=util.safeGet(payload,"w");if(Array.isArray(warnings)&&~warnings.indexOf("no_index")){var indexSpec='".indexOn": "'+query.getQueryParams().getIndex().toString()+'"',indexPath=query.path.toString();warn("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+indexSpec+" at "+indexPath+" to your security rules for better performance.")}}},PersistentConnection.prototype.refreshAuthToken=function(token){this.authToken_=token,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},function(){}),this.reduceReconnectDelayIfAdminCredential_(token)},PersistentConnection.prototype.reduceReconnectDelayIfAdminCredential_=function(credential){(credential&&40===credential.length||util.isAdmin(credential))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},PersistentConnection.prototype.tryAuth=function(){var _this=this;if(this.connected_&&this.authToken_){var token_1=this.authToken_,authMethod=util.isValidFormat(token_1)?"auth":"gauth",requestData={cred:token_1};null===this.authOverride_?requestData.noauth=!0:"object"==typeof this.authOverride_&&(requestData.authvar=this.authOverride_),this.sendRequest(authMethod,requestData,function(res){var status=res.s,data=res.d||"error";_this.authToken_===token_1&&("ok"===status?_this.invalidAuthTokenCount_=0:_this.onAuthRevoked_(status,data))})}},PersistentConnection.prototype.unlisten=function(query,tag){var pathString=query.path.toString(),queryId=query.queryIdentifier();this.log_("Unlisten called for "+pathString+" "+queryId),util.assert(query.getQueryParams().isDefault()||!query.getQueryParams().loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(pathString,queryId)&&this.connected_&&this.sendUnlisten_(pathString,queryId,query.queryObject(),tag)},PersistentConnection.prototype.sendUnlisten_=function(pathString,queryId,queryObj,tag){this.log_("Unlisten on "+pathString+" for "+queryId);var req={p:pathString};tag&&(req.q=queryObj,req.t=tag),this.sendRequest("n",req)},PersistentConnection.prototype.onDisconnectPut=function(pathString,data,onComplete){this.connected_?this.sendOnDisconnect_("o",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"o",data:data,onComplete:onComplete})},PersistentConnection.prototype.onDisconnectMerge=function(pathString,data,onComplete){this.connected_?this.sendOnDisconnect_("om",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"om",data:data,onComplete:onComplete})},PersistentConnection.prototype.onDisconnectCancel=function(pathString,onComplete){this.connected_?this.sendOnDisconnect_("oc",pathString,null,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"oc",data:null,onComplete:onComplete})},PersistentConnection.prototype.sendOnDisconnect_=function(action,pathString,data,onComplete){var request={p:pathString,d:data};this.log_("onDisconnect "+action,request),this.sendRequest(action,request,function(response){onComplete&&setTimeout(function(){onComplete(response.s,response.d)},Math.floor(0))})},PersistentConnection.prototype.put=function(pathString,data,onComplete,hash){this.putInternal("p",pathString,data,onComplete,hash)},PersistentConnection.prototype.merge=function(pathString,data,onComplete,hash){this.putInternal("m",pathString,data,onComplete,hash)},PersistentConnection.prototype.putInternal=function(action,pathString,data,onComplete,hash){var request={p:pathString,d:data};void 0!==hash&&(request.h=hash),this.outstandingPuts_.push({action:action,request:request,onComplete:onComplete}),this.outstandingPutCount_++;var index=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(index):this.log_("Buffering put: "+pathString)},PersistentConnection.prototype.sendPut_=function(index){var _this=this,action=this.outstandingPuts_[index].action,request=this.outstandingPuts_[index].request,onComplete=this.outstandingPuts_[index].onComplete;this.outstandingPuts_[index].queued=this.connected_,this.sendRequest(action,request,function(message){_this.log_(action+" response",message),delete _this.outstandingPuts_[index],_this.outstandingPutCount_--,0===_this.outstandingPutCount_&&(_this.outstandingPuts_=[]),onComplete&&onComplete(message.s,message.d)})},PersistentConnection.prototype.reportStats=function(stats){var _this=this;if(this.connected_){var request={c:stats};this.log_("reportStats",request),this.sendRequest("s",request,function(result){if("ok"!==result.s){var errorReason=result.d;_this.log_("reportStats","Error sending stats: "+errorReason)}})}},PersistentConnection.prototype.onDataMessage_=function(message){if("r"in message){this.log_("from server: "+util.stringify(message));var reqNum=message.r,onResponse=this.requestCBHash_[reqNum];onResponse&&(delete this.requestCBHash_[reqNum],onResponse(message.b))}else{if("error"in message)throw"A server-side error has occurred: "+message.error;"a"in message&&this.onDataPush_(message.a,message.b)}},PersistentConnection.prototype.onDataPush_=function(action,body){this.log_("handleServerMessage",action,body),"d"===action?this.onDataUpdate_(body.p,body.d,!1,body.t):"m"===action?this.onDataUpdate_(body.p,body.d,!0,body.t):"c"===action?this.onListenRevoked_(body.p,body.q):"ac"===action?this.onAuthRevoked_(body.s,body.d):"sd"===action?this.onSecurityDebugPacket_(body):error("Unrecognized action received from server: "+util.stringify(action)+"\nAre you using the latest client?")},PersistentConnection.prototype.onReady_=function(timestamp,sessionId){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(timestamp),this.lastSessionId=sessionId,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},PersistentConnection.prototype.scheduleConnect_=function(timeout){var _this=this;util.assert(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(function(){_this.establishConnectionTimer_=null,_this.establishConnection_()},Math.floor(timeout))},PersistentConnection.prototype.onVisible_=function(visible){visible&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=RECONNECT_MIN_DELAY,this.realtime_||this.scheduleConnect_(0)),this.visible_=visible},PersistentConnection.prototype.onOnline_=function(online){online?(this.log_("Browser went online."),this.reconnectDelay_=RECONNECT_MIN_DELAY,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},PersistentConnection.prototype.onRealtimeDisconnect_=function(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=RECONNECT_MIN_DELAY),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();var timeSinceLastConnectAttempt=(new Date).getTime()-this.lastConnectionAttemptTime_,reconnectDelay=Math.max(0,this.reconnectDelay_-timeSinceLastConnectAttempt);reconnectDelay=Math.random()*reconnectDelay,this.log_("Trying to reconnect in "+reconnectDelay+"ms"),this.scheduleConnect_(reconnectDelay),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)},PersistentConnection.prototype.establishConnection_=function(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;var onDataMessage_1=this.onDataMessage_.bind(this),onReady_1=this.onReady_.bind(this),onDisconnect_1=this.onRealtimeDisconnect_.bind(this),connId_1=this.id+":"+PersistentConnection.nextConnectionId_++,self_1=this,lastSessionId_1=this.lastSessionId,canceled_1=!1,connection_1=null,closeFn_1=function(){connection_1?connection_1.close():(canceled_1=!0,onDisconnect_1())};this.realtime_={close:closeFn_1,sendRequest:function(msg){util.assert(connection_1,"sendRequest call when we're not connected not allowed."),connection_1.sendRequest(msg)}};var forceRefresh=this.forceTokenRefresh_;this.forceTokenRefresh_=!1,this.authTokenProvider_.getToken(forceRefresh).then(function(result){canceled_1?log("getToken() completed but was canceled"):(log("getToken() completed. Creating connection."),self_1.authToken_=result&&result.accessToken,connection_1=new Connection(connId_1,self_1.repoInfo_,onDataMessage_1,onReady_1,onDisconnect_1,function(reason){warn(reason+" ("+self_1.repoInfo_.toString()+")"),self_1.interrupt("server_kill")},lastSessionId_1))}).then(null,function(error){self_1.log_("Failed to get token: "+error),canceled_1||(util.CONSTANTS.NODE_ADMIN&&warn(error),closeFn_1())})}},PersistentConnection.prototype.interrupt=function(reason){log("Interrupting connection for reason: "+reason),this.interruptReasons_[reason]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},PersistentConnection.prototype.resume=function(reason){log("Resuming connection for reason: "+reason),delete this.interruptReasons_[reason],util.isEmpty(this.interruptReasons_)&&(this.reconnectDelay_=RECONNECT_MIN_DELAY,this.realtime_||this.scheduleConnect_(0))},PersistentConnection.prototype.handleTimestamp_=function(timestamp){var delta=timestamp-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:delta})},PersistentConnection.prototype.cancelSentTransactions_=function(){for(var i=0;i<this.outstandingPuts_.length;i++){var put=this.outstandingPuts_[i];put&&"h"in put.request&&put.queued&&(put.onComplete&&put.onComplete("disconnect"),delete this.outstandingPuts_[i],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},PersistentConnection.prototype.onListenRevoked_=function(pathString,query){var queryId;queryId=query?query.map(function(q){return ObjectToUniqueKey(q)}).join("$"):"default";var listen=this.removeListen_(pathString,queryId);listen&&listen.onComplete&&listen.onComplete("permission_denied")},PersistentConnection.prototype.removeListen_=function(pathString,queryId){var listen,normalizedPathString=new Path(pathString).toString();return void 0!==this.listens_[normalizedPathString]?(listen=this.listens_[normalizedPathString][queryId],delete this.listens_[normalizedPathString][queryId],0===util.getCount(this.listens_[normalizedPathString])&&delete this.listens_[normalizedPathString]):listen=void 0,listen},PersistentConnection.prototype.onAuthRevoked_=function(statusCode,explanation){log("Auth token revoked: "+statusCode+"/"+explanation),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==statusCode&&"permission_denied"!==statusCode||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},PersistentConnection.prototype.onSecurityDebugPacket_=function(body){this.securityDebugCallback_?this.securityDebugCallback_(body):"msg"in body&&console.log("FIREBASE: "+body.msg.replace("\n","\nFIREBASE: "))},PersistentConnection.prototype.restoreState_=function(){var _this=this;this.tryAuth(),util.forEach(this.listens_,function(pathString,queries){util.forEach(queries,function(key,listenSpec){_this.sendListen_(listenSpec)})});for(var i=0;i<this.outstandingPuts_.length;i++)this.outstandingPuts_[i]&&this.sendPut_(i);for(;this.onDisconnectRequestQueue_.length;){var request=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(request.action,request.pathString,request.data,request.onComplete)}},PersistentConnection.prototype.sendConnectStats_=function(){var stats={},clientName="js";util.CONSTANTS.NODE_ADMIN?clientName="admin_node":util.CONSTANTS.NODE_CLIENT&&(clientName="node"),stats["sdk."+clientName+"."+firebase.SDK_VERSION.replace(/\./g,"-")]=1,util.isMobileCordova()?stats["framework.cordova"]=1:util.isReactNative()&&(stats["framework.reactnative"]=1),this.reportStats(stats)},PersistentConnection.prototype.shouldReconnect_=function(){var online=OnlineMonitor.getInstance().currentlyOnline();return util.isEmpty(this.interruptReasons_)&&online},PersistentConnection.nextPersistentConnectionId_=0,PersistentConnection.nextConnectionId_=0,PersistentConnection}(ServerActions),ReadonlyRestClient=function(_super){function ReadonlyRestClient(repoInfo_,onDataUpdate_,authTokenProvider_){var _this=_super.call(this)||this;return _this.repoInfo_=repoInfo_,_this.onDataUpdate_=onDataUpdate_,_this.authTokenProvider_=authTokenProvider_,_this.log_=logWrapper("p:rest:"),_this.listens_={},_this}return tslib_1.__extends(ReadonlyRestClient,_super),ReadonlyRestClient.prototype.reportStats=function(stats){throw new Error("Method not implemented.")},ReadonlyRestClient.getListenId_=function(query,tag){return void 0!==tag?"tag$"+tag:(util.assert(query.getQueryParams().isDefault(),"should have a tag if it's not a default query."),query.path.toString())},ReadonlyRestClient.prototype.listen=function(query,currentHashFn,tag,onComplete){var _this=this,pathString=query.path.toString();this.log_("Listen called for "+pathString+" "+query.queryIdentifier());var listenId=ReadonlyRestClient.getListenId_(query,tag),thisListen={};this.listens_[listenId]=thisListen;var queryStringParameters=query.getQueryParams().toRestQueryStringParameters();this.restRequest_(pathString+".json",queryStringParameters,function(error,result){var data=result;(404===error&&(data=null,error=null),null===error&&_this.onDataUpdate_(pathString,data,!1,tag),util.safeGet(_this.listens_,listenId)===thisListen)&&onComplete(error?401==error?"permission_denied":"rest_error:"+error:"ok",null)})},ReadonlyRestClient.prototype.unlisten=function(query,tag){var listenId=ReadonlyRestClient.getListenId_(query,tag);delete this.listens_[listenId]},ReadonlyRestClient.prototype.refreshAuthToken=function(token){},ReadonlyRestClient.prototype.restRequest_=function(pathString,queryStringParameters,callback){var _this=this;void 0===queryStringParameters&&(queryStringParameters={}),queryStringParameters.format="export",this.authTokenProvider_.getToken(!1).then(function(authTokenData){var authToken=authTokenData&&authTokenData.accessToken;authToken&&(queryStringParameters.auth=authToken);var url=(_this.repoInfo_.secure?"https://":"http://")+_this.repoInfo_.host+pathString+"?ns="+_this.repoInfo_.namespace+util.querystring(queryStringParameters);_this.log_("Sending REST request for "+url);var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(callback&&4===xhr.readyState){_this.log_("REST Response for "+url+" received. status:",xhr.status,"response:",xhr.responseText);var res=null;if(xhr.status>=200&&xhr.status<300){try{res=util.jsonEval(xhr.responseText)}catch(e){warn("Failed to parse JSON response for "+url+": "+xhr.responseText)}callback(null,res)}else 401!==xhr.status&&404!==xhr.status&&warn("Got unsuccessful REST response for "+url+" Status: "+xhr.status),callback(xhr.status);callback=null}},xhr.open("GET",url,!0),xhr.send()})},ReadonlyRestClient}(ServerActions),Repo=function(){function Repo(repoInfo_,forceRestClient,app){var _this=this;this.repoInfo_=repoInfo_,this.app=app,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new EventQueue,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=new SparseSnapshotTree,this.persistentConnection_=null;var authTokenProvider=new AuthTokenProvider(app);if(this.stats_=StatsManager.getCollection(repoInfo_),forceRestClient||beingCrawled())this.server_=new ReadonlyRestClient(this.repoInfo_,this.onDataUpdate_.bind(this),authTokenProvider),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{var authOverride=app.options.databaseAuthVariableOverride;if(null!=authOverride){if("object"!=typeof authOverride)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{util.stringify(authOverride)}catch(e){throw new Error("Invalid authOverride provided: "+e)}}this.persistentConnection_=new PersistentConnection(this.repoInfo_,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),authTokenProvider,authOverride),this.server_=this.persistentConnection_}authTokenProvider.addTokenChangeListener(function(token){_this.server_.refreshAuthToken(token)}),this.statsReporter_=StatsManager.getOrCreateReporter(repoInfo_,function(){return new StatsReporter(_this.stats_,_this.server_)}),this.transactions_init_(),this.infoData_=new SnapshotHolder,this.infoSyncTree_=new SyncTree({startListening:function(query,tag,currentHashFn,onComplete){var infoEvents=[],node=_this.infoData_.getNode(query.path);return node.isEmpty()||(infoEvents=_this.infoSyncTree_.applyServerOverwrite(query.path,node),setTimeout(function(){onComplete("ok")},0)),infoEvents},stopListening:function(){}}),this.updateInfo_("connected",!1),this.serverSyncTree_=new SyncTree({startListening:function(query,tag,currentHashFn,onComplete){return _this.server_.listen(query,currentHashFn,tag,function(status,data){var events=onComplete(status,data);_this.eventQueue_.raiseEventsForChangedPath(query.path,events)}),[]},stopListening:function(query,tag){_this.server_.unlisten(query,tag)}})}return Repo.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},Repo.prototype.name=function(){return this.repoInfo_.namespace},Repo.prototype.serverTime=function(){var offset=this.infoData_.getNode(new Path(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+offset},Repo.prototype.generateServerValues=function(){return(values=(values={timestamp:this.serverTime()})||{}).timestamp=values.timestamp||(new Date).getTime(),values;var values},Repo.prototype.onDataUpdate_=function(pathString,data,isMerge,tag){this.dataUpdateCount++;var path=new Path(pathString);data=this.interceptServerDataCallback_?this.interceptServerDataCallback_(pathString,data):data;var events=[];if(tag)if(isMerge){var taggedChildren=util.map(data,function(raw){return nodeFromJSON$1(raw)});events=this.serverSyncTree_.applyTaggedQueryMerge(path,taggedChildren,tag)}else{var taggedSnap=nodeFromJSON$1(data);events=this.serverSyncTree_.applyTaggedQueryOverwrite(path,taggedSnap,tag)}else if(isMerge){var changedChildren=util.map(data,function(raw){return nodeFromJSON$1(raw)});events=this.serverSyncTree_.applyServerMerge(path,changedChildren)}else{var snap=nodeFromJSON$1(data);events=this.serverSyncTree_.applyServerOverwrite(path,snap)}var affectedPath=path;events.length>0&&(affectedPath=this.rerunTransactions_(path)),this.eventQueue_.raiseEventsForChangedPath(affectedPath,events)},Repo.prototype.interceptServerData_=function(callback){this.interceptServerDataCallback_=callback},Repo.prototype.onConnectStatus_=function(connectStatus){this.updateInfo_("connected",connectStatus),!1===connectStatus&&this.runOnDisconnectEvents_()},Repo.prototype.onServerInfoUpdate_=function(updates){var _this=this;each(updates,function(value,key){_this.updateInfo_(key,value)})},Repo.prototype.updateInfo_=function(pathString,value){var path=new Path("/.info/"+pathString),newNode=nodeFromJSON$1(value);this.infoData_.updateSnapshot(path,newNode);var events=this.infoSyncTree_.applyServerOverwrite(path,newNode);this.eventQueue_.raiseEventsForChangedPath(path,events)},Repo.prototype.getNextWriteId_=function(){return this.nextWriteId_++},Repo.prototype.setWithPriority=function(path,newVal,newPriority,onComplete){var _this=this;this.log_("set",{path:path.toString(),value:newVal,priority:newPriority});var serverValues=this.generateServerValues(),newNodeUnresolved=nodeFromJSON$1(newVal,newPriority),newNode=resolveDeferredValueSnapshot(newNodeUnresolved,serverValues),writeId=this.getNextWriteId_(),events=this.serverSyncTree_.applyUserOverwrite(path,newNode,writeId,!0);this.eventQueue_.queueEvents(events),this.server_.put(path.toString(),newNodeUnresolved.val(!0),function(status,errorReason){var success="ok"===status;success||warn("set at "+path+" failed: "+status);var clearEvents=_this.serverSyncTree_.ackUserWrite(writeId,!success);_this.eventQueue_.raiseEventsForChangedPath(path,clearEvents),_this.callOnCompleteCallback(onComplete,status,errorReason)});var affectedPath=this.abortTransactions_(path);this.rerunTransactions_(affectedPath),this.eventQueue_.raiseEventsForChangedPath(affectedPath,[])},Repo.prototype.update=function(path,childrenToMerge,onComplete){var _this=this;this.log_("update",{path:path.toString(),value:childrenToMerge});var empty=!0,serverValues=this.generateServerValues(),changedChildren={};if(util.forEach(childrenToMerge,function(changedKey,changedValue){empty=!1;var newNodeUnresolved=nodeFromJSON$1(changedValue);changedChildren[changedKey]=resolveDeferredValueSnapshot(newNodeUnresolved,serverValues)}),empty)log("update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(onComplete,"ok");else{var writeId_1=this.getNextWriteId_(),events=this.serverSyncTree_.applyUserMerge(path,changedChildren,writeId_1);this.eventQueue_.queueEvents(events),this.server_.merge(path.toString(),childrenToMerge,function(status,errorReason){var success="ok"===status;success||warn("update at "+path+" failed: "+status);var clearEvents=_this.serverSyncTree_.ackUserWrite(writeId_1,!success),affectedPath=clearEvents.length>0?_this.rerunTransactions_(path):path;_this.eventQueue_.raiseEventsForChangedPath(affectedPath,clearEvents),_this.callOnCompleteCallback(onComplete,status,errorReason)}),util.forEach(childrenToMerge,function(changedPath){var affectedPath=_this.abortTransactions_(path.child(changedPath));_this.rerunTransactions_(affectedPath)}),this.eventQueue_.raiseEventsForChangedPath(path,[])}},Repo.prototype.runOnDisconnectEvents_=function(){var _this=this;this.log_("onDisconnectEvents");var serverValues=this.generateServerValues(),resolvedOnDisconnectTree=function(tree,serverValues){var resolvedTree=new SparseSnapshotTree;return tree.forEachTree(new Path(""),function(path,node){resolvedTree.remember(path,resolveDeferredValueSnapshot(node,serverValues))}),resolvedTree}(this.onDisconnect_,serverValues),events=[];resolvedOnDisconnectTree.forEachTree(Path.Empty,function(path,snap){events=events.concat(_this.serverSyncTree_.applyServerOverwrite(path,snap));var affectedPath=_this.abortTransactions_(path);_this.rerunTransactions_(affectedPath)}),this.onDisconnect_=new SparseSnapshotTree,this.eventQueue_.raiseEventsForChangedPath(Path.Empty,events)},Repo.prototype.onDisconnectCancel=function(path,onComplete){var _this=this;this.server_.onDisconnectCancel(path.toString(),function(status,errorReason){"ok"===status&&_this.onDisconnect_.forget(path),_this.callOnCompleteCallback(onComplete,status,errorReason)})},Repo.prototype.onDisconnectSet=function(path,value,onComplete){var _this=this,newNode=nodeFromJSON$1(value);this.server_.onDisconnectPut(path.toString(),newNode.val(!0),function(status,errorReason){"ok"===status&&_this.onDisconnect_.remember(path,newNode),_this.callOnCompleteCallback(onComplete,status,errorReason)})},Repo.prototype.onDisconnectSetWithPriority=function(path,value,priority,onComplete){var _this=this,newNode=nodeFromJSON$1(value,priority);this.server_.onDisconnectPut(path.toString(),newNode.val(!0),function(status,errorReason){"ok"===status&&_this.onDisconnect_.remember(path,newNode),_this.callOnCompleteCallback(onComplete,status,errorReason)})},Repo.prototype.onDisconnectUpdate=function(path,childrenToMerge,onComplete){var _this=this;if(util.isEmpty(childrenToMerge))return log("onDisconnect().update() called with empty data.  Don't do anything."),void this.callOnCompleteCallback(onComplete,"ok");this.server_.onDisconnectMerge(path.toString(),childrenToMerge,function(status,errorReason){"ok"===status&&util.forEach(childrenToMerge,function(childName,childNode){var newChildNode=nodeFromJSON$1(childNode);_this.onDisconnect_.remember(path.child(childName),newChildNode)}),_this.callOnCompleteCallback(onComplete,status,errorReason)})},Repo.prototype.addEventCallbackForQuery=function(query,eventRegistration){var events;events=".info"===query.path.getFront()?this.infoSyncTree_.addEventRegistration(query,eventRegistration):this.serverSyncTree_.addEventRegistration(query,eventRegistration),this.eventQueue_.raiseEventsAtPath(query.path,events)},Repo.prototype.removeEventCallbackForQuery=function(query,eventRegistration){var events;events=".info"===query.path.getFront()?this.infoSyncTree_.removeEventRegistration(query,eventRegistration):this.serverSyncTree_.removeEventRegistration(query,eventRegistration),this.eventQueue_.raiseEventsAtPath(query.path,events)},Repo.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt("repo_interrupt")},Repo.prototype.resume=function(){this.persistentConnection_&&this.persistentConnection_.resume("repo_interrupt")},Repo.prototype.stats=function(showDelta){if(void 0===showDelta&&(showDelta=!1),"undefined"!=typeof console){var stats;showDelta?(this.statsListener_||(this.statsListener_=new StatsListener(this.stats_)),stats=this.statsListener_.get()):stats=this.stats_.get();var longestName=Object.keys(stats).reduce(function(previousValue,currentValue){return Math.max(currentValue.length,previousValue)},0);util.forEach(stats,function(stat,value){for(var i=stat.length;i<longestName+2;i++)stat+=" ";console.log(stat+value)})}},Repo.prototype.statsIncrementCounter=function(metric){this.stats_.incrementCounter(metric),this.statsReporter_.includeStat(metric)},Repo.prototype.log_=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];var prefix="";this.persistentConnection_&&(prefix=this.persistentConnection_.id+":"),log.apply(void 0,[prefix].concat(var_args))},Repo.prototype.callOnCompleteCallback=function(callback,status,errorReason){callback&&exceptionGuard(function(){if("ok"==status)callback(null);else{var code=(status||"error").toUpperCase(),message=code;errorReason&&(message+=": "+errorReason);var error=new Error(message);error.code=code,callback(error)}})},Object.defineProperty(Repo.prototype,"database",{get:function(){return this.__database||(this.__database=new Database(this))},enumerable:!0,configurable:!0}),Repo}(),RangedFilter=function(){function RangedFilter(params){this.indexedFilter_=new IndexedFilter(params.getIndex()),this.index_=params.getIndex(),this.startPost_=RangedFilter.getStartPost_(params),this.endPost_=RangedFilter.getEndPost_(params)}return RangedFilter.prototype.getStartPost=function(){return this.startPost_},RangedFilter.prototype.getEndPost=function(){return this.endPost_},RangedFilter.prototype.matches=function(node){return this.index_.compare(this.getStartPost(),node)<=0&&this.index_.compare(node,this.getEndPost())<=0},RangedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){return this.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE),this.indexedFilter_.updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator)},RangedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){newSnap.isLeafNode()&&(newSnap=ChildrenNode.EMPTY_NODE);var filtered=newSnap.withIndex(this.index_);filtered=filtered.updatePriority(ChildrenNode.EMPTY_NODE);var self=this;return newSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){self.matches(new NamedNode(key,childNode))||(filtered=filtered.updateImmediateChild(key,ChildrenNode.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(oldSnap,filtered,optChangeAccumulator)},RangedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap},RangedFilter.prototype.filtersNodes=function(){return!0},RangedFilter.prototype.getIndexedFilter=function(){return this.indexedFilter_},RangedFilter.prototype.getIndex=function(){return this.index_},RangedFilter.getStartPost_=function(params){if(params.hasStart()){var startName=params.getIndexStartName();return params.getIndex().makePost(params.getIndexStartValue(),startName)}return params.getIndex().minPost()},RangedFilter.getEndPost_=function(params){if(params.hasEnd()){var endName=params.getIndexEndName();return params.getIndex().makePost(params.getIndexEndValue(),endName)}return params.getIndex().maxPost()},RangedFilter}(),LimitedFilter=function(){function LimitedFilter(params){this.rangedFilter_=new RangedFilter(params),this.index_=params.getIndex(),this.limit_=params.getLimit(),this.reverse_=!params.isViewFromLeft()}return LimitedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){return this.rangedFilter_.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE),snap.getImmediateChild(key).equals(newChild)?snap:snap.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator):this.fullLimitUpdateChild_(snap,key,newChild,source,optChangeAccumulator)},LimitedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){var filtered;if(newSnap.isLeafNode()||newSnap.isEmpty())filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<newSnap.numChildren()&&newSnap.isIndexed(this.index_)){filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);var iterator=void 0;iterator=this.reverse_?newSnap.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):newSnap.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var count=0;iterator.hasNext()&&count<this.limit_;){var next=iterator.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),next)<=0:this.index_.compare(next,this.rangedFilter_.getEndPost())<=0))break;filtered=filtered.updateImmediateChild(next.name,next.node),count++}}else{filtered=(filtered=newSnap.withIndex(this.index_)).updatePriority(ChildrenNode.EMPTY_NODE);var startPost=void 0,endPost=void 0,cmp=void 0;iterator=void 0;if(this.reverse_){iterator=filtered.getReverseIterator(this.index_),startPost=this.rangedFilter_.getEndPost(),endPost=this.rangedFilter_.getStartPost();var indexCompare_1=this.index_.getCompare();cmp=function(a,b){return indexCompare_1(b,a)}}else iterator=filtered.getIterator(this.index_),startPost=this.rangedFilter_.getStartPost(),endPost=this.rangedFilter_.getEndPost(),cmp=this.index_.getCompare();count=0;for(var foundStartPost=!1;iterator.hasNext();){next=iterator.getNext();!foundStartPost&&cmp(startPost,next)<=0&&(foundStartPost=!0),foundStartPost&&count<this.limit_&&cmp(next,endPost)<=0?count++:filtered=filtered.updateImmediateChild(next.name,ChildrenNode.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(oldSnap,filtered,optChangeAccumulator)},LimitedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap},LimitedFilter.prototype.filtersNodes=function(){return!0},LimitedFilter.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},LimitedFilter.prototype.getIndex=function(){return this.index_},LimitedFilter.prototype.fullLimitUpdateChild_=function(snap,childKey,childSnap,source,changeAccumulator){var cmp;if(this.reverse_){var indexCmp_1=this.index_.getCompare();cmp=function(a,b){return indexCmp_1(b,a)}}else cmp=this.index_.getCompare();var oldEventCache=snap;util.assert(oldEventCache.numChildren()==this.limit_,"");var newChildNamedNode=new NamedNode(childKey,childSnap),windowBoundary=this.reverse_?oldEventCache.getFirstChild(this.index_):oldEventCache.getLastChild(this.index_),inRange=this.rangedFilter_.matches(newChildNamedNode);if(oldEventCache.hasChild(childKey)){for(var oldChildSnap=oldEventCache.getImmediateChild(childKey),nextChild=source.getChildAfterChild(this.index_,windowBoundary,this.reverse_);null!=nextChild&&(nextChild.name==childKey||oldEventCache.hasChild(nextChild.name));)nextChild=source.getChildAfterChild(this.index_,nextChild,this.reverse_);var compareNext=null==nextChild?1:cmp(nextChild,newChildNamedNode);if(inRange&&!childSnap.isEmpty()&&compareNext>=0)return null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childChangedChange(childKey,childSnap,oldChildSnap)),oldEventCache.updateImmediateChild(childKey,childSnap);null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childRemovedChange(childKey,oldChildSnap));var newEventCache=oldEventCache.updateImmediateChild(childKey,ChildrenNode.EMPTY_NODE);return null!=nextChild&&this.rangedFilter_.matches(nextChild)?(null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childAddedChange(nextChild.name,nextChild.node)),newEventCache.updateImmediateChild(nextChild.name,nextChild.node)):newEventCache}return childSnap.isEmpty()?snap:inRange&&cmp(windowBoundary,newChildNamedNode)>=0?(null!=changeAccumulator&&(changeAccumulator.trackChildChange(Change.childRemovedChange(windowBoundary.name,windowBoundary.node)),changeAccumulator.trackChildChange(Change.childAddedChange(childKey,childSnap))),oldEventCache.updateImmediateChild(childKey,childSnap).updateImmediateChild(windowBoundary.name,ChildrenNode.EMPTY_NODE)):snap},LimitedFilter}(),QueryParams=function(){function QueryParams(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=PRIORITY_INDEX}return QueryParams.prototype.hasStart=function(){return this.startSet_},QueryParams.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:this.viewFrom_===QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT},QueryParams.prototype.getIndexStartValue=function(){return util.assert(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},QueryParams.prototype.getIndexStartName=function(){return util.assert(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:MIN_NAME},QueryParams.prototype.hasEnd=function(){return this.endSet_},QueryParams.prototype.getIndexEndValue=function(){return util.assert(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},QueryParams.prototype.getIndexEndName=function(){return util.assert(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:MAX_NAME},QueryParams.prototype.hasLimit=function(){return this.limitSet_},QueryParams.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},QueryParams.prototype.getLimit=function(){return util.assert(this.limitSet_,"Only valid if limit has been set"),this.limit_},QueryParams.prototype.getIndex=function(){return this.index_},QueryParams.prototype.copy_=function(){var copy=new QueryParams;return copy.limitSet_=this.limitSet_,copy.limit_=this.limit_,copy.startSet_=this.startSet_,copy.indexStartValue_=this.indexStartValue_,copy.startNameSet_=this.startNameSet_,copy.indexStartName_=this.indexStartName_,copy.endSet_=this.endSet_,copy.indexEndValue_=this.indexEndValue_,copy.endNameSet_=this.endNameSet_,copy.indexEndName_=this.indexEndName_,copy.index_=this.index_,copy.viewFrom_=this.viewFrom_,copy},QueryParams.prototype.limit=function(newLimit){var newParams=this.copy_();return newParams.limitSet_=!0,newParams.limit_=newLimit,newParams.viewFrom_="",newParams},QueryParams.prototype.limitToFirst=function(newLimit){var newParams=this.copy_();return newParams.limitSet_=!0,newParams.limit_=newLimit,newParams.viewFrom_=QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT,newParams},QueryParams.prototype.limitToLast=function(newLimit){var newParams=this.copy_();return newParams.limitSet_=!0,newParams.limit_=newLimit,newParams.viewFrom_=QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_RIGHT,newParams},QueryParams.prototype.startAt=function(indexValue,key){var newParams=this.copy_();return newParams.startSet_=!0,void 0===indexValue&&(indexValue=null),newParams.indexStartValue_=indexValue,null!=key?(newParams.startNameSet_=!0,newParams.indexStartName_=key):(newParams.startNameSet_=!1,newParams.indexStartName_=""),newParams},QueryParams.prototype.endAt=function(indexValue,key){var newParams=this.copy_();return newParams.endSet_=!0,void 0===indexValue&&(indexValue=null),newParams.indexEndValue_=indexValue,void 0!==key?(newParams.endNameSet_=!0,newParams.indexEndName_=key):(newParams.endNameSet_=!1,newParams.indexEndName_=""),newParams},QueryParams.prototype.orderBy=function(index){var newParams=this.copy_();return newParams.index_=index,newParams},QueryParams.prototype.getQueryObject=function(){var WIRE_PROTOCOL_CONSTANTS=QueryParams.WIRE_PROTOCOL_CONSTANTS_,obj={};if(this.startSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_START_VALUE]=this.indexStartValue_,this.startNameSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_START_NAME]=this.indexStartName_)),this.endSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_END_VALUE]=this.indexEndValue_,this.endNameSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_END_NAME]=this.indexEndName_)),this.limitSet_){obj[WIRE_PROTOCOL_CONSTANTS.LIMIT]=this.limit_;var viewFrom=this.viewFrom_;""===viewFrom&&(viewFrom=this.isViewFromLeft()?WIRE_PROTOCOL_CONSTANTS.VIEW_FROM_LEFT:WIRE_PROTOCOL_CONSTANTS.VIEW_FROM_RIGHT),obj[WIRE_PROTOCOL_CONSTANTS.VIEW_FROM]=viewFrom}return this.index_!==PRIORITY_INDEX&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX]=this.index_.toString()),obj},QueryParams.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},QueryParams.prototype.isDefault=function(){return this.loadsAllData()&&this.index_==PRIORITY_INDEX},QueryParams.prototype.getNodeFilter=function(){return this.loadsAllData()?new IndexedFilter(this.getIndex()):this.hasLimit()?new LimitedFilter(this):new RangedFilter(this)},QueryParams.prototype.toRestQueryStringParameters=function(){var orderBy,REST_CONSTANTS=QueryParams.REST_QUERY_CONSTANTS_,qs={};return this.isDefault()?qs:(this.index_===PRIORITY_INDEX?orderBy=REST_CONSTANTS.PRIORITY_INDEX:this.index_===VALUE_INDEX?orderBy=REST_CONSTANTS.VALUE_INDEX:this.index_===KEY_INDEX?orderBy=REST_CONSTANTS.KEY_INDEX:(util.assert(this.index_ instanceof PathIndex,"Unrecognized index type!"),orderBy=this.index_.toString()),qs[REST_CONSTANTS.ORDER_BY]=util.stringify(orderBy),this.startSet_&&(qs[REST_CONSTANTS.START_AT]=util.stringify(this.indexStartValue_),this.startNameSet_&&(qs[REST_CONSTANTS.START_AT]+=","+util.stringify(this.indexStartName_))),this.endSet_&&(qs[REST_CONSTANTS.END_AT]=util.stringify(this.indexEndValue_),this.endNameSet_&&(qs[REST_CONSTANTS.END_AT]+=","+util.stringify(this.indexEndName_))),this.limitSet_&&(this.isViewFromLeft()?qs[REST_CONSTANTS.LIMIT_TO_FIRST]=this.limit_:qs[REST_CONSTANTS.LIMIT_TO_LAST]=this.limit_),qs)},QueryParams.WIRE_PROTOCOL_CONSTANTS_={INDEX_START_VALUE:"sp",INDEX_START_NAME:"sn",INDEX_END_VALUE:"ep",INDEX_END_NAME:"en",LIMIT:"l",VIEW_FROM:"vf",VIEW_FROM_LEFT:"l",VIEW_FROM_RIGHT:"r",INDEX:"i"},QueryParams.REST_QUERY_CONSTANTS_={ORDER_BY:"orderBy",PRIORITY_INDEX:"$priority",VALUE_INDEX:"$value",KEY_INDEX:"$key",START_AT:"startAt",END_AT:"endAt",LIMIT_TO_FIRST:"limitToFirst",LIMIT_TO_LAST:"limitToLast"},QueryParams.DEFAULT=new QueryParams,QueryParams}(),Reference=function(_super){function Reference(repo,path){if(!(repo instanceof Repo))throw new Error("new Reference() no longer supported - use app.database().");return _super.call(this,repo,path,QueryParams.DEFAULT,!1)||this}return tslib_1.__extends(Reference,_super),Reference.prototype.getKey=function(){return util.validateArgCount("Reference.key",0,0,arguments.length),this.path.isEmpty()?null:this.path.getBack()},Reference.prototype.child=function(pathString){return util.validateArgCount("Reference.child",1,1,arguments.length),"number"==typeof pathString?pathString=String(pathString):pathString instanceof Path||(null===this.path.getFront()?function(fnName,argumentNumber,pathString,optional){pathString&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/")),validatePathString(fnName,argumentNumber,pathString,optional)}("Reference.child",1,pathString,!1):validatePathString("Reference.child",1,pathString,!1)),new Reference(this.repo,this.path.child(pathString))},Reference.prototype.getParent=function(){util.validateArgCount("Reference.parent",0,0,arguments.length);var parentPath=this.path.parent();return null===parentPath?null:new Reference(this.repo,parentPath)},Reference.prototype.getRoot=function(){util.validateArgCount("Reference.root",0,0,arguments.length);for(var ref=this;null!==ref.getParent();)ref=ref.getParent();return ref},Reference.prototype.databaseProp=function(){return this.repo.database},Reference.prototype.set=function(newVal,onComplete){util.validateArgCount("Reference.set",1,2,arguments.length),validateWritablePath("Reference.set",this.path),validateFirebaseDataArg("Reference.set",1,newVal,this.path,!1),util.validateCallback("Reference.set",2,onComplete,!0);var deferred=new util.Deferred;return this.repo.setWithPriority(this.path,newVal,null,deferred.wrapCallback(onComplete)),deferred.promise},Reference.prototype.update=function(objectToMerge,onComplete){if(util.validateArgCount("Reference.update",1,2,arguments.length),validateWritablePath("Reference.update",this.path),Array.isArray(objectToMerge)){for(var newObjectToMerge={},i=0;i<objectToMerge.length;++i)newObjectToMerge[""+i]=objectToMerge[i];objectToMerge=newObjectToMerge,warn("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}validateFirebaseMergeDataArg("Reference.update",1,objectToMerge,this.path,!1),util.validateCallback("Reference.update",2,onComplete,!0);var deferred=new util.Deferred;return this.repo.update(this.path,objectToMerge,deferred.wrapCallback(onComplete)),deferred.promise},Reference.prototype.setWithPriority=function(newVal,newPriority,onComplete){if(util.validateArgCount("Reference.setWithPriority",2,3,arguments.length),validateWritablePath("Reference.setWithPriority",this.path),validateFirebaseDataArg("Reference.setWithPriority",1,newVal,this.path,!1),validatePriority("Reference.setWithPriority",2,newPriority,!1),util.validateCallback("Reference.setWithPriority",3,onComplete,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.setWithPriority failed: "+this.getKey()+" is a read-only object.";var deferred=new util.Deferred;return this.repo.setWithPriority(this.path,newVal,newPriority,deferred.wrapCallback(onComplete)),deferred.promise},Reference.prototype.remove=function(onComplete){return util.validateArgCount("Reference.remove",0,1,arguments.length),validateWritablePath("Reference.remove",this.path),util.validateCallback("Reference.remove",1,onComplete,!0),this.set(null,onComplete)},Reference.prototype.transaction=function(transactionUpdate,onComplete,applyLocally){if(util.validateArgCount("Reference.transaction",1,3,arguments.length),validateWritablePath("Reference.transaction",this.path),util.validateCallback("Reference.transaction",1,transactionUpdate,!1),util.validateCallback("Reference.transaction",2,onComplete,!0),function(fnName,argumentNumber,bool,optional){if((!optional||void 0!==bool)&&"boolean"!=typeof bool)throw new Error(util.errorPrefix(fnName,argumentNumber,optional)+"must be a boolean.")}("Reference.transaction",3,applyLocally,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.transaction failed: "+this.getKey()+" is a read-only object.";void 0===applyLocally&&(applyLocally=!0);var deferred=new util.Deferred;"function"==typeof onComplete&&deferred.promise.catch(function(){});return this.repo.startTransaction(this.path,transactionUpdate,function(error,committed,snapshot){error?deferred.reject(error):deferred.resolve(new TransactionResult(committed,snapshot)),"function"==typeof onComplete&&onComplete(error,committed,snapshot)},applyLocally),deferred.promise},Reference.prototype.setPriority=function(priority,onComplete){util.validateArgCount("Reference.setPriority",1,2,arguments.length),validateWritablePath("Reference.setPriority",this.path),validatePriority("Reference.setPriority",1,priority,!1),util.validateCallback("Reference.setPriority",2,onComplete,!0);var deferred=new util.Deferred;return this.repo.setWithPriority(this.path.child(".priority"),priority,null,deferred.wrapCallback(onComplete)),deferred.promise},Reference.prototype.push=function(value,onComplete){util.validateArgCount("Reference.push",0,2,arguments.length),validateWritablePath("Reference.push",this.path),validateFirebaseDataArg("Reference.push",1,value,this.path,!0),util.validateCallback("Reference.push",2,onComplete,!0);var promise,now=this.repo.serverTime(),name=nextPushId(now),thennablePushRef=this.child(name),pushRef=this.child(name);return promise=null!=value?thennablePushRef.set(value,onComplete).then(function(){return pushRef}):Promise.resolve(pushRef),thennablePushRef.then=promise.then.bind(promise),thennablePushRef.catch=promise.then.bind(promise,void 0),"function"==typeof onComplete&&promise.catch(function(){}),thennablePushRef},Reference.prototype.onDisconnect=function(){return validateWritablePath("Reference.onDisconnect",this.path),new OnDisconnect(this.repo,this.path)},Object.defineProperty(Reference.prototype,"database",{get:function(){return this.databaseProp()},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"key",{get:function(){return this.getKey()},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"parent",{get:function(){return this.getParent()},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"root",{get:function(){return this.getRoot()},enumerable:!0,configurable:!0}),Reference}(Query);
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Query.__referenceConstructor=Reference,SyncPoint.__referenceConstructor=Reference;
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var TransactionStatus,TreeNode=function(){return function(){this.children={},this.childCount=0,this.value=null}}(),Tree=function(){function Tree(name_,parent_,node_){void 0===name_&&(name_=""),void 0===parent_&&(parent_=null),void 0===node_&&(node_=new TreeNode),this.name_=name_,this.parent_=parent_,this.node_=node_}return Tree.prototype.subTree=function(pathObj){for(var next,path=pathObj instanceof Path?pathObj:new Path(pathObj),child=this;null!==(next=path.getFront());){child=new Tree(next,child,util.safeGet(child.node_.children,next)||new TreeNode),path=path.popFront()}return child},Tree.prototype.getValue=function(){return this.node_.value},Tree.prototype.setValue=function(value){util.assert(void 0!==value,"Cannot set value to undefined"),this.node_.value=value,this.updateParents_()},Tree.prototype.clear=function(){this.node_.value=null,this.node_.children={},this.node_.childCount=0,this.updateParents_()},Tree.prototype.hasChildren=function(){return this.node_.childCount>0},Tree.prototype.isEmpty=function(){return null===this.getValue()&&!this.hasChildren()},Tree.prototype.forEachChild=function(action){var _this=this;util.forEach(this.node_.children,function(child,childTree){action(new Tree(child,_this,childTree))})},Tree.prototype.forEachDescendant=function(action,includeSelf,childrenFirst){includeSelf&&!childrenFirst&&action(this),this.forEachChild(function(child){child.forEachDescendant(action,!0,childrenFirst)}),includeSelf&&childrenFirst&&action(this)},Tree.prototype.forEachAncestor=function(action,includeSelf){for(var node=includeSelf?this:this.parent();null!==node;){if(action(node))return!0;node=node.parent()}return!1},Tree.prototype.forEachImmediateDescendantWithValue=function(action){this.forEachChild(function(child){null!==child.getValue()?action(child):child.forEachImmediateDescendantWithValue(action)})},Tree.prototype.path=function(){return new Path(null===this.parent_?this.name_:this.parent_.path()+"/"+this.name_)},Tree.prototype.name=function(){return this.name_},Tree.prototype.parent=function(){return this.parent_},Tree.prototype.updateParents_=function(){null!==this.parent_&&this.parent_.updateChild_(this.name_,this)},Tree.prototype.updateChild_=function(childName,child){var childEmpty=child.isEmpty(),childExists=util.contains(this.node_.children,childName);childEmpty&&childExists?(delete this.node_.children[childName],this.node_.childCount--,this.updateParents_()):childEmpty||childExists||(this.node_.children[childName]=child.node_,this.node_.childCount++,this.updateParents_())},Tree}();!function(TransactionStatus){TransactionStatus[TransactionStatus.RUN=0]="RUN",TransactionStatus[TransactionStatus.SENT=1]="SENT",TransactionStatus[TransactionStatus.COMPLETED=2]="COMPLETED",TransactionStatus[TransactionStatus.SENT_NEEDS_ABORT=3]="SENT_NEEDS_ABORT",TransactionStatus[TransactionStatus.NEEDS_ABORT=4]="NEEDS_ABORT"}(TransactionStatus||(TransactionStatus={})),Repo.MAX_TRANSACTION_RETRIES_=25,Repo.prototype.transactions_init_=function(){this.transactionQueueTree_=new Tree},Repo.prototype.startTransaction=function(path,transactionUpdate,onComplete,applyLocally){this.log_("transaction on "+path);var valueCallback=function(){},watchRef=new Reference(this,path);watchRef.on("value",valueCallback);var transaction={path:path,update:transactionUpdate,onComplete:onComplete,status:null,order:LUIDGenerator(),applyLocally:applyLocally,retryCount:0,unwatcher:function(){watchRef.off("value",valueCallback)},abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},currentState=this.getLatestState_(path);transaction.currentInputSnapshot=currentState;var newVal=transaction.update(currentState.val());if(void 0===newVal){if(transaction.unwatcher(),transaction.currentOutputSnapshotRaw=null,transaction.currentOutputSnapshotResolved=null,transaction.onComplete){var snapshot=new DataSnapshot(transaction.currentInputSnapshot,new Reference(this,transaction.path),PRIORITY_INDEX);transaction.onComplete(null,!1,snapshot)}}else{validateFirebaseData("transaction failed: Data returned ",newVal,transaction.path),transaction.status=TransactionStatus.RUN;var queueNode=this.transactionQueueTree_.subTree(path),nodeQueue=queueNode.getValue()||[];nodeQueue.push(transaction),queueNode.setValue(nodeQueue);var priorityForNode=void 0;if("object"==typeof newVal&&null!==newVal&&util.contains(newVal,".priority"))priorityForNode=util.safeGet(newVal,".priority"),util.assert(isValidPriority(priorityForNode),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.");else priorityForNode=(this.serverSyncTree_.calcCompleteEventCache(path)||ChildrenNode.EMPTY_NODE).getPriority().val();priorityForNode=priorityForNode;var serverValues=this.generateServerValues(),newNodeUnresolved=nodeFromJSON$1(newVal,priorityForNode),newNode=resolveDeferredValueSnapshot(newNodeUnresolved,serverValues);transaction.currentOutputSnapshotRaw=newNodeUnresolved,transaction.currentOutputSnapshotResolved=newNode,transaction.currentWriteId=this.getNextWriteId_();var events=this.serverSyncTree_.applyUserOverwrite(path,newNode,transaction.currentWriteId,transaction.applyLocally);this.eventQueue_.raiseEventsForChangedPath(path,events),this.sendReadyTransactions_()}},Repo.prototype.getLatestState_=function(path,excludeSets){return this.serverSyncTree_.calcCompleteEventCache(path,excludeSets)||ChildrenNode.EMPTY_NODE},Repo.prototype.sendReadyTransactions_=function(node){var _this=this;if(void 0===node&&(node=this.transactionQueueTree_),node||this.pruneCompletedTransactionsBelowNode_(node),null!==node.getValue()){var queue=this.buildTransactionQueue_(node);util.assert(queue.length>0,"Sending zero length transaction queue"),queue.every(function(transaction){return transaction.status===TransactionStatus.RUN})&&this.sendTransactionQueue_(node.path(),queue)}else node.hasChildren()&&node.forEachChild(function(childNode){_this.sendReadyTransactions_(childNode)})},Repo.prototype.sendTransactionQueue_=function(path,queue){for(var _this=this,setsToIgnore=queue.map(function(txn){return txn.currentWriteId}),latestState=this.getLatestState_(path,setsToIgnore),snapToSend=latestState,latestHash=latestState.hash(),i=0;i<queue.length;i++){var txn=queue[i];util.assert(txn.status===TransactionStatus.RUN,"tryToSendTransactionQueue_: items in queue should all be run."),txn.status=TransactionStatus.SENT,txn.retryCount++;var relativePath=Path.relativePath(path,txn.path);snapToSend=snapToSend.updateChild(relativePath,txn.currentOutputSnapshotRaw)}var dataToSend=snapToSend.val(!0),pathToSend=path;this.server_.put(pathToSend.toString(),dataToSend,function(status){_this.log_("transaction put response",{path:pathToSend.toString(),status:status});var events=[];if("ok"===status){for(var callbacks=[],i=0;i<queue.length;i++){if(queue[i].status=TransactionStatus.COMPLETED,events=events.concat(_this.serverSyncTree_.ackUserWrite(queue[i].currentWriteId)),queue[i].onComplete){var node=queue[i].currentOutputSnapshotResolved,ref=new Reference(_this,queue[i].path),snapshot=new DataSnapshot(node,ref,PRIORITY_INDEX);callbacks.push(queue[i].onComplete.bind(null,null,!0,snapshot))}queue[i].unwatcher()}_this.pruneCompletedTransactionsBelowNode_(_this.transactionQueueTree_.subTree(path)),_this.sendReadyTransactions_(),_this.eventQueue_.raiseEventsForChangedPath(path,events);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i])}else{if("datastale"===status)for(i=0;i<queue.length;i++)queue[i].status===TransactionStatus.SENT_NEEDS_ABORT?queue[i].status=TransactionStatus.NEEDS_ABORT:queue[i].status=TransactionStatus.RUN;else{warn("transaction at "+pathToSend.toString()+" failed: "+status);for(i=0;i<queue.length;i++)queue[i].status=TransactionStatus.NEEDS_ABORT,queue[i].abortReason=status}_this.rerunTransactions_(path)}},latestHash)},Repo.prototype.rerunTransactions_=function(changedPath){var rootMostTransactionNode=this.getAncestorTransactionNode_(changedPath),path=rootMostTransactionNode.path(),queue=this.buildTransactionQueue_(rootMostTransactionNode);return this.rerunTransactionQueue_(queue,path),path},Repo.prototype.rerunTransactionQueue_=function(queue,path){if(0!==queue.length){for(var unwatcher,callbacks=[],events=[],setsToIgnore=queue.filter(function(q){return q.status===TransactionStatus.RUN}).map(function(q){return q.currentWriteId}),i=0;i<queue.length;i++){var transaction=queue[i],relativePath=Path.relativePath(path,transaction.path),abortTransaction=!1,abortReason=void 0;if(util.assert(null!==relativePath,"rerunTransactionsUnderNode_: relativePath should not be null."),transaction.status===TransactionStatus.NEEDS_ABORT)abortTransaction=!0,abortReason=transaction.abortReason,events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,!0));else if(transaction.status===TransactionStatus.RUN)if(transaction.retryCount>=Repo.MAX_TRANSACTION_RETRIES_)abortTransaction=!0,abortReason="maxretry",events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,!0));else{var currentNode=this.getLatestState_(transaction.path,setsToIgnore);transaction.currentInputSnapshot=currentNode;var newData=queue[i].update(currentNode.val());if(void 0!==newData){validateFirebaseData("transaction failed: Data returned ",newData,transaction.path);var newDataNode=nodeFromJSON$1(newData);"object"==typeof newData&&null!=newData&&util.contains(newData,".priority")||(newDataNode=newDataNode.updatePriority(currentNode.getPriority()));var oldWriteId=transaction.currentWriteId,serverValues=this.generateServerValues(),newNodeResolved=resolveDeferredValueSnapshot(newDataNode,serverValues);transaction.currentOutputSnapshotRaw=newDataNode,transaction.currentOutputSnapshotResolved=newNodeResolved,transaction.currentWriteId=this.getNextWriteId_(),setsToIgnore.splice(setsToIgnore.indexOf(oldWriteId),1),events=(events=events.concat(this.serverSyncTree_.applyUserOverwrite(transaction.path,newNodeResolved,transaction.currentWriteId,transaction.applyLocally))).concat(this.serverSyncTree_.ackUserWrite(oldWriteId,!0))}else abortTransaction=!0,abortReason="nodata",events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,!0))}if(this.eventQueue_.raiseEventsForChangedPath(path,events),events=[],abortTransaction&&(queue[i].status=TransactionStatus.COMPLETED,unwatcher=queue[i].unwatcher,setTimeout(unwatcher,Math.floor(0)),queue[i].onComplete))if("nodata"===abortReason){var ref=new Reference(this,queue[i].path),lastInput=queue[i].currentInputSnapshot,snapshot=new DataSnapshot(lastInput,ref,PRIORITY_INDEX);callbacks.push(queue[i].onComplete.bind(null,null,!1,snapshot))}else callbacks.push(queue[i].onComplete.bind(null,new Error(abortReason),!1,null))}this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i]);this.sendReadyTransactions_()}},Repo.prototype.getAncestorTransactionNode_=function(path){for(var front,transactionNode=this.transactionQueueTree_;null!==(front=path.getFront())&&null===transactionNode.getValue();)transactionNode=transactionNode.subTree(front),path=path.popFront();return transactionNode},Repo.prototype.buildTransactionQueue_=function(transactionNode){var transactionQueue=[];return this.aggregateTransactionQueuesForNode_(transactionNode,transactionQueue),transactionQueue.sort(function(a,b){return a.order-b.order}),transactionQueue},Repo.prototype.aggregateTransactionQueuesForNode_=function(node,queue){var _this=this,nodeQueue=node.getValue();if(null!==nodeQueue)for(var i=0;i<nodeQueue.length;i++)queue.push(nodeQueue[i]);node.forEachChild(function(child){_this.aggregateTransactionQueuesForNode_(child,queue)})},Repo.prototype.pruneCompletedTransactionsBelowNode_=function(node){var _this=this,queue=node.getValue();if(queue){for(var to=0,from=0;from<queue.length;from++)queue[from].status!==TransactionStatus.COMPLETED&&(queue[to]=queue[from],to++);queue.length=to,node.setValue(queue.length>0?queue:null)}node.forEachChild(function(childNode){_this.pruneCompletedTransactionsBelowNode_(childNode)})},Repo.prototype.abortTransactions_=function(path){var _this=this,affectedPath=this.getAncestorTransactionNode_(path).path(),transactionNode=this.transactionQueueTree_.subTree(path);return transactionNode.forEachAncestor(function(node){_this.abortTransactionsOnNode_(node)}),this.abortTransactionsOnNode_(transactionNode),transactionNode.forEachDescendant(function(node){_this.abortTransactionsOnNode_(node)}),affectedPath},Repo.prototype.abortTransactionsOnNode_=function(node){var queue=node.getValue();if(null!==queue){for(var callbacks=[],events=[],lastSent=-1,i=0;i<queue.length;i++)if(queue[i].status===TransactionStatus.SENT_NEEDS_ABORT);else if(queue[i].status===TransactionStatus.SENT)util.assert(lastSent===i-1,"All SENT items should be at beginning of queue."),lastSent=i,queue[i].status=TransactionStatus.SENT_NEEDS_ABORT,queue[i].abortReason="set";else if(util.assert(queue[i].status===TransactionStatus.RUN,"Unexpected transaction status in abort"),queue[i].unwatcher(),events=events.concat(this.serverSyncTree_.ackUserWrite(queue[i].currentWriteId,!0)),queue[i].onComplete){callbacks.push(queue[i].onComplete.bind(null,new Error("set"),!1,null))}-1===lastSent?node.setValue(null):queue.length=lastSent+1,this.eventQueue_.raiseEventsForChangedPath(node.path(),events);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i])}};
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var _staticInstance,RepoManager=function(){function RepoManager(){this.repos_={},this.useRestClient_=!1}return RepoManager.getInstance=function(){return _staticInstance||(_staticInstance=new RepoManager),_staticInstance},RepoManager.prototype.interrupt=function(){for(var appName in this.repos_)for(var dbUrl in this.repos_[appName])this.repos_[appName][dbUrl].interrupt()},RepoManager.prototype.resume=function(){for(var appName in this.repos_)for(var dbUrl in this.repos_[appName])this.repos_[appName][dbUrl].resume()},RepoManager.prototype.databaseFromApp=function(app,url){var dbUrl=url||app.options.databaseURL;void 0===dbUrl&&fatal("Can't determine Firebase Database URL.  Be sure to include databaseURL option when calling firebase.initializeApp().");var parsedUrl=parseRepoInfo(dbUrl),repoInfo=parsedUrl.repoInfo;return validateUrl("Invalid Firebase Database URL",1,parsedUrl),parsedUrl.path.isEmpty()||fatal("Database URL must point to the root of a Firebase Database (not including a child path)."),this.createRepo(repoInfo,app).database},RepoManager.prototype.deleteRepo=function(repo){var appRepos=util.safeGet(this.repos_,repo.app.name);appRepos&&util.safeGet(appRepos,repo.repoInfo_.toURLString())===repo||fatal("Database "+repo.app.name+"("+repo.repoInfo_+") has already been deleted."),repo.interrupt(),delete appRepos[repo.repoInfo_.toURLString()]},RepoManager.prototype.createRepo=function(repoInfo,app){var appRepos=util.safeGet(this.repos_,app.name);appRepos||(appRepos={},this.repos_[app.name]=appRepos);var repo=util.safeGet(appRepos,repoInfo.toURLString());return repo&&fatal("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),repo=new Repo(repoInfo,this.useRestClient_,app),appRepos[repoInfo.toURLString()]=repo,repo},RepoManager.prototype.forceRestClient=function(forceRestClient){this.useRestClient_=forceRestClient},RepoManager}(),Database=function(){function Database(repo_){this.repo_=repo_,repo_ instanceof Repo||fatal("Don't call new Database() directly - please use firebase.database()."),this.root_=new Reference(repo_,Path.Empty),this.INTERNAL=new DatabaseInternals(this)}return Object.defineProperty(Database.prototype,"app",{get:function(){return this.repo_.app},enumerable:!0,configurable:!0}),Database.prototype.ref=function(path){return this.checkDeleted_("ref"),util.validateArgCount("database.ref",0,1,arguments.length),path instanceof Reference?this.refFromURL(path.toString()):void 0!==path?this.root_.child(path):this.root_},Database.prototype.refFromURL=function(url){var apiName="database.refFromURL";this.checkDeleted_(apiName),util.validateArgCount(apiName,1,1,arguments.length);var parsedURL=parseRepoInfo(url);validateUrl(apiName,1,parsedURL);var repoInfo=parsedURL.repoInfo;return repoInfo.host!==this.repo_.repoInfo_.host&&fatal(apiName+": Host name does not match the current database: (found "+repoInfo.host+" but expected "+this.repo_.repoInfo_.host+")"),this.ref(parsedURL.path.toString())},Database.prototype.checkDeleted_=function(apiName){null===this.repo_&&fatal("Cannot call "+apiName+" on a deleted database.")},Database.prototype.goOffline=function(){util.validateArgCount("database.goOffline",0,0,arguments.length),this.checkDeleted_("goOffline"),this.repo_.interrupt()},Database.prototype.goOnline=function(){util.validateArgCount("database.goOnline",0,0,arguments.length),this.checkDeleted_("goOnline"),this.repo_.resume()},Database.ServerValue={TIMESTAMP:{".sv":"timestamp"}},Database}(),DatabaseInternals=function(){function DatabaseInternals(database){this.database=database}return DatabaseInternals.prototype.delete=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this.database.checkDeleted_("delete"),RepoManager.getInstance().deleteRepo(this.database.repo_),this.database.repo_=null,this.database.root_=null,this.database.INTERNAL=null,this.database=null,[2]})})},DatabaseInternals}(),INTERNAL=Object.freeze({forceLongPolling:function(){WebSocketConnection.forceDisallow(),BrowserPollConnection.forceAllow()},forceWebSockets:function(){BrowserPollConnection.forceDisallow()},isWebSocketsAvailable:function(){return WebSocketConnection.isAvailable()},setSecurityDebugCallback:function(ref,callback){ref.repo.persistentConnection_.securityDebugCallback_=callback},stats:function(ref,showDelta){ref.repo.stats(showDelta)},statsIncrementCounter:function(ref,metric){ref.repo.statsIncrementCounter(metric)},dataUpdateCount:function(ref){return ref.repo.dataUpdateCount},interceptServerData:function(ref,callback){return ref.repo.interceptServerData_(callback)}}),DataConnection=PersistentConnection;PersistentConnection.prototype.simpleListen=function(pathString,onComplete){this.sendRequest("q",{p:pathString},onComplete)},PersistentConnection.prototype.echo=function(data,onEcho){this.sendRequest("echo",{d:data},onEcho)};var RealTimeConnection=Connection,ConnectionTarget=RepoInfo,TEST_ACCESS=Object.freeze({DataConnection:DataConnection,RealTimeConnection:RealTimeConnection,hijackHash:function(newHash){var oldPut=PersistentConnection.prototype.put;return PersistentConnection.prototype.put=function(pathString,data,opt_onComplete,opt_hash){void 0!==opt_hash&&(opt_hash=newHash()),oldPut.call(this,pathString,data,opt_onComplete,opt_hash)},function(){PersistentConnection.prototype.put=oldPut}},ConnectionTarget:ConnectionTarget,queryIdentifier:function(query){return query.queryIdentifier()},listens:function(firebaseRef){return firebaseRef.repo.persistentConnection_.listens_},forceRestClient:function(forceRestClient){RepoManager.getInstance().forceRestClient(forceRestClient)}}),ServerValue=Database.ServerValue;function registerDatabase(instance){var namespace=instance.INTERNAL.registerService("database",function(app,unused,url){return RepoManager.getInstance().databaseFromApp(app,url)},{Reference:Reference,Query:Query,Database:Database,DataSnapshot:DataSnapshot,enableLogging:enableLogging,INTERNAL:INTERNAL,ServerValue:ServerValue,TEST_ACCESS:TEST_ACCESS},null,!0);util.isNodeSdk()&&(module.exports=namespace)}registerDatabase(firebase),exports.DataSnapshot=DataSnapshot,exports.Database=Database,exports.OnDisconnect=OnDisconnect,exports.Query=Query,exports.Reference=Reference,exports.ServerValue=ServerValue,exports.enableLogging=enableLogging,exports.registerDatabase=registerDatabase}).call(this,__webpack_require__(53))},53:function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},54:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"__extends",function(){return __extends}),__webpack_require__.d(__webpack_exports__,"__assign",function(){return __assign}),__webpack_require__.d(__webpack_exports__,"__rest",function(){return __rest}),__webpack_require__.d(__webpack_exports__,"__decorate",function(){return __decorate}),__webpack_require__.d(__webpack_exports__,"__param",function(){return __param}),__webpack_require__.d(__webpack_exports__,"__metadata",function(){return __metadata}),__webpack_require__.d(__webpack_exports__,"__awaiter",function(){return __awaiter}),__webpack_require__.d(__webpack_exports__,"__generator",function(){return __generator}),__webpack_require__.d(__webpack_exports__,"__exportStar",function(){return __exportStar}),__webpack_require__.d(__webpack_exports__,"__values",function(){return __values}),__webpack_require__.d(__webpack_exports__,"__read",function(){return __read}),__webpack_require__.d(__webpack_exports__,"__spread",function(){return __spread}),__webpack_require__.d(__webpack_exports__,"__await",function(){return __await}),__webpack_require__.d(__webpack_exports__,"__asyncGenerator",function(){return __asyncGenerator}),__webpack_require__.d(__webpack_exports__,"__asyncDelegator",function(){return __asyncDelegator}),__webpack_require__.d(__webpack_exports__,"__asyncValues",function(){return __asyncValues}),__webpack_require__.d(__webpack_exports__,"__makeTemplateObject",function(){return __makeTemplateObject}),__webpack_require__.d(__webpack_exports__,"__importStar",function(){return __importStar}),__webpack_require__.d(__webpack_exports__,"__importDefault",function(){return __importDefault});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&(t[p[i]]=s[p[i]])}return t}function __decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function __param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}function __metadata(metadataKey,metadataValue){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)}function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __exportStar(m,exports){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}function __values(o){var m="function"==typeof Symbol&&o[Symbol.iterator],i=0;return m?m.call(o):{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}}}function __read(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar}function __spread(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar}function __await(v){return this instanceof __await?(this.v=v,this):new __await(v)}function __asyncGenerator(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,g=generator.apply(thisArg,_arguments||[]),q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){g[n]&&(i[n]=function(v){return new Promise(function(a,b){q.push([n,v,a,b])>1||resume(n,v)})})}function resume(n,v){try{(r=g[n](v)).value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}catch(e){settle(q[0][3],e)}var r}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){f(v),q.shift(),q.length&&resume(q[0][0],q[0][1])}}function __asyncDelegator(o){var i,p;return i={},verb("next"),verb("throw",function(e){throw e}),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:"return"===n}:f?f(v):v}:f}}function __asyncValues(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,m=o[Symbol.asyncIterator];return m?m.call(o):(o=__values(o),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise(function(resolve,reject){(function(resolve,reject,d,v){Promise.resolve(v).then(function(v){resolve({value:v,done:d})},reject)})(resolve,reject,(v=o[n](v)).done,v.value)})}}}function __makeTemplateObject(cooked,raw){return Object.defineProperty?Object.defineProperty(cooked,"raw",{value:raw}):cooked.raw=raw,cooked}function __importStar(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result}function __importDefault(mod){return mod&&mod.__esModule?mod:{default:mod}}},55:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(56);
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */},56:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"registerStorage",function(){return registerStorage});var _firebase_app__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(46),_firebase_app__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_firebase_app__WEBPACK_IMPORTED_MODULE_0__),DEFAULT_HOST="firebasestorage.googleapis.com",DEFAULT_MAX_OPERATION_RETRY_TIME=12e4,DEFAULT_MAX_UPLOAD_RETRY_TIME=6e4,MIN_SAFE_INTEGER=-9007199254740991,FirebaseStorageError=function(){function FirebaseStorageError(code,message){this.code_=prependCode(code),this.message_="Firebase Storage: "+message,this.serverResponse_=null,this.name_="FirebaseError"}return FirebaseStorageError.prototype.codeProp=function(){return this.code},FirebaseStorageError.prototype.codeEquals=function(code){return prependCode(code)===this.codeProp()},FirebaseStorageError.prototype.serverResponseProp=function(){return this.serverResponse_},FirebaseStorageError.prototype.setServerResponseProp=function(serverResponse){this.serverResponse_=serverResponse},Object.defineProperty(FirebaseStorageError.prototype,"name",{get:function(){return this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseStorageError.prototype,"code",{get:function(){return this.code_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseStorageError.prototype,"message",{get:function(){return this.message_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseStorageError.prototype,"serverResponse",{get:function(){return this.serverResponse_},enumerable:!0,configurable:!0}),FirebaseStorageError}(),Code={UNKNOWN:"unknown",OBJECT_NOT_FOUND:"object-not-found",BUCKET_NOT_FOUND:"bucket-not-found",PROJECT_NOT_FOUND:"project-not-found",QUOTA_EXCEEDED:"quota-exceeded",UNAUTHENTICATED:"unauthenticated",UNAUTHORIZED:"unauthorized",RETRY_LIMIT_EXCEEDED:"retry-limit-exceeded",INVALID_CHECKSUM:"invalid-checksum",CANCELED:"canceled",INVALID_EVENT_NAME:"invalid-event-name",INVALID_URL:"invalid-url",INVALID_DEFAULT_BUCKET:"invalid-default-bucket",NO_DEFAULT_BUCKET:"no-default-bucket",CANNOT_SLICE_BLOB:"cannot-slice-blob",SERVER_FILE_WRONG_SIZE:"server-file-wrong-size",NO_DOWNLOAD_URL:"no-download-url",INVALID_ARGUMENT:"invalid-argument",INVALID_ARGUMENT_COUNT:"invalid-argument-count",APP_DELETED:"app-deleted",INVALID_ROOT_OPERATION:"invalid-root-operation",INVALID_FORMAT:"invalid-format",INTERNAL_ERROR:"internal-error"};function prependCode(code){return"storage/"+code}function unknown(){return new FirebaseStorageError(Code.UNKNOWN,"An unknown error occurred, please check the error payload for server response.")}function canceled(){return new FirebaseStorageError(Code.CANCELED,"User canceled the upload/download.")}function cannotSliceBlob(){return new FirebaseStorageError(Code.CANNOT_SLICE_BLOB,"Cannot slice blob for upload. Please retry the upload.")}function invalidArgument(index,fnName,message){return new FirebaseStorageError(Code.INVALID_ARGUMENT,"Invalid argument in `"+fnName+"` at index "+index+": "+message)}function appDeleted(){return new FirebaseStorageError(Code.APP_DELETED,"The Firebase app was deleted.")}function invalidFormat(format,message){return new FirebaseStorageError(Code.INVALID_FORMAT,"String does not match format '"+format+"': "+message)}function internalError(message){throw new FirebaseStorageError(Code.INTERNAL_ERROR,"Internal error: "+message)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var StringFormat={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"};function formatValidator(stringFormat){switch(stringFormat){case StringFormat.RAW:case StringFormat.BASE64:case StringFormat.BASE64URL:case StringFormat.DATA_URL:return;default:throw"Expected one of the event types: ["+StringFormat.RAW+", "+StringFormat.BASE64+", "+StringFormat.BASE64URL+", "+StringFormat.DATA_URL+"]."}}var StringData=function(){return function(data,opt_contentType){this.data=data,this.contentType=opt_contentType||null}}();function dataFromString(format,string){switch(format){case StringFormat.RAW:return new StringData(utf8Bytes_(string));case StringFormat.BASE64:case StringFormat.BASE64URL:return new StringData(base64Bytes_(format,string));case StringFormat.DATA_URL:return new StringData(function(string){var parts=new DataURLParts(string);return parts.base64?base64Bytes_(StringFormat.BASE64,parts.rest):function(string){var decoded;try{decoded=decodeURIComponent(string)}catch(e){throw invalidFormat(StringFormat.DATA_URL,"Malformed data URL.")}return utf8Bytes_(decoded)}(parts.rest)}(string),function(string){return new DataURLParts(string).contentType}(string))}throw unknown()}function utf8Bytes_(string){for(var b=[],i=0;i<string.length;i++){var c=string.charCodeAt(i);if(c<=127)b.push(c);else if(c<=2047)b.push(192|c>>6,128|63&c);else if(55296==(64512&c))if(i<string.length-1&&56320==(64512&string.charCodeAt(i+1)))c=65536|(1023&c)<<10|1023&string.charCodeAt(++i),b.push(240|c>>18,128|c>>12&63,128|c>>6&63,128|63&c);else b.push(239,191,189);else 56320==(64512&c)?b.push(239,191,189):b.push(224|c>>12,128|c>>6&63,128|63&c)}return new Uint8Array(b)}function base64Bytes_(format,string){switch(format){case StringFormat.BASE64:var hasMinus=-1!==string.indexOf("-"),hasUnder=-1!==string.indexOf("_");if(hasMinus||hasUnder)throw invalidFormat(format,"Invalid character '"+(hasMinus?"-":"_")+"' found: is it base64url encoded?");break;case StringFormat.BASE64URL:var hasPlus=-1!==string.indexOf("+"),hasSlash=-1!==string.indexOf("/");if(hasPlus||hasSlash)throw invalidFormat(format,"Invalid character '"+(hasPlus?"+":"/")+"' found: is it base64 encoded?");string=string.replace(/-/g,"+").replace(/_/g,"/")}var bytes;try{bytes=atob(string)}catch(e){throw invalidFormat(format,"Invalid character found")}for(var array=new Uint8Array(bytes.length),i=0;i<bytes.length;i++)array[i]=bytes.charCodeAt(i);return array}var DataURLParts=function(){return function(dataURL){this.base64=!1,this.contentType=null;var matches=dataURL.match(/^data:([^,]+)?,/);if(null===matches)throw invalidFormat(StringFormat.DATA_URL,"Must be formatted 'data:[<mediatype>][;base64],<data>");var middle=matches[1]||null;null!=middle&&(this.base64=(s=middle,end=";base64",s.length>=end.length&&s.substring(s.length-end.length)===end),this.contentType=this.base64?middle.substring(0,middle.length-";base64".length):middle),this.rest=dataURL.substring(dataURL.indexOf(",")+1);var s,end;
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */}}();var ErrorCode,TaskEvent={STATE_CHANGED:"state_changed"},InternalTaskState={RUNNING:"running",PAUSING:"pausing",PAUSED:"paused",SUCCESS:"success",CANCELING:"canceling",CANCELED:"canceled",ERROR:"error"},TaskState={RUNNING:"running",PAUSED:"paused",SUCCESS:"success",CANCELED:"canceled",ERROR:"error"};function taskStateFromInternalTaskState(state){switch(state){case InternalTaskState.RUNNING:case InternalTaskState.PAUSING:case InternalTaskState.CANCELING:return TaskState.RUNNING;case InternalTaskState.PAUSED:return TaskState.PAUSED;case InternalTaskState.SUCCESS:return TaskState.SUCCESS;case InternalTaskState.CANCELED:return TaskState.CANCELED;case InternalTaskState.ERROR:default:return TaskState.ERROR}}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function contains(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}function forEach(obj,f){for(var key in obj)contains(obj,key)&&f(key,obj[key])}function clone(obj){if(null==obj)return{};var c={};return forEach(obj,function(key,val){c[key]=val}),c}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function make(resolver){return new Promise(resolver)}function resolve(value){return Promise.resolve(value)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function isDef(p){return null!=p}function isJustDef(p){return void 0!==p}function isFunction(p){return"function"==typeof p}function isObject(p){return"object"==typeof p}function isNonNullObject(p){return isObject(p)&&null!==p}function isString(p){return"string"==typeof p||p instanceof String}function isNativeBlob(p){return isNativeBlobDefined()&&p instanceof Blob}function isNativeBlobDefined(){return"undefined"!=typeof Blob}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */!function(ErrorCode){ErrorCode[ErrorCode.NO_ERROR=0]="NO_ERROR",ErrorCode[ErrorCode.NETWORK_ERROR=1]="NETWORK_ERROR",ErrorCode[ErrorCode.ABORT=2]="ABORT"}(ErrorCode||(ErrorCode={}));
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var NetworkXhrIo=function(){function NetworkXhrIo(){var _this=this;this.sent_=!1,this.xhr_=new XMLHttpRequest,this.errorCode_=ErrorCode.NO_ERROR,this.sendPromise_=make(function(resolve,reject){_this.xhr_.addEventListener("abort",function(event){_this.errorCode_=ErrorCode.ABORT,resolve(_this)}),_this.xhr_.addEventListener("error",function(event){_this.errorCode_=ErrorCode.NETWORK_ERROR,resolve(_this)}),_this.xhr_.addEventListener("load",function(event){resolve(_this)})})}return NetworkXhrIo.prototype.send=function(url,method,opt_body,opt_headers){var _this=this;if(this.sent_)throw internalError("cannot .send() more than once");(this.sent_=!0,this.xhr_.open(method,url,!0),isDef(opt_headers))&&forEach(opt_headers,function(key,val){_this.xhr_.setRequestHeader(key,val.toString())});return isDef(opt_body)?this.xhr_.send(opt_body):this.xhr_.send(),this.sendPromise_},NetworkXhrIo.prototype.getErrorCode=function(){if(!this.sent_)throw internalError("cannot .getErrorCode() before sending");return this.errorCode_},NetworkXhrIo.prototype.getStatus=function(){if(!this.sent_)throw internalError("cannot .getStatus() before sending");try{return this.xhr_.status}catch(e){return-1}},NetworkXhrIo.prototype.getResponseText=function(){if(!this.sent_)throw internalError("cannot .getResponseText() before sending");return this.xhr_.responseText},NetworkXhrIo.prototype.abort=function(){this.xhr_.abort()},NetworkXhrIo.prototype.getResponseHeader=function(header){return this.xhr_.getResponseHeader(header)},NetworkXhrIo.prototype.addUploadProgressListener=function(listener){isDef(this.xhr_.upload)&&this.xhr_.upload.addEventListener("progress",listener)},NetworkXhrIo.prototype.removeUploadProgressListener=function(listener){isDef(this.xhr_.upload)&&this.xhr_.upload.removeEventListener("progress",listener)},NetworkXhrIo}(),XhrIoPool=function(){function XhrIoPool(){}return XhrIoPool.prototype.createXhrIo=function(){return new NetworkXhrIo},XhrIoPool}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function jsonObjectOrNull(s){var obj,p;try{obj=JSON.parse(s)}catch(e){return null}return isObject(p=obj)&&!Array.isArray(p)?obj:null}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Location=function(){function Location(bucket,path){this.bucket=bucket,this.path_=path}return Object.defineProperty(Location.prototype,"path",{get:function(){return this.path_},enumerable:!0,configurable:!0}),Location.prototype.fullServerUrl=function(){var encode=encodeURIComponent;return"/b/"+encode(this.bucket)+"/o/"+encode(this.path)},Location.prototype.bucketOnlyServerUrl=function(){return"/b/"+encodeURIComponent(this.bucket)+"/o"},Location.makeFromBucketSpec=function(bucketString){var bucketLocation,bucket;try{bucketLocation=Location.makeFromUrl(bucketString)}catch(e){return new Location(bucketString,"")}if(""===bucketLocation.path)return bucketLocation;throw bucket=bucketString,new FirebaseStorageError(Code.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+bucket+"'.")},Location.makeFromUrl=function(url){var location=null;var gsRegex=new RegExp("^gs://([A-Za-z0-9.\\-_]+)(/(.*))?$","i");for(var hostRegex=DEFAULT_HOST.replace(/[.]/g,"\\."),groups=[{regex:gsRegex,indices:{bucket:1,path:3},postModify:function(loc){"/"===loc.path.charAt(loc.path.length-1)&&(loc.path_=loc.path_.slice(0,-1))}},{regex:new RegExp("^https?://"+hostRegex+"/v[A-Za-z0-9_]+/b/([A-Za-z0-9.\\-_]+)/o(/([^?#]*).*)?$","i"),indices:{bucket:1,path:3},postModify:function(loc){loc.path_=decodeURIComponent(loc.path)}}],i=0;i<groups.length;i++){var group=groups[i],captures=group.regex.exec(url);if(captures){var bucketValue=captures[group.indices.bucket],pathValue=captures[group.indices.path];pathValue||(pathValue=""),location=new Location(bucketValue,pathValue),group.postModify(location);break}}if(null==location)throw function(url){return new FirebaseStorageError(Code.INVALID_URL,"Invalid URL '"+url+"'.")}(url);return location},Location}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lastComponent(path){var index=path.lastIndexOf("/",path.length-2);return-1===index?path:path.slice(index+1)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function makeUrl(urlPart){return"https://"+DEFAULT_HOST+"/v0"+urlPart}function makeQueryString(params){var encode=encodeURIComponent,queryPart="?";return forEach(params,function(key,val){var nextPart=encode(key)+"="+encode(val);queryPart=queryPart+nextPart+"&"}),queryPart=queryPart.slice(0,-1)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function noXform_(metadata,value){return value}var Mapping=function(){return function(server,opt_local,opt_writable,opt_xform){this.server=server,this.local=opt_local||server,this.writable=!!opt_writable,this.xform=opt_xform||noXform_}}(),mappings_=null;function getMappings(){if(mappings_)return mappings_;var mappings=[];mappings.push(new Mapping("bucket")),mappings.push(new Mapping("generation")),mappings.push(new Mapping("metageneration")),mappings.push(new Mapping("name","fullPath",!0));var nameMapping=new Mapping("name");nameMapping.xform=function(metadata,fullPath){return function(fullPath){return!isString(fullPath)||fullPath.length<2?fullPath:lastComponent(fullPath=fullPath)}(fullPath)},mappings.push(nameMapping);var sizeMapping=new Mapping("size");return sizeMapping.xform=function(metadata,size){return isDef(size)?+size:size},mappings.push(sizeMapping),mappings.push(new Mapping("timeCreated")),mappings.push(new Mapping("updated")),mappings.push(new Mapping("md5Hash",null,!0)),mappings.push(new Mapping("cacheControl",null,!0)),mappings.push(new Mapping("contentDisposition",null,!0)),mappings.push(new Mapping("contentEncoding",null,!0)),mappings.push(new Mapping("contentLanguage",null,!0)),mappings.push(new Mapping("contentType",null,!0)),mappings.push(new Mapping("metadata","customMetadata",!0)),mappings_=mappings}function fromResource(authWrapper,resource,mappings){for(var metadata={type:"file"},len=mappings.length,i=0;i<len;i++){var mapping=mappings[i];metadata[mapping.local]=mapping.xform(metadata,resource[mapping.server])}return function(metadata,authWrapper){Object.defineProperty(metadata,"ref",{get:function(){var bucket=metadata.bucket,path=metadata.fullPath,loc=new Location(bucket,path);return authWrapper.makeStorageReference(loc)}})}(metadata,authWrapper),metadata}function fromResourceString(authWrapper,resourceString,mappings){var obj=jsonObjectOrNull(resourceString);return null===obj?null:fromResource(authWrapper,obj,mappings)}function toResourceString(metadata,mappings){for(var resource={},len=mappings.length,i=0;i<len;i++){var mapping=mappings[i];mapping.writable&&(resource[mapping.server]=metadata[mapping.local])}return JSON.stringify(resource)}function metadataValidator(p){if(!(p&&isObject(p)))throw"Expected Metadata object.";for(var key in p){var val=p[key];if("customMetadata"===key){if(!isObject(val))throw"Expected object for 'customMetadata' mapping."}else if(isNonNullObject(val))throw"Mapping for '"+key+"' cannot be an object."}}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function validate(name,specs,passed){for(var minArgs=specs.length,maxArgs=specs.length,i=0;i<specs.length;i++)if(specs[i].optional){minArgs=i;break}var argMin,argMax,fnName,real,countPart,plural;if(!(minArgs<=passed.length&&passed.length<=maxArgs))throw argMin=minArgs,argMax=maxArgs,fnName=name,real=passed.length,argMin===argMax?(countPart=argMin,plural=1===argMin?"argument":"arguments"):(countPart="between "+argMin+" and "+argMax,plural="arguments"),new FirebaseStorageError(Code.INVALID_ARGUMENT_COUNT,"Invalid argument count in `"+fnName+"`: Expected "+countPart+" "+plural+", received "+real+".");for(i=0;i<passed.length;i++)try{specs[i].validator(passed[i])}catch(e){throw e instanceof Error?invalidArgument(i,name,e.message):invalidArgument(i,name,e)}}var ArgSpec=function(){return function(validator,opt_optional){var self=this;this.validator=function(p){self.optional&&!isJustDef(p)||validator(p)},this.optional=!!opt_optional}}();function stringSpec(opt_validator,opt_optional){function stringValidator(p){if(!isString(p))throw"Expected string."}var validator,v1,v2;return opt_validator?(v1=stringValidator,v2=opt_validator,validator=function(p){v1(p),v2(p)}):validator=stringValidator,new ArgSpec(validator,opt_optional)}function uploadDataSpec(){return new ArgSpec(function(p){if(!(p instanceof Uint8Array||p instanceof ArrayBuffer||isNativeBlobDefined()&&p instanceof Blob))throw"Expected Blob or File."})}function metadataSpec(opt_optional){return new ArgSpec(metadataValidator,opt_optional)}function nonNegativeNumberSpec(){return new ArgSpec(function(p){if(!(function(p){return"number"==typeof p||p instanceof Number}(p)&&p>=0))throw"Expected a number 0 or greater."})}function looseObjectSpec(opt_validator,opt_optional){return new ArgSpec(function(p){if(!(null===p||isDef(p)&&p instanceof Object))throw"Expected an Object.";null!=opt_validator&&opt_validator(p)},opt_optional)}function nullFunctionSpec(opt_optional){return new ArgSpec(function(p){if(null!==p&&!isFunction(p))throw"Expected a Function."},opt_optional)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getBlobBuilder(){return"undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:void 0}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var FbsBlob=function(){function FbsBlob(data,opt_elideCopy){var size=0,blobType="";isNativeBlob(data)?(this.data_=data,size=data.size,blobType=data.type):data instanceof ArrayBuffer?(opt_elideCopy?this.data_=new Uint8Array(data):(this.data_=new Uint8Array(data.byteLength),this.data_.set(new Uint8Array(data))),size=this.data_.length):data instanceof Uint8Array&&(opt_elideCopy?this.data_=data:(this.data_=new Uint8Array(data.length),this.data_.set(data)),size=data.length),this.size_=size,this.type_=blobType}return FbsBlob.prototype.size=function(){return this.size_},FbsBlob.prototype.type=function(){return this.type_},FbsBlob.prototype.slice=function(startByte,endByte){if(isNativeBlob(this.data_)){var realBlob=this.data_,sliced=(start=startByte,end=endByte,(blob=realBlob).webkitSlice?blob.webkitSlice(start,end):blob.mozSlice?blob.mozSlice(start,end):blob.slice?blob.slice(start,end):null);return null===sliced?null:new FbsBlob(sliced)}var blob,start,end;return new FbsBlob(new Uint8Array(this.data_.buffer,startByte,endByte-startByte),!0)},FbsBlob.getBlob=function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];if(isNativeBlobDefined()){var blobby=var_args.map(function(val){return val instanceof FbsBlob?val.data_:val});return new FbsBlob(function(){for(var var_args=[],_i=0;_i<arguments.length;_i++)var_args[_i]=arguments[_i];var BlobBuilder=getBlobBuilder();if(void 0!==BlobBuilder){for(var bb=new BlobBuilder,i=0;i<var_args.length;i++)bb.append(var_args[i]);return bb.getBlob()}if(isNativeBlobDefined())return new Blob(var_args);throw Error("This browser doesn't seem to support creating Blobs")}.apply(null,blobby))}var uint8Arrays=var_args.map(function(val){return isString(val)?dataFromString(StringFormat.RAW,val).data:val.data_}),finalLength_1=0;uint8Arrays.forEach(function(array){finalLength_1+=array.byteLength});var merged_1=new Uint8Array(finalLength_1),index_1=0;return uint8Arrays.forEach(function(array){for(var i=0;i<array.length;i++)merged_1[index_1++]=array[i]}),new FbsBlob(merged_1,!0)},FbsBlob.prototype.uploadData=function(){return this.data_},FbsBlob}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function contains$1(array,elem){return-1!==array.indexOf(elem)}var RequestInfo=function(){return function(url,method,handler,timeout){this.url=url,this.method=method,this.handler=handler,this.timeout=timeout,this.urlParams={},this.headers={},this.body=null,this.errorHandler=null,this.progressCallback=null,this.successCodes=[200],this.additionalRetryCodes=[]}}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function handlerCheck(cndn){if(!cndn)throw unknown()}function metadataHandler(authWrapper,mappings){return function(xhr,text){var metadata=fromResourceString(authWrapper,text,mappings);return handlerCheck(null!==metadata),metadata}}function downloadUrlHandler(authWrapper,mappings){return function(xhr,text){var metadata=fromResourceString(authWrapper,text,mappings);return handlerCheck(null!==metadata),function(metadata,resourceString){var obj=jsonObjectOrNull(resourceString);if(null===obj)return null;if(!isString(obj.downloadTokens))return null;var tokens=obj.downloadTokens;if(0===tokens.length)return null;var encode=encodeURIComponent;return tokens.split(",").map(function(token){var bucket=metadata.bucket,path=metadata.fullPath;return makeUrl("/b/"+encode(bucket)+"/o/"+encode(path))+makeQueryString({alt:"media",token:token})})[0]}(metadata,text)}}function sharedErrorHandler(location){return function(xhr,err){var newErr,path,bucket;return 401===xhr.getStatus()?newErr=new FirebaseStorageError(Code.UNAUTHENTICATED,"User is not authenticated, please authenticate using Firebase Authentication and try again."):402===xhr.getStatus()?(bucket=location.bucket,newErr=new FirebaseStorageError(Code.QUOTA_EXCEEDED,"Quota for bucket '"+bucket+"' exceeded, please view quota on https://firebase.google.com/pricing/.")):403===xhr.getStatus()?(path=location.path,newErr=new FirebaseStorageError(Code.UNAUTHORIZED,"User does not have permission to access '"+path+"'.")):newErr=err,newErr.setServerResponseProp(err.serverResponseProp()),newErr}}function objectErrorHandler(location){var shared=sharedErrorHandler(location);return function(xhr,err){var path,newErr=shared(xhr,err);return 404===xhr.getStatus()&&(path=location.path,newErr=new FirebaseStorageError(Code.OBJECT_NOT_FOUND,"Object '"+path+"' does not exist.")),newErr.setServerResponseProp(err.serverResponseProp()),newErr}}function getMetadata(authWrapper,location,mappings){var url=makeUrl(location.fullServerUrl()),timeout=authWrapper.maxOperationRetryTime(),requestInfo=new RequestInfo(url,"GET",metadataHandler(authWrapper,mappings),timeout);return requestInfo.errorHandler=objectErrorHandler(location),requestInfo}function metadataForUpload_(location,blob,opt_metadata){var metadata=clone(opt_metadata);return metadata.fullPath=location.path,metadata.size=blob.size(),metadata.contentType||(metadata.contentType=function(metadata,blob){return metadata&&metadata.contentType||blob&&blob.type()||"application/octet-stream"}(null,blob)),metadata}var ResumableUploadStatus=function(){return function(current,total,finalized,metadata){this.current=current,this.total=total,this.finalized=!!finalized,this.metadata=metadata||null}}();function checkResumeHeader_(xhr,opt_allowed){var status;try{status=xhr.getResponseHeader("X-Goog-Upload-Status")}catch(e){handlerCheck(!1)}return handlerCheck(contains$1(opt_allowed||["active"],status)),status}function continueResumableUpload(location,authWrapper,url,blob,chunkSize,mappings,opt_status,opt_progressCallback){var status=new ResumableUploadStatus(0,0);if(opt_status?(status.current=opt_status.current,status.total=opt_status.total):(status.current=0,status.total=blob.size()),blob.size()!==status.total)throw new FirebaseStorageError(Code.SERVER_FILE_WRONG_SIZE,"Server recorded incorrect upload file size, please retry the upload.");var bytesLeft=status.total-status.current,bytesToUpload=bytesLeft;chunkSize>0&&(bytesToUpload=Math.min(bytesToUpload,chunkSize));var startByte=status.current,endByte=startByte+bytesToUpload,headers={"X-Goog-Upload-Command":bytesToUpload===bytesLeft?"upload, finalize":"upload","X-Goog-Upload-Offset":status.current},body=blob.slice(startByte,endByte);if(null===body)throw cannotSliceBlob();var timeout=authWrapper.maxUploadRetryTime(),requestInfo=new RequestInfo(url,"POST",function(xhr,text){var metadata,uploadStatus=checkResumeHeader_(xhr,["active","final"]),newCurrent=status.current+bytesToUpload,size=blob.size();return metadata="final"===uploadStatus?metadataHandler(authWrapper,mappings)(xhr,text):null,new ResumableUploadStatus(newCurrent,size,"final"===uploadStatus,metadata)},timeout);return requestInfo.headers=headers,requestInfo.body=body.uploadData(),requestInfo.progressCallback=opt_progressCallback||null,requestInfo.errorHandler=sharedErrorHandler(location),requestInfo}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Observer=function(){return function(nextOrObserver,opt_error,opt_complete){if(isFunction(nextOrObserver)||isDef(opt_error)||isDef(opt_complete))this.next=nextOrObserver,this.error=opt_error||null,this.complete=opt_complete||null;else{var observer=nextOrObserver;this.next=observer.next||null,this.error=observer.error||null,this.complete=observer.complete||null}}}(),UploadTaskSnapshot=function(){return function(bytesTransferred,totalBytes,state,metadata,task,ref){this.bytesTransferred=bytesTransferred,this.totalBytes=totalBytes,this.state=state,this.metadata=metadata,this.task=task,this.ref=ref}}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function async(f){return function(){for(var argsToForward=[],_i=0;_i<arguments.length;_i++)argsToForward[_i]=arguments[_i];resolve(!0).then(function(){f.apply(null,argsToForward)})}}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var UploadTask=function(){function UploadTask(ref,authWrapper,location,mappings,blob,metadata){var _this=this;void 0===metadata&&(metadata=null),this.transferred_=0,this.needToFetchStatus_=!1,this.needToFetchMetadata_=!1,this.observers_=[],this.error_=null,this.uploadUrl_=null,this.request_=null,this.chunkMultiplier_=1,this.resolve_=null,this.reject_=null,this.ref_=ref,this.authWrapper_=authWrapper,this.location_=location,this.blob_=blob,this.metadata_=metadata,this.mappings_=mappings,this.resumable_=this.shouldDoResumable_(this.blob_),this.state_=InternalTaskState.RUNNING,this.errorHandler_=function(error){_this.request_=null,_this.chunkMultiplier_=1,error.codeEquals(Code.CANCELED)?(_this.needToFetchStatus_=!0,_this.completeTransitions_()):(_this.error_=error,_this.transition_(InternalTaskState.ERROR))},this.metadataErrorHandler_=function(error){_this.request_=null,error.codeEquals(Code.CANCELED)?_this.completeTransitions_():(_this.error_=error,_this.transition_(InternalTaskState.ERROR))},this.promise_=make(function(resolve,reject){_this.resolve_=resolve,_this.reject_=reject,_this.start_()}),this.promise_.then(null,function(){})}return UploadTask.prototype.makeProgressCallback_=function(){var _this=this,sizeBefore=this.transferred_;return function(loaded,total){_this.updateProgress_(sizeBefore+loaded)}},UploadTask.prototype.shouldDoResumable_=function(blob){return blob.size()>262144},UploadTask.prototype.start_=function(){this.state_===InternalTaskState.RUNNING&&null===this.request_&&(this.resumable_?null===this.uploadUrl_?this.createResumable_():this.needToFetchStatus_?this.fetchStatus_():this.needToFetchMetadata_?this.fetchMetadata_():this.continueUpload_():this.oneShotUpload_())},UploadTask.prototype.resolveToken_=function(callback){var _this=this;this.authWrapper_.getAuthToken().then(function(authToken){switch(_this.state_){case InternalTaskState.RUNNING:callback(authToken);break;case InternalTaskState.CANCELING:_this.transition_(InternalTaskState.CANCELED);break;case InternalTaskState.PAUSING:_this.transition_(InternalTaskState.PAUSED)}})},UploadTask.prototype.createResumable_=function(){var _this=this;this.resolveToken_(function(authToken){var requestInfo=function(authWrapper,location,mappings,blob,opt_metadata){var urlPart=location.bucketOnlyServerUrl(),metadata=metadataForUpload_(location,blob,opt_metadata),urlParams={name:metadata.fullPath},url=makeUrl(urlPart),headers={"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":blob.size(),"X-Goog-Upload-Header-Content-Type":metadata.contentType,"Content-Type":"application/json; charset=utf-8"},body=toResourceString(metadata,mappings),timeout=authWrapper.maxUploadRetryTime(),requestInfo=new RequestInfo(url,"POST",function(xhr,text){var url;checkResumeHeader_(xhr);try{url=xhr.getResponseHeader("X-Goog-Upload-URL")}catch(e){handlerCheck(!1)}return handlerCheck(isString(url)),url},timeout);return requestInfo.urlParams=urlParams,requestInfo.headers=headers,requestInfo.body=body,requestInfo.errorHandler=sharedErrorHandler(location),requestInfo}(_this.authWrapper_,_this.location_,_this.mappings_,_this.blob_,_this.metadata_),createRequest=_this.authWrapper_.makeRequest(requestInfo,authToken);_this.request_=createRequest,createRequest.getPromise().then(function(url){_this.request_=null,_this.uploadUrl_=url,_this.needToFetchStatus_=!1,_this.completeTransitions_()},_this.errorHandler_)})},UploadTask.prototype.fetchStatus_=function(){var _this=this,url=this.uploadUrl_;this.resolveToken_(function(authToken){var requestInfo=function(authWrapper,location,url,blob){var timeout=authWrapper.maxUploadRetryTime(),requestInfo=new RequestInfo(url,"POST",function(xhr,text){var sizeString,status=checkResumeHeader_(xhr,["active","final"]);try{sizeString=xhr.getResponseHeader("X-Goog-Upload-Size-Received")}catch(e){handlerCheck(!1)}var size=parseInt(sizeString,10);return handlerCheck(!isNaN(size)),new ResumableUploadStatus(size,blob.size(),"final"===status)},timeout);return requestInfo.headers={"X-Goog-Upload-Command":"query"},requestInfo.errorHandler=sharedErrorHandler(location),requestInfo}(_this.authWrapper_,_this.location_,url,_this.blob_),statusRequest=_this.authWrapper_.makeRequest(requestInfo,authToken);_this.request_=statusRequest,statusRequest.getPromise().then(function(status){status=status,_this.request_=null,_this.updateProgress_(status.current),_this.needToFetchStatus_=!1,status.finalized&&(_this.needToFetchMetadata_=!0),_this.completeTransitions_()},_this.errorHandler_)})},UploadTask.prototype.continueUpload_=function(){var _this=this,chunkSize=262144*this.chunkMultiplier_,status=new ResumableUploadStatus(this.transferred_,this.blob_.size()),url=this.uploadUrl_;this.resolveToken_(function(authToken){var requestInfo;try{requestInfo=continueResumableUpload(_this.location_,_this.authWrapper_,url,_this.blob_,chunkSize,_this.mappings_,status,_this.makeProgressCallback_())}catch(e){return _this.error_=e,void _this.transition_(InternalTaskState.ERROR)}var uploadRequest=_this.authWrapper_.makeRequest(requestInfo,authToken);_this.request_=uploadRequest,uploadRequest.getPromise().then(function(newStatus){_this.increaseMultiplier_(),_this.request_=null,_this.updateProgress_(newStatus.current),newStatus.finalized?(_this.metadata_=newStatus.metadata,_this.transition_(InternalTaskState.SUCCESS)):_this.completeTransitions_()},_this.errorHandler_)})},UploadTask.prototype.increaseMultiplier_=function(){262144*this.chunkMultiplier_<33554432&&(this.chunkMultiplier_*=2)},UploadTask.prototype.fetchMetadata_=function(){var _this=this;this.resolveToken_(function(authToken){var requestInfo=getMetadata(_this.authWrapper_,_this.location_,_this.mappings_),metadataRequest=_this.authWrapper_.makeRequest(requestInfo,authToken);_this.request_=metadataRequest,metadataRequest.getPromise().then(function(metadata){_this.request_=null,_this.metadata_=metadata,_this.transition_(InternalTaskState.SUCCESS)},_this.metadataErrorHandler_)})},UploadTask.prototype.oneShotUpload_=function(){var _this=this;this.resolveToken_(function(authToken){var requestInfo=function(authWrapper,location,mappings,blob,opt_metadata){var urlPart=location.bucketOnlyServerUrl(),headers={"X-Goog-Upload-Protocol":"multipart"},boundary=function(){for(var str="",i=0;i<2;i++)str+=Math.random().toString().slice(2);return str}();headers["Content-Type"]="multipart/related; boundary="+boundary;var metadata=metadataForUpload_(location,blob,opt_metadata),preBlobPart="--"+boundary+"\r\nContent-Type: application/json; charset=utf-8\r\n\r\n"+toResourceString(metadata,mappings)+"\r\n--"+boundary+"\r\nContent-Type: "+metadata.contentType+"\r\n\r\n",postBlobPart="\r\n--"+boundary+"--",body=FbsBlob.getBlob(preBlobPart,blob,postBlobPart);if(null===body)throw cannotSliceBlob();var urlParams={name:metadata.fullPath},url=makeUrl(urlPart),timeout=authWrapper.maxUploadRetryTime(),requestInfo=new RequestInfo(url,"POST",metadataHandler(authWrapper,mappings),timeout);return requestInfo.urlParams=urlParams,requestInfo.headers=headers,requestInfo.body=body.uploadData(),requestInfo.errorHandler=sharedErrorHandler(location),requestInfo}(_this.authWrapper_,_this.location_,_this.mappings_,_this.blob_,_this.metadata_),multipartRequest=_this.authWrapper_.makeRequest(requestInfo,authToken);_this.request_=multipartRequest,multipartRequest.getPromise().then(function(metadata){_this.request_=null,_this.metadata_=metadata,_this.updateProgress_(_this.blob_.size()),_this.transition_(InternalTaskState.SUCCESS)},_this.errorHandler_)})},UploadTask.prototype.updateProgress_=function(transferred){var old=this.transferred_;this.transferred_=transferred,this.transferred_!==old&&this.notifyObservers_()},UploadTask.prototype.transition_=function(state){if(this.state_!==state)switch(state){case InternalTaskState.CANCELING:case InternalTaskState.PAUSING:this.state_=state,null!==this.request_&&this.request_.cancel();break;case InternalTaskState.RUNNING:var wasPaused=this.state_===InternalTaskState.PAUSED;this.state_=state,wasPaused&&(this.notifyObservers_(),this.start_());break;case InternalTaskState.PAUSED:this.state_=state,this.notifyObservers_();break;case InternalTaskState.CANCELED:this.error_=canceled(),this.state_=state,this.notifyObservers_();break;case InternalTaskState.ERROR:case InternalTaskState.SUCCESS:this.state_=state,this.notifyObservers_()}},UploadTask.prototype.completeTransitions_=function(){switch(this.state_){case InternalTaskState.PAUSING:this.transition_(InternalTaskState.PAUSED);break;case InternalTaskState.CANCELING:this.transition_(InternalTaskState.CANCELED);break;case InternalTaskState.RUNNING:this.start_()}},Object.defineProperty(UploadTask.prototype,"snapshot",{get:function(){var externalState=taskStateFromInternalTaskState(this.state_);return new UploadTaskSnapshot(this.transferred_,this.blob_.size(),externalState,this.metadata_,this,this.ref_)},enumerable:!0,configurable:!0}),UploadTask.prototype.on=function(type,nextOrObserver,error,completed){void 0===nextOrObserver&&(nextOrObserver=void 0),void 0===error&&(error=void 0),void 0===completed&&(completed=void 0);var nextOrObserverMessage="Expected a function or an Object with one of `next`, `error`, `complete` properties.",nextValidator=nullFunctionSpec(!0).validator,observerValidator=looseObjectSpec(null,!0).validator;function nextOrObserverValidator(p){try{return void nextValidator(p)}catch(e){}try{if(observerValidator(p),!(isJustDef(p.next)||isJustDef(p.error)||isJustDef(p.complete)))throw"";return}catch(e){throw nextOrObserverMessage}}validate("on",[stringSpec(function(_p){if(type!==TaskEvent.STATE_CHANGED)throw"Expected one of the event types: ["+TaskEvent.STATE_CHANGED+"]."}),looseObjectSpec(nextOrObserverValidator,!0),nullFunctionSpec(!0),nullFunctionSpec(!0)],arguments);var self=this;function makeBinder(specs){return function(nextOrObserver,error,opt_complete){null!==specs&&validate("on",specs,arguments);var observer=new Observer(nextOrObserver,error,completed);return self.addObserver_(observer),function(){self.removeObserver_(observer)}}}var binderSpecs=[looseObjectSpec(function(p){if(null===p)throw nextOrObserverMessage;nextOrObserverValidator(p)}),nullFunctionSpec(!0),nullFunctionSpec(!0)];return!(isJustDef(nextOrObserver)||isJustDef(error)||isJustDef(completed))?makeBinder(binderSpecs):makeBinder(null)(nextOrObserver,error,completed)},UploadTask.prototype.then=function(onFulfilled,onRejected){return this.promise_.then(onFulfilled,onRejected)},UploadTask.prototype.catch=function(onRejected){return this.then(null,onRejected)},UploadTask.prototype.addObserver_=function(observer){this.observers_.push(observer),this.notifyObserver_(observer)},UploadTask.prototype.removeObserver_=function(observer){var array,elem,i;array=this.observers_,elem=observer,-1!==(i=array.indexOf(elem))&&array.splice(i,1)},UploadTask.prototype.notifyObservers_=function(){var arraylike,_this=this;this.finishPromise_(),(arraylike=this.observers_,Array.prototype.slice.call(arraylike)).forEach(function(observer){_this.notifyObserver_(observer)})},UploadTask.prototype.finishPromise_=function(){if(null!==this.resolve_){var triggered=!0;switch(taskStateFromInternalTaskState(this.state_)){case TaskState.SUCCESS:async(this.resolve_.bind(null,this.snapshot))();break;case TaskState.CANCELED:case TaskState.ERROR:async(this.reject_.bind(null,this.error_))();break;default:triggered=!1}triggered&&(this.resolve_=null,this.reject_=null)}},UploadTask.prototype.notifyObserver_=function(observer){switch(taskStateFromInternalTaskState(this.state_)){case TaskState.RUNNING:case TaskState.PAUSED:null!==observer.next&&async(observer.next.bind(observer,this.snapshot))();break;case TaskState.SUCCESS:null!==observer.complete&&async(observer.complete.bind(observer))();break;case TaskState.CANCELED:case TaskState.ERROR:null!==observer.error&&async(observer.error.bind(observer,this.error_))();break;default:null!==observer.error&&async(observer.error.bind(observer,this.error_))()}},UploadTask.prototype.resume=function(){validate("resume",[],arguments);var valid=this.state_===InternalTaskState.PAUSED||this.state_===InternalTaskState.PAUSING;return valid&&this.transition_(InternalTaskState.RUNNING),valid},UploadTask.prototype.pause=function(){validate("pause",[],arguments);var valid=this.state_===InternalTaskState.RUNNING;return valid&&this.transition_(InternalTaskState.PAUSING),valid},UploadTask.prototype.cancel=function(){validate("cancel",[],arguments);var valid=this.state_===InternalTaskState.RUNNING||this.state_===InternalTaskState.PAUSING;return valid&&this.transition_(InternalTaskState.CANCELING),valid},UploadTask}(),Reference=function(){function Reference(authWrapper,location){this.authWrapper=authWrapper,this.location=location instanceof Location?location:Location.makeFromUrl(location)}return Reference.prototype.toString=function(){return validate("toString",[],arguments),"gs://"+this.location.bucket+"/"+this.location.path},Reference.prototype.newRef=function(authWrapper,location){return new Reference(authWrapper,location)},Reference.prototype.mappings=function(){return getMappings()},Reference.prototype.child=function(childPath){validate("child",[stringSpec()],arguments);var newPath=function(path,childPath){var canonicalChildPath=childPath.split("/").filter(function(component){return component.length>0}).join("/");return 0===path.length?canonicalChildPath:path+"/"+canonicalChildPath}(this.location.path,childPath),location=new Location(this.location.bucket,newPath);return this.newRef(this.authWrapper,location)},Object.defineProperty(Reference.prototype,"parent",{get:function(){var newPath=function(path){if(0==path.length)return null;var index=path.lastIndexOf("/");return-1===index?"":path.slice(0,index)}(this.location.path);if(null===newPath)return null;var location=new Location(this.location.bucket,newPath);return this.newRef(this.authWrapper,location)},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"root",{get:function(){var location=new Location(this.location.bucket,"");return this.newRef(this.authWrapper,location)},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"bucket",{get:function(){return this.location.bucket},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"fullPath",{get:function(){return this.location.path},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"name",{get:function(){return lastComponent(this.location.path)},enumerable:!0,configurable:!0}),Object.defineProperty(Reference.prototype,"storage",{get:function(){return this.authWrapper.service()},enumerable:!0,configurable:!0}),Reference.prototype.put=function(data,metadata){return void 0===metadata&&(metadata=null),validate("put",[uploadDataSpec(),metadataSpec(!0)],arguments),this.throwIfRoot_("put"),new UploadTask(this,this.authWrapper,this.location,this.mappings(),new FbsBlob(data),metadata)},Reference.prototype.putString=function(string,format,opt_metadata){void 0===format&&(format=StringFormat.RAW),validate("putString",[stringSpec(),stringSpec(formatValidator,!0),metadataSpec(!0)],arguments),this.throwIfRoot_("putString");var data=dataFromString(format,string),metadata=clone(opt_metadata);return!isDef(metadata.contentType)&&isDef(data.contentType)&&(metadata.contentType=data.contentType),new UploadTask(this,this.authWrapper,this.location,this.mappings(),new FbsBlob(data.data,!0),metadata)},Reference.prototype.delete=function(){validate("delete",[],arguments),this.throwIfRoot_("delete");var self=this;return this.authWrapper.getAuthToken().then(function(authToken){var requestInfo=function(authWrapper,location){var url=makeUrl(location.fullServerUrl()),timeout=authWrapper.maxOperationRetryTime(),requestInfo=new RequestInfo(url,"DELETE",function(xhr,text){},timeout);return requestInfo.successCodes=[200,204],requestInfo.errorHandler=objectErrorHandler(location),requestInfo}(self.authWrapper,self.location);return self.authWrapper.makeRequest(requestInfo,authToken).getPromise()})},Reference.prototype.getMetadata=function(){validate("getMetadata",[],arguments),this.throwIfRoot_("getMetadata");var self=this;return this.authWrapper.getAuthToken().then(function(authToken){var requestInfo=getMetadata(self.authWrapper,self.location,self.mappings());return self.authWrapper.makeRequest(requestInfo,authToken).getPromise()})},Reference.prototype.updateMetadata=function(metadata){validate("updateMetadata",[metadataSpec()],arguments),this.throwIfRoot_("updateMetadata");var self=this;return this.authWrapper.getAuthToken().then(function(authToken){var requestInfo=function(authWrapper,location,metadata,mappings){var url=makeUrl(location.fullServerUrl()),body=toResourceString(metadata,mappings),timeout=authWrapper.maxOperationRetryTime(),requestInfo=new RequestInfo(url,"PATCH",metadataHandler(authWrapper,mappings),timeout);return requestInfo.headers={"Content-Type":"application/json; charset=utf-8"},requestInfo.body=body,requestInfo.errorHandler=objectErrorHandler(location),requestInfo}(self.authWrapper,self.location,metadata,self.mappings());return self.authWrapper.makeRequest(requestInfo,authToken).getPromise()})},Reference.prototype.getDownloadURL=function(){validate("getDownloadURL",[],arguments),this.throwIfRoot_("getDownloadURL");var self=this;return this.authWrapper.getAuthToken().then(function(authToken){var requestInfo=function(authWrapper,location,mappings){var url=makeUrl(location.fullServerUrl()),timeout=authWrapper.maxOperationRetryTime(),requestInfo=new RequestInfo(url,"GET",downloadUrlHandler(authWrapper,mappings),timeout);return requestInfo.errorHandler=objectErrorHandler(location),requestInfo}(self.authWrapper,self.location,self.mappings());return self.authWrapper.makeRequest(requestInfo,authToken).getPromise().then(function(url){if(null===url)throw new FirebaseStorageError(Code.NO_DOWNLOAD_URL,"The given file does not have any download URLs.");return url})})},Reference.prototype.throwIfRoot_=function(name){if(""===this.location.path)throw function(name){return new FirebaseStorageError(Code.INVALID_ROOT_OPERATION,"The operation '"+name+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}(name)},Reference}(),FailRequest=function(){function FailRequest(error){this.promise_=function(error){return Promise.reject(error)}(error)}return FailRequest.prototype.getPromise=function(){return this.promise_},FailRequest.prototype.cancel=function(appDelete){void 0===appDelete&&(appDelete=!1)},FailRequest}(),RequestMap=function(){function RequestMap(){this.map_={},this.id_=MIN_SAFE_INTEGER}return RequestMap.prototype.addRequest=function(r){var id=this.id_;this.id_++,this.map_[id]=r;var self=this;function unmap(){delete self.map_[id]}r.getPromise().then(unmap,unmap)},RequestMap.prototype.clear=function(){forEach(this.map_,function(key,val){val&&val.cancel(!0)}),this.map_={}},RequestMap}(),AuthWrapper=function(){function AuthWrapper(app,maker,requestMaker,service,pool){if(this.bucket_=null,this.deleted_=!1,this.app_=app,null!==this.app_){var options=this.app_.options;isDef(options)&&(this.bucket_=AuthWrapper.extractBucket_(options))}this.storageRefMaker_=maker,this.requestMaker_=requestMaker,this.pool_=pool,this.service_=service,this.maxOperationRetryTime_=DEFAULT_MAX_OPERATION_RETRY_TIME,this.maxUploadRetryTime_=DEFAULT_MAX_UPLOAD_RETRY_TIME,this.requestMap_=new RequestMap}return AuthWrapper.extractBucket_=function(config){var bucketString=config.storageBucket||null;return null==bucketString?null:Location.makeFromBucketSpec(bucketString).bucket},AuthWrapper.prototype.getAuthToken=function(){return null!==this.app_&&isDef(this.app_.INTERNAL)&&isDef(this.app_.INTERNAL.getToken)?this.app_.INTERNAL.getToken().then(function(response){return null!==response?response.accessToken:null},function(_error){return null}):resolve(null)},AuthWrapper.prototype.bucket=function(){if(this.deleted_)throw appDeleted();return this.bucket_},AuthWrapper.prototype.service=function(){return this.service_},AuthWrapper.prototype.makeStorageReference=function(loc){return this.storageRefMaker_(this,loc)},AuthWrapper.prototype.makeRequest=function(requestInfo,authToken){if(this.deleted_)return new FailRequest(appDeleted());var request=this.requestMaker_(requestInfo,authToken,this.pool_);return this.requestMap_.addRequest(request),request},AuthWrapper.prototype.deleteApp=function(){this.deleted_=!0,this.app_=null,this.requestMap_.clear()},AuthWrapper.prototype.maxUploadRetryTime=function(){return this.maxUploadRetryTime_},AuthWrapper.prototype.setMaxUploadRetryTime=function(time){this.maxUploadRetryTime_=time},AuthWrapper.prototype.maxOperationRetryTime=function(){return this.maxOperationRetryTime_},AuthWrapper.prototype.setMaxOperationRetryTime=function(time){this.maxOperationRetryTime_=time},AuthWrapper}();
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var NetworkRequest=function(){function NetworkRequest(url,method,headers,body,successCodes,additionalRetryCodes,callback,errorCallback,timeout,progressCallback,pool){this.pendingXhr_=null,this.backoffId_=null,this.resolve_=null,this.reject_=null,this.canceled_=!1,this.appDelete_=!1,this.url_=url,this.method_=method,this.headers_=headers,this.body_=body,this.successCodes_=successCodes.slice(),this.additionalRetryCodes_=additionalRetryCodes.slice(),this.callback_=callback,this.errorCallback_=errorCallback,this.progressCallback_=progressCallback,this.timeout_=timeout,this.pool_=pool;var self=this;this.promise_=make(function(resolve,reject){self.resolve_=resolve,self.reject_=reject,self.start_()})}return NetworkRequest.prototype.start_=function(){var self=this;function backoffDone(requestWentThrough,status){var err,resolve=self.resolve_,reject=self.reject_,xhr=status.xhr;if(status.wasSuccessCode)try{var result=self.callback_(xhr,xhr.getResponseText());isJustDef(result)?resolve(result):resolve()}catch(e){reject(e)}else null!==xhr?((err=unknown()).setServerResponseProp(xhr.getResponseText()),self.errorCallback_?reject(self.errorCallback_(xhr,err)):reject(err)):status.canceled?reject(err=self.appDelete_?appDeleted():canceled()):reject(err=new FirebaseStorageError(Code.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again."))}this.canceled_?backoffDone(0,new RequestEndStatus(!1,null,!0)):this.backoffId_=
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function(f,callback,timeout){var waitSeconds=1,timeoutId=null,hitTimeout=!1,cancelState=0;function canceled(){return 2===cancelState}var triggeredCallback=!1;function triggerCallback(){triggeredCallback||(triggeredCallback=!0,callback.apply(null,arguments))}function callWithDelay(millis){timeoutId=setTimeout(function(){timeoutId=null,f(handler,canceled())},millis)}function handler(success){for(var waitMillis,var_args=[],_i=1;_i<arguments.length;_i++)var_args[_i-1]=arguments[_i];triggeredCallback||(success?triggerCallback.apply(null,arguments):canceled()||hitTimeout?triggerCallback.apply(null,arguments):(waitSeconds<64&&(waitSeconds*=2),1===cancelState?(cancelState=2,waitMillis=0):waitMillis=1e3*(waitSeconds+Math.random()),callWithDelay(waitMillis)))}var stopped=!1;function stop(wasTimeout){stopped||(stopped=!0,triggeredCallback||(null!==timeoutId?(wasTimeout||(cancelState=2),clearTimeout(timeoutId),callWithDelay(0)):wasTimeout||(cancelState=1)))}return callWithDelay(0),setTimeout(function(){hitTimeout=!0,stop(!0)},timeout),stop}(function(backoffCallback,canceled){if(canceled)backoffCallback(!1,new RequestEndStatus(!1,null,!0));else{var xhr=self.pool_.createXhrIo();self.pendingXhr_=xhr,null!==self.progressCallback_&&xhr.addUploadProgressListener(progressListener),xhr.send(self.url_,self.method_,self.body_,self.headers_).then(function(xhr){null!==self.progressCallback_&&xhr.removeUploadProgressListener(progressListener),self.pendingXhr_=null;var hitServer=(xhr=xhr).getErrorCode()===ErrorCode.NO_ERROR,status=xhr.getStatus();if(hitServer&&!self.isRetryStatusCode_(status)){var successCode=contains$1(self.successCodes_,status);backoffCallback(!0,new RequestEndStatus(successCode,xhr))}else{var wasCanceled=xhr.getErrorCode()===ErrorCode.ABORT;backoffCallback(!1,new RequestEndStatus(!1,null,wasCanceled))}})}function progressListener(progressEvent){var loaded=progressEvent.loaded,total=progressEvent.lengthComputable?progressEvent.total:-1;null!==self.progressCallback_&&self.progressCallback_(loaded,total)}},backoffDone,this.timeout_)},NetworkRequest.prototype.getPromise=function(){return this.promise_},NetworkRequest.prototype.cancel=function(appDelete){this.canceled_=!0,this.appDelete_=appDelete||!1,null!==this.backoffId_&&(0,this.backoffId_)(!1),null!==this.pendingXhr_&&this.pendingXhr_.abort()},NetworkRequest.prototype.isRetryStatusCode_=function(status){var isFiveHundredCode=status>=500&&status<600,isExtraRetryCode=contains$1([408,429],status),isRequestSpecificRetryCode=contains$1(this.additionalRetryCodes_,status);return isFiveHundredCode||isExtraRetryCode||isRequestSpecificRetryCode},NetworkRequest}(),RequestEndStatus=function(){return function(wasSuccessCode,xhr,opt_canceled){this.wasSuccessCode=wasSuccessCode,this.xhr=xhr,this.canceled=!!opt_canceled}}();function makeRequest(requestInfo,authToken,pool){var queryPart=makeQueryString(requestInfo.urlParams),url=requestInfo.url+queryPart,headers=clone(requestInfo.headers);return function(headers,authToken){null!==authToken&&authToken.length>0&&(headers.Authorization="Firebase "+authToken)}(headers,authToken),function(headers){var number=void 0!==_firebase_app__WEBPACK_IMPORTED_MODULE_0___default.a?_firebase_app__WEBPACK_IMPORTED_MODULE_0___default.a.SDK_VERSION:"AppManager";headers["X-Firebase-Storage-Version"]="webjs/"+number}(headers),new NetworkRequest(url,requestInfo.method,headers,requestInfo.body,requestInfo.successCodes,requestInfo.additionalRetryCodes,requestInfo.handler,requestInfo.errorHandler,requestInfo.timeout,requestInfo.progressCallback,pool)}
/**
 * @license
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Service=function(){function Service(app,pool,url){if(this.bucket_=null,this.authWrapper_=new AuthWrapper(app,function(authWrapper,loc){return new Reference(authWrapper,loc)},makeRequest,this,pool),this.app_=app,null!=url)this.bucket_=Location.makeFromBucketSpec(url);else{var authWrapperBucket=this.authWrapper_.bucket();null!=authWrapperBucket&&(this.bucket_=new Location(authWrapperBucket,""))}this.internals_=new ServiceInternals(this)}return Service.prototype.ref=function(path){if(validate("ref",[stringSpec(function(path){if(/^[A-Za-z]+:\/\//.test(path))throw"Expected child path but got a URL, use refFromURL instead."},!0)],arguments),null==this.bucket_)throw new Error("No Storage Bucket defined in Firebase Options.");var ref=new Reference(this.authWrapper_,this.bucket_);return null!=path?ref.child(path):ref},Service.prototype.refFromURL=function(url){return validate("refFromURL",[stringSpec(function(p){if(!/^[A-Za-z]+:\/\//.test(p))throw"Expected full URL but got a child path, use ref instead.";try{Location.makeFromUrl(p)}catch(e){throw"Expected valid full URL but got an invalid one."}},!1)],arguments),new Reference(this.authWrapper_,url)},Object.defineProperty(Service.prototype,"maxUploadRetryTime",{get:function(){return this.authWrapper_.maxUploadRetryTime()},enumerable:!0,configurable:!0}),Service.prototype.setMaxUploadRetryTime=function(time){validate("setMaxUploadRetryTime",[nonNegativeNumberSpec()],arguments),this.authWrapper_.setMaxUploadRetryTime(time)},Service.prototype.setMaxOperationRetryTime=function(time){validate("setMaxOperationRetryTime",[nonNegativeNumberSpec()],arguments),this.authWrapper_.setMaxOperationRetryTime(time)},Object.defineProperty(Service.prototype,"app",{get:function(){return this.app_},enumerable:!0,configurable:!0}),Object.defineProperty(Service.prototype,"INTERNAL",{get:function(){return this.internals_},enumerable:!0,configurable:!0}),Service}(),ServiceInternals=function(){function ServiceInternals(service){this.service_=service}return ServiceInternals.prototype.delete=function(){return this.service_.authWrapper_.deleteApp(),resolve(void 0)},ServiceInternals}(),STORAGE_TYPE="storage";function factory(app,unused,opt_url){return new Service(app,new XhrIoPool,opt_url)}function registerStorage(instance){var namespaceExports={TaskState:TaskState,TaskEvent:TaskEvent,StringFormat:StringFormat,Storage:Service,Reference:Reference};instance.INTERNAL.registerService(STORAGE_TYPE,factory,namespaceExports,void 0,!0)}registerStorage(_firebase_app__WEBPACK_IMPORTED_MODULE_0___default.a)}})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(15),_firebase_storage_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(112);_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__.StorageProviderFactory.register("firebase",{storage:_firebase_storage_js__WEBPACK_IMPORTED_MODULE_1__.FirebaseStorage,isPersistent:!0})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"resetStorageForTesting",function(){return resetStorageForTesting}),__webpack_require__.d(__webpack_exports__,"FirebaseStorage",function(){return FirebaseStorage});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_atob_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(113),_platform_btoa_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(114),_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(115),_type_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(18),_util_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(100),_crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(34),_key_base_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(35),_storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(36);
// @license
async function resetStorageForTesting(key){key=new FirebaseKey(key);const app=_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__.firebase.initializeApp({apiKey:key.apiKey,projectId:key.projectId,databaseURL:key.databaseUrl}),reference=_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__.firebase.database(app).ref(key.location);await new Promise(resolve=>{reference.remove(resolve)}),app.delete()}class FirebaseKey extends _key_base_js__WEBPACK_IMPORTED_MODULE_7__.KeyBase{constructor(key){super();let parts=key.split("://");if(this.protocol=parts[0],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("firebase"===this.protocol,`can't construct firebase key for protocol ${this.protocol} (input key ${key})`),parts[1]){if(parts=parts[1].split("/"),this.databaseUrl=parts[0],!this.databaseUrl||!this.databaseUrl.endsWith(".firebaseio.com"))throw new Error("FirebaseKey must end with .firebaseio.com");this.projectId=this.databaseUrl.split(".")[0],this.apiKey=parts[1],this.location=parts.slice(2).join("/")}else this.databaseUrl=void 0,this.projectId=void 0,this.apiKey=void 0,this.location=""}base(){const str=this.toString();return str.substring(0,str.length-this.arcId.length)}get arcId(){return this.location.substring(this.location.lastIndexOf("/")+1)}childKeyForHandle(id){return this.buildChildKey(`handles/${id}`)}childKeyForArcInfo(){return this.buildChildKey("arc-info")}childKeyForSuggestions(userId,arcId){return this.buildChildKey(`${userId}/suggestions/${arcId}`)}childKeyForSearch(userId){return this.buildChildKey(`${userId}/search`)}buildChildKey(leaf){let location="";return null!=this.location&&this.location.length>0&&(location=this.location+"/"),location+=leaf,new FirebaseKey(`${this.protocol}://${this.databaseUrl}/${this.apiKey}/${location}`)}toString(){return this.databaseUrl&&this.apiKey?`${this.protocol}://${this.databaseUrl}/${this.apiKey}/${this.location}`:`${this.protocol}://`}}let _nextAppNameSuffix=0;var Mode,CursorState;!function(Mode){Mode[Mode.direct=0]="direct",Mode[Mode.reference=1]="reference",Mode[Mode.backing=2]="backing"}(Mode||(Mode={}));class FirebaseStorage extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.StorageBase{constructor(arcId){super(arcId),this.apps={},this.baseStores=new Map,this.baseStorePromises=new Map}async construct(id,type,keyFragment){let mode=type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.ReferenceType?Mode.direct:Mode.reference;return type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.BigCollectionType?mode=Mode.direct:type.isTypeContainer()&&type.getContainedType()instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.ReferenceType&&(mode=Mode.direct),this._join(id,type,keyFragment,!1,mode)}async connect(id,type,key){return this._join(id,type,key,!0,Mode.direct)}async shutdown(){for(const entry of Object.values(this.apps))entry.owned&&(entry.app.delete(),entry.owned=!1)}baseStorageKey(type,keyString){const fbKey=new FirebaseKey(keyString);return fbKey.location=`${fbKey.location.split("/")[0]}/backingStores/${type.toString()}`,fbKey.toString()}async baseStorageFor(type,key){const typeStr=type.toString(),cacheStr=`${new FirebaseKey(key).databaseUrl}!${typeStr}`;let storage;if(storage=this.baseStores.get(cacheStr))return storage;if(storage=this.baseStorePromises.get(cacheStr))return storage;const storagePromise=this._join(typeStr,type.collectionOf(),key,"unknown",Mode.backing);return this.baseStorePromises.set(cacheStr,storagePromise),storage=await storagePromise,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(storage,"baseStorageFor should not fail"),this.baseStores.set(cacheStr,storage),this.baseStorePromises.delete(cacheStr),storage}parseStringAsKey(s){return new FirebaseKey(s)}async _join(id,type,keyString,shouldExist,mode){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!(type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariable)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!(type.isTypeContainer()&&type.getContainedType()instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.TypeVariable));const fbKey=new FirebaseKey(keyString);if(null==fbKey.databaseUrl||null==fbKey.apiKey)throw new Error("Can't complete partial firebase keys");if(null==this.apps[fbKey.projectId])for(const app of _platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__.firebase.apps)if(app.options.databaseURL===fbKey.databaseUrl){this.apps[fbKey.projectId]={app:app,owned:!1};break}if(null==this.apps[fbKey.projectId]){const app=_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__.firebase.initializeApp({apiKey:fbKey.apiKey,projectId:fbKey.projectId,databaseURL:fbKey.databaseUrl},`app${_nextAppNameSuffix++}`);this.apps[fbKey.projectId]={app:app,owned:!0}}const reference=_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_3__.firebase.database(this.apps[fbKey.projectId].app).ref(fbKey.location),currentSnapshot=await reference.once("value");if("unknown"!==shouldExist&&shouldExist!==currentSnapshot.exists())return null;let enableReferenceMode=currentSnapshot.exists()&&currentSnapshot.val().referenceMode;if(!1===shouldExist||"unknown"===shouldExist&&!1===currentSnapshot.exists()){if(!(await reference.transaction(data=>{if(null==data)return{version:0,referenceMode:mode===Mode.reference}},void 0,!1)).committed)return null;enableReferenceMode=mode===Mode.reference}const provider=FirebaseStorageProvider.newProvider(type,this,id,reference,fbKey,shouldExist,mode);return enableReferenceMode&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(mode!==Mode.backing,"backing stores should not have referenceMode enabled"),provider.enableReferenceMode()),provider}static encodeKey(key){return(key=Object(_platform_btoa_web_js__WEBPACK_IMPORTED_MODULE_2__.btoa)(key)).replace(/\//g,"*")}static decodeKey(key){return key=key.replace(/\*/g,"/"),Object(_platform_atob_web_js__WEBPACK_IMPORTED_MODULE_1__.atob)(key)}}class FirebaseStorageProvider extends _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.StorageProviderBase{constructor(type,storageEngine,id,reference,key){super(type,void 0,id,key.toString()),this.storageEngine=storageEngine,this.firebaseKey=key,this.reference=reference,this.backingStore=null,this.pendingBackingStore=null,this.persisting=null}async ensureBackingStore(){if(this.backingStore)return this.backingStore;if(!this.pendingBackingStore){const key=this.storageEngine.baseStorageKey(this.backingType(),this.storageKey);this.pendingBackingStore=this.storageEngine.baseStorageFor(this.type,key),this.pendingBackingStore.then(backingStore=>this.backingStore=backingStore)}return this.pendingBackingStore}static newProvider(type,storageEngine,id,reference,key,shouldExist,mode){return mode===Mode.backing?new FirebaseBackingStore(type,storageEngine,id,reference,key):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.CollectionType?new FirebaseCollection(type,storageEngine,id,reference,key):type instanceof _type_js__WEBPACK_IMPORTED_MODULE_4__.BigCollectionType?new FirebaseBigCollection(type,storageEngine,id,reference,key):new FirebaseVariable(type,storageEngine,id,reference,key,shouldExist)}async _transaction(transactionFunction){const result=await this.reference.transaction(data=>{if(null==data)return 0;const newData=transactionFunction(data);return JSON.parse(JSON.stringify(newData))},void 0,!1);return result.committed&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(0!==result.snapshot.val()),result}async _persistChanges(){for(;this._hasLocalChanges;)this.persisting?await this.persisting:(this.persisting=this._persistChangesImpl(),await this.persisting,this.persisting=null)}}class FirebaseVariable extends FirebaseStorageProvider{constructor(type,storageEngine,id,reference,firebaseKey,shouldExist){super(type,storageEngine,id,reference,firebaseKey),this.localKeyId=Date.now(),this.pendingWrites=[],this.wasConnect=shouldExist,this.value=null,this.version=null,this.localModified=!1,this.initialized=new Promise(resolve=>this.resolveInitialized=resolve),this.valueChangeCallback=this.reference.on("value",dataSnapshot=>this.remoteStateChanged(dataSnapshot))}dispose(){this.reference.off("value",this.valueChangeCallback)}backingType(){return this.type}remoteStateChanged(dataSnapshot){if(this.localModified)return;const data=dataSnapshot.val();if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null==this.version||data.version>this.version),this.value=data.value||null,this.version=data.version,this.resolveInitialized(),this.referenceMode&&this.value){const version=this.version;this.ensureBackingStore().then(async store=>{const data=await store.get(this.value.id);this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({data:data,version:version}))})}else this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({data:data.value||null,version:this.version}))}get _hasLocalChanges(){return this.localModified}async _persistChangesImpl(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.localModified);const version=this.version,value=this.value;if(this.referenceMode&&this.pendingWrites.length>0){await this.ensureBackingStore();const pendingWrites=this.pendingWrites.slice();this.pendingWrites=[],await Promise.all(pendingWrites.map(pendingItem=>this.backingStore.store(pendingItem.value,[this.storageKey+this.localKeyId++])))}const result=await this._transaction(data=>(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.version>=version),{version:Math.max(data.version+1,version),value:value,referenceMode:this.referenceMode}));Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(result.committed,"uncommited transaction (offline?) not supported yet");const data=result.snapshot.val();if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(0!==data),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(data.version>=version),this.version!==version)return this._persistChangesImpl();this.localModified=!1,this.version=data.version,this.value=data.value||null}get versionForTesting(){return this.version}async get(){if(await this.initialized,this.referenceMode&&this.value){this.type;return await this.ensureBackingStore(),await this.backingStore.get(this.value.id)}return this.value}async set(value,originatorId=null,barrier=null){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value),null==this.version)Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.localModified),this.version=0,this.resolveInitialized();else if(!this.referenceMode&&JSON.stringify(this.value)===JSON.stringify(value))return;const version=this.version+1;let storageKey;this.referenceMode&&value?(storageKey=this.storageEngine.baseStorageKey(this.type,this.storageKey),this.pendingWrites.push({value:value,storageKey:storageKey})):this.value=value,this.localModified=!0,await this._persistChanges(),this.version=version,this.referenceMode&&value&&(this.value={id:value.id,storageKey:storageKey}),this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({data:value,version:version,originatorId:originatorId,barrier:barrier}))}async clear(originatorId=null,barrier=null){return this.set(null,originatorId,barrier)}async cloneFrom(handle){this.referenceMode=handle.referenceMode;const literal=await handle.toLiteral(),data=literal.model[0].value;if(this.referenceMode&&literal.model.length>0){await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]),literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:id,storageKey:this.backingStore.storageKey}}));const underlying=await handle.backingStore.getMultiple(literal.model.map(({id:id})=>id));await this.backingStore.storeMultiple(underlying,[this.storageKey])}this.fromLiteral(literal),this.localModified=!0,this.resolveInitialized(),this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({data:this.referenceMode?data:this.value,version:this.version})),await this._persistChanges()}async modelForSynchronization(){if(await this.initialized,this.value&&!this.referenceMode&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null==this.value.storageKey,`values in non-referenceMode stores shouldn't have storageKeys. This store is ${this.storageKey}`),this.referenceMode&&null!==this.value){const value=this.value;await this.ensureBackingStore();const result=await this.backingStore.get(value.id);return{version:this.version,model:[{id:value.id,value:result}]}}return super.modelForSynchronization()}async toLiteral(){await this.initialized;const value=this.value,model=null==value?[]:[{id:value.id,value:value,keys:[]}];return{version:this.version,model:model}}fromLiteral({version:version,model:model}){const value=0===model.length?null:model[0].value;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==value),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.referenceMode||!value.storageKey),this.value=value,this.version=version}}class FirebaseCollection extends FirebaseStorageProvider{constructor(type,storageEngine,id,reference,firebaseKey){super(type,storageEngine,id,reference,firebaseKey),this.pendingWrites=[],this.localKeyId=Date.now(),this.localChanges=new Map,this.addSuppressions=new Map,this.model=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_6__.CrdtCollectionModel,this.version=null,this.remoteState={items:{}},this.initialized=new Promise(resolve=>this.resolveInitialized=resolve),this.valueChangeCallback=this.reference.on("value",dataSnapshot=>this.remoteStateChanged(dataSnapshot))}dispose(){this.reference.off("value",this.valueChangeCallback)}backingType(){return this.type.getContainedType()}remoteStateChanged(dataSnapshot){const newRemoteState=dataSnapshot.val();newRemoteState.items||(newRemoteState.items={});const add=[],remove=[],encIds=new Set([...Object.keys(newRemoteState.items),...Object.keys(this.remoteState.items)]);for(const encId of encIds){const id=FirebaseStorage.decodeKey(encId),suppression=this.addSuppressions.get(id);if(encId in newRemoteState.items){let{keys:encKeys,value:value}=newRemoteState.items[encId];if(encKeys=Object.keys(encKeys),encId in this.remoteState.items){const encOldkeys=Object.keys(this.remoteState.items[encId].keys),{add:encAddKeys,remove:encRemoveKeys}=Object(_util_js__WEBPACK_IMPORTED_MODULE_5__.setDiff)(encOldkeys,encKeys);let addKeys=encAddKeys.map(FirebaseStorage.decodeKey);const removeKeys=encRemoveKeys.map(FirebaseStorage.decodeKey);if(suppression&&(addKeys=addKeys.filter(key=>!suppression.keys.has(key))),addKeys.length){this.localChanges.has(id)&&this.localChanges.get(id).add.length>0&&this.model.has(id)&&(value=this.model.getValue(id));const effective=this.model.add(id,value,addKeys);effective&&add.push({value:value,keys:addKeys,effective:effective})}if(removeKeys.length){const value=this.model.getValue(id),effective=this.model.remove(id,removeKeys);effective&&remove.push({value:value,keys:removeKeys,effective:effective})}}else{let addKeys=encKeys.map(FirebaseStorage.decodeKey);if(suppression&&(addKeys=addKeys.filter(key=>!suppression.keys.has(key))),addKeys.length){this.localChanges.has(id)&&this.localChanges.get(id).add.length>0&&this.model.has(id)&&(value=this.model.getValue(id));const keys=encKeys.map(FirebaseStorage.decodeKey),effective=this.model.add(id,value,keys);effective&&add.push({value:value,keys:keys,effective:effective})}}}else{const{keys:encKeys,value:value}=this.remoteState.items[encId],keys=Object.keys(encKeys).map(FirebaseStorage.decodeKey),effective=this.model.remove(id,keys);effective&&remove.push({value:value,keys:keys,effective:effective})}}for(const[id,{barrierVersion:barrierVersion}]of this.addSuppressions.entries())newRemoteState.version>=barrierVersion&&this.addSuppressions.delete(id);if(0!==add.length||0!==remove.length)if(this.version=Math.max(this.version+1,newRemoteState.version),this.remoteState=newRemoteState,this.resolveInitialized(),this.referenceMode){const ids=add.map(({value:value})=>value.id).concat(remove.map(({value:value})=>value.id));this.ensureBackingStore().then(async backingStore=>{const values=await backingStore.getMultiple(ids),valueMap={};values.forEach(value=>valueMap[value.id]=value);const addPrimitives=add.map(({value:value,keys:keys,effective:effective})=>({value:valueMap[value.id],keys:keys,effective:effective})),removePrimitives=remove.map(({value:value,keys:keys,effective:effective})=>({value:valueMap[value.id],keys:keys,effective:effective}));this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({add:addPrimitives,remove:removePrimitives,version:this.version}))})}else this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({add:add,remove:remove,version:this.version}));else this.resolveInitialized()}get versionForTesting(){return this.version}async get(id){if(await this.initialized,this.referenceMode){const ref=this.model.getValue(id);return null==ref?null:(await this.ensureBackingStore(),await this.backingStore.get(ref.id))}return this.model.getValue(id)}async removeMultiple(items,originatorId=null){await this.initialized,0===items.length&&(items=this.model.toList().map(item=>({id:item.id,keys:[]}))),items.forEach(item=>{item.value=this.model.getValue(item.id),null!==item.value&&(0===item.keys.length&&(item.keys=this.model.getKeys(item.id)),item.effective=this.model.remove(item.id,item.keys))}),this.version++,items=items.filter(item=>item.value),this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({remove:items,version:this.version,originatorId:originatorId})),items.forEach(item=>{this.localChanges.has(item.id)||this.localChanges.set(item.id,{add:[],remove:[]});const localChange=this.localChanges.get(item.id);for(const key of item.keys)localChange.remove.push(key)}),await this._persistChanges()}async remove(id,keys=[],originatorId=null){await this.initialized;const value=this.model.getValue(id);if(null===value)return;0===keys.length&&(keys=this.model.getKeys(id));const effective=this.model.remove(id,keys);this.version++,this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({remove:[{value:value,keys:keys,effective:effective}],version:this.version,originatorId:originatorId})),this.localChanges.has(id)||this.localChanges.set(id,{add:[],remove:[]});const localChange=this.localChanges.get(id);for(const key of keys)localChange.remove.push(key);await this._persistChanges()}async store(value,keys,originatorId=null){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required"),await this.initialized;const id=value.id;let effective;if(this.referenceMode){const referredType=this.type.getContainedType(),storageKey=this.storageEngine.baseStorageKey(referredType,this.storageKey);effective=this.model.add(id,{id:id,storageKey:storageKey},keys),this.version++,this.pendingWrites.push({value:value,storageKey:storageKey})}else effective=this.model.add(id,value,keys),this.version++;this._fire("change",new _storage_provider_base_js__WEBPACK_IMPORTED_MODULE_8__.ChangeEvent({add:[{value:value,keys:keys,effective:effective}],version:this.version,originatorId:originatorId})),this.localChanges.has(id)||this.localChanges.set(id,{add:[],remove:[]});const localChange=this.localChanges.get(id);for(const key of keys)localChange.add.push(key);await this._persistChanges()}get _hasLocalChanges(){return this.localChanges.size>0||this.pendingWrites.length>0}async _persistChangesImpl(){if(this.pendingWrites.length>0){await this.ensureBackingStore(),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.backingStore);const pendingWrites=this.pendingWrites.slice();return this.pendingWrites=[],void await Promise.all(pendingWrites.map(pendingItem=>this.backingStore.store(pendingItem.value,[this.storageKey+this.localKeyId++])))}if(this.localChanges.size>0){let changesPersisted;const result=await this._transaction(data=>{data.items||(data.items={}),data.version=Math.max(data.version+1,this.version),changesPersisted=new Map;for(let[id,{add:add,remove:remove}]of this.localChanges.entries()){const encId=FirebaseStorage.encodeKey(id);changesPersisted.set(id,{add:[...add],remove:[...remove]}),add=add.filter(key=>!(remove.indexOf(key)>=0));const item=data.items[encId]||{value:null,keys:{}};for(const key of add){const encKey=FirebaseStorage.encodeKey(key);item.keys[encKey]=data.version}for(const key of remove){const encKey=FirebaseStorage.encodeKey(key);delete item.keys[encKey]}add.length>0&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.model.has(id)),item.value=this.model.getValue(id)),Object.keys(item.keys).length>0?data.items[encId]=item:delete data.items[encId]}return data.referenceMode=this.referenceMode,data});Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(result.committed);const data=result.snapshot.val();for(let[id,{add:add,remove:remove}]of changesPersisted.entries()){add=new Set(add),remove=new Set(remove);const localChange=this.localChanges.get(id);if(localChange.add=localChange.add.filter(key=>!add.has(key)),localChange.remove=localChange.remove.filter(key=>!remove.has(key)),0===localChange.add.length&&0===localChange.remove.length&&this.localChanges.delete(id),this.addSuppressions.has(id)){const suppression=this.addSuppressions.get(id);for(const key of add)suppression.keys.add(key);suppression.barrierVersion=data.version}else this.addSuppressions.set(id,{keys:add,barrierVersion:data.version})}}}async _toList(){if(await this.initialized,this.referenceMode){const items=(await this.toLiteral()).model;if(0===items.length)return[];this.type.getContainedType();const refSet=new Set;items.forEach(item=>refSet.add(item.value.storageKey)),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(1===refSet.size);refSet.values().next().value;await this.ensureBackingStore();const retrieveItem=async item=>{const ref=item.value;return{id:ref.id,value:await this.backingStore.get(ref.id),keys:item.keys}};return await Promise.all(items.map(retrieveItem))}return(await this.toLiteral()).model}async modelForSynchronization(){const model=await this._toList();return{version:this.version,model:model}}async toList(){return(await this._toList()).map(item=>item.value)}async getMultiple(ids){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"getMultiple not implemented for referenceMode stores"),await this.initialized,ids.map(id=>this.model.getValue(id))}async storeMultiple(values,keys,originatorId=null){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!this.referenceMode,"storeMultiple not implemented for referenceMode stores"),values.map(value=>{this.model.add(value.id,value,keys),this.localChanges.has(value.id)||this.localChanges.set(value.id,{add:[],remove:[]});const localChanges=this.localChanges.get(value.id);for(const key of keys)localChanges.add.push(key)}),await this._persistChanges()}async cloneFrom(handle){this.referenceMode=handle.referenceMode;const literal=await handle.toLiteral();if(this.referenceMode&&literal.model.length>0&&(await Promise.all([this.ensureBackingStore(),handle.ensureBackingStore()]),this.backingStore!==handle.backingStore)){literal.model=literal.model.map(({id:id,value:value})=>({id:id,value:{id:value.id,storageKey:this.backingStore.storageKey}}));const underlying=await handle.backingStore.getMultiple(literal.model.map(({id:id})=>id));await this.backingStore.storeMultiple(underlying,[this.storageKey])}this.fromLiteral(literal);for(const item of this.model.toLiteral())Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(void 0!==item.value.id),this.localChanges.set(item.value.id,{add:[...item.keys],remove:[]});await this._persistChanges()}async toLiteral(){return await this.initialized,await this.persisting,{version:this.version,model:this.model.toLiteral()}}fromLiteral({version:version,model:model}){this.version=version,this.model=new _crdt_collection_model_js__WEBPACK_IMPORTED_MODULE_6__.CrdtCollectionModel(model)}}!function(CursorState){CursorState[CursorState.new=0]="new",CursorState[CursorState.init=1]="init",CursorState[CursorState.stream=2]="stream",CursorState[CursorState.removed=3]="removed",CursorState[CursorState.done=4]="done"}(CursorState||(CursorState={}));class FirebaseCursor{constructor(reference,pageSize,forward){this.orderByIndex=reference.child("items").orderByChild("index"),this.pageSize=pageSize,this.forward=forward,this.state=CursorState.new,this.removed=[],this.baseQuery=null,this.nextBoundary=null,this.end=null,this.removedFn=null}async _init(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.state===CursorState.new),(await this.orderByIndex.limitToLast(1).once("value")).forEach(entry=>this.end=entry.val().index),this.baseQuery=this.forward?this.orderByIndex.limitToFirst(this.pageSize+1):this.orderByIndex.limitToLast(this.pageSize+1),this.removedFn=this.orderByIndex.on("child_removed",snapshot=>{const index=snapshot.val().index;index>this.end||(null===this.nextBoundary||this.forward&&index>=this.nextBoundary||!this.forward&&index<=this.nextBoundary)&&this.removed.push(snapshot.val().value)}),this.state=CursorState.init}get version(){return this.end}async next(){if(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.state!==CursorState.new),this.state===CursorState.done)return{done:!0};let query;this.state===CursorState.init?(query=this.baseQuery.endAt(this.end),this.state=CursorState.stream):this.state===CursorState.stream&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!==this.nextBoundary),query=this.forward?this.baseQuery.startAt(this.nextBoundary).endAt(this.end):this.baseQuery.endAt(this.nextBoundary));const value=[];if(this.state===CursorState.stream){this.nextBoundary=null;const queryResults=await query.once("value");if(this.forward)queryResults.forEach(entry=>{value.length<this.pageSize?value.push(entry.val().value):this.nextBoundary=entry.val().index});else{let startIndex=null;queryResults.forEach(entry=>{value.push(entry.val().value),null===startIndex&&(startIndex=entry.val().index)}),value.length>this.pageSize&&(value.shift(),this.nextBoundary=startIndex),value.reverse()}null===this.nextBoundary&&(this._detach(),this.state=CursorState.removed)}if(this.state===CursorState.removed){for(;this.removed.length&&value.length<this.pageSize;)value.push(this.removed.pop());0===this.removed.length&&(this.state=CursorState.done)}return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(value.length>0),{value:value,done:!1}}close(){this._detach(),this.state=CursorState.done}_detach(){this.removedFn&&(this.orderByIndex.off("child_removed",this.removedFn),this.removedFn=null)}}class FirebaseBigCollection extends FirebaseStorageProvider{constructor(type,storageEngine,id,reference,firebaseKey){super(type,storageEngine,id,reference,firebaseKey),this.cursors=new Map,this.cursorIndex=0}backingType(){return this.type.getContainedType()}enableReferenceMode(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!1,"referenceMode is not supported for BigCollection")}async get(id){const encId=FirebaseStorage.encodeKey(id),snapshot=await this.reference.child("items/"+encId).once("value");return null!==snapshot.val()?snapshot.val().value:null}async store(value,keys,originatorId){let version;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(null!=keys&&keys.length>0,"keys required"),await this.reference.child("version").transaction(data=>version=(data||0)+1,void 0,!1);const encId=FirebaseStorage.encodeKey(value.id);await this.reference.child("items/"+encId).transaction(data=>{null===data?data={value:value,keys:{}}:data.value=value;for(const key of keys){const encKey=FirebaseStorage.encodeKey(key);data.keys[encKey]=version}return data.index=version,data},void 0,!1)}async remove(id,keys,originatorId){await this.reference.child("version").transaction(data=>(data||0)+1,void 0,!1);const encId=FirebaseStorage.encodeKey(id);await this.reference.child("items/"+encId).remove()}async stream(pageSize,forward=!0){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!isNaN(pageSize)&&pageSize>0),this.cursorIndex++;const cursor=new FirebaseCursor(this.reference,pageSize,forward);return await cursor._init(),this.cursors.set(this.cursorIndex,cursor),this.cursorIndex}async cursorNext(cursorId){const cursor=this.cursors.get(cursorId);if(!cursor)return{done:!0};const data=await cursor.next();return data.done&&this.cursors.delete(cursorId),data}cursorClose(cursorId){const cursor=this.cursors.get(cursorId);cursor&&(this.cursors.delete(cursorId),cursor.close())}cursorVersion(cursorId){const cursor=this.cursors.get(cursorId);return cursor?cursor.version:null}async _persistChangesImpl(){throw new Error("FireBaseBigCollection does not implement _persistChangesImpl")}get _hasLocalChanges(){return!1}async cloneFrom(handle){throw new Error("FirebaseBigCollection does not yet implement cloneFrom")}async toLiteral(){throw new Error("FirebaseBigCollection does not yet implement toLiteral")}fromLiteral({version:version,model:model}){throw new Error("FirebaseBigCollection does not yet implement fromLiteral")}clearItemsForTesting(){throw new Error("unimplemented")}}class FirebaseBackingStore extends FirebaseStorageProvider{constructor(){super(...arguments),this.maxConcurrentRequests=5}childRef(id){return this.reference.child("items/"+FirebaseStorage.encodeKey(id))}async store(value,keys){await this.storeSingle(value,keys)}async storeMultiple(values,keys){for(;values.length>0;){const chunk=values.splice(0,this.maxConcurrentRequests);await Promise.all(chunk.map(value=>this.storeSingle(value,keys)))}}async storeSingle(value,keys){return this.childRef(value.id).transaction(data=>{null===data?data={value:value,keys:{}}:data.value=value;for(const key of keys){const encKey=FirebaseStorage.encodeKey(key);data.keys[encKey]=1}return data},void 0,!1)}async remove(id,keys){await this.removeSingle(id,keys)}async removeMultiple(items){if(0===items.length)await this.reference.child("items").remove();else for(;items.length>0;){const chunk=items.splice(0,this.maxConcurrentRequests);await Promise.all(chunk.map(item=>this.removeSingle(item.id,item.keys)))}}async removeSingle(id,keys){return this.childRef(id).transaction(data=>null===data?null:keys.length>0&&(keys.forEach(key=>delete data.keys[FirebaseStorage.encodeKey(key)]),Object.keys(data.keys).length>0)?data:{},void 0,!1)}async get(id){const snapshot=await this.childRef(id).once("value");return null!==snapshot.val()?snapshot.val().value:null}async getMultiple(ids){const values=[];for(;ids.length>0;){const chunk=ids.splice(0,this.maxConcurrentRequests),snapshots=await Promise.all(chunk.map(id=>this.childRef(id).once("value")));values.push(...snapshots.map(s=>null!==s.val()?s.val().value:null))}return values}async toList(){const snapshot=await this.reference.child("items").once("value");return snapshot.val()?Object.values(snapshot.val()).map(x=>x.value):[]}backingType(){return this.type}get _hasLocalChanges(){return!1}async _persistChangesImpl(){throw new Error("FirebaseBackingStore does not implement _persistChangesImpl")}enableReferenceMode(){throw new Error("FirebaseBackingStore does not implement enableReferenceMode")}async ensureBackingStore(){throw new Error("FirebaseBackingStore does not implement ensureBackingStore")}on(kindStr,callback,target){throw new Error("FirebaseBackingStore does not implement on")}off(kindStr,callback){throw new Error("FirebaseBackingStore does not implement off")}async toLiteral(){throw new Error("FirebaseBackingStore does not implement toLiteral")}async cloneFrom(store){throw new Error("FirebaseBackingStore does not implement cloneFrom")}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"atob",function(){return atob});const atob=window.atob},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"btoa",function(){return btoa});const btoa=window.btoa},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"firebase",function(){return firebase});const firebase=window.firebase?window.firebase.firebase:null},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Utils",function(){return Utils});var _build_runtime_manifest_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(41),_build_runtime_arc_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(54),_build_runtime_id_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(29),_build_runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(80),_build_platform_loader_web_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(117),_build_platform_pec_industry_web_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(120),_build_devtools_connector_devtools_inspector_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(121);const log=console.log.bind(console),warn=console.warn.bind(console),env={},Utils={createPathMap:root=>({"https://$arcs/":`${root}/`,"https://$shells/":`${root}/shells/`,"https://$build/":`${root}/shells/lib/build/`,"https://$particles/":`${root}/particles/`}),init:(root,urls)=>{const map=Object.assign(Utils.createPathMap(root),urls);return env.loader=new _build_platform_loader_web_js__WEBPACK_IMPORTED_MODULE_4__.PlatformLoader(map),env.pecFactory=Object(_build_platform_pec_industry_web_js__WEBPACK_IMPORTED_MODULE_5__.PecIndustry)(env.loader),env},env:env,parse:async(content,options)=>{const id=`in-memory-${Math.floor(1e6*(Math.random()+1))}.manifest`,localOptions={id:id,fileName:`./${id}`,loader:env.loader};return options&&Object.assign(localOptions,options),_build_runtime_manifest_js__WEBPACK_IMPORTED_MODULE_0__.Manifest.parse(content,localOptions)},resolve:async(arc,recipe)=>{if(recipe.normalize()){let plan=recipe;if(!plan.isResolved()){const resolver=new _build_runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_3__.RecipeResolver(arc);(plan=await resolver.resolve(recipe))&&plan.isResolved()||(warn("failed to resolve:\n",(plan||recipe).toString({showUnresolved:!0})),log(arc.context,arc,arc.context.storeTags),plan=null)}return plan}warn("failed to normalize:\n",recipe.toString())},spawn:async({id:id,serialization:serialization,context:context,composer:composer,storage:storage})=>{const params={id:_build_runtime_id_js__WEBPACK_IMPORTED_MODULE_2__.IdGenerator.newSession().newArcId(id),fileName:"./serialized.manifest",serialization:serialization,context:context,storageKey:storage,slotComposer:composer,pecFactory:env.pecFactory,loader:env.loader,inspectorFactory:_build_devtools_connector_devtools_inspector_js__WEBPACK_IMPORTED_MODULE_6__.devtoolsInspectorFactory};return Object.assign(params,env.params),serialization?_build_runtime_arc_js__WEBPACK_IMPORTED_MODULE_1__.Arc.deserialize(params):new _build_runtime_arc_js__WEBPACK_IMPORTED_MODULE_1__.Arc(params)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PlatformLoader",function(){return PlatformLoader});var _loader_platform_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(118),_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(119);Object(_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("loader-web","green");const warn=Object(_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("loader-web","green","warn"),error=Object(_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("loader-web","green","error");class PlatformLoader extends _loader_platform_js__WEBPACK_IMPORTED_MODULE_0__.PlatformLoaderBase{flushCaches(){}async loadResource(url){return super._loadURL(this._resolve(url))}async loadBinary(url){return super.loadBinary(this._resolve(url))}async provisionObjectUrl(fileName){const code=`${await this.loadResource(fileName)}\n//# sourceURL=${fileName}`;return URL.createObjectURL(new Blob([code],{type:"application/javascript"}))}async loadParticleClass(spec){const clazz=await this.requireParticle(spec.implFile,spec.implBlobUrl);return clazz.spec=spec,clazz}async requireParticle(unresolvedPath,blobUrl){this.mapParticleUrl(unresolvedPath);const url=blobUrl||this._resolve(unresolvedPath),particle=this.loadWrappedParticle(url);if(particle){const logger=this.provisionLogger(unresolvedPath);return this.unwrapParticle(particle,logger)}}provisionLogger(fileName){return Object(_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)(fileName.split("/").pop(),"#1faa00")}loadWrappedParticle(url){let result;self.defineParticle=function(particleWrapper){result&&warn("multiple particles not supported, last particle wins"),result=particleWrapper};try{importScripts(url)}catch(x){error(x)}return delete self.defineParticle,result}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PlatformLoaderBase",function(){return PlatformLoaderBase});var _runtime_loader_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(56),_runtime_particle_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(63),_runtime_dom_particle_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(61),_runtime_multiplexer_dom_particle_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(64),_runtime_transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(65);
/**
 * @license
 * Copyright (c) 2017 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const html=(strings,...values)=>(strings[0]+values.map((v,i)=>v+strings[i+1]).join("")).trim();class PlatformLoaderBase extends _runtime_loader_js__WEBPACK_IMPORTED_MODULE_0__.Loader{constructor(urlMap){super(),this._urlMap=urlMap||[]}loadResource(name){const path=this._resolve(name);return super.loadResource(path)}_resolve(path){let url=this._urlMap[path];if(!url&&path){const macro=Object.keys(this._urlMap).sort((a,b)=>b.length-a.length).find(k=>path.slice(0,k.length)==k);macro&&(url=this._urlMap[macro]+path.slice(macro.length))}return url=this.normalizeDots(url||path)}mapParticleUrl(path){const parts=path.split("/"),suffix=parts.pop(),folder=parts.join("/"),name=suffix.split(".").shift(),resolved=this._resolve(folder);this._urlMap[name]=resolved,this._urlMap.$here=resolved}unwrapParticle(particleWrapper,log){const resolver=this._resolve.bind(this);return particleWrapper({Particle:_runtime_particle_js__WEBPACK_IMPORTED_MODULE_1__.Particle,DomParticle:_runtime_dom_particle_js__WEBPACK_IMPORTED_MODULE_2__.DomParticle,MultiplexerDomParticle:_runtime_multiplexer_dom_particle_js__WEBPACK_IMPORTED_MODULE_3__.MultiplexerDomParticle,SimpleParticle:_runtime_dom_particle_js__WEBPACK_IMPORTED_MODULE_2__.DomParticle,TransformationDomParticle:_runtime_transformation_dom_particle_js__WEBPACK_IMPORTED_MODULE_4__.TransformationDomParticle,resolver:resolver,log:log||(()=>{}),html:html})}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"logFactory",function(){return logFactory});let logLevel=2;"undefined"!=typeof window&&(logLevel="logLevel"in window?window.logLevel:0,console.log(`log-web: binding logFactory to level [${logLevel}]`));const factory=logLevel>0?(preamble,color,log="log")=>console[log].bind(console,`%c${preamble}`,`background: ${color||"gray"}; color: white; padding: 1px 6px 2px 7px; border-radius: 6px;`):()=>()=>{},logFactory=(...args)=>factory(...args)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PecIndustry",function(){return pecIndustry});const pecIndustry=loader=>{const remap=_expandUrls(loader._urlMap),workerUrl=loader._resolve("https://$build/worker.js");let workerBlobUrl;return loader.provisionObjectUrl(workerUrl).then(url=>workerBlobUrl=url),id=>{workerBlobUrl||console.warn("wokerBlob not available, falling back to network URL");const worker=new Worker(workerBlobUrl||workerUrl),channel=new MessageChannel;return worker.postMessage({id:`${id}:inner`,base:remap},[channel.port1]),channel.port2}},_expandUrls=urlMap=>{const remap={},{origin:origin,pathname:pathname}=location;return Object.keys(urlMap).forEach(k=>{let path=urlMap[k];"/"===path[0]?path=`${origin}${path}`:path.indexOf("//")<0&&(path=`${origin}${pathname.split("/").slice(0,-1).join("/")}/${path}`),remap[k]=path}),remap}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"devtoolsInspectorFactory",function(){return devtoolsInspectorFactory});var _platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(72),_arc_stores_fetcher_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(122),_arc_planner_invoker_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(123),_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(127),_tracing_adapter_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(164);_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.onceConnected.then(devtoolsChannel=>{Object(_tracing_adapter_js__WEBPACK_IMPORTED_MODULE_4__.enableTracingAdapter)(devtoolsChannel)});const devtoolsInspectorFactory={create:arc=>new DevtoolsInspector(arc)};class DevtoolsInspector{constructor(arc){if(this.arcDevtoolsChannel=null,this.onceActiveResolve=null,this.onceActive=null,arc.isStub)return;this.onceActive=new Promise(resolve=>this.onceActiveResolve=resolve);const connectedOnInstantiate=_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected;_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.onceConnected.then(devtoolsChannel=>{connectedOnInstantiate||devtoolsChannel.send({messageType:"warning",messageBody:"pre-existing-arc"}),this.arcDevtoolsChannel=devtoolsChannel.forArc(arc);new _arc_stores_fetcher_js__WEBPACK_IMPORTED_MODULE_1__.ArcStoresFetcher(arc,this.arcDevtoolsChannel),new _arc_planner_invoker_js__WEBPACK_IMPORTED_MODULE_2__.ArcPlannerInvoker(arc,this.arcDevtoolsChannel);this.arcDevtoolsChannel.send({messageType:"arc-available",messageBody:{speculative:arc.isSpeculative,inner:arc.isInnerArc}}),this.sendEnvironmentMessage(arc),this.onceActiveResolve()})}recipeInstantiated(particles,activeRecipe){if(!_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected)return;const truncate=({id:id,name:name})=>({id:id,name:name}),slotConnections=[];particles.forEach(p=>Object.values(p.consumedSlotConnections).forEach(cs=>{cs.targetSlot&&slotConnections.push({particleId:cs.particle.id.toString(),consumed:truncate(cs.targetSlot),provided:Object.values(cs.providedSlots).map(slot=>truncate(slot))})})),this.arcDevtoolsChannel.send({messageType:"recipe-instantiated",messageBody:{slotConnections:slotConnections,activeRecipe:activeRecipe}})}pecMessage(name,pecMsgBody,pecMsgCount,stackString){if(!_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected)return;const stack=this._extractStackFrames(stackString);this.arcDevtoolsChannel.send({messageType:"PecLog",messageBody:{name:name,pecMsgBody:pecMsgBody,pecMsgCount:pecMsgCount,timestamp:Date.now(),stack:stack}})}_extractStackFrames(stackString){const stack=[];if(!stackString)return stack;if(stackString.includes("(file:///")){for(const frameString of stackString.split("\n    at ").slice(2)){const match=frameString.match(/^(.*) \((.*)\)$/),method=match?match[1]:"<unknown>";let location=match?match[2]:frameString;(location=location.replace(/:[0-9]+$/,"")).startsWith("file")&&(location=location.replace(/^.*\/arcs[^\/]*\//,"")),stack.push({method:method,location:location,target:null,targetClass:"noLink"})}return stack}return _platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_0__.mapStackTrace&&Object(_platform_sourcemapped_stacktrace_web_js__WEBPACK_IMPORTED_MODULE_0__.mapStackTrace)(stackString,mapped=>mapped.slice(1).map(frameString=>{const match=frameString.match(/^ {4}at (.*) \((.*)\)$/),method=match?match[1]:"<unknown>";let source=match?match[2]:frameString.replace(/^ *at */,"");const frame={method:method};(source=match[2].replace(/:[0-9]+$/,"")).startsWith("http")?(frame.location=source.replace(/^.*\/arcs[^\/]*\//,""),frame.target=source,frame.targetClass="link"):source.startsWith("webpack")?(frame.location=source.slice(11),frame.target=`webpack:///./${frame.location}`,frame.targetClass="link"):(frame.location=source,frame.target=null,frame.targetClass="noLink"),stack.push(frame)}),{sync:!1,cacheGlobally:!0}),stack}isActive(){return _devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected}sendEnvironmentMessage(arc){const allManifests=[];!function traverse(manifest){allManifests.push(manifest),manifest.imports.forEach(traverse)}(arc.context),this.arcDevtoolsChannel.send({messageType:"arc-environment",messageBody:{recipes:arc.context.allRecipes.map(r=>({name:r.name,text:r.toString(),file:allManifests.find(m=>m.recipes.includes(r)).fileName})),particles:arc.context.allParticles.map(p=>({name:p.name,spec:p.toString(),file:allManifests.find(m=>m.particles.includes(p)).fileName}))}})}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ArcStoresFetcher",function(){return ArcStoresFetcher});
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class ArcStoresFetcher{constructor(arc,arcDevtoolsChannel){this.arc=arc,arcDevtoolsChannel.listen("fetch-stores",async()=>arcDevtoolsChannel.send({messageType:"fetch-stores-result",messageBody:await this._listStores()}))}async _listStores(){const find=manifest=>{let tags=[...manifest.storeTags];return manifest.imports&&manifest.imports.forEach(imp=>tags=tags.concat(find(imp))),tags};return{arcStores:await this._digestStores([...this.arc.storeTags]),contextStores:await this._digestStores(find(this.arc.context))}}async _digestStores(stores){const result=[];for(const[store,tags]of stores){let value;value=store.toList?await store.toList():store.get?await store.get():"(don't know how to dereference)",JSON.stringify(value).length>5e4&&(value="too large for WebRTC"),result.push({name:store.name,tags:tags?[...tags]:[],id:store.id,storage:store.storageKey,type:store.type,description:store.description,value:value})}return result}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ArcPlannerInvoker",function(){return ArcPlannerInvoker});var _runtime_manifest_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(41),_planning_planner_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(124),_planning_recipe_index_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(160),_planning_strategies_coalesce_recipes_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(142),_planning_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(157),_planning_strategizer_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(140);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class InitialRecipe extends _planning_strategizer_js__WEBPACK_IMPORTED_MODULE_5__.Strategy{constructor(recipe){super(),this.recipe=recipe}async generate({generation:generation}){return 0!==generation?[]:[{result:this.recipe,score:1,derivation:[{strategy:this,parent:void 0}],hash:this.recipe.digest(),valid:Object.isFrozen(this.recipe)}]}}class ArcPlannerInvoker{constructor(arc,arcDevtoolsChannel){this.arc=arc,arcDevtoolsChannel.listen("fetch-strategies",()=>arcDevtoolsChannel.send({messageType:"fetch-strategies-result",messageBody:_planning_planner_js__WEBPACK_IMPORTED_MODULE_1__.Planner.AllStrategies.map(s=>s.name)})),arcDevtoolsChannel.listen("invoke-planner",async msg=>arcDevtoolsChannel.send({messageType:"invoke-planner-result",messageBody:await this.invokePlanner(msg.messageBody.manifest,msg.messageBody.method),requestId:msg.requestId}))}async invokePlanner(manifestString,method){let manifest;this.recipeIndex||(this.recipeIndex=_planning_recipe_index_js__WEBPACK_IMPORTED_MODULE_2__.RecipeIndex.create(this.arc,{reportGenerations:!1}),await this.recipeIndex.ready);try{manifest=await _runtime_manifest_js__WEBPACK_IMPORTED_MODULE_0__.Manifest.parse(manifestString,{loader:this.arc._loader,fileName:"manifest.manifest"})}catch(error){return this.processManifestError(error)}if(0===manifest.recipes.length)return{results:[]};if(manifest.recipes.length>1)return{error:{message:`More than 1 recipe present, found ${manifest.recipes.length}.`}};const recipe=manifest.recipes[0];return recipe.normalize(),"arc"===method||"arc_coalesce"===method?this.multiStrategyRun(recipe,method):this.singleStrategyRun(recipe,method)}async multiStrategyRun(recipe,method){const strategies="arc_coalesce"===method?_planning_planner_js__WEBPACK_IMPORTED_MODULE_1__.Planner.ResolutionStrategies:_planning_planner_js__WEBPACK_IMPORTED_MODULE_1__.Planner.ResolutionStrategies.filter(s=>s!==_planning_strategies_coalesce_recipes_js__WEBPACK_IMPORTED_MODULE_3__.CoalesceRecipes),strategizer=new _planning_strategizer_js__WEBPACK_IMPORTED_MODULE_5__.Strategizer([new InitialRecipe(recipe),...strategies.map(S=>this.instantiate(S))],[],_planning_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_4__.Empty),terminal=[];do{await strategizer.generate(),terminal.push(...strategizer.terminal)}while(strategizer.generated.length+strategizer.terminal.length>0);return this.processStrategyOutput(terminal)}async singleStrategyRun(recipe,strategyName){const strategy=_planning_planner_js__WEBPACK_IMPORTED_MODULE_1__.Planner.AllStrategies.find(s=>s.name===strategyName);return strategy?this.processStrategyOutput(await this.instantiate(strategy).generate({generation:0,generated:[{result:recipe,score:1}],population:[{result:recipe,score:1}],terminal:[{result:recipe,score:1}]})):{error:{message:`Strategy ${strategyName} not found`}}}instantiate(strategyClass){return new strategyClass(this.arc,{recipeIndex:this.recipeIndex})}processStrategyOutput(inputs){return{results:inputs.map(result=>{const recipe=result.result,errors=new Map;Object.isFrozen(recipe)||recipe.normalize({errors:errors});let recipeString="";try{recipeString=recipe.toString({showUnresolved:!0})}catch(e){console.warn(e)}return{recipe:recipeString,derivation:this.extractDerivation(result),errors:[...errors.values()].map(error=>({error:error}))}})}}extractDerivation(result){const found=[];for(const deriv of result.derivation||[])if(deriv.parent||deriv.strategy.constructor===InitialRecipe){if(deriv.parent){const childDerivs=this.extractDerivation(deriv.parent);for(const childDeriv of childDerivs)found.push(childDeriv?`${childDeriv} -> ${deriv.strategy.constructor.name}`:deriv.strategy.constructor.name);0===childDerivs.length&&found.push(deriv.strategy.constructor.name)}}else found.push(deriv.strategy.constructor.name);return found}processManifestError(error){let suggestion=null;const errorTypes=[{pattern:/could not find particle ([A-Z][A-Za-z0-9_]*)\n/,predicate:extracted=>manifest=>!!manifest.particles.find(p=>p.name===extracted)},{pattern:/Could not resolve type reference to type name '([A-Z][A-Za-z0-9_]*)'\n/,predicate:extracted=>manifest=>!!manifest.schemas[extracted]}];for(const{pattern:pattern,predicate:predicate}of errorTypes){const match=pattern.exec(error.message);if(match){const[_,extracted]=match,fileNames=this.findManifestNames(this.arc.context,predicate(extracted));fileNames.length>0&&(suggestion={action:"import",fileNames:fileNames})}}return{suggestion:suggestion,error:(({location:location,message:message})=>({location:location,message:message}))(error)}}findManifestNames(manifest,predicate){const map=new Map;return this.findManifestNamesRecursive(manifest,predicate,map),[...map.entries()].sort(([a,depthA],[b,depthB])=>depthA-depthB).map(v=>v[0])}findManifestNamesRecursive(manifest,predicate,fileNames){let depth=predicate(manifest)?0:Number.MAX_SAFE_INTEGER;for(const child of manifest.imports)depth=Math.min(depth,this.findManifestNamesRecursive(child,predicate,fileNames)+1);return depth<Number.MAX_SAFE_INTEGER&&manifest.fileName.startsWith("http")&&fileNames.set(manifest.fileName,depth),depth}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Planner",function(){return Planner});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_date_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(125),_platform_deviceinfo_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(126),_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(127),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(47),_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(134),_debug_strategy_explorer_adapter_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(136),_plan_planning_result_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(137),_plan_suggestion_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(138),_strategies_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(139),_strategies_assign_handles_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(141),_strategies_coalesce_recipes_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(142),_strategies_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(143),_strategies_create_description_handle_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(144),_strategies_create_handle_group_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(145),_strategies_find_hosted_particle_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(146),_strategies_find_required_particle_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(147),_strategies_group_handle_connections_js__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__(148),_strategies_init_population_js__WEBPACK_IMPORTED_MODULE_18__=__webpack_require__(149),_strategies_init_search_js__WEBPACK_IMPORTED_MODULE_19__=__webpack_require__(150),_strategies_map_slots_js__WEBPACK_IMPORTED_MODULE_20__=__webpack_require__(151),_strategies_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_21__=__webpack_require__(152),_strategies_match_particle_by_verb_js__WEBPACK_IMPORTED_MODULE_22__=__webpack_require__(153),_strategies_match_recipe_by_verb_js__WEBPACK_IMPORTED_MODULE_23__=__webpack_require__(154),_strategies_name_unnamed_connections_js__WEBPACK_IMPORTED_MODULE_24__=__webpack_require__(155),_strategies_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_25__=__webpack_require__(156),_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_26__=__webpack_require__(157),_strategies_search_tokens_to_handles_js__WEBPACK_IMPORTED_MODULE_27__=__webpack_require__(159),_strategies_search_tokens_to_particles_js__WEBPACK_IMPORTED_MODULE_28__=__webpack_require__(158),_strategizer_js__WEBPACK_IMPORTED_MODULE_29__=__webpack_require__(140),_runtime_description_js__WEBPACK_IMPORTED_MODULE_30__=__webpack_require__(39),_runtime_runtime_js__WEBPACK_IMPORTED_MODULE_31__=__webpack_require__(38);const suggestionByHash=()=>_runtime_runtime_js__WEBPACK_IMPORTED_MODULE_31__.Runtime.getRuntime().getCacheService().getOrCreateCache("suggestionByHash");class Planner{init(arc,{strategies:strategies=Planner.AllStrategies,ruleset:ruleset=_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_26__.Empty,strategyArgs:strategyArgs={},speculator:speculator=null,blockDevtools:blockDevtools=!1}={}){strategyArgs=Object.freeze({...strategyArgs}),this._arc=arc;const strategyImpls=strategies.map(strategy=>new strategy(arc,strategyArgs));this.strategizer=new _strategizer_js__WEBPACK_IMPORTED_MODULE_29__.Strategizer(strategyImpls,[],ruleset),this.blockDevtools=blockDevtools,this.speculator=speculator}async plan(timeout,generations=[]){const trace=_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_5__.Tracing.start({cat:"planning",name:"Planner::plan",overview:!0,args:{timeout:timeout}});timeout=timeout||-1;const allResolved=[],start=Object(_platform_date_web_js__WEBPACK_IMPORTED_MODULE_1__.now)();do{const record=await trace.wait(this.strategizer.generate()),generated=this.strategizer.generated;trace.addArgs({generated:generated.length,generation:this.strategizer.generation}),generations&&generations.push({generated:generated,record:record});const resolved=this.strategizer.generated.map(individual=>individual.result).filter(recipe=>recipe.isResolved());allResolved.push(...resolved);const elapsed=Object(_platform_date_web_js__WEBPACK_IMPORTED_MODULE_1__.now)()-start;if(timeout>=0&&elapsed>timeout){console.warn(`Planner.plan timed out [elapsed=${Math.floor(elapsed)}ms, timeout=${timeout}ms].`);break}}while(this.strategizer.generated.length+this.strategizer.terminal.length>0);return trace.end(),generations.length&&!this.blockDevtools&&_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected&&_debug_strategy_explorer_adapter_js__WEBPACK_IMPORTED_MODULE_6__.StrategyExplorerAdapter.processGenerations(_plan_planning_result_js__WEBPACK_IMPORTED_MODULE_7__.PlanningResult.formatSerializableGenerations(generations),_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.get().forArc(this._arc),{label:"Planner",keep:!0}),allResolved}_speculativeThreadCount(){const cores=_platform_deviceinfo_web_js__WEBPACK_IMPORTED_MODULE_2__.DeviceInfo.hardwareConcurrency(),memory=_platform_deviceinfo_web_js__WEBPACK_IMPORTED_MODULE_2__.DeviceInfo.deviceMemory();if(!cores||!memory)return 2;const maxThreadsByMemory=memory/4/.125,maxThreadsByCores=cores/2;return Math.max(2,Math.min(maxThreadsByMemory,maxThreadsByCores))}_splitToGroups(items,groupCount){const groups=[];if(!items||0===items.length)return groups;const groupItemSize=Math.max(1,Math.floor(items.length/groupCount));let startIndex=0;for(let i=0;i<groupCount&&startIndex<items.length;i++)groups.push(items.slice(startIndex,startIndex+groupItemSize)),startIndex+=groupItemSize;return startIndex<items.length&&groups[groups.length-1].push(...items.slice(startIndex,items.length)),groups}async suggest(timeout,generations=[]){const trace=_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_5__.Tracing.start({cat:"planning",name:"Planner::suggest",overview:!0,args:{timeout:timeout}}),plans=await trace.wait(this.plan(timeout,generations)),threadCount=this._speculativeThreadCount(),planGroups=this._splitToGroups(plans,threadCount);let results=await trace.wait(Promise.all(planGroups.map(async(group,groupIndex)=>{const results=[];for(const plan of group){const hash=(hash=>hash.substring(hash.length-4))(await plan.digest());if(_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_4__.RecipeUtil.matchesRecipe(this._arc.activeRecipe,plan)){this._updateGeneration(generations,hash,g=>g.active=!0);continue}const planTrace=_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_5__.Tracing.start({cat:"speculating",sequence:`speculator_${groupIndex}`,overview:!0,args:{groupIndex:groupIndex}}),suggestion=await this.retriveOrCreateSuggestion(hash,plan,this._arc);suggestion?(this._updateGeneration(generations,hash,g=>g.description=suggestion.descriptionText),suggestion.groupIndex=groupIndex,results.push(suggestion),planTrace.end({name:suggestion.descriptionText,args:{rank:suggestion.rank,hash:hash,groupIndex:groupIndex}})):(this._updateGeneration(generations,hash,g=>g.irrelevant=!0),planTrace.end({name:"[Irrelevant suggestion]",args:{hash:hash,groupIndex:groupIndex}}))}return results})));return results=[].concat(...results),trace.endWith(results)}static clearCache(){suggestionByHash().clear()}async retriveOrCreateSuggestion(hash,plan,arc){const cachedSuggestion=suggestionByHash().get(hash);if(cachedSuggestion&&cachedSuggestion.isUpToDate(arc,plan))return cachedSuggestion;let relevance=null,description=null;if(this.speculator){const result=await this.speculator.speculate(this._arc,plan,hash);if(!result)return;const speculativeArc=result.speculativeArc;relevance=result.relevance,description=await _runtime_description_js__WEBPACK_IMPORTED_MODULE_30__.Description.create(speculativeArc,relevance)}else description=await _runtime_description_js__WEBPACK_IMPORTED_MODULE_30__.Description.createForPlan(plan);const suggestion=_plan_suggestion_js__WEBPACK_IMPORTED_MODULE_8__.Suggestion.create(plan,hash,relevance);return suggestion.setDescription(description,this._arc.modality,this._arc.pec.slotComposer?this._arc.pec.slotComposer.modalityHandler.descriptionFormatter:void 0),suggestionByHash().set(hash,suggestion),suggestion}_updateGeneration(generations,hash,handler){generations&&generations.forEach(g=>{g.generated.forEach(gg=>{Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)("string"==typeof gg.hash),"string"==typeof gg.hash&&gg.hash.endsWith(hash)&&handler(gg)})})}}Planner.InitializationStrategies=[_strategies_init_population_js__WEBPACK_IMPORTED_MODULE_18__.InitPopulation,_strategies_init_search_js__WEBPACK_IMPORTED_MODULE_19__.InitSearch],Planner.ResolutionStrategies=[_strategies_search_tokens_to_particles_js__WEBPACK_IMPORTED_MODULE_28__.SearchTokensToParticles,_strategies_search_tokens_to_handles_js__WEBPACK_IMPORTED_MODULE_27__.SearchTokensToHandles,_strategies_group_handle_connections_js__WEBPACK_IMPORTED_MODULE_17__.GroupHandleConnections,_strategies_create_handle_group_js__WEBPACK_IMPORTED_MODULE_14__.CreateHandleGroup,_strategies_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_12__.ConvertConstraintsToConnections,_strategies_map_slots_js__WEBPACK_IMPORTED_MODULE_20__.MapSlots,_strategies_assign_handles_js__WEBPACK_IMPORTED_MODULE_10__.AssignHandles,_strategies_match_particle_by_verb_js__WEBPACK_IMPORTED_MODULE_22__.MatchParticleByVerb,_strategies_match_recipe_by_verb_js__WEBPACK_IMPORTED_MODULE_23__.MatchRecipeByVerb,_strategies_name_unnamed_connections_js__WEBPACK_IMPORTED_MODULE_24__.NameUnnamedConnections,_strategies_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_9__.AddMissingHandles,_strategies_create_description_handle_js__WEBPACK_IMPORTED_MODULE_13__.CreateDescriptionHandle,_strategies_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_21__.MatchFreeHandlesToConnections,_strategies_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_25__.ResolveRecipe,_strategies_find_hosted_particle_js__WEBPACK_IMPORTED_MODULE_15__.FindHostedParticle,_strategies_coalesce_recipes_js__WEBPACK_IMPORTED_MODULE_11__.CoalesceRecipes,_strategies_find_required_particle_js__WEBPACK_IMPORTED_MODULE_16__.FindRequiredParticle],Planner.AllStrategies=Planner.InitializationStrategies.concat(Planner.ResolutionStrategies)},function(module,__webpack_exports__,__webpack_require__){"use strict";function now(){return performance.now()}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"now",function(){return now})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DeviceInfo",function(){return DeviceInfo});class DeviceInfo{static hardwareConcurrency(){return navigator.hardwareConcurrency}static deviceMemory(){return navigator.deviceMemory}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DevtoolsConnection",function(){return DevtoolsConnection}),__webpack_require__.d(__webpack_exports__,"DevtoolsForTests",function(){return DevtoolsForTests});var _devtools_shared_devtools_broker_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(128),_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(17),_platform_devtools_channel_web_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(129),_testing_devtools_channel_stub_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(133);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
let channel=null,isConnected=!1,onceConnectedResolve=null,onceConnected=new Promise(resolve=>onceConnectedResolve=resolve);_devtools_shared_devtools_broker_js__WEBPACK_IMPORTED_MODULE_0__.DevtoolsBroker.onceConnected.then(()=>{DevtoolsConnection.ensure(),onceConnectedResolve(channel),isConnected=!0});class DevtoolsConnection{static get isConnected(){return isConnected}static get onceConnected(){return onceConnected}static get(){return channel}static ensure(){channel||(channel=new _platform_devtools_channel_web_js__WEBPACK_IMPORTED_MODULE_2__.DevtoolsChannel)}}class DevtoolsForTests{static get channel(){return channel}static ensureStub(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(!channel),channel=new _testing_devtools_channel_stub_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsChannelStub,onceConnectedResolve(channel),isConnected=!0}static reset(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(channel),isConnected=!1,onceConnectedResolve=null,onceConnected=new Promise(resolve=>onceConnectedResolve=resolve),channel=null}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(global){__webpack_require__.d(__webpack_exports__,"DevtoolsBroker",function(){return DevtoolsBroker});
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const root="object"==typeof window?window:global;root._arcDebugPromise||(root._arcDebugPromise=new Promise(resolve=>{root._arcDebugPromiseResolve=resolve}));class DevtoolsBroker{static get onceConnected(){return root._arcDebugPromise}static markConnected(){root._arcDebugPromiseResolve()}}}.call(this,__webpack_require__(68))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DevtoolsChannel",function(){return DevtoolsChannel});var _devtools_shared_web_rtc_signalling_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(130),_devtools_connector_abstract_devtools_channel_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(131),_devtools_shared_devtools_broker_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(128),_shells_lib_database_firebase_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(132);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DevtoolsChannel extends _devtools_connector_abstract_devtools_channel_js__WEBPACK_IMPORTED_MODULE_1__.AbstractDevtoolsChannel{constructor(){super(),this.remoteExploreKey=new URLSearchParams(window.location.search).get("remote-explore-key"),this.remoteExploreKey?this._connectViaWebRtc(this.remoteExploreKey):document.addEventListener("arcs-debug-in",e=>this._handleMessage(e.detail))}_connectViaWebRtc(remoteExploreKey){console.log("Attempting a connection with remote Arcs Explorer.");const connection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]}),channel=connection.createDataChannel("arcs-explorer");channel.onopen=(e=>{console.log("WebRTC channel opened")}),channel.onmessage=(({data:data})=>{"init"===data?(this.webRtcChannel=channel,_devtools_shared_devtools_broker_js__WEBPACK_IMPORTED_MODULE_2__.DevtoolsBroker.markConnected(),this._sendHeartbeat()):this._handleMessage(JSON.parse(data))}),channel.onclose=(e=>{console.warn("WebRTC channel closed"),this.webRtcChannel=null}),connection.onicecandidate=(e=>{e.candidate||Object(_devtools_shared_web_rtc_signalling_js__WEBPACK_IMPORTED_MODULE_0__.offerWebRtcSignal)(_shells_lib_database_firebase_js__WEBPACK_IMPORTED_MODULE_3__.database,remoteExploreKey,btoa(JSON.stringify(connection.localDescription)),signal=>connection.setRemoteDescription(JSON.parse(atob(signal))).catch(e=>console.error(e)))}),connection.createOffer().then(offer=>connection.setLocalDescription(offer)).catch(e=>{console.error(e)})}_sendHeartbeat(){this.webRtcChannel&&(this.webRtcChannel.send("heartbeat"),setTimeout(()=>this._sendHeartbeat(),1e3))}_flush(messages){this.remoteExploreKey?this.webRtcChannel?this.webRtcChannel.send(JSON.stringify(messages)):console.warn("Connection to DevTools is closed. Message not sent."):document.dispatchEvent(new CustomEvent("arcs-debug-out",{detail:messages}))}}},function(module,__webpack_exports__,__webpack_require__){"use strict";
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
function offerWebRtcSignal(database,channelId,shellSignal,onExplorerSignal){const ref=database.ref(`devtoolsSignalling/${channelId}`),initId=randomInt();ref.set({init:initId}),onValue(ref,`ack_${initId}`,ackId=>{ref.child(`offer_${ackId}`).set(shellSignal),onValue(ref,`answer_${ackId}`,explorerSignal=>onExplorerSignal(explorerSignal))})}function listenForWebRtcSignal(database,channelId,onShellSignal){const ref=database.ref(`devtoolsSignalling/${channelId}`),initRef=ref.child("init"),initCb=initIdSnap=>{if(!initIdSnap.exists())return;const ackId=randomInt();ref.child(`ack_${initIdSnap.val()}`).set(ackId),onValue(ref,`offer_${ackId}`,shellSignal=>{initRef.off("value",initCb),onShellSignal(shellSignal).then(explorerSignal=>{ref.child(`answer_${ackId}`).set(explorerSignal)})})};initRef.on("value",initCb)}function onValue(ref,path,onVal){const childRef=ref.child(path),cb=snap=>{snap.exists()&&(onVal(snap.val()),childRef.off("value",cb))};childRef.on("value",cb)}function randomInt(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"offerWebRtcSignal",function(){return offerWebRtcSignal}),__webpack_require__.d(__webpack_exports__,"listenForWebRtcSignal",function(){return listenForWebRtcSignal})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"AbstractDevtoolsChannel",function(){return AbstractDevtoolsChannel}),__webpack_require__.d(__webpack_exports__,"ArcDevtoolsChannel",function(){return ArcDevtoolsChannel});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */class AbstractDevtoolsChannel{constructor(){this.debouncedMessages=[],this.messageListeners=new Map,this.timer=null}send(message){this.ensureNoCycle(message),this.debouncedMessages.push(message),this.debouncedMessages.length>10?this._empty():this.timer||(this.timer=setTimeout(()=>this._empty(),100))}listen(arcOrId,messageType,listener){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(messageType),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(arcOrId);const key=`${"string"==typeof arcOrId?arcOrId:arcOrId.id.toString()}/${messageType}`;let listeners=this.messageListeners.get(key);listeners||this.messageListeners.set(key,listeners=[]),listeners.push(listener)}forArc(arc){return new ArcDevtoolsChannel(arc,this)}_handleMessage(msg){const listeners=this.messageListeners.get(`${msg.arcId}/${msg.messageType}`);if(listeners)for(const listener of listeners)listener(msg);else console.warn(`No one is listening to ${msg.messageType} message`)}_empty(){this._flush(this.debouncedMessages),this.debouncedMessages=[],clearTimeout(this.timer),this.timer=null}_flush(_messages){throw new Error("Not implemented in an abstract class")}ensureNoCycle(object,objectPath=[]){object&&"object"==typeof object&&(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(-1===objectPath.indexOf(object),"Message cannot contain a cycle"),objectPath.push(object),(Array.isArray(object)?object:Object.values(object)).forEach(element=>this.ensureNoCycle(element,objectPath)),objectPath.pop())}}class ArcDevtoolsChannel{constructor(arc,channel){this.channel=channel,this.arcId=arc.id.toString()}send(message){this.channel.send({meta:{arcId:this.arcId},...message})}listen(messageType,callback){this.channel.listen(this.arcId,messageType,callback)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"app",function(){return app}),__webpack_require__.d(__webpack_exports__,"database",function(){return database}),__webpack_require__.d(__webpack_exports__,"storage",function(){return storage});var _build_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(115);__webpack_require__.d(__webpack_exports__,"firebase",function(){return _build_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_0__.firebase});
/*
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
*/
const app=_build_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_0__.firebase&&_build_platform_firebase_web_js__WEBPACK_IMPORTED_MODULE_0__.firebase.initializeApp({server:"arcs-storage.firebaseio.com",apiKey:"AIzaSyBme42moeI-2k8WgXh-6YK_wYyjEXo4Oz8",authDomain:"arcs-storage.firebaseapp.com",databaseURL:"https://arcs-storage.firebaseio.com",projectId:"arcs-storage",storageBucket:"arcs-storage.appspot.com",messagingSenderId:"779656349412"},"images"),database=app&&app.database(),storage=app&&app.storage()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DevtoolsChannelStub",function(){return DevtoolsChannelStub});
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class DevtoolsChannelStub{constructor(){this._messages=[]}get messages(){return this._messages}send(message){this._messages.push(JSON.parse(JSON.stringify(message)))}listen(arcOrId,messageType,listener){}clear(){this._messages.length=0}forArc(arc){return this}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(process){__webpack_require__.d(__webpack_exports__,"Tracing",function(){return Tracing});const events=[];let pid,now;"object"==typeof document?(pid=42,now=(()=>1e3*performance.now())):(pid=process.pid,now=(()=>{const t=process.hrtime();return 1e6*t[0]+t[1]/1e3}));let flowId=0;function parseInfo(info){return info?"function"==typeof info?parseInfo(info()):info.toTraceInfo?parseInfo(info.toTraceInfo()):info:{}}const streamingCallbacks=[];function pushEvent(event){event.pid=pid,event.tid=0,event.args||delete event.args,event.ov||delete event.ov,event.cat||(event.cat=""),0===streamingCallbacks.length&&events.push(event),Promise.resolve().then(()=>{for(const{callback:callback,predicate:predicate}of streamingCallbacks)predicate&&!predicate(event)||callback(event)})}const module_={exports:{}},Tracing=module_.exports;function init(){const result={wait:async v=>v,start(){return this},end(){return this},step(){return this},addArgs(){},endWith:async v=>v};function startSyncTrace(info){let args=(info=parseInfo(info)).args;const begin=now();return{addArgs(extraArgs){args={...args||{},...extraArgs}},end(endInfo={},flow){(endInfo=parseInfo(endInfo)).args&&(args={...args||{},...endInfo.args}),endInfo={...info,...endInfo},this.endTs=now(),pushEvent({ph:"X",ts:begin,dur:this.endTs-begin,cat:endInfo.cat,name:endInfo.name,ov:endInfo.overview,args:args,flowId:flow&&flow.id(),seq:endInfo.sequence})},beginTs:begin}}module_.exports.wrap=((info,fn)=>fn),module_.exports.start=(info=>result),module_.exports.flow=(info=>result),module_.exports.enabled&&(module_.exports.wrap=((info,fn)=>(...args)=>{const t=module_.exports.start(info);try{return fn(...args)}finally{t.end()}}),module_.exports.start=(info=>{let flow,trace=startSyncTrace(info);const baseInfo={cat:info.cat,name:info.name+" (async)",overview:info.overview,sequence:info.sequence};return{async wait(v,info){const flowExisted=!!flow;flowExisted||(flow=module_.exports.flow(baseInfo)),trace.end(info,flow),flowExisted?flow.step({ts:trace.beginTs,...baseInfo}):flow.start({ts:trace.endTs}),trace=null;try{return await v}finally{trace=startSyncTrace(baseInfo)}},addArgs(extraArgs){trace.addArgs(extraArgs)},end(endInfo){trace.end(endInfo,flow),flow&&flow.end({ts:trace.beginTs})},async endWith(v,endInfo){if(Promise.resolve(v)!==v)return this.end(endInfo),v;v=this.wait(v,null);try{return await v}finally{this.end(endInfo)}}}}),module_.exports.flow=(info=>{info=parseInfo(info);const id=flowId++;let started=!1;return{start(startInfo){const ts=startInfo&&startInfo.ts||now();return started=!0,pushEvent({ph:"s",ts:ts,cat:info.cat,name:info.name,ov:info.overview,args:info.args,id:id,seq:info.sequence}),this},end(endInfo){if(!started)return this;const ts=endInfo&&endInfo.ts||now();return endInfo=parseInfo(endInfo),pushEvent({ph:"f",bp:"e",ts:ts,cat:info.cat,name:info.name,ov:info.overview,args:endInfo&&endInfo.args,id:id,seq:info.sequence}),this},step(stepInfo){if(!started)return this;const ts=stepInfo&&stepInfo.ts||now();return stepInfo=parseInfo(stepInfo),pushEvent({ph:"t",ts:ts,cat:info.cat,name:info.name,ov:info.overview,args:stepInfo&&stepInfo.args,id:id,seq:info.sequence}),this},id:()=>id}}),module_.exports.save=(()=>({traceEvents:events})),module_.exports.download=(()=>{const a=document.createElement("a");a.download="trace.json",a.href="data:text/plain;base64,"+btoa(JSON.stringify(module_.exports.save())),a.click()}),module_.exports.now=now,module_.exports.stream=((callback,predicate)=>{events.length=0,streamingCallbacks.push({callback:callback,predicate:predicate})}),module_.exports.__clearForTests=(()=>{events.length=0,streamingCallbacks.length=0}))}module_.exports.enabled=!1,module_.exports.enable=(()=>{module_.exports.enabled||(module_.exports.enabled=!0,init())}),init()}.call(this,__webpack_require__(135))},function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"StrategyExplorerAdapter",function(){return StrategyExplorerAdapter});
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class StrategyExplorerAdapter{static processGenerations(generations,devtoolsChannel,options={}){devtoolsChannel&&devtoolsChannel.send({messageType:"generations",messageBody:{results:generations,options:options}})}static printGenerations(generations){for(let i=0;i<generations.length;++i)for(let j=0;j<generations[i].generated.length;++j){const gg=generations[i].generated[j];if(!gg.result.isResolved())continue;const results=StrategyExplorerAdapter._collectDerivation(gg.derivation,[]);console.log(results.map(r=>`gen [${i}][${j}] ${r.reverse().join(" -> ")}`).join("\n"))}}static _collectDerivation(derivation,allResults){for(const d of derivation){const results=[];if(results.push(d.strategy.constructor.name),d.parent){const innerResults=StrategyExplorerAdapter._collectDerivation(d.parent.derivation,[]);for(const ir of innerResults)allResults.push([].concat(results,ir))}else allResults.push(results)}return allResults}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PlanningResult",function(){return PlanningResult});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(119),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(47),_suggestion_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(138);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
const error=Object(_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("PlanningResult","#ff0090","error");class PlanningResult{constructor(envOptions,store){this.suggestions=[],this.lastUpdated=new Date(null),this.generations=[],this.contextual=!0,this.changeCallbacks=[],this.envOptions=envOptions,Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(envOptions.context,"context cannot be null"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(envOptions.loader,"loader cannot be null"),this.store=store,this.store&&(this.storeCallback=(()=>this.load()),this.store.on("change",this.storeCallback,this))}registerChangeCallback(callback){this.changeCallbacks.push(callback)}onChanged(){for(const callback of this.changeCallbacks)callback()}async load(){const value=await this.store.get()||{};return!(!value.suggestions||!await this.fromLiteral(value))}async flush(){try{await this.store.set(this.toLiteral())}catch(e){throw error("Failed storing suggestions: ",e),e}}async clear(){return this.store.clear()}dispose(){this.changeCallbacks=[],this.store.off("change",this.storeCallback),this.store.dispose()}static formatSerializableGenerations(generations){const idMap=new Map;let lastID=0;const assignIdAndCopy=recipe=>{idMap.set(recipe,lastID);const{result:result,score:score,derivation:derivation,description:description,hash:hash,valid:valid,active:active,irrelevant:irrelevant}=recipe;return{result:result.toString({showUnresolved:!0,showInvalid:!1,details:""}),resolved:result.isResolved(),score:score,derivation:derivation,description:description,hash:hash,valid:valid,active:active,irrelevant:irrelevant,id:lastID++}};return(generations=generations.map(pop=>({record:pop.record,generated:pop.generated.map(assignIdAndCopy)}))).map(pop=>{const population=pop.generated,record=pop.record;record.resolvedDerivations=0,record.resolvedDerivationsByStrategy={};for(const item of population){if(item.derivation=item.derivation.map(derivItem=>{let parent,strategy;return derivItem.parent&&(parent=idMap.get(derivItem.parent)),derivItem.strategy&&(strategy=derivItem.strategy.constructor.name),{parent:parent,strategy:strategy}}),item.resolved){record.resolvedDerivations++;const strategy=item.derivation[0].strategy;void 0===record.resolvedDerivationsByStrategy[strategy]&&(record.resolvedDerivationsByStrategy[strategy]=0),record.resolvedDerivationsByStrategy[strategy]++}}const populationMap={};for(const item of population)null==populationMap[item.derivation[0].strategy]&&(populationMap[item.derivation[0].strategy]=[]),populationMap[item.derivation[0].strategy].push(item);const result={population:[],record:record};for(const strategy of Object.keys(populationMap))result.population.push({strategy:strategy,recipes:populationMap[strategy]});return result})}_set({suggestions:suggestions,lastUpdated:lastUpdated=new Date,generations:generations=[],contextual:contextual=!0}){this.suggestions=suggestions,this.generations=generations,this.lastUpdated=lastUpdated,this.contextual=contextual,this.onChanged()}merge({suggestions:suggestions,lastUpdated:lastUpdated=new Date,generations:generations=[],contextual:contextual=!0},arc){const newSuggestions=[],removeIndexes=[],arcVersionByStore=arc.getVersionByStore({includeArc:!0,includeContext:!0});for(const newSuggestion of suggestions){const index=this.suggestions.findIndex(suggestion=>suggestion.isEquivalent(newSuggestion));if(index>=0){if(this.suggestions[index].isEqual(newSuggestion))continue;const outdatedStores=Object.keys(newSuggestion.versionByStore).filter(storeId=>{const currentVersion=this.suggestions[index].versionByStore[storeId];return void 0===currentVersion||newSuggestion.versionByStore[storeId]<currentVersion});outdatedStores.length>0&&console.warn(`New suggestions has older store versions:\n ${outdatedStores.map(id=>`${id}: ${this.suggestions[index].versionByStore[id]} -> ${newSuggestion.versionByStore[id]}`).join(";")}`),removeIndexes.push(index),newSuggestion.mergeSearch(this.suggestions[index])}this._isUpToDate(newSuggestion,arcVersionByStore)&&newSuggestions.push(newSuggestion)}const jointSuggestions=this.suggestions.filter((suggestion,index)=>!removeIndexes.some(removeIndex=>removeIndex===index)&&this._isUpToDate(suggestion,arcVersionByStore)&&!_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(arc.activeRecipe,suggestion.plan));return(jointSuggestions.length!==this.suggestions.length||0!==newSuggestions.length)&&(jointSuggestions.push(...newSuggestions),this._set({suggestions:jointSuggestions,generations:this.generations.concat(...generations),lastUpdated:lastUpdated,contextual:contextual&&this.contextual}),!0)}_isUpToDate(suggestion,versionByStore){for(const handle of suggestion.plan.handles){const arcVersion=versionByStore[handle.id]||0;if((suggestion.versionByStore[handle.id]||0)<arcVersion)return!1}return!0}isEquivalent(suggestions){return PlanningResult.isEquivalent(this.suggestions,suggestions)}static isEquivalent(oldSuggestions,newSuggestions){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(newSuggestions,"New suggestions cannot be null."),oldSuggestions&&oldSuggestions.length===newSuggestions.length&&oldSuggestions.every(suggestion=>newSuggestions.find(newSuggestion=>suggestion.isEquivalent(newSuggestion)))}async fromLiteral({suggestions:suggestions,generations:generations,lastUpdated:lastUpdated,contextual:contextual}){const deserializedSuggestions=[];for(const suggestion of suggestions)deserializedSuggestions.push(await _suggestion_js__WEBPACK_IMPORTED_MODULE_3__.Suggestion.fromLiteral(suggestion,this.envOptions));return!this.isEquivalent(deserializedSuggestions)&&(this._set({suggestions:deserializedSuggestions,generations:JSON.parse(generations||"[]"),lastUpdated:new Date(lastUpdated),contextual:contextual}),!0)}toLiteral(){return{suggestions:this.suggestions.map(suggestion=>suggestion.toLiteral()),generations:JSON.stringify(this.generations),lastUpdated:this.lastUpdated.toString(),contextual:this.contextual}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Suggestion",function(){return Suggestion});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(40),_runtime_manifest_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(41),_runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(80);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class Suggestion{constructor(plan,hash,rank,versionByStore){this.descriptionByModality={},this.versionByStore={},this.searchGroups=[],Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(plan,"plan cannot be null"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(hash,"hash cannot be null"),this.plan=plan,this.planString=this.plan.toString(),this.hash=hash,this.rank=rank,this.versionByStore=versionByStore;for(const store in this.versionByStore)void 0===this.versionByStore[store]&&delete this.versionByStore[store]}static create(plan,hash,relevance){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(plan,"plan cannot be null"),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(hash,"hash cannot be null");const suggestion=new Suggestion(plan,hash,relevance?relevance.calcRelevanceScore():0,relevance?relevance.versionByStore:{});return suggestion.setSearch(plan.search),suggestion}get descriptionText(){return this.getDescription("text")}getDescription(modality){return this.descriptionByModality[modality]}setDescription(description,modality,descriptionFormatter=_runtime_description_formatter_js__WEBPACK_IMPORTED_MODULE_1__.DescriptionFormatter){this.descriptionByModality.text=description.getRecipeSuggestion();for(const planModality of this.plan.modality.names)modality.names.includes(planModality)&&(this.descriptionByModality[planModality]=description.getRecipeSuggestion(descriptionFormatter))}isEquivalent(other){return this.hash===other.hash&&this.descriptionText===other.descriptionText}isEqual(other){return this.isEquivalent(other)&&this.rank===other.rank&&this._isSameSearch(other)&&this._isSameDescription(other)&&this._isSameVersions(other)}_isSameSearch(other){return this.searchGroups.length===other.searchGroups.length&&this.searchGroups.every(search=>other.hasSearchGroup(search))}_isSameDescription(other){return Object.keys(this.descriptionByModality).length===Object.keys(other.descriptionByModality).length&&Object.keys(this.descriptionByModality).every(key=>JSON.stringify(this.descriptionByModality[key])===JSON.stringify(other.descriptionByModality[key]))}_isSameVersions(other){const storeIds=Object.keys(this.versionByStore);return storeIds.length===Object.keys(other.versionByStore).length&&storeIds.every(id=>this.versionByStore[id]===other.versionByStore[id])}static compare(s1,s2){return s2.rank-s1.rank}hasSearch(search){return this.hasSearchGroup(search.split(" "))}hasSearchGroup(tokens){return this.searchGroups.some(group=>tokens.every(token=>group.includes(token)))}setSearch(search){this.searchGroups=[],search&&this._addSearch(search.resolvedTokens)}mergeSearch(suggestion){let updated=!1;0===suggestion.searchGroups.length&&this._addSearch([""]);for(const other of suggestion.searchGroups)this._addSearch(other)&&(1===this.searchGroups.length&&this.searchGroups.push([""]),updated=!0);return this.searchGroups.sort(),updated}_addSearch(searchGroup){return!this.searchGroups.find(group=>((group,otherGroup)=>group.length===otherGroup.length&&group.every(token=>otherGroup.includes(token)))(group,searchGroup))&&(this.searchGroups.push(searchGroup),!0)}toLiteral(){return{plan:this.planString,hash:this.hash,rank:this.rank,versionByStore:JSON.stringify(this.versionByStore),searchGroups:this.searchGroups,descriptionByModality:this.descriptionByModality}}static async fromLiteral({plan:plan,hash:hash,rank:rank,versionByStore:versionByStore,searchGroups:searchGroups,descriptionByModality:descriptionByModality},{context:context,loader:loader}){const manifest=await _runtime_manifest_js__WEBPACK_IMPORTED_MODULE_2__.Manifest.parse(plan,{loader:loader,context:context,fileName:""});Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(1===manifest.recipes.length);const recipe=manifest.recipes[0];Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.normalize({}),`can't normalize deserialized suggestion: ${plan}`);const suggestion=new Suggestion(recipe,hash,rank,JSON.parse(versionByStore||"{}"));return suggestion.searchGroups=searchGroups||[],suggestion.descriptionByModality=descriptionByModality,suggestion}async instantiate(arc){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(arc,"Cannot instantiate suggestion without and arc");const plan=await this.getResolvedPlan(arc);return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(plan&&plan.isResolved(),`can't resolve plan: ${this.plan.toString({showUnresolved:!0})}`),arc.instantiate(plan)}async getResolvedPlan(arc){if(this.plan.isResolved())return this.plan;return new _runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_3__.RecipeResolver(arc).resolve(this.plan)}isUpToDate(arc,plan){const arcVersionByStoreId=arc.getVersionByStore({includeArc:!0,includeContext:!0});return plan.handles.every(handle=>arcVersionByStoreId[handle.id]===this.versionByStore[handle.id])}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"AddMissingHandles",function(){return AddMissingHandles});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class AddMissingHandles extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker{onRecipe(recipe){if(recipe.connectionConstraints.length>0)return;if(recipe.getFreeHandles().length>0)return;const disconnectedConnections=recipe.getFreeConnections();return 0!==disconnectedConnections.length?recipe=>(disconnectedConnections.forEach(({particle:particle,connSpec:connSpec})=>{const handleConnection=recipe.updateToClone({particle:particle}).particle.addConnectionName(connSpec.name),handle=recipe.newHandle();handle.fate="?",handleConnection.connectToHandle(handle)}),0):void 0}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Strategizer",function(){return Strategizer}),__webpack_require__.d(__webpack_exports__,"StrategizerWalker",function(){return StrategizerWalker}),__webpack_require__.d(__webpack_exports__,"Strategy",function(){return Strategy}),__webpack_require__.d(__webpack_exports__,"RulesetBuilder",function(){return RulesetBuilder}),__webpack_require__.d(__webpack_exports__,"Ruleset",function(){return Ruleset});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_recipe_walker_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(81),_runtime_recipe_walker_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(82);class Strategizer{constructor(strategies,evaluators,ruleset){this._generation=0,this._internalPopulation=[],this._population=[],this._generated=[],this._terminal=[],this._strategies=strategies,this._evaluators=evaluators,this._ruleset=ruleset,this.populationHash=new Map}get generation(){return this._generation}get population(){return this._population}get generated(){return this._generated}get terminal(){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this._terminal),this._terminal}async generate(){const generation=this.generation+1,generatedResults=await Promise.all(this._strategies.map(async strategy=>{const recipeFilter=recipe=>this._ruleset.isAllowed(strategy,recipe);return strategy.generate({generation:this.generation,generated:this.generated.filter(recipeFilter),terminal:this.terminal.filter(recipeFilter),population:this.population.filter(recipeFilter)})})),record={generation:generation,sizeOfLastGeneration:this.generated.length,generatedDerivationsByStrategy:{}};for(let i=0;i<this._strategies.length;i++)record.generatedDerivationsByStrategy[this._strategies[i].constructor.name]=generatedResults[i].length;let generated=[].concat(...generatedResults);generated=await Promise.all(generated.map(async result=>(result.hash&&(result.hash=await result.hash),result))),record.generatedDerivations=generated.length,record.nullDerivations=0,record.invalidDerivations=0,record.duplicateDerivations=0,record.duplicateSameParentDerivations=0,record.nullDerivationsByStrategy={},record.invalidDerivationsByStrategy={},record.duplicateDerivationsByStrategy={},record.duplicateSameParentDerivationsByStrategy={},generated=generated.filter(result=>{const strategy=result.derivation[0].strategy.constructor.name;if(result.hash){const existingResult=this.populationHash.get(result.hash);if(existingResult)return result.derivation[0].parent===existingResult?(record.nullDerivations+=1,null==record.nullDerivationsByStrategy[strategy]&&(record.nullDerivationsByStrategy[strategy]=0),record.nullDerivationsByStrategy[strategy]++):-1!==existingResult.derivation.map(a=>a.parent).indexOf(result.derivation[0].parent)?(record.duplicateSameParentDerivations+=1,null==record.duplicateSameParentDerivationsByStrategy[strategy]&&(record.duplicateSameParentDerivationsByStrategy[strategy]=0),record.duplicateSameParentDerivationsByStrategy[strategy]++):(record.duplicateDerivations+=1,null==record.duplicateDerivationsByStrategy[strategy]&&(record.duplicateDerivationsByStrategy[strategy]=0),record.duplicateDerivationsByStrategy[strategy]++,this.populationHash.get(result.hash).derivation.push(result.derivation[0])),!1;this.populationHash.set(result.hash,result)}return!1!==result.valid||(record.invalidDerivations++,record.invalidDerivationsByStrategy[strategy]=(record.invalidDerivationsByStrategy[strategy]||0)+1,!1)});const terminalMap=new Map;for(const candidate of this.generated)terminalMap.set(candidate.result,candidate);for(const result of this.populationHash.values())for(const{parent:parent}of result.derivation)parent&&terminalMap.has(parent.result)&&terminalMap.delete(parent.result);const terminal=[...terminalMap.values()];record.survivingDerivations=generated.length,generated.sort((a,b)=>a.score>b.score?-1:a.score<b.score?1:0);const evaluations=await Promise.all(this._evaluators.map(async strategy=>strategy.evaluate(this,generated))),fitness=Strategizer._mergeEvaluations(evaluations,generated);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(fitness.length===generated.length);for(let i=0;i<fitness.length;i++)this._internalPopulation.push({fitness:fitness[i],individual:generated[i]});return this._internalPopulation.sort((x,y)=>y.fitness-x.fitness),this._terminal=terminal,this._generation=generation,this._generated=generated,this._population=this._internalPopulation.map(x=>x.individual),record}static _mergeEvaluations(evaluations,generated){const n=generated.length,mergedEvaluations=[];for(let i=0;i<n;i++){let merged=NaN;for(const evaluation of evaluations){const fitness=evaluation[i];isNaN(fitness)||(merged=isNaN(merged)?fitness:(merged*i+fitness)/(i+1))}isNaN(merged)&&(merged=.5),mergedEvaluations.push(merged)}return mergedEvaluations}}class StrategizerWalker extends _runtime_recipe_recipe_walker_js__WEBPACK_IMPORTED_MODULE_1__.RecipeWalker{constructor(tactic){super(tactic)}createDescendant(recipe,score){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(this.currentAction instanceof Strategy,"no current strategy"),super.createDescendant(recipe,score)}static over(results,walker,strategy){return super.walk(results,walker,strategy)}}class Strategy extends _runtime_recipe_walker_js__WEBPACK_IMPORTED_MODULE_2__.Action{constructor(arc,args){super(arc,args)}async activate(strategizer){return{generate:0,evaluate:0}}async evaluate(strategizer,individuals){return individuals.map(()=>NaN)}}class RulesetBuilder{constructor(){this._orderingRules=new Map}order(...strategiesOrGroups){for(let i=0;i<strategiesOrGroups.length-1;i++){const current=strategiesOrGroups[i],next=strategiesOrGroups[i+1];for(const strategy of Array.isArray(current)?current:[current]){let set=this._orderingRules.get(strategy);set||this._orderingRules.set(strategy,set=new Set);for(const nextStrategy of Array.isArray(next)?next:[next])set.add(nextStrategy)}}return this}build(){const beingExpanded=new Set,alreadyExpanded=new Set;for(const strategy of this._orderingRules.keys())this._transitiveClosureFor(strategy,beingExpanded,alreadyExpanded);return new Ruleset(this._orderingRules)}_transitiveClosureFor(strategy,beingExpanded,alreadyExpanded){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!beingExpanded.has(strategy),"Detected a loop in the ordering rules");const followingStrategies=this._orderingRules.get(strategy);if(alreadyExpanded.has(strategy))return followingStrategies||new Set;if(followingStrategies){beingExpanded.add(strategy);for(const following of followingStrategies)for(const expanded of this._transitiveClosureFor(following,beingExpanded,alreadyExpanded))followingStrategies.add(expanded);beingExpanded.delete(strategy)}return alreadyExpanded.add(strategy),followingStrategies||new Set}}class Ruleset{constructor(orderingRules){this._orderingRules=orderingRules}isAllowed(strategy,recipe){const forbiddenAncestors=this._orderingRules.get(strategy.constructor);return!forbiddenAncestors||!recipe.derivation.some(d=>forbiddenAncestors.has(d.strategy.constructor))}}Ruleset.Builder=RulesetBuilder},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"AssignHandles",function(){return AssignHandles});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(47),_strategizer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(140);class AssignHandles extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.Strategy{async generate(inputParams){const self=this;return _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker{onHandle(recipe,handle){if(!["?","use","copy","map"].includes(handle.fate))return;if(0===handle.connections.length)return;if(handle.id)return;if(!handle.type)return;const counts=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__.RecipeUtil.directionCounts(handle);if(counts.unknown>0)return;const score=this._getScore(counts,handle.tags);if(counts.out>0&&"map"===handle.fate)return;const stores=self.getMappableStores(handle.fate,handle.type,handle.tags,counts);return"?"!==handle.fate&&stores.size<2?void 0:[...stores.keys()].map(store=>(recipe,clonedHandle)=>(Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(store.id),recipe.findHandleByID(store.id)?0:(clonedHandle.mapToStorage(store),"?"===clonedHandle.fate?clonedHandle.fate=stores.get(store):Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(clonedHandle.fate,stores.get(store)),score)))}_getScore(counts,tags){let score=-1;return 0!==counts.in&&0!==counts.out||(score=0===counts.out?1:0),tags.length>0&&(score+=4),score}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.Permuted),this)}getMappableStores(fate,type,tags,counts){const stores=new Map;return"use"!==fate&&"?"!==fate||this.arc.findStoresByType(type,{tags:tags}).forEach(store=>stores.set(store,"use")),"map"!==fate&&"copy"!==fate&&"?"!==fate||this.arc.context.findStoresByType(type,{tags:tags,subtype:!0}).forEach(store=>stores.set(store,"?"===fate?counts.out>0?"copy":"map":fate)),stores}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"CoalesceRecipes",function(){return CoalesceRecipes});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(46),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(47),_runtime_type_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(18),_strategizer_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(140);class CoalesceRecipes extends _strategizer_js__WEBPACK_IMPORTED_MODULE_4__.Strategy{constructor(arc,{recipeIndex:recipeIndex}){super(arc),this.recipeIndex=recipeIndex}getResults(inputParams){return inputParams.terminal.filter(result=>!result.result.isResolved()||0===result.result.slots.length)}async generate(inputParams){const arc=this.arc,index=this.recipeIndex;return await index.ready,_strategizer_js__WEBPACK_IMPORTED_MODULE_4__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_4__.StrategizerWalker{onPotentialSlotConnection(recipe,particle,slotSpec){const results=[];for(const providedSlot of index.findProvidedSlot(particle,slotSpec))recipe.particles.length+providedSlot.recipe.particles.length>10||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(arc.activeRecipe,providedSlot.recipe)||results.push((recipe,particle,slotSpec)=>{const otherToHandle=index.findCoalescableHandles(recipe,providedSlot.recipe),{cloneMap:cloneMap}=providedSlot.recipe.mergeInto(recipe),mergedSlot=cloneMap.get(providedSlot);return particle.addSlotConnection(slotSpec.name).connectToSlot(mergedSlot),this._connectOtherHandles(otherToHandle,cloneMap,!1),recipe.verbs.splice(0),recipe.name=null,1});if(results.length>0)return results}onSlotConnection(recipe,slotConnection){if(slotConnection.isResolved())return;if(!slotConnection.name||!slotConnection.particle)return;if(slotConnection.targetSlot)return;const results=[];for(const providedSlot of index.findProvidedSlot(slotConnection.particle,slotConnection.spec))recipe.particles.length+providedSlot.recipe.particles.length>10||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(arc.activeRecipe,providedSlot.recipe)||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(recipe,providedSlot.recipe)||results.push((recipe,slotConnection)=>{const otherToHandle=index.findCoalescableHandles(recipe,providedSlot.recipe),{cloneMap:cloneMap}=providedSlot.recipe.mergeInto(slotConnection.recipe),mergedSlot=cloneMap.get(providedSlot);return slotConnection.connectToSlot(mergedSlot),this._connectOtherHandles(otherToHandle,cloneMap,!1),recipe.verbs.splice(0),recipe.name=null,1});return results.length>0?results:void 0}onSlot(recipe,slot){if(slot.consumeConnections.length>0)return;if(!slot.sourceConnection||!slot.spec.isRequired)return;const results=[];for(const{recipeParticle:recipeParticle,slotSpec:slotSpec,matchingHandles:matchingHandles}of index.findConsumeSlotConnectionMatch(slot.sourceConnection.particle,slot.spec))recipe.particles.length+recipeParticle.recipe.particles.length>10||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(arc.activeRecipe,recipeParticle.recipe)||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(recipe,recipeParticle.recipe)||results.push((recipe,slot)=>{const otherToHandle=index.findCoalescableHandles(recipe,recipeParticle.recipe,new Set(slot.handles.concat(matchingHandles.map(({handle:handle,matchingConn:matchingConn})=>matchingConn.handle)))),{cloneMap:cloneMap}=recipeParticle.recipe.mergeInto(slot.recipe),slotConn=recipeParticle.getSlotConnectionByName(slot.name);let mergedSlotConn=cloneMap.get(slotConn);if(!mergedSlotConn){mergedSlotConn=cloneMap.get(recipeParticle).addSlotConnection(slotSpec.name)}mergedSlotConn.connectToSlot(slot);for(const{handle:handle,matchingConn:matchingConn}of matchingHandles){const disconnectedHandle=cloneMap.get(matchingConn).handle,clonedHandle=slot.findHandleByID(handle.id);if(disconnectedHandle!==clonedHandle){for(;disconnectedHandle.connections.length>0;){const conn=disconnectedHandle.connections[0];conn.disconnectHandle(),conn.connectToHandle(clonedHandle)}recipe.removeHandle(disconnectedHandle)}}return this._connectOtherHandles(otherToHandle,cloneMap,!1),recipe.verbs.splice(0),recipe.name=null,1});return results.length>0?results:void 0}onHandle(recipe,handle){if(!index.coalescableFates.includes(handle.fate)||handle.id||0===handle.connections.length||"descriptions"===handle.name)return;const results=[];for(const otherHandle of index.findHandleMatch(handle,index.coalescableFates))if(!(recipe.particles.length+otherHandle.recipe.particles.length>10||otherHandle.findConnectionByDirection("in"))){if(otherHandle.type.hasVariable){let resolved=otherHandle.type.resolvedType();if((resolved=resolved.getContainedType()||resolved)instanceof _runtime_type_js__WEBPACK_IMPORTED_MODULE_3__.TypeVariable&&!resolved.canReadSubset)continue}_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(arc.activeRecipe,otherHandle.recipe)||_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_2__.RecipeUtil.matchesRecipe(recipe,otherHandle.recipe)||results.push((recipe,handle)=>{const otherToHandle=index.findCoalescableHandles(recipe,otherHandle.recipe,new Set([handle,otherHandle])),{cloneMap:cloneMap}=otherHandle.recipe.mergeInto(handle.recipe);return cloneMap.get(otherHandle).mergeInto(handle),this._connectOtherHandles(otherToHandle,cloneMap,!0),recipe.verbs.splice(0),recipe.name=null,1})}return results}_connectOtherHandles(otherToHandle,cloneMap,verifyTypes){otherToHandle.forEach((otherHandle,handle)=>{const otherHandleClone=cloneMap.get(otherHandle);verifyTypes&&!this._reverifyHandleTypes(handle,otherHandleClone)||otherHandleClone.mergeInto(handle)})}_reverifyHandleTypes(handle,otherHandle){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handle.recipe===otherHandle.recipe);const cloneMap=new Map;return handle.recipe.clone(cloneMap).normalize(),_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_1__.Handle.effectiveType(cloneMap.get(handle).type,[...cloneMap.get(handle).connections,...cloneMap.get(otherHandle).connections])}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_4__.StrategizerWalker.Independent),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ConvertConstraintsToConnections",function(){return ConvertConstraintsToConnections});var _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(45),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(47),_strategizer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(140);class ConvertConstraintsToConnections extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.Strategy{async generate(inputParams){const arcModality=this.arc.modality;return _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker{onRecipe(recipe){if(0===recipe.connectionConstraints.length)return;const modality=arcModality.intersection(recipe.modality),particles=new Set,handleNames=new Map,handles=new Set,map={},particlesByName={};let handleNameIndex=0;function nameForHandle(handle,existingNames){if(existingNames.has(handle))return existingNames.get(handle);if(handle.localName&&!handles.has(handle.localName))return existingNames.set(handle,handle.localName),handle.localName;for(;!handles.has("handle"+handleNameIndex);)handleNameIndex++;return existingNames.set(handle,"handle"+handleNameIndex),"handle"+handleNameIndex++}let handleCount=0;const obligations=[];for(const constraint of recipe.connectionConstraints){const from=constraint.from,to=constraint.to;if(from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint&&to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint&&(!from.particle.isCompatible(modality)||!to.particle.isCompatible(modality)))return;const reverse={"->":"<-","=":"=","<-":"->"};let handle,handleIsConcrete=!1,createObligation=!1;from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint&&(particles.add(from.particle.name),null==map[from.particle.name]&&(map[from.particle.name]={},particlesByName[from.particle.name]=from.particle),from.connection?(handleIsConcrete=!0,handle=map[from.particle.name][from.connection]):createObligation=!0),from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.HandleEndPoint&&(handle={handle:nameForHandle(from.handle,handleNames),direction:reverse[constraint.direction],localName:from.handle.localName},handles.add(handle.handle)),to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint&&(particles.add(to.particle.name),null==map[to.particle.name]&&(map[to.particle.name]={},particlesByName[to.particle.name]=to.particle),to.connection?(handleIsConcrete=!0,handle||(handle=map[to.particle.name][to.connection])):createObligation=!0),to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.HandleEndPoint&&(handle={handle:nameForHandle(to.handle,handleNames),direction:constraint.direction,localName:to.handle.localName},handles.add(handle.handle)),null==handle&&(handle={handle:"v"+handleCount++,direction:constraint.direction},handleIsConcrete&&handles.add(handle.handle)),from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.TagEndPoint?handle.tags=from.tags:to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.TagEndPoint&&(handle.tags=to.tags),createObligation&&obligations.push({from:from._clone(),to:to._clone(),direction:constraint.direction});const unionDirections=(a,b)=>"="===a?"=":"="===b?"=":a!==b?"=":a;let direction=constraint.direction;if(from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint){const connection=from.connection;if(connection){const existingHandle=map[from.particle.name][connection];if(existingHandle&&null==(direction=unionDirections(direction,existingHandle.direction)))return;map[from.particle.name][connection]={handle:handle.handle,direction:direction,tags:handle.tags,localName:handle.localName}}}if(direction=reverse[constraint.direction],to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint){const connection=to.connection;if(connection){const existingHandle=map[to.particle.name][connection];if(existingHandle&&null==(direction=unionDirections(direction,existingHandle.direction)))return;map[to.particle.name][connection]={handle:handle.handle,direction:direction,tags:handle.tags,localName:handle.localName}}}}const shape=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__.RecipeUtil.makeShape([...particles.values()],[...handles.values()],map);return _runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__.RecipeUtil.find(recipe,shape).filter(match=>{const resolvedHandles={};for(const particle of Object.keys(map))for(const connection of Object.keys(map[particle])){const handle=map[particle][connection].handle;if(!resolvedHandles[handle])if(match.match[handle])resolvedHandles[handle]=!0;else{const spec=particlesByName[particle];resolvedHandles[handle]=spec.isOutput(connection)}}return Object.values(resolvedHandles).every(value=>value)}).map(match=>recipe=>{const score=recipe.connectionConstraints.length+match.score,recipeMap=recipe.updateToClone(match.match);for(const particle of Object.keys(map)){let recipeParticle=recipeMap[particle];recipeParticle||((recipeParticle=recipe.newParticle(particle)).spec=particlesByName[particle],recipeMap[particle]=recipeParticle);for(const connection of Object.keys(map[particle])){const handle=map[particle][connection];let recipeHandleConnection=recipeParticle.connections[connection];null==recipeHandleConnection&&(recipeHandleConnection=recipeParticle.addConnectionName(connection));let recipeHandle=recipeMap[handle.handle];null==recipeHandle&&null==recipeHandleConnection.handle&&((recipeHandle=recipe.newHandle()).fate="create",recipeHandle.tags=handle.tags||[],recipeMap[handle.handle]=recipeHandle),null==recipeHandleConnection.handle&&recipeHandleConnection.connectToHandle(recipeHandle)}}recipe.clearConnectionConstraints();for(const obligation of obligations){if(!(obligation.from instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint&&obligation.to instanceof _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.ParticleEndPoint))throw new Error("constraints with a particle endpoint at one end but not at the other are not supported");{const from=new _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.InstanceEndPoint(recipeMap[obligation.from.particle.name],obligation.from.connection),to=new _runtime_recipe_connection_constraint_js__WEBPACK_IMPORTED_MODULE_0__.InstanceEndPoint(recipeMap[obligation.to.particle.name],obligation.to.connection);recipe.newObligation(from,to,obligation.direction)}}return score})}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.Independent),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"CreateDescriptionHandle",function(){return CreateDescriptionHandle});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class CreateDescriptionHandle extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker{onHandleConnection(recipe,handleConnection){if(!handleConnection.handle&&"descriptions"===handleConnection.name)return(recipe,handleConnection)=>this._createAndConnectHandle(handleConnection)}onPotentialHandleConnection(recipe,particle,connectionSpec){if("descriptions"===connectionSpec.name)return(recipe,particle,connectionSpec)=>this._createAndConnectHandle(particle.addConnectionName(connectionSpec.name))}_createAndConnectHandle(handleConnection){const handle=handleConnection.recipe.newHandle();return handle.fate="create",handleConnection.connectToHandle(handle),1}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"CreateHandleGroup",function(){return CreateHandleGroup});var _runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(46),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class CreateHandleGroup extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker{onRecipe(recipe){if(recipe.connectionConstraints.length>0)return;const freeConnections=recipe.getFreeConnections();let maximalGroup=null;for(const writer of freeConnections.filter(({connSpec:connSpec})=>connSpec.isOutput)){const compatibleConnections=[writer];let effectiveType=_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_0__.Handle.effectiveType(null,compatibleConnections.map(cc=>cc.connSpec)),typeCandidate=null;const involvedParticles=new Set([writer.particle]);let foundSomeReader=!1;for(const reader of freeConnections.filter(({connSpec:connSpec})=>connSpec.isInput))involvedParticles.has(reader.particle)||null===(typeCandidate=_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_0__.Handle.effectiveType(effectiveType,[reader.connSpec]))||(compatibleConnections.push(reader),involvedParticles.add(reader.particle),effectiveType=typeCandidate,foundSomeReader=!0);if(foundSomeReader){for(const otherWriter of freeConnections.filter(({connSpec:connSpec})=>connSpec.isOutput))involvedParticles.has(otherWriter.particle)||null===(typeCandidate=_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_0__.Handle.effectiveType(effectiveType,[otherWriter.connSpec]))||(compatibleConnections.push(otherWriter),involvedParticles.add(otherWriter.particle),effectiveType=typeCandidate);(!maximalGroup||compatibleConnections.length>maximalGroup.length)&&(maximalGroup=compatibleConnections)}}return maximalGroup?recipe=>{const newHandle=recipe.newHandle();newHandle.fate="create";for(const{particle:particle,connSpec:connSpec}of maximalGroup){recipe.updateToClone({particle:particle}).particle.addConnectionName(connSpec.name).connectToHandle(newHandle)}return 0}:void 0}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.Independent),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"FindHostedParticle",function(){return FindHostedParticle});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(47),_runtime_type_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(18),_strategizer_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(140);class FindHostedParticle extends _strategizer_js__WEBPACK_IMPORTED_MODULE_3__.Strategy{async generate(inputParams){const arc=this.arc;return _strategizer_js__WEBPACK_IMPORTED_MODULE_3__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_3__.StrategizerWalker{onPotentialHandleConnection(recipe,particle,connectionSpec){const matchingParticleSpecs=this._findMatchingParticleSpecs(arc,connectionSpec,connectionSpec.type);if(!matchingParticleSpecs)return;const results=[];for(const particleSpec of matchingParticleSpecs)results.push((recipe,particle,connectionSpec)=>{const handleConnection=particle.addConnectionName(connectionSpec.name),handle=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_1__.RecipeUtil.constructImmediateValueHandle(handleConnection,particleSpec,arc.generateID());Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(handle),handleConnection.connectToHandle(handle)});return results}_findMatchingParticleSpecs(arc,connectionSpec,connectionType){if(!connectionSpec)return;if("host"!==connectionSpec.direction)return;Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(connectionType instanceof _runtime_type_js__WEBPACK_IMPORTED_MODULE_2__.InterfaceType);const iface=connectionType,particles=[];for(const particle of arc.context.allParticles){const ifaceClone=iface.interfaceInfo.cloneWithResolutions(new Map);!1!==ifaceClone.restrictType(particle)&&(ifaceClone.canEnsureResolved()&&particles.push(particle))}return particles}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_3__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"FindRequiredParticle",function(){return FindRequiredParticle});var _runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(83),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class FindRequiredParticle extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{async generate(inputParams){const arc=this.arc;return _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker{onRequiredParticle(recipe,particle){return arc.activeRecipe.particles.filter(arcParticle=>particle.matches(arcParticle)).map(particleMatch=>(recipe,particle)=>{if(particle.matches(particleMatch)){for(const[name,slotConn]of Object.entries(particle.consumedSlotConnections)){const oldSlot=slotConn.targetSlot,newSlot=particleMatch.consumedSlotConnections[name].targetSlot;if(!_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.replaceOldSlot(recipe,oldSlot,newSlot))return;for(const[pname,oldPSlot]of Object.entries(slotConn.providedSlots)){const pslot=particleMatch.consumedSlotConnections[name].providedSlots[pname];if(!_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.replaceOldSlot(recipe,oldPSlot,pslot))return}for(const requires of recipe.requires)-1!==requires.particles.indexOf(particle)&&requires.removeParticle(particle)}return 0}})}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"GroupHandleConnections",function(){return GroupHandleConnections});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(20),_strategizer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(140);class GroupHandleConnections extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.Strategy{constructor(arc,args){super(arc,args),this._walker=new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker{onRecipe(recipe){if(recipe.getUnnamedUntypedConnections())return;if(recipe.particles.some(p=>!p.spec))return;const types=new Set;recipe.getFreeConnections().forEach(({connSpec:connSpec})=>{Array.from(types).find(type=>_runtime_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:type},{type:connSpec.type}))||types.add(connSpec.type)});const groupsByType=new Map;for(const type of types){const sortedParticles=[...recipe.particles].sort((p1,p2)=>p2.getUnboundConnections(type).length-p1.getUnboundConnections(type).length).filter(p=>p.getUnboundConnections(type).length>0);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(sortedParticles.length>0);const particleWithMostConnectionsOfType=sortedParticles[0],groups=[];let allTypeHandleConnections=recipe.getFreeConnections(type).filter(c=>c.particle!==particleWithMostConnectionsOfType),iteration=0;for(;allTypeHandleConnections.length>0;){for(const connSpec of particleWithMostConnectionsOfType.spec.handleConnections){if(!_runtime_recipe_type_checker_js__WEBPACK_IMPORTED_MODULE_1__.TypeChecker.compareTypes({type:type},{type:connSpec.type}))continue;groups.find(g=>g.particle===particleWithMostConnectionsOfType&&g.connSpec===connSpec)||groups.push({particle:particleWithMostConnectionsOfType,connSpec:connSpec,group:[]});const group=groups.find(g=>g.particle===particleWithMostConnectionsOfType&&g.connSpec===connSpec).group,possibleConnections=allTypeHandleConnections.filter(c=>!group.find(gc=>gc.particle===c.particle));let selectedConn=possibleConnections.find(({connSpec:connSpec})=>connSpec.isInput!=connSpec.isInput||connSpec.isOutput!=connSpec.isOutput);if(!selectedConn){if(0===possibleConnections.length||0===iteration)continue;selectedConn=possibleConnections[0]}group.push(selectedConn),allTypeHandleConnections=allTypeHandleConnections.filter(({connSpec:connSpec})=>connSpec!==selectedConn.connSpec)}iteration++}for(let i=0;i<groups.length;++i)0===groups[i].group.length?groups.splice(i,1):groups[i].group.push({particle:groups[i].particle,connSpec:groups[i].connSpec});0!==groups.length&&groupsByType.set(type,groups)}return groupsByType.size>0?recipe=>(groupsByType.forEach((groups,type)=>{groups.forEach(({group:group})=>{const recipeHandle=recipe.newHandle();for(const{particle:particle,connSpec:connSpec}of group){const particleClone=recipe.updateToClone({particle:particle}).particle;particleClone.connections[connSpec.name]||particleClone.addConnectionName(connSpec.name),particleClone.connections[connSpec.name].connectToHandle(recipeHandle)}})}),0):void 0}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.Permuted)}get walker(){return this._walker}async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.over(this.getResults(inputParams),this.walker,this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"InitPopulation",function(){return InitPopulation});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class InitPopulation extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{constructor(arc,{contextual:contextual=!1,recipeIndex:recipeIndex}){super(arc,{contextual:contextual}),this._contextual=contextual,this._recipeIndex=recipeIndex,this._loadedParticles=new Set(this.arc.loadedParticleSpecs().map(spec=>spec.implFile))}async generate({generation:generation}){if(0!==generation)return[];return await this._recipeIndex.ready,(this._contextual?this._contextualResults():this._allResults()).map(({recipe:recipe,score:score=1})=>({result:recipe,score:score,derivation:[{strategy:this,parent:void 0}],hash:recipe.digest(),valid:Object.isFrozen(recipe)}))}_contextualResults(){const results=[];for(const particle of this.arc.activeRecipe.particles)for(const[name,slotSpec]of particle.spec.slotConnections)for(const providedSlotSpec of slotSpec.provideSlotConnections)results.push(...this._recipeIndex.findConsumeSlotConnectionMatch(particle,providedSlotSpec).map(({recipeParticle:recipeParticle})=>({recipe:recipeParticle.recipe})));for(const handle of[].concat(...this.arc.allDescendingArcs.map(arc=>arc.activeRecipe.handles)))results.push(...this._recipeIndex.findHandleMatch(handle,["use","?"]).map(otherHandle=>({recipe:otherHandle.recipe})));return results}_allResults(){return this._recipeIndex.recipes.map(recipe=>({recipe:recipe,score:1-recipe.getParticlesByImplFile(this._loadedParticles).length}))}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"InitSearch",function(){return InitSearch});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_recipe_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(48),_strategizer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(140);class InitSearch extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.Strategy{constructor(arc,{search:search}){super(arc,{search:search}),this._search=search}async generate({generation:generation}){if(null==this._search||0!==generation)return[];const recipe=new _runtime_recipe_recipe_js__WEBPACK_IMPORTED_MODULE_1__.Recipe;return recipe.setSearchPhrase(this._search),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(recipe.normalize()),Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(!recipe.isResolved()),[{result:recipe,score:0,derivation:[{strategy:this,parent:void 0}],hash:recipe.digest(),valid:!0}]}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MapSlots",function(){return MapSlots});var _runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(83),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class MapSlots extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{async generate(inputParams){const arc=this.arc;return _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker{onPotentialSlotConnection(recipe,particle,slotSpec){const{local:local,remote:remote}=_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.findAllSlotCandidates(particle,slotSpec,arc);if(!(local.length+remote.length<2))return(local.length>0?local:remote).map(slot=>(recipe,particle,slotSpec)=>{const newSlotConnection=particle.addSlotConnection(slotSpec.name);return _runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.connectSlotConnection(newSlotConnection,slot),1})}onSlotConnection(recipe,slotConnection){if(null==slotConnection.getSlotSpec())return;if(slotConnection.isConnected())return;const slotSpec=slotConnection.getSlotSpec(),particle=slotConnection.particle,{local:local,remote:remote}=_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.findAllSlotCandidates(particle,slotSpec,arc);return local.length+remote.length<2?void 0:(local.length>0?local:remote).map(slot=>(recipe,slotConnection)=>(_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_0__.SlotUtils.connectSlotConnection(slotConnection,slot),1))}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MatchFreeHandlesToConnections",function(){return MatchFreeHandlesToConnections});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class MatchFreeHandlesToConnections extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker{onHandle(recipe,handle){if(handle.connections.length>0)return;return recipe.getFreeConnections().map(({particle:particle,connSpec:connSpec})=>(recipe,handle)=>{return recipe.updateToClone({particle:particle}).particle.addConnectionName(connSpec.name).connectToHandle(handle),1})}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MatchParticleByVerb",function(){return MatchParticleByVerb});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class MatchParticleByVerb extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{async generate(inputParams){const arc=this.arc;return _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker{onParticle(recipe,particle){if(particle.name)return;const modality=arc.modality.intersection(recipe.modality);return arc.context.findParticlesByVerb(particle.primaryVerb).filter(spec=>spec.isCompatible(modality)).map(spec=>(recipe,particle)=>{return particle.name=spec.name,particle.spec=spec,1})}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MatchRecipeByVerb",function(){return MatchRecipeByVerb});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(46),_strategizer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(140);class MatchRecipeByVerb extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.Strategy{async generate(inputParams){const arc=this.arc;return _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker{onParticle(recipe,particle){if(particle.name)return;let recipes=arc.context.findRecipesByVerb(particle.primaryVerb);const slotConstraints={};for(const consumeSlot of Object.values(particle.consumedSlotConnections)){const targetSlot=consumeSlot.targetSlot&&consumeSlot.targetSlot.sourceConnection?consumeSlot.targetSlot:null;slotConstraints[consumeSlot.name]={targetSlot:targetSlot,providedSlots:{}};for(const providedSlot of Object.keys(consumeSlot.providedSlots)){const sourceSlot=consumeSlot.providedSlots[providedSlot].consumeConnections.length>0?consumeSlot.providedSlots[providedSlot]:null;slotConstraints[consumeSlot.name].providedSlots[providedSlot]=sourceSlot}}const handleConstraints={named:{},unnamed:[]};for(const handleConnection of Object.values(particle.connections))handleConstraints.named[handleConnection.name]={direction:handleConnection.direction,handle:handleConnection.handle};for(const unnamedConnection of particle.unnamedConnections)handleConstraints.unnamed.push({direction:unnamedConnection.direction,handle:unnamedConnection.handle});return(recipes=recipes.filter(recipe=>MatchRecipeByVerb.satisfiesSlotConstraints(recipe,slotConstraints)).filter(recipe=>MatchRecipeByVerb.satisfiesHandleConstraints(recipe,handleConstraints))).map(recipe=>(outputRecipe,particleForReplacing)=>{const{handles:handles,particles:particles,slots:slots}=recipe.mergeInto(outputRecipe);particleForReplacing.remove();for(const consumeSlot in slotConstraints)if(slotConstraints[consumeSlot].targetSlot||Object.values(slotConstraints[consumeSlot].providedSlots).filter(a=>null!=a).length>0){let slotMapped=!1;for(const particle of particles)if(MatchRecipeByVerb.slotsMatchConstraint(particle,particle.getSlotSpecs(),consumeSlot,slotConstraints[consumeSlot].providedSlots)){if(slotConstraints[consumeSlot].targetSlot){const{mappedSlot:mappedSlot}=outputRecipe.updateToClone({mappedSlot:slotConstraints[consumeSlot].targetSlot});null==particle.consumedSlotConnections[consumeSlot]&&particle.addSlotConnection(consumeSlot),particle.consumedSlotConnections[consumeSlot].targetSlot=mappedSlot,mappedSlot.consumeConnections.push(particle.consumedSlotConnections[consumeSlot])}for(const slotName of Object.keys(slotConstraints[consumeSlot].providedSlots)){const slot=slotConstraints[consumeSlot].providedSlots[slotName];if(null==slot)continue;const{mappedSlot:mappedSlot}=outputRecipe.updateToClone({mappedSlot:slot});null==particle.consumedSlotConnections[consumeSlot]&&particle.addSlotConnection(consumeSlot),particle.consumedSlotConnections[consumeSlot].providedSlots[slotName].remove(),particle.consumedSlotConnections[consumeSlot].providedSlots[slotName]=mappedSlot,mappedSlot._sourceConnection=particle.consumedSlotConnections[consumeSlot]}slotMapped=!0;break}Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(slotMapped)}function tryApplyHandleConstraint(name,connSpec,particle,constraint,handle){let connection=particle.connections[name];if(connection&&null!=connection.handle)return!1;if(!MatchRecipeByVerb.connectionMatchesConstraint(connection||connSpec,constraint))return!1;connection=connection||particle.addConnectionName(connSpec.name);for(let i=0;i<handle.connections.length;i++){const candidate=handle.connections[i];if(candidate.particle===particleForReplacing&&candidate.name==name)return connection._handle=handle,handle.connections[i]=connection,!0}return!1}function applyHandleConstraint(name,constraint,handle){const{mappedHandle:mappedHandle}=outputRecipe.updateToClone({mappedHandle:handle});for(const particle of particles)if(name){if(tryApplyHandleConstraint(name,particle.spec.getConnectionByName(name),particle,constraint,mappedHandle))return!0}else for(const connSpec of particle.spec.handleConnections)if(tryApplyHandleConstraint(name,connSpec,particle,constraint,mappedHandle))return!0;return!1}for(const name in handleConstraints.named)handleConstraints.named[name].handle&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(applyHandleConstraint(name,handleConstraints.named[name],handleConstraints.named[name].handle));for(const connection of handleConstraints.unnamed)connection.handle&&Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(applyHandleConstraint(null,connection,connection.handle));return 1})}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_2__.StrategizerWalker.Permuted),this)}static satisfiesHandleConstraints(recipe,handleConstraints){for(const handleName in handleConstraints.named)if(!MatchRecipeByVerb.satisfiesHandleConnection(recipe,handleName,handleConstraints.named[handleName]))return!1;for(const handleData of handleConstraints.unnamed)if(!MatchRecipeByVerb.satisfiesUnnamedHandleConnection(recipe,handleData))return!1;return!0}static satisfiesUnnamedHandleConnection(recipe,handleData){if(!handleData.handle)return!1;for(const particle of recipe.particles){for(const connection of Object.values(particle.connections))if(MatchRecipeByVerb.connectionMatchesConstraint(connection,handleData))return!0;if(particle.spec)for(const connectionSpec of particle.spec.handleConnections)if(MatchRecipeByVerb.connectionSpecMatchesConstraint(connectionSpec,handleData))return!0}return!1}static satisfiesHandleConnection(recipe,handleName,handleData){for(const particle of recipe.particles)if(particle.connections[handleName]){if(MatchRecipeByVerb.connectionMatchesConstraint(particle.connections[handleName],handleData))return!0}else if(particle.spec&&particle.spec.getConnectionByName(handleName)&&MatchRecipeByVerb.connectionSpecMatchesConstraint(particle.spec.getConnectionByName(handleName),handleData))return!0;return!1}static connectionSpecMatchesConstraint(connSpec,handleData){return connSpec.direction===handleData.direction}static connectionMatchesConstraint(connection,handleData){return connection.direction===handleData.direction&&(!handleData.handle||null!=_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_1__.Handle.effectiveType(handleData.handle._mappedType,handleData.handle.connections.concat(connection)))}static satisfiesSlotConstraints(recipe,slotConstraints){for(const slotName in slotConstraints)if(!MatchRecipeByVerb.satisfiesSlotConnection(recipe,slotName,slotConstraints[slotName]))return!1;return!0}static satisfiesSlotConnection(recipe,slotName,constraints){for(const particle of recipe.particles)if(particle.spec&&MatchRecipeByVerb.slotsMatchConstraint(particle,particle.getSlotSpecs(),slotName,constraints))return!0;return!1}static slotsMatchConstraint(particle,slotSpecs,name,constraints){if(null==slotSpecs.get(name))return!1;const slotConn=particle.getSlotConnectionBySpec(slotSpecs.get(name));if(slotConn&&null!=slotConn.targetSlot&&null!=constraints.targetSlot)return!1;for(const provideName in constraints.providedSlots)if(void 0===slotSpecs.get(name).provideSlotConnections.find(spec=>spec.name===provideName))return!1;return!0}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"NameUnnamedConnections",function(){return NameUnnamedConnections});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140);class NameUnnamedConnections extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker{onHandleConnection(recipe,handleConnection){if(handleConnection.name)return;if(!handleConnection.particle.spec)return;return handleConnection.findSpecsForUnnamedHandles().map(specConn=>(recipe,handleConnection)=>(handleConnection.particle.nameConnection(handleConnection,specConn.name),1))}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ResolveRecipe",function(){return ResolveRecipe});var _runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(80),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class ResolveRecipe extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{async generate(inputParams){return _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),new _runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_0__.ResolveWalker(_runtime_recipe_recipe_resolver_js__WEBPACK_IMPORTED_MODULE_0__.ResolveWalker.Permuted,this.arc),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Empty",function(){return Empty}),__webpack_require__.d(__webpack_exports__,"ExperimentalPhased",function(){return ExperimentalPhased}),__webpack_require__.d(__webpack_exports__,"ExperimentalLinear",function(){return ExperimentalLinear});var _strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140),_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(139),_assign_handles_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(141),_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(143),_create_description_handle_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(144),_group_handle_connections_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(148),_init_population_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(149),_init_search_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(150),_map_slots_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(151),_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(152),_match_particle_by_verb_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(153),_match_recipe_by_verb_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(154),_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(156),_search_tokens_to_particles_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(158);const Empty=(new _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Ruleset.Builder).build(),ExperimentalPhased=(new _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Ruleset.Builder).order([_init_population_js__WEBPACK_IMPORTED_MODULE_6__.InitPopulation,_init_search_js__WEBPACK_IMPORTED_MODULE_7__.InitSearch],_search_tokens_to_particles_js__WEBPACK_IMPORTED_MODULE_13__.SearchTokensToParticles,[_match_recipe_by_verb_js__WEBPACK_IMPORTED_MODULE_11__.MatchRecipeByVerb,_match_particle_by_verb_js__WEBPACK_IMPORTED_MODULE_10__.MatchParticleByVerb],_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_3__.ConvertConstraintsToConnections,_group_handle_connections_js__WEBPACK_IMPORTED_MODULE_5__.GroupHandleConnections,[_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_1__.AddMissingHandles,_assign_handles_js__WEBPACK_IMPORTED_MODULE_2__.AssignHandles,_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_9__.MatchFreeHandlesToConnections],_map_slots_js__WEBPACK_IMPORTED_MODULE_8__.MapSlots,_create_description_handle_js__WEBPACK_IMPORTED_MODULE_4__.CreateDescriptionHandle,_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_12__.ResolveRecipe).build(),ExperimentalLinear=(new _strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Ruleset.Builder).order(_init_population_js__WEBPACK_IMPORTED_MODULE_6__.InitPopulation,_init_search_js__WEBPACK_IMPORTED_MODULE_7__.InitSearch,_search_tokens_to_particles_js__WEBPACK_IMPORTED_MODULE_13__.SearchTokensToParticles,_match_recipe_by_verb_js__WEBPACK_IMPORTED_MODULE_11__.MatchRecipeByVerb,_match_particle_by_verb_js__WEBPACK_IMPORTED_MODULE_10__.MatchParticleByVerb,_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_3__.ConvertConstraintsToConnections,_group_handle_connections_js__WEBPACK_IMPORTED_MODULE_5__.GroupHandleConnections,_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_9__.MatchFreeHandlesToConnections,_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_1__.AddMissingHandles,_assign_handles_js__WEBPACK_IMPORTED_MODULE_2__.AssignHandles,_map_slots_js__WEBPACK_IMPORTED_MODULE_8__.MapSlots,_create_description_handle_js__WEBPACK_IMPORTED_MODULE_4__.CreateDescriptionHandle,_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_12__.ResolveRecipe).build()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SearchTokensToParticles",function(){return SearchTokensToParticles});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class SearchTokensToParticles extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{constructor(arc,options){super(arc,options);const thingByToken={},thingByPhrase={};arc.context.allParticles.forEach(p=>{this._addThing(p.name,{spec:p},thingByToken,thingByPhrase),p.verbs.forEach(verb=>this._addThing(verb,{spec:p},thingByToken,thingByPhrase))}),arc.context.allRecipes.forEach(r=>{const packaged={innerRecipe:r};this._addThing(r.name,packaged,thingByToken,thingByPhrase),r.verbs.forEach(verb=>this._addThing(verb,packaged,thingByToken,thingByPhrase))});this._walker=new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker{constructor(tactic,arc,recipeIndex){super(tactic),this.recipeIndex=recipeIndex}onRecipe(recipe){if(!recipe.search||!recipe.search.unresolvedTokens.length)return;const byToken={},resolvedTokens=new Set,_addThingsByToken=(token,things)=>{things.forEach(thing=>{byToken[token]=byToken[token]||[],byToken[token].push(thing),token.split(" ").forEach(t=>resolvedTokens.add(t))})};for(const[phrase,things]of Object.entries(thingByPhrase))phrase.split(" ").every(token=>recipe.search.unresolvedTokens.includes(token))&&recipe.search.phrase.includes(phrase)&&_addThingsByToken(phrase,things);for(const token of recipe.search.unresolvedTokens){if(resolvedTokens.has(token))continue;const things=thingByToken[token];things&&_addThingsByToken(token,things)}if(0===resolvedTokens.size)return;const flatten=arr=>[].concat(...arr);return((...sets)=>sets.reduce((acc,set)=>flatten(acc.map(x=>set.map(y=>[...x,y]))),[[]]))(...Object.values(byToken).map(v=>flatten(v))).map(combination=>recipe=>(resolvedTokens.forEach(token=>recipe.search.resolveToken(token)),combination.forEach(({spec:spec,innerRecipe:innerRecipe})=>{if(spec)recipe.newParticle(spec.name).spec=spec;else{const otherToHandle=this.recipeIndex.findCoalescableHandles(recipe,innerRecipe);Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(innerRecipe);const{cloneMap:cloneMap}=innerRecipe.mergeInto(recipe);otherToHandle.forEach((otherHandle,handle)=>cloneMap.get(otherHandle).mergeInto(handle))}}),resolvedTokens.size))}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.Permuted,arc,options.recipeIndex)}get walker(){return this._walker}getResults(inputParams){return Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(inputParams),[...super.getResults(inputParams).filter(result=>!result.result.isResolved()),...inputParams.terminal]}_addThing(token,thing,thingByToken,thingByPhrase){if(!token)return;this._addThingByToken(token.toLowerCase(),thing,thingByToken);const phrase=token.replace(/([^A-Z])([A-Z])/g,"$1 $2").replace(/([A-Z][^A-Z])/g," $1").replace(/[\s]+/g," ").trim();phrase!==token&&this._addThingByToken(phrase.toLowerCase(),thing,thingByPhrase)}_addThingByToken(key,thing,thingByKey){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(key===key.toLowerCase()),thingByKey[key]=thingByKey[key]||[],thingByKey[key].find(t=>t===thing)||thingByKey[key].push(thing)}async generate(inputParams){return await this.walker.recipeIndex.ready,_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),this.walker,this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SearchTokensToHandles",function(){return SearchTokensToHandles});var _runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(47),_strategizer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(140);class SearchTokensToHandles extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.Strategy{async generate(inputParams){const arc=this.arc,findMatchingStores=(token,handle)=>{const counts=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_0__.RecipeUtil.directionCounts(handle);let stores;stores=arc.findStoresByType(handle.type,{tags:[`${token}`]});let fate="use";return 0===stores.length&&(stores=arc.context.findStoresByType(handle.type,{tags:[`${token}`],subtype:0===counts.out}),fate=0===counts.out?"map":"copy"),(stores=stores.filter(store=>!handle.recipe.handles.find(handle=>handle.id===store.id))).map(store=>({store:store,fate:fate,token:token}))};return _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.over(this.getResults(inputParams),new class extends _strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker{onHandle(recipe,handle){if(!recipe.search||0===recipe.search.unresolvedTokens.length)return;if(handle.isResolved()||0===handle.connections.length)return;const possibleMatches=[];for(const token of recipe.search.unresolvedTokens)possibleMatches.push(...findMatchingStores(token,handle));return 0!==possibleMatches.length?possibleMatches.map(match=>(recipe,handle)=>(handle.fate=match.fate,handle.mapToStorage(match.store),recipe.search.resolveToken(match.token),0)):void 0}}(_strategizer_js__WEBPACK_IMPORTED_MODULE_1__.StrategizerWalker.Permuted),this)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"RecipeIndex",function(){return RecipeIndex});var _planning_strategizer_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(140),_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(17),_runtime_arc_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(54),_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(127),_runtime_manifest_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(41),_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(46),_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(47),_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(83),_runtime_slot_composer_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(95),_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(134),_debug_strategy_explorer_adapter_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(136),_plan_planning_result_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(137),_planning_modality_handler_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(161),_strategies_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(139),_strategies_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(143),_strategies_create_handle_group_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(145),_strategies_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(152),_strategies_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__(156),_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_18__=__webpack_require__(157),_runtime_id_js__WEBPACK_IMPORTED_MODULE_19__=__webpack_require__(29);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class RelevantContextRecipes extends _planning_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategy{constructor(context,modality){super(),this._recipes=[];for(let recipe of context.allRecipes){if(!recipe.isCompatible(modality))continue;recipe=recipe.clone();const options={errors:new Map};recipe.normalize(options)?this._recipes.push(recipe):console.warn(`could not normalize a context recipe: ${[...options.errors.values()].join("\n")}.\n${recipe.toString()}`)}}async generate({generation:generation}){return 0!==generation?[]:this._recipes.map(recipe=>({result:recipe,score:1,derivation:[{strategy:this,parent:void 0}],hash:recipe.digest(),valid:Object.isFrozen(recipe)}))}}const IndexStrategies=[_strategies_convert_constraints_to_connections_js__WEBPACK_IMPORTED_MODULE_14__.ConvertConstraintsToConnections,_strategies_add_missing_handles_js__WEBPACK_IMPORTED_MODULE_13__.AddMissingHandles,_strategies_resolve_recipe_js__WEBPACK_IMPORTED_MODULE_17__.ResolveRecipe,_strategies_match_free_handles_to_connections_js__WEBPACK_IMPORTED_MODULE_16__.MatchFreeHandlesToConnections,_strategies_create_handle_group_js__WEBPACK_IMPORTED_MODULE_15__.CreateHandleGroup];class RecipeIndex{constructor(arc,{reportGenerations:reportGenerations=!1}={}){this._isReady=!1;const trace=_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_9__.Tracing.start({cat:"indexing",name:"RecipeIndex::constructor",overview:!0}),idGenerator=_runtime_id_js__WEBPACK_IMPORTED_MODULE_19__.IdGenerator.newSession(),arcStub=new _runtime_arc_js__WEBPACK_IMPORTED_MODULE_2__.Arc({id:idGenerator.newArcId("index-stub"),context:new _runtime_manifest_js__WEBPACK_IMPORTED_MODULE_4__.Manifest({id:idGenerator.newArcId("empty-context")}),loader:arc.loader,slotComposer:new _runtime_slot_composer_js__WEBPACK_IMPORTED_MODULE_8__.SlotComposer({modalityHandler:_planning_modality_handler_js__WEBPACK_IMPORTED_MODULE_12__.PlanningModalityHandler.createHeadlessHandler(),noRoot:!0}),stub:!0}),strategizer=new _planning_strategizer_js__WEBPACK_IMPORTED_MODULE_0__.Strategizer([new RelevantContextRecipes(arc.context,arc.modality),...IndexStrategies.map(S=>new S(arcStub,{recipeIndex:this}))],[],_strategies_rulesets_js__WEBPACK_IMPORTED_MODULE_18__.Empty);this.ready=trace.endWith(new Promise(async resolve=>{const generations=[];do{const record=await strategizer.generate();generations.push({record:record,generated:strategizer.generated})}while(strategizer.generated.length+strategizer.terminal.length>0);reportGenerations&&_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.isConnected&&_debug_strategy_explorer_adapter_js__WEBPACK_IMPORTED_MODULE_10__.StrategyExplorerAdapter.processGenerations(_plan_planning_result_js__WEBPACK_IMPORTED_MODULE_11__.PlanningResult.formatSerializableGenerations(generations),_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_3__.DevtoolsConnection.get().forArc(arc),{label:"Index",keep:!0});const population=strategizer.population,candidates=new Set(population);for(const result of population)for(const deriv of result.derivation)deriv.parent&&candidates.delete(deriv.parent);this._recipes=[...candidates].map(r=>r.result),this._isReady=!0,resolve(!0)}))}static create(arc,options={}){return new RecipeIndex(arc,options)}get recipes(){if(!this._isReady)throw Error("await on recipeIndex.ready before accessing");return this._recipes}ensureReady(){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(this._isReady,"await on recipeIndex.ready before accessing")}findHandleMatch(handle,requestedFates){this.ensureReady();const particleNames=handle.connections.map(conn=>conn.particle.name),results=[];for(const recipe of this._recipes)if(!recipe.particles.some(particle=>!particle.name))for(const otherHandle of recipe.handles){if(requestedFates&&!requestedFates.includes(otherHandle.fate))continue;if(!this.doesHandleMatch(handle,otherHandle))continue;const otherParticleNames=otherHandle.connections.map(conn=>conn.particle.name);new Set([...particleNames,...otherParticleNames]).size===particleNames.length&&particleNames.length===otherParticleNames.length||results.push(otherHandle)}return results}doesHandleMatch(handle,otherHandle){if(Boolean(handle.id)&&Boolean(otherHandle.id)&&handle.id!==otherHandle.id)return!1;if(0===otherHandle.connections.length||"descriptions"===otherHandle.localName)return!1;const fates=[handle.originalFate,handle.fate,otherHandle.originalFate,otherHandle.fate];if(!fates.includes("copy")&&!fates.includes("map")){const counts=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_6__.RecipeUtil.directionCounts(handle),otherCounts=_runtime_recipe_recipe_util_js__WEBPACK_IMPORTED_MODULE_6__.RecipeUtil.directionCounts(otherHandle);if(otherCounts.in+counts.in===0||otherCounts.out+counts.out===0)return!1}return!(handle.tags.length>0&&!handle.tags.some(t=>otherHandle.tags.includes(t)))&&!!_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_5__.Handle.effectiveType(handle.mappedType,[...handle.connections,...otherHandle.connections])}findConsumeSlotConnectionMatch(particle,providedSlotSpec){this.ensureReady();const consumeConns=[];for(const recipe of this._recipes)if(!recipe.particles.some(recipeParticle=>!recipeParticle.name))for(const recipeParticle of recipe.particles)if(recipeParticle.spec)for(const[name,slotSpec]of recipeParticle.spec.slotConnections){const recipeSlotConn=recipeParticle.getSlotConnectionByName(name);if((!recipeSlotConn||!recipeSlotConn.targetSlot)&&(_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_7__.SlotUtils.specMatch(slotSpec,providedSlotSpec)&&_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_7__.SlotUtils.tagsOrNameMatch(slotSpec,providedSlotSpec))){const slotConn=particle.getSlotConnectionByName(providedSlotSpec.name);let matchingHandles=[];if((0!==providedSlotSpec.handles.length||slotConn&&!_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_7__.SlotUtils.handlesMatch(recipeParticle,slotConn))&&0===(matchingHandles=this._getMatchingHandles(recipeParticle,particle,providedSlotSpec)).length)continue;consumeConns.push({recipeParticle:recipeParticle,slotSpec:slotSpec,matchingHandles:matchingHandles})}}return consumeConns}findProvidedSlot(particle,slotSpec){this.ensureReady();const providedSlots=[];for(const recipe of this._recipes)if(!recipe.particles.some(particle=>!particle.name))for(const consumeConn of recipe.slotConnections)for(const providedSlot of Object.values(consumeConn.providedSlots))_runtime_recipe_slot_utils_js__WEBPACK_IMPORTED_MODULE_7__.SlotUtils.slotMatches(particle,slotSpec,providedSlot)&&providedSlots.push(providedSlot);return providedSlots}_getMatchingHandles(particle,providingParticle,providedSlotSpec){const matchingHandles=[];for(const slotHandleConnName of providedSlotSpec.handles){const providedHandleConn=providingParticle.getConnectionByName(slotHandleConnName);providedHandleConn&&Object.values(particle.connections).filter(handleConn=>"host"!==handleConn.direction&&(!handleConn.handle||!handleConn.handle.id||handleConn.handle.id===providedHandleConn.handle.id)&&_runtime_recipe_handle_js__WEBPACK_IMPORTED_MODULE_5__.Handle.effectiveType(providedHandleConn.handle.mappedType,[handleConn])).forEach(matchingConn=>{this._fatesAndDirectionsMatch(providedHandleConn,matchingConn)&&matchingHandles.push({handle:providedHandleConn.handle,matchingConn:matchingConn})})}return matchingHandles}_fatesAndDirectionsMatch(slotHandleConn,matchingHandleConn){const matchingHandle=matchingHandleConn.handle,matchingHandleConnsHasOutput=(matchingHandle?matchingHandle.connections:[matchingHandleConn]).find(conn=>["out","inout"].includes(conn.direction));switch(slotHandleConn.handle.fate){case"create":case"use":return!matchingHandle||["use","?"].includes(matchingHandle.fate);case"copy":return!matchingHandle||"create"!==matchingHandle.fate;case"map":return!(matchingHandleConnsHasOutput||matchingHandle&&"copy"===matchingHandle.fate);case"?":return!1;default:throw new Error(`Unexpected fate ${slotHandleConn.handle.fate}`)}}get coalescableFates(){return["create","use","?"]}findCoalescableHandles(recipe,otherRecipe,usedHandles){Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_1__.assert)(recipe!==otherRecipe,"Cannot coalesce handles in the same recipe");const otherToHandle=new Map;usedHandles=usedHandles||new Set;for(const handle of recipe.handles)if(!usedHandles.has(handle)&&this.coalescableFates.includes(handle.fate))for(const otherHandle of otherRecipe.handles)!usedHandles.has(otherHandle)&&this.coalescableFates.includes(otherHandle.fate)&&this.doesHandleMatch(handle,otherHandle)&&(otherToHandle.set(handle,otherHandle),usedHandles.add(handle),usedHandles.add(otherHandle));return otherToHandle}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"PlanningModalityHandler",function(){return PlanningModalityHandler});var _runtime_description_dom_formatter_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(89),_runtime_headless_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(90),_runtime_modality_handler_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(88),_runtime_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(91),_headless_suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(162),_suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(163);
/**
 * @license
 * Copyright (c) 2019 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class PlanningModalityHandler extends _runtime_modality_handler_js__WEBPACK_IMPORTED_MODULE_2__.ModalityHandler{constructor(slotConsumerClass,suggestionConsumerClass,descriptionFormatter){super(slotConsumerClass,descriptionFormatter),this.suggestionConsumerClass=suggestionConsumerClass}static createHeadlessHandler(){return new PlanningModalityHandler(_runtime_headless_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.HeadlessSlotDomConsumer,_headless_suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_4__.HeadlessSuggestDomConsumer)}}PlanningModalityHandler.domHandler=new PlanningModalityHandler(_runtime_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_3__.SlotDomConsumer,_suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_5__.SuggestDomConsumer,_runtime_description_dom_formatter_js__WEBPACK_IMPORTED_MODULE_0__.DescriptionDomFormatter)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"HeadlessSuggestDomConsumer",function(){return HeadlessSuggestDomConsumer});var _platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(163);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class HeadlessSuggestDomConsumer extends _suggest_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.SuggestDomConsumer{constructor(arc,containerKind,suggestion,eventHandler){super(arc,containerKind,suggestion,eventHandler),this._suggestionContent=this._suggestionContent.template?this._suggestionContent:{template:`<dummy-suggestion>${this._suggestionContent}</dummy-element>`,templateName:"dummy-suggestion",model:{}},this._setContentPromise=null,this._content={},this.contentAvailable=new Promise(resolve=>this._contentAvailableResolve=resolve)}get suggestion(){return this._suggestion}get templatePrefix(){return"suggest"}onContainerUpdate(container,originalContainer){super.onContainerUpdate(container,originalContainer),container&&this.setContent(this._suggestionContent,this._eventHandler)}static render(arc,container,suggestion){}setContent(content,handler){super.setContent(content,handler),content?(this._content.templateName=content.templateName,content.template&&(this._content.template=content.template),this._content.model=content.model,this._contentAvailableResolve()):this._content={}}createNewContainer(container,subId){return container}isSameContainer(container,contextContainer){return container===contextContainer}getInnerContainer(slotId){const model=Array.from(this.renderings,([_,{model:model}])=>model)[0],providedContext=this.findProvidedContext(ctx=>ctx.id===slotId);if(providedContext){if(providedContext.spec.isSet&&model&&model.items&&model.items.models){const innerContainers={};for(const itemModel of model.items.models)Object(_platform_assert_web_js__WEBPACK_IMPORTED_MODULE_0__.assert)(itemModel.id),innerContainers[itemModel.id]=itemModel.id;return innerContainers}return slotId}console.warn(`Cannot find provided spec for ${slotId} in ${this.consumeConn.getQualifiedName()}`)}createTemplateElement(template){return template}static findRootContainers(container){return container}static clear(container){}_onUpdate(rendering){}_stampTemplate(template){}_initMutationObserver(){return null}_observe(){}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SuggestDomConsumer",function(){return SuggestDomConsumer});var _runtime_modality_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(28),_runtime_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(91);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
class SuggestDomConsumer extends _runtime_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.SlotDomConsumer{constructor(arc,containerKind,suggestion,eventHandler){super(arc,null,containerKind),this._suggestion=suggestion,this._suggestionContent=SuggestDomConsumer._extractContent(this._suggestion),this._eventHandler=eventHandler}get suggestion(){return this._suggestion}get templatePrefix(){return"suggest"}formatContent(content){return{template:`<suggestion-element inline key="{{hash}}" on-click="">${content.template}</suggestion-element>`,templateName:"suggestion",model:{hash:this.suggestion.hash,...content.model}}}onContainerUpdate(container,originalContainer){super.onContainerUpdate(container,originalContainer),container&&this.setContent(this._suggestionContent,this._eventHandler)}static _extractContent(suggestion){return suggestion.getDescription(_runtime_modality_js__WEBPACK_IMPORTED_MODULE_0__.Modality.Name.Dom)||{template:suggestion.descriptionText}}static render(arc,container,suggestion){const content=SuggestDomConsumer._extractContent(suggestion);if(!content)return;const suggestionContainer=Object.assign(document.createElement("suggestion-element"),{plan:suggestion});container.appendChild(suggestionContainer,container.firstElementChild);const rendering={container:suggestionContainer,model:content.model},consumer=new _runtime_slot_dom_consumer_js__WEBPACK_IMPORTED_MODULE_1__.SlotDomConsumer(arc);return consumer.addRenderingBySubId(void 0,rendering),consumer.eventHandler=(()=>{}),consumer._stampTemplate(rendering,consumer.createTemplateElement(content.template)),consumer._onUpdate(rendering),consumer}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"enableTracingAdapter",function(){return enableTracingAdapter});var _tracelib_trace_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(134);
/**
 * @license
 * Copyright (c) 2018 Google Inc. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * Code distributed by Google as part of this project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */let streamingToDevtools=!1;function enableTracingAdapter(devtoolsChannel){streamingToDevtools||(_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_0__.Tracing.enable(),devtoolsChannel.send({messageType:"trace-time-sync",messageBody:{traceTime:_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_0__.Tracing.now(),localTime:Date.now()}}),_tracelib_trace_js__WEBPACK_IMPORTED_MODULE_0__.Tracing.stream(trace=>devtoolsChannel.send({messageType:"trace",messageBody:trace}),trace=>trace.ov),streamingToDevtools=!0)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ShellApiFactory",function(){return ShellApiFactory});var _build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(119),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(116),_context_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(166),_pipe_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(172);const log=Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_0__.logFactory)("Device");Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_0__.logFactory)("Device",null,"warn");let recipes,client,userContext,testMode,recipeManifest;const ShellApiFactory=async(storage,manifest,deviceClient)=>(recipeManifest=manifest||"\nimport 'https://thorn-egret.glitch.me/custom.recipes'\nimport 'https://$particles/PipeApps/canonical.recipes'\n",client=deviceClient,await marshalRecipeContext(),userContext=new _context_js__WEBPACK_IMPORTED_MODULE_2__.Context(storage),await signalClientWhenReady(deviceClient),shellApi),signalClientWhenReady=async client=>{if(client){const ready=client.shellReady;ready&&(await userContext.isReady,ready.call(client))}},marshalRecipeContext=async()=>{const manifest=await _lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_1__.Utils.parse(recipeManifest),types=(recipes=manifest.findRecipesByVerb("autofill")).map(recipe=>recipe.name.toLowerCase().replace(/_/g,".")),json=JSON.stringify(types);log(`> DeviceClient.notifyAutofillTypes('${json}')`),client&&client.notifyAutofillTypes(json)},shellApi={receiveEntity(json){const id=trackTransactionId(()=>receiveJsonEntity(json));return log(`[${id}]: received entity`,json),id},observeEntity:json=>(log("observing entity",json),observeJsonEntity(json),!0),flush(){log("flushing caches"),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_1__.Utils.env.loader.flushCaches(),marshalRecipeContext()}},transactionIds=[],trackTransactionId=async=>{const id=transactionIds.push(0);return async().then(arcid=>transactionIds[id-1]=arcid),id},observeJsonEntity=async json=>{_pipe_js__WEBPACK_IMPORTED_MODULE_3__.Pipe.observeEntity(userContext.entityStore,json)},receiveJsonEntity=async json=>{try{if(testMode=!json,userContext.pipesArc){const arc=await _pipe_js__WEBPACK_IMPORTED_MODULE_3__.Pipe.receiveEntity(userContext.context,recipes,foundSuggestions,json);return String(arc.id)}}catch(x){console.error(x)}},foundSuggestions=(arc,text)=>{const id=(arc=>{const arcid=String(arc.id);return transactionIds.findIndex(id=>id===arcid)+1})(arc);testMode?console.log(`[testMode] foundSuggestions("${id}", "${text}")`):(console.warn(`invoking DeviceClient.foundSuggestions("${id}", "${text}")`),client&&client.foundSuggestions(id,text))}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Context",function(){return Context});var _build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(125),_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(119),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(116),_lib_runtime_stores_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(167),_lib_components_ram_slot_composer_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(168),_lib_components_arc_host_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(169),_schemas_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(171);const log=Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("Context"),Context=class{constructor(storage){this.isReady=new Promise((resolve,reject)=>this.readyResolver=resolve),this.initContext(storage)}async initContext(storage){this.context=await _lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__.Utils.parse(""),await this.initAddressStore(this.context),await this.initPipesArc(storage),this.readyResolver()}async initAddressStore(context){const store=await _lib_runtime_stores_js__WEBPACK_IMPORTED_MODULE_3__.Stores.create(context,{name:"pipe-entities",id:"pipe-entities",schema:_schemas_js__WEBPACK_IMPORTED_MODULE_6__.Schemas.PipeEntity,isCollection:!0,tags:null,storageKey:null});this.contextEntityStore=store}async initPipesArc(storage){log("initPipesArc");const host=new _lib_components_arc_host_js__WEBPACK_IMPORTED_MODULE_5__.ArcHost(null,storage,new _lib_components_ram_slot_composer_js__WEBPACK_IMPORTED_MODULE_4__.RamSlotComposer);this.pipesArc=await host.spawn({id:"pipes-arc",manifest:"import 'https://$particles/PipeApps/BackgroundPipes.recipes'"}),this.entityStore=this.pipesArc._stores[0],this.entityStore?(await this.entityStoreChange(await this.getInitialChange(this.entityStore)),this.entityStore.on("change",info=>this.entityStoreChange(info),this)):log("initPipesArc: failed to find entityStore")}async getInitialChange(store){const change={add:[]};return(await store.toList()).forEach(value=>change.add.push({value:value})),change}async entityStoreChange(change){await this.cloneStoreChange(change,this.contextEntityStore)}async cloneStoreChange(change,store){store&&change.add&&await Promise.all(change.add.map(async add=>{await store.store(add.value,[Object(_build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__.now)()])}))}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Stores",function(){return Stores});var _build_runtime_type_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18);class Stores{static async create(context,options){const schemaType=_build_runtime_type_js__WEBPACK_IMPORTED_MODULE_0__.Type.fromLiteral(options.schema),typeOf=options.isCollection?schemaType.collectionOf():schemaType;return await this._requireStore(context,typeOf,options)}static async _requireStore(context,type,{name:name,id:id,tags:tags,storageKey:storageKey}){return context.findStoreById(id)||await context.createStore(type,name,id,tags,storageKey)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"RamSlotComposer",function(){return RamSlotComposer});var _build_runtime_modality_handler_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(88),_build_runtime_slot_composer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(95);class RamSlotComposer extends _build_runtime_slot_composer_js__WEBPACK_IMPORTED_MODULE_1__.SlotComposer{constructor(options={}){super({rootContainer:options.rootContainer||{root:"root-context"},modalityName:options.modalityName,modalityHandler:_build_runtime_modality_handler_js__WEBPACK_IMPORTED_MODULE_0__.ModalityHandler.createHeadlessHandler()})}sendEvent(particleName,slotName,event,data){const particles=this.consumers.filter(s=>s.consumeConn.particle.name==particleName).map(s=>s.consumeConn.particle);this.pec.sendEvent(particles[0],slotName,{handler:event,data:data})}renderSlot(particle,slotName,content){super.renderSlot(particle,slotName,content);const slotConsumer=this.getSlotConsumer(particle,slotName);slotConsumer&&slotConsumer.updateProvidedContexts()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"ArcHost",function(){return ArcHost});var _build_runtime_type_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18),_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(119),_runtime_synthetic_stores_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(170),_runtime_utils_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(116);const log=Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("ArcHost","#cade57"),error=(Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("ArcHost","#cade57","warn"),Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("ArcHost","#cade57","error"));class ArcHost{constructor(context,storage,composer){this.context=context,this.storage=storage,this.composer=composer}disposeArc(){this.arc&&this.arc.dispose(),this.arc=null}async spawn(config){log("spawning arc",config),this.config=config;const context=this.context||await _runtime_utils_js__WEBPACK_IMPORTED_MODULE_3__.Utils.parse("");if(this.serialization=await this.computeSerialization(config,this.storage),this.arc=await this._spawn(context,this.composer,this.storage,config.id,this.serialization),config.manifest&&!this.serialization&&await this.instantiateDefaultRecipe(this.arc,config.manifest),this.pendingPlan){const plan=this.pendingPlan;this.pendingPlan=null,await this.instantiatePlan(this.arc,plan)}return this.arc}set manifest(manifest){this.instantiateDefaultRecipe(this.arc,manifest)}set plan(plan){this.arc?this.instantiatePlan(this.arc,plan):this.pendingPlan=plan}async computeSerialization(config,storage){let serialization;return null!=config.serialization&&(serialization=config.serialization),null==serialization&&(serialization=storage.includes("volatile")?"":await this.fetchSerialization(storage,config.id)||""),serialization}async _spawn(context,composer,storage,id,serialization){return await _runtime_utils_js__WEBPACK_IMPORTED_MODULE_3__.Utils.spawn({id:id,context:context,composer:composer,serialization:serialization,storage:`${storage}/${id}`})}async instantiateDefaultRecipe(arc,manifest){log("instantiateDefaultRecipe");try{const recipe=(manifest=await _runtime_utils_js__WEBPACK_IMPORTED_MODULE_3__.Utils.parse(manifest)).allRecipes[0],plan=await _runtime_utils_js__WEBPACK_IMPORTED_MODULE_3__.Utils.resolve(arc,recipe);plan&&await this.instantiatePlan(arc,plan)}catch(x){error(x)}}async instantiatePlan(arc,plan){log("instantiatePlan"),plan.isResolved()||log(`Suggestion plan ${plan.toString({showUnresolved:!0})} is not resolved.`);try{await arc.instantiate(plan)}catch(x){error(x)}await this.persistSerialization()}async fetchSerialization(storage,arcid){const key=`${storage}/${arcid}/arc-info`,store=await _runtime_synthetic_stores_js__WEBPACK_IMPORTED_MODULE_2__.SyntheticStores.providerFactory.connect("id",new _build_runtime_type_js__WEBPACK_IMPORTED_MODULE_0__.ArcType,key);if(store){log("loading stored serialization");const info=await store.get();return info&&info.serialization}}async persistSerialization(){const{arc:arc,config:{id:id},storage:storage}=this;if(!storage.includes("volatile")){log(`persisting serialization to [${id}/serialization]`);const serialization=await arc.serialize();await arc.persistSerialization(serialization)}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SyntheticStores",function(){return SyntheticStores});var _build_runtime_storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(15);class SyntheticStores{static get providerFactory(){return SyntheticStores._providerFactory||(SyntheticStores._providerFactory=new _build_runtime_storage_storage_provider_factory_js__WEBPACK_IMPORTED_MODULE_0__.StorageProviderFactory("shell"))}static async getArcsStore(storage,arcid){const handleStore=await SyntheticStores.getStore(storage,arcid);if(handleStore){const handle=(await handleStore.toList())[0];if(handle)return await SyntheticStores.getHandleStore(handle)}}static async getStore(storage,arcid){return await SyntheticStores.connectToKind("handles",storage,arcid)}static async connectToKind(kind,storage,arcid){return"/"===storage[storage.length-1]&&(storage=storage.slice(0,-1)),SyntheticStores.storeConnect(null,`synthetic://arc/${kind}/${storage}/${arcid}`)}static async getHandleStore(handle){return await SyntheticStores.storeConnect(handle.type,handle.storageKey)}static async storeConnect(type,storageKey){return SyntheticStores.providerFactory.connect(SyntheticStores.makeId(),type,storageKey)}static makeId(){return`id${Math.random()}`}static snarfId(key){return key.split("/").pop()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Schemas",function(){return Schemas});const Schemas={PipeEntity:{tag:"Entity",data:{names:["PipeEntity"],fields:{id:"Text",type:"Text",name:"Text",timestamp:"Number",count:"Number",source:"Text"}}}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Pipe",function(){return Pipe});var _build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(125),_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(119),_lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(116),_lib_components_ram_slot_composer_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(168),_modalities_dom_components_generate_id_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(173);const log=Object(_build_platform_log_web_js__WEBPACK_IMPORTED_MODULE_1__.logFactory)("Pipe");let t0;const Pipe={async observeEntity(store,json){const data=fromJson(json);if(store&&data){data.timestamp||(data.timestamp=Date.now(),data.source="com.unknown");const entity={id:Object(_modalities_dom_components_generate_id_js__WEBPACK_IMPORTED_MODULE_4__.generateId)(),rawData:data};await store.store(entity,[Object(_build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__.now)()])}},async receiveEntity(context,recipes,callback,json){t0=Object(_build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__.now)();const type=extractType(json),recipe=recipeForType(type,recipes);if(recipe)return instantiateAutofillArc(context,type,recipe,callback);log(`found no autofill recipe for type [${type}]`)}},fromJson=json=>{try{return JSON.parse(json)}catch(x){return null}},extractType=json=>{const entity=fromJson(json);return(entity?entity.type:"com.music.spotify").replace(/\./g,"_")},recipeForType=(type,recipes)=>recipes.find(recipe=>recipe.name.toLowerCase()===type),instantiateAutofillArc=async(context,type,recipe,callback)=>{const arc=await _lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__.Utils.spawn({id:"piping-arc",composer:new _lib_components_ram_slot_composer_js__WEBPACK_IMPORTED_MODULE_3__.RamSlotComposer,context:context});return log(`arc [${arc.id}]`),await instantiatePipeRecipe(arc,type),await instantiateAutofillRecipe(arc,recipe.clone(),callback),arc},instantiateAutofillRecipe=async(arc,recipe,callback)=>{await instantiateRecipe(arc,recipe);const store=arc._stores[2];watchOneChange(store,callback,arc)},instantiatePipeRecipe=async(arc,type)=>{const manifestContent=buildEntityManifest({type:type}),manifest=await _lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__.Utils.parse(manifestContent),recipe=recipeByName(manifest,"Pipe");await instantiateRecipe(arc,recipe)},instantiateRecipe=async(arc,recipe)=>{const plan=await _lib_runtime_utils_js__WEBPACK_IMPORTED_MODULE_2__.Utils.resolve(arc,recipe);await arc.instantiate(plan)},recipeByName=(manifest,name)=>manifest.allRecipes.find(recipe=>recipe.name===name),watchOneChange=(store,callback,arc)=>{const cb=info=>{onChange(arc,info,callback),store.off("change",cb),arc.dispose()};store.on("change",cb,arc)},onChange=(arc,change,callback)=>{if(change.data){const data=change.data.rawData,text=data.json||data.text||data.address;callback(arc,text);const dt=Object(_build_platform_date_web_js__WEBPACK_IMPORTED_MODULE_0__.now)()-t0;"undefined"!=typeof document&&document.body.appendChild(Object.assign(document.createElement("div"),{style:"padding: 16px;",innerText:`[${arc.id}] ${text}\n\n${dt.toFixed(1)}ms`}))}},buildEntityManifest=entity=>`\nimport 'https://$particles/PipeApps/Trigger.recipes'\n\nresource PipeEntityResource\n  start\n  [{"type": "${entity.type}", "name": "${entity.name}"}]\n\nstore LivePipeEntity of PipeEntity 'LivePipeEntity' @0 #pipe_entity #pipe_${entity.type} in PipeEntityResource\n\nrecipe Pipe\n  use 'LivePipeEntity' #pipe_entity #pipe_${entity.type} as pipe\n  Trigger\n    pipe = pipe\n`},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"generateId",function(){return generateId});const PUSH_CHARS="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",lastRandChars=[];let lastPushTime=0;const generateId=function(){let now=(new Date).getTime();const duplicateTime=now===lastPushTime;lastPushTime=now;const timeStampChars=new Array(8);for(let i=7;i>=0;i--)timeStampChars[i]=PUSH_CHARS.charAt(now%64),now=Math.floor(now/64);if(0!==now)throw new Error("We should have converted the entire timestamp.");let id=timeStampChars.join("");if(duplicateTime){let i;for(i=11;i>=0&&63===lastRandChars[i];i--)lastRandChars[i]=0;lastRandChars[i]++}else for(let i=0;i<12;i++)lastRandChars[i]=Math.floor(64*Math.random());for(let i=0;i<12;i++)id+=PUSH_CHARS.charAt(lastRandChars[i]);return id}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"DevtoolsSupport",function(){return DevtoolsSupport});var _build_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(127);const DevtoolsSupport=async()=>{new URL(document.location).searchParams.has("remote-explore-key")&&(_build_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_0__.DevtoolsConnection.ensure(),await _build_devtools_connector_devtools_connection_js__WEBPACK_IMPORTED_MODULE_0__.DevtoolsConnection.onceConnected)}}]);